// =========================
// ðŸ’¸ FINANCE MODULE
// =========================

model CashAccount {
  id             String  @id @default(cuid())
  name           String
  description    String?
  initialBalance Decimal @default(0) @db.Decimal(10, 2)
  currentBalance Decimal @default(0) @db.Decimal(10, 2)
  isDefault      Boolean @default(false)
  isActive       Boolean @default(true)

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  sales Sale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions CashTransaction[]
  expenses     Expense[]

  carriageInwards CarriageInward[]
}

model CashTransaction {
  id              String   @id @default(cuid())
  amount          Decimal  @db.Decimal(10, 2)
  transactionType String // "cash_in", "cash_out", "transfer_in", "transfer_out"
  category        String?
  description     String?
  personInCharge  String? // person_in_charge
  tags            String[]
  date            DateTime
  paymentMethod   String? // payment_method
  receiptImage    String? // receipt_image

  accountId String
  account   CashAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  branchId String // location_id
  branch   Branch @relation(fields: [branchId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  installmentPayment InstallmentPayment?
  expenses           Expense[]

  sale Sale?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InstallmentPayment {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(10, 2)
  paymentDate DateTime // payment_date
  notes       String?

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("PaymentReceiver", fields: [userId], references: [id])

  cashTransactionId String?          @unique
  cashTransaction   CashTransaction? @relation(fields: [cashTransactionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Expense {
  id            String   @id @default(cuid())
  amount        Decimal  @db.Decimal(10, 2)
  description   String
  category      String
  date          DateTime @default(now())
  paymentMethod String?
  reference     String?

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id])

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  receiptImage String?

  cashAccountId     String?
  cashAccount       CashAccount?     @relation(fields: [cashAccountId], references: [id])
  cashTransactionId String?
  cashTransaction   CashTransaction? @relation(fields: [cashTransactionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ExpenseCategory {
  id        String  @id @default(cuid())
  name      String
  isDefault Boolean @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, name])
}

model Transaction {
  id                       String   @id @default(cuid())
  userId                   String
  user                     User     @relation(fields: [userId], references: [id])
  amount                   Float
  currency                 String   @default("UGX")
  status                   String   @default("pending") // "pending", "completed", "failed"
  pesapalOrderTrackingId   String?  @unique
  pesapalMerchantReference String   @unique
  description              String?

  // Subscription payment fields (null for credit top-up transactions)
  type         String  @default("topup") // "topup" | "subscription"
  agencyId     String? // Which agency this subscription payment is for
  packageId    String? // Which package is being purchased
  billingCycle String? // "monthly" | "yearly"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
