import React, { useState, useMemo, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Plus, RefreshCw, Download, Upload, Trash2, ArrowLeft, Printer } from 'lucide-react';
import { useAuth } from '@/components/auth/AuthProvider';
import { useBusiness } from '@/contexts/BusinessContext';
import InventoryTable from '@/components/inventory/InventoryTable';
import InventoryFilters from '@/components/inventory/InventoryFilters';
import InventoryStats from '@/components/inventory/InventoryStats';
import { useProducts } from '@/hooks/useProducts';
import { useToast } from '@/hooks/use-toast';
import { useIsMobile } from '@/hooks/use-mobile';
import { formatNumber } from '@/lib/utils';
import { exportProductsForUpdate } from '@/utils/exportProductsForUpdate';
import { exportProductsToCSV } from '@/utils/exportProductsToCSV';
import { exportProductsToPDF } from '@/utils/exportProductsToPDF';
import LoadingSpinner from '@/components/LoadingSpinner';
import BulkDeleteDialog from '@/components/inventory/BulkDeleteDialog';
import CSVUploadDialog from '@/components/inventory/CSVUploadDialog';
import CSVUpdateDialog from '@/components/inventory/CSVUpdateDialog';
import BulkPrintDialog from '@/components/inventory/BulkPrintDialog';
import BarcodeExportDialog, { BarcodeExportConfig } from '@/components/inventory/BarcodeExportDialog';
import { useBulkProducts } from '@/hooks/useBulkProducts';
import { generateProductCSVTemplate } from '@/utils/csvTemplate';
import { useCategories } from '@/hooks/useCategories';
import { useBusinessSettings } from '@/hooks/useBusinessSettings';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { SortField } from '@/components/inventory/InventoryTable';
import { Product } from '@/types';
import { supabase } from '@/integrations/supabase/client';
import { exportBulkBarcodesToPDF } from '@/utils/exportBarcodeToPDF';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  DropdownMenuSeparator,
} from '@/components/ui/dropdown-menu';
import { ChevronDown } from 'lucide-react';

// Helper function definition
  const handleOpenBarcodeExport = async (all: boolean = false) => {
    try {
      let products: Product[] = [];
      
      if (all) {
        toast({
          title: "Preparing barcode export...",
          description: "Fetching all products matching current filters.",
        });
        products = await fetchAllProductsForExport();
      } else {
        if (selectedProductIds.size === 0) {
          toast({
            title: "No products selected",
            description: "Please select products to export barcodes.",
            variant: "destructive"
          });
          return;
        }
        products = selectedProducts;
      }

      const productsWithBarcodes = products.filter(p => p.barcode);
      
      if (productsWithBarcodes.length === 0) {
        toast({
          title: "No barcodes to export",
          description: "None of the selected products have barcodes.",
          variant: "destructive"
        });
        return;
      }

      setProductsToExport(productsWithBarcodes);
      setBarcodeExportOpen(true);
    } catch (error) {
      console.error('Failed to prepare barcode export:', error);
      toast({
        title: "Export preparation failed",
        description: "Failed to prepare products for export.",
        variant: "destructive"
      });
    }
  };

  const handleConfirmBarcodeExport = async (config: BarcodeExportConfig) => {
    setIsExportingBarcodes(true);
    try {
      toast({
        title: "Generating PDF...",
        description: `Exporting ${productsToExport.length} barcode${productsToExport.length > 1 ? 's' : ''}...`,
      });

      await exportBulkBarcodesToPDF(productsToExport, {
        showPrice: config.showPrice,
        currency: settings.currency,
        cols: config.cols,
        rows: config.rows,
      });

      toast({
        title: "Export successful",
        description: `${productsToExport.length} barcode${productsToExport.length > 1 ? 's' : ''} exported to PDF.`,
      });

      setBarcodeExportOpen(false);
    } catch (error) {
      console.error('Barcode export failed:', error);
      toast({
        title: "Export failed",
        description: "Failed to export barcodes. Please try again.",
        variant: "destructive"
      });
    } finally {
      setIsExportingBarcodes(false);
    }
  };
