{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/components/ui/textarea.tsx"],"sourcesContent":["import * as React from \"react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nexport interface TextareaProps\r\n  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}\r\n\r\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(\r\n  ({ className, ...props }, ref) => {\r\n    return (\r\n      <textarea\r\n        className={cn(\r\n          \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\r\n          className\r\n        )}\r\n        ref={ref}\r\n        {...props}\r\n      />\r\n    )\r\n  }\r\n)\r\nTextarea.displayName = \"Textarea\"\r\n\r\nexport { Textarea }\r\n"],"names":[],"mappings":";;;;;AAAA;AAEA;;;;AAKA,MAAM,yBAAW,2KAAgB,MAC/B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE;IACxB,qBACE,6LAAC;QACC,WAAW,IAAA,4HAAE,EACX,wSACA;QAEF,KAAK;QACJ,GAAG,KAAK;;;;;;AAGf;;AAEF,SAAS,WAAW,GAAG"}},
    {"offset": {"line": 38, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/app/actions/business-settings.ts"],"sourcesContent":["'use server';\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function getBusinessSettingsAction(branchId: string) {\r\n    try {\r\n        const settings = await db.branchSettings.findUnique({\r\n            where: { branchId }\r\n        });\r\n\r\n        if (!settings) {\r\n            return null;\r\n        }\r\n\r\n        return {\r\n            id: settings.id,\r\n            business_name: settings.businessName,\r\n            business_address: settings.address,\r\n            business_phone: settings.phone,\r\n            business_email: settings.email,\r\n            business_logo: settings.logo,\r\n            currency: settings.currency,\r\n            signature: settings.signatureImage,\r\n            metadata: settings.metadata || {}\r\n        };\r\n    } catch (error) {\r\n        console.error('Error fetching business settings:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function upsertBusinessSettingsAction(branchId: string, userId: string, updateData: any) {\r\n    try {\r\n        // Validate user access to branch\r\n        const branch = await db.branch.findFirst({\r\n            where: {\r\n                id: branchId,\r\n                OR: [\r\n                    { adminId: userId },\r\n                    { users: { some: { id: userId } } }\r\n                ]\r\n            }\r\n        });\r\n\r\n        if (!branch) {\r\n            return { success: false, error: 'Unauthorized to update branch settings' };\r\n        }\r\n\r\n        const data = {\r\n            businessName: updateData.business_name,\r\n            address: updateData.business_address,\r\n            phone: updateData.business_phone,\r\n            email: updateData.business_email,\r\n            logo: updateData.business_logo,\r\n            currency: updateData.currency,\r\n            signatureImage: updateData.signature,\r\n            metadata: updateData.metadata\r\n        };\r\n\r\n        const upserted = await db.branchSettings.upsert({\r\n            where: { branchId: branchId },\r\n            update: data,\r\n            create: {\r\n                branchId: branchId,\r\n                ...data\r\n            }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                id: upserted.id,\r\n                business_name: upserted.businessName,\r\n                business_address: upserted.address,\r\n                business_phone: upserted.phone,\r\n                business_email: upserted.email,\r\n                business_logo: upserted.logo,\r\n                currency: upserted.currency,\r\n                signature: upserted.signatureImage,\r\n                metadata: upserted.metadata\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error upserting business settings:', error);\r\n        return { success: false, error: error.message || 'Failed to update settings' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAKsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,6DAAA"}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/app/actions/business-settings.ts"],"sourcesContent":["'use server';\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function getBusinessSettingsAction(branchId: string) {\r\n    try {\r\n        const settings = await db.branchSettings.findUnique({\r\n            where: { branchId }\r\n        });\r\n\r\n        if (!settings) {\r\n            return null;\r\n        }\r\n\r\n        return {\r\n            id: settings.id,\r\n            business_name: settings.businessName,\r\n            business_address: settings.address,\r\n            business_phone: settings.phone,\r\n            business_email: settings.email,\r\n            business_logo: settings.logo,\r\n            currency: settings.currency,\r\n            signature: settings.signatureImage,\r\n            metadata: settings.metadata || {}\r\n        };\r\n    } catch (error) {\r\n        console.error('Error fetching business settings:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function upsertBusinessSettingsAction(branchId: string, userId: string, updateData: any) {\r\n    try {\r\n        // Validate user access to branch\r\n        const branch = await db.branch.findFirst({\r\n            where: {\r\n                id: branchId,\r\n                OR: [\r\n                    { adminId: userId },\r\n                    { users: { some: { id: userId } } }\r\n                ]\r\n            }\r\n        });\r\n\r\n        if (!branch) {\r\n            return { success: false, error: 'Unauthorized to update branch settings' };\r\n        }\r\n\r\n        const data = {\r\n            businessName: updateData.business_name,\r\n            address: updateData.business_address,\r\n            phone: updateData.business_phone,\r\n            email: updateData.business_email,\r\n            logo: updateData.business_logo,\r\n            currency: updateData.currency,\r\n            signatureImage: updateData.signature,\r\n            metadata: updateData.metadata\r\n        };\r\n\r\n        const upserted = await db.branchSettings.upsert({\r\n            where: { branchId: branchId },\r\n            update: data,\r\n            create: {\r\n                branchId: branchId,\r\n                ...data\r\n            }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                id: upserted.id,\r\n                business_name: upserted.businessName,\r\n                business_address: upserted.address,\r\n                business_phone: upserted.phone,\r\n                business_email: upserted.email,\r\n                business_logo: upserted.logo,\r\n                currency: upserted.currency,\r\n                signature: upserted.signatureImage,\r\n                metadata: upserted.metadata\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error upserting business settings:', error);\r\n        return { success: false, error: error.message || 'Failed to update settings' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAgCsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,gEAAA"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/hooks/useBusinessSettings.ts"],"sourcesContent":["\r\nimport { useState, useEffect } from 'react';\r\nimport { useQuery } from '@tanstack/react-query';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\nimport { useAuth } from '@/components/auth/AuthProvider';\r\nimport { getBusinessSettingsAction, upsertBusinessSettingsAction } from '@/app/actions/business-settings';\r\n\r\nexport interface BusinessSettings {\r\n  id?: string;\r\n  businessName: string;\r\n  businessAddress: string;\r\n  businessPhone: string;\r\n  businessEmail: string;\r\n  businessLogo?: string;\r\n  currency: string;\r\n  signature?: string;\r\n  paymentInfo?: string;\r\n  defaultPrintFormat?: 'standard' | 'thermal';\r\n  defaultPrinterName?: string;\r\n  defaultPrinterType?: 'USB' | 'Bluetooth';\r\n  printerPaperSize?: '58mm' | '80mm';\r\n}\r\n\r\n// Utility function to parse payment info text into structured format\r\nexport const parsePaymentInfo = (paymentInfo: string): { method: string, accountNumber: string, accountName: string }[] => {\r\n  if (!paymentInfo || paymentInfo.trim() === '') {\r\n    return [];\r\n  }\r\n\r\n  const lines = paymentInfo.split('\\n').filter(line => line.trim() !== '');\r\n  const methods: { method: string, accountNumber: string, accountName: string }[] = [];\r\n\r\n  for (let i = 0; i < lines.length; i += 3) {\r\n    if (i + 2 < lines.length) {\r\n      methods.push({\r\n        method: lines[i].trim(),\r\n        accountNumber: lines[i + 1].trim(),\r\n        accountName: lines[i + 2].trim()\r\n      });\r\n    }\r\n  }\r\n\r\n  return methods;\r\n};\r\n\r\n// Utility function to convert payment methods array back to string format\r\nexport const convertPaymentMethodsToString = (paymentMethods: { method: string, accountNumber: string, accountName: string }[]): string => {\r\n  return paymentMethods\r\n    .filter(pm => pm.method.trim() !== '' || pm.accountNumber.trim() !== '' || pm.accountName.trim() !== '')\r\n    .map(pm => `${pm.method}\\n${pm.accountNumber}\\n${pm.accountName}`)\r\n    .join('\\n');\r\n};\r\n\r\n// Default settings for new businesses\r\nconst getDefaultSettings = (): BusinessSettings => ({\r\n  businessName: '',\r\n  businessAddress: '',\r\n  businessPhone: '',\r\n  businessEmail: '',\r\n  currency: 'UGX',\r\n  paymentInfo: '',\r\n  defaultPrintFormat: 'standard'\r\n});\r\n\r\nexport const useBusinessSettings = () => {\r\n  const [settings, setSettings] = useState<BusinessSettings>(getDefaultSettings());\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const { toast } = useToast();\r\n  const { currentBusiness } = useBusiness();\r\n\r\n  const loadSettings = async (): Promise<BusinessSettings> => {\r\n    if (!currentBusiness) {\r\n      return getDefaultSettings();\r\n    }\r\n\r\n    try {\r\n      const data = await getBusinessSettingsAction(currentBusiness.id);\r\n\r\n      if (data) {\r\n        // Extract payment info from metadata\r\n        const paymentInfo = data.metadata && typeof data.metadata === 'object' ?\r\n          (data.metadata as Record<string, unknown>).payment_info as string || '' : '';\r\n\r\n        return {\r\n          id: data.id,\r\n          businessName: data.business_name,\r\n          businessAddress: data.business_address,\r\n          businessPhone: data.business_phone,\r\n          businessEmail: data.business_email,\r\n          businessLogo: data.business_logo,\r\n          currency: data.currency,\r\n          signature: data.signature,\r\n          paymentInfo: paymentInfo,\r\n          defaultPrintFormat: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).default_print_format as 'standard' | 'thermal' || 'standard' : 'standard',\r\n          defaultPrinterName: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).default_printer_name as string || '' : '',\r\n          defaultPrinterType: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).default_printer_type as 'USB' | 'Bluetooth' || 'USB' : 'USB',\r\n          printerPaperSize: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).printer_paper_size as '58mm' | '80mm' || '58mm' : '58mm'\r\n        };\r\n      } else {\r\n        return getDefaultSettings();\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading business settings:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to load business settings. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return getDefaultSettings();\r\n    }\r\n  };\r\n\r\n  const updateSettings = async (newSettings: Partial<BusinessSettings>) => {\r\n    if (!currentBusiness) {\r\n      console.error('No business selected for updating settings');\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No business selected\",\r\n        variant: \"destructive\"\r\n      });\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const userData = { user: { id: '00000000-0000-0000-0000-000000000000' } }; // Mocked user id for now\r\n\r\n      // Prepare the metadata object with payment info\r\n      const metadata = {\r\n        payment_info: newSettings.hasOwnProperty('paymentInfo') ? newSettings.paymentInfo : settings.paymentInfo || '',\r\n        default_print_format: newSettings.hasOwnProperty('defaultPrintFormat') ? newSettings.defaultPrintFormat : settings.defaultPrintFormat || 'standard',\r\n        default_printer_name: newSettings.hasOwnProperty('defaultPrinterName') ? newSettings.defaultPrinterName : settings.defaultPrinterName || '',\r\n        default_printer_type: newSettings.hasOwnProperty('defaultPrinterType') ? newSettings.defaultPrinterType : settings.defaultPrinterType || 'USB',\r\n        printer_paper_size: newSettings.hasOwnProperty('printerPaperSize') ? newSettings.printerPaperSize : settings.printerPaperSize || '58mm'\r\n      };\r\n\r\n      const updateData = {\r\n        business_name: newSettings.hasOwnProperty('businessName') ? newSettings.businessName : settings.businessName,\r\n        business_address: newSettings.hasOwnProperty('businessAddress') ? newSettings.businessAddress : settings.businessAddress,\r\n        business_phone: newSettings.hasOwnProperty('businessPhone') ? newSettings.businessPhone : settings.businessPhone,\r\n        business_email: newSettings.hasOwnProperty('businessEmail') ? newSettings.businessEmail : settings.businessEmail,\r\n        business_logo: newSettings.hasOwnProperty('businessLogo') ? newSettings.businessLogo : settings.businessLogo,\r\n        currency: newSettings.hasOwnProperty('currency') ? newSettings.currency : settings.currency,\r\n        signature: newSettings.hasOwnProperty('signature') ? newSettings.signature : settings.signature,\r\n        metadata: metadata\r\n      };\r\n\r\n      const response = await upsertBusinessSettingsAction(currentBusiness.id, userData.user.id, updateData);\r\n\r\n      if (!response.success) {\r\n        console.error('Supabase error updating business settings:', response.error);\r\n        throw new Error(response.error);\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Business settings updated successfully\"\r\n      });\r\n\r\n      // Refetch settings after update\r\n      refetch();\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating business settings:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to update business settings. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // React Query for settings loading with proper caching\r\n  const { data: queriedData, isLoading: isQueryLoading, isFetching, refetch } = useQuery({\r\n    queryKey: ['businessSettings', currentBusiness?.id],\r\n    queryFn: loadSettings,\r\n    enabled: !!currentBusiness?.id,\r\n    staleTime: 5 * 60_000,\r\n    gcTime: 30 * 60_000,\r\n    refetchOnWindowFocus: false,\r\n    refetchOnReconnect: false,\r\n  });\r\n\r\n  // Sync React Query data with local state\r\n  useEffect(() => {\r\n    if (queriedData) {\r\n      setSettings(queriedData);\r\n    } else if (!currentBusiness) {\r\n      setSettings(getDefaultSettings());\r\n    }\r\n  }, [queriedData, currentBusiness]);\r\n\r\n  // Sync loading state from React Query\r\n  useEffect(() => {\r\n    setIsLoading(isQueryLoading || isFetching);\r\n  }, [isQueryLoading, isFetching]);\r\n\r\n  return {\r\n    settings,\r\n    isLoading,\r\n    updateSettings,\r\n    loadSettings\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 277, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/hooks/useProductImage.ts"],"sourcesContent":["import { useToast } from '@/hooks/use-toast';\r\nimport { supabase } from '@/integrations/supabase/client';\r\n\r\n/**\r\n * Hook for handling product image uploads with enhanced compression\r\n */\r\nexport const useProductImage = (userId: string | undefined) => {\r\n  const { toast } = useToast();\r\n\r\n  /**\r\n   * Progressive compression that guarantees file size under 10KB\r\n   * @param file The original image file\r\n   * @returns A promise that resolves to the compressed file\r\n   */\r\n  const compressImage = async (file: File): Promise<File> => {\r\n    const MAX_SIZE_KB = 10;\r\n    const MAX_SIZE_BYTES = MAX_SIZE_KB * 1024;\r\n    \r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        const reader = new FileReader();\r\n        reader.onerror = () => {\r\n          console.error('FileReader error');\r\n          reject(new Error('Failed to read file'));\r\n        };\r\n        \r\n        reader.onload = (event) => {\r\n          try {\r\n            const img = new Image();\r\n            img.onerror = () => {\r\n              console.error('Image load error');\r\n              reject(new Error('Failed to load image'));\r\n            };\r\n            \r\n            img.onload = () => {\r\n              try {\r\n                // Progressive compression function\r\n                const compressWithQuality = (width: number, height: number, quality: number): Promise<File> => {\r\n                  return new Promise((resolveCompress) => {\r\n                    const canvas = document.createElement('canvas');\r\n                    canvas.width = width;\r\n                    canvas.height = height;\r\n                    \r\n                    const ctx = canvas.getContext('2d');\r\n                    if (!ctx) {\r\n                      reject(new Error('Could not get canvas context'));\r\n                      return;\r\n                    }\r\n                    \r\n                    // Clear canvas and draw image\r\n                    ctx.clearRect(0, 0, width, height);\r\n                    ctx.drawImage(img, 0, 0, width, height);\r\n                    \r\n                    // Convert to JPEG with specified quality\r\n                    canvas.toBlob(\r\n                      (blob) => {\r\n                        if (!blob) {\r\n                          reject(new Error('Could not compress image'));\r\n                          return;\r\n                        }\r\n                        \r\n                        const compressedFile = new File([blob], `${file.name.replace(/\\.[^/.]+$/, '')}-optimized.jpg`, {\r\n                          type: 'image/jpeg',\r\n                          lastModified: Date.now(),\r\n                        });\r\n                        \r\n                        resolveCompress(compressedFile);\r\n                      },\r\n                      'image/jpeg',\r\n                      quality\r\n                    );\r\n                  });\r\n                };\r\n                \r\n                // Progressive compression algorithm\r\n                const progressiveCompress = async () => {\r\n                  let { width, height } = img;\r\n                  \r\n                  // Start with reasonable dimensions and quality\r\n                  const maxDimension = 400;\r\n                  if (width > maxDimension || height > maxDimension) {\r\n                    const aspectRatio = width / height;\r\n                    if (width > height) {\r\n                      width = maxDimension;\r\n                      height = width / aspectRatio;\r\n                    } else {\r\n                      height = maxDimension;\r\n                      width = height * aspectRatio;\r\n                    }\r\n                  }\r\n                  \r\n                  // Ensure dimensions are valid\r\n                  width = Math.max(50, Math.floor(width));\r\n                  height = Math.max(50, Math.floor(height));\r\n                  \r\n                  // Try different quality levels\r\n                  const qualityLevels = [0.8, 0.6, 0.4, 0.3, 0.2, 0.1, 0.05, 0.02, 0.01];\r\n                  \r\n                  for (const quality of qualityLevels) {\r\n                    const compressedFile = await compressWithQuality(width, height, quality);\r\n                    \r\n                    if (compressedFile.size <= MAX_SIZE_BYTES) {\r\n                      console.log(`Image compression successful:`);\r\n                      console.log(`  Original: ${(file.size / 1024).toFixed(1)}KB`);\r\n                      console.log(`  Compressed: ${(compressedFile.size / 1024).toFixed(1)}KB`);\r\n                      console.log(`  Reduction: ${((file.size - compressedFile.size) / file.size * 100).toFixed(1)}%`);\r\n                      console.log(`  Dimensions: ${width}x${height}px`);\r\n                      console.log(`  Quality: ${(quality * 100).toFixed(0)}%`);\r\n                      \r\n                      return compressedFile;\r\n                    }\r\n                  }\r\n                  \r\n                  // If still too large, reduce dimensions further\r\n                  const dimensionReductions = [0.8, 0.6, 0.5, 0.4, 0.3, 0.25, 0.2];\r\n                  \r\n                  for (const reduction of dimensionReductions) {\r\n                    const newWidth = Math.max(50, Math.floor(width * reduction));\r\n                    const newHeight = Math.max(50, Math.floor(height * reduction));\r\n                    \r\n                    for (const quality of [0.1, 0.05, 0.02, 0.01]) {\r\n                      const compressedFile = await compressWithQuality(newWidth, newHeight, quality);\r\n                      \r\n                      if (compressedFile.size <= MAX_SIZE_BYTES) {\r\n                        console.log(`Image compression successful with dimension reduction:`);\r\n                        console.log(`  Original: ${(file.size / 1024).toFixed(1)}KB`);\r\n                        console.log(`  Compressed: ${(compressedFile.size / 1024).toFixed(1)}KB`);\r\n                        console.log(`  Reduction: ${((file.size - compressedFile.size) / file.size * 100).toFixed(1)}%`);\r\n                        console.log(`  Dimensions: ${newWidth}x${newHeight}px`);\r\n                        console.log(`  Quality: ${(quality * 100).toFixed(0)}%`);\r\n                        \r\n                        return compressedFile;\r\n                      }\r\n                    }\r\n                  }\r\n                  \r\n                  // Final fallback - create a very small image\r\n                  const finalFile = await compressWithQuality(50, 50, 0.01);\r\n                  console.log(`Image compression fallback:`);\r\n                  console.log(`  Original: ${(file.size / 1024).toFixed(1)}KB`);\r\n                  console.log(`  Compressed: ${(finalFile.size / 1024).toFixed(1)}KB`);\r\n                  console.log(`  Dimensions: 50x50px`);\r\n                  \r\n                  return finalFile;\r\n                };\r\n                \r\n                progressiveCompress().then(resolve).catch(reject);\r\n                \r\n              } catch (error) {\r\n                console.error('Canvas processing error:', error);\r\n                reject(new Error('Failed to process image on canvas'));\r\n              }\r\n            };\r\n            \r\n            img.src = event.target?.result as string;\r\n          } catch (error) {\r\n            console.error('Image creation error:', error);\r\n            reject(new Error('Failed to create image'));\r\n          }\r\n        };\r\n        \r\n        reader.readAsDataURL(file);\r\n      } catch (error) {\r\n        console.error('File reading setup error:', error);\r\n        reject(new Error('Failed to setup file reader'));\r\n      }\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Additional optimization to remove EXIF data and metadata\r\n   * @param file The image file to optimize\r\n   * @returns Promise resolving to optimized file\r\n   */\r\n  const removeMetadata = async (file: File): Promise<File> => {\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        const reader = new FileReader();\r\n        reader.onerror = () => reject(new Error('Failed to read file'));\r\n        \r\n        reader.onload = (event) => {\r\n          try {\r\n            const img = new Image();\r\n            img.onerror = () => reject(new Error('Failed to load image'));\r\n            \r\n            img.onload = () => {\r\n              try {\r\n                const canvas = document.createElement('canvas');\r\n                canvas.width = img.width;\r\n                canvas.height = img.height;\r\n                \r\n                const ctx = canvas.getContext('2d');\r\n                if (!ctx) {\r\n                  reject(new Error('Could not get canvas context'));\r\n                  return;\r\n                }\r\n                \r\n                ctx.drawImage(img, 0, 0);\r\n                \r\n                canvas.toBlob(\r\n                  (blob) => {\r\n                    if (!blob) {\r\n                      reject(new Error('Could not process image'));\r\n                      return;\r\n                    }\r\n                    \r\n                    const cleanFile = new File([blob], file.name, {\r\n                      type: file.type,\r\n                      lastModified: Date.now(),\r\n                    });\r\n                    \r\n                    resolve(cleanFile);\r\n                  },\r\n                  file.type,\r\n                  0.95\r\n                );\r\n              } catch (error) {\r\n                console.error('Metadata removal canvas error:', error);\r\n                reject(new Error('Failed to process image'));\r\n              }\r\n            };\r\n            \r\n            img.src = event.target?.result as string;\r\n          } catch (error) {\r\n            console.error('Metadata removal image error:', error);\r\n            reject(new Error('Failed to load image'));\r\n          }\r\n        };\r\n        \r\n        reader.readAsDataURL(file);\r\n      } catch (error) {\r\n        console.error('Metadata removal setup error:', error);\r\n        reject(new Error('Failed to setup file reader'));\r\n      }\r\n    });\r\n  };\r\n\r\n  const uploadProductImage = async (file: File): Promise<string | null> => {\r\n    try {\r\n      if (!userId || !file) {\r\n        console.error('Missing userId or file for image upload');\r\n        toast({\r\n          title: \"Error\",\r\n          description: \"Missing user ID or file for image upload.\",\r\n          variant: \"destructive\"\r\n        });\r\n        return null;\r\n      }\r\n      \r\n      // Check if the file is an image\r\n      if (!file.type.startsWith('image/')) {\r\n        toast({\r\n          title: \"Error\",\r\n          description: \"Only image files are allowed.\",\r\n          variant: \"destructive\"\r\n        });\r\n        return null;\r\n      }\r\n\r\n      // Check file size (max 20MB before compression)\r\n      if (file.size > 20 * 1024 * 1024) {\r\n        toast({\r\n          title: \"Error\",\r\n          description: \"Image file is too large. Maximum size is 20MB.\",\r\n          variant: \"destructive\"\r\n        });\r\n        return null;\r\n      }\r\n      \r\n      console.log('Starting image processing...');\r\n      \r\n      // Show compression progress\r\n      toast({\r\n        title: \"Processing Image\",\r\n        description: \"Optimizing image to under 10KB...\",\r\n      });\r\n      \r\n      // Remove metadata first, then compress\r\n      console.log('Removing metadata...');\r\n      const cleanFile = await removeMetadata(file);\r\n      \r\n      console.log('Compressing image...');\r\n      const compressedFile = await compressImage(cleanFile);\r\n      \r\n      // Verify final size\r\n      const finalSizeKB = compressedFile.size / 1024;\r\n      console.log(`Final compressed size: ${finalSizeKB.toFixed(1)}KB`);\r\n      \r\n      // Show compression results to user\r\n      const compressionRatio = ((file.size - compressedFile.size) / file.size * 100);\r\n      toast({\r\n        title: \"Image Optimized\",\r\n        description: `File compressed to ${finalSizeKB.toFixed(1)}KB (${compressionRatio.toFixed(1)}% reduction)`,\r\n      });\r\n      \r\n      // Create a unique filename using timestamp and random string\r\n      const timestamp = Date.now();\r\n      const randomString = Math.random().toString(36).substring(2, 10);\r\n      const fileName = `${userId}/${timestamp}-${randomString}.jpg`;\r\n      \r\n      console.log('Uploading to Supabase storage...');\r\n      \r\n      // Upload with timeout and retry logic\r\n      const uploadWithTimeout = async (attempt = 1): Promise<any> => {\r\n        const controller = new AbortController();\r\n        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\r\n        \r\n        try {\r\n          const { data, error } = await supabase.storage\r\n            .from('product-images')\r\n            .upload(fileName, compressedFile, {\r\n              cacheControl: '3600',\r\n              upsert: true,\r\n            });\r\n          \r\n          clearTimeout(timeoutId);\r\n          \r\n          if (error) {\r\n            console.error('Supabase upload error:', error);\r\n            throw error;\r\n          }\r\n          return data;\r\n        } catch (error) {\r\n          clearTimeout(timeoutId);\r\n          \r\n          if (attempt < 3 && (error.name === 'AbortError' || error.message?.includes('timeout'))) {\r\n            console.log(`Upload attempt ${attempt} failed, retrying...`);\r\n            await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // Progressive delay\r\n            return uploadWithTimeout(attempt + 1);\r\n          }\r\n          throw error;\r\n        }\r\n      };\r\n\r\n      const data = await uploadWithTimeout();\r\n\r\n      // Get public URL\r\n      const { data: urlData } = supabase\r\n        .storage\r\n        .from('product-images')\r\n        .getPublicUrl(data.path);\r\n\r\n      console.log('Upload successful, public URL:', urlData.publicUrl);\r\n      return urlData.publicUrl;\r\n    } catch (error) {\r\n      console.error('Error uploading product image:', error);\r\n      \r\n      let errorMessage = \"Failed to process image. Please try again.\";\r\n      \r\n      if (error.name === 'AbortError' || error.message?.includes('timeout')) {\r\n        errorMessage = \"Upload timed out. Please check your connection and try again.\";\r\n      } else if (error.message?.includes('storage')) {\r\n        errorMessage = \"Storage service error. Please try again later.\";\r\n      } else if (error.message?.includes('network')) {\r\n        errorMessage = \"Network error. Please check your connection.\";\r\n      } else if (error.message?.includes('canvas') || error.message?.includes('compress')) {\r\n        errorMessage = \"Failed to process image. Please try a different image or smaller file size.\";\r\n      }\r\n      \r\n      toast({\r\n        title: \"Upload Error\",\r\n        description: errorMessage,\r\n        variant: \"destructive\"\r\n      });\r\n      return null;\r\n    }\r\n  };\r\n\r\n  return {\r\n    uploadProductImage,\r\n    compressImage, // Export for testing or direct usage if needed\r\n    removeMetadata // Export metadata removal function\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 619, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/components/ui/popover.tsx"],"sourcesContent":["import * as React from \"react\"\r\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst Popover = PopoverPrimitive.Root\r\n\r\nconst PopoverTrigger = PopoverPrimitive.Trigger\r\n\r\nconst PopoverContent = React.forwardRef<\r\n  React.ElementRef<typeof PopoverPrimitive.Content>,\r\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\r\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\r\n  <PopoverPrimitive.Portal>\r\n    <PopoverPrimitive.Content\r\n      ref={ref}\r\n      align={align}\r\n      sideOffset={sideOffset}\r\n      className={cn(\r\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  </PopoverPrimitive.Portal>\r\n))\r\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\r\n\r\nexport { Popover, PopoverTrigger, PopoverContent }\r\n"],"names":[],"mappings":";;;;;;;;;AAAA;AACA;AAEA;;;;;AAEA,MAAM,UAAU,8KAAqB;AAErC,MAAM,iBAAiB,iLAAwB;AAE/C,MAAM,+BAAiB,2KAAgB,MAGrC,CAAC,EAAE,SAAS,EAAE,QAAQ,QAAQ,EAAE,aAAa,CAAC,EAAE,GAAG,OAAO,EAAE,oBAC5D,6LAAC,gLAAuB;kBACtB,cAAA,6LAAC,iLAAwB;YACvB,KAAK;YACL,OAAO;YACP,YAAY;YACZ,WAAW,IAAA,4HAAE,EACX,8aACA;YAED,GAAG,KAAK;;;;;;;;;;;;AAIf,eAAe,WAAW,GAAG,iLAAwB,CAAC,WAAW"}},
    {"offset": {"line": 667, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/components/ui/calendar.tsx"],"sourcesContent":["\r\nimport * as React from \"react\";\r\nimport { ChevronLeft, ChevronRight } from \"lucide-react\";\r\nimport { DayPicker } from \"react-day-picker\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\nimport { buttonVariants } from \"@/components/ui/button\";\r\n\r\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>;\r\n\r\nfunction Calendar({\r\n  className,\r\n  classNames,\r\n  showOutsideDays = true,\r\n  ...props\r\n}: CalendarProps) {\r\n  return (\r\n    <DayPicker\r\n      showOutsideDays={showOutsideDays}\r\n      className={cn(\"p-3 pointer-events-auto\", className)}\r\n      classNames={{\r\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\r\n        month: \"space-y-4\",\r\n        caption: \"flex justify-center pt-1 relative items-center\",\r\n        caption_label: \"text-sm font-medium\",\r\n        caption_dropdowns: \"flex justify-center gap-1\",\r\n        nav: \"space-x-1 flex items-center\",\r\n        nav_button: cn(\r\n          buttonVariants({ variant: \"outline\" }),\r\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\r\n        ),\r\n        nav_button_previous: \"absolute left-1\",\r\n        nav_button_next: \"absolute right-1\",\r\n        table: \"w-full border-collapse space-y-1\",\r\n        head_row: \"flex\",\r\n        head_cell:\r\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\r\n        row: \"flex w-full mt-2\",\r\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\r\n        day: cn(\r\n          buttonVariants({ variant: \"ghost\" }),\r\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\r\n        ),\r\n        day_range_end: \"day-range-end\",\r\n        day_selected:\r\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\r\n        day_today: \"bg-accent text-accent-foreground\",\r\n        day_outside:\r\n          \"day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30\",\r\n        day_disabled: \"text-muted-foreground opacity-50\",\r\n        day_range_middle:\r\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\r\n        day_hidden: \"invisible\",\r\n        dropdown: \"bg-background rounded-md border p-1 shadow-md\",\r\n        dropdown_month: \"w-[var(--rdp-caption-dropdown-month-width)]\",\r\n        dropdown_year: \"w-[var(--rdp-caption-dropdown-year-width)]\",\r\n        dropdown_icon: \"w-4 h-4\",\r\n        button_reset: \"appearance-none bg-transparent border-none p-0 m-0\",\r\n        vhidden: \"sr-only\",\r\n        ...classNames,\r\n      }}\r\n      components={{\r\n        IconLeft: ({ ..._props }) => <ChevronLeft className=\"h-4 w-4\" />,\r\n        IconRight: ({ ..._props }) => <ChevronRight className=\"h-4 w-4\" />,\r\n      }}\r\n      {...props}\r\n    />\r\n  );\r\n}\r\nCalendar.displayName = \"Calendar\";\r\n\r\nexport { Calendar };\r\n"],"names":[],"mappings":";;;;;AAEA;AAAA;AACA;AAEA;AACA;;;;;;AAIA,SAAS,SAAS,EAChB,SAAS,EACT,UAAU,EACV,kBAAkB,IAAI,EACtB,GAAG,OACW;IACd,qBACE,6LAAC,8KAAS;QACR,iBAAiB;QACjB,WAAW,IAAA,4HAAE,EAAC,2BAA2B;QACzC,YAAY;YACV,QAAQ;YACR,OAAO;YACP,SAAS;YACT,eAAe;YACf,mBAAmB;YACnB,KAAK;YACL,YAAY,IAAA,4HAAE,EACZ,IAAA,uJAAc,EAAC;gBAAE,SAAS;YAAU,IACpC;YAEF,qBAAqB;YACrB,iBAAiB;YACjB,OAAO;YACP,UAAU;YACV,WACE;YACF,KAAK;YACL,MAAM;YACN,KAAK,IAAA,4HAAE,EACL,IAAA,uJAAc,EAAC;gBAAE,SAAS;YAAQ,IAClC;YAEF,eAAe;YACf,cACE;YACF,WAAW;YACX,aACE;YACF,cAAc;YACd,kBACE;YACF,YAAY;YACZ,UAAU;YACV,gBAAgB;YAChB,eAAe;YACf,eAAe;YACf,cAAc;YACd,SAAS;YACT,GAAG,UAAU;QACf;QACA,YAAY;YACV,UAAU,CAAC,EAAE,GAAG,QAAQ,iBAAK,6LAAC,sOAAW;oBAAC,WAAU;;;;;;YACpD,WAAW,CAAC,EAAE,GAAG,QAAQ,iBAAK,6LAAC,yOAAY;oBAAC,WAAU;;;;;;QACxD;QACC,GAAG,KAAK;;;;;;AAGf;KA1DS;AA2DT,SAAS,WAAW,GAAG"}},
    {"offset": {"line": 756, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/components/ui/switch.tsx"],"sourcesContent":["import * as React from \"react\"\r\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst Switch = React.forwardRef<\r\n  React.ElementRef<typeof SwitchPrimitives.Root>,\r\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\r\n>(({ className, ...props }, ref) => (\r\n  <SwitchPrimitives.Root\r\n    className={cn(\r\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\r\n      className\r\n    )}\r\n    {...props}\r\n    ref={ref}\r\n  >\r\n    <SwitchPrimitives.Thumb\r\n      className={cn(\r\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\r\n      )}\r\n    />\r\n  </SwitchPrimitives.Root>\r\n))\r\nSwitch.displayName = SwitchPrimitives.Root.displayName\r\n\r\nexport { Switch }\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AAEA;;;;;AAEA,MAAM,uBAAS,2KAAgB,MAG7B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,6LAAC,6KAAqB;QACpB,WAAW,IAAA,4HAAE,EACX,sXACA;QAED,GAAG,KAAK;QACT,KAAK;kBAEL,cAAA,6LAAC,8KAAsB;YACrB,WAAW,IAAA,4HAAE,EACX;;;;;;;;;;;;AAKR,OAAO,WAAW,GAAG,6KAAqB,CAAC,WAAW"}},
    {"offset": {"line": 797, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/components/inventory/ProductForm.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, DragEvent } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport { Product, ProductCategory, ProductFormData } from '@/types';\r\nimport { useBusinessSettings } from '@/hooks/useBusinessSettings';\r\nimport { toast } from 'sonner';\r\nimport { Trash2, Upload, ExternalLink, Loader2, Zap, Calendar, Printer } from 'lucide-react';\r\nimport { useAuth } from '@/components/auth/AuthProvider';\r\nimport { useProductImage } from '@/hooks/useProductImage';\r\nimport { cn } from '@/lib/utils';\r\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\r\nimport { Calendar as CalendarComponent } from '@/components/ui/calendar';\r\nimport { format } from 'date-fns';\r\nimport { Switch } from '@/components/ui/switch';\r\n\r\ninterface ProductFormProps {\r\n  initialData?: Product;\r\n  categories: ProductCategory[];\r\n  onProductSubmit: (data: ProductFormData & { autoPrintLabel?: boolean, printQuantity?: number }) => void;\r\n  isLoading: boolean;\r\n}\r\n\r\n// Extended form data type to handle quantity as string or number\r\ninterface ExtendedProductFormData extends Omit<ProductFormData, 'quantity'> {\r\n  quantity: number | string;\r\n  createdAt?: Date;\r\n  autoPrintLabel?: boolean;\r\n  printQuantity: number;\r\n}\r\n\r\nconst ProductForm: React.FC<ProductFormProps> = ({\r\n  initialData,\r\n  categories,\r\n  onProductSubmit,\r\n  isLoading,\r\n}) => {\r\n  const navigate = useNavigate();\r\n  const { settings } = useBusinessSettings();\r\n  const { user } = useAuth();\r\n  const { uploadProductImage, compressImage } = useProductImage(user?.id);\r\n\r\n  // Function to get initial form data\r\n  const getInitialFormData = (productData?: Product): ExtendedProductFormData => {\r\n    if (productData) {\r\n      // When editing/duplicating, use the product's data\r\n      return {\r\n        name: productData.name,\r\n        barcode: productData.barcode || '',\r\n        manufacturerBarcode: productData.manufacturerBarcode || '',\r\n        description: productData.description || '',\r\n        category: productData.category,\r\n        quantity: productData.quantity ?? 0,\r\n        costPrice: productData.costPrice,\r\n        sellingPrice: productData.sellingPrice,\r\n        supplier: productData.supplier || '',\r\n        minimumStock: productData.minimumStock,\r\n        imageFile: null,\r\n        imageUrl: productData.imageUrl,\r\n        createdAt: productData.createdAt || new Date(), // Use product's creation date\r\n        printQuantity: 1,\r\n        autoPrintLabel: false\r\n      };\r\n    } else {\r\n      // When creating new product, use defaults\r\n      return {\r\n        name: '',\r\n        barcode: '',\r\n        manufacturerBarcode: '',\r\n        description: '',\r\n        category: '',\r\n        quantity: 0,\r\n        costPrice: undefined,\r\n        sellingPrice: undefined,\r\n        supplier: '',\r\n        minimumStock: undefined,\r\n        imageFile: null,\r\n        imageUrl: null,\r\n        createdAt: new Date(), // Default to current date for new products\r\n        autoPrintLabel: true, // Default to true for new products as requested\r\n        printQuantity: 1\r\n      };\r\n    }\r\n  };\r\n\r\n  // Form state - initialize with proper data immediately\r\n  const [formData, setFormData] = useState<ExtendedProductFormData>(() =>\r\n    getInitialFormData(initialData)\r\n  );\r\n\r\n  const [errors, setErrors] = useState<Record<string, string>>({});\r\n  const [imagePreview, setImagePreview] = useState<string | null>(null);\r\n  const [imageChanged, setImageChanged] = useState(false);\r\n  const [uploading, setUploading] = useState(false);\r\n  const [compressing, setCompressing] = useState(false);\r\n  const [isDragging, setIsDragging] = useState(false);\r\n  const [compressionStats, setCompressionStats] = useState<{\r\n    originalSize: number;\r\n    compressedSize: number;\r\n    reduction: number;\r\n  } | null>(null);\r\n  const [isCalendarOpen, setIsCalendarOpen] = useState(false);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Update form data when initialData changes\r\n  useEffect(() => {\r\n    if (initialData) {\r\n      console.log('ProductForm - Setting form data from initialData:', initialData);\r\n      console.log('ProductForm - InitialData createdAt:', initialData.createdAt);\r\n\r\n      const newFormData = getInitialFormData(initialData);\r\n      setFormData(newFormData);\r\n\r\n      console.log('ProductForm - Form data set to:', newFormData);\r\n      console.log('ProductForm - Form createdAt set to:', newFormData.createdAt);\r\n\r\n      if (initialData.imageUrl) {\r\n        setImagePreview(initialData.imageUrl);\r\n      }\r\n    }\r\n  }, [initialData]);\r\n\r\n  const handleChange = (\r\n    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>\r\n  ) => {\r\n    const { name, value } = e.target;\r\n    let processedValue: any = value;\r\n\r\n    // Convert numeric fields to numbers or undefined if empty\r\n    if (\r\n      name === 'quantity' ||\r\n      name === 'minimumStock' ||\r\n      name === 'costPrice' ||\r\n      name === 'sellingPrice'\r\n    ) {\r\n      // For quantity, allow empty string and convert to number when not empty\r\n      if (name === 'quantity') {\r\n        if (value === '') {\r\n          processedValue = ''; // Keep as empty string to allow deletion\r\n        } else {\r\n          processedValue = parseFloat(value) || 0; // Allow decimal values\r\n        }\r\n        console.log('Quantity changed to:', processedValue);\r\n      } else {\r\n        processedValue = value === '' ? undefined : parseFloat(value);\r\n      }\r\n    }\r\n\r\n    setFormData({\r\n      ...formData,\r\n      [name]: processedValue\r\n    });\r\n\r\n    // Clear error when field is edited\r\n    if (errors[name]) {\r\n      setErrors({\r\n        ...errors,\r\n        [name]: ''\r\n      });\r\n    }\r\n  };\r\n\r\n  const handleCategoryChange = (value: string) => {\r\n    setFormData({\r\n      ...formData,\r\n      category: value\r\n    });\r\n\r\n    if (errors.category) {\r\n      setErrors({\r\n        ...errors,\r\n        category: ''\r\n      });\r\n    }\r\n\r\n    // Focus description field after category selection\r\n    setTimeout(() => {\r\n      document.getElementById('description')?.focus();\r\n    }, 100);\r\n  };\r\n\r\n  const handleDateChange = (date: Date | undefined) => {\r\n    if (date) {\r\n      // Set time to Noon (12:00:00) to avoid timezone issues where midnight UTC becomes 3 AM EAT\r\n      const adjustedDate = new Date(date);\r\n      adjustedDate.setHours(12, 0, 0, 0);\r\n\r\n      console.log('ProductForm - Date changed to:', adjustedDate);\r\n      setFormData({\r\n        ...formData,\r\n        createdAt: adjustedDate\r\n      });\r\n      setIsCalendarOpen(false);\r\n    }\r\n  };\r\n\r\n  const processImageFile = async (file: File) => {\r\n    if (file.size > 20 * 1024 * 1024) { // 20MB\r\n      toast.error('Image file is too large. Maximum size is 20MB.');\r\n      return;\r\n    }\r\n\r\n    if (!file.type.startsWith('image/')) {\r\n      toast.error('Only image files are allowed.');\r\n      return;\r\n    }\r\n\r\n    setCompressing(true);\r\n    setCompressionStats(null);\r\n\r\n    try {\r\n      // Use the compressImage function from the properly called hook\r\n      const compressedFile = await compressImage(file);\r\n\r\n      // Calculate compression stats\r\n      const reduction = ((file.size - compressedFile.size) / file.size * 100);\r\n      setCompressionStats({\r\n        originalSize: file.size,\r\n        compressedSize: compressedFile.size,\r\n        reduction: reduction\r\n      });\r\n\r\n      setFormData({\r\n        ...formData,\r\n        imageFile: compressedFile\r\n      });\r\n\r\n      setImageChanged(true);\r\n\r\n      // Create preview\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        setImagePreview(reader.result as string);\r\n      };\r\n      reader.readAsDataURL(compressedFile);\r\n\r\n      toast.success(`Image optimized to ${(compressedFile.size / 1024).toFixed(1)}KB!`);\r\n    } catch (error) {\r\n      console.error('Error compressing image:', error);\r\n      toast.error('Failed to process image. Please try again.');\r\n    } finally {\r\n      setCompressing(false);\r\n    }\r\n  };\r\n\r\n  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n\r\n    if (file) {\r\n      processImageFile(file);\r\n    }\r\n  };\r\n\r\n  const handleDragOver = (e: DragEvent<HTMLDivElement>) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    setIsDragging(true);\r\n  };\r\n\r\n  const handleDragLeave = (e: DragEvent<HTMLDivElement>) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    setIsDragging(false);\r\n  };\r\n\r\n  const handleDrop = (e: DragEvent<HTMLDivElement>) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    setIsDragging(false);\r\n\r\n    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {\r\n      const file = e.dataTransfer.files[0];\r\n      processImageFile(file);\r\n    }\r\n  };\r\n\r\n  const handleImageUploadClick = () => {\r\n    fileInputRef.current?.click();\r\n  };\r\n\r\n  const removeImage = () => {\r\n    setFormData({\r\n      ...formData,\r\n      imageFile: null,\r\n      imageUrl: null  // Clear the image URL when removing image\r\n    });\r\n    setImagePreview(null);\r\n    setImageChanged(true);\r\n    setCompressionStats(null);\r\n\r\n    // Reset the file input\r\n    if (fileInputRef.current) {\r\n      fileInputRef.current.value = '';\r\n    }\r\n  };\r\n\r\n  const validateForm = (): boolean => {\r\n    const newErrors: Record<string, string> = {};\r\n\r\n    if (!formData.name.trim()) {\r\n      newErrors.name = 'Product name is required';\r\n    }\r\n\r\n    // Category is optional, so no validation needed\r\n\r\n    // Note: Initial stock can now be negative to handle cases like backorders or inventory deficits\r\n    // Removed validation that prevented negative initial stock values\r\n\r\n    if (formData.costPrice !== undefined && formData.costPrice < 0) {\r\n      newErrors.costPrice = 'Cost price cannot be negative';\r\n    }\r\n\r\n    if (formData.sellingPrice !== undefined && formData.sellingPrice < 0) {\r\n      newErrors.sellingPrice = 'Selling price cannot be negative';\r\n    }\r\n\r\n    if (formData.minimumStock !== undefined && formData.minimumStock < 0) {\r\n      newErrors.minimumStock = 'Minimum stock cannot be negative';\r\n    }\r\n\r\n    setErrors(newErrors);\r\n    return Object.keys(newErrors).length === 0;\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    console.log('ProductForm - Form data before validation:', formData);\r\n    console.log('ProductForm - Quantity value:', formData.quantity, 'Type:', typeof formData.quantity);\r\n    console.log('ProductForm - CreatedAt value:', formData.createdAt);\r\n\r\n    if (!validateForm()) {\r\n      toast.error('Please correct the errors in the form');\r\n      return;\r\n    }\r\n\r\n    let finalImageUrl = formData.imageUrl;\r\n\r\n    try {\r\n      // Handle image upload separately if needed\r\n      if (imageChanged && formData.imageFile) {\r\n        setUploading(true);\r\n        toast.info('Uploading optimized image...');\r\n        finalImageUrl = await uploadProductImage(formData.imageFile);\r\n\r\n        if (!finalImageUrl) {\r\n          setUploading(false);\r\n          return; // Stop if image upload failed - error is already shown by the hook\r\n        }\r\n        toast.success('Image uploaded successfully!');\r\n      } else if (imageChanged && !formData.imageFile) {\r\n        // Image was removed\r\n        finalImageUrl = null;\r\n      }\r\n\r\n      // Prepare final submission data - convert empty string quantity to 0\r\n      const finalQuantity = typeof formData.quantity === 'string' ? (formData.quantity === '' ? 0 : Number(formData.quantity)) : formData.quantity;\r\n      const submissionData = {\r\n        ...formData,\r\n        imageUrl: finalImageUrl,\r\n        quantity: finalQuantity // Convert to number for submission\r\n      };\r\n\r\n      console.log('ProductForm - Final submission data:', submissionData);\r\n      console.log('ProductForm - Final quantity being submitted:', submissionData.quantity);\r\n      console.log('ProductForm - Final createdAt being submitted:', submissionData.createdAt);\r\n\r\n      // Submit form with final image URL\r\n      await onProductSubmit(submissionData);\r\n    } catch (error) {\r\n      console.error('Error handling form submission:', error);\r\n      toast.error('Something went wrong. Please try again.');\r\n    } finally {\r\n      setUploading(false);\r\n    }\r\n  };\r\n\r\n  const isSubmitting = isLoading || uploading;\r\n\r\n  return (\r\n    <Card className=\"w-full\">\r\n      <CardHeader>\r\n        <CardTitle>{initialData ? 'Edit Product' : 'New Product'}</CardTitle>\r\n        <CardDescription>Enter the product details below. Only name is required.</CardDescription>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n          <div className=\"grid md:grid-cols-2 gap-6\">\r\n            <div className=\"space-y-6\">\r\n              <div className=\"grid gap-3\">\r\n                <Label htmlFor=\"name\">Product Name*</Label>\r\n                <Input\r\n                  id=\"name\"\r\n                  name=\"name\"\r\n                  value={formData.name}\r\n                  onChange={handleChange}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter') {\r\n                      e.preventDefault();\r\n                      const categorySelect = document.querySelector('[role=\"combobox\"]') as HTMLElement;\r\n                      categorySelect?.focus();\r\n                    }\r\n                  }}\r\n                  placeholder=\"Enter product name\"\r\n                  className={errors.name ? 'border-red-500' : ''}\r\n                  disabled={isSubmitting}\r\n                />\r\n                {errors.name && (\r\n                  <p className=\"text-red-500 text-xs\">{errors.name}</p>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"grid gap-3\">\r\n                <Label htmlFor=\"manufacturerBarcode\">Manufacturer Barcode (Optional)</Label>\r\n                <Input\r\n                  id=\"manufacturerBarcode\"\r\n                  name=\"manufacturerBarcode\"\r\n                  value={formData.manufacturerBarcode}\r\n                  onChange={handleChange}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter') {\r\n                      e.preventDefault();\r\n                      const categorySelect = document.querySelector('[role=\"combobox\"]') as HTMLElement;\r\n                      categorySelect?.focus();\r\n                    }\r\n                  }}\r\n                  placeholder=\"Enter manufacturer barcode (if any)\"\r\n                  disabled={isSubmitting}\r\n                />\r\n              </div>\r\n\r\n\r\n              <div className=\"grid gap-3\">\r\n                <Label htmlFor=\"category\">Category (Optional)</Label>\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  Need to create a new category? Go to the{' '}\r\n                  <Button\r\n                    type=\"button\"\r\n                    variant=\"link\"\r\n                    className=\"p-0 h-auto text-blue-600 underline\"\r\n                    onClick={() => navigate(`/categories?returnTo=${encodeURIComponent(window.location.pathname)}`)}\r\n                    disabled={isSubmitting}\r\n                  >\r\n                    Categories page <ExternalLink className=\"h-3 w-3 ml-1 inline\" />\r\n                  </Button>\r\n                  {' '}first, then return here to select it.\r\n                </p>\r\n                <Select\r\n                  value={formData.category}\r\n                  onValueChange={handleCategoryChange}\r\n                  disabled={isSubmitting}\r\n                >\r\n                  <SelectTrigger\r\n                    className={cn(errors.category ? 'border-red-500' : '')}\r\n                    onKeyDown={(e) => {\r\n                      console.log('SelectTrigger keydown:', e.key, 'Category:', formData.category);\r\n                      if (e.key === 'Enter') {\r\n                        e.preventDefault();\r\n                        e.stopPropagation();\r\n                        console.log('Enter pressed on SelectTrigger, focusing description');\r\n                        // Always move to description when Enter is pressed\r\n                        setTimeout(() => {\r\n                          const descriptionField = document.getElementById('description');\r\n                          console.log('Description field found:', !!descriptionField);\r\n                          descriptionField?.focus();\r\n                        }, 50);\r\n                        return false;\r\n                      } else if (e.key === 'Escape') {\r\n                        // On Escape, also move to description\r\n                        setTimeout(() => {\r\n                          document.getElementById('description')?.focus();\r\n                        }, 50);\r\n                      }\r\n                    }}\r\n                  >\r\n                    <SelectValue placeholder=\"Select category (optional)\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {categories.length > 0 ? (\r\n                      categories.map((category) => (\r\n                        <SelectItem key={category.id} value={category.name}>\r\n                          {category.name}\r\n                        </SelectItem>\r\n                      ))\r\n                    ) : (\r\n                      <div className=\"p-2 text-sm text-muted-foreground\">\r\n                        No categories available\r\n                      </div>\r\n                    )}\r\n                  </SelectContent>\r\n                </Select>\r\n                {errors.category && (\r\n                  <p className=\"text-red-500 text-xs\">{errors.category}</p>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"grid gap-3\">\r\n                <Label htmlFor=\"description\">Description</Label>\r\n                <Textarea\r\n                  id=\"description\"\r\n                  name=\"description\"\r\n                  value={formData.description}\r\n                  onChange={handleChange}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter' && !e.shiftKey) {\r\n                      e.preventDefault();\r\n                      document.getElementById('supplier')?.focus();\r\n                    }\r\n                  }}\r\n                  placeholder=\"Enter product description\"\r\n                  className=\"resize-none h-32\"\r\n                  disabled={isSubmitting}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"grid gap-3\">\r\n                <Label htmlFor=\"supplier\">Supplier</Label>\r\n                <Input\r\n                  id=\"supplier\"\r\n                  name=\"supplier\"\r\n                  value={formData.supplier}\r\n                  onChange={handleChange}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter') {\r\n                      e.preventDefault();\r\n                      document.getElementById('quantity')?.focus();\r\n                    }\r\n                  }}\r\n                  placeholder=\"Enter supplier name\"\r\n                  disabled={isSubmitting}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"grid gap-3\">\r\n                <Label>Created Date</Label>\r\n                <Popover open={isCalendarOpen} onOpenChange={setIsCalendarOpen}>\r\n                  <PopoverTrigger asChild>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className={cn(\r\n                        \"w-full justify-start text-left font-normal\",\r\n                        !formData.createdAt && \"text-muted-foreground\",\r\n                        initialData && \"cursor-not-allowed opacity-60\"\r\n                      )}\r\n                      disabled={isSubmitting || !!initialData}\r\n                    >\r\n                      <Calendar className=\"mr-2 h-4 w-4\" />\r\n                      {formData.createdAt ? format(formData.createdAt, \"PPP\") : \"Pick a date\"}\r\n                    </Button>\r\n                  </PopoverTrigger>\r\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\r\n                    <CalendarComponent\r\n                      mode=\"single\"\r\n                      selected={formData.createdAt}\r\n                      onSelect={handleDateChange}\r\n                      disabled={(date) => date > new Date()}\r\n                      initialFocus\r\n                    />\r\n                  </PopoverContent>\r\n                </Popover>\r\n                {initialData && (\r\n                  <div className=\"bg-amber-50 border border-amber-200 p-3 rounded-lg\">\r\n                    <div className=\"text-amber-800 text-sm\">\r\n                      <strong>Note:</strong> To edit the creation date, please edit the initial stock history entry for this product through the inventory stock history.\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-6\">\r\n              <div className=\"grid gap-3\">\r\n                <Label htmlFor=\"imageFile\">Product Image</Label>\r\n                <div className=\"flex flex-col items-center space-y-4\">\r\n                  {imagePreview ? (\r\n                    <div className=\"relative w-full\">\r\n                      <img\r\n                        src={imagePreview}\r\n                        alt=\"Product preview\"\r\n                        className=\"w-full h-40 object-contain border rounded-md\"\r\n                      />\r\n                      <Button\r\n                        type=\"button\"\r\n                        variant=\"destructive\"\r\n                        size=\"icon\"\r\n                        className=\"absolute top-2 right-2 rounded-full h-8 w-8\"\r\n                        onClick={removeImage}\r\n                        disabled={isSubmitting || compressing}\r\n                      >\r\n                        <Trash2 className=\"h-4 w-4\" />\r\n                      </Button>\r\n\r\n                      {/* Compression stats display */}\r\n                      {compressionStats && (\r\n                        <div className=\"mt-2 p-2 bg-green-50 border border-green-200 rounded-md\">\r\n                          <div className=\"flex items-center gap-2 text-green-700\">\r\n                            <Zap className=\"h-4 w-4\" />\r\n                            <span className=\"text-xs font-medium\">\r\n                              Optimized to {(compressionStats.compressedSize / 1024).toFixed(1)}KB\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"text-xs text-green-600 mt-1\">\r\n                            {(compressionStats.originalSize / 1024).toFixed(1)}KB  {(compressionStats.compressedSize / 1024).toFixed(1)}KB ({compressionStats.reduction.toFixed(1)}% reduction)\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  ) : (\r\n                    <div\r\n                      className={cn(\r\n                        \"border-2 border-dashed rounded-md p-8 w-full flex flex-col items-center justify-center cursor-pointer transition-colors\",\r\n                        isDragging ? \"border-blue-500 bg-blue-50\" : \"border-gray-300 hover:border-gray-400\",\r\n                        (isSubmitting || compressing) && \"opacity-50 cursor-not-allowed\"\r\n                      )}\r\n                      onDragOver={handleDragOver}\r\n                      onDragLeave={handleDragLeave}\r\n                      onDrop={handleDrop}\r\n                      onClick={!(isSubmitting || compressing) ? handleImageUploadClick : undefined}\r\n                    >\r\n                      {compressing ? (\r\n                        <>\r\n                          <Loader2 className=\"h-10 w-10 text-blue-500 mb-2 animate-spin\" />\r\n                          <p className=\"text-sm text-gray-500\">Optimizing image...</p>\r\n                          <p className=\"text-xs text-gray-400\">Compressing to under 15KB</p>\r\n                        </>\r\n                      ) : uploading ? (\r\n                        <>\r\n                          <Loader2 className=\"h-10 w-10 text-blue-500 mb-2 animate-spin\" />\r\n                          <p className=\"text-sm text-gray-500\">Uploading image...</p>\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <Upload className=\"h-10 w-10 text-gray-400 mb-2\" />\r\n                          <p className=\"text-sm text-gray-500\">\r\n                            Click to upload or drag and drop\r\n                          </p>\r\n                          <p className=\"text-xs text-gray-400\">PNG, JPG, GIF up to 20MB</p>\r\n                          <p className=\"text-xs text-blue-500 mt-1\">\r\n                             Auto Image compression for instant loading\r\n                          </p>\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                  <input\r\n                    type=\"file\"\r\n                    id=\"imageFile\"\r\n                    ref={fileInputRef}\r\n                    accept=\"image/*\"\r\n                    onChange={handleImageChange}\r\n                    className=\"hidden\"\r\n                    disabled={isSubmitting || compressing}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid md:grid-cols-2 gap-4\">\r\n                <div className=\"grid gap-3\">\r\n                  <Label htmlFor=\"quantity\">Initial Stock</Label>\r\n                  <Input\r\n                    id=\"quantity\"\r\n                    name=\"quantity\"\r\n                    type=\"number\"\r\n                    step=\"0.01\"\r\n                    value={formData.quantity}\r\n                    onChange={handleChange}\r\n                    onKeyDown={(e) => {\r\n                      if (e.key === 'Enter') {\r\n                        e.preventDefault();\r\n                        document.getElementById('minimumStock')?.focus();\r\n                      }\r\n                    }}\r\n                    className={errors.quantity ? 'border-red-500' : ''}\r\n                    disabled={isSubmitting}\r\n                    placeholder=\"Enter initial stock quantity (can be negative)\"\r\n                  />\r\n                  {errors.quantity && (\r\n                    <p className=\"text-red-500 text-xs\">{errors.quantity}</p>\r\n                  )}\r\n                  {initialData && (\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      Current stock: {initialData.quantity} units\r\n                    </p>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"grid gap-3\">\r\n                  <Label htmlFor=\"minimumStock\">Minimum Stock Level</Label>\r\n                  <Input\r\n                    id=\"minimumStock\"\r\n                    name=\"minimumStock\"\r\n                    type=\"number\"\r\n                    min=\"0\"\r\n                    step=\"0.01\"\r\n                    value={formData.minimumStock === undefined ? '' : formData.minimumStock}\r\n                    onChange={handleChange}\r\n                    onKeyDown={(e) => {\r\n                      if (e.key === 'Enter') {\r\n                        e.preventDefault();\r\n                        document.getElementById('costPrice')?.focus();\r\n                      }\r\n                    }}\r\n                    className={errors.minimumStock ? 'border-red-500' : ''}\r\n                    disabled={isSubmitting}\r\n                  />\r\n                  {errors.minimumStock && (\r\n                    <p className=\"text-red-500 text-xs\">{errors.minimumStock}</p>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid md:grid-cols-2 gap-4\">\r\n                <div className=\"grid gap-3\">\r\n                  <Label htmlFor=\"costPrice\">Cost Price</Label>\r\n                  <div className=\"flex\">\r\n                    <span className=\"inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500\">\r\n                      {settings.currency}\r\n                    </span>\r\n                    <Input\r\n                      id=\"costPrice\"\r\n                      name=\"costPrice\"\r\n                      type=\"number\"\r\n                      min=\"0\"\r\n                      step=\"0.01\"\r\n                      value={formData.costPrice === undefined ? '' : formData.costPrice}\r\n                      onChange={handleChange}\r\n                      onKeyDown={(e) => {\r\n                        if (e.key === 'Enter') {\r\n                          e.preventDefault();\r\n                          document.getElementById('sellingPrice')?.focus();\r\n                        }\r\n                      }}\r\n                      className={`rounded-l-none ${errors.costPrice ? 'border-red-500' : ''}`}\r\n                      disabled={isSubmitting}\r\n                    />\r\n                  </div>\r\n                  {errors.costPrice && (\r\n                    <p className=\"text-red-500 text-xs\">{errors.costPrice}</p>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"grid gap-3\">\r\n                  <Label htmlFor=\"sellingPrice\">Selling Price</Label>\r\n                  <div className=\"flex\">\r\n                    <span className=\"inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500\">\r\n                      {settings.currency}\r\n                    </span>\r\n                    <Input\r\n                      id=\"sellingPrice\"\r\n                      name=\"sellingPrice\"\r\n                      type=\"number\"\r\n                      min=\"0\"\r\n                      step=\"0.01\"\r\n                      value={formData.sellingPrice === undefined ? '' : formData.sellingPrice}\r\n                      onChange={handleChange}\r\n                      onKeyDown={(e) => {\r\n                        if (e.key === 'Enter') {\r\n                          e.preventDefault();\r\n                          const submitButton = document.querySelector('button[type=\"submit\"]') as HTMLElement;\r\n                          submitButton?.focus();\r\n                        }\r\n                      }}\r\n                      className={`rounded-l-none ${errors.sellingPrice ? 'border-red-500' : ''}`}\r\n                      disabled={isSubmitting}\r\n                    />\r\n                  </div>\r\n                  {errors.sellingPrice && (\r\n                    <p className=\"text-red-500 text-xs\">{errors.sellingPrice}</p>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid gap-3\">\r\n                <p className=\"text-sm text-gray-500\">\r\n                  * Required fields | Initial Stock: The starting quantity for this product\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-end space-x-4\">\r\n            <Button\r\n              variant=\"outline\"\r\n              type=\"button\"\r\n              onClick={() => navigate('/inventory')}\r\n              disabled={isSubmitting || compressing}\r\n            >\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              type=\"submit\"\r\n              disabled={isSubmitting || compressing}\r\n              className=\"min-w-[100px]\"\r\n            >\r\n              {compressing ? (\r\n                <>\r\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                  Optimizing...\r\n                </>\r\n              ) : isSubmitting ? (\r\n                <>\r\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                  {uploading ? 'Uploading...' : 'Saving...'}\r\n                </>\r\n              ) : (\r\n                initialData ? 'Update Product' : 'Create Product'\r\n              )}\r\n            </Button>\r\n          </div>\r\n\r\n          {!initialData && (\r\n            <div className=\"flex flex-col md:flex-row items-center justify-end gap-4 pt-3 border-t\">\r\n              {formData.autoPrintLabel && (\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Label htmlFor=\"printQuantity\" className=\"text-sm text-muted-foreground whitespace-nowrap\">\r\n                    Quantity to print:\r\n                  </Label>\r\n                  <Input\r\n                    id=\"printQuantity\"\r\n                    type=\"number\"\r\n                    min=\"1\"\r\n                    className=\"w-20 h-8\"\r\n                    value={formData.printQuantity}\r\n                    onChange={(e) => setFormData(prev => ({ ...prev, printQuantity: parseInt(e.target.value) || 1 }))}\r\n                    disabled={isSubmitting}\r\n                  />\r\n                </div>\r\n              )}\r\n              <div className=\"flex items-center space-x-2\">\r\n                <Printer className=\"h-4 w-4 text-muted-foreground\" />\r\n                <Label htmlFor=\"autoPrint\" className=\"text-sm font-medium cursor-pointer\">\r\n                  Auto-print barcode label\r\n                </Label>\r\n                <Switch\r\n                  id=\"autoPrint\"\r\n                  checked={formData.autoPrintLabel}\r\n                  onCheckedChange={(checked) => setFormData(prev => ({ ...prev, autoPrintLabel: checked }))}\r\n                  disabled={isSubmitting}\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </form>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default ProductForm;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2210, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/hooks/useStockHistory.ts"],"sourcesContent":["\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { StockHistoryEntry } from '@/types';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\n\r\nexport interface ChainRepairBreakEntry {\r\n  entryId: string;\r\n  createdAt: string;\r\n  changeReason: string;\r\n  currentPrevQty: number;\r\n  currentNewQty: number;\r\n  fixedPrevQty: number;\r\n  fixedNewQty: number;\r\n}\r\n\r\nexport interface ChainRepairPreview {\r\n  productId: string;\r\n  productName: string;\r\n  totalEntries: number;\r\n  brokenEntries: ChainRepairBreakEntry[];\r\n  finalFixedQty: number;\r\n  currentProductQty: number;\r\n}\r\n\r\nexport const useStockHistory = (userId: string | undefined, productId?: string) => {\r\n  const [stockHistory, setStockHistory] = useState<StockHistoryEntry[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const { currentBusiness } = useBusiness();\r\n\r\n  // Memoize the load function to prevent infinite re-renders\r\n  const loadStockHistory = useCallback(async () => {\r\n    if (!userId || !currentBusiness) {\r\n      setStockHistory([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n      // Fetch all stock history without any limits\r\n      // We'll implement a recursive fetch to get all records\r\n      let allData: any[] = [];\r\n      let hasMore = true;\r\n      let offset = 0;\r\n      const batchSize = 1000; // Fetch in smaller, more manageable batches\r\n\r\n      while (hasMore) {\r\n        let query = supabase\r\n          .from('stock_history')\r\n          .select('*, products(name, cost_price, selling_price, item_number)')\r\n          .eq('location_id', currentBusiness.id)\r\n          .order('created_at', { ascending: true })\r\n          .order('id', { ascending: true })\r\n          .range(offset, offset + batchSize - 1);\r\n\r\n        // If productId is provided, filter by it\r\n        if (productId) {\r\n          query = query.eq('product_id', productId);\r\n        }\r\n\r\n        const { data: batchData, error: batchError } = await query;\r\n\r\n        if (batchError) {\r\n          throw batchError;\r\n        }\r\n\r\n        if (batchData && batchData.length > 0) {\r\n          allData = [...allData, ...batchData];\r\n\r\n          // If we got less than the batch size, we've reached the end\r\n          if (batchData.length < batchSize) {\r\n            hasMore = false;\r\n          } else {\r\n            offset += batchSize;\r\n          }\r\n        } else {\r\n          hasMore = false;\r\n        }\r\n      }\r\n\r\n      const data = allData;\r\n\r\n      // Remove the individual query as it's now handled in the batch loop above\r\n      const error = null; // No error if we reached this point\r\n\r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      if (data) {\r\n        const formattedHistory: StockHistoryEntry[] = data.map(entry => {\r\n          const productData = entry.products;\r\n          return {\r\n            id: entry.id,\r\n            productId: entry.product_id,\r\n            oldQuantity: entry.previous_quantity,\r\n            newQuantity: entry.new_quantity,\r\n            changeReason: entry.change_reason,\r\n            createdAt: new Date(entry.created_at),\r\n            referenceId: entry.reference_id,\r\n            receiptNumber: entry.receipt_number,\r\n            product: productData ? {\r\n              name: productData.name,\r\n              costPrice: productData.cost_price,\r\n              sellingPrice: productData.selling_price,\r\n              itemNumber: productData.item_number\r\n            } : undefined\r\n          };\r\n        });\r\n        // Reverse for display (newest first for UI)\r\n        setStockHistory(formattedHistory.reverse());\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading stock history:', error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [userId, currentBusiness, productId]);\r\n\r\n  useEffect(() => {\r\n    loadStockHistory();\r\n  }, [loadStockHistory]);\r\n\r\n  // Create stock history entry with standardized reasons and recalculate stock chain\r\n  const createStockHistoryEntry = async (\r\n    productId: string,\r\n    previousQuantity: number,\r\n    newQuantity: number,\r\n    reason: string,\r\n    referenceId?: string,\r\n    entryDate?: Date,\r\n    receiptNumber?: string,\r\n    productName?: string\r\n  ) => {\r\n    console.log(' createStockHistoryEntry CALLED', {\r\n      productId,\r\n      productName,\r\n      prevQty: previousQuantity,\r\n      newQty: newQuantity,\r\n      reason,\r\n      refId: referenceId,\r\n      receipt: receiptNumber,\r\n      entryDate: entryDate?.toISOString(),\r\n      stack: new Error().stack\r\n    });\r\n\r\n    try {\r\n      if (!userId || !currentBusiness) return false;\r\n\r\n      // Prefix reason with product name for future retrieval if product is deleted\r\n      const snapshottedReason = productName\r\n        ? `[${productName}] | ${reason}`\r\n        : reason;\r\n\r\n      const insertData: any = {\r\n        user_id: userId,\r\n        product_id: productId,\r\n        previous_quantity: previousQuantity,\r\n        new_quantity: newQuantity,\r\n        change_reason: snapshottedReason,\r\n        reference_id: referenceId,\r\n        receipt_number: receiptNumber,\r\n        location_id: currentBusiness.id\r\n      };\r\n\r\n      // ONLY use explicit date if provided AND it includes a real time component\r\n      // Otherwise let database use now() to avoid midnight UTC issues (which show as 3:00 AM in EAT)\r\n      if (entryDate) {\r\n        const hours = entryDate.getHours();\r\n        const minutes = entryDate.getMinutes();\r\n        const seconds = entryDate.getSeconds();\r\n\r\n        // Skip midnight (00:00:00) - this is from date pickers, let DB use now() instead\r\n        // Also skip noon (12:00:00) from our date picker fix - let DB use now()\r\n        const isMidnight = hours === 0 && minutes === 0 && seconds === 0;\r\n        const isNoon = hours === 12 && minutes === 0 && seconds === 0;\r\n\r\n        if (!isMidnight && !isNoon) {\r\n          insertData.created_at = entryDate.toISOString();\r\n        }\r\n        // If it's midnight or noon, don't set created_at - let DB use now() for accurate timestamp\r\n      }\r\n\r\n      const { error } = await supabase\r\n        .from('stock_history')\r\n        .insert(insertData);\r\n\r\n      if (error) {\r\n        console.error('Error creating stock history entry:', error);\r\n        return false;\r\n      }\r\n\r\n      // Chain recalculation disabled to prevent cascading errors\r\n      // Use the Reconciliation tool to fix stock discrepancies instead\r\n      // const recalcSuccess = await recalculateStockChain(productId);\r\n\r\n      // Refresh stock history after creating new entry\r\n      await loadStockHistory();\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error creating stock history:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Update stock history entry and recalculate all subsequent entries\r\n  const updateStockHistoryEntry = async (\r\n    entryId: string,\r\n    newQuantity: number,\r\n    newChangeReason: string,\r\n    newDate?: Date\r\n  ) => {\r\n    try {\r\n      if (!userId || !currentBusiness) return false;\r\n\r\n      // First, get the current entry to understand the change\r\n      const { data: currentEntry, error: fetchError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('id', entryId)\r\n        .single();\r\n\r\n      if (fetchError || !currentEntry) {\r\n        console.error('Error fetching current entry:', fetchError);\r\n        return false;\r\n      }\r\n\r\n      // Check if this is the initial stock entry by getting all stock history for this product\r\n      const { data: allStockHistory, error: stockHistoryError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('product_id', currentEntry.product_id)\r\n        .eq('location_id', currentBusiness.id)\r\n        .order('created_at', { ascending: true })\r\n        .order('id', { ascending: true });\r\n\r\n      if (stockHistoryError || !allStockHistory) {\r\n        console.error('Error fetching stock history:', stockHistoryError);\r\n        return false;\r\n      }\r\n\r\n      const isInitialStock = allStockHistory.length > 0 && allStockHistory[0].id === entryId;\r\n\r\n      // Update the current entry\r\n      const updateData: any = {\r\n        new_quantity: newQuantity,\r\n        change_reason: newChangeReason,\r\n      };\r\n\r\n      if (newDate) {\r\n        // Use toISOString() to preserve the exact local time without timezone conversion\r\n        updateData.created_at = newDate.toISOString();\r\n      }\r\n\r\n      const { error: updateError } = await supabase\r\n        .from('stock_history')\r\n        .update(updateData)\r\n        .eq('id', entryId);\r\n\r\n      if (updateError) {\r\n        console.error('Error updating stock history entry:', updateError);\r\n        return false;\r\n      }\r\n\r\n      // If this is initial stock and date is being updated, also update product creation date\r\n      if (isInitialStock && newDate) {\r\n        const { error: productDateUpdateError } = await supabase\r\n          .from('products')\r\n          .update({ created_at: newDate.toISOString() })\r\n          .eq('id', currentEntry.product_id);\r\n\r\n        if (productDateUpdateError) {\r\n          console.error('Error updating product creation date:', productDateUpdateError);\r\n          return false;\r\n        }\r\n      }\r\n\r\n      // Use the already fetched stock history to avoid duplicate queries\r\n      const allHistory = allStockHistory;\r\n\r\n      // Find the index of the updated entry\r\n      const updatedEntryIndex = allHistory.findIndex(entry => entry.id === entryId);\r\n      if (updatedEntryIndex === -1) return false;\r\n\r\n      // Calculate the user's intended change amount for the edited entry\r\n      const userChangeAmount = newQuantity - currentEntry.previous_quantity;\r\n\r\n      // Recalculate the entire chain from the beginning\r\n      const updatesToMake = [];\r\n      let runningQuantity = 0; // Start from initial stock of 0\r\n\r\n      for (let i = 0; i < allHistory.length; i++) {\r\n        const entry = allHistory[i];\r\n\r\n        if (i === updatedEntryIndex) {\r\n          // For the updated entry, preserve the user's intended change amount\r\n          const newPreviousQuantity = runningQuantity;\r\n          const newNewQuantity = newPreviousQuantity + userChangeAmount;\r\n\r\n          // Update both previous and new quantities to preserve user's change amount\r\n          if (entry.previous_quantity !== newPreviousQuantity || entry.new_quantity !== newNewQuantity) {\r\n            updatesToMake.push({\r\n              id: entry.id,\r\n              previous_quantity: newPreviousQuantity,\r\n              new_quantity: newNewQuantity\r\n            });\r\n          }\r\n\r\n          runningQuantity = newNewQuantity;\r\n        } else {\r\n          // For all other entries, recalculate based on their original change amount\r\n          const originalChange = entry.new_quantity - entry.previous_quantity;\r\n          const newPreviousQuantity = runningQuantity;\r\n          const newNewQuantity = newPreviousQuantity + originalChange;\r\n\r\n          // Only update if values have changed\r\n          if (entry.previous_quantity !== newPreviousQuantity || entry.new_quantity !== newNewQuantity) {\r\n            updatesToMake.push({\r\n              id: entry.id,\r\n              previous_quantity: newPreviousQuantity,\r\n              new_quantity: newNewQuantity\r\n            });\r\n          }\r\n\r\n          runningQuantity = newNewQuantity;\r\n        }\r\n      }\r\n\r\n      // Perform batch updates for all subsequent entries\r\n      if (updatesToMake.length > 0) {\r\n        for (const update of updatesToMake) {\r\n          const { error: batchUpdateError } = await supabase\r\n            .from('stock_history')\r\n            .update({\r\n              previous_quantity: update.previous_quantity,\r\n              new_quantity: update.new_quantity\r\n            })\r\n            .eq('id', update.id);\r\n\r\n          if (batchUpdateError) {\r\n            console.error('Error updating subsequent entry:', batchUpdateError);\r\n            // Continue with other updates even if one fails\r\n          }\r\n        }\r\n      }\r\n\r\n      // Update the final product quantity\r\n      const finalQuantity = runningQuantity;\r\n\r\n      const { error: productUpdateError } = await supabase\r\n        .from('products')\r\n        .update({ quantity: finalQuantity })\r\n        .eq('id', currentEntry.product_id);\r\n\r\n      if (productUpdateError) {\r\n        console.error('Error updating product quantity:', productUpdateError);\r\n        return false;\r\n      }\r\n\r\n      // Refresh stock history to show updated chain\r\n      await loadStockHistory();\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating stock history:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Delete multiple stock history entries (for bulk operations like deleting entire invoice)\r\n  const deleteMultipleStockHistoryEntries = async (entryIds: string[]) => {\r\n    try {\r\n      if (!userId || !currentBusiness || entryIds.length === 0) return false;\r\n\r\n      // Get all entries to be deleted\r\n      const { data: entriesToDelete, error: fetchError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .in('id', entryIds);\r\n\r\n      if (fetchError || !entriesToDelete) {\r\n        console.error('Error fetching entries to delete:', fetchError);\r\n        return false;\r\n      }\r\n\r\n      // Group entries by product_id to handle recalculation properly\r\n      const entriesByProduct = entriesToDelete.reduce((acc, entry) => {\r\n        if (!acc[entry.product_id]) {\r\n          acc[entry.product_id] = [];\r\n        }\r\n        acc[entry.product_id].push(entry);\r\n        return acc;\r\n      }, {} as Record<string, typeof entriesToDelete>);\r\n\r\n      // Delete all entries in a single batch\r\n      const { error: deleteError } = await supabase\r\n        .from('stock_history')\r\n        .delete()\r\n        .in('id', entryIds);\r\n\r\n      if (deleteError) {\r\n        console.error('Error deleting stock history entries:', deleteError);\r\n        return false;\r\n      }\r\n\r\n      // Re-enable chain recalculation for affected products only.\r\n      // We only recalculate the specific product IDs that were deleted  not all products.\r\n      for (const productId of Object.keys(entriesByProduct)) {\r\n        await recalculateStockChain(productId);\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting multiple stock history entries:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Delete stock history entry and recalculate all subsequent entries\r\n  const deleteStockHistoryEntry = async (entryId: string) => {\r\n    try {\r\n      if (!userId || !currentBusiness) return false;\r\n\r\n      // First, get the entry to be deleted\r\n      const { data: entryToDelete, error: fetchError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('id', entryId)\r\n        .single();\r\n\r\n      if (fetchError || !entryToDelete) {\r\n        console.error('Error fetching entry to delete:', fetchError);\r\n        return false;\r\n      }\r\n\r\n      // Get all stock history for this product in chronological order\r\n      const { data: allHistory, error: historyError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('product_id', entryToDelete.product_id)\r\n        .eq('location_id', currentBusiness.id)\r\n        .order('created_at', { ascending: true })\r\n        .order('id', { ascending: true });\r\n\r\n      if (historyError || !allHistory) {\r\n        console.error('Error fetching stock history:', historyError);\r\n        return false;\r\n      }\r\n\r\n      // Find the index of the entry to delete\r\n      const deleteIndex = allHistory.findIndex(entry => entry.id === entryId);\r\n      if (deleteIndex === -1) return false;\r\n\r\n      // Delete the entry\r\n      const { error: deleteError } = await supabase\r\n        .from('stock_history')\r\n        .delete()\r\n        .eq('id', entryId);\r\n\r\n      if (deleteError) {\r\n        console.error('Error deleting stock history entry:', deleteError);\r\n        return false;\r\n      }\r\n\r\n      // Recalculate all subsequent entries\r\n      const updatesToMake = [];\r\n\r\n      // If this was the first entry, the next entry's previous_quantity should be 0\r\n      // If this was a middle entry, the next entry's previous_quantity should be the previous entry's new_quantity\r\n      let newPreviousQuantity = 0;\r\n      if (deleteIndex > 0) {\r\n        newPreviousQuantity = allHistory[deleteIndex - 1].new_quantity;\r\n      }\r\n\r\n      // Recalculate all entries after the deleted one\r\n      for (let i = deleteIndex + 1; i < allHistory.length; i++) {\r\n        const entry = allHistory[i];\r\n        const originalChange = entry.new_quantity - entry.previous_quantity;\r\n        const newNewQuantity = newPreviousQuantity + originalChange;\r\n\r\n        updatesToMake.push({\r\n          id: entry.id,\r\n          previous_quantity: newPreviousQuantity,\r\n          new_quantity: newNewQuantity\r\n        });\r\n\r\n        newPreviousQuantity = newNewQuantity;\r\n      }\r\n\r\n      // Perform batch updates for all subsequent entries\r\n      if (updatesToMake.length > 0) {\r\n        for (const update of updatesToMake) {\r\n          const { error: batchUpdateError } = await supabase\r\n            .from('stock_history')\r\n            .update({\r\n              previous_quantity: update.previous_quantity,\r\n              new_quantity: update.new_quantity\r\n            })\r\n            .eq('id', update.id);\r\n\r\n          if (batchUpdateError) {\r\n            console.error('Error updating subsequent entry:', batchUpdateError);\r\n            // Continue with other updates even if one fails\r\n          }\r\n        }\r\n      }\r\n\r\n      // Update the final product quantity\r\n      const finalQuantity = updatesToMake.length > 0\r\n        ? updatesToMake[updatesToMake.length - 1].new_quantity\r\n        : (deleteIndex > 0 ? allHistory[deleteIndex - 1].new_quantity : 0);\r\n\r\n      const { error: productUpdateError } = await supabase\r\n        .from('products')\r\n        .update({ quantity: finalQuantity })\r\n        .eq('id', entryToDelete.product_id);\r\n\r\n      if (productUpdateError) {\r\n        console.error('Error updating product quantity:', productUpdateError);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting stock history:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Recalculate the entire stock chain for a product to maintain proper flow\r\n  const recalculateStockChain = async (productId: string) => {\r\n    try {\r\n      if (!userId || !currentBusiness) return false;\r\n\r\n      // Get all stock history for this product in chronological order\r\n      const { data: allHistory, error: historyError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('product_id', productId)\r\n        .eq('location_id', currentBusiness.id)\r\n        .order('created_at', { ascending: true })\r\n        .order('id', { ascending: true });\r\n\r\n      if (historyError || !allHistory) {\r\n        console.error('Error fetching stock history for recalculation:', historyError);\r\n        return false;\r\n      }\r\n\r\n      if (allHistory.length === 0) return true;\r\n\r\n      // Recalculate the entire chain from the beginning\r\n      const updatesToMake = [];\r\n      let runningQuantity = 0; // Start from initial stock of 0\r\n\r\n      for (let i = 0; i < allHistory.length; i++) {\r\n        const entry = allHistory[i];\r\n\r\n        // Calculate the original change amount for this entry\r\n        const originalChange = entry.new_quantity - entry.previous_quantity;\r\n\r\n        // Set the correct previous quantity and recalculated new quantity\r\n        const newPreviousQuantity = runningQuantity;\r\n        const newNewQuantity = newPreviousQuantity + originalChange;\r\n\r\n        // Only update if values have changed\r\n        if (entry.previous_quantity !== newPreviousQuantity || entry.new_quantity !== newNewQuantity) {\r\n          updatesToMake.push({\r\n            id: entry.id,\r\n            previous_quantity: newPreviousQuantity,\r\n            new_quantity: newNewQuantity\r\n          });\r\n        }\r\n\r\n        runningQuantity = newNewQuantity;\r\n      }\r\n\r\n      // Perform batch updates for all entries that need updating\r\n      if (updatesToMake.length > 0) {\r\n        for (const update of updatesToMake) {\r\n          const { error: batchUpdateError } = await supabase\r\n            .from('stock_history')\r\n            .update({\r\n              previous_quantity: update.previous_quantity,\r\n              new_quantity: update.new_quantity\r\n            })\r\n            .eq('id', update.id);\r\n\r\n          if (batchUpdateError) {\r\n            console.error('Error updating entry during chain recalculation:', batchUpdateError);\r\n            // Continue with other updates even if one fails\r\n          }\r\n        }\r\n      }\r\n\r\n      // Update the final product quantity\r\n      const finalQuantity = runningQuantity;\r\n\r\n      const { error: productUpdateError } = await supabase\r\n        .from('products')\r\n        .update({ quantity: finalQuantity })\r\n        .eq('id', productId);\r\n\r\n      if (productUpdateError) {\r\n        console.error('Error updating product quantity during chain recalculation:', productUpdateError);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error recalculating stock chain:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Recalculate product stock based on remaining history\r\n  // Update stock history dates for a specific sale\r\n  const updateStockHistoryDatesBySaleId = async (saleId: string, newDate: Date) => {\r\n    try {\r\n      if (!userId || !currentBusiness) {\r\n        console.log('Missing userId or currentBusiness for stock history update');\r\n        return false;\r\n      }\r\n\r\n      console.log('Updating stock history dates for sale:', saleId, 'to date:', newDate);\r\n\r\n      // Find all stock history entries with this sale as reference_id\r\n      const { data: stockEntries, error: fetchError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('reference_id', saleId)\r\n        .eq('location_id', currentBusiness.id);\r\n\r\n      if (fetchError) {\r\n        console.error('Error fetching stock history entries for sale:', fetchError);\r\n        return false;\r\n      }\r\n\r\n      console.log('Found stock history entries for sale:', stockEntries?.length || 0);\r\n\r\n      if (!stockEntries || stockEntries.length === 0) {\r\n        console.log('No stock entries found for sale:', saleId);\r\n        return true; // No stock entries to update\r\n      }\r\n\r\n      // Group entries by product_id to handle recalculation properly\r\n      const entriesByProduct = stockEntries.reduce((acc, entry) => {\r\n        if (!acc[entry.product_id]) {\r\n          acc[entry.product_id] = [];\r\n        }\r\n        acc[entry.product_id].push(entry);\r\n        return acc;\r\n      }, {} as Record<string, typeof stockEntries>);\r\n\r\n      // Update each stock history entry's date\r\n      for (const entry of stockEntries) {\r\n        console.log('Updating stock history entry:', entry.id, 'from date:', entry.created_at, 'to:', newDate.toISOString());\r\n\r\n        const { error: updateError } = await supabase\r\n          .from('stock_history')\r\n          .update({ created_at: newDate.toISOString() })\r\n          .eq('id', entry.id);\r\n\r\n        if (updateError) {\r\n          console.error('Error updating stock history date:', updateError);\r\n          return false;\r\n        }\r\n      }\r\n\r\n      console.log('Successfully updated', stockEntries.length, 'stock history entries');\r\n\r\n      // Re-run chain recalculation for each affected product after date reorder.\r\n      // Date changes can reorder entries in the chain so recalculation is mandatory.\r\n      for (const productId of Object.keys(entriesByProduct)) {\r\n        const recalcSuccess = await recalculateStockChain(productId);\r\n        if (!recalcSuccess) {\r\n          console.error('Failed to recalculate stock chain for product:', productId);\r\n        }\r\n      }\r\n\r\n      // Refresh stock history to reflect the updated dates\r\n      await loadStockHistory();\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating stock history dates by sale ID:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const recalculateProductStock = async (productId: string) => {\r\n    try {\r\n      if (!userId || !currentBusiness) return null;\r\n\r\n      // Get all stock history for this product in chronological order\r\n      const { data, error } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('product_id', productId)\r\n        .eq('location_id', currentBusiness.id)\r\n        .order('created_at', { ascending: true })\r\n        .order('id', { ascending: true });\r\n\r\n      if (error) {\r\n        console.error('Error fetching stock history for recalculation:', error);\r\n        return null;\r\n      }\r\n\r\n      // Calculate final stock quantity from history\r\n      let currentStock = 0;\r\n      if (data && data.length > 0) {\r\n        // Start with the first entry's new quantity\r\n        currentStock = data[0].new_quantity;\r\n\r\n        // Process remaining entries sequentially\r\n        for (let i = 1; i < data.length; i++) {\r\n          const entry = data[i];\r\n          const previousEntry = data[i - 1];\r\n\r\n          // Calculate the change based on the difference\r\n          const change = entry.new_quantity - entry.previous_quantity;\r\n          currentStock = previousEntry.new_quantity + change;\r\n        }\r\n\r\n        // The final stock is the new_quantity of the last entry\r\n        if (data.length > 0) {\r\n          currentStock = data[data.length - 1].new_quantity;\r\n        }\r\n      }\r\n\r\n      // Update the product's quantity\r\n      const { error: updateError } = await supabase\r\n        .from('products')\r\n        .update({ quantity: currentStock })\r\n        .eq('id', productId);\r\n\r\n      if (updateError) {\r\n        console.error('Error updating product quantity:', updateError);\r\n        return null;\r\n      }\r\n\r\n      return currentStock;\r\n    } catch (error) {\r\n      console.error('Error recalculating product stock:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Dry-run preview: walks every product's stock chain and returns the list of\r\n   * products that have broken chains, with per-product detail.\r\n   * Does NOT write anything to the database.\r\n   */\r\n  const previewStockChainRepairs = async (\r\n    onProgress?: (current: number, total: number) => void\r\n  ): Promise<ChainRepairPreview[]> => {\r\n    if (!userId || !currentBusiness) return [];\r\n\r\n    // Collect all distinct product IDs in this business's stock history\r\n    let allProductIds: string[] = [];\r\n    let offset = 0;\r\n    const batch = 1000;\r\n    let hasMore = true;\r\n\r\n    while (hasMore) {\r\n      const { data, error } = await supabase\r\n        .from('stock_history')\r\n        .select('product_id')\r\n        .eq('location_id', currentBusiness.id)\r\n        .range(offset, offset + batch - 1);\r\n\r\n      if (error) {\r\n        console.error('previewStockChainRepairs: error fetching product IDs', error);\r\n        break;\r\n      }\r\n\r\n      if (data && data.length > 0) {\r\n        allProductIds.push(...data.map((r: any) => r.product_id));\r\n        offset += batch;\r\n        hasMore = data.length === batch;\r\n      } else {\r\n        hasMore = false;\r\n      }\r\n    }\r\n\r\n    const uniqueProductIds = [...new Set(allProductIds)];\r\n    const total = uniqueProductIds.length;\r\n    const broken: ChainRepairPreview[] = [];\r\n\r\n    for (let i = 0; i < uniqueProductIds.length; i++) {\r\n      const productId = uniqueProductIds[i];\r\n\r\n      const { data: allHistory, error: historyError } = await supabase\r\n        .from('stock_history')\r\n        .select('*')\r\n        .eq('product_id', productId)\r\n        .eq('location_id', currentBusiness.id)\r\n        .order('created_at', { ascending: true })\r\n        .order('id', { ascending: true });\r\n\r\n      if (historyError || !allHistory || allHistory.length === 0) {\r\n        onProgress?.(i + 1, total);\r\n        continue;\r\n      }\r\n\r\n      // Fetch product name separately to avoid TS join-resolution issues\r\n      let productName = productId;\r\n      const { data: productRow } = await supabase\r\n        .from('products')\r\n        .select('name')\r\n        .eq('id', productId)\r\n        .maybeSingle();\r\n      if (productRow?.name) productName = productRow.name;\r\n      const brokenEntries: ChainRepairPreview['brokenEntries'] = [];\r\n      let runningQuantity = 0;\r\n\r\n      for (const entry of allHistory) {\r\n        const originalChange = entry.new_quantity - entry.previous_quantity;\r\n        const expectedPrev = runningQuantity;\r\n        const expectedNew = runningQuantity + originalChange;\r\n\r\n        if (entry.previous_quantity !== expectedPrev || entry.new_quantity !== expectedNew) {\r\n          brokenEntries.push({\r\n            entryId: entry.id,\r\n            createdAt: entry.created_at,\r\n            changeReason: entry.change_reason ?? '',\r\n            currentPrevQty: entry.previous_quantity,\r\n            currentNewQty: entry.new_quantity,\r\n            fixedPrevQty: expectedPrev,\r\n            fixedNewQty: expectedNew,\r\n          });\r\n        }\r\n\r\n        runningQuantity = expectedNew;\r\n      }\r\n\r\n      if (brokenEntries.length > 0) {\r\n        broken.push({\r\n          productId,\r\n          productName,\r\n          totalEntries: allHistory.length,\r\n          brokenEntries,\r\n          finalFixedQty: runningQuantity,\r\n          currentProductQty: allHistory[allHistory.length - 1].new_quantity,\r\n        });\r\n      }\r\n\r\n      onProgress?.(i + 1, total);\r\n    }\r\n\r\n    return broken;\r\n  };\r\n\r\n  /**\r\n   * Repairs all broken stock chains for the current business by iterating\r\n   * every product and re-running recalculateStockChain.\r\n   * Use this to fix historical data corruption caused by past disabled recalculations.\r\n   * Returns { repaired, failed } counts.\r\n   */\r\n  const repairAllStockChains = async (\r\n    onProgress?: (current: number, total: number) => void\r\n  ): Promise<{ repaired: number; failed: number }> => {\r\n    if (!userId || !currentBusiness) return { repaired: 0, failed: 0 };\r\n\r\n    // Fetch all distinct product IDs that have stock history for this business\r\n    let allProductIds: string[] = [];\r\n    let offset = 0;\r\n    const batch = 1000;\r\n    let hasMore = true;\r\n\r\n    while (hasMore) {\r\n      const { data, error } = await supabase\r\n        .from('stock_history')\r\n        .select('product_id')\r\n        .eq('location_id', currentBusiness.id)\r\n        .range(offset, offset + batch - 1);\r\n\r\n      if (error) {\r\n        console.error('repairAllStockChains: error fetching product IDs', error);\r\n        break;\r\n      }\r\n\r\n      if (data && data.length > 0) {\r\n        allProductIds.push(...data.map((r: any) => r.product_id));\r\n        offset += batch;\r\n        hasMore = data.length === batch;\r\n      } else {\r\n        hasMore = false;\r\n      }\r\n    }\r\n\r\n    // Deduplicate\r\n    const uniqueProductIds = [...new Set(allProductIds)];\r\n    const total = uniqueProductIds.length;\r\n    let repaired = 0;\r\n    let failed = 0;\r\n\r\n    for (let i = 0; i < uniqueProductIds.length; i++) {\r\n      const productId = uniqueProductIds[i];\r\n      const success = await recalculateStockChain(productId);\r\n      if (success) {\r\n        repaired++;\r\n      } else {\r\n        failed++;\r\n        console.warn('repairAllStockChains: failed for product', productId);\r\n      }\r\n      onProgress?.(i + 1, total);\r\n    }\r\n\r\n    // Refresh UI after full repair\r\n    await loadStockHistory();\r\n\r\n    return { repaired, failed };\r\n  };\r\n\r\n  return {\r\n    stockHistory,\r\n    isLoading,\r\n    createStockHistoryEntry,\r\n    updateStockHistoryEntry,\r\n    deleteStockHistoryEntry,\r\n    deleteMultipleStockHistoryEntries,\r\n    recalculateStockChain,\r\n    repairAllStockChains,\r\n    previewStockChainRepairs,\r\n    updateStockHistoryDatesBySaleId,\r\n    recalculateProductStock,\r\n    loadStockHistory\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2929, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/utils/searchUtils.ts"],"sourcesContent":["import { Product } from '@/types';\r\n\r\n/**\r\n * Checks if a search term (possibly containing multiple words in any order) matches a product.\r\n * Returns true if every word in the search term is found in at least one searchable field of the product.\r\n */\r\nexport const matchProductSearch = (product: Product, searchTerm: string): boolean => {\r\n    if (!searchTerm || !searchTerm.trim()) return true;\r\n\r\n    const words = searchTerm.toLowerCase().trim().split(/\\s+/);\r\n\r\n    const searchableText = [\r\n        String(product.name || ''),\r\n        String(product.description || ''),\r\n        String(product.category || ''),\r\n        String(product.supplier || ''),\r\n        String(product.itemNumber || ''),\r\n        String(product.barcode || ''),\r\n        String(product.manufacturerBarcode || '')\r\n    ].map(s => s.toLowerCase());\r\n\r\n    // Every word in the search must match at least one searchable field\r\n    return words.every(word =>\r\n        searchableText.some(field => field.includes(word))\r\n    );\r\n};\r\n"],"names":[],"mappings":";;;;AAMO,MAAM,qBAAqB,CAAC,SAAkB;IACjD,IAAI,CAAC,cAAc,CAAC,WAAW,IAAI,IAAI,OAAO;IAE9C,MAAM,QAAQ,WAAW,WAAW,GAAG,IAAI,GAAG,KAAK,CAAC;IAEpD,MAAM,iBAAiB;QACnB,OAAO,QAAQ,IAAI,IAAI;QACvB,OAAO,QAAQ,WAAW,IAAI;QAC9B,OAAO,QAAQ,QAAQ,IAAI;QAC3B,OAAO,QAAQ,QAAQ,IAAI;QAC3B,OAAO,QAAQ,UAAU,IAAI;QAC7B,OAAO,QAAQ,OAAO,IAAI;QAC1B,OAAO,QAAQ,mBAAmB,IAAI;KACzC,CAAC,GAAG,CAAC,CAAA,IAAK,EAAE,WAAW;IAExB,oEAAoE;IACpE,OAAO,MAAM,KAAK,CAAC,CAAA,OACf,eAAe,IAAI,CAAC,CAAA,QAAS,MAAM,QAAQ,CAAC;AAEpD"}},
    {"offset": {"line": 2955, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/hooks/useProductFilters.ts"],"sourcesContent":["import { useState, useMemo, useEffect, useCallback } from 'react';\r\nimport { Product, ProductFilters } from '@/types';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\nimport { matchProductSearch } from '@/utils/searchUtils';\r\n\r\n/**\r\n * Hook for filtering products based on search, category, and stock status\r\n */\r\nexport const useProductFilters = (products: Product[]) => {\r\n  const { currentBusiness } = useBusiness();\r\n\r\n  const FILTER_STORAGE_KEY = useMemo(() =>\r\n    currentBusiness?.id ? `productFilters_${currentBusiness.id}` : 'productFilters'\r\n    , [currentBusiness?.id]);\r\n\r\n  // Load initial filters from localStorage or use defaults\r\n  const loadFiltersFromStorage = useCallback((): ProductFilters => {\r\n    try {\r\n      const stored = localStorage.getItem(FILTER_STORAGE_KEY);\r\n      if (stored) {\r\n        const parsed = JSON.parse(stored);\r\n        return {\r\n          search: parsed.search || '',\r\n          category: parsed.category || '',\r\n          stockStatus: parsed.stockStatus || 'all'\r\n        };\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load filters from localStorage:', error);\r\n    }\r\n\r\n    return {\r\n      search: '',\r\n      category: '',\r\n      stockStatus: 'all'\r\n    };\r\n  }, [FILTER_STORAGE_KEY]);\r\n\r\n  const [filters, setFiltersState] = useState<ProductFilters>(loadFiltersFromStorage);\r\n\r\n  // Reload filters when business changes\r\n  useEffect(() => {\r\n    if (currentBusiness?.id) {\r\n      setFiltersState(loadFiltersFromStorage());\r\n    }\r\n  }, [currentBusiness?.id, loadFiltersFromStorage]);\r\n\r\n  // Save filters to localStorage whenever they change\r\n  useEffect(() => {\r\n    try {\r\n      localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(filters));\r\n    } catch (error) {\r\n      console.error('Failed to save filters to localStorage:', error);\r\n    }\r\n  }, [filters, FILTER_STORAGE_KEY]);\r\n\r\n  // Wrapper function to update filters\r\n  const setFilters = (newFilters: ProductFilters) => {\r\n    setFiltersState(newFilters);\r\n  };\r\n\r\n  const applyFilters = (products: Product[], filters: ProductFilters): Product[] => {\r\n    return products.filter(product => {\r\n      // Search filter - now uses multi-word matching\r\n      if (filters.search) {\r\n        if (!matchProductSearch(product, filters.search)) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      // Category filter\r\n      if (filters.category && filters.category !== product.category) {\r\n        return false;\r\n      }\r\n\r\n      // Stock status filter\r\n      if (filters.stockStatus !== 'all') {\r\n        if (filters.stockStatus === 'inStock' && product.quantity <= product.minimumStock) {\r\n          return false;\r\n        }\r\n        if (filters.stockStatus === 'lowStock' && (product.quantity === 0 || product.quantity > product.minimumStock)) {\r\n          return false;\r\n        }\r\n        if (filters.stockStatus === 'outOfStock' && product.quantity > 0) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      return true;\r\n    });\r\n  };\r\n\r\n  const filteredProducts = useMemo(() => {\r\n    return applyFilters(products, filters);\r\n  }, [products, filters]);\r\n\r\n  return {\r\n    filters,\r\n    setFilters,\r\n    filteredProducts,\r\n    applyFilters\r\n  };\r\n};\r\n"],"names":[],"mappings":";;;;AAAA;AAEA;AACA;;;;;AAKO,MAAM,oBAAoB,CAAC;;IAChC,MAAM,EAAE,eAAe,EAAE,GAAG,IAAA,qJAAW;IAEvC,MAAM,qBAAqB,IAAA,wKAAO;yDAAC,IACjC,iBAAiB,KAAK,CAAC,eAAe,EAAE,gBAAgB,EAAE,EAAE,GAAG;wDAC7D;QAAC,iBAAiB;KAAG;IAEzB,yDAAyD;IACzD,MAAM,yBAAyB,IAAA,4KAAW;iEAAC;YACzC,IAAI;gBACF,MAAM,SAAS,aAAa,OAAO,CAAC;gBACpC,IAAI,QAAQ;oBACV,MAAM,SAAS,KAAK,KAAK,CAAC;oBAC1B,OAAO;wBACL,QAAQ,OAAO,MAAM,IAAI;wBACzB,UAAU,OAAO,QAAQ,IAAI;wBAC7B,aAAa,OAAO,WAAW,IAAI;oBACrC;gBACF;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,6CAA6C;YAC7D;YAEA,OAAO;gBACL,QAAQ;gBACR,UAAU;gBACV,aAAa;YACf;QACF;gEAAG;QAAC;KAAmB;IAEvB,MAAM,CAAC,SAAS,gBAAgB,GAAG,IAAA,yKAAQ,EAAiB;IAE5D,uCAAuC;IACvC,IAAA,0KAAS;uCAAC;YACR,IAAI,iBAAiB,IAAI;gBACvB,gBAAgB;YAClB;QACF;sCAAG;QAAC,iBAAiB;QAAI;KAAuB;IAEhD,oDAAoD;IACpD,IAAA,0KAAS;uCAAC;YACR,IAAI;gBACF,aAAa,OAAO,CAAC,oBAAoB,KAAK,SAAS,CAAC;YAC1D,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,2CAA2C;YAC3D;QACF;sCAAG;QAAC;QAAS;KAAmB;IAEhC,qCAAqC;IACrC,MAAM,aAAa,CAAC;QAClB,gBAAgB;IAClB;IAEA,MAAM,eAAe,CAAC,UAAqB;QACzC,OAAO,SAAS,MAAM,CAAC,CAAA;YACrB,+CAA+C;YAC/C,IAAI,QAAQ,MAAM,EAAE;gBAClB,IAAI,CAAC,IAAA,oJAAkB,EAAC,SAAS,QAAQ,MAAM,GAAG;oBAChD,OAAO;gBACT;YACF;YAEA,kBAAkB;YAClB,IAAI,QAAQ,QAAQ,IAAI,QAAQ,QAAQ,KAAK,QAAQ,QAAQ,EAAE;gBAC7D,OAAO;YACT;YAEA,sBAAsB;YACtB,IAAI,QAAQ,WAAW,KAAK,OAAO;gBACjC,IAAI,QAAQ,WAAW,KAAK,aAAa,QAAQ,QAAQ,IAAI,QAAQ,YAAY,EAAE;oBACjF,OAAO;gBACT;gBACA,IAAI,QAAQ,WAAW,KAAK,cAAc,CAAC,QAAQ,QAAQ,KAAK,KAAK,QAAQ,QAAQ,GAAG,QAAQ,YAAY,GAAG;oBAC7G,OAAO;gBACT;gBACA,IAAI,QAAQ,WAAW,KAAK,gBAAgB,QAAQ,QAAQ,GAAG,GAAG;oBAChE,OAAO;gBACT;YACF;YAEA,OAAO;QACT;IACF;IAEA,MAAM,mBAAmB,IAAA,wKAAO;uDAAC;YAC/B,OAAO,aAAa,UAAU;QAChC;sDAAG;QAAC;QAAU;KAAQ;IAEtB,OAAO;QACL;QACA;QACA;QACA;IACF;AACF;GA9Fa;;QACiB,qJAAW"}},
    {"offset": {"line": 3082, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/utils/inventoryCacheUtils.ts"],"sourcesContent":["import { QueryClient } from \"@tanstack/react-query\";\r\n\r\n/**\r\n * Utility to clear inventory-related caches (both localStorage and React Query)\r\n * to ensure real-time data accuracy.\r\n */\r\nexport const clearInventoryCaches = (queryClient?: QueryClient) => {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    // 1. Clear LocalStorage (Legacy / Manual caches)\r\n    const keys = Object.keys(localStorage);\r\n    const patterns = [\r\n        'allProductsStats_',\r\n        'stockSummary_',\r\n        'soldItems_',\r\n        'dashboardData_',\r\n        'analyticsData_'\r\n    ];\r\n\r\n    let clearedCount = 0;\r\n    keys.forEach(key => {\r\n        if (patterns.some(pattern => key.startsWith(pattern))) {\r\n            localStorage.removeItem(key);\r\n            clearedCount++;\r\n        }\r\n    });\r\n\r\n    if (clearedCount > 0) {\r\n        console.log(`[Cache] Cleared ${clearedCount} inventory-related localStorage entries.`);\r\n    }\r\n\r\n    // 2. Invalidate React Query Keys (Modern State)\r\n    if (queryClient) {\r\n        console.log('[Cache] Invalidating React Query inventory keys...');\r\n        // Invalidate specific keys used in the inventory module\r\n        queryClient.invalidateQueries({ queryKey: ['inventory_global_stats'] });\r\n        queryClient.invalidateQueries({ queryKey: ['stockSummary'] });\r\n        queryClient.invalidateQueries({ queryKey: ['products'] });\r\n        queryClient.invalidateQueries({ queryKey: ['sales'] });\r\n        queryClient.invalidateQueries({ queryKey: ['all-products-for-scanner'] });\r\n        queryClient.invalidateQueries({ queryKey: ['all-products'] });\r\n    }\r\n};\r\n"],"names":[],"mappings":";;;;AAMO,MAAM,uBAAuB,CAAC;IACjC;;IAEA,iDAAiD;IACjD,MAAM,OAAO,OAAO,IAAI,CAAC;IACzB,MAAM,WAAW;QACb;QACA;QACA;QACA;QACA;KACH;IAED,IAAI,eAAe;IACnB,KAAK,OAAO,CAAC,CAAA;QACT,IAAI,SAAS,IAAI,CAAC,CAAA,UAAW,IAAI,UAAU,CAAC,WAAW;YACnD,aAAa,UAAU,CAAC;YACxB;QACJ;IACJ;IAEA,IAAI,eAAe,GAAG;QAClB,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,aAAa,wCAAwC,CAAC;IACzF;IAEA,gDAAgD;IAChD,IAAI,aAAa;QACb,QAAQ,GAAG,CAAC;QACZ,wDAAwD;QACxD,YAAY,iBAAiB,CAAC;YAAE,UAAU;gBAAC;aAAyB;QAAC;QACrE,YAAY,iBAAiB,CAAC;YAAE,UAAU;gBAAC;aAAe;QAAC;QAC3D,YAAY,iBAAiB,CAAC;YAAE,UAAU;gBAAC;aAAW;QAAC;QACvD,YAAY,iBAAiB,CAAC;YAAE,UAAU;gBAAC;aAAQ;QAAC;QACpD,YAAY,iBAAiB,CAAC;YAAE,UAAU;gBAAC;aAA2B;QAAC;QACvE,YAAY,iBAAiB,CAAC;YAAE,UAAU;gBAAC;aAAe;QAAC;IAC/D;AACJ"}},
    {"offset": {"line": 3151, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/app/actions/products.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { Product, ProductFormData, mapDbProductToProduct, mapProductToDbProduct } from '@/types';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// We implement server actions for the products here\r\n\r\nexport async function getProductsAction({\r\n  userId,\r\n  businessId,\r\n  page,\r\n  pageSize,\r\n  search,\r\n  category,\r\n  stockStatus,\r\n}: {\r\n  userId: string;\r\n  businessId: string;\r\n  page: number;\r\n  pageSize: number;\r\n  search?: string;\r\n  category?: string;\r\n  stockStatus?: 'inStock' | 'outOfStock' | 'lowStock' | 'all';\r\n}) {\r\n  if (!userId || !businessId) return { products: [], count: 0 };\r\n\r\n  const skip = (page - 1) * pageSize;\r\n  const take = pageSize;\r\n\r\n  let whereClause: any = {\r\n    userId: userId,\r\n    branchId: businessId,\r\n  };\r\n\r\n  if (search) {\r\n    whereClause.OR = [\r\n      { name: { contains: search, mode: 'insensitive' } },\r\n      { description: { contains: search, mode: 'insensitive' } },\r\n      { sku: { contains: search, mode: 'insensitive' } },\r\n      { barcode: { contains: search, mode: 'insensitive' } },\r\n    ];\r\n  }\r\n\r\n  if (category) {\r\n    whereClause.category = { name: category };\r\n  }\r\n\r\n  if (stockStatus === 'outOfStock') {\r\n    whereClause.stock = 0;\r\n  } else if (stockStatus === 'inStock') {\r\n    whereClause.stock = { gt: 0 };\r\n  } else if (stockStatus === 'lowStock') {\r\n    // Handling lowStock is complex because minStock is compared locally or using direct SQL in Prisma\r\n    // For now, we will handle it with Prisma's raw query or by filtering in memory if necessary\r\n    // Fortunately, since PRISMA 5.0, column comparison still needs raw queries or we can fetch and filter if small\r\n    // Here we'll fetch them all if lowStock is enabled, or add a generated column. \r\n    // We will do a basic fetch and filter later if needed.\r\n  }\r\n\r\n  try {\r\n    const [productsData, totalCount] = await Promise.all([\r\n      db.product.findMany({\r\n        where: whereClause,\r\n        skip,\r\n        take,\r\n        orderBy: [{ createdAt: 'desc' }, { id: 'desc' }],\r\n        include: {\r\n          category: true,\r\n          supplier: true,\r\n        }\r\n      }),\r\n      db.product.count({ where: whereClause })\r\n    ]);\r\n\r\n    // Map the Prisma product model back to the application's Product type\r\n    let formattedProducts = productsData.map((p) => {\r\n      // Assuming mapping exists, we will map it\r\n      return {\r\n        id: p.id,\r\n        name: p.name,\r\n        description: p.description || '',\r\n        category: p.category?.name || 'Uncategorized',\r\n        quantity: p.stock,\r\n        costPrice: p.costPrice,\r\n        sellingPrice: p.sellingPrice,\r\n        supplier: p.supplier?.name,\r\n        imageUrl: p.image,\r\n        barcode: p.barcode,\r\n        itemNumber: p.sku || '',\r\n        minimumStock: p.minStock,\r\n        createdAt: p.createdAt,\r\n      };\r\n    });\r\n\r\n    if (stockStatus === 'lowStock') {\r\n      formattedProducts = formattedProducts.filter(p => p.quantity > 0 && p.quantity <= p.minimumStock);\r\n    }\r\n\r\n    return { products: formattedProducts as any[], count: totalCount };\r\n  } catch (error) {\r\n    console.error('Error fetching products from DB:', error);\r\n    return { products: [], count: 0 };\r\n  }\r\n}\r\n\r\nexport async function createProductAction(data: any) {\r\n  try {\r\n    const product = await db.product.create({\r\n      data: {\r\n        name: data.name,\r\n        description: data.description,\r\n        branchId: data.businessId,\r\n        userId: data.userId,\r\n        // Optional relations\r\n        ...(data.categoryId && { categoryId: data.categoryId }),\r\n        ...(data.supplierId && { supplierId: data.supplierId }),\r\n        sku: data.itemNumber || data.sku,\r\n        barcode: data.barcode,\r\n        image: data.imageUrl,\r\n        costPrice: data.costPrice,\r\n        sellingPrice: data.sellingPrice,\r\n        stock: data.quantity || 0,\r\n        minStock: data.minimumStock || 0,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return {\r\n      id: product.id,\r\n      name: product.name,\r\n      description: product.description || '',\r\n      category: 'Uncategorized', // Would need real mapping\r\n      quantity: product.stock,\r\n      costPrice: product.costPrice,\r\n      sellingPrice: product.sellingPrice,\r\n      imageUrl: product.image,\r\n      barcode: product.barcode,\r\n      itemNumber: product.sku || '',\r\n      minimumStock: product.minStock,\r\n      createdAt: product.createdAt,\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function updateProductAction(id: string, updates: any) {\r\n  try {\r\n    const updated = await db.product.update({\r\n      where: { id },\r\n      data: {\r\n        name: updates.name,\r\n        description: updates.description,\r\n        ...(updates.categoryId !== undefined && { categoryId: updates.categoryId }),\r\n        ...(updates.supplierId !== undefined && { supplierId: updates.supplierId }),\r\n        sku: updates.itemNumber || updates.sku,\r\n        barcode: updates.barcode,\r\n        image: updates.imageUrl,\r\n        costPrice: updates.costPrice,\r\n        sellingPrice: updates.sellingPrice,\r\n        stock: updates.quantity,\r\n        minStock: updates.minimumStock,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return updated;\r\n  } catch (error) {\r\n    console.error('Error updating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function deleteProductAction(id: string) {\r\n  try {\r\n    await db.product.delete({\r\n      where: { id }\r\n    });\r\n    // revalidatePath('/inventory/products');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error deleting product:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function updateProductsBulkAction(\r\n  updates: Array<{ id: string; updated: Partial<any> }>,\r\n  businessId: string\r\n) {\r\n  try {\r\n    // Prisma transaction for bulk updates\r\n    const updatePromises = updates.map(u =>\r\n      db.product.update({\r\n        where: { id: u.id },\r\n        data: {\r\n          ...(u.updated.name && { name: u.updated.name }),\r\n          ...(u.updated.description !== undefined && { description: u.updated.description }),\r\n          ...(u.updated.categoryId !== undefined && { categoryId: u.updated.categoryId }),\r\n          ...(u.updated.supplierId !== undefined && { supplierId: u.updated.supplierId }),\r\n          ...(u.updated.sku !== undefined && { sku: u.updated.sku }),\r\n          ...(u.updated.barcode !== undefined && { barcode: u.updated.barcode }),\r\n          ...(u.updated.costPrice !== undefined && { costPrice: u.updated.costPrice }),\r\n          ...(u.updated.sellingPrice !== undefined && { sellingPrice: u.updated.sellingPrice }),\r\n          ...(u.updated.quantity !== undefined && { stock: u.updated.quantity }),\r\n          ...(u.updated.minimumStock !== undefined && { minStock: u.updated.minimumStock }),\r\n        }\r\n      })\r\n    );\r\n\r\n    await db.$transaction(updatePromises);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error performing bulk update:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAQsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,qDAAA"}},
    {"offset": {"line": 3168, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/app/actions/products.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { Product, ProductFormData, mapDbProductToProduct, mapProductToDbProduct } from '@/types';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// We implement server actions for the products here\r\n\r\nexport async function getProductsAction({\r\n  userId,\r\n  businessId,\r\n  page,\r\n  pageSize,\r\n  search,\r\n  category,\r\n  stockStatus,\r\n}: {\r\n  userId: string;\r\n  businessId: string;\r\n  page: number;\r\n  pageSize: number;\r\n  search?: string;\r\n  category?: string;\r\n  stockStatus?: 'inStock' | 'outOfStock' | 'lowStock' | 'all';\r\n}) {\r\n  if (!userId || !businessId) return { products: [], count: 0 };\r\n\r\n  const skip = (page - 1) * pageSize;\r\n  const take = pageSize;\r\n\r\n  let whereClause: any = {\r\n    userId: userId,\r\n    branchId: businessId,\r\n  };\r\n\r\n  if (search) {\r\n    whereClause.OR = [\r\n      { name: { contains: search, mode: 'insensitive' } },\r\n      { description: { contains: search, mode: 'insensitive' } },\r\n      { sku: { contains: search, mode: 'insensitive' } },\r\n      { barcode: { contains: search, mode: 'insensitive' } },\r\n    ];\r\n  }\r\n\r\n  if (category) {\r\n    whereClause.category = { name: category };\r\n  }\r\n\r\n  if (stockStatus === 'outOfStock') {\r\n    whereClause.stock = 0;\r\n  } else if (stockStatus === 'inStock') {\r\n    whereClause.stock = { gt: 0 };\r\n  } else if (stockStatus === 'lowStock') {\r\n    // Handling lowStock is complex because minStock is compared locally or using direct SQL in Prisma\r\n    // For now, we will handle it with Prisma's raw query or by filtering in memory if necessary\r\n    // Fortunately, since PRISMA 5.0, column comparison still needs raw queries or we can fetch and filter if small\r\n    // Here we'll fetch them all if lowStock is enabled, or add a generated column. \r\n    // We will do a basic fetch and filter later if needed.\r\n  }\r\n\r\n  try {\r\n    const [productsData, totalCount] = await Promise.all([\r\n      db.product.findMany({\r\n        where: whereClause,\r\n        skip,\r\n        take,\r\n        orderBy: [{ createdAt: 'desc' }, { id: 'desc' }],\r\n        include: {\r\n          category: true,\r\n          supplier: true,\r\n        }\r\n      }),\r\n      db.product.count({ where: whereClause })\r\n    ]);\r\n\r\n    // Map the Prisma product model back to the application's Product type\r\n    let formattedProducts = productsData.map((p) => {\r\n      // Assuming mapping exists, we will map it\r\n      return {\r\n        id: p.id,\r\n        name: p.name,\r\n        description: p.description || '',\r\n        category: p.category?.name || 'Uncategorized',\r\n        quantity: p.stock,\r\n        costPrice: p.costPrice,\r\n        sellingPrice: p.sellingPrice,\r\n        supplier: p.supplier?.name,\r\n        imageUrl: p.image,\r\n        barcode: p.barcode,\r\n        itemNumber: p.sku || '',\r\n        minimumStock: p.minStock,\r\n        createdAt: p.createdAt,\r\n      };\r\n    });\r\n\r\n    if (stockStatus === 'lowStock') {\r\n      formattedProducts = formattedProducts.filter(p => p.quantity > 0 && p.quantity <= p.minimumStock);\r\n    }\r\n\r\n    return { products: formattedProducts as any[], count: totalCount };\r\n  } catch (error) {\r\n    console.error('Error fetching products from DB:', error);\r\n    return { products: [], count: 0 };\r\n  }\r\n}\r\n\r\nexport async function createProductAction(data: any) {\r\n  try {\r\n    const product = await db.product.create({\r\n      data: {\r\n        name: data.name,\r\n        description: data.description,\r\n        branchId: data.businessId,\r\n        userId: data.userId,\r\n        // Optional relations\r\n        ...(data.categoryId && { categoryId: data.categoryId }),\r\n        ...(data.supplierId && { supplierId: data.supplierId }),\r\n        sku: data.itemNumber || data.sku,\r\n        barcode: data.barcode,\r\n        image: data.imageUrl,\r\n        costPrice: data.costPrice,\r\n        sellingPrice: data.sellingPrice,\r\n        stock: data.quantity || 0,\r\n        minStock: data.minimumStock || 0,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return {\r\n      id: product.id,\r\n      name: product.name,\r\n      description: product.description || '',\r\n      category: 'Uncategorized', // Would need real mapping\r\n      quantity: product.stock,\r\n      costPrice: product.costPrice,\r\n      sellingPrice: product.sellingPrice,\r\n      imageUrl: product.image,\r\n      barcode: product.barcode,\r\n      itemNumber: product.sku || '',\r\n      minimumStock: product.minStock,\r\n      createdAt: product.createdAt,\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function updateProductAction(id: string, updates: any) {\r\n  try {\r\n    const updated = await db.product.update({\r\n      where: { id },\r\n      data: {\r\n        name: updates.name,\r\n        description: updates.description,\r\n        ...(updates.categoryId !== undefined && { categoryId: updates.categoryId }),\r\n        ...(updates.supplierId !== undefined && { supplierId: updates.supplierId }),\r\n        sku: updates.itemNumber || updates.sku,\r\n        barcode: updates.barcode,\r\n        image: updates.imageUrl,\r\n        costPrice: updates.costPrice,\r\n        sellingPrice: updates.sellingPrice,\r\n        stock: updates.quantity,\r\n        minStock: updates.minimumStock,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return updated;\r\n  } catch (error) {\r\n    console.error('Error updating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function deleteProductAction(id: string) {\r\n  try {\r\n    await db.product.delete({\r\n      where: { id }\r\n    });\r\n    // revalidatePath('/inventory/products');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error deleting product:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function updateProductsBulkAction(\r\n  updates: Array<{ id: string; updated: Partial<any> }>,\r\n  businessId: string\r\n) {\r\n  try {\r\n    // Prisma transaction for bulk updates\r\n    const updatePromises = updates.map(u =>\r\n      db.product.update({\r\n        where: { id: u.id },\r\n        data: {\r\n          ...(u.updated.name && { name: u.updated.name }),\r\n          ...(u.updated.description !== undefined && { description: u.updated.description }),\r\n          ...(u.updated.categoryId !== undefined && { categoryId: u.updated.categoryId }),\r\n          ...(u.updated.supplierId !== undefined && { supplierId: u.updated.supplierId }),\r\n          ...(u.updated.sku !== undefined && { sku: u.updated.sku }),\r\n          ...(u.updated.barcode !== undefined && { barcode: u.updated.barcode }),\r\n          ...(u.updated.costPrice !== undefined && { costPrice: u.updated.costPrice }),\r\n          ...(u.updated.sellingPrice !== undefined && { sellingPrice: u.updated.sellingPrice }),\r\n          ...(u.updated.quantity !== undefined && { stock: u.updated.quantity }),\r\n          ...(u.updated.minimumStock !== undefined && { minStock: u.updated.minimumStock }),\r\n        }\r\n      })\r\n    );\r\n\r\n    await db.$transaction(updatePromises);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error performing bulk update:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA0GsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,uDAAA"}},
    {"offset": {"line": 3185, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/app/actions/products.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { Product, ProductFormData, mapDbProductToProduct, mapProductToDbProduct } from '@/types';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// We implement server actions for the products here\r\n\r\nexport async function getProductsAction({\r\n  userId,\r\n  businessId,\r\n  page,\r\n  pageSize,\r\n  search,\r\n  category,\r\n  stockStatus,\r\n}: {\r\n  userId: string;\r\n  businessId: string;\r\n  page: number;\r\n  pageSize: number;\r\n  search?: string;\r\n  category?: string;\r\n  stockStatus?: 'inStock' | 'outOfStock' | 'lowStock' | 'all';\r\n}) {\r\n  if (!userId || !businessId) return { products: [], count: 0 };\r\n\r\n  const skip = (page - 1) * pageSize;\r\n  const take = pageSize;\r\n\r\n  let whereClause: any = {\r\n    userId: userId,\r\n    branchId: businessId,\r\n  };\r\n\r\n  if (search) {\r\n    whereClause.OR = [\r\n      { name: { contains: search, mode: 'insensitive' } },\r\n      { description: { contains: search, mode: 'insensitive' } },\r\n      { sku: { contains: search, mode: 'insensitive' } },\r\n      { barcode: { contains: search, mode: 'insensitive' } },\r\n    ];\r\n  }\r\n\r\n  if (category) {\r\n    whereClause.category = { name: category };\r\n  }\r\n\r\n  if (stockStatus === 'outOfStock') {\r\n    whereClause.stock = 0;\r\n  } else if (stockStatus === 'inStock') {\r\n    whereClause.stock = { gt: 0 };\r\n  } else if (stockStatus === 'lowStock') {\r\n    // Handling lowStock is complex because minStock is compared locally or using direct SQL in Prisma\r\n    // For now, we will handle it with Prisma's raw query or by filtering in memory if necessary\r\n    // Fortunately, since PRISMA 5.0, column comparison still needs raw queries or we can fetch and filter if small\r\n    // Here we'll fetch them all if lowStock is enabled, or add a generated column. \r\n    // We will do a basic fetch and filter later if needed.\r\n  }\r\n\r\n  try {\r\n    const [productsData, totalCount] = await Promise.all([\r\n      db.product.findMany({\r\n        where: whereClause,\r\n        skip,\r\n        take,\r\n        orderBy: [{ createdAt: 'desc' }, { id: 'desc' }],\r\n        include: {\r\n          category: true,\r\n          supplier: true,\r\n        }\r\n      }),\r\n      db.product.count({ where: whereClause })\r\n    ]);\r\n\r\n    // Map the Prisma product model back to the application's Product type\r\n    let formattedProducts = productsData.map((p) => {\r\n      // Assuming mapping exists, we will map it\r\n      return {\r\n        id: p.id,\r\n        name: p.name,\r\n        description: p.description || '',\r\n        category: p.category?.name || 'Uncategorized',\r\n        quantity: p.stock,\r\n        costPrice: p.costPrice,\r\n        sellingPrice: p.sellingPrice,\r\n        supplier: p.supplier?.name,\r\n        imageUrl: p.image,\r\n        barcode: p.barcode,\r\n        itemNumber: p.sku || '',\r\n        minimumStock: p.minStock,\r\n        createdAt: p.createdAt,\r\n      };\r\n    });\r\n\r\n    if (stockStatus === 'lowStock') {\r\n      formattedProducts = formattedProducts.filter(p => p.quantity > 0 && p.quantity <= p.minimumStock);\r\n    }\r\n\r\n    return { products: formattedProducts as any[], count: totalCount };\r\n  } catch (error) {\r\n    console.error('Error fetching products from DB:', error);\r\n    return { products: [], count: 0 };\r\n  }\r\n}\r\n\r\nexport async function createProductAction(data: any) {\r\n  try {\r\n    const product = await db.product.create({\r\n      data: {\r\n        name: data.name,\r\n        description: data.description,\r\n        branchId: data.businessId,\r\n        userId: data.userId,\r\n        // Optional relations\r\n        ...(data.categoryId && { categoryId: data.categoryId }),\r\n        ...(data.supplierId && { supplierId: data.supplierId }),\r\n        sku: data.itemNumber || data.sku,\r\n        barcode: data.barcode,\r\n        image: data.imageUrl,\r\n        costPrice: data.costPrice,\r\n        sellingPrice: data.sellingPrice,\r\n        stock: data.quantity || 0,\r\n        minStock: data.minimumStock || 0,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return {\r\n      id: product.id,\r\n      name: product.name,\r\n      description: product.description || '',\r\n      category: 'Uncategorized', // Would need real mapping\r\n      quantity: product.stock,\r\n      costPrice: product.costPrice,\r\n      sellingPrice: product.sellingPrice,\r\n      imageUrl: product.image,\r\n      barcode: product.barcode,\r\n      itemNumber: product.sku || '',\r\n      minimumStock: product.minStock,\r\n      createdAt: product.createdAt,\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function updateProductAction(id: string, updates: any) {\r\n  try {\r\n    const updated = await db.product.update({\r\n      where: { id },\r\n      data: {\r\n        name: updates.name,\r\n        description: updates.description,\r\n        ...(updates.categoryId !== undefined && { categoryId: updates.categoryId }),\r\n        ...(updates.supplierId !== undefined && { supplierId: updates.supplierId }),\r\n        sku: updates.itemNumber || updates.sku,\r\n        barcode: updates.barcode,\r\n        image: updates.imageUrl,\r\n        costPrice: updates.costPrice,\r\n        sellingPrice: updates.sellingPrice,\r\n        stock: updates.quantity,\r\n        minStock: updates.minimumStock,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return updated;\r\n  } catch (error) {\r\n    console.error('Error updating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function deleteProductAction(id: string) {\r\n  try {\r\n    await db.product.delete({\r\n      where: { id }\r\n    });\r\n    // revalidatePath('/inventory/products');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error deleting product:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function updateProductsBulkAction(\r\n  updates: Array<{ id: string; updated: Partial<any> }>,\r\n  businessId: string\r\n) {\r\n  try {\r\n    // Prisma transaction for bulk updates\r\n    const updatePromises = updates.map(u =>\r\n      db.product.update({\r\n        where: { id: u.id },\r\n        data: {\r\n          ...(u.updated.name && { name: u.updated.name }),\r\n          ...(u.updated.description !== undefined && { description: u.updated.description }),\r\n          ...(u.updated.categoryId !== undefined && { categoryId: u.updated.categoryId }),\r\n          ...(u.updated.supplierId !== undefined && { supplierId: u.updated.supplierId }),\r\n          ...(u.updated.sku !== undefined && { sku: u.updated.sku }),\r\n          ...(u.updated.barcode !== undefined && { barcode: u.updated.barcode }),\r\n          ...(u.updated.costPrice !== undefined && { costPrice: u.updated.costPrice }),\r\n          ...(u.updated.sellingPrice !== undefined && { sellingPrice: u.updated.sellingPrice }),\r\n          ...(u.updated.quantity !== undefined && { stock: u.updated.quantity }),\r\n          ...(u.updated.minimumStock !== undefined && { minStock: u.updated.minimumStock }),\r\n        }\r\n      })\r\n    );\r\n\r\n    await db.$transaction(updatePromises);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error performing bulk update:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAqJsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,uDAAA"}},
    {"offset": {"line": 3202, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/app/actions/products.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { Product, ProductFormData, mapDbProductToProduct, mapProductToDbProduct } from '@/types';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// We implement server actions for the products here\r\n\r\nexport async function getProductsAction({\r\n  userId,\r\n  businessId,\r\n  page,\r\n  pageSize,\r\n  search,\r\n  category,\r\n  stockStatus,\r\n}: {\r\n  userId: string;\r\n  businessId: string;\r\n  page: number;\r\n  pageSize: number;\r\n  search?: string;\r\n  category?: string;\r\n  stockStatus?: 'inStock' | 'outOfStock' | 'lowStock' | 'all';\r\n}) {\r\n  if (!userId || !businessId) return { products: [], count: 0 };\r\n\r\n  const skip = (page - 1) * pageSize;\r\n  const take = pageSize;\r\n\r\n  let whereClause: any = {\r\n    userId: userId,\r\n    branchId: businessId,\r\n  };\r\n\r\n  if (search) {\r\n    whereClause.OR = [\r\n      { name: { contains: search, mode: 'insensitive' } },\r\n      { description: { contains: search, mode: 'insensitive' } },\r\n      { sku: { contains: search, mode: 'insensitive' } },\r\n      { barcode: { contains: search, mode: 'insensitive' } },\r\n    ];\r\n  }\r\n\r\n  if (category) {\r\n    whereClause.category = { name: category };\r\n  }\r\n\r\n  if (stockStatus === 'outOfStock') {\r\n    whereClause.stock = 0;\r\n  } else if (stockStatus === 'inStock') {\r\n    whereClause.stock = { gt: 0 };\r\n  } else if (stockStatus === 'lowStock') {\r\n    // Handling lowStock is complex because minStock is compared locally or using direct SQL in Prisma\r\n    // For now, we will handle it with Prisma's raw query or by filtering in memory if necessary\r\n    // Fortunately, since PRISMA 5.0, column comparison still needs raw queries or we can fetch and filter if small\r\n    // Here we'll fetch them all if lowStock is enabled, or add a generated column. \r\n    // We will do a basic fetch and filter later if needed.\r\n  }\r\n\r\n  try {\r\n    const [productsData, totalCount] = await Promise.all([\r\n      db.product.findMany({\r\n        where: whereClause,\r\n        skip,\r\n        take,\r\n        orderBy: [{ createdAt: 'desc' }, { id: 'desc' }],\r\n        include: {\r\n          category: true,\r\n          supplier: true,\r\n        }\r\n      }),\r\n      db.product.count({ where: whereClause })\r\n    ]);\r\n\r\n    // Map the Prisma product model back to the application's Product type\r\n    let formattedProducts = productsData.map((p) => {\r\n      // Assuming mapping exists, we will map it\r\n      return {\r\n        id: p.id,\r\n        name: p.name,\r\n        description: p.description || '',\r\n        category: p.category?.name || 'Uncategorized',\r\n        quantity: p.stock,\r\n        costPrice: p.costPrice,\r\n        sellingPrice: p.sellingPrice,\r\n        supplier: p.supplier?.name,\r\n        imageUrl: p.image,\r\n        barcode: p.barcode,\r\n        itemNumber: p.sku || '',\r\n        minimumStock: p.minStock,\r\n        createdAt: p.createdAt,\r\n      };\r\n    });\r\n\r\n    if (stockStatus === 'lowStock') {\r\n      formattedProducts = formattedProducts.filter(p => p.quantity > 0 && p.quantity <= p.minimumStock);\r\n    }\r\n\r\n    return { products: formattedProducts as any[], count: totalCount };\r\n  } catch (error) {\r\n    console.error('Error fetching products from DB:', error);\r\n    return { products: [], count: 0 };\r\n  }\r\n}\r\n\r\nexport async function createProductAction(data: any) {\r\n  try {\r\n    const product = await db.product.create({\r\n      data: {\r\n        name: data.name,\r\n        description: data.description,\r\n        branchId: data.businessId,\r\n        userId: data.userId,\r\n        // Optional relations\r\n        ...(data.categoryId && { categoryId: data.categoryId }),\r\n        ...(data.supplierId && { supplierId: data.supplierId }),\r\n        sku: data.itemNumber || data.sku,\r\n        barcode: data.barcode,\r\n        image: data.imageUrl,\r\n        costPrice: data.costPrice,\r\n        sellingPrice: data.sellingPrice,\r\n        stock: data.quantity || 0,\r\n        minStock: data.minimumStock || 0,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return {\r\n      id: product.id,\r\n      name: product.name,\r\n      description: product.description || '',\r\n      category: 'Uncategorized', // Would need real mapping\r\n      quantity: product.stock,\r\n      costPrice: product.costPrice,\r\n      sellingPrice: product.sellingPrice,\r\n      imageUrl: product.image,\r\n      barcode: product.barcode,\r\n      itemNumber: product.sku || '',\r\n      minimumStock: product.minStock,\r\n      createdAt: product.createdAt,\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function updateProductAction(id: string, updates: any) {\r\n  try {\r\n    const updated = await db.product.update({\r\n      where: { id },\r\n      data: {\r\n        name: updates.name,\r\n        description: updates.description,\r\n        ...(updates.categoryId !== undefined && { categoryId: updates.categoryId }),\r\n        ...(updates.supplierId !== undefined && { supplierId: updates.supplierId }),\r\n        sku: updates.itemNumber || updates.sku,\r\n        barcode: updates.barcode,\r\n        image: updates.imageUrl,\r\n        costPrice: updates.costPrice,\r\n        sellingPrice: updates.sellingPrice,\r\n        stock: updates.quantity,\r\n        minStock: updates.minimumStock,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return updated;\r\n  } catch (error) {\r\n    console.error('Error updating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function deleteProductAction(id: string) {\r\n  try {\r\n    await db.product.delete({\r\n      where: { id }\r\n    });\r\n    // revalidatePath('/inventory/products');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error deleting product:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function updateProductsBulkAction(\r\n  updates: Array<{ id: string; updated: Partial<any> }>,\r\n  businessId: string\r\n) {\r\n  try {\r\n    // Prisma transaction for bulk updates\r\n    const updatePromises = updates.map(u =>\r\n      db.product.update({\r\n        where: { id: u.id },\r\n        data: {\r\n          ...(u.updated.name && { name: u.updated.name }),\r\n          ...(u.updated.description !== undefined && { description: u.updated.description }),\r\n          ...(u.updated.categoryId !== undefined && { categoryId: u.updated.categoryId }),\r\n          ...(u.updated.supplierId !== undefined && { supplierId: u.updated.supplierId }),\r\n          ...(u.updated.sku !== undefined && { sku: u.updated.sku }),\r\n          ...(u.updated.barcode !== undefined && { barcode: u.updated.barcode }),\r\n          ...(u.updated.costPrice !== undefined && { costPrice: u.updated.costPrice }),\r\n          ...(u.updated.sellingPrice !== undefined && { sellingPrice: u.updated.sellingPrice }),\r\n          ...(u.updated.quantity !== undefined && { stock: u.updated.quantity }),\r\n          ...(u.updated.minimumStock !== undefined && { minStock: u.updated.minimumStock }),\r\n        }\r\n      })\r\n    );\r\n\r\n    await db.$transaction(updatePromises);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error performing bulk update:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAiLsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,uDAAA"}},
    {"offset": {"line": 3219, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/app/actions/products.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { Product, ProductFormData, mapDbProductToProduct, mapProductToDbProduct } from '@/types';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// We implement server actions for the products here\r\n\r\nexport async function getProductsAction({\r\n  userId,\r\n  businessId,\r\n  page,\r\n  pageSize,\r\n  search,\r\n  category,\r\n  stockStatus,\r\n}: {\r\n  userId: string;\r\n  businessId: string;\r\n  page: number;\r\n  pageSize: number;\r\n  search?: string;\r\n  category?: string;\r\n  stockStatus?: 'inStock' | 'outOfStock' | 'lowStock' | 'all';\r\n}) {\r\n  if (!userId || !businessId) return { products: [], count: 0 };\r\n\r\n  const skip = (page - 1) * pageSize;\r\n  const take = pageSize;\r\n\r\n  let whereClause: any = {\r\n    userId: userId,\r\n    branchId: businessId,\r\n  };\r\n\r\n  if (search) {\r\n    whereClause.OR = [\r\n      { name: { contains: search, mode: 'insensitive' } },\r\n      { description: { contains: search, mode: 'insensitive' } },\r\n      { sku: { contains: search, mode: 'insensitive' } },\r\n      { barcode: { contains: search, mode: 'insensitive' } },\r\n    ];\r\n  }\r\n\r\n  if (category) {\r\n    whereClause.category = { name: category };\r\n  }\r\n\r\n  if (stockStatus === 'outOfStock') {\r\n    whereClause.stock = 0;\r\n  } else if (stockStatus === 'inStock') {\r\n    whereClause.stock = { gt: 0 };\r\n  } else if (stockStatus === 'lowStock') {\r\n    // Handling lowStock is complex because minStock is compared locally or using direct SQL in Prisma\r\n    // For now, we will handle it with Prisma's raw query or by filtering in memory if necessary\r\n    // Fortunately, since PRISMA 5.0, column comparison still needs raw queries or we can fetch and filter if small\r\n    // Here we'll fetch them all if lowStock is enabled, or add a generated column. \r\n    // We will do a basic fetch and filter later if needed.\r\n  }\r\n\r\n  try {\r\n    const [productsData, totalCount] = await Promise.all([\r\n      db.product.findMany({\r\n        where: whereClause,\r\n        skip,\r\n        take,\r\n        orderBy: [{ createdAt: 'desc' }, { id: 'desc' }],\r\n        include: {\r\n          category: true,\r\n          supplier: true,\r\n        }\r\n      }),\r\n      db.product.count({ where: whereClause })\r\n    ]);\r\n\r\n    // Map the Prisma product model back to the application's Product type\r\n    let formattedProducts = productsData.map((p) => {\r\n      // Assuming mapping exists, we will map it\r\n      return {\r\n        id: p.id,\r\n        name: p.name,\r\n        description: p.description || '',\r\n        category: p.category?.name || 'Uncategorized',\r\n        quantity: p.stock,\r\n        costPrice: p.costPrice,\r\n        sellingPrice: p.sellingPrice,\r\n        supplier: p.supplier?.name,\r\n        imageUrl: p.image,\r\n        barcode: p.barcode,\r\n        itemNumber: p.sku || '',\r\n        minimumStock: p.minStock,\r\n        createdAt: p.createdAt,\r\n      };\r\n    });\r\n\r\n    if (stockStatus === 'lowStock') {\r\n      formattedProducts = formattedProducts.filter(p => p.quantity > 0 && p.quantity <= p.minimumStock);\r\n    }\r\n\r\n    return { products: formattedProducts as any[], count: totalCount };\r\n  } catch (error) {\r\n    console.error('Error fetching products from DB:', error);\r\n    return { products: [], count: 0 };\r\n  }\r\n}\r\n\r\nexport async function createProductAction(data: any) {\r\n  try {\r\n    const product = await db.product.create({\r\n      data: {\r\n        name: data.name,\r\n        description: data.description,\r\n        branchId: data.businessId,\r\n        userId: data.userId,\r\n        // Optional relations\r\n        ...(data.categoryId && { categoryId: data.categoryId }),\r\n        ...(data.supplierId && { supplierId: data.supplierId }),\r\n        sku: data.itemNumber || data.sku,\r\n        barcode: data.barcode,\r\n        image: data.imageUrl,\r\n        costPrice: data.costPrice,\r\n        sellingPrice: data.sellingPrice,\r\n        stock: data.quantity || 0,\r\n        minStock: data.minimumStock || 0,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return {\r\n      id: product.id,\r\n      name: product.name,\r\n      description: product.description || '',\r\n      category: 'Uncategorized', // Would need real mapping\r\n      quantity: product.stock,\r\n      costPrice: product.costPrice,\r\n      sellingPrice: product.sellingPrice,\r\n      imageUrl: product.image,\r\n      barcode: product.barcode,\r\n      itemNumber: product.sku || '',\r\n      minimumStock: product.minStock,\r\n      createdAt: product.createdAt,\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function updateProductAction(id: string, updates: any) {\r\n  try {\r\n    const updated = await db.product.update({\r\n      where: { id },\r\n      data: {\r\n        name: updates.name,\r\n        description: updates.description,\r\n        ...(updates.categoryId !== undefined && { categoryId: updates.categoryId }),\r\n        ...(updates.supplierId !== undefined && { supplierId: updates.supplierId }),\r\n        sku: updates.itemNumber || updates.sku,\r\n        barcode: updates.barcode,\r\n        image: updates.imageUrl,\r\n        costPrice: updates.costPrice,\r\n        sellingPrice: updates.sellingPrice,\r\n        stock: updates.quantity,\r\n        minStock: updates.minimumStock,\r\n      }\r\n    });\r\n\r\n    // revalidatePath('/inventory/products');\r\n\r\n    return updated;\r\n  } catch (error) {\r\n    console.error('Error updating product:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function deleteProductAction(id: string) {\r\n  try {\r\n    await db.product.delete({\r\n      where: { id }\r\n    });\r\n    // revalidatePath('/inventory/products');\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error deleting product:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function updateProductsBulkAction(\r\n  updates: Array<{ id: string; updated: Partial<any> }>,\r\n  businessId: string\r\n) {\r\n  try {\r\n    // Prisma transaction for bulk updates\r\n    const updatePromises = updates.map(u =>\r\n      db.product.update({\r\n        where: { id: u.id },\r\n        data: {\r\n          ...(u.updated.name && { name: u.updated.name }),\r\n          ...(u.updated.description !== undefined && { description: u.updated.description }),\r\n          ...(u.updated.categoryId !== undefined && { categoryId: u.updated.categoryId }),\r\n          ...(u.updated.supplierId !== undefined && { supplierId: u.updated.supplierId }),\r\n          ...(u.updated.sku !== undefined && { sku: u.updated.sku }),\r\n          ...(u.updated.barcode !== undefined && { barcode: u.updated.barcode }),\r\n          ...(u.updated.costPrice !== undefined && { costPrice: u.updated.costPrice }),\r\n          ...(u.updated.sellingPrice !== undefined && { sellingPrice: u.updated.sellingPrice }),\r\n          ...(u.updated.quantity !== undefined && { stock: u.updated.quantity }),\r\n          ...(u.updated.minimumStock !== undefined && { minStock: u.updated.minimumStock }),\r\n        }\r\n      })\r\n    );\r\n\r\n    await db.$transaction(updatePromises);\r\n    return true;\r\n  } catch (error) {\r\n    console.error('Error performing bulk update:', error);\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA8LsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,4DAAA"}},
    {"offset": {"line": 3236, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/hooks/useProducts.ts"],"sourcesContent":["import { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { Product, ProductFormData, mapDbProductToProduct, mapProductToDbProduct, ProductFilters } from '@/types';\r\nimport { useBusinessSettings } from './useBusinessSettings';\r\nimport { useStockHistory } from './useStockHistory';\r\nimport { useProductFilters } from './useProductFilters';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\r\nimport { clearInventoryCaches } from '@/utils/inventoryCacheUtils';\r\n\r\n// Import our new Server Actions\r\nimport { getProductsAction, createProductAction, updateProductAction, deleteProductAction, updateProductsBulkAction } from '@/app/actions/products';\r\n\r\nexport const useProducts = (userId: string | undefined, initialPageSize: number = 50) => {\r\n  const [products, setProducts] = useState<Product[]>([]);\r\n  const [page, setPage] = useState(1);\r\n  const [pageSize, setPageSize] = useState(initialPageSize);\r\n  const [totalCount, setTotalCount] = useState(0);\r\n  const [isTyping, setIsTyping] = useState(false);\r\n  const { settings } = useBusinessSettings();\r\n  const { createStockHistoryEntry } = useStockHistory(userId);\r\n  const { currentBusiness } = useBusiness();\r\n  const queryClient = useQueryClient();\r\n\r\n  const { filters, setFilters, filteredProducts } = useProductFilters(products);\r\n  const [typingTimer, setTypingTimer] = useState<NodeJS.Timeout | null>(null);\r\n\r\n  const setFiltersWithTypingState = useCallback((newFilters: ProductFilters) => {\r\n    if (newFilters.search !== filters.search) {\r\n      setIsTyping(true);\r\n      if (typingTimer) clearTimeout(typingTimer);\r\n      const timer = setTimeout(() => {\r\n        setIsTyping(false);\r\n      }, 600);\r\n      setTypingTimer(timer);\r\n    }\r\n    setFilters(newFilters);\r\n  }, [filters.search, typingTimer, setFilters]);\r\n\r\n  // Use Server Action instead of Supabase\r\n  const loadProducts = useCallback(async (): Promise<{ products: Product[], count: number }> => {\r\n    if (!userId || !currentBusiness) {\r\n      return { products: [], count: 0 };\r\n    }\r\n\r\n    try {\r\n      // Server Action call\r\n      const result = await getProductsAction({\r\n        userId,\r\n        businessId: currentBusiness.id,\r\n        page,\r\n        pageSize,\r\n        search: filters.search,\r\n        category: filters.category,\r\n        stockStatus: filters.stockStatus,\r\n      });\r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error loading products from server action:', error);\r\n      return { products: [], count: 0 };\r\n    }\r\n  }, [userId, currentBusiness?.id, page, pageSize, filters.search, filters.category, filters.stockStatus]);\r\n\r\n  const baseQueryKey = useMemo(() => ['products', userId, currentBusiness?.id], [userId, currentBusiness?.id]);\r\n  const queryKey = useMemo(() => [...baseQueryKey, page, pageSize, filters.search, filters.category, filters.stockStatus], [baseQueryKey, page, pageSize, filters.search, filters.category, filters.stockStatus]);\r\n\r\n  const { data: queriedData, isLoading: isQueryLoading, isFetching, refetch } = useQuery({\r\n    queryKey,\r\n    queryFn: loadProducts,\r\n    enabled: !!userId && !!currentBusiness?.id,\r\n    staleTime: 30_000,\r\n    gcTime: 30 * 60_000,\r\n    refetchOnWindowFocus: true,\r\n    refetchOnReconnect: true,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (queriedData) {\r\n      setProducts(queriedData.products);\r\n      setTotalCount(queriedData.count);\r\n    }\r\n  }, [queriedData]);\r\n\r\n  const isLoading = (isQueryLoading && !queriedData) && !isTyping;\r\n\r\n  // Supabase Storage remains untouched since Prisma doesn't do file storage\r\n  const uploadProductImage = async (imageFile: File): Promise<string | null> => {\r\n    try {\r\n      if (!userId) return null;\r\n      const fileExt = imageFile.name.split('.').pop();\r\n      const fileName = `${Date.now()}.${fileExt}`;\r\n      const filePath = `${userId}/${fileName}`;\r\n\r\n      const { error: uploadError } = await supabase.storage\r\n        .from('product-images')\r\n        .upload(filePath, imageFile, { upsert: true });\r\n\r\n      if (uploadError) {\r\n        console.error('Error uploading image:', uploadError);\r\n        return null;\r\n      }\r\n\r\n      const { data: { publicUrl } } = supabase.storage\r\n        .from('product-images')\r\n        .getPublicUrl(filePath);\r\n\r\n      return publicUrl;\r\n    } catch (error) {\r\n      console.error('Error in uploadProductImage:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const createProduct = async (productData: ProductFormData): Promise<Product | null> => {\r\n    try {\r\n      if (!userId || !currentBusiness) return null;\r\n\r\n      // Assuming createProductAction exists and is fully implemented:\r\n      const newProduct = await createProductAction({\r\n        ...productData,\r\n        userId,\r\n        businessId: currentBusiness.id\r\n      });\r\n\r\n      if (!newProduct) return null;\r\n\r\n      if (newProduct.quantity > 0) {\r\n        await createStockHistoryEntry(\r\n          newProduct.id,\r\n          0,\r\n          newProduct.quantity,\r\n          'Initial stock',\r\n          undefined,\r\n          productData.createdAt,\r\n          undefined,\r\n          newProduct.name\r\n        );\r\n      }\r\n\r\n      setProducts(prev => [newProduct, ...prev]);\r\n      setTotalCount(c => c + 1);\r\n\r\n      queryClient.setQueryData(queryKey, (oldData: any) => {\r\n        if (!oldData) return { products: [newProduct], count: 1 };\r\n        return {\r\n          products: [newProduct, ...oldData.products],\r\n          count: (oldData.count || 0) + 1\r\n        };\r\n      });\r\n\r\n      clearInventoryCaches(queryClient);\r\n\r\n      return newProduct;\r\n    } catch (error) {\r\n      console.error('Error creating product:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const updateProduct = async (\r\n    id: string,\r\n    updates: Partial<Product>,\r\n    imageFile?: File | null,\r\n    isFromSale = false,\r\n    customChangeReason?: string,\r\n    adjustmentDate?: Date,\r\n    referenceId?: string,\r\n    receiptNumber?: string\r\n  ): Promise<boolean> => {\r\n    try {\r\n      if (!userId) return false;\r\n\r\n      let currentProduct = products.find(p => p.id === id);\r\n      if (!currentProduct) return false;\r\n\r\n      let imageUrl = updates.imageUrl;\r\n      if (imageFile) {\r\n        imageUrl = await uploadProductImage(imageFile);\r\n      }\r\n\r\n      const updatedData = { ...updates, imageUrl, barcode: updates.barcode !== undefined ? updates.barcode : currentProduct.barcode };\r\n\r\n      // We will create the update updateProductAction next\r\n      await updateProductAction(id, { ...updatedData, userId, businessId: currentBusiness?.id });\r\n\r\n      setProducts(prev => prev.map(p => p.id === id ? { ...p, ...updatedData } : p));\r\n      queryClient.setQueryData(queryKey, (oldData: any) => {\r\n        if (!oldData) return oldData;\r\n        return {\r\n          ...oldData,\r\n          products: oldData.products.map((p: Product) =>\r\n            p.id === id ? { ...p, ...updatedData } : p\r\n          )\r\n        };\r\n      });\r\n\r\n      if (updates.quantity !== undefined && updates.quantity !== currentProduct.quantity && customChangeReason !== 'skip-history') {\r\n        let changeReason = customChangeReason || (isFromSale ? 'Sale' : (updates.quantity > currentProduct.quantity ? 'Manual stock addition' : 'Manual stock reduction'));\r\n        await createStockHistoryEntry(\r\n          id,\r\n          currentProduct.quantity,\r\n          updates.quantity,\r\n          changeReason,\r\n          referenceId,\r\n          adjustmentDate,\r\n          receiptNumber,\r\n          currentProduct.name\r\n        );\r\n      }\r\n\r\n      queryClient.invalidateQueries({ queryKey: baseQueryKey });\r\n      clearInventoryCaches(queryClient);\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating product:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const deleteProduct = async (id: string): Promise<boolean> => {\r\n    try {\r\n      if (!userId) return false;\r\n\r\n      await deleteProductAction(id);\r\n\r\n      setProducts(prev => prev.filter(p => p.id !== id));\r\n      queryClient.setQueryData(queryKey, (old: any) => {\r\n        if (!old) return old;\r\n        const { products: oldProducts, count } = old;\r\n        const newProducts = (oldProducts as Product[]).filter(p => p.id !== id);\r\n        return { products: newProducts, count: Math.max(0, (count || 0) - 1) };\r\n      });\r\n\r\n      queryClient.invalidateQueries({ queryKey: baseQueryKey });\r\n      clearInventoryCaches(queryClient);\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting product:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    // In Prisma, we either use WebSockets, polling, or React Query's built-in focus/refetch handlers\r\n    // Disabled Supabase Realtime Channels since we moved off the raw Supabase client for data fetches\r\n  }, [userId, currentBusiness?.id, baseQueryKey]);\r\n\r\n  const updateProductsBulk = async (\r\n    updates: Array<{ id: string; updated: Partial<Product>; imageFile?: File | null }>,\r\n    userIdForHistory?: string,\r\n    changeReason?: string,\r\n    referenceId?: string,\r\n    adjustmentDate?: Date,\r\n    receiptNumber?: string\r\n  ): Promise<boolean> => {\r\n    try {\r\n      if (!userId || !currentBusiness) return false;\r\n\r\n      // Basic implementation without handling independent image uploads for bulk right now\r\n      const success = await updateProductsBulkAction(\r\n        updates.map(u => ({ id: u.id, updated: u.updated })),\r\n        currentBusiness.id\r\n      );\r\n\r\n      if (success) {\r\n        // Optimistically update UI\r\n        setProducts(prev => {\r\n          const updatedMap = new Map(updates.map(u => [u.id, u.updated]));\r\n          return prev.map(p => {\r\n            const updatedItem = updatedMap.get(p.id);\r\n            return updatedItem ? { ...p, ...updatedItem } as Product : p;\r\n          });\r\n        });\r\n\r\n        // Add history for quantity changes\r\n        for (const update of updates) {\r\n          const currentProduct = products.find(p => p.id === update.id);\r\n          if (currentProduct && update.updated.quantity !== undefined && update.updated.quantity !== currentProduct.quantity) {\r\n            await createStockHistoryEntry(\r\n              update.id,\r\n              currentProduct.quantity,\r\n              update.updated.quantity,\r\n              changeReason || 'Bulk update',\r\n              referenceId,\r\n              adjustmentDate,\r\n              receiptNumber,\r\n              currentProduct.name\r\n            );\r\n          }\r\n        }\r\n\r\n        queryClient.invalidateQueries({ queryKey: baseQueryKey });\r\n        clearInventoryCaches(queryClient);\r\n      }\r\n\r\n      return success;\r\n    } catch (error) {\r\n      console.error('Error in bulk update:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  return {\r\n    products,\r\n    isLoading,\r\n    loadProducts,\r\n    page,\r\n    setPage,\r\n    pageSize,\r\n    setPageSize,\r\n    totalCount,\r\n    createProduct,\r\n    updateProduct,\r\n    updateProductsBulk,\r\n    deleteProduct,\r\n    uploadProductImage,\r\n    refetch,\r\n    isFetching,\r\n    filters,\r\n    setFilters: setFiltersWithTypingState,\r\n    filteredProducts\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3604, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/types/index.ts"],"sourcesContent":["// Sale item type definition\r\nexport interface SaleItem {\r\n  description: string;\r\n  quantity: number;\r\n  price: number;\r\n  cost: number;\r\n  productId?: string;\r\n  discountPercentage?: number;\r\n  discountType?: 'percentage' | 'amount';\r\n  discountAmount?: number;\r\n}\r\n\r\nexport interface SalesCategory {\r\n  id: string;\r\n  user_id: string;\r\n  location_id?: string;\r\n  name: string;\r\n  is_default: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface Sale {\r\n  id: string;\r\n  receiptNumber: string;\r\n  customerName: string;\r\n  customerAddress?: string;\r\n  customerContact?: string;\r\n  customerId?: string;\r\n  items: SaleItem[];\r\n  paymentStatus: 'Paid' | 'NOT PAID' | 'Quote' | 'Installment Sale';\r\n  profit: number;\r\n  date: Date;\r\n  taxRate?: number;\r\n  cashTransactionId?: string;\r\n  amountPaid?: number;\r\n  amountDue?: number;\r\n  notes?: string;\r\n  categoryId?: string;\r\n  installments?: Array<{\r\n    date?: string | Date;\r\n    amountPaid?: number;\r\n  }>;\r\n  createdAt: Date;\r\n}\r\n\r\n// Supabase database schema and Json type\r\nexport type Json =\r\n  | string\r\n  | number\r\n  | boolean\r\n  | null\r\n  | { [key: string]: Json | undefined }\r\n  | Json[];\r\n\r\n// Supabase database sale structure\r\nexport interface DbSale {\r\n  id: string;\r\n  user_id: string;\r\n  location_id: string;\r\n  receipt_number: string;\r\n  customer_name: string;\r\n  customer_address?: string | null;\r\n  customer_contact?: string | null;\r\n  customer_id?: string | null;\r\n  items: Json;\r\n  payment_status: string;\r\n  profit: number;\r\n  date: string;\r\n  tax_rate?: number | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  cash_transaction_id?: string | null;\r\n  amount_paid?: number | null;\r\n  amount_due?: number | null;\r\n  notes?: string | null;\r\n  category_id?: string | null;\r\n}\r\n\r\n// Expense interface - add cashTransactionId field\r\nexport interface Expense {\r\n  id: string;\r\n  amount: number;\r\n  description: string;\r\n  category: string | null;\r\n  date: Date;\r\n  paymentMethod: string | null;\r\n  personInCharge: string | null;\r\n  receiptImage: string | null;\r\n  cashAccountId: string | null;\r\n  cashTransactionId: string | null; // Add this field\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\n// Supabase database expense structure\r\nexport interface DbExpense {\r\n  id: string;\r\n  user_id: string;\r\n  amount: number;\r\n  description: string;\r\n  category: string | null;\r\n  date: string;\r\n  payment_method: string | null;\r\n  person_in_charge: string | null;\r\n  receipt_image: string | null;\r\n  cash_account_id: string | null;\r\n  cash_transaction_id: string | null; // Add this field\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface SaleFormData {\r\n  customerName: string;\r\n  customerAddress: string;\r\n  customerContact: string;\r\n  customerId?: string; // Added customerId field\r\n  items: SaleItem[];\r\n  paymentStatus: \"Paid\" | \"NOT PAID\" | \"Quote\" | \"Installment Sale\";\r\n  receiptNumber?: string;\r\n  taxRate?: number | null;\r\n  amountPaid?: number;\r\n  amountDue?: number;\r\n  notes?: string;\r\n  categoryId?: string;\r\n}\r\n\r\n// Analytics data type\r\nexport interface AnalyticsData {\r\n  totalSales: number;\r\n  totalProfit: number;\r\n  totalCost: number;\r\n  paidSalesCount: number;\r\n  pendingSalesCount: number;\r\n}\r\n\r\n// Form validation errors\r\nexport interface FormErrors {\r\n  customerName?: string;\r\n  customerAddress?: string;\r\n  customerContact?: string;\r\n  itemDescription?: string;\r\n  quantity?: string;\r\n  salePrice?: string;\r\n  costOfProduction?: string;\r\n  taxRate?: string;\r\n}\r\n\r\n// BusinessSettings interface to include paymentInfo\r\nexport interface BusinessSettings {\r\n  businessName: string;\r\n  businessAddress: string;\r\n  businessPhone: string;\r\n  businessEmail: string;\r\n  businessLogo?: string;\r\n  currency: string;\r\n  signature?: string;\r\n  paymentInfo?: string; // Added payment information field\r\n  defaultPrintFormat?: 'standard' | 'thermal'; // Added default print format\r\n  defaultPrinterName?: string; // Added default printer name\r\n  defaultPrinterType?: 'USB' | 'Bluetooth'; // Added default printer type\r\n}\r\n\r\n// Database business settings structure\r\nexport interface DbBusinessSettings {\r\n  id?: string;\r\n  user_id: string; // Make sure this is required, not optional\r\n  business_name: string;\r\n  business_address: string;\r\n  business_phone: string;\r\n  business_email: string;\r\n  business_logo?: string;\r\n  currency: string;\r\n  signature?: string;\r\n  metadata?: Json | null; // Add metadata field\r\n  created_at?: string;\r\n  updated_at?: string;\r\n}\r\n\r\n// Updated UserProfile interface to match the Supabase database structure\r\nexport interface UserProfile {\r\n  id: string;\r\n  full_name: string | null;\r\n  display_name: string | null;\r\n  avatar_url: string | null;\r\n  created_at: string | null;\r\n  updated_at: string | null;\r\n}\r\n\r\n// New interfaces for Product management - ADDED itemNumber\r\nexport interface Product {\r\n  id: string;\r\n  itemNumber: string; // Added item number field\r\n  barcode: string | null; // Added barcode field\r\n  manufacturerBarcode: string | null; // Added manufacturer barcode field\r\n  name: string;\r\n  description: string | null;\r\n  category: string;\r\n  quantity: number;\r\n  costPrice: number;\r\n  sellingPrice: number;\r\n  supplier: string | null;\r\n  imageUrl: string | null;\r\n  minimumStock: number;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface DbProduct {\r\n  id: string;\r\n  user_id: string;\r\n  item_number: string; // Added item number field\r\n  barcode: string | null; // Added barcode field\r\n  manufacturer_barcode: string | null; // Added manufacturer barcode field\r\n  name: string;\r\n  description: string | null;\r\n  category: string;\r\n  quantity: number;\r\n  cost_price: number;\r\n  selling_price: number;\r\n  supplier: string | null;\r\n  image_url: string | null;\r\n  minimum_stock: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface ProductFormData {\r\n  name: string;\r\n  barcode?: string; // Added barcode field\r\n  manufacturerBarcode?: string; // Added manufacturer barcode field\r\n  description?: string;\r\n  category?: string;\r\n  quantity: number; // Always a number, never undefined\r\n  costPrice?: number;\r\n  sellingPrice?: number;\r\n  supplier?: string;\r\n  minimumStock?: number;\r\n  imageFile?: File | null;\r\n  imageUrl?: string | null;\r\n  createdAt?: Date; // Added created date field\r\n}\r\n\r\nexport interface ProductCategory {\r\n  id: string;\r\n  name: string;\r\n}\r\n\r\nexport interface DbProductCategory {\r\n  id: string;\r\n  user_id: string;\r\n  name: string;\r\n  created_at: string;\r\n}\r\n\r\nexport interface StockHistoryEntry {\r\n  id: string;\r\n  productId: string;\r\n  oldQuantity: number;\r\n  newQuantity: number;\r\n  changeReason: string;\r\n  referenceId?: string | null;\r\n  receiptNumber?: string;\r\n  createdAt: Date;\r\n  product?: {\r\n    name: string;\r\n    costPrice: number;\r\n    sellingPrice: number;\r\n    itemNumber: string;\r\n  };\r\n}\r\n\r\nexport interface DbStockHistoryEntry {\r\n  id: string;\r\n  user_id: string;\r\n  product_id: string;\r\n  previous_quantity: number;\r\n  new_quantity: number;\r\n  change_reason: string;\r\n  reference_id?: string | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface ProductFilters {\r\n  search: string;\r\n  category: string;\r\n  stockStatus: 'all' | 'inStock' | 'lowStock' | 'outOfStock';\r\n}\r\n\r\n// Customer management types\r\nexport interface Customer {\r\n  id: string;\r\n  fullName: string;\r\n  email: string | null;\r\n  phoneNumber: string | null;\r\n  birthday: Date | null;\r\n  location: string | null;\r\n  categoryId: string | null; // Added category relationship\r\n  socialMedia: {\r\n    facebook?: string;\r\n    instagram?: string;\r\n    twitter?: string;\r\n    linkedin?: string;\r\n    other?: string;\r\n  } | null;\r\n  gender: string | null;\r\n  tags: string[] | null;\r\n  notes: string | null;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface DbCustomer {\r\n  id: string;\r\n  user_id: string;\r\n  full_name: string;\r\n  email: string | null;\r\n  phone_number: string | null;\r\n  birthday: string | null;\r\n  location: string | null;\r\n  category_id: string | null; // Added category relationship\r\n  social_media: Json | null;\r\n  gender: string | null;\r\n  tags: string[] | null;\r\n  notes: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface CustomerFormData {\r\n  fullName: string;\r\n  email: string;\r\n  phoneNumber: string;\r\n  birthday: Date | null;\r\n  location: string;\r\n  categoryId: string | null; // Added category field\r\n  socialMedia: {\r\n    facebook?: string;\r\n    instagram?: string;\r\n    twitter?: string;\r\n    linkedin?: string;\r\n    other?: string;\r\n  };\r\n  gender: string;\r\n  tags: string[];\r\n  notes: string;\r\n}\r\n\r\n// Utility functions for database conversions\r\nexport const mapDbSaleToSale = (dbSale: DbSale): Sale => {\r\n  // Parse items and ensure numeric fields are numbers, not strings\r\n  // This is critical for discount calculations to work correctly\r\n  const items = (Array.isArray(dbSale.items) ? dbSale.items : []).map((item: any) => {\r\n    const discountPercentage = item.discountPercentage !== undefined ? Number(item.discountPercentage) : undefined;\r\n    const discountAmount = item.discountAmount !== undefined ? Number(item.discountAmount) : undefined;\r\n\r\n    // Infer discountType if missing (for legacy data)\r\n    let discountType = item.discountType as 'percentage' | 'amount' | undefined;\r\n    if (!discountType) {\r\n      if (discountPercentage && discountPercentage > 0) {\r\n        discountType = 'percentage';\r\n      } else if (discountAmount && discountAmount > 0) {\r\n        discountType = 'amount';\r\n      }\r\n    }\r\n\r\n    return {\r\n      description: item.description || '',\r\n      quantity: Number(item.quantity) || 0,\r\n      price: Number(item.price) || 0,\r\n      cost: Number(item.cost) || 0,\r\n      productId: item.productId || undefined,\r\n      discountType,\r\n      discountPercentage,\r\n      discountAmount,\r\n      createdAt: item.createdAt || undefined,\r\n    };\r\n  }) as SaleItem[];\r\n\r\n  return {\r\n    id: dbSale.id,\r\n    receiptNumber: dbSale.receipt_number,\r\n    customerName: dbSale.customer_name,\r\n    customerAddress: dbSale.customer_address || '',\r\n    customerContact: dbSale.customer_contact || '',\r\n    customerId: dbSale.customer_id || undefined,\r\n    items,\r\n    paymentStatus: dbSale.payment_status as 'Paid' | 'NOT PAID' | 'Quote' | 'Installment Sale',\r\n    profit: Number(dbSale.profit),\r\n    date: new Date(dbSale.date),\r\n    taxRate: dbSale.tax_rate ? Number(dbSale.tax_rate) : 0,\r\n    cashTransactionId: dbSale.cash_transaction_id || undefined,\r\n    amountPaid: dbSale.amount_paid ? Number(dbSale.amount_paid) : undefined,\r\n    amountDue: dbSale.amount_due ? Number(dbSale.amount_due) : undefined,\r\n    notes: dbSale.notes || '',\r\n    categoryId: dbSale.category_id || undefined,\r\n    createdAt: new Date(dbSale.created_at),\r\n  };\r\n};\r\n\r\nexport const mapSaleToDbSale = (\r\n  saleData: SaleFormData,\r\n  selectedDate: Date,\r\n  profit: number,\r\n  receiptNumber: string,\r\n  userId: string,\r\n  locationId: string,\r\n  cashTransactionId?: string | null\r\n): Omit<DbSale, 'id' | 'created_at' | 'updated_at'> => {\r\n  return {\r\n    user_id: userId,\r\n    location_id: locationId,\r\n    receipt_number: receiptNumber,\r\n    customer_name: saleData.customerName,\r\n    customer_address: saleData.customerAddress || null,\r\n    customer_contact: saleData.customerContact || null,\r\n    customer_id: saleData.customerId || null, // Include customer_id\r\n    items: (saleData.items as unknown) as Json,\r\n    payment_status: saleData.paymentStatus,\r\n    profit: profit,\r\n    date: selectedDate.toISOString().split('T')[0],\r\n    tax_rate: saleData.taxRate || 0,\r\n    cash_transaction_id: cashTransactionId || null,\r\n    amount_paid: saleData.amountPaid || null,\r\n    amount_due: saleData.amountDue || null,\r\n    notes: saleData.notes || null,\r\n    category_id: saleData.categoryId || null,\r\n  };\r\n};\r\n\r\n// Conversion functions for business settings\r\nexport const mapDbBusinessSettingsToBusinessSettings = (dbSettings: DbBusinessSettings): BusinessSettings => {\r\n  return {\r\n    businessName: dbSettings.business_name,\r\n    businessAddress: dbSettings.business_address,\r\n    businessPhone: dbSettings.business_phone,\r\n    businessEmail: dbSettings.business_email,\r\n    businessLogo: dbSettings.business_logo,\r\n    currency: dbSettings.currency,\r\n    signature: dbSettings.signature,\r\n    paymentInfo: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).payment_info as string || '' : '',\r\n    defaultPrintFormat: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).default_print_format as 'standard' | 'thermal' || 'standard' : 'standard',\r\n    defaultPrinterName: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).default_printer_name as string || '' : '',\r\n    defaultPrinterType: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).default_printer_type as 'USB' | 'Bluetooth' || 'USB' : 'USB'\r\n  };\r\n};\r\n\r\nexport const mapBusinessSettingsToDbBusinessSettings = (\r\n  settings: BusinessSettings,\r\n  userId: string\r\n): DbBusinessSettings => {\r\n  // Create metadata object with payment_info\r\n  const metadata: Json = {\r\n    payment_info: settings.paymentInfo || '',\r\n    default_print_format: settings.defaultPrintFormat || 'standard',\r\n    default_printer_name: settings.defaultPrinterName || '',\r\n    default_printer_type: settings.defaultPrinterType || 'USB'\r\n  };\r\n\r\n  return {\r\n    user_id: userId,\r\n    business_name: settings.businessName,\r\n    business_address: settings.businessAddress,\r\n    business_phone: settings.businessPhone,\r\n    business_email: settings.businessEmail,\r\n    business_logo: settings.businessLogo,\r\n    currency: settings.currency,\r\n    signature: settings.signature,\r\n    metadata: metadata, // Include metadata in the return object\r\n    updated_at: new Date().toISOString()\r\n  };\r\n};\r\n\r\n// Conversion functions for products and categories - ADDED itemNumber\r\nexport const mapDbProductToProduct = (dbProduct: DbProduct): Product => {\r\n  return {\r\n    id: dbProduct.id,\r\n    itemNumber: dbProduct.item_number, // Added item number mapping\r\n    barcode: dbProduct.barcode, // Added barcode mapping\r\n    manufacturerBarcode: dbProduct.manufacturer_barcode, // Added manufacturer barcode mapping\r\n    name: dbProduct.name,\r\n    description: dbProduct.description,\r\n    category: dbProduct.category,\r\n    quantity: dbProduct.quantity,\r\n    costPrice: Number(dbProduct.cost_price),\r\n    sellingPrice: Number(dbProduct.selling_price),\r\n    supplier: dbProduct.supplier,\r\n    imageUrl: dbProduct.image_url,\r\n    minimumStock: dbProduct.minimum_stock,\r\n    createdAt: new Date(dbProduct.created_at),\r\n    updatedAt: new Date(dbProduct.updated_at)\r\n  };\r\n};\r\n\r\nexport const mapProductToDbProduct = (product: Partial<Product>, userId: string): Partial<DbProduct> => {\r\n  const result: Partial<DbProduct> = {\r\n    user_id: userId\r\n  };\r\n\r\n  if (product.id) result.id = product.id;\r\n  if (product.itemNumber) result.item_number = product.itemNumber; // Added item number mapping\r\n  if (product.barcode !== undefined) result.barcode = product.barcode; // Added barcode mapping\r\n  if (product.manufacturerBarcode !== undefined) result.manufacturer_barcode = product.manufacturerBarcode; // Added manufacturer barcode mapping\r\n  if (product.name) result.name = product.name;\r\n  result.description = product.description;\r\n  if (product.category) result.category = product.category;\r\n  if (product.quantity !== undefined) result.quantity = product.quantity;\r\n  if (product.costPrice !== undefined) {\r\n    result.cost_price = product.costPrice;\r\n    console.log(`DEBUG: Mapping costPrice ${product.costPrice} to cost_price`);\r\n  }\r\n  if (product.sellingPrice !== undefined) {\r\n    result.selling_price = product.sellingPrice;\r\n    console.log(`DEBUG: Mapping sellingPrice ${product.sellingPrice} to selling_price`);\r\n  }\r\n  result.supplier = product.supplier;\r\n  result.image_url = product.imageUrl;\r\n  if (product.minimumStock !== undefined) result.minimum_stock = product.minimumStock;\r\n\r\n  return result;\r\n};\r\n\r\nexport const mapDbProductCategoryToProductCategory = (dbCategory: DbProductCategory): ProductCategory => {\r\n  return {\r\n    id: dbCategory.id,\r\n    name: dbCategory.name\r\n  };\r\n};\r\n\r\nexport const mapDbStockHistoryToStockHistory = (dbHistory: DbStockHistoryEntry): StockHistoryEntry => {\r\n  return {\r\n    id: dbHistory.id,\r\n    productId: dbHistory.product_id,\r\n    oldQuantity: dbHistory.previous_quantity,\r\n    newQuantity: dbHistory.new_quantity,\r\n    changeReason: dbHistory.change_reason,\r\n    referenceId: dbHistory.reference_id || null,\r\n    createdAt: new Date(dbHistory.created_at)\r\n  };\r\n};\r\n\r\n// Updated Customer mapping functions to include categoryId\r\nexport const mapDbCustomerToCustomer = (dbCustomer: DbCustomer): Customer => {\r\n  let birthday = null;\r\n\r\n  if (dbCustomer.birthday) {\r\n    try {\r\n      const birthdayStr = String(dbCustomer.birthday);\r\n      const [year, month, day] = birthdayStr.split('-').map(Number);\r\n\r\n      if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {\r\n        birthday = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));\r\n\r\n        console.log(\r\n          'Converting DB birthday to Date object:',\r\n          dbCustomer.birthday,\r\n          '',\r\n          birthday,\r\n          '(UTC string:',\r\n          birthday.toISOString(),\r\n          ')'\r\n        );\r\n      } else {\r\n        console.error('Invalid date components in birthday:', dbCustomer.birthday);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error parsing birthday:', error, dbCustomer.birthday);\r\n    }\r\n  }\r\n\r\n  return {\r\n    id: dbCustomer.id,\r\n    fullName: dbCustomer.full_name,\r\n    email: dbCustomer.email,\r\n    phoneNumber: dbCustomer.phone_number,\r\n    birthday: birthday,\r\n    location: dbCustomer.location,\r\n    categoryId: dbCustomer.category_id, // Added category mapping\r\n    socialMedia: dbCustomer.social_media as any,\r\n    gender: dbCustomer.gender,\r\n    tags: dbCustomer.tags,\r\n    notes: dbCustomer.notes,\r\n    createdAt: new Date(dbCustomer.created_at),\r\n    updatedAt: new Date(dbCustomer.updated_at)\r\n  };\r\n};\r\n\r\nexport const mapCustomerToDbCustomer = (customer: Partial<Customer>, userId: string): Partial<DbCustomer> => {\r\n  const result: Partial<DbCustomer> = {\r\n    user_id: userId\r\n  };\r\n\r\n  if (customer.id) result.id = customer.id;\r\n  if (customer.fullName) result.full_name = customer.fullName;\r\n  result.email = customer.email;\r\n  result.phone_number = customer.phoneNumber;\r\n  if (customer.birthday) result.birthday = customer.birthday.toISOString().split('T')[0];\r\n  result.location = customer.location;\r\n  result.category_id = customer.categoryId; // Added category mapping\r\n  result.social_media = customer.socialMedia as Json;\r\n  result.gender = customer.gender;\r\n  result.tags = customer.tags;\r\n  result.notes = customer.notes;\r\n\r\n  return result;\r\n};\r\n\r\n// Conversion functions for expenses\r\nexport const mapDbExpenseToExpense = (dbExpense: DbExpense): Expense => {\r\n  return {\r\n    id: dbExpense.id,\r\n    amount: Number(dbExpense.amount),\r\n    description: dbExpense.description,\r\n    category: dbExpense.category,\r\n    date: new Date(dbExpense.date),\r\n    paymentMethod: dbExpense.payment_method,\r\n    personInCharge: dbExpense.person_in_charge,\r\n    receiptImage: dbExpense.receipt_image,\r\n    cashAccountId: dbExpense.cash_account_id,\r\n    cashTransactionId: dbExpense.cash_transaction_id,\r\n    createdAt: new Date(dbExpense.created_at),\r\n    updatedAt: new Date(dbExpense.updated_at)\r\n  };\r\n};\r\n\r\nexport const mapExpenseToDbExpense = (expense: Partial<Expense>, userId: string): Partial<DbExpense> => {\r\n  const result: Partial<DbExpense> = {\r\n    user_id: userId\r\n  };\r\n\r\n  if (expense.id) result.id = expense.id;\r\n  if (expense.amount !== undefined) result.amount = expense.amount;\r\n  if (expense.description) result.description = expense.description;\r\n  result.category = expense.category;\r\n  if (expense.date) result.date = expense.date.toISOString().split('T')[0];\r\n  result.payment_method = expense.paymentMethod;\r\n  result.person_in_charge = expense.personInCharge;\r\n  result.receipt_image = expense.receiptImage;\r\n  result.cash_account_id = expense.cashAccountId;\r\n  result.cash_transaction_id = expense.cashTransactionId;\r\n\r\n  return result;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3884, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/hooks/useCategories.ts"],"sourcesContent":["\r\nimport { useState, useEffect } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { ProductCategory, DbProductCategory, mapDbProductCategoryToProductCategory } from '@/types';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\n\r\nexport const useCategories = (userId: string | undefined) => {\r\n  const [categories, setCategories] = useState<ProductCategory[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const { toast } = useToast();\r\n  const { currentBusiness } = useBusiness();\r\n\r\n  const loadCategories = async () => {\r\n    try {\r\n      if (!userId || !currentBusiness) return;\r\n      \r\n      setIsLoading(true);\r\n      const { data, error } = await supabase\r\n        .from('product_categories')\r\n        .select('*')\r\n        .eq('location_id', currentBusiness.id)\r\n        .order('name');\r\n\r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      const formattedCategories: ProductCategory[] = data ? \r\n        data.map((item: DbProductCategory) => mapDbProductCategoryToProductCategory(item)) : [];\r\n      \r\n      setCategories(formattedCategories);\r\n    } catch (error) {\r\n      console.error('Error loading categories:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to load product categories. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadCategories();\r\n  }, [userId, currentBusiness?.id]);\r\n\r\n  const createCategory = async (name: string) => {\r\n    try {\r\n      if (!userId || !currentBusiness) return null;\r\n\r\n      // Check if category already exists\r\n      const existingCategory = categories.find(\r\n        cat => cat.name.toLowerCase() === name.toLowerCase()\r\n      );\r\n      \r\n      if (existingCategory) {\r\n        toast({\r\n          title: \"Category exists\",\r\n          description: \"This category already exists.\",\r\n          variant: \"default\"\r\n        });\r\n        return existingCategory;\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('product_categories')\r\n        .insert({\r\n          user_id: userId,\r\n          location_id: currentBusiness.id,\r\n          name\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      if (data) {\r\n        const newCategory = mapDbProductCategoryToProductCategory(data as DbProductCategory);\r\n        setCategories([...categories, newCategory]);\r\n        return newCategory;\r\n      }\r\n      \r\n      return null;\r\n    } catch (error) {\r\n      console.error('Error creating category:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to create category. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const updateCategory = async (id: string, name: string) => {\r\n    try {\r\n      if (!userId) return false;\r\n\r\n      // Check if category already exists\r\n      const existingCategory = categories.find(\r\n        cat => cat.name.toLowerCase() === name.toLowerCase() && cat.id !== id\r\n      );\r\n      \r\n      if (existingCategory) {\r\n        toast({\r\n          title: \"Category exists\",\r\n          description: \"Another category with this name already exists.\",\r\n          variant: \"default\"\r\n        });\r\n        return false;\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('product_categories')\r\n        .update({ name })\r\n        .eq('id', id)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) throw error;\r\n\r\n      if (data) {\r\n        const updatedCategory = mapDbProductCategoryToProductCategory(data as DbProductCategory);\r\n        setCategories(categories.map(c => c.id === id ? updatedCategory : c));\r\n        return true;\r\n      }\r\n      \r\n      return false;\r\n    } catch (error) {\r\n      console.error('Error updating category:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to update category. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const deleteCategory = async (id: string) => {\r\n    try {\r\n      if (!userId) return false;\r\n\r\n      // First check if there are any products using this category\r\n      const { data: products, error: productsError } = await supabase\r\n        .from('products')\r\n        .select('id')\r\n        .eq('category', categories.find(c => c.id === id)?.name || '');\r\n      \r\n      if (productsError) throw productsError;\r\n      \r\n      if (products && products.length > 0) {\r\n        toast({\r\n          title: \"Cannot delete category\",\r\n          description: \"This category is being used by one or more products.\",\r\n          variant: \"destructive\"\r\n        });\r\n        return false;\r\n      }\r\n\r\n      const { error } = await supabase\r\n        .from('product_categories')\r\n        .delete()\r\n        .eq('id', id);\r\n\r\n      if (error) throw error;\r\n\r\n      setCategories(categories.filter(c => c.id !== id));\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting category:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to delete category. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return false;\r\n    }\r\n  };\r\n\r\n  return { \r\n    categories, \r\n    isLoading, \r\n    loadCategories,\r\n    createCategory,\r\n    updateCategory,\r\n    deleteCategory\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4055, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/HP/Downloads/FINAL/src/pages/NewProduct.tsx"],"sourcesContent":["\r\nimport React, { useEffect, useState } from 'react';\r\nimport { useNavigate, useParams, useLocation } from 'react-router-dom';\r\nimport ProductForm from '@/components/inventory/ProductForm';\r\nimport { useAuth } from '@/components/auth/AuthProvider';\r\nimport { useProducts } from '@/hooks/useProducts';\r\nimport { useCategories } from '@/hooks/useCategories';\r\nimport { Product, ProductFormData } from '@/types';\r\nimport { toast } from 'sonner';\r\nimport { Button } from '@/components/ui/button';\r\nimport { ArrowLeft, RefreshCw } from 'lucide-react';\r\nimport { useBusinessSettings } from '@/hooks/useBusinessSettings';\r\nimport { formatNumber } from '@/lib/utils';\r\nimport { useProfiles } from '@/contexts/ProfileContext';\r\nimport { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';\r\nimport { AlertCircle } from 'lucide-react';\r\n\r\nconst NewProduct = () => {\r\n  const { id } = useParams<{ id: string }>();\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const { user } = useAuth();\r\n  const { products, isLoading: productsLoading, createProduct, updateProduct, loadProducts, refetch } = useProducts(user?.id, 10000); // Load all products\r\n  const { categories, isLoading: categoriesLoading } = useCategories(user?.id);\r\n  const [product, setProduct] = useState<Product | undefined>(undefined);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [loadError, setLoadError] = useState<string | null>(null);\r\n  const [isRefreshing, setIsRefreshing] = useState(false);\r\n  const [dataLoaded, setDataLoaded] = useState(false);\r\n  const { settings } = useBusinessSettings();\r\n  const { hasPermission, isLoading: profilesLoading } = useProfiles();\r\n\r\n  // Check for duplicate data from navigation state\r\n  const duplicateData = location.state?.duplicateData;\r\n\r\n  const loadProductData = async () => {\r\n    if (id) {\r\n      // If refreshing, set state \r\n      setIsRefreshing(true);\r\n\r\n      // Clear any previous error\r\n      setLoadError(null);\r\n\r\n      // Load fresh product data\r\n      const { data: refetchedData } = await refetch();\r\n      const fetchedProducts = refetchedData?.products || [];\r\n\r\n      const foundProduct = fetchedProducts.find(p => p.id === id);\r\n\r\n      if (foundProduct) {\r\n        setProduct(foundProduct);\r\n        setDataLoaded(true);\r\n      } else {\r\n        setLoadError('Product not found. It may have been deleted or you may not have permission to view it.');\r\n        toast.error('Product not found');\r\n      }\r\n\r\n      setIsRefreshing(false);\r\n    } else if (duplicateData) {\r\n      // For duplicate mode, set the data as loaded\r\n      setDataLoaded(true);\r\n    } else {\r\n      // For new product mode\r\n      setDataLoaded(true);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    // Only load if we have an ID, haven't loaded yet, and products are available\r\n    if (id && products.length > 0 && !dataLoaded) {\r\n      const foundProduct = products.find(p => p.id === id);\r\n\r\n      if (foundProduct) {\r\n        setProduct(foundProduct);\r\n        setDataLoaded(true);\r\n        // Clear any previous error\r\n        setLoadError(null);\r\n      } else if (products.length > 0) {\r\n        // Only set error if we have products loaded but didn't find the one we're looking for\r\n        setLoadError('Product not found. It may have been deleted or you may not have permission to view it.');\r\n        toast.error('Product not found');\r\n      }\r\n    } else if (!id) {\r\n      // New product or duplicate mode\r\n      setDataLoaded(true);\r\n    }\r\n  }, [id, products.length, dataLoaded]); // Use products.length instead of products array\r\n\r\n  const handleRefresh = async () => {\r\n    toast.info('Refreshing product data...');\r\n    setDataLoaded(false);\r\n    await loadProductData();\r\n  };\r\n\r\n  const handleProductSubmit = async (formData: ProductFormData & { createdAt?: Date, autoPrintLabel?: boolean, printQuantity?: number }) => {\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      if (id && product) {\r\n        // ... (update existing product logic - unchanged)\r\n        const updateData = {\r\n          name: formData.name,\r\n          description: formData.description || '',\r\n          category: formData.category || '',\r\n          quantity: formData.quantity,\r\n          costPrice: formData.costPrice ?? 0,\r\n          sellingPrice: formData.sellingPrice ?? 0,\r\n          supplier: formData.supplier || '',\r\n          minimumStock: formData.minimumStock ?? 0,\r\n          imageUrl: formData.imageUrl || null,\r\n          createdAt: formData.createdAt,\r\n          barcode: formData.barcode,\r\n          manufacturerBarcode: formData.manufacturerBarcode\r\n        };\r\n\r\n        const result = await updateProduct(id, updateData);\r\n\r\n        if (result) {\r\n          toast.success('Product updated successfully');\r\n          navigate(`/inventory/${id}`);\r\n        } else {\r\n          toast.error('Failed to update product');\r\n        }\r\n      } else {\r\n        // Create new product\r\n        if (!user?.id) {\r\n          toast.error('You must be logged in to create products');\r\n          return;\r\n        }\r\n\r\n        const createData = {\r\n          id: '',\r\n          name: formData.name,\r\n          description: formData.description || '',\r\n          category: formData.category || '',\r\n          quantity: formData.quantity,\r\n          costPrice: formData.costPrice ?? 0,\r\n          sellingPrice: formData.sellingPrice ?? 0,\r\n          supplier: formData.supplier || '',\r\n          minimumStock: formData.minimumStock ?? 0,\r\n          imageUrl: formData.imageUrl || null,\r\n          createdAt: formData.createdAt || new Date(),\r\n          updatedAt: new Date(),\r\n          barcode: formData.barcode || '',\r\n          manufacturerBarcode: formData.manufacturerBarcode || ''\r\n        };\r\n\r\n        const newProduct = await createProduct(createData);\r\n\r\n        if (newProduct) {\r\n          toast.success('Product created successfully');\r\n\r\n          // Auto-print label if requested\r\n          if (formData.autoPrintLabel && newProduct.barcode) {\r\n            try {\r\n              const printQty = formData.printQuantity || 1;\r\n              toast.info(`Sending ${printQty} barcode label${printQty > 1 ? 's' : ''} to printer...`);\r\n              await fetch('http://localhost:5000/print/label', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                mode: 'cors',\r\n                body: JSON.stringify({\r\n                  PrinterName: settings.defaultPrinterName || 'Label Printer',\r\n                  Content: `SIZE 50 mm, 30 mm\\nGAP 3 mm, 0 mm\\nCLS\\nTEXT 15,20,\"3\",0,1,1,\"${newProduct.name}\"\\nBARCODE 15,70,\"128\",60,1,0,2,2,\"${newProduct.barcode}\"\\nTEXT 15,180,\"3\",0,1,1,\"${settings.currency} ${formatNumber(newProduct.sellingPrice)}\"\\nPRINT ${printQty}\\n`\r\n                })\r\n              });\r\n              toast.success('Barcode label printed');\r\n            } catch (err) {\r\n              console.error('Failed to auto-print label:', err);\r\n              toast.error('Failed to print label. Is the Printer Bridge running?');\r\n            }\r\n          }\r\n\r\n          navigate(`/inventory/${newProduct.id}`);\r\n        } else {\r\n          toast.error('Failed to create product');\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error submitting product:', error);\r\n      toast.error('An error occurred while saving the product');\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const isLoading = productsLoading || categoriesLoading || isSubmitting || isRefreshing;\r\n\r\n  // Determine initial data - use duplicateData if available, otherwise use product for edit mode\r\n  const initialData = duplicateData ? {\r\n    ...duplicateData,\r\n    quantity: 0, // Always start with 0 quantity for duplicates\r\n    id: '', // No ID for new product\r\n    itemNumber: '', // Will be auto-generated\r\n    createdAt: new Date(), // Use current time for duplicate, not original product time\r\n    updatedAt: new Date(),\r\n    barcode: '', // Clear barcode to avoid unique constraint conflict\r\n    manufacturerBarcode: '' // Clear manufacturer barcode as well\r\n  } as Product : product;\r\n\r\n  // Permission Check\r\n  const canEdit = id ? hasPermission('inventory', 'edit') : true;\r\n  const canCreate = !id ? hasPermission('inventory', 'create') : true;\r\n\r\n  if (profilesLoading || productsLoading || categoriesLoading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-[400px]\">\r\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!canEdit || !canCreate) {\r\n    return (\r\n      <div className=\"max-w-4xl mx-auto p-6\">\r\n        <Alert variant=\"destructive\">\r\n          <AlertCircle className=\"h-4 w-4\" />\r\n          <AlertTitle>Access Denied</AlertTitle>\r\n          <AlertDescription>\r\n            You do not have permission to {id ? 'edit this product' : 'create a new product'}.\r\n            Please contact your administrator if you believe this is an error.\r\n          </AlertDescription>\r\n        </Alert>\r\n        <div className=\"mt-4\">\r\n          <Button onClick={() => navigate('/inventory')} variant=\"outline\">\r\n            Back to Inventory\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Don't render the form until we have loaded the data or determined we don't need to load it\r\n  if (id && !dataLoaded && !loadError) {\r\n    return (\r\n      <div className=\"space-y-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => navigate('/inventory')}\r\n            className=\"flex items-center gap-1\"\r\n          >\r\n            <ArrowLeft className=\"h-4 w-4\" /> Back to Inventory\r\n          </Button>\r\n        </div>\r\n        <div className=\"flex items-center justify-center h-64\">\r\n          <div className=\"text-center\">\r\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-4\"></div>\r\n            <p className=\"text-gray-600\">Loading product data...</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={() => navigate('/inventory')}\r\n          className=\"flex items-center gap-1\"\r\n        >\r\n          <ArrowLeft className=\"h-4 w-4\" /> Back to Inventory\r\n        </Button>\r\n\r\n        {/* Add refresh button when in edit mode */}\r\n        {id && (\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={handleRefresh}\r\n            disabled={isLoading}\r\n            className=\"flex items-center gap-1\"\r\n          >\r\n            <RefreshCw className={`h-4 w-4 ${isRefreshing ? 'animate-spin' : ''}`} />\r\n            {isRefreshing ? 'Refreshing...' : 'Refresh Data'}\r\n          </Button>\r\n        )}\r\n      </div>\r\n\r\n      {loadError ? (\r\n        <div className=\"p-6 bg-red-50 border border-red-200 rounded-md\">\r\n          <h3 className=\"text-lg font-medium text-red-800 mb-2\">Error Loading Product</h3>\r\n          <p className=\"text-red-600\">{loadError}</p>\r\n          <Button\r\n            className=\"mt-4\"\r\n            onClick={() => navigate('/inventory')}\r\n          >\r\n            Return to Inventory\r\n          </Button>\r\n        </div>\r\n      ) : (\r\n        <ProductForm\r\n          initialData={initialData}\r\n          categories={categories}\r\n          onProductSubmit={handleProductSubmit}\r\n          isLoading={isLoading}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default NewProduct;\r\n"],"names":[],"mappings":";;;;;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;AAEA,MAAM,aAAa;;IACjB,MAAM,EAAE,EAAE,EAAE,GAAG,IAAA,gLAAS;IACxB,MAAM,WAAW,IAAA,kLAAW;IAC5B,MAAM,WAAW,IAAA,kLAAW;IAC5B,MAAM,EAAE,IAAI,EAAE,GAAG,IAAA,wJAAO;IACxB,MAAM,EAAE,QAAQ,EAAE,WAAW,eAAe,EAAE,aAAa,EAAE,aAAa,EAAE,YAAY,EAAE,OAAO,EAAE,GAAG,IAAA,6IAAW,EAAC,MAAM,IAAI,QAAQ,oBAAoB;IACxJ,MAAM,EAAE,UAAU,EAAE,WAAW,iBAAiB,EAAE,GAAG,IAAA,iJAAa,EAAC,MAAM;IACzE,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAsB;IAC5D,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,yKAAQ,EAAC;IACjD,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,yKAAQ,EAAgB;IAC1D,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,yKAAQ,EAAC;IACjD,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,yKAAQ,EAAC;IAC7C,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,6JAAmB;IACxC,MAAM,EAAE,aAAa,EAAE,WAAW,eAAe,EAAE,GAAG,IAAA,oJAAW;IAEjE,iDAAiD;IACjD,MAAM,gBAAgB,SAAS,KAAK,EAAE;IAEtC,MAAM,kBAAkB;QACtB,IAAI,IAAI;YACN,4BAA4B;YAC5B,gBAAgB;YAEhB,2BAA2B;YAC3B,aAAa;YAEb,0BAA0B;YAC1B,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM;YACtC,MAAM,kBAAkB,eAAe,YAAY,EAAE;YAErD,MAAM,eAAe,gBAAgB,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;YAExD,IAAI,cAAc;gBAChB,WAAW;gBACX,cAAc;YAChB,OAAO;gBACL,aAAa;gBACb,oJAAK,CAAC,KAAK,CAAC;YACd;YAEA,gBAAgB;QAClB,OAAO,IAAI,eAAe;YACxB,6CAA6C;YAC7C,cAAc;QAChB,OAAO;YACL,uBAAuB;YACvB,cAAc;QAChB;IACF;IAEA,IAAA,0KAAS;gCAAC;YACR,6EAA6E;YAC7E,IAAI,MAAM,SAAS,MAAM,GAAG,KAAK,CAAC,YAAY;gBAC5C,MAAM,eAAe,SAAS,IAAI;yDAAC,CAAA,IAAK,EAAE,EAAE,KAAK;;gBAEjD,IAAI,cAAc;oBAChB,WAAW;oBACX,cAAc;oBACd,2BAA2B;oBAC3B,aAAa;gBACf,OAAO,IAAI,SAAS,MAAM,GAAG,GAAG;oBAC9B,sFAAsF;oBACtF,aAAa;oBACb,oJAAK,CAAC,KAAK,CAAC;gBACd;YACF,OAAO,IAAI,CAAC,IAAI;gBACd,gCAAgC;gBAChC,cAAc;YAChB;QACF;+BAAG;QAAC;QAAI,SAAS,MAAM;QAAE;KAAW,GAAG,gDAAgD;IAEvF,MAAM,gBAAgB;QACpB,oJAAK,CAAC,IAAI,CAAC;QACX,cAAc;QACd,MAAM;IACR;IAEA,MAAM,sBAAsB,OAAO;QACjC,gBAAgB;QAEhB,IAAI;YACF,IAAI,MAAM,SAAS;gBACjB,kDAAkD;gBAClD,MAAM,aAAa;oBACjB,MAAM,SAAS,IAAI;oBACnB,aAAa,SAAS,WAAW,IAAI;oBACrC,UAAU,SAAS,QAAQ,IAAI;oBAC/B,UAAU,SAAS,QAAQ;oBAC3B,WAAW,SAAS,SAAS,IAAI;oBACjC,cAAc,SAAS,YAAY,IAAI;oBACvC,UAAU,SAAS,QAAQ,IAAI;oBAC/B,cAAc,SAAS,YAAY,IAAI;oBACvC,UAAU,SAAS,QAAQ,IAAI;oBAC/B,WAAW,SAAS,SAAS;oBAC7B,SAAS,SAAS,OAAO;oBACzB,qBAAqB,SAAS,mBAAmB;gBACnD;gBAEA,MAAM,SAAS,MAAM,cAAc,IAAI;gBAEvC,IAAI,QAAQ;oBACV,oJAAK,CAAC,OAAO,CAAC;oBACd,SAAS,CAAC,WAAW,EAAE,IAAI;gBAC7B,OAAO;oBACL,oJAAK,CAAC,KAAK,CAAC;gBACd;YACF,OAAO;gBACL,qBAAqB;gBACrB,IAAI,CAAC,MAAM,IAAI;oBACb,oJAAK,CAAC,KAAK,CAAC;oBACZ;gBACF;gBAEA,MAAM,aAAa;oBACjB,IAAI;oBACJ,MAAM,SAAS,IAAI;oBACnB,aAAa,SAAS,WAAW,IAAI;oBACrC,UAAU,SAAS,QAAQ,IAAI;oBAC/B,UAAU,SAAS,QAAQ;oBAC3B,WAAW,SAAS,SAAS,IAAI;oBACjC,cAAc,SAAS,YAAY,IAAI;oBACvC,UAAU,SAAS,QAAQ,IAAI;oBAC/B,cAAc,SAAS,YAAY,IAAI;oBACvC,UAAU,SAAS,QAAQ,IAAI;oBAC/B,WAAW,SAAS,SAAS,IAAI,IAAI;oBACrC,WAAW,IAAI;oBACf,SAAS,SAAS,OAAO,IAAI;oBAC7B,qBAAqB,SAAS,mBAAmB,IAAI;gBACvD;gBAEA,MAAM,aAAa,MAAM,cAAc;gBAEvC,IAAI,YAAY;oBACd,oJAAK,CAAC,OAAO,CAAC;oBAEd,gCAAgC;oBAChC,IAAI,SAAS,cAAc,IAAI,WAAW,OAAO,EAAE;wBACjD,IAAI;4BACF,MAAM,WAAW,SAAS,aAAa,IAAI;4BAC3C,oJAAK,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,SAAS,cAAc,EAAE,WAAW,IAAI,MAAM,GAAG,cAAc,CAAC;4BACtF,MAAM,MAAM,qCAAqC;gCAC/C,QAAQ;gCACR,SAAS;oCAAE,gBAAgB;gCAAmB;gCAC9C,MAAM;gCACN,MAAM,KAAK,SAAS,CAAC;oCACnB,aAAa,SAAS,kBAAkB,IAAI;oCAC5C,SAAS,CAAC,8DAA8D,EAAE,WAAW,IAAI,CAAC,mCAAmC,EAAE,WAAW,OAAO,CAAC,0BAA0B,EAAE,SAAS,QAAQ,CAAC,CAAC,EAAE,IAAA,sIAAY,EAAC,WAAW,YAAY,EAAE,SAAS,EAAE,SAAS,EAAE,CAAC;gCAClQ;4BACF;4BACA,oJAAK,CAAC,OAAO,CAAC;wBAChB,EAAE,OAAO,KAAK;4BACZ,QAAQ,KAAK,CAAC,+BAA+B;4BAC7C,oJAAK,CAAC,KAAK,CAAC;wBACd;oBACF;oBAEA,SAAS,CAAC,WAAW,EAAE,WAAW,EAAE,EAAE;gBACxC,OAAO;oBACL,oJAAK,CAAC,KAAK,CAAC;gBACd;YACF;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,6BAA6B;YAC3C,oJAAK,CAAC,KAAK,CAAC;QACd,SAAU;YACR,gBAAgB;QAClB;IACF;IAEA,MAAM,YAAY,mBAAmB,qBAAqB,gBAAgB;IAE1E,+FAA+F;IAC/F,MAAM,cAAc,gBAAgB;QAClC,GAAG,aAAa;QAChB,UAAU;QACV,IAAI;QACJ,YAAY;QACZ,WAAW,IAAI;QACf,WAAW,IAAI;QACf,SAAS;QACT,qBAAqB,GAAG,qCAAqC;IAC/D,IAAe;IAEf,mBAAmB;IACnB,MAAM,UAAU,KAAK,cAAc,aAAa,UAAU;IAC1D,MAAM,YAAY,CAAC,KAAK,cAAc,aAAa,YAAY;IAE/D,IAAI,mBAAmB,mBAAmB,mBAAmB;QAC3D,qBACE,6LAAC;YAAI,WAAU;sBACb,cAAA,6LAAC;gBAAI,WAAU;;;;;;;;;;;IAGrB;IAEA,IAAI,CAAC,WAAW,CAAC,WAAW;QAC1B,qBACE,6LAAC;YAAI,WAAU;;8BACb,6LAAC,6IAAK;oBAAC,SAAQ;;sCACb,6LAAC,sOAAW;4BAAC,WAAU;;;;;;sCACvB,6LAAC,kJAAU;sCAAC;;;;;;sCACZ,6LAAC,wJAAgB;;gCAAC;gCACe,KAAK,sBAAsB;gCAAuB;;;;;;;;;;;;;8BAIrF,6LAAC;oBAAI,WAAU;8BACb,cAAA,6LAAC,+IAAM;wBAAC,SAAS,IAAM,SAAS;wBAAe,SAAQ;kCAAU;;;;;;;;;;;;;;;;;IAMzE;IAEA,6FAA6F;IAC7F,IAAI,MAAM,CAAC,cAAc,CAAC,WAAW;QACnC,qBACE,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAI,WAAU;8BACb,cAAA,6LAAC,+IAAM;wBACL,SAAQ;wBACR,MAAK;wBACL,SAAS,IAAM,SAAS;wBACxB,WAAU;;0CAEV,6LAAC,gOAAS;gCAAC,WAAU;;;;;;4BAAY;;;;;;;;;;;;8BAGrC,6LAAC;oBAAI,WAAU;8BACb,cAAA,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAI,WAAU;;;;;;0CACf,6LAAC;gCAAE,WAAU;0CAAgB;;;;;;;;;;;;;;;;;;;;;;;IAKvC;IAEA,qBACE,6LAAC;QAAI,WAAU;;0BACb,6LAAC;gBAAI,WAAU;;kCACb,6LAAC,+IAAM;wBACL,SAAQ;wBACR,MAAK;wBACL,SAAS,IAAM,SAAS;wBACxB,WAAU;;0CAEV,6LAAC,gOAAS;gCAAC,WAAU;;;;;;4BAAY;;;;;;;oBAIlC,oBACC,6LAAC,+IAAM;wBACL,SAAQ;wBACR,MAAK;wBACL,SAAS;wBACT,UAAU;wBACV,WAAU;;0CAEV,6LAAC,gOAAS;gCAAC,WAAW,CAAC,QAAQ,EAAE,eAAe,iBAAiB,IAAI;;;;;;4BACpE,eAAe,kBAAkB;;;;;;;;;;;;;YAKvC,0BACC,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCAAwC;;;;;;kCACtD,6LAAC;wBAAE,WAAU;kCAAgB;;;;;;kCAC7B,6LAAC,+IAAM;wBACL,WAAU;wBACV,SAAS,IAAM,SAAS;kCACzB;;;;;;;;;;;yEAKH,6LAAC,4JAAW;gBACV,aAAa;gBACb,YAAY;gBACZ,iBAAiB;gBACjB,WAAW;;;;;;;;;;;;AAKrB;GA/RM;;QACW,gLAAS;QACP,kLAAW;QACX,kLAAW;QACX,wJAAO;QAC8E,6IAAW;QAC5D,iJAAa;QAM7C,6JAAmB;QACc,oJAAW;;;KAb7D;uCAiSS"}}]
}