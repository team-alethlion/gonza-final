(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,178583,e=>{"use strict";let t=(0,e.i(475254).default)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]);e.s(["FileText",()=>t],178583)},624687,e=>{"use strict";var t=e.i(843476),r=e.i(271645),a=e.i(975157);let i=r.forwardRef(({className:e,...r},i)=>(0,t.jsx)("textarea",{className:(0,a.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:i,...r}));i.displayName="Textarea",e.s(["Textarea",()=>i])},160615,e=>{"use strict";var t=e.i(271645),r=e.i(266027),a=e.i(908406),i=e.i(422713),s=e.i(95187);let o=(0,s.createServerReference)("40290a4fc6b8571a026afeb877566edb807919e482",s.callServer,void 0,s.findSourceMapURL,"getBusinessSettingsAction");var n=e.i(709239);let u=()=>({businessName:"",businessAddress:"",businessPhone:"",businessEmail:"",currency:"UGX",paymentInfo:"",defaultPrintFormat:"standard"});e.s(["convertPaymentMethodsToString",0,e=>e.filter(e=>""!==e.method.trim()||""!==e.accountNumber.trim()||""!==e.accountName.trim()).map(e=>`${e.method}
${e.accountNumber}
${e.accountName}`).join("\n"),"parsePaymentInfo",0,e=>{if(!e||""===e.trim())return[];let t=e.split("\n").filter(e=>""!==e.trim()),r=[];for(let e=0;e<t.length;e+=3)e+2<t.length&&r.push({method:t[e].trim(),accountNumber:t[e+1].trim(),accountName:t[e+2].trim()});return r},"useBusinessSettings",0,()=>{let[e,s]=(0,t.useState)(u()),[c,d]=(0,t.useState)(!1),{toast:l}=(0,a.useToast)(),{currentBusiness:m}=(0,i.useBusiness)(),y=async()=>{if(!m)return u();try{let e=await o(m.id);if(!e)return u();{let t=e.metadata&&"object"==typeof e.metadata&&e.metadata.payment_info||"";return{id:e.id,businessName:e.business_name||"",businessAddress:e.business_address||"",businessPhone:e.business_phone||"",businessEmail:e.business_email||"",businessLogo:e.business_logo||void 0,currency:e.currency||"UGX",signature:e.signature||void 0,paymentInfo:t,defaultPrintFormat:e.metadata&&"object"==typeof e.metadata&&e.metadata.default_print_format||"standard",defaultPrinterName:e.metadata&&"object"==typeof e.metadata&&e.metadata.default_printer_name||"",defaultPrinterType:e.metadata&&"object"==typeof e.metadata&&e.metadata.default_printer_type||"USB",printerPaperSize:e.metadata&&"object"==typeof e.metadata&&e.metadata.printer_paper_size||"58mm"}}}catch(e){return console.error("Error loading business settings:",e),l({title:"Error",description:"Failed to load business settings. Please try again.",variant:"destructive"}),u()}},p=async t=>{if(!m)return console.error("No business selected for updating settings"),l({title:"Error",description:"No business selected",variant:"destructive"}),!1;try{let r={payment_info:t.hasOwnProperty("paymentInfo")?t.paymentInfo:e.paymentInfo||"",default_print_format:t.hasOwnProperty("defaultPrintFormat")?t.defaultPrintFormat:e.defaultPrintFormat||"standard",default_printer_name:t.hasOwnProperty("defaultPrinterName")?t.defaultPrinterName:e.defaultPrinterName||"",default_printer_type:t.hasOwnProperty("defaultPrinterType")?t.defaultPrinterType:e.defaultPrinterType||"USB",printer_paper_size:t.hasOwnProperty("printerPaperSize")?t.printerPaperSize:e.printerPaperSize||"58mm"},a={business_name:t.hasOwnProperty("businessName")?t.businessName:e.businessName,business_address:t.hasOwnProperty("businessAddress")?t.businessAddress:e.businessAddress,business_phone:t.hasOwnProperty("businessPhone")?t.businessPhone:e.businessPhone,business_email:t.hasOwnProperty("businessEmail")?t.businessEmail:e.businessEmail,business_logo:t.hasOwnProperty("businessLogo")?t.businessLogo:e.businessLogo,currency:t.hasOwnProperty("currency")?t.currency:e.currency,signature:t.hasOwnProperty("signature")?t.signature:e.signature,metadata:r},i=await (0,n.upsertBusinessSettingsAction)(m.id,"00000000-0000-0000-0000-000000000000",a);if(!i.success)throw console.error("Supabase error updating business settings:",i.error),Error(i.error);return l({title:"Success",description:"Business settings updated successfully"}),h(),!0}catch(e){return console.error("Error updating business settings:",e),l({title:"Error",description:"Failed to update business settings. Please try again.",variant:"destructive"}),!1}},{data:f,isLoading:g,isFetching:b,refetch:h}=(0,r.useQuery)({queryKey:["businessSettings",m?.id],queryFn:y,enabled:!!m?.id,staleTime:3e5,gcTime:18e5,refetchOnWindowFocus:!1,refetchOnReconnect:!1});return(0,t.useEffect)(()=>{f?s(f):m||s(u())},[f,m]),(0,t.useEffect)(()=>{d(g||b)},[g,b]),{settings:e,isLoading:c,updateSettings:p,loadSettings:y}}],160615)},281092,234662,677241,e=>{"use strict";let t=Symbol.for("constructDateFrom");function r(e,r){return"function"==typeof e?e(r):e&&"object"==typeof e&&t in e?e[t](r):e instanceof Date?new e.constructor(r):new Date(r)}function a(e,t){return r(t||e,e)}e.s(["constructFromSymbol",0,t,"millisecondsInDay",0,864e5,"millisecondsInHour",0,36e5,"millisecondsInMinute",0,6e4,"millisecondsInSecond",0,1e3,"millisecondsInWeek",0,6048e5,"minutesInDay",0,1440,"minutesInMonth",0,43200],234662),e.s(["constructFrom",()=>r],677241),e.s(["toDate",()=>a],281092)},751371,595727,e=>{"use strict";var t=e.i(677241),r=e.i(281092);function a(e,a,i){let s=(0,r.toDate)(e,i?.in);return isNaN(a)?(0,t.constructFrom)(i?.in||e,NaN):(a&&s.setDate(s.getDate()+a),s)}function i(e,t,r){return a(e,-t,r)}e.s(["addDays",()=>a],595727),e.s(["subDays",()=>i],751371)},688594,e=>{"use strict";var t=e.i(677241),r=e.i(281092);function a(e,a,i){let s=(0,r.toDate)(e,i?.in);if(isNaN(a))return(0,t.constructFrom)(i?.in||e,NaN);if(!a)return s;let o=s.getDate(),n=(0,t.constructFrom)(i?.in||e,s.getTime());return(n.setMonth(s.getMonth()+a+1,0),o>=n.getDate())?n:(s.setFullYear(n.getFullYear(),n.getMonth(),o),s)}e.s(["addMonths",()=>a])},299378,e=>{"use strict";var t=e.i(688594);function r(e,r,a){return(0,t.addMonths)(e,12*r,a)}e.s(["addYears",()=>r])},986387,e=>{"use strict";var t=e.i(102594);e.s(["useCurrentUser",0,()=>{let{user:e}=(0,t.useAuth)();return{userId:e?.id}}])},457786,e=>{"use strict";var t=e.i(95187);let r=(0,t.createServerReference)("401d907b5cd7e0b2f207e9b555ac4fe2e14de08444",t.callServer,void 0,t.findSourceMapURL,"logActivityAction");var a=e.i(986387),i=e.i(422713),s=e.i(777624);e.s(["useActivityLogger",0,()=>{let{userId:e}=(0,a.useCurrentUser)(),{currentBusiness:t}=(0,i.useBusiness)(),o=null;try{let{currentProfile:e}=(0,s.useProfiles)();o=e}catch{o=null}return{logActivity:async a=>{if(!e||!t?.id)return void console.warn("Cannot log activity: missing user or business context");try{let i=await r({userId:e,locationId:t.id,activityType:a.activityType,module:a.module,entityType:a.entityType,entityId:a.entityId||void 0,entityName:a.entityName,description:a.description,metadata:a.metadata||void 0,profileId:o?.id||void 0,profileName:o?.profile_name||void 0});i.success||console.error("Error logging activity:",i.error)}catch(e){console.error("Failed to log activity:",e)}}}}],457786)},589271,e=>{"use strict";e.s(["mapDbProductToProduct",0,e=>({id:e.id,itemNumber:e.item_number,barcode:e.barcode,manufacturerBarcode:e.manufacturer_barcode,name:e.name,description:e.description,category:e.category,quantity:e.quantity,costPrice:Number(e.cost_price),sellingPrice:Number(e.selling_price),supplier:e.supplier,imageUrl:e.image_url,minimumStock:e.minimum_stock,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}),"mapDbSaleToSale",0,e=>{let t=(Array.isArray(e.items)?e.items:[]).map(e=>{let t=void 0!==e.discountPercentage?Number(e.discountPercentage):void 0,r=void 0!==e.discountAmount?Number(e.discountAmount):void 0,a=e.discountType;return!a&&(t&&t>0?a="percentage":r&&r>0&&(a="amount")),{description:e.description||"",quantity:Number(e.quantity)||0,price:Number(e.price)||0,cost:Number(e.cost)||0,productId:e.productId||void 0,discountType:a,discountPercentage:t,discountAmount:r,createdAt:e.createdAt||void 0}});return{id:e.id,receiptNumber:e.receipt_number,customerName:e.customer_name,customerAddress:e.customer_address||"",customerContact:e.customer_contact||"",customerId:e.customer_id||void 0,items:t,paymentStatus:e.payment_status,profit:Number(e.profit),date:new Date(e.date),taxRate:e.tax_rate?Number(e.tax_rate):0,cashTransactionId:e.cash_transaction_id||void 0,amountPaid:e.amount_paid?Number(e.amount_paid):void 0,amountDue:e.amount_due?Number(e.amount_due):void 0,notes:e.notes||"",categoryId:e.category_id||void 0,createdAt:new Date(e.created_at)}},"mapSaleToDbSale",0,(e,t,r,a,i,s,o)=>({user_id:i,location_id:s,receipt_number:a,customer_name:e.customerName,customer_address:e.customerAddress||null,customer_contact:e.customerContact||null,customer_id:e.customerId||null,items:e.items,payment_status:e.paymentStatus,profit:r,date:t.toISOString().split("T")[0],tax_rate:e.taxRate||0,cash_transaction_id:o||null,amount_paid:e.amountPaid||null,amount_due:e.amountDue||null,notes:e.notes||null,category_id:e.categoryId||null})])},146786,850823,617318,e=>{"use strict";var t=e.i(271645),r=e.i(589271),a=e.i(908406),i=e.i(266027),s=e.i(912598),o=e.i(457786),n=e.i(422713),u=e.i(908962),c=e.i(846696),d=e.i(555781);let l=e=>{let{updateProductsBulk:t}=(0,u.useProducts)(e),r=async(e,t)=>{if(!e.length)return[];try{return await (0,d.getProductsByIdsAction)(e,t)}catch(e){throw console.error("Error fetching fresh products:",e),e}};return{deductStockForSale:async(a,i,s,o,n)=>{if(!e)return!1;try{let u=a.filter(e=>e.productId);if(0===u.length)return!0;let d=[...new Set(u.map(e=>e.productId))],l=await r(d,n);if(0===l.length)return!1;let m=new Map;for(let e of u){let t=m.get(e.productId)||0;m.set(e.productId,t+e.quantity)}let y=[];for(let[e,t]of m.entries()){let r=l.find(t=>t.id===e);if(!r)continue;let a=r.quantity-t;y.push({id:e,updated:{...r,quantity:a}}),a<0&&c.toast.warning(`${r.name} inventory is now negative (${a}). Please restock soon.`)}return y.length>0&&await t(y,e,"Sale",i,s,o),!0}catch(e){return console.error("Error deducting stock for sale:",e),!1}},restoreStockForSale:async(a,i,s,o)=>{if(!e)return!1;try{let n=a.filter(e=>e.productId);if(0===n.length)return!0;let u=[...new Set(n.map(e=>e.productId))],c=await r(u,o),d=new Map;for(let e of n){let t=d.get(e.productId)||0;d.set(e.productId,t+e.quantity)}let l=[];for(let[e,t]of d.entries()){let r=c.find(t=>t.id===e);if(!r)continue;let a=r.quantity+t;l.push({id:e,updated:{...r,quantity:a}})}return l.length>0&&await t(l,e,"Deleted Sale",i,void 0,s),!0}catch(e){return console.error("Error restoring stock for sale:",e),!1}},adjustStockForEditedSale:async(a,i,s,o,n,u)=>{if(!e)return!1;try{let d=[...a.filter(e=>e.productId).map(e=>e.productId),...i.filter(e=>e.productId).map(e=>e.productId)],l=[...new Set(d)];if(0===l.length)return!0;let m=await r(l,u),y=new Map;for(let e of a.filter(e=>e.productId)){let t=y.get(e.productId)||0;y.set(e.productId,t+e.quantity)}for(let e of i.filter(e=>e.productId)){let t=y.get(e.productId)||0;y.set(e.productId,t-e.quantity)}let p=[];for(let[e,t]of y.entries()){if(0===t)continue;let r=m.find(t=>t.id===e);if(!r)continue;let a=r.quantity+t;p.push({id:e,updated:{...r,quantity:a}}),a<0&&c.toast.warning(`${r.name} inventory is now negative (${a}). Please restock soon.`)}return p.length>0&&await t(p,e,"Sale Status/Qty Edit",s,o,n),!0}catch(e){return console.error("Error adjusting stock for edited sale:",e),!1}}}};e.s(["useInventoryActions",0,l],850823);var m=e.i(224410),y=e.i(95187);let p=(0,y.createServerReference)("703e9376bfaf2adbf9aba886e70ba6b561f6bf5e0c",y.callServer,void 0,y.findSourceMapURL,"getSalesAction"),f=(0,y.createServerReference)("40d9064371ce5c0811194879498fdc849fbf872b8a",y.callServer,void 0,y.findSourceMapURL,"deleteSaleAction");e.s(["deleteSaleAction",()=>f],617318),e.s(["useSalesData",0,(e,u="desc",c)=>{let d=(0,s.useQueryClient)(),{toast:y}=(0,a.useToast)(),{logActivity:g}=(0,o.useActivityLogger)(),{currentBusiness:b}=(0,n.useBusiness)(),{restoreStockForSale:h}=l(e),v=(0,t.useCallback)(async()=>{try{if(!e||!b)return[];let t=await p(b.id,u,c);return t?t.map(e=>{let t={id:e.id,user_id:e.user_id,location_id:e.location_id,receipt_number:e.receipt_number,customer_name:e.customer_name,customer_address:e.customer_address,customer_contact:e.customer_contact,customer_id:e.customer_id,items:e.items,payment_status:e.payment_status,profit:e.profit?Number(e.profit):0,date:e.date,tax_rate:e.tax_rate||0,created_at:e.created_at,updated_at:e.updated_at,cash_transaction_id:e.cash_transaction_id,amount_paid:e.amount_paid?Number(e.amount_paid):void 0,amount_due:e.amount_due?Number(e.amount_due):void 0,category_id:e.category_id,notes:e.notes};return(0,r.mapDbSaleToSale)(t)}):[]}catch(e){return console.error("Error loading sales:",e),y({title:"Error",description:"Failed to load sales data. Please try again.",variant:"destructive"}),[]}},[e,b?.id,u,c,y]),S=(0,t.useMemo)(()=>["sales",b?.id,e],[b?.id,e]),_=(0,t.useMemo)(()=>[...S,u,c],[S,u,c]),{data:N=[],isLoading:I,isFetching:w,refetch:P}=(0,i.useQuery)({queryKey:_,queryFn:v,enabled:!!e&&!!b?.id,staleTime:3e4,gcTime:18e5,refetchOnWindowFocus:!0,refetchOnReconnect:!0}),E=I||w&&0===N.length,A=(0,t.useMemo)(()=>{let e=N.filter(e=>"Quote"!==e.paymentStatus),t=new Map;return e.forEach(e=>{let r=e.customerName,a=e.items.reduce((e,t)=>e+t.price*t.quantity,0);if(t.has(r)){let i=t.get(r);t.set(r,{total:i.total+a,count:i.count+1,customerId:i.customerId||e.customerId})}else t.set(r,{total:a,count:1,customerId:e.customerId})}),Array.from(t.entries()).map(([e,t])=>({id:t.customerId,name:e,totalPurchases:t.total,orderCount:t.count})).sort((e,t)=>t.totalPurchases-e.totalPurchases)},[N]),T=(0,t.useMemo)(()=>e=>{let t=N.filter(t=>t.customerName.toLowerCase()===e.toLowerCase()&&"Quote"!==t.paymentStatus);return{total:t.reduce((e,t)=>e+t.items.reduce((e,t)=>e+t.price*t.quantity,0),0),count:t.length}},[N]),D=async e=>{try{let t=N.find(t=>t.id===e);if(!t)throw Error("Sale not found");if("Quote"!==t.paymentStatus&&t.items.length>0&&(console.log("Restoring product quantities via useInventoryActions..."),await h(t.items,e,t.receiptNumber,b?.id)||y({title:"Inventory Update Warning",description:"Sale deleted, but inventory restoration might have failed. Please check your stock levels.",variant:"destructive"})),!b?.id)throw Error("Business context missing for deletion");let r=await f(e,b.id);if(!r.success)throw Error(r.error);return d.setQueryData(_,t=>t?t.filter(t=>t.id!==e):[]),d.invalidateQueries({queryKey:S}),C(),await g({activityType:"DELETE",module:"SALES",entityType:"sale",entityId:e,entityName:`Sale #${t.receiptNumber}`,description:`Deleted sale for ${t.customerName} - Total: UGX ${((t.amountPaid||0)+(t.amountDue||0)).toLocaleString()} (Stock restored)`,metadata:{receiptNumber:t.receiptNumber,customerName:t.customerName,customerAddress:t.customerAddress,customerContact:t.customerContact,totalAmount:(t.amountPaid||0)+(t.amountDue||0),amountPaid:t.amountPaid,profit:t.profit,paymentStatus:t.paymentStatus,taxRate:t.taxRate,itemCount:t.items.length,items:t.items.map(e=>({description:e.description,quantity:e.quantity,price:e.price,cost:e.cost,total:e.quantity*e.price,discountPercentage:e.discountPercentage,discountAmount:e.discountAmount})),notes:t.notes,cashTransactionDeleted:!!t.cashTransactionId}}),y({title:"Sale Deleted",description:"The sale record and associated data have been successfully deleted."}),(0,m.clearInventoryCaches)(),!0}catch(e){return console.error("Error deleting sale:",e),y({title:"Error",description:"Failed to delete sale. Please try again.",variant:"destructive"}),!1}},C=(0,t.useCallback)(()=>{if(!b?.id)return;let e=`soldItemsFilters_${b.id}`;localStorage.removeItem(e),localStorage.removeItem("soldItemsFilters")},[b?.id]);return{sales:N,isLoading:E,deleteSale:D,addSale:(0,t.useCallback)(e=>{d.setQueryData(_,t=>t?[e,...t]:[e]),d.invalidateQueries({queryKey:S}),C(),(0,m.clearInventoryCaches)()},[d,_,S,C,m.clearInventoryCaches]),updateSale:(0,t.useCallback)(e=>{d.setQueryData(_,t=>t?t.map(t=>t.id===e.id?e:t):[e]),d.invalidateQueries({queryKey:S}),C(),(0,m.clearInventoryCaches)()},[d,_,S,C,m.clearInventoryCaches]),getTopCustomers:A,getCustomerLifetimePurchases:T,clearSoldItemsCache:C,refetch:P,isFetching:w}}],146786)},871689,e=>{"use strict";let t=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>t],871689)},63209,e=>{"use strict";let t=(0,e.i(475254).default)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);e.s(["AlertCircle",()=>t],63209)},555781,(e,t,r)=>{let a=Error("Could not parse module '[project]/src/app/actions/products.ts'\n\n'import', and 'export' cannot be used outside of module code");throw a.code="MODULE_UNPARSABLE",a},908962,224410,e=>{"use strict";var t=e.i(271645),r=e.i(160615),a=e.i(422713),i=e.i(266027),s=e.i(912598);let o=e=>{let t=Object.keys(localStorage),r=["allProductsStats_","stockSummary_","soldItems_","dashboardData_","analyticsData_"],a=0;t.forEach(e=>{r.some(t=>e.startsWith(t))&&(localStorage.removeItem(e),a++)}),a>0&&console.log(`[Cache] Cleared ${a} inventory-related localStorage entries.`),e&&(console.log("[Cache] Invalidating React Query inventory keys..."),e.invalidateQueries({queryKey:["inventory_global_stats"]}),e.invalidateQueries({queryKey:["stockSummary"]}),e.invalidateQueries({queryKey:["products"]}),e.invalidateQueries({queryKey:["sales"]}),e.invalidateQueries({queryKey:["all-products-for-scanner"]}),e.invalidateQueries({queryKey:["all-products"]}))};e.s(["clearInventoryCaches",0,o],224410);var n=e.i(555781);e.s(["useProducts",0,(e,u=50)=>{let[c,d]=(0,t.useState)([]),[l,m]=(0,t.useState)(1),[y,p]=(0,t.useState)(u),[f,g]=(0,t.useState)(0),[b,h]=(0,t.useState)(!1),{settings:v}=(0,r.useBusinessSettings)(),{currentBusiness:S}=(0,a.useBusiness)(),_=(0,s.useQueryClient)(),[N,I]=(0,t.useState)({search:"",category:"all",stockStatus:"all"}),[w,P]=(0,t.useState)(null),E=(0,t.useCallback)(e=>{e.search!==N.search&&(h(!0),w&&clearTimeout(w),P(setTimeout(()=>{h(!1)},600))),I(e)},[N.search,w]),A=(0,t.useCallback)(async()=>{if(!e||!S)return{products:[],count:0};try{return await (0,n.getProductsAction)({userId:e,businessId:S.id,page:l,pageSize:y,search:N.search,category:"all"===N.category?void 0:N.category,stockStatus:N.stockStatus})}catch(e){return console.error("Error loading products from server action:",e),{products:[],count:0}}},[e,S?.id,l,y,N.search,N.category,N.stockStatus]),T=(0,t.useMemo)(()=>["products",e,S?.id],[e,S?.id]),D=(0,t.useMemo)(()=>[...T,l,y,N.search,N.category,N.stockStatus],[T,l,y,N.search,N.category,N.stockStatus]),{data:C,isLoading:k,isFetching:M,refetch:q}=(0,i.useQuery)({queryKey:D,queryFn:A,enabled:!!e&&!!S?.id,staleTime:3e4,gcTime:18e5,refetchOnWindowFocus:!0,refetchOnReconnect:!0});(0,t.useEffect)(()=>{C&&(d(C.products),g(C.count))},[C]);let F=async t=>{try{if(!e)return null;return console.warn("Image upload redirecting to server action (TODO)"),null}catch(e){return console.error("Error in uploadProductImage:",e),null}};return{products:c,isLoading:k&&!C&&!b,loadProducts:A,page:l,setPage:m,pageSize:y,setPageSize:p,totalCount:f,createProduct:async t=>{try{if(!e||!S)return null;let r=await (0,n.createProductAction)({...t,userId:e,businessId:S.id});if(!r)return null;return d(e=>[r,...e]),g(e=>e+1),_.invalidateQueries({queryKey:T}),o(_),r}catch(e){return console.error("Error creating product:",e),null}},updateProduct:async(t,r,a,i=!1,s,u,c,d)=>{try{if(!e||!S)return!1;let u=r.imageUrl;if(a&&(u=await F(a)),!await (0,n.updateProductAction)(t,{...r,imageUrl:u,userId:e,businessId:S.id,isFromSale:i,customChangeReason:s,referenceId:c}))return!1;return _.invalidateQueries({queryKey:T}),o(_),!0}catch(e){return console.error("Error updating product:",e),!1}},updateProductsBulk:async(t,r,a,i,s,u)=>{try{if(!e||!S)return!1;let r=await (0,n.updateProductsBulkAction)(t.map(e=>({id:e.id,updated:e.updated})),S.id);return r&&(_.invalidateQueries({queryKey:T}),o(_)),r}catch(e){return console.error("Error in bulk update:",e),!1}},deleteProduct:async t=>{try{if(!e)return!1;if(await (0,n.deleteProductAction)(t))return _.invalidateQueries({queryKey:T}),o(_),!0;return!1}catch(e){return console.error("Error deleting product:",e),!1}},uploadProductImage:F,refetch:q,isFetching:M,filters:N,setFilters:E}}],908962)},39725,e=>{"use strict";var t=e.i(271645),r=e.i(908406),a=e.i(422713),i=e.i(457786),s=e.i(266027),o=e.i(912598),n=e.i(95187);let u=(0,n.createServerReference)("40227d1c2ed5cbf6324cf519682235031f0a3138a5",n.callServer,void 0,n.findSourceMapURL,"getCustomersAction"),c=(0,n.createServerReference)("708938753470d59bd6fa4ddf41a8a3581263dd393b",n.callServer,void 0,n.findSourceMapURL,"createCustomerAction"),d=(0,n.createServerReference)("609ad415d8b556837c750a19320a30ea6d4beaf896",n.callServer,void 0,n.findSourceMapURL,"updateCustomerAction"),l=(0,n.createServerReference)("40f9d32b0ea15e5c8f0b3441eec79ddb30815f1c83",n.callServer,void 0,n.findSourceMapURL,"deleteCustomerAction");var m=e.i(102594);e.s(["useCustomers",0,(e=50)=>{let[n,y]=(0,t.useState)([]),[p,f]=(0,t.useState)(1),[g,b]=(0,t.useState)(e),[h,v]=(0,t.useState)(0),{toast:S}=(0,r.useToast)(),{currentBusiness:_}=(0,a.useBusiness)(),{user:N}=(0,m.useAuth)(),{logActivity:I}=(0,i.useActivityLogger)(),w=(0,o.useQueryClient)(),P=(0,t.useCallback)(async()=>{if(!_)return{customers:[],count:0};try{let e=await u(_.id);if(!e.success)throw Error(e.error);return{customers:(e.data?.customers||[]).map(e=>({id:e.id,fullName:e.fullName||e.name,phoneNumber:e.phoneNumber||e.phone,email:e.email,birthday:e.birthday?new Date(e.birthday):null,gender:e.gender,location:e.location||e.address,categoryId:e.categoryId,notes:e.notes,tags:e.tags,socialMedia:e.socialMedia||null,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)})),count:e.data?.count||0}}catch(e){return console.error("Error loading customers:",e),S({title:"Error",description:"Failed to load customers. Please try again.",variant:"destructive"}),{customers:[],count:0}}},[_?.id,S]),E=["customers",_?.id],{data:A,isLoading:T,isFetching:D}=(0,s.useQuery)({queryKey:E,queryFn:P,enabled:!!_?.id,staleTime:3e5,gcTime:18e5,refetchOnWindowFocus:!1,refetchOnReconnect:!1});(0,t.useEffect)(()=>{A&&(y(A.customers),v(A.count))},[A]);let C=async e=>{if(!_)return S({title:"Error",description:"No business selected",variant:"destructive"}),null;try{if(!N)throw Error("User not authenticated");let t={fullName:e.fullName,phoneNumber:e.phoneNumber||null,email:e.email||null,birthday:e.birthday?.toISOString().split("T")[0]||null,gender:e.gender||null,location:e.location||null,categoryId:e.categoryId||null,notes:e.notes||null,tags:e.tags||null,socialMedia:e.socialMedia||null},r=await c(_.id,N.id,t);if(!r.success||!r.data)throw Error(r.error||"Failed to create customer");let a=r.data,i={id:a.id,fullName:a.name||a.fullName,phoneNumber:a.phone||a.phoneNumber,email:a.email,birthday:a.birthday?new Date(a.birthday):null,gender:a.gender,location:a.address||a.location,categoryId:a.categoryId,notes:a.notes,tags:a.tags,socialMedia:a.socialMedia,createdAt:new Date(a.createdAt),updatedAt:new Date(a.updatedAt)};return y(e=>[i,...e]),v(e=>e+1),w.setQueryData(E,e=>e?{customers:[i,...e.customers],count:(e.count||0)+1}:{customers:[i],count:1}),await I({activityType:"CREATE",module:"CUSTOMERS",entityType:"customer",entityId:a.id,entityName:e.fullName,description:`Created customer "${e.fullName}"`,metadata:{phoneNumber:e.phoneNumber,email:e.email,location:e.location}}),S({title:"Success",description:"Customer created successfully"}),a}catch(e){return console.error("Error creating customer:",e),S({title:"Error",description:"Failed to create customer. Please try again.",variant:"destructive"}),null}},k=async(e,t)=>{try{let r={};void 0!==t.fullName&&(r.fullName=t.fullName),void 0!==t.phoneNumber&&(r.phoneNumber=t.phoneNumber),void 0!==t.email&&(r.email=t.email),void 0!==t.birthday&&(r.birthday=t.birthday?.toISOString()),void 0!==t.gender&&(r.gender=t.gender),void 0!==t.location&&(r.location=t.location),void 0!==t.categoryId&&(r.categoryId=t.categoryId),void 0!==t.notes&&(r.notes=t.notes),void 0!==t.tags&&(r.tags=t.tags),void 0!==t.socialMedia&&(r.socialMedia=t.socialMedia);let a=await d(e,r);if(!a.success)throw Error(a.error||"Failed to update customer");y(r=>r.map(r=>r.id===e?{...r,...t}:r)),w.setQueryData(E,r=>r?{...r,customers:r.customers.map(r=>r.id===e?{...r,...t}:r)}:r);let i=n.find(t=>t.id===e);return i&&await I({activityType:"UPDATE",module:"CUSTOMERS",entityType:"customer",entityId:e,entityName:i.fullName,description:`Updated customer "${i.fullName}"`,metadata:{updates:t}}),S({title:"Success",description:"Customer updated successfully"}),!0}catch(e){return console.error("Error updating customer:",e),S({title:"Error",description:"Failed to update customer. Please try again.",variant:"destructive"}),!1}},M=async e=>{try{let t=n.find(t=>t.id===e),r=await l(e);if(!r.success)throw Error(r.error||"Failed to delete customer");return y(t=>t.filter(t=>t.id!==e)),v(e=>Math.max(0,e-1)),w.setQueryData(E,t=>{if(!t)return t;let{customers:r,count:a}=t;return{customers:r.filter(t=>t.id!==e),count:Math.max(0,(a||0)-1)}}),w.invalidateQueries({queryKey:E}),t&&await I({activityType:"DELETE",module:"CUSTOMERS",entityType:"customer",entityId:e,entityName:t.fullName,description:`Deleted customer "${t.fullName}"`,metadata:{phoneNumber:t.phoneNumber,email:t.email}}),S({title:"Success",description:"Customer deleted successfully"}),!0}catch(e){return console.error("Error deleting customer:",e),S({title:"Error",description:"Failed to delete customer. Please try again.",variant:"destructive"}),!1}};return{customers:n,isLoading:T&&!A,createCustomer:C,addCustomer:C,updateCustomer:k,deleteCustomer:M,loadCustomers:P,page:p,setPage:f,pageSize:g,setPageSize:b,totalCount:h}}],39725)}]);