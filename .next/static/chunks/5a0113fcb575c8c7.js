(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,72702,e=>{"use strict";var t=e.i(391398),a=e.i(191788),s=e.i(365713),n=e.i(824216),r=e.i(563905),l=e.i(46108);let i=()=>{let[e,t]=(0,a.useState)(!1),{currentBusiness:s}=(0,l.useBusiness)(),n=(0,a.useMemo)(()=>s?.id?`sale_draft_${s.id}`:"sale_draft",[s?.id]),r=(0,a.useCallback)(()=>{let e=!!localStorage.getItem(n);return t(e),e},[n]);(0,a.useEffect)(()=>{s?.id&&r()},[r,s?.id]);let i=(0,a.useCallback)((e,a)=>{if(!s?.id)return;let r={formData:e,selectedDate:a.toISOString(),savedAt:new Date().toISOString()};localStorage.setItem(n,JSON.stringify(r)),t(!0)},[n,s?.id]);return{hasDraft:e,saveDraft:i,loadDraft:(0,a.useCallback)(()=>{let e=localStorage.getItem(n);if(e)try{let t=JSON.parse(e);return{formData:t.formData,selectedDate:new Date(t.selectedDate),savedAt:new Date(t.savedAt)}}catch(e){console.error("Error parsing draft:",e),localStorage.removeItem(n),t(!1)}return null},[n]),clearDraft:(0,a.useCallback)(()=>{localStorage.removeItem(n),t(!1)},[n]),checkForDraft:r}};var o=e.i(217837),c=e.i(150064),d=e.i(879975),u=e.i(852577),m=e.i(355879),h=e.i(554913);let x=e=>{let{products:t}=(0,m.useProducts)(e),{currentBusiness:s}=(0,l.useBusiness)(),{deductStockForSale:n,adjustStockForEditedSale:r}=(0,h.useInventoryActions)(e),[i,o]=(0,a.useState)({});return{products:t,selectedProducts:i,selectProduct:(e,t)=>{o(a=>({...a,[e]:t}))},getProductForItem:e=>{let a=i[e];return a&&t.find(e=>e.id===a)||null},updateInventoryForSale:async(e,t,a,r,l)=>"Quote"===t||n(e,r,a,l,s?.id),updateInventoryForEditedSale:async(e,t,a,n,l,i,o)=>{let c="Quote"!==o,d="Quote"!==a;return!c&&!d||r(c?e:[],d?t:[],l,n,i,s?.id)}}};var p=e.i(679935),g=e.i(546462),y=e.i(209695),f=e.i(504088),j=e.i(873015);let b=()=>(0,t.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,t.jsxs)("div",{className:"animate-pulse",children:[(0,t.jsx)("div",{className:"h-8 bg-gray-200 rounded w-48 mb-4"}),(0,t.jsx)("div",{className:"h-64 bg-gray-200 rounded"})]})}),N=()=>{let e=(0,o.useRouter)();return(0,t.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,t.jsxs)("div",{className:"bg-amber-50 border border-amber-200 p-4 rounded-md",children:[(0,t.jsx)("p",{className:"text-amber-800 mb-4",children:"No business location found. Please create a business location to manage sales."}),(0,t.jsx)("button",{onClick:()=>e.push("/business-management"),className:"bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700",children:"Manage Business Locations"})]})})},v=()=>(0,t.jsx)("div",{className:"bg-amber-50 border border-amber-200 p-4 rounded-md mb-6",children:(0,t.jsx)("p",{className:"text-amber-800",children:"You need to be signed in to create or edit sales. All sales are saved to your Supabase database."})});var C=e.i(810686),S=e.i(924432);let w=async e=>{try{if(!e)return console.error("Location ID is required for receipt number generation"),"000001";let t=await (0,S.getNextReceiptNumberAction)(e);if(t.success&&t.data)return t.data;return console.error("Error generating receipt number:",t.error),"000001"}catch(e){return console.error("Error generating receipt number:",e),"000001"}};var I=e.i(8745),k=e.i(726302);let P={description:"",quantity:1,price:0,cost:0},D={description:"",quantity:1,price:0,cost:0};var T=e.i(133583),A=e.i(649973),E=e.i(96539),L=e.i(83049),B=e.i(533398),F=e.i(893930),M=e.i(426119),R=e.i(939310),q=e.i(386408),$=e.i(369547);let _=(0,$.default)("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);var z=e.i(792042),U=e.i(229767),V=e.i(897837),O=e.i(348370),H=e.i(91762),K=e.i(353533);let Y=({selectedDate:e,onDateChange:a})=>(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"date",children:"Date"}),(0,t.jsxs)(O.Popover,{children:[(0,t.jsx)(O.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(R.Button,{variant:"outline",className:(0,K.cn)("w-full justify-start text-left font-normal",!e&&"text-muted-foreground"),children:[(0,t.jsx)(U.CalendarIcon,{className:"mr-2 h-4 w-4"}),e?(0,z.format)(e,"PPP"):(0,t.jsx)("span",{children:"Pick a date"})]})}),(0,t.jsx)(O.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(V.Calendar,{mode:"single",selected:e,onSelect:e=>{e&&a(new Date(e.getFullYear(),e.getMonth(),e.getDate(),12,0,0))},initialFocus:!0,className:(0,K.cn)("p-3 pointer-events-auto")})})]})]});var X=e.i(45124),Q=e.i(770084),W=e.i(690176),G=e.i(614913);let J=()=>{let[e,t]=(0,a.useState)([]),[s,r]=(0,a.useState)(!0),{currentBusiness:i}=(0,l.useBusiness)(),{user:o}=(0,n.useAuth)(),d=async()=>{if(!i){t([]),r(!1);return}try{let e=await (0,G.getCustomerCategoriesAction)(i.id);if(e.success&&e.data)t(e.data);else throw Error(e.error)}catch(e){console.error("Error fetching customer categories:",e),(0,c.toast)({title:"Error",description:"Failed to fetch customer categories",variant:"destructive"})}finally{r(!1)}};return(0,a.useEffect)(()=>{d()},[i]),{categories:e,isLoading:s,createCategory:async e=>{if(!i||!o)return(0,c.toast)({title:"Error",description:"No business selected or user not authenticated",variant:"destructive"}),!1;try{let t=await (0,G.createCustomerCategoryAction)(i.id,o.id,e);if(t.success)return(0,c.toast)({title:"Success",description:"Customer category created successfully"}),d(),!0;throw Error(t.error)}catch(e){return console.error("Error creating customer category:",e),(0,c.toast)({title:"Error",description:"Failed to create customer category",variant:"destructive"}),!1}},updateCategory:async(e,t)=>{try{let a=await (0,G.updateCustomerCategoryAction)(e,t);if(a.success)return(0,c.toast)({title:"Success",description:"Customer category updated successfully"}),d(),!0;throw Error(a.error)}catch(e){return console.error("Error updating customer category:",e),(0,c.toast)({title:"Error",description:"Failed to update customer category",variant:"destructive"}),!1}},deleteCategory:async e=>{try{let t=await (0,G.deleteCustomerCategoryAction)(e);if(t.success)return(0,c.toast)({title:"Success",description:"Customer category deleted successfully"}),d(),!0;throw Error(t.error)}catch(e){return console.error("Error deleting customer category:",e),(0,c.toast)({title:"Error",description:"Failed to delete customer category",variant:"destructive"}),!1}},refetch:d}},Z=({customerName:e,customerAddress:s,customerContact:n,notes:r="",onCustomerInfoChange:l,errors:i,customers:o=[],onAddNewCustomer:c,onSelectCustomer:d,selectedCategoryId:u,onCategoryChange:m})=>{let[h,x]=(0,a.useState)(!1),[p,g]=(0,a.useState)(""),[y,f]=(0,a.useState)(""),{categories:j}=J(),b=o?.filter(e=>e.fullName.toLowerCase().includes(p.toLowerCase()))||[];(0,a.useEffect)(()=>{if(g(e),e.trim()){let t=o.find(t=>t.fullName===e);if(t&&t.categoryId){let e=j.find(e=>e.id===t.categoryId);f(e?.name||"")}else f("")}else f("")},[e,o,j]),(0,a.useEffect)(()=>{if(u){let e=j.find(e=>e.id===u);f(e?.name||"")}else f("")},[u,j]);let N=e.trim()&&o.some(t=>t.fullName===e);return(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold",children:"Customer Information"}),(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"customerName",children:"Customer Name"}),(0,t.jsxs)("div",{className:"flex flex-col space-y-2 relative",children:[(0,t.jsx)(X.Input,{id:"customerName",name:"customerName",value:e,onChange:e=>{let t=e.target.value;g(t),l(e),t.trim()?x(!0):(x(!1),f(""),m&&m(""))},onFocus:()=>p.trim()&&x(!0),onBlur:()=>{setTimeout(()=>{x(!1)},200)},onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("customerAddress")?.focus())},className:(0,K.cn)(i.customerName?"border-red-500":"","w-full"),placeholder:"Start typing customer name...",autoComplete:"off"}),h&&(0,t.jsx)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border rounded-md shadow-lg z-50 max-h-60 overflow-y-auto",children:b.length>0?b.map(a=>{let s=(e=>{if(!e)return null;let t=j.find(t=>t.id===e);return t?.name||null})(a.categoryId||null);return(0,t.jsx)("div",{className:"px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b last:border-0 border-gray-100 dark:border-gray-700 transition-colors",onMouseDown:e=>{e.preventDefault();if(x(!1),d&&d(a),a.categoryId){let e=j.find(e=>e.id===a.categoryId);f(e?.name||""),m&&m(a.categoryId)}else f(""),m&&m("")},children:(0,t.jsx)("div",{className:"flex items-start justify-between gap-2",children:(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-0.5",children:[e===a.fullName&&(0,t.jsx)(Q.Check,{className:"h-4 w-4 text-green-500 shrink-0"}),(0,t.jsx)("span",{className:"font-medium text-sm truncate uppercase tracking-tight",children:a.fullName}),s&&(0,t.jsx)("span",{className:"text-[10px] font-bold bg-primary/10 text-primary px-1.5 py-0.5 rounded leading-none uppercase",children:s})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-x-3 gap-y-1 text-xs text-muted-foreground mt-1",children:[a.location&&(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{className:"opacity-70 italic text-[11px]",children:"at"})," ",a.location]}),a.phoneNumber&&(0,t.jsx)("span",{className:"flex items-center gap-1",children:(0,t.jsx)("span",{className:"opacity-70 tabular-nums",children:a.phoneNumber})})]})]})})},a.id)}):(0,t.jsxs)("div",{className:"px-4 py-6 text-center text-muted-foreground",children:[(0,t.jsx)("p",{className:"text-sm",children:"No customers found"}),(0,t.jsx)("p",{className:"text-xs opacity-70 mt-1",children:"Try a different search or add a new customer"})]})}),i.customerName&&(0,t.jsx)("p",{className:"text-red-500 text-xs",children:i.customerName})]})]}),(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"customerAddress",children:"Customer Address"}),(0,t.jsx)(X.Input,{id:"customerAddress",name:"customerAddress",value:s,onChange:l,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("customerContact")?.focus())}})]}),(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"customerContact",children:"Customer Contact"}),(0,t.jsx)(X.Input,{id:"customerContact",name:"customerContact",value:n,onChange:l,onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.getElementById("customerCategory"),a=document.querySelector('[role="combobox"]');t?t.focus():a?a.focus():document.getElementById("description-0")?.focus()}}})]}),(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"customerCategory",children:"Customer Category"}),N?(0,t.jsx)(X.Input,{id:"customerCategory",value:y,readOnly:!0,className:"bg-gray-50 dark:bg-gray-800",placeholder:"Category from existing customer",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("description-0")?.focus())}}):(0,t.jsxs)(W.Select,{value:u||"none",onValueChange:e=>{if("none"===e)f(""),m&&m("");else{let t=j.find(t=>t.id===e);t&&(f(t.name),m&&m(e))}},onOpenChange:e=>{e||setTimeout(()=>{document.getElementById("description-0")?.focus()},100)},children:[(0,t.jsx)(W.SelectTrigger,{onKeyDown:e=>{"Enter"===e.key&&setTimeout(()=>{document.getElementById("description-0")?.focus()},100)},children:(0,t.jsx)(W.SelectValue,{placeholder:"Select a category"})}),(0,t.jsxs)(W.SelectContent,{children:[(0,t.jsx)(W.SelectItem,{value:"none",children:"No Category"}),j.filter(e=>e.id&&""!==e.id.trim()).map(e=>(0,t.jsx)(W.SelectItem,{value:e.id,children:e.name},e.id))]})]})]}),c&&(0,t.jsx)(R.Button,{type:"button",variant:"outline",onClick:c,className:"w-full mt-2",children:"Add New Customer"})]})},ee=({isEditing:e,selectedDate:a,onDateChange:s,customerName:n,customerAddress:r,customerContact:l,notes:i,onCustomerInfoChange:c,errors:d,customers:u,onAddNewCustomer:m,onSelectCustomer:h,selectedCategoryId:x,onCategoryChange:p,onClearForm:g})=>{let y=(0,o.useRouter)();return(0,t.jsxs)(M.Card,{className:"mb-6",children:[(0,t.jsx)(M.CardHeader,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(R.Button,{variant:"ghost",size:"icon",onClick:()=>{y.push("/sales")},type:"button",className:"h-8 w-8",children:(0,t.jsx)(q.ArrowLeft,{className:"h-4 w-4"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)(M.CardTitle,{children:e?"Edit Sale":"New Sale"}),(0,t.jsx)(M.CardDescription,{children:"Enter the sale details below"})]})]}),!e&&g&&(0,t.jsxs)(R.Button,{variant:"outline",size:"sm",onClick:g,type:"button",className:"flex items-center gap-2",children:[(0,t.jsx)(_,{className:"h-4 w-4"}),"Clear Form"]})]})}),(0,t.jsxs)(M.CardContent,{className:"space-y-6",children:[(0,t.jsx)(Y,{selectedDate:a,onDateChange:s}),(0,t.jsx)(Z,{customerName:n,customerAddress:r,customerContact:l,notes:i,onCustomerInfoChange:c,errors:d,customers:u,onAddNewCustomer:m,onSelectCustomer:h,selectedCategoryId:x,onCategoryChange:p})]})]})};var et=e.i(972733),ea=e.i(443915),es=e.i(909289),en=e.i(450095),er=e.i(978757);let el=(0,$.default)("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);var ei=e.i(30691),eo=e.i(857274),ec=e.i(569479),ed=e.i(671185),eu=e.i(479293),em=e.i(55037),eh=e.i(776833),ex=e.i(357006),ep=e.i(674534),eg=e.i(993953),ey=e.i(64592),ef="Collapsible",[ej,eb]=(0,eu.createContextScope)(ef),[eN,ev]=ej(ef),eC=a.forwardRef((e,s)=>{let{__scopeCollapsible:n,open:r,defaultOpen:l,disabled:i,onOpenChange:o,...c}=e,[d,u]=(0,em.useControllableState)({prop:r,defaultProp:l??!1,onChange:o,caller:ef});return(0,t.jsx)(eN,{scope:n,disabled:i,contentId:(0,ey.useId)(),open:d,onOpenToggle:a.useCallback(()=>u(e=>!e),[u]),children:(0,t.jsx)(ep.Primitive.div,{"data-state":eD(d),"data-disabled":i?"":void 0,...c,ref:s})})});eC.displayName=ef;var eS="CollapsibleTrigger",ew=a.forwardRef((e,a)=>{let{__scopeCollapsible:s,...n}=e,r=ev(eS,s);return(0,t.jsx)(ep.Primitive.button,{type:"button","aria-controls":r.contentId,"aria-expanded":r.open||!1,"data-state":eD(r.open),"data-disabled":r.disabled?"":void 0,disabled:r.disabled,...n,ref:a,onClick:(0,ed.composeEventHandlers)(e.onClick,r.onOpenToggle)})});ew.displayName=eS;var eI="CollapsibleContent",ek=a.forwardRef((e,a)=>{let{forceMount:s,...n}=e,r=ev(eI,e.__scopeCollapsible);return(0,t.jsx)(eg.Presence,{present:s||r.open,children:({present:e})=>(0,t.jsx)(eP,{...n,ref:a,present:e})})});ek.displayName=eI;var eP=a.forwardRef((e,s)=>{let{__scopeCollapsible:n,present:r,children:l,...i}=e,o=ev(eI,n),[c,d]=a.useState(r),u=a.useRef(null),m=(0,ex.useComposedRefs)(s,u),h=a.useRef(0),x=h.current,p=a.useRef(0),g=p.current,y=o.open||c,f=a.useRef(y),j=a.useRef(void 0);return a.useEffect(()=>{let e=requestAnimationFrame(()=>f.current=!1);return()=>cancelAnimationFrame(e)},[]),(0,eh.useLayoutEffect)(()=>{let e=u.current;if(e){j.current=j.current||{transitionDuration:e.style.transitionDuration,animationName:e.style.animationName},e.style.transitionDuration="0s",e.style.animationName="none";let t=e.getBoundingClientRect();h.current=t.height,p.current=t.width,f.current||(e.style.transitionDuration=j.current.transitionDuration,e.style.animationName=j.current.animationName),d(r)}},[o.open,r]),(0,t.jsx)(ep.Primitive.div,{"data-state":eD(o.open),"data-disabled":o.disabled?"":void 0,id:o.contentId,hidden:!y,...i,ref:m,style:{"--radix-collapsible-content-height":x?`${x}px`:void 0,"--radix-collapsible-content-width":g?`${g}px`:void 0,...e.style},children:y&&l})});function eD(e){return e?"open":"closed"}var eT=e.i(599875),eA=e.i(928936),eE=e.i(89635);let eL=({item:e,index:s,onUpdate:i,onRemove:o,saleDate:c})=>{let d,u,{settings:m}=(0,r.useBusinessSettings)(),h=m.currency||"USD",{user:x}=(0,n.useAuth)(),{currentBusiness:g}=(0,l.useBusiness)(),{canViewCostPrice:y,canViewSellingPrice:f,formatFinancial:j}=(0,eE.useFinancialVisibility)(),[b,N]=(0,a.useState)(e.description||""),v=(0,ei.useIsMobile)(),[C,S]=(0,a.useState)(!1),[w,k]=(0,a.useState)(!1),[P,D]=(0,a.useState)((0,K.formatNumberInput)(e.quantity?.toString()||"0")),[T,A]=(0,a.useState)((0,K.formatNumberInput)(e.price?.toString()||"0")),[E,L]=(0,a.useState)((0,K.formatNumberInput)(e.cost?.toString()||"0")),[B,M]=(0,a.useState)((0,K.formatNumberInput)(e.discountAmount?.toString()||"0")),[q,$]=(0,a.useState)((0,K.formatNumberInput)(e.discountPercentage?.toString()||"0")),[_,z]=(0,a.useState)(e.description||"");(0,a.useEffect)(()=>{let e=setTimeout(()=>{z(b)},300);return()=>clearTimeout(e)},[b]);let{data:U=[]}=(0,F.useQuery)({queryKey:["all-products",x?.id,g?.id],queryFn:async()=>x?.id&&g?.id?await (0,I.getAllProductsAction)(x.id,g.id):[],enabled:!!x?.id&&!!g?.id,staleTime:3e5}),V=(0,a.useMemo)(()=>_.trim()?U.filter(e=>(0,eA.matchProductSearch)(e,_)).slice(0,20):[],[U,_]);(0,a.useEffect)(()=>{N(e.description||""),Math.abs((parseFloat(P.replace(/,/g,""))||0)-e.quantity)>.001&&D(0===e.quantity&&""===P?"":e.quantity.toString()),Math.abs((parseFloat(T.replace(/,/g,""))||0)-e.price)>.001&&A(0===e.price&&""===T?"":e.price.toString()),Math.abs((parseFloat(E.replace(/,/g,""))||0)-e.cost)>.001&&L(0===e.cost&&""===E?"":e.cost.toString()),Math.abs((parseFloat(B.replace(/,/g,""))||0)-(e.discountAmount||0))>.001&&M(e.discountAmount?.toString()||"0"),Math.abs((parseFloat(q.replace(/,/g,""))||0)-(e.discountPercentage||0))>.001&&$(e.discountPercentage?.toString()||"0")},[e.description,e.quantity,e.price,e.cost,e.discountAmount,e.discountPercentage]);let Y=e.price*e.quantity,Q="amount"===e.discountType?e.discountAmount||0:Y*(e.discountPercentage||0)/100,W=t=>{let{name:a,value:n}=t.target;if("description"===a){N(n),k(""!==n.trim());return}let r=(0,K.formatNumberInput)(n),l=(0,K.parseNumberInput)(n);if("quantity"===a){D(r),i(s,{...e,quantity:l});return}if("price"===a){A(r),i(s,{...e,price:l});return}if("cost"===a){L(r),i(s,{...e,cost:l});return}if("discountAmount"===a){M(r),i(s,{...e,discountAmount:l});return}if("discountPercentage"===a){$(r),i(s,{...e,discountPercentage:l});return}i(s,{...e,[a]:l})},G=t=>{let a=(0,K.parseNumberInput)(t.target.value)/(e.quantity||1);L((0,K.formatNumberInput)(a.toString())),i(s,{...e,cost:a})},J=e.productId?V.find(t=>t.id===e.productId):null,Z=J&&c&&(d=new Date(J.createdAt),u=new Date(c).setHours(0,0,0,0),new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime()>u);return(0,t.jsxs)("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[(0,t.jsxs)("div",{className:"flex justify-between items-start",children:[(0,t.jsxs)("h3",{className:"text-sm font-medium",children:["Item ",s+1]}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsxs)(R.Button,{variant:"outline",size:"sm",onClick:()=>{N(""),k(!1),e.quantity;let t={...e,description:"",price:0,cost:0,productId:null,discountAmount:0,discountPercentage:0};A("0"),L("0"),M("0"),$("0"),i(s,t),p.toast.success("Item cleared")},className:"text-gray-600 hover:text-gray-800",children:[(0,t.jsx)(el,{className:"h-4 w-4 mr-1"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Clear"})]}),(0,t.jsxs)(R.Button,{variant:"ghost",size:"sm",onClick:()=>o(s),className:"text-destructive hover:text-destructive",children:[(0,t.jsx)(es.Trash2,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"sr-only",children:"Remove Item"})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`description-${s}`,className:"text-sm font-medium",children:"Product / Service"}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsxs)("div",{className:"flex-grow relative",children:[(0,t.jsx)(ea.Textarea,{id:`description-${s}`,name:"description",value:b,onChange:W,placeholder:"Enter product name",onFocus:()=>""!==b.trim()&&k(!0),onBlur:()=>{b!==e.description&&i(s,{...e,description:b})},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),document.getElementById(`quantity-${s}`)?.focus())},className:v?"min-h-16 text-base":""}),w&&""!==b.trim()&&V.length>0&&(0,t.jsx)("div",{className:"absolute z-10 mt-1 w-full bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:V.map(a=>(0,t.jsxs)("div",{className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center",onClick:()=>{N(a.name),k(!1),A((0,K.formatNumberInput)(a.sellingPrice.toString())),L((0,K.formatNumberInput)(a.costPrice.toString())),i(s,{...e,description:a.name,price:a.sellingPrice,cost:a.costPrice,productId:a.id})},children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)(eo.default,{imageUrl:a.imageUrl,alt:a.name,size:"sm"}),(0,t.jsxs)("div",{className:"ml-3",children:[(0,t.jsxs)("div",{className:"font-medium flex items-center gap-2",children:[a.name,a.category&&(0,t.jsx)(eT.Badge,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-4 bg-gray-100 text-gray-500 font-normal",children:a.category})]}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:f?`${h} ${a.sellingPrice.toFixed(2)}`:"Price Hidden"})]})]}),(0,t.jsxs)("div",{className:"text-xs",children:[parseFloat(a.quantity.toFixed(5)).toString()," in stock"]})]},a.id))})]}),Z&&(0,t.jsxs)("div",{className:"mt-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[(0,t.jsx)("p",{className:"text-sm text-red-700 font-medium",children:"ðŸš« Error: This product was created after the sale date. The sale cannot be created or updated."}),(0,t.jsx)("p",{className:"text-xs text-red-600 mt-1",children:"Please adjust the sale date or select a different product to continue."})]})]})]}),v?(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`quantity-${s}`,className:"text-sm font-medium",children:"Quantity"}),(0,t.jsx)(X.Input,{id:`quantity-${s}`,name:"quantity",type:"text",inputMode:"decimal",value:P,onChange:W,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById(`price-${s}`)?.focus())},className:"h-12 text-lg"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`price-${s}`,className:"text-sm font-medium",children:"Price per unit"}),(0,t.jsx)(X.Input,{id:`price-${s}`,name:"price",type:"text",inputMode:"decimal",value:T,onChange:W,onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.getElementById(`price-${s}`);t?.focus()}},className:"h-12 text-lg"})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(H.Label,{className:"text-sm font-medium",children:"Discount"}),(0,t.jsxs)("select",{value:e.discountType||"percentage",onChange:t=>{let a=t.target.value,n={...e,discountType:a};"percentage"===a?(n.discountAmount=0,M("0")):(n.discountPercentage=0,$("0")),i(s,n)},className:"flex-shrink-0 w-12 h-8 text-xs border border-input bg-background px-1 rounded-md",children:[(0,t.jsx)("option",{value:"percentage",children:"%"}),(0,t.jsx)("option",{value:"amount",children:h})]})]}),(0,t.jsx)(X.Input,{name:"amount"===e.discountType?"discountAmount":"discountPercentage",type:"text",inputMode:"decimal",value:"amount"===e.discountType?B:q,onChange:W,placeholder:"0",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("taxRate")?.focus())},className:"h-12 text-lg"})]}),y&&(0,t.jsx)("div",{className:"space-y-2",children:(0,t.jsxs)(eC,{open:C,onOpenChange:S,children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(H.Label,{className:"text-sm font-medium text-gray-500",children:"Cost Info"}),(0,t.jsx)(ew,{asChild:!0,children:(0,t.jsx)(R.Button,{variant:"ghost",size:"sm",className:"p-1 h-8 w-8",children:C?(0,t.jsx)(er.EyeOff,{className:"h-4 w-4 text-gray-500"}):(0,t.jsx)(en.Eye,{className:"h-4 w-4 text-gray-500"})})})]}),(0,t.jsxs)(ek,{className:"space-y-4 pt-2",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`cost-${s}`,className:"text-xs text-gray-500",children:"Cost per unit"}),(0,t.jsx)(X.Input,{id:`cost-${s}`,name:"cost",type:"text",inputMode:"decimal",value:E,onChange:W,className:"h-12 text-lg"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`total-cost-${s}`,className:"text-xs text-gray-500",children:"Total Cost"}),(0,t.jsx)(X.Input,{id:`total-cost-${s}`,name:"totalCost",type:"text",inputMode:"decimal",value:(0,K.formatNumber)(e.cost*e.quantity),onChange:G,className:"h-12 text-lg font-semibold bg-gray-50"})]}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"(Internal use only)"})]})]})})]})]}):(0,t.jsxs)("div",{className:"grid grid-cols-4 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`quantity-${s}`,children:"Quantity"}),(0,t.jsx)(X.Input,{id:`quantity-${s}`,name:"quantity",type:"text",inputMode:"decimal",value:P,onChange:W,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById(`price-${s}`)?.focus())}})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`price-${s}`,children:"Price per unit"}),(0,t.jsx)(X.Input,{id:`price-${s}`,name:"price",type:"text",inputMode:"decimal",value:T,onChange:W,onKeyDown:t=>{if("Enter"===t.key){t.preventDefault();let a=document.querySelector(`input[name="${"amount"===e.discountType?"discountAmount":"discountPercentage"}"]`);a?.focus()}}})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{children:"Discount"}),(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsxs)("select",{value:e.discountType||"percentage",onChange:t=>{let a=t.target.value,n={...e,discountType:a};"percentage"===a?(n.discountAmount=0,M("0")):(n.discountPercentage=0,$("0")),i(s,n)},className:"flex-shrink-0 w-12 text-xs border border-input bg-background px-1 py-2 rounded-md",children:[(0,t.jsx)("option",{value:"percentage",children:"%"}),(0,t.jsx)("option",{value:"amount",children:h})]}),(0,t.jsx)(X.Input,{name:"amount"===e.discountType?"discountAmount":"discountPercentage",type:"text",inputMode:"decimal",value:"amount"===e.discountType?B:q,onChange:W,placeholder:"0",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("taxRate")?.focus())},className:"flex-1"})]})]}),y&&(0,t.jsx)("div",{className:"space-y-2",children:(0,t.jsxs)(O.Popover,{children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(H.Label,{className:"text-gray-500",children:"Cost Info"}),(0,t.jsx)(ec.TooltipProvider,{children:(0,t.jsxs)(ec.Tooltip,{children:[(0,t.jsx)(ec.TooltipTrigger,{asChild:!0,children:(0,t.jsx)(O.PopoverTrigger,{asChild:!0,children:(0,t.jsx)(R.Button,{variant:"ghost",size:"sm",className:"p-0 h-6 w-6",children:(0,t.jsx)(en.Eye,{className:"h-4 w-4 text-gray-500"})})})}),(0,t.jsx)(ec.TooltipContent,{children:(0,t.jsx)("p",{children:"Click to view/edit cost"})})]})})]}),(0,t.jsx)(O.PopoverContent,{className:"w-64 p-4 bg-white shadow-xl border",children:(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:`cost-popover-${s}`,className:"text-xs",children:"Cost per unit"}),(0,t.jsx)(X.Input,{id:`cost-popover-${s}`,name:"cost",type:"text",inputMode:"decimal",value:E,onChange:W})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(H.Label,{htmlFor:`total-cost-popover-${s}`,className:"text-xs",children:["Total Cost (for ",e.quantity," units)"]}),(0,t.jsx)(X.Input,{id:`total-cost-popover-${s}`,name:"totalCost",type:"text",value:(0,K.formatNumber)(e.cost*e.quantity),onChange:G,className:"font-bold bg-gray-50"})]}),(0,t.jsx)("div",{className:"pt-2 border-t",children:(0,t.jsx)("p",{className:"text-[10px] text-muted-foreground",children:"Costs entered here only apply to this specific sale and do not change the product's base price in inventory."})})]})})]})})]}),(0,t.jsx)("div",{className:"pt-2 border-t mt-2",children:(0,t.jsxs)("div",{className:"flex justify-end items-center space-y-1 flex-col",children:[((e.discountPercentage||0)>0||(e.discountAmount||0)>0)&&(0,t.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,t.jsx)("span",{className:"text-xs text-muted-foreground mr-2",children:"Subtotal:"}),(0,t.jsxs)("span",{className:"text-xs text-muted-foreground line-through",children:[h," ",(0,K.formatNumber)(Y)]})]}),((e.discountPercentage||0)>0||(e.discountAmount||0)>0)&&(0,t.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,t.jsxs)("span",{className:"text-xs text-green-600 mr-2",children:["Discount ","amount"===e.discountType?"":`(${e.discountPercentage}%)`,":"]}),(0,t.jsxs)("span",{className:"text-xs text-green-600",children:["-",h," ",(0,K.formatNumber)(Q)]})]}),(0,t.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,t.jsx)("span",{className:"text-sm font-medium mr-2",children:"Total:"}),(0,t.jsxs)("span",{className:"text-sm font-bold",children:[h," ",(0,K.formatNumber)(Y-Q)]})]})]})})]})},eB=({items:e,onAddItem:a,onUpdateItem:s,onRemoveItem:n,saleDate:r})=>(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold",children:"Items/Services"}),(0,t.jsxs)("div",{className:"space-y-4",children:[e.map((e,a)=>(0,t.jsx)("div",{id:`sale-item-${a}`,children:(0,t.jsx)(eL,{item:e,index:a,onUpdate:s,onRemove:n,saleDate:r})},a)),(0,t.jsxs)(R.Button,{type:"button",variant:"outline",size:"sm",onClick:()=>a(),className:"gap-1 w-full mt-2",children:[(0,t.jsx)(et.Plus,{className:"h-4 w-4"}),"Add Item"]})]})]}),eF=({taxRateInput:e,onTaxRateChange:a,errors:s})=>(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"taxRate",children:"Tax Rate (%)"}),(0,t.jsx)(X.Input,{id:"taxRate",name:"taxRate",type:"text",inputMode:"decimal",value:e,onChange:a,onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.querySelector('[data-payment-status-select="true"]');if(t)t.focus();else{let e=document.querySelector('button[type="submit"]');e?.focus()}}},className:s.taxRate?"border-red-500":""}),s.taxRate&&(0,t.jsx)("p",{className:"text-red-500 text-xs",children:s.taxRate})]}),eM=({totalAmount:e,taxAmount:a,grandTotal:s,taxRate:n,currency:r})=>(0,t.jsx)("div",{className:"bg-slate-50 p-4 rounded-md border",children:(0,t.jsxs)("div",{className:"flex flex-col space-y-2",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,t.jsx)("h3",{className:"font-medium",children:"Subtotal"}),(0,t.jsxs)("span",{className:"font-medium",children:[r," ",(0,K.formatNumber)(e)]})]}),n>0&&(0,t.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,t.jsxs)("h3",{className:"font-medium",children:["Tax (",n,"%)"]}),(0,t.jsxs)("span",{className:"font-medium",children:[r," ",(0,K.formatNumber)(a)]})]}),(0,t.jsx)("div",{className:"h-px bg-gray-300 my-1"}),(0,t.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Grand Total"}),(0,t.jsxs)("span",{className:"text-xl font-bold",children:[r," ",(0,K.formatNumber)(s)]})]})]})}),eR=({items:e,onAddItem:s,onUpdateItem:n,onRemoveItem:r,taxRateInput:l,onTaxRateChange:i,errors:o,totalAmount:c,taxAmount:d,grandTotal:u,taxRate:m,currency:h,saleDate:x})=>{let p=a.default.useRef(e);return a.default.useEffect(()=>{let t=p.current,a=-1;e.length>t.length?a=e.length-1:e.length===t.length&&(a=e.findIndex((e,a)=>{let s=t[a];return s&&e.quantity!==s.quantity})),p.current=e,-1!==a&&setTimeout(()=>{let e=document.getElementById(`sale-item-${a}`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})},150)},[e]),(0,t.jsx)(M.Card,{className:"mb-6",children:(0,t.jsxs)(M.CardContent,{className:"pt-6 space-y-6",children:[(0,t.jsx)(eB,{items:e,onAddItem:s,onUpdateItem:n,onRemoveItem:r,saleDate:x}),(0,t.jsx)(eF,{taxRateInput:l,onTaxRateChange:i,errors:o}),(0,t.jsx)(eM,{totalAmount:c,taxAmount:d,grandTotal:u,taxRate:m,currency:h})]})})},eq=({paymentStatus:e,onPaymentStatusChange:a})=>(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"paymentStatus",children:"Payment Status"}),(0,t.jsxs)(W.Select,{value:e,onValueChange:a,children:[(0,t.jsx)(W.SelectTrigger,{className:"w-full","data-payment-status-select":"true",onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.querySelector('[data-cash-account-switch="true"]');if(t)t.focus();else{let e=document.querySelector('button[type="submit"]');e?.focus()}}},children:(0,t.jsx)(W.SelectValue,{placeholder:"Select payment status"})}),(0,t.jsxs)(W.SelectContent,{children:[(0,t.jsx)(W.SelectItem,{value:"Paid",children:"Paid"}),(0,t.jsx)(W.SelectItem,{value:"NOT PAID",children:"NOT PAID"}),(0,t.jsx)(W.SelectItem,{value:"Quote",children:"Quote"}),(0,t.jsx)(W.SelectItem,{value:"Installment Sale",children:"Installment Sale"})]})]})]});var e$=e.i(518466),e_=e.i(756043),ez=e.i(868462);let eU=(0,$.default)("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]),eV=(0,$.default)("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]),eO=({payments:e,currency:s,isLoading:n,pendingChanges:r=[],isLocalMode:l=!1,onStageChange:i,cashAccounts:o=[],onLinkToCash:c,onUpdatePayment:d})=>{let[u,m]=(0,a.useState)(null),[h,x]=(0,a.useState)(null),[p,g]=(0,a.useState)(""),[y,f]=(0,a.useState)(""),[j,b]=(0,a.useState)(void 0),[N,v]=(0,a.useState)(null),[C,S]=(0,a.useState)(""),w=(e,t)=>{m(e.id),x(t||null),g(E(e).toString()),f(L(e)||""),b(e.paymentDate)},I=async e=>{d&&"deleted"!==A(e.id)&&w(e,"date")},k=async(e,t)=>{if(t&&d){console.log("ðŸ”µ Date selected:",{paymentId:e.id,oldDate:e.paymentDate,newDate:t,formattedNew:(0,z.format)(t,"yyyy-MM-dd")});try{await d(e.id,{paymentDate:t}),console.log("âœ… Date update successful"),i&&i({id:e.id,type:"update",originalPayment:e,updatedData:{paymentDate:t}}),m(null),x(null),b(void 0)}catch(t){console.error("âŒ Error updating payment date:",t),b(e.paymentDate)}}},P=async e=>{if(!i&&!d)return;let t=""===p?0:parseFloat(p)||0;i?i({id:e.id,type:"update",originalPayment:e,updatedData:{amount:t,notes:y.trim()||void 0}}):d&&await d(e.id,{amount:"amount"===h?t:void 0,notes:"notes"===h&&y.trim()||void 0}),m(null),x(null)},D=()=>{m(null),x(null),g(""),f(""),b(void 0)},T=e=>{if(!i)return;let t=0===e.amount;window.confirm(t?"Are you sure you want to remove this zero-amount payment entry?":"Are you sure you want to mark this payment for deletion?")&&(console.log("ðŸŸ¡ STAGING deletion locally - NO DATABASE CALL"),i({id:e.id,type:"delete",originalPayment:e}),console.log("âœ… Deletion staged successfully"))},A=e=>{let t=r.find(t=>t.id===e);return t?.type==="delete"?"deleted":t?.type==="update"?"modified":"original"},E=e=>{let t=r.find(t=>t.id===e.id&&"update"===t.type);return t?.updatedData?.amount||e.amount},L=e=>{let t=r.find(t=>t.id===e.id&&"update"===t.type);return t?.updatedData?.notes||e.notes},B=e=>!!l&&!!i&&"deleted"!==A(e.id),F=e=>{v(e),S("")},q=()=>{v(null),S("")},$=async e=>{if(c&&C)try{await c(e.id,C),v(null),S("")}catch(e){console.error("Error linking payment to cash account:",e)}};if(n)return(0,t.jsxs)(M.Card,{className:"border-blue-200 bg-blue-50",children:[(0,t.jsx)(M.CardHeader,{className:"pb-3",children:(0,t.jsx)(M.CardTitle,{className:"text-sm text-blue-800",children:"Payment History"})}),(0,t.jsx)(M.CardContent,{children:(0,t.jsx)("div",{className:"text-sm text-muted-foreground",children:"Loading payment history..."})})]});if(0===e.length)return(0,t.jsxs)(M.Card,{className:"border-blue-200 bg-blue-50",children:[(0,t.jsx)(M.CardHeader,{className:"pb-3",children:(0,t.jsx)(M.CardTitle,{className:"text-sm text-blue-800",children:"Payment History"})}),(0,t.jsx)(M.CardContent,{children:(0,t.jsx)("div",{className:"text-sm text-muted-foreground",children:"No payments recorded yet"})})]});let _=e.reduce((e,t)=>"deleted"===A(t.id)?e:e+E(t),0),H=l&&i;return console.log("InstallmentPaymentHistory - isLocalMode:",l,"onStageChange:",!!i,"showInlineEdit:",H),(0,t.jsxs)(M.Card,{className:"border-blue-200 bg-blue-50",children:[(0,t.jsx)(M.CardHeader,{className:"pb-3",children:(0,t.jsxs)(M.CardTitle,{className:"text-sm text-blue-800 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:["Payment History",l&&(0,t.jsx)(e_.Clock,{className:"h-3 w-3 text-amber-600"}),r.length>0&&(0,t.jsxs)(eT.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:[r.length," staged"]})]}),(0,t.jsxs)(eT.Badge,{variant:"secondary",className:"bg-blue-100 text-blue-800 text-xs",children:["Total: ",s," ",(0,K.formatNumber)(_)]})]})}),(0,t.jsxs)(M.CardContent,{className:"p-3 sm:p-6",children:[H&&(0,t.jsx)("div",{className:"hidden sm:block mb-4 text-xs text-muted-foreground bg-blue-50 p-2 rounded border border-blue-200",children:"ðŸ’¡ Double-click on amount or notes to edit. Click delete button to remove payments (including zero amounts)."}),(0,t.jsx)("div",{className:"block sm:hidden space-y-3",children:e.map(e=>{let a=A(e.id),n=E(e),r=L(e),l=u===e.id,i=B(e);return(0,t.jsxs)("div",{className:`bg-white rounded-lg p-3 border shadow-sm ${"deleted"===a?"border-red-200 bg-red-50 opacity-60":"modified"===a?"border-amber-200 bg-amber-50":"border-gray-200"}`,children:[(0,t.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[l&&"date"===h?(0,t.jsxs)(O.Popover,{children:[(0,t.jsx)(O.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(R.Button,{variant:"outline",size:"sm",className:(0,K.cn)("h-7 text-xs justify-start text-left font-normal",!j&&"text-muted-foreground"),children:[(0,t.jsx)(U.CalendarIcon,{className:"mr-2 h-3 w-3"}),j?(0,z.format)(j,"MMM dd, yyyy"):(0,t.jsx)("span",{children:"Pick a date"})]})}),(0,t.jsx)(O.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(V.Calendar,{mode:"single",selected:j,onSelect:t=>k(e,t),initialFocus:!0,className:(0,K.cn)("p-3 pointer-events-auto")})})]}):(0,t.jsx)("div",{className:`text-xs text-muted-foreground ${d?"cursor-pointer hover:text-blue-600":""}`,onClick:()=>d&&I(e),title:d?"Click to edit date":"",children:(0,z.format)(e.paymentDate,"MMM dd, yyyy")}),"deleted"===a&&(0,t.jsx)(eT.Badge,{variant:"outline",className:"text-xs bg-red-100 text-red-800 border-red-300",children:"To Delete"}),"modified"===a&&(0,t.jsx)(eT.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:"Modified"})]}),l&&"amount"===h?(0,t.jsx)("div",{className:"flex flex-col gap-2 min-w-0 flex-1 ml-2",children:(0,t.jsx)(X.Input,{type:"number",value:p,onChange:e=>g(e.target.value),className:"h-7 text-xs",step:"0.01",min:"0",placeholder:"0"})}):(0,t.jsxs)("div",{className:`text-sm font-semibold ${"deleted"===a?"line-through":""}`,children:[s," ",(0,K.formatNumber)(n)]})]}),l?(0,t.jsxs)("div",{className:"space-y-2",children:["notes"===h&&(0,t.jsx)(X.Input,{value:y,onChange:e=>f(e.target.value),placeholder:"Payment notes",className:"h-7 text-xs"}),(0,t.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,t.jsx)(R.Button,{size:"sm",variant:"outline",className:"h-6 px-2 text-xs",onClick:D,children:(0,t.jsx)(ez.X,{className:"h-3 w-3"})}),(0,t.jsx)(R.Button,{size:"sm",className:"h-6 px-2 text-xs",onClick:()=>P(e),children:(0,t.jsx)(Q.Check,{className:"h-3 w-3"})})]})]}):(0,t.jsxs)(t.Fragment,{children:[r&&(0,t.jsx)("div",{className:`text-xs text-muted-foreground mb-3 ${"deleted"===a?"line-through":""} ${d?"cursor-pointer hover:text-blue-600":""}`,onClick:()=>d&&w(e,"notes"),title:d?"Click to edit notes":"",children:r}),(0,t.jsxs)("div",{className:"mb-3",children:[(0,t.jsx)("div",{className:"text-xs text-muted-foreground mb-1",children:"Cash Account:"}),N===e.id?(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(W.Select,{value:C,onValueChange:S,children:[(0,t.jsx)(W.SelectTrigger,{className:"h-7 text-xs flex-1",children:(0,t.jsx)(W.SelectValue,{placeholder:"Select account"})}),(0,t.jsx)(W.SelectContent,{children:o.map(e=>(0,t.jsx)(W.SelectItem,{value:e.id,children:(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("span",{children:e.name}),e.isDefault&&(0,t.jsx)("span",{className:"ml-1 text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded",children:"Default"})]})},e.id))})]}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-gray-500 hover:text-gray-700",onClick:q,children:(0,t.jsx)(ez.X,{className:"h-3 w-3"})}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-green-500 hover:text-green-700",onClick:()=>$(e),disabled:!C,children:(0,t.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,t.jsx)("div",{className:"flex items-center gap-2",children:e.cashTransactionId?(0,t.jsx)(eT.Badge,{variant:"outline",className:"text-xs bg-green-100 text-green-800 border-green-300",children:"Linked"}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"Not linked"}),c&&o.length>0&&(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-blue-500 hover:text-blue-700",onClick:()=>F(e.id),title:"Link to cash account",children:(0,t.jsx)(eV,{className:"h-3 w-3"})})]})})]}),H&&i&&(0,t.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,t.jsxs)(R.Button,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs text-blue-600 hover:text-blue-700 border-blue-200 hover:border-blue-300",onClick:()=>w(e),children:[(0,t.jsx)(eU,{className:"h-3 w-3 mr-1"}),"Edit"]}),(0,t.jsxs)(R.Button,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs text-red-600 hover:text-red-700 border-red-200 hover:border-red-300",onClick:()=>T(e),children:[(0,t.jsx)(es.Trash2,{className:"h-3 w-3 mr-1"}),"Delete"]})]})]})]},e.id)})}),(0,t.jsx)("div",{className:"hidden sm:block overflow-x-auto",children:(0,t.jsxs)(e$.Table,{children:[(0,t.jsx)(e$.TableHeader,{children:(0,t.jsxs)(e$.TableRow,{children:[(0,t.jsx)(e$.TableHead,{className:"text-xs",children:"Date"}),(0,t.jsx)(e$.TableHead,{className:"text-xs text-right",children:"Amount"}),(0,t.jsx)(e$.TableHead,{className:"text-xs",children:"Notes"}),(0,t.jsx)(e$.TableHead,{className:"text-xs",children:"Cash Account"}),H&&(0,t.jsx)(e$.TableHead,{className:"text-xs w-16",children:"Actions"})]})}),(0,t.jsx)(e$.TableBody,{children:e.map(e=>{let a=A(e.id),n=E(e),r=L(e),m=u===e.id,x=B(e);return(0,t.jsxs)(e$.TableRow,{className:"deleted"===a?"bg-red-50 opacity-60":"modified"===a?"bg-amber-50":"",children:[(0,t.jsx)(e$.TableCell,{className:"text-xs",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[u===e.id&&"date"===h?(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsxs)(O.Popover,{children:[(0,t.jsx)(O.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(R.Button,{variant:"outline",size:"sm",className:(0,K.cn)("h-7 text-xs justify-start text-left font-normal w-32",!j&&"text-muted-foreground"),children:[(0,t.jsx)(U.CalendarIcon,{className:"mr-2 h-3 w-3"}),j?(0,z.format)(j,"MMM dd, yyyy"):(0,t.jsx)("span",{children:"Pick a date"})]})}),(0,t.jsx)(O.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(V.Calendar,{mode:"single",selected:j,onSelect:t=>k(e,t),initialFocus:!0,className:(0,K.cn)("p-3 pointer-events-auto")})})]}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,t.jsx)(ez.X,{className:"h-3 w-3"})}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>P(e),children:(0,t.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,t.jsx)("span",{className:`cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===a?"line-through":""} ${d?"hover:bg-blue-50":""}`,onClick:()=>d&&I(e),title:d?"Click to edit date":"",children:(0,z.format)(e.paymentDate,"MMM dd, yyyy")}),"deleted"===a&&(0,t.jsx)(eT.Badge,{variant:"outline",className:"text-xs bg-red-100 text-red-800 border-red-300",children:"To Delete"}),"modified"===a&&(0,t.jsx)(eT.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:"Modified"})]})}),(0,t.jsx)(e$.TableCell,{className:"text-xs text-right",children:m&&"amount"===h?(0,t.jsxs)("div",{className:"flex items-center gap-1 justify-end",children:[(0,t.jsx)(X.Input,{type:"number",value:p,onChange:e=>g(e.target.value),className:"h-7 text-xs w-24",step:"0.01",min:"0",autoFocus:!0,placeholder:"0"}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,t.jsx)(ez.X,{className:"h-3 w-3"})}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>P(e),children:(0,t.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,t.jsxs)("span",{className:`font-medium cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===a?"line-through":""} ${H&&x?"hover:bg-blue-50":""}`,onDoubleClick:()=>{!l||!i||"deleted"!==A(e.id)&&w(e,"amount")},title:H&&x?"Double-click to edit":"",children:[s," ",(0,K.formatNumber)(n)]})}),(0,t.jsx)(e$.TableCell,{className:"text-xs",children:m&&"notes"===h?(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)(X.Input,{value:y,onChange:e=>f(e.target.value),placeholder:"Payment notes",className:"h-7 text-xs",autoFocus:!0}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,t.jsx)(ez.X,{className:"h-3 w-3"})}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>P(e),children:(0,t.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,t.jsx)("span",{className:`text-muted-foreground cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===a?"line-through":""} ${H&&x?"hover:bg-blue-50":""}`,onDoubleClick:()=>{!l||!i||"deleted"!==A(e.id)&&w(e,"notes")},title:H&&x?"Double-click to edit":"",children:r||"-"})}),(0,t.jsx)(e$.TableCell,{className:"text-xs",children:N===e.id?(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsxs)(W.Select,{value:C,onValueChange:S,children:[(0,t.jsx)(W.SelectTrigger,{className:"h-7 text-xs w-32",children:(0,t.jsx)(W.SelectValue,{placeholder:"Select account"})}),(0,t.jsx)(W.SelectContent,{children:o.map(e=>(0,t.jsx)(W.SelectItem,{value:e.id,children:(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("span",{children:e.name}),e.isDefault&&(0,t.jsx)("span",{className:"ml-1 text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded",children:"Default"})]})},e.id))})]}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:q,children:(0,t.jsx)(ez.X,{className:"h-3 w-3"})}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>$(e),disabled:!C,children:(0,t.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,t.jsx)("div",{className:"flex items-center gap-1",children:e.cashTransactionId?(0,t.jsx)(eT.Badge,{variant:"outline",className:"text-xs bg-green-100 text-green-800 border-green-300",children:"Linked"}):c&&o.length>0&&(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-blue-500 hover:text-blue-700",onClick:()=>F(e.id),title:"Link to cash account",children:(0,t.jsx)(eV,{className:"h-3 w-3"})})})}),H&&(0,t.jsx)(e$.TableCell,{className:"text-xs",children:!m&&x&&(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-red-500 hover:text-red-700",onClick:()=>T(e),title:"Delete payment",children:(0,t.jsx)(es.Trash2,{className:"h-3 w-3"})})})]},e.id)})})]})})]})]})},eH=({amountPaid:e,amountDue:s,grandTotal:n,currency:r,onAmountPaidChange:l,onPaymentDateChange:i,paymentDate:o,maxAmount:c,saleId:d,onPaymentStatusChange:u,isEditing:m=!1,payments:h=[],pendingChanges:x=[],onStagePaymentChange:p,cashAccounts:g=[],onLinkToCash:y,onUpdatePayment:f})=>{let[j,b]=(0,a.useState)(o||new Date),[N,v]=(0,a.useState)((0,K.formatNumberInput)(e?.toString()||"0"));a.default.useEffect(()=>{Math.abs((0,K.parseNumberInput)(N)-e)>.001&&v((0,K.formatNumberInput)(e.toString()))},[e]);let C=h.filter(e=>!x.find(t=>t.id===e.id&&"delete"===t.type)).map(e=>{let t=x.find(t=>t.id===e.id&&"update"===t.type);return t&&t.updatedData?{...e,amount:t.updatedData.amount??e.amount,notes:t.updatedData.notes??e.notes}:e}).reduce((e,t)=>e+t.amount,0),S=Math.max(0,n-C),w=C>=n,I=w?0:e||0;return console.log("InstallmentPaymentInput - isEditing:",m,"has onStagePaymentChange:",!!p),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)(M.Card,{className:"border-blue-200 bg-blue-50",children:[(0,t.jsx)(M.CardHeader,{className:"pb-3",children:(0,t.jsx)(M.CardTitle,{className:"text-sm text-blue-800",children:"Installment Payment Details"})}),(0,t.jsxs)(M.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"amountPaid",className:"text-sm font-medium",children:"Amount Paid (Current Payment)"}),(0,t.jsx)(X.Input,{id:"amountPaid",type:"text",inputMode:"decimal",value:N,onChange:e=>{let t=e.target.value;v((0,K.formatNumberInput)(t)),l(Math.min((0,K.parseNumberInput)(t),S))},placeholder:"Enter amount paid",disabled:w,className:"text-base"})]}),(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{className:"text-sm font-medium",children:"Payment Date"}),(0,t.jsxs)(O.Popover,{children:[(0,t.jsx)(O.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(R.Button,{variant:"outline",className:(0,K.cn)("w-full justify-start text-left font-normal",!j&&"text-muted-foreground"),disabled:w,children:[(0,t.jsx)(U.CalendarIcon,{className:"mr-2 h-4 w-4"}),j?(0,z.format)(j,"PPP"):(0,t.jsx)("span",{children:"Pick a date"})]})}),(0,t.jsx)(O.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(V.Calendar,{mode:"single",selected:j,onSelect:e=>{e&&(b(e),i?.(e))},initialFocus:!0,className:(0,K.cn)("p-3 pointer-events-auto")})})]})]}),(0,t.jsxs)("div",{className:"space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4",children:[(0,t.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"Total Amount:"}),(0,t.jsxs)("span",{className:"text-sm font-semibold sm:block",children:[r," ",(0,K.formatNumber)(n)]})]}),(0,t.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"Total Paid (History):"}),(0,t.jsxs)("span",{className:"text-sm font-semibold text-green-600 sm:block",children:[r," ",(0,K.formatNumber)(C)]})]})]}),(0,t.jsxs)("div",{className:"space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4",children:[(0,t.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"Current Payment:"}),(0,t.jsxs)("span",{className:"text-sm font-semibold text-blue-600 sm:block",children:[r," ",(0,K.formatNumber)(I)]})]}),(0,t.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"Amount Due:"}),(0,t.jsxs)("span",{className:"text-sm font-semibold text-red-600 sm:block",children:[r," ",(0,K.formatNumber)(Math.max(0,S-I))]})]})]}),C+I>=n&&I>0&&(0,t.jsx)("div",{className:"text-sm text-green-600 font-medium bg-green-50 p-3 rounded border border-green-200",children:"âœ“ Full payment received - you can manually change status to Paid if needed"}),w&&(0,t.jsx)("div",{className:"text-sm text-green-600 font-medium bg-green-50 p-3 rounded border border-green-200",children:"âœ“ Sale fully paid - you can manually change status to Paid if needed"}),m&&x.length>0&&(0,t.jsxs)("div",{className:"text-sm text-amber-600 font-medium bg-amber-50 p-3 rounded border border-amber-200",children:["â„¹ï¸ ",x.length,' payment change(s) staged. Changes will be saved when you click "Update Sale".']}),m&&0===x.length&&h.length>0&&(0,t.jsx)("div",{className:"text-sm text-blue-600 font-medium bg-blue-50 p-3 rounded border border-blue-200",children:'â„¹ï¸ You can edit payment history. Changes will be saved when you click "Update Sale".'})]})]}),d&&(0,t.jsx)(eO,{payments:h,currency:r,isLoading:!1,pendingChanges:x,isLocalMode:m,onStageChange:p,cashAccounts:g,onLinkToCash:y,onUpdatePayment:f})]})};var eK=e.i(130027);let eY=({linkToCash:e,onLinkToCashChange:a,selectedCashAccountId:s,onCashAccountChange:n,cashAccounts:r,paymentStatus:l})=>"Paid"!==l&&"Installment Sale"!==l?null:(0,t.jsxs)(M.Card,{className:"border-green-200 bg-green-50",children:[(0,t.jsx)(M.CardHeader,{className:"pb-3",children:(0,t.jsx)(M.CardTitle,{className:"text-sm text-green-800",children:"Installment Sale"===l?"Link Partial Payment to Cash Account":"Link to Cash Account"})}),(0,t.jsxs)(M.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"space-y-0.5",children:[(0,t.jsx)(H.Label,{htmlFor:"link-to-cash",children:"Link to Cash Account"}),(0,t.jsx)("div",{className:"text-sm text-muted-foreground",children:"Installment Sale"===l?"Record the partial payment in a cash account":"Record this payment in a cash account"})]}),(0,t.jsx)(eK.Switch,{id:"link-to-cash",checked:e,onCheckedChange:a,"data-cash-account-switch":"true",onKeyDown:t=>{if("Enter"===t.key)if(t.preventDefault(),e){let e=document.querySelector('[data-cash-account-select="true"]');e?.focus()}else{let e=document.querySelector('button[type="submit"]');e?.focus()}}})]}),e&&(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"cash-account",children:"Select Cash Account"}),(0,t.jsxs)(W.Select,{value:s,onValueChange:n,children:[(0,t.jsx)(W.SelectTrigger,{className:"w-full","data-cash-account-select":"true",onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.querySelector('button[type="submit"]');t?.focus()}},children:(0,t.jsx)(W.SelectValue,{placeholder:"Select a cash account"})}),(0,t.jsx)(W.SelectContent,{children:r.map(e=>(0,t.jsx)(W.SelectItem,{value:e.id,children:(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("span",{children:e.name}),e.isDefault&&(0,t.jsx)("span",{className:"ml-2 text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded",children:"Default"})]})},e.id))})]}),s&&(0,t.jsx)("div",{className:"text-sm text-muted-foreground",children:"Installment Sale"===l?"The partial payment amount will be recorded in this account":"The full payment amount will be recorded in this account"})]})]})]});var eX=e.i(577340);let eQ=({value:e,onChange:a,label:s="Sales Source",placeholder:n="Select category (optional)"})=>{let{categories:r,isLoading:l}=(0,eX.useSalesCategories)();return l?(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{children:s}),(0,t.jsx)(W.Select,{disabled:!0,children:(0,t.jsx)(W.SelectTrigger,{children:(0,t.jsx)(W.SelectValue,{placeholder:"Loading..."})})})]}):(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{children:s}),(0,t.jsxs)(W.Select,{value:e||"none",onValueChange:e=>{a("none"===e?"":e)},children:[(0,t.jsx)(W.SelectTrigger,{children:(0,t.jsx)(W.SelectValue,{placeholder:n})}),(0,t.jsxs)(W.SelectContent,{children:[(0,t.jsx)(W.SelectItem,{value:"none",children:"No source"}),r.map(e=>(0,t.jsx)(W.SelectItem,{value:e.id,children:e.name},e.id))]})]})]})},eW=({paymentStatus:e,onPaymentStatusChange:a,isInstallmentSale:s,amountPaid:n,amountDue:r,grandTotal:l,currency:i,onAmountPaidChange:o,onPaymentDateChange:c,paymentDate:d,saleId:u,onPaymentStatusChangeFromInstallment:m,isEditing:h,payments:x,pendingChanges:p,onStagePaymentChange:g,linkToCash:y,onLinkToCashChange:f,selectedCashAccountId:j,onCashAccountChange:b,cashAccounts:N,hasPaidWithHistory:v,onLinkPaymentToCash:C,onUpdatePayment:S,notes:w="",onNotesChange:I,categoryId:k="",onCategoryChange:P})=>(0,t.jsxs)(M.Card,{className:"mb-6",children:[(0,t.jsx)(M.CardHeader,{children:(0,t.jsx)(M.CardTitle,{children:"Payment Information"})}),(0,t.jsxs)(M.CardContent,{className:"space-y-6",children:[(0,t.jsx)(eq,{paymentStatus:e,onPaymentStatusChange:a}),s&&(0,t.jsx)(eH,{amountPaid:n,amountDue:r,grandTotal:l,currency:i,onAmountPaidChange:o,onPaymentDateChange:c,paymentDate:d,maxAmount:l,saleId:u,onPaymentStatusChange:m,isEditing:h,payments:x,pendingChanges:p,onStagePaymentChange:h?g:void 0,cashAccounts:N,onLinkToCash:C,onUpdatePayment:S}),v&&(0,t.jsxs)(M.Card,{className:"border-green-200 bg-green-50",children:[(0,t.jsx)(M.CardHeader,{className:"pb-3",children:(0,t.jsx)(M.CardTitle,{className:"text-sm text-green-800",children:"Payment History (Sale Completed)"})}),(0,t.jsx)(M.CardContent,{children:(0,t.jsx)(eO,{payments:x,currency:i,isLoading:!1,pendingChanges:p,isLocalMode:h,onStageChange:h?g:void 0,cashAccounts:N,onLinkToCash:C,onUpdatePayment:S})})]}),(0,t.jsx)(eY,{linkToCash:y,onLinkToCashChange:f,selectedCashAccountId:j,onCashAccountChange:b,cashAccounts:N,paymentStatus:e}),P&&(0,t.jsx)(eQ,{value:k,onChange:P}),(0,t.jsxs)("div",{className:"grid gap-3",children:[(0,t.jsx)(H.Label,{htmlFor:"saleNotes",children:"Notes"}),(0,t.jsx)(X.Input,{id:"saleNotes",name:"notes",value:w,onChange:I,placeholder:"Order notes (will appear on receipt)"})]})]})]});var eG=e.i(262945),eJ=e.i(322138),eZ=e.i(235090),e0=e.i(641405);let e1=({loading:e,isEditing:s,onCancel:i,onClearForm:o,printAfterSave:c,onPrintAfterSaveChange:d,thermalPrintAfterSave:u=!1,onThermalPrintAfterSaveChange:m,paymentStatus:h,includePaymentInfo:x,onIncludePaymentInfoChange:p,hasPendingPaymentChanges:g=!1,sendSMS:y=!1,onSendSMSChange:j,smsMessage:b="",onSMSMessageChange:N,customerName:v="",customerHasPhone:C=!1,disabled:S=!1})=>{let{user:w}=(0,n.useAuth)(),I=w?.id,{currentBusiness:k}=(0,l.useBusiness)(),{settings:P}=(0,r.useBusinessSettings)(),[D,T]=(0,a.useState)(!1),{templates:A=[],isLoading:E}=(0,B.useMessages)(I),[L,F]=(0,a.useState)("");(0,a.useEffect)(()=>{(async()=>{T(await (0,f.checkBridgeStatus)())})()},[]);let q="Thank you for your purchase from {business_name} We truly appreciate your support and trust in our Business. If you need any assistance or have any questions about your order, please feel free to reach out, on {business_number} We look forward to servingÂ youÂ again!",$=(e,t)=>{let a=e;return t&&(a=a.replace(/\{customer_name\}/gi,t).replace(/\{first_name\}/gi,t.split(" ")[0]||"").replace(/\{last_name\}/gi,t.split(" ").slice(1).join(" ")||"")),a=a.replace(/\{business_name\}/gi,k?.name||"[Business Name]").replace(/\{business_number\}/gi,P.businessPhone||"[Business Number]")},_=(0,a.useMemo)(()=>A.filter(e=>e.category&&"ThankYou"===String(e.category).trim()),[A]);(0,a.useEffect)(()=>{if(!y||!N)return;let e=q;if("default"===L)e=q;else if(L&&_.length>0){let t=_.find(e=>e.id===L);t&&(e=t.content)}else L||F("default");N($(e,v))},[y,v,_,L,N]);let z=b.length,U=Math.ceil(z/160)||1;return(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsx)(M.Card,{className:"border-gray-200",children:(0,t.jsxs)(M.CardContent,{className:"pt-6 space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(eG.Checkbox,{id:"printAfterSave",checked:c,onCheckedChange:d}),(0,t.jsxs)(H.Label,{className:"text-sm",children:["Show receipt after ",s?"updating":"creating"," sale"]})]}),D&&m&&(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(eG.Checkbox,{id:"thermalPrintAfterSave",checked:u,onCheckedChange:m}),(0,t.jsxs)(H.Label,{className:"text-sm flex items-center gap-1.5 text-green-700 font-medium",children:[(0,t.jsx)(e0.Printer,{className:"w-3.5 h-3.5"}),"Auto-print (Thermal Bridge)"]})]}),("Paid"===h||"Installment Sale"===h)&&(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(eG.Checkbox,{id:"includePaymentInfo",checked:x,onCheckedChange:p}),(0,t.jsx)(H.Label,{className:"text-sm",children:"Include payment information in receipt"})]})]})}),j&&N&&(0,t.jsx)(M.Card,{className:`border-blue-200 ${y?"bg-blue-50/50":"bg-gray-50"}`,children:(0,t.jsxs)(M.CardContent,{className:"pt-6 space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-start space-x-3",children:[(0,t.jsx)(eG.Checkbox,{id:"sendSMS",checked:y,onCheckedChange:j,disabled:!C}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)(H.Label,{className:"text-base font-medium flex items-center gap-2",children:[(0,t.jsx)(eZ.MessageSquare,{className:"w-5 h-5 text-blue-600"}),"Send Thank You SMS"]}),!C&&(0,t.jsx)("p",{className:"text-xs text-amber-600 mt-1",children:"Customer phone number required to send SMS"})]})]}),y&&C&&(0,t.jsxs)("div",{className:"space-y-4 pl-8 border-l-4 border-blue-300 bg-blue-50/30 -m-4 p-4 rounded-r-lg",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(H.Label,{className:"text-sm font-medium",children:"Template"}),E?(0,t.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-2 mt-1",children:[(0,t.jsx)(eJ.Loader2,{className:"w-4 h-4 animate-spin"}),"Loading templates..."]}):(0,t.jsxs)(W.Select,{value:L||"default",onValueChange:e=>{F(e);let t=q;if("default"===e)t=q;else{let a=_.find(t=>t.id===e);a&&(t=a.content)}let a=$(t,v);N?.(a)},children:[(0,t.jsx)(W.SelectTrigger,{className:"mt-1",children:(0,t.jsx)(W.SelectValue,{placeholder:"Choose a thank you template..."})}),(0,t.jsxs)(W.SelectContent,{children:[(0,t.jsx)(W.SelectItem,{value:"default",children:"Default Template"}),_.map(e=>(0,t.jsx)(W.SelectItem,{value:e.id,children:e.name},e.id))]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(H.Label,{className:"text-sm font-medium",children:"Message"}),(0,t.jsx)(ea.Textarea,{value:b,onChange:e=>N?.(e.target.value),placeholder:"Your message will appear here...",rows:4,className:"mt-1 resize-none text-sm font-medium"}),(0,t.jsxs)("div",{className:"flex justify-between items-center mt-2 text-xs text-gray-600",children:[(0,t.jsxs)("span",{children:[z," characters"]}),(0,t.jsxs)("span",{className:"font-semibold text-blue-600",children:[U," SMS credit",U>1?"s":""," will be used"]})]})]})]})]})}),g&&(0,t.jsx)("div",{className:"text-sm text-amber-600 bg-amber-50 p-3 rounded border border-amber-200",children:"Pending payment changes will be applied when updating."}),(0,t.jsxs)("div",{className:"flex gap-4 pt-4",children:[(0,t.jsx)(R.Button,{type:"button",variant:"outline",onClick:i,disabled:e,className:"flex-1",children:"Cancel"}),!s&&o&&(0,t.jsx)(R.Button,{type:"button",variant:"outline",onClick:o,disabled:e,className:"flex-1",children:"Clear Form"}),(0,t.jsx)(R.Button,{type:"submit",disabled:e||S,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:e?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(eJ.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),s?"Updating...":"Creating..."]}):s?"Update Sale":"Create Sale"})]})]})},e2=({initialData:e,onSaleComplete:s,currency:c="USD",customers:d=[],onAddNewCustomer:u,draftData:m,onClearDraft:h})=>{let g=(0,o.useRouter)();(0,o.useSearchParams)();let[y,f]=(0,a.useState)(!1),[b,N]=(0,a.useState)(e?.date||new Date),v=e?.paymentStatus||"Paid",{settings:S}=(0,r.useBusinessSettings)(),{user:M}=(0,n.useAuth)(),{updateInventoryForSale:R,updateInventoryForEditedSale:q}=x(M?.id),{accounts:$}=(0,k.useCashAccounts)(),{currentBusiness:_}=(0,l.useBusiness)();(0,a.useEffect)(()=>{e&&(console.log("SalesForm initialData:",e),console.log("SalesForm initialData.categoryId:",e.categoryId),console.log("SalesForm initialData.notes:",e.notes))},[e]);let{saveDraft:z}=i(),{updateStockHistoryDatesBySaleId:U}=(0,L.useStockHistory)(M?.id),V=(0,a.useRef)(),O=(0,a.useRef)(!1),[H,K]=(0,a.useState)(!1),{createMessage:Y,templates:X=[]}=(0,B.useMessages)(M?.id),[Q,W]=(0,a.useState)(null),[G,J]=(0,a.useState)(!0),[Z,et]=(0,a.useState)("Thank you for your purchase from {business_name} We truly appreciate your support and trust in our Business. If you need any assistance or have any questions about your order, please feel free to reach out, on {business_number} We look forward to servingÂ youÂ again!"),{formData:ea,errors:es,taxRateInput:en,printAfterSave:er,thermalPrintAfterSave:el,includePaymentInfo:ei,selectedCustomerCategoryId:eo,paymentDate:ec,linkToCash:ed,selectedCashAccountId:eu,cashTransactionId:em,originalPaymentStatus:eh,formRecentlyCleared:ex,payments:ep,pendingChanges:eg,hasChanges:ey,setFormData:ef,setTaxRateInput:ej,setPrintAfterSave:eb,setThermalPrintAfterSave:eN,setIncludePaymentInfo:ev,setLinkToCash:eC,setSelectedCashAccountId:eS,setCashTransactionId:ew,setOriginalPaymentStatus:eI,handleChange:ek,handleSelectChange:eP,handleAddItem:eD,handleUpdateItem:eT,handleRemoveItem:eA,handleSelectCustomer:eE,handleCategoryChange:eL,handleSalesCategoryChange:eB,handleAmountPaidChange:eF,handlePaymentDateChange:eM,calculateTotalAmount:eq,calculateTaxAmount:e$,validateForm:e_,processPendingPaymentChanges:ez,createInstallmentPayment:eU,updateInstallmentPayment:eV,deleteInstallmentPayment:eO,addPaymentChange:eH,clearChanges:eK,getModifiedPayments:eY,clearForm:eX}=(({initialData:e,defaultPaymentStatus:t,cashAccounts:s})=>{let{formData:n,errors:r,taxRateInput:l,printAfterSave:i,thermalPrintAfterSave:o,includePaymentInfo:c,selectedCustomerCategoryId:d,paymentDate:u,linkToCash:m,selectedCashAccountId:h,cashTransactionId:x,originalPaymentStatus:p,formRecentlyCleared:g,setFormData:y,setErrors:f,setTaxRateInput:j,setPrintAfterSave:b,setThermalPrintAfterSave:N,setIncludePaymentInfo:v,setSelectedCustomerCategoryId:C,setPaymentDate:S,setLinkToCash:w,setSelectedCashAccountId:I,setCashTransactionId:k,setOriginalPaymentStatus:A,setFormRecentlyCleared:E,clearFormState:L}=(({initialData:e,defaultPaymentStatus:t})=>{let[s,n]=(0,a.useState)({customerName:e?.customerName||"",customerAddress:e?.customerAddress||"",customerContact:e?.customerContact||"",customerId:e?.customerId||"",items:e?.items||[{...P}],paymentStatus:t,taxRate:e?.taxRate||0,amountPaid:e&&"Installment Sale"===e.paymentStatus?0:e?.amountPaid||0,amountDue:e?.amountDue||0,notes:e?.notes||"",categoryId:e?.categoryId||""}),[r,l]=(0,a.useState)({}),[i,o]=(0,a.useState)(e?.taxRate?e.taxRate.toString():""),[c,d]=(0,a.useState)(!0),[u,m]=(0,a.useState)(!1),[h,x]=(0,a.useState)(!0),[p,g]=(0,a.useState)(""),[y,f]=(0,a.useState)(new Date),[j,b]=(0,a.useState)(!1),[N,v]=(0,a.useState)(""),[C,S]=(0,a.useState)(null),[w,I]=(0,a.useState)(t),[k,D]=(0,a.useState)(!1),T=(0,a.useCallback)(e=>{n({customerName:"",customerAddress:"",customerContact:"",customerId:"",items:[{...P}],paymentStatus:t,taxRate:0,amountPaid:0,amountDue:0,notes:"",categoryId:""}),o(""),g(""),f(new Date),b(!1),l({}),D(!0),e&&e()},[t]);return(0,a.useEffect)(()=>{e&&(n(t=>({...t,customerName:e.customerName||t.customerName,customerAddress:e.customerAddress||t.customerAddress,customerContact:e.customerContact||t.customerContact,customerId:e.customerId||t.customerId,items:e.items&&e.items.length>0?e.items:t.items,paymentStatus:e.paymentStatus||t.paymentStatus,taxRate:void 0!==e.taxRate?e.taxRate:t.taxRate,amountPaid:void 0!==e.amountPaid?e.amountPaid:t.amountPaid,amountDue:void 0!==e.amountDue?e.amountDue:t.amountDue,notes:e.notes||t.notes,categoryId:e.categoryId||t.categoryId})),e.categoryId&&D(!1),void 0!==e.taxRate&&o(e.taxRate.toString()))},[e]),{formData:s,errors:r,taxRateInput:i,printAfterSave:c,thermalPrintAfterSave:u,includePaymentInfo:h,selectedCustomerCategoryId:p,paymentDate:y,linkToCash:j,selectedCashAccountId:N,cashTransactionId:C,originalPaymentStatus:w,formRecentlyCleared:k,setFormData:n,setErrors:l,setTaxRateInput:o,setPrintAfterSave:d,setThermalPrintAfterSave:m,setIncludePaymentInfo:x,setSelectedCustomerCategoryId:g,setPaymentDate:f,setLinkToCash:b,setSelectedCashAccountId:v,setCashTransactionId:S,setOriginalPaymentStatus:I,setFormRecentlyCleared:D,clearFormState:T}})({initialData:e,defaultPaymentStatus:t}),{handleChange:B,handleSelectChange:F,handleAmountPaidChange:M,handlePaymentDateChange:R}=(({formData:e,setFormData:t,errors:s,setErrors:n,setTaxRateInput:r,setLinkToCash:l})=>{let i=(0,a.useCallback)(e=>{let{name:a,value:l}=e.target;if("taxRate"===a){r(l);let e=l.replace(/,/g,""),a=""===e?0:parseFloat(e);t(e=>({...e,taxRate:isNaN(a)?0:a}))}else t(e=>({...e,[a]:l}));s[a]&&n(e=>({...e,[a]:void 0}))},[s,t,n,r]),o=(0,a.useCallback)(e=>{t(t=>({...t,paymentStatus:e})),"Paid"!==e&&"Installment Sale"!==e&&l(!1),"Installment Sale"!==e&&t(t=>({...t,paymentStatus:e,amountPaid:0,amountDue:0}))},[t,l]);return{handleChange:i,handleSelectChange:o,handleAmountPaidChange:(0,a.useCallback)((e,a)=>{let s=Math.max(0,a-e);t(t=>({...t,amountPaid:e,amountDue:s}))},[t]),handlePaymentDateChange:(0,a.useCallback)(e=>{},[])}})({formData:n,setFormData:y,errors:r,setErrors:f,setTaxRateInput:j,setLinkToCash:w}),{handleAddItem:q,handleAddItemWithProduct:$,handleUpdateItem:_,handleRemoveItem:z}=(({formData:e,setFormData:t})=>{let s=(0,a.useCallback)(()=>{t(e=>({...e,items:[...e.items,{...D}]}))},[t]),n=(0,a.useCallback)(e=>{t(t=>{let a=t.items.findIndex(t=>t.productId===e.id);if(-1!==a){let e=[...t.items];return e[a]={...e[a],quantity:e[a].quantity+1},{...t,items:e}}let s={productId:e.id,description:e.name,quantity:1,price:e.sellingPrice,cost:e.costPrice};return 1!==t.items.length||t.items[0].description||t.items[0].productId?{...t,items:[...t.items,s]}:{...t,items:[s]}})},[t]);return{handleAddItem:s,handleAddItemWithProduct:n,handleUpdateItem:(0,a.useCallback)((e,a)=>{t(t=>{if(a.productId){let s=t.items.findIndex((t,s)=>s!==e&&t.productId===a.productId);if(-1!==s){let n=[...t.items],r=n[s];return n[s]={...r,quantity:r.quantity+a.quantity},n.length>1?n.splice(e,1):n[e]={...D},{...t,items:n}}}let s=[...t.items];return s[e]=a,{...t,items:s}})},[t]),handleRemoveItem:(0,a.useCallback)(e=>{t(t=>{if(1===t.items.length)return t;let a=t.items.filter((t,a)=>a!==e);return{...t,items:a}})},[t])}})({formData:n,setFormData:y}),{handleSelectCustomer:U,handleCategoryChange:V}=(({setFormData:e,setSelectedCustomerCategoryId:t})=>({handleSelectCustomer:(0,a.useCallback)(a=>{e(e=>({...e,customerName:a.fullName,customerAddress:a.location||"",customerContact:a.phoneNumber||"",customerId:a.id})),t(a.categoryId||"")},[e,t]),handleCategoryChange:(0,a.useCallback)(e=>{t(e)},[t])}))({setFormData:y,setSelectedCustomerCategoryId:C}),{validateForm:O}=(({formData:e,linkToCash:t,selectedCashAccountId:s,initialData:n,formRecentlyCleared:r,setErrors:l})=>({validateForm:(0,a.useCallback)((a,r)=>{let i={};return e.customerName.trim()||(i.customerName="Customer name is required"),e.taxRate<0&&(i.taxRate="Tax rate cannot be negative"),e.items.filter(e=>""!==e.description.trim()||e.quantity>0||e.price>0).some(e=>!e.description.trim()||e.quantity<=0||e.price<0||e.cost<0)&&(i.items="All items must have a description, positive quantity, and non-negative price/cost"),t&&("Paid"===e.paymentStatus||"Installment Sale"===e.paymentStatus)&&!s&&(i.cashAccount="Select a cash account when linking payments"),"Installment Sale"===e.paymentStatus&&!n&&((!e.amountPaid||e.amountPaid<=0)&&(i.amountPaid="Enter an initial payment greater than 0"),e.amountPaid&&e.amountPaid>a&&(i.amountPaid="Amount paid cannot exceed total")),"Installment Sale"===e.paymentStatus&&n&&e.amountPaid&&e.amountPaid>a&&(i.amountPaid="Amount paid cannot exceed total"),l(i),0===Object.keys(i).length},[e,t,s,n,r,l])}))({formData:n,linkToCash:m,selectedCashAccountId:h,initialData:e,formRecentlyCleared:g,setErrors:f}),{calculateTotalAmount:H,calculateTaxAmount:K}=(({taxRate:e})=>({calculateTotalAmount:(0,a.useCallback)(e=>e.reduce((e,t)=>{let a=t.price*t.quantity,s="amount"===t.discountType?t.discountAmount||0:a*(t.discountPercentage||0)/100;return e+(a-s)},0),[]),calculateTaxAmount:(0,a.useCallback)(t=>e/100*t,[e])}))({taxRate:n.taxRate}),{payments:Y,pendingChanges:X,hasChanges:Q,createInstallmentPayment:W,updateInstallmentPayment:G,deleteInstallmentPayment:J,addPaymentChange:Z,clearChanges:ee,getModifiedPayments:et,processPendingPaymentChanges:ea}=(({initialDataId:e})=>{let{payments:t,createPayment:s,updatePayment:n,deletePayment:r}=(0,T.useInstallmentPayments)(e),{pendingChanges:l,addPaymentChange:i,clearChanges:o,getModifiedPayments:c,hasChanges:d}=(()=>{let[e,t]=(0,a.useState)([]),s=e.length>0;return{pendingChanges:e,addPaymentChange:e=>{t(t=>[...t.filter(t=>t.id!==e.id),e])},removePaymentChange:e=>{t(t=>t.filter(t=>t.id!==e))},clearChanges:()=>{t([])},getModifiedPayments:t=>t.filter(t=>!e.find(e=>e.id===t.id&&"delete"===e.type)).map(t=>{let a=e.find(e=>e.id===t.id&&"update"===e.type);return a&&a.updatedData?{...t,amount:a.updatedData.amount??t.amount,notes:a.updatedData.notes??t.notes,paymentDate:a.updatedData.paymentDate??t.paymentDate}:t}),hasChanges:s}})(),u=(0,a.useCallback)(async()=>{for(let e of l)"update"===e.type?await n(e.id,e.updatedData):"delete"===e.type&&await r(e.id);o()},[l,n,r,o]);return{payments:t,pendingChanges:l,hasChanges:d,createInstallmentPayment:s,updateInstallmentPayment:n,deleteInstallmentPayment:r,addPaymentChange:i,clearChanges:o,getModifiedPayments:c,processPendingPaymentChanges:u}})({initialDataId:e?.id}),es=(0,a.useCallback)(e=>{S(e)},[S]),en=(0,a.useCallback)((e,t)=>{L(e),ee(),t&&t()},[L,ee]),er=(0,a.useCallback)(e=>{g&&E(!1),B(e)},[g,E,B]),el=(0,a.useCallback)(e=>{g&&E(!1),F(e)},[g,E,F]),ei=(0,a.useCallback)(e=>{g&&E(!1);let t=e&&(e.nativeEvent||e.preventDefault||e.stopPropagation||e.type&&e.target);e&&!t?$(e):q()},[g,E,q,$]),eo=(0,a.useCallback)((e,t)=>{g&&E(!1),_(e,t)},[g,E,_]),ec=(0,a.useCallback)(e=>{g&&E(!1),z(e)},[g,E,z]),ed=(0,a.useCallback)(e=>{g&&E(!1),U(e)},[g,E,U]),eu=(0,a.useCallback)(e=>{g&&E(!1),V(e)},[g,E,V]),em=(0,a.useCallback)(e=>{g&&E(!1),y(t=>({...t,categoryId:e}))},[g,E,y]);return{formData:n,errors:r,taxRateInput:l,printAfterSave:i,thermalPrintAfterSave:o,includePaymentInfo:c,selectedCustomerCategoryId:d,paymentDate:u,linkToCash:m,selectedCashAccountId:h,cashTransactionId:x,originalPaymentStatus:p,formRecentlyCleared:g,payments:Y,pendingChanges:X,hasChanges:Q,setFormData:y,setTaxRateInput:j,setPrintAfterSave:b,setThermalPrintAfterSave:N,setIncludePaymentInfo:v,setLinkToCash:w,setSelectedCashAccountId:I,setCashTransactionId:k,setOriginalPaymentStatus:A,handleChange:er,handleSelectChange:el,handleAddItem:ei,handleUpdateItem:eo,handleRemoveItem:ec,handleSelectCustomer:ed,handleCategoryChange:eu,handleSalesCategoryChange:em,handleAmountPaidChange:M,handlePaymentDateChange:es,clearForm:en,calculateTotalAmount:H,calculateTaxAmount:K,validateForm:O,processPendingPaymentChanges:ea,createInstallmentPayment:W,updateInstallmentPayment:G,deleteInstallmentPayment:J,addPaymentChange:Z,clearChanges:ee,getModifiedPayments:et}})({initialData:e,defaultPaymentStatus:v,cashAccounts:$}),{createCashTransactionForSale:eQ,updateCashTransactionForSale:eG,createInstallmentPaymentWithCash:eJ,findCashTransactionForSale:eZ}=(()=>{let{createTransaction:e,updateTransaction:t,deleteTransaction:s}=(0,A.useCashTransactions)(),n=(0,a.useCallback)(async(t,a,s,n,r,l)=>{if(!s||!n||"Paid"!==l)return null;try{let s=`Sale to ${t.customerName||t.customer_name||"Customer"} - Receipt #${t.receiptNumber||t.receipt_number||"N/A"}`,l=await e({accountId:n,amount:a,transactionType:"cash_in",category:"Cash sale",description:s,date:r,personInCharge:"",tags:[],paymentMethod:"",receiptImage:""});return l?.id||null}catch(e){return console.error("Error creating cash transaction:",e),p.toast.error("Failed to create cash transaction"),null}},[e]),r=(0,a.useCallback)(async(a,n,r,l,i,o,c,d)=>{try{let u=`Sale to ${a.customerName||a.customer_name||"Customer"} - Receipt #${a.receiptNumber||a.receipt_number||"N/A"}`,m=c&&""!==c.trim();if(!r&&o&&"Paid"===i&&m){let t=await e({accountId:c,amount:n,transactionType:"cash_in",category:"Cash sale",description:u,date:d,personInCharge:"",tags:[],paymentMethod:"",receiptImage:""});return t?.id||null}if(!r)return null;if("Paid"===l&&"Installment Sale"===i)return await s(r),null;if(o&&"Paid"===i&&m)return await t(r,{amount:n,category:"Cash sale",description:u,date:d}),r;return await s(r),null}catch(e){return console.error("Error updating cash transaction:",e),p.toast.error("Failed to update cash transaction"),r}},[e,t,s]);return{createCashTransactionForSale:n,updateCashTransactionForSale:r,createInstallmentPaymentWithCash:(0,a.useCallback)(async(e,t,a,s,n,r,l)=>t<=0?null:s&&n?await l({saleId:e,amount:t,accountId:n,locationId:r,date:new Date}):await l({saleId:e,amount:t}),[]),findCashTransactionForSale:(0,a.useCallback)(async e=>{try{let t=await (0,E.findCashTransactionAction)(e);if(t.success&&t.data)return t.data.accountId}catch(e){console.error("Error finding cash transaction:",e)}return null},[])}})(),{payments:e0,linkPaymentToCashAccount:e2,unlinkPaymentFromCashAccount:e3,updatePayment:e5}=(0,T.useInstallmentPayments)(e?.id),e4=async(e,t)=>{await e5(e,t)},[e6,e7]=(0,a.useState)(!1),e8=()=>{O.current=!0,eX&&eX(()=>N(new Date),h)};(0,a.useEffect)(()=>{O.current=!1});let e9=a.default.useCallback(()=>{!O.current&&!e&&!y&&!e6&&!ex&&(ea.customerName.trim()||ea.customerAddress.trim()||ea.customerContact.trim()||ea.items.some(e=>e.description.trim()||1!==e.quantity||0!==e.price))&&z(ea,b)},[ea,b,e,y,z,e6,ex]);(0,a.useEffect)(()=>(V.current&&clearTimeout(V.current),V.current=setTimeout(e9,2e3),()=>{V.current&&clearTimeout(V.current),e9()}),[e9]),(0,a.useEffect)(()=>{let e=()=>e9(),t=()=>document.hidden&&e9();return window.addEventListener("beforeunload",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("beforeunload",e),document.removeEventListener("visibilitychange",t)}},[e9]),(0,a.useEffect)(()=>{m&&!e&&(ef(m.formData),N(m.selectedDate),ej(m.formData.taxRate?.toString()||""))},[m,e,ef,ej]),(0,a.useEffect)(()=>{(async()=>{if(e?.cashTransactionId){eC(!0),ew(e.cashTransactionId);let t=await eZ(e.cashTransactionId);t&&eS(t)}!($.length>0)||eu||e?.cashTransactionId||eS(($.find(e=>e.isDefault)||$[0]).id)})()},[e,$,eZ,eS]);let te=async t=>{t.preventDefault();let a=eq(ea.items),n=e$(a),r=a+n;if(!e_(r,b))return void(es.customerName?p.toast.error(es.customerName):es.taxRate?p.toast.error(es.taxRate):p.toast.error("Please fill in all required fields correctly"));if(0===ea.items.length||ea.items.every(e=>!e.description.trim()))return void p.toast.error("Please add at least one valid item");f(!0);try{let t=e?.receiptNumber||await w(_?.id||""),a=ea.items.reduce((e,t)=>{let a=t.price*t.quantity,s="amount"===t.discountType?t.discountAmount||0:a*(t.discountPercentage||0)/100,n=t.cost*t.quantity;return e+(a-s-n)},0),n=em;e&&(n=await eG({id:e.id,customerName:ea.customerName,receiptNumber:e.receiptNumber,items:ea.items},r,em,eh,ea.paymentStatus,ed,eu,b),ew(n));let l=(0,C.mapSaleToDbSale)(ea,b,a,t,M?.id||"",_?.id||"",n),{success:i,data:o,error:c}=await (0,j.upsertSaleAction)(l,!!e,e?.id);if(!i||!o)throw Error(c||"Failed to save sale");let u={id:o.id,receiptNumber:o.receiptNumber,customerName:o.customerName,customerAddress:o.customerAddress||"",customerContact:o.customerContact||"",customerId:o.customerId||void 0,items:o.items,paymentStatus:o.paymentStatus,profit:o.profit,date:new Date(o.date),taxRate:o.taxRate?Number(o.taxRate):0,cashTransactionId:o.cashTransactionId||void 0,amountPaid:o.amountPaid?Number(o.amountPaid):void 0,amountDue:o.amountDue?Number(o.amountDue):void 0,notes:o.notes||"",categoryId:o.categoryId||void 0,createdAt:new Date(o.createdAt)};if(e)ey&&await ez(),"Installment Sale"===ea.paymentStatus&&ea.amountPaid&&(await eU({saleId:u.id,amount:ea.amountPaid,notes:u.items.map(e=>e.description).join(", "),paymentDate:ec,accountId:ed?eu:void 0,locationId:_?.id}),ef(e=>({...e,amountPaid:0}))),e.date.getTime()!==b.getTime()&&await U(u.id,b);else{let e=await eQ(u,r,ed,eu,b,ea.paymentStatus);e&&(await (0,I.updateSaleCashTransactionAction)(u.id,e),u.cashTransactionId=e),"Installment Sale"===ea.paymentStatus&&ea.amountPaid&&await eJ(u.id,ea.amountPaid,u.items.map(e=>e.description).join(", "),ed,eu,_?.id||"",eU)}if(m&&h&&h(),s&&await s(u,er,ei,eo,void 0,b,el),p.toast.success(e?"Sale updated successfully!":"Sale recorded successfully!"),G&&ea.customerContact&&!e){let e=ea.items.map(e=>`â€¢ ${e.description} (Qty: ${e.quantity})`).join("\r\n"),t=Z.replace(/\{customer_name\}/gi,ea.customerName||"Valued Customer").replace(/\{receipt_number\}/gi,u.receiptNumber).replace(/\{items_list\}/gi,e).replace(/\{currency\}/gi,S.currency||"UGX").replace(/\{amount\}/gi,r.toLocaleString()).replace(/\{business_contact\}/gi,S.businessPhone||"our office").replace(/\{business_name\}/gi,_?.name||"Our Business");try{await Y({phoneNumber:ea.customerContact,content:t,customerId:d.find(e=>e.phoneNumber===ea.customerContact)?.id,metadata:{sale_id:u.id,receipt_number:u.receiptNumber,type:"thank_you"}}),p.toast.success("Thank you SMS sent successfully!")}catch(e){p.toast.error("Sale saved, but failed to send SMS: "+e.message)}}e7(!0),K(!0),e7(!0),K(!0),s||g.push("/sales")}catch(e){console.error("Error submitting sale:",e),K(!1),p.toast.error(e.message||"An error occurred. Please try again.")}finally{f(!1)}},tt=(0,a.useMemo)(()=>eq(ea.items),[ea.items]),ta=(0,a.useMemo)(()=>e$(tt),[tt,ea.taxRate]),ts=(0,a.useMemo)(()=>tt+ta,[tt,ta]),{data:tn=[]}=(0,F.useQuery)({queryKey:["all-products-for-scanner",M?.id,_?.id],queryFn:async()=>M?.id&&_?.id?(await (0,I.getProductsForBarcodeScannerAction)(_.id)||[]).map(C.mapDbProductToProduct):[],enabled:!!M?.id&&!!_?.id,staleTime:3e5}),tr=(0,a.useRef)(""),tl=(0,a.useRef)(Date.now());return(0,a.useEffect)(()=>{let e=e=>{let t=e.target,a=Date.now(),s=a-tl.current;if(tl.current=a,"Shift"===e.key||"Control"===e.key||"Alt"===e.key||"Meta"===e.key)return;let n=/^[a-zA-Z0-9\-_]$/.test(e.key),r="INPUT"===t.tagName||"TEXTAREA"===t.tagName||"true"===t.contentEditable;if(!r&&n&&(e.preventDefault(),e.stopPropagation()),"Enter"===e.key){let t=tr.current.trim();if(t.length>=2){e.preventDefault(),e.stopPropagation(),console.log(`[Scanner] Processing: "${t}"`);let a=async e=>{let t=await (0,I.lookupProductByBarcodeAction)(e,_?.id||"");return t?(0,C.mapDbProductToProduct)(t):null};(async()=>{let e=await a(t);if(e){let a=e.barcode||e.itemNumber||t;console.log(`[Scanner] âœ… Server Match: ${e.name}`),console.log(`[Scanner] ðŸ”— Mapping "${t}" -> System Code "${a}"`),eD(e),p.toast.success(`Scanned: ${e.name} (${a})`)}else console.warn(`[Scanner] âŒ No server match for: "${t}"`)})(),tr.current="";return}tr.current="",e.preventDefault(),e.stopPropagation();return}1===e.key.length&&(s<60&&r&&n&&(e.preventDefault(),e.stopPropagation()),s>100?tr.current=e.key:tr.current+=e.key)};return window.addEventListener("keydown",e,!0),()=>window.removeEventListener("keydown",e,!0)},[M?.id,_?.id]),(0,t.jsxs)("form",{onSubmit:te,className:"space-y-6",children:[(0,t.jsx)(ee,{isEditing:!!e,selectedDate:b,onDateChange:N,customerName:ea.customerName,customerAddress:ea.customerAddress,customerContact:ea.customerContact,notes:ea.notes,onCustomerInfoChange:ek,errors:es,customers:d,onAddNewCustomer:u,onSelectCustomer:eE,selectedCategoryId:eo,onCategoryChange:eL,onClearForm:e?void 0:e8}),(0,t.jsx)(eR,{items:ea.items,onAddItem:eD,onUpdateItem:eT,onRemoveItem:eA,taxRateInput:en,onTaxRateChange:ek,errors:es,totalAmount:tt,taxAmount:ta,grandTotal:ts,taxRate:ea.taxRate||0,currency:S.currency,saleDate:b.toISOString()}),(0,t.jsx)(eW,{paymentStatus:ea.paymentStatus,onPaymentStatusChange:eP,isInstallmentSale:"Installment Sale"===ea.paymentStatus,amountPaid:ea.amountPaid||0,amountDue:ea.amountDue||0,grandTotal:ts,currency:S.currency,onAmountPaidChange:e=>eF(e,ts),onPaymentDateChange:eM,paymentDate:ec,saleId:e?.id,isEditing:!!e,payments:eY(ep),pendingChanges:eg,onStagePaymentChange:e?eH:void 0,linkToCash:ed,onLinkToCashChange:eC,selectedCashAccountId:eu,onCashAccountChange:eS,cashAccounts:$,hasPaidWithHistory:"Paid"===ea.paymentStatus&&ep.length>0,onLinkPaymentToCash:(e,t)=>e2(e,t,_?.id||""),onUpdatePayment:e4,onPaymentStatusChangeFromInstallment:async e=>eP(e),notes:ea.notes,onNotesChange:ek,categoryId:ea.categoryId||"",onCategoryChange:eB}),(0,t.jsx)(e1,{loading:y,isEditing:!!e,onCancel:()=>g.push("/sales"),onClearForm:e?void 0:e8,printAfterSave:er,onPrintAfterSaveChange:eb,thermalPrintAfterSave:el,onThermalPrintAfterSaveChange:eN,paymentStatus:ea.paymentStatus,includePaymentInfo:ei,onIncludePaymentInfoChange:ev,hasPendingPaymentChanges:ey,sendSMS:G,onSendSMSChange:J,smsMessage:Z,onSMSMessageChange:et,customerHasPhone:!!ea.customerContact,customerName:ea.customerName,disabled:H})]})};var e3=e.i(392734),e5=e.i(296202),e4=e.i(151670),e6=e.i(558021);let e7=({initialData:e,onSubmit:s,onCancel:n})=>{let[r,l]=a.default.useState(!1),{categories:i}=J(),[o,c]=a.default.useState(()=>{if(e?.birthday)return console.log("Initial birthday from props:",e.birthday),e.birthday}),[d,u]=a.default.useState(e?.categoryId||"none");a.default.useEffect(()=>{e?.birthday&&(console.log("Initial birthday from props:",e.birthday),console.log("Is Date object:",e.birthday instanceof Date),console.log("Date string:",e.birthday.toString()))},[e?.birthday]);let[m,h]=a.default.useState({facebook:e?.socialMedia?.facebook||"",instagram:e?.socialMedia?.instagram||"",twitter:e?.socialMedia?.twitter||"",linkedin:e?.socialMedia?.linkedin||"",other:e?.socialMedia?.other||""}),[x,p]=a.default.useState(e?.tags||[]),[g,y]=a.default.useState(""),[f,j]=a.default.useState(e?.gender||""),{register:b,handleSubmit:N,formState:{errors:v}}=(0,e6.useForm)({defaultValues:{fullName:e?.fullName||"",email:e?.email||"",phoneNumber:e?.phoneNumber||"",location:e?.location||"",gender:e?.gender||"",notes:e?.notes||""}}),C=()=>{""===g.trim()||x.includes(g.trim())||(p([...x,g.trim()]),y(""))},S=(e,t)=>{h({...m,[t]:e.target.value})},w=async e=>{l(!0);try{console.log("Selected date before submission:",o);let t={...e,gender:f,birthday:o,categoryId:"none"===d?null:d,socialMedia:Object.keys(m).length>0?m:null,tags:x.length>0?x:null};console.log("Submitting customer data:",t),await s(t)}finally{l(!1)}},I=new Date().getFullYear(),k=Array.from({length:100},(e,t)=>I-t),P=[{value:0,label:"January"},{value:1,label:"February"},{value:2,label:"March"},{value:3,label:"April"},{value:4,label:"May"},{value:5,label:"June"},{value:6,label:"July"},{value:7,label:"August"},{value:8,label:"September"},{value:9,label:"October"},{value:10,label:"November"},{value:11,label:"December"}],D=e=>{if(console.log("Date selected from calendar:",e),e){let t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),12,0,0));console.log("Corrected date with UTC noon:",t),c(t)}else c(void 0)},T=e=>{try{let t=parseInt(e),a=o?new Date(o):new Date,s=new Date(Date.UTC(t,a.getMonth(),a.getDate(),12,0,0));isNaN(s.getTime())?console.error("Invalid date after setting year:",e):(c(s),console.log("Year selected, new date:",s))}catch(e){console.error("Error setting year:",e)}},A=e=>{try{let t=parseInt(e),a=o?new Date(o):new Date,s=new Date(Date.UTC(a.getFullYear(),t,a.getDate(),12,0,0));isNaN(s.getTime())?console.error("Invalid date after setting month:",e):(c(s),console.log("Month selected, new date:",s))}catch(e){console.error("Error setting month:",e)}},E=i.filter(e=>e.id&&""!==e.id.trim());return(0,t.jsx)("form",{onSubmit:N(w),children:(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:"fullName",children:"Full Name*"}),(0,t.jsx)(X.Input,{id:"fullName",...b("fullName",{required:"Name is required"}),className:(0,K.cn)(v.fullName&&"border-red-500")}),v.fullName&&(0,t.jsx)("p",{className:"text-red-500 text-xs",children:v.fullName.message})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:"category",children:"Category"}),(0,t.jsxs)(W.Select,{value:d,onValueChange:u,children:[(0,t.jsx)(W.SelectTrigger,{id:"category",children:(0,t.jsx)(W.SelectValue,{placeholder:"Select category"})}),(0,t.jsxs)(W.SelectContent,{children:[(0,t.jsx)(W.SelectItem,{value:"none",children:"No Category"}),E.map(e=>(0,t.jsx)(W.SelectItem,{value:e.id,children:e.name},e.id))]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:"email",children:"Email Address"}),(0,t.jsx)(X.Input,{id:"email",type:"email",...b("email",{pattern:{value:/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,message:"Invalid email address"}}),className:(0,K.cn)(v.email&&"border-red-500")}),v.email&&(0,t.jsx)("p",{className:"text-red-500 text-xs",children:v.email.message})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:"phoneNumber",children:"Phone Number"}),(0,t.jsx)(X.Input,{id:"phoneNumber",...b("phoneNumber")})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:"location",children:"Location"}),(0,t.jsx)(X.Input,{id:"location",...b("location")})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:"gender",children:"Gender"}),(0,t.jsxs)(W.Select,{value:f,onValueChange:j,children:[(0,t.jsx)(W.SelectTrigger,{id:"gender",children:(0,t.jsx)(W.SelectValue,{placeholder:"Select gender"})}),(0,t.jsxs)(W.SelectContent,{children:[(0,t.jsx)(W.SelectItem,{value:"male",children:"Male"}),(0,t.jsx)(W.SelectItem,{value:"female",children:"Female"}),(0,t.jsx)(W.SelectItem,{value:"non-binary",children:"Non-binary"}),(0,t.jsx)(W.SelectItem,{value:"prefer-not-to-say",children:"Prefer not to say"})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{children:"Birthday"}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,t.jsxs)("div",{className:"flex flex-row gap-2",children:[(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)(O.Popover,{children:[(0,t.jsx)(O.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(R.Button,{variant:"outline",className:"w-full justify-between",children:[o?o.getDate():"Day",(0,t.jsx)(e4.Calendar,{className:"h-4 w-4 opacity-50"})]})}),(0,t.jsx)(O.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(V.Calendar,{mode:"single",selected:o,onSelect:D,initialFocus:!0,captionLayout:"buttons",className:"p-3 pointer-events-auto",classNames:{caption_label:"hidden",dropdown:"hidden"}})})]})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)(W.Select,{value:o?String(o.getMonth()):void 0,onValueChange:A,children:[(0,t.jsx)(W.SelectTrigger,{children:(0,t.jsx)(W.SelectValue,{placeholder:"Month"})}),(0,t.jsx)(W.SelectContent,{children:P.map(e=>(0,t.jsx)(W.SelectItem,{value:String(e.value),children:e.label},e.value))})]})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)(W.Select,{value:o?String(o.getFullYear()):void 0,onValueChange:T,children:[(0,t.jsx)(W.SelectTrigger,{children:(0,t.jsx)(W.SelectValue,{placeholder:"Year"})}),(0,t.jsx)(W.SelectContent,{children:k.map(e=>(0,t.jsx)(W.SelectItem,{value:String(e),children:e},e))})]})})]}),o&&(0,t.jsxs)("div",{className:"text-sm text-muted-foreground",children:["Selected: ",o?(0,z.format)(o,"PPP"):"No date selected"]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{children:"Tags"}),(0,t.jsx)("div",{className:"flex flex-wrap gap-1 mb-2",children:x.map(e=>(0,t.jsxs)(eT.Badge,{variant:"secondary",children:[e,(0,t.jsxs)("button",{type:"button",className:"ml-1 rounded-full hover:bg-gray-200",onClick:()=>{p(x.filter(t=>t!==e))},children:[(0,t.jsx)(ez.X,{className:"h-3 w-3"}),(0,t.jsx)("span",{className:"sr-only",children:"Remove tag"})]})]},e))}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(X.Input,{value:g,onChange:e=>y(e.target.value),placeholder:"Add tag",onKeyDown:e=>"Enter"===e.key&&(e.preventDefault(),C())}),(0,t.jsx)(R.Button,{type:"button",onClick:C,variant:"outline",children:"Add"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{children:"Social Media"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)(H.Label,{htmlFor:"facebook",className:"text-xs",children:"Facebook"}),(0,t.jsx)(X.Input,{id:"facebook",value:m.facebook,onChange:e=>S(e,"facebook"),placeholder:"Username or URL"})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)(H.Label,{htmlFor:"instagram",className:"text-xs",children:"Instagram"}),(0,t.jsx)(X.Input,{id:"instagram",value:m.instagram,onChange:e=>S(e,"instagram"),placeholder:"Username without @"})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)(H.Label,{htmlFor:"twitter",className:"text-xs",children:"Twitter/X"}),(0,t.jsx)(X.Input,{id:"twitter",value:m.twitter,onChange:e=>S(e,"twitter"),placeholder:"Username without @"})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)(H.Label,{htmlFor:"linkedin",className:"text-xs",children:"LinkedIn"}),(0,t.jsx)(X.Input,{id:"linkedin",value:m.linkedin,onChange:e=>S(e,"linkedin"),placeholder:"Profile URL or username"})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{children:"Birthday"}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,t.jsxs)("div",{className:"flex flex-row gap-2",children:[(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)(O.Popover,{children:[(0,t.jsx)(O.PopoverTrigger,{asChild:!0,children:(0,t.jsxs)(R.Button,{variant:"outline",className:"w-full justify-between",children:[o?o.getDate():"Day",(0,t.jsx)(e4.Calendar,{className:"h-4 w-4 opacity-50"})]})}),(0,t.jsx)(O.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(V.Calendar,{mode:"single",selected:o,onSelect:D,initialFocus:!0,captionLayout:"buttons",className:"p-3 pointer-events-auto",classNames:{caption_label:"hidden",dropdown:"hidden"}})})]})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)(W.Select,{value:o?String(o.getMonth()):void 0,onValueChange:A,children:[(0,t.jsx)(W.SelectTrigger,{children:(0,t.jsx)(W.SelectValue,{placeholder:"Month"})}),(0,t.jsx)(W.SelectContent,{children:P.map(e=>(0,t.jsx)(W.SelectItem,{value:String(e.value),children:e.label},e.value))})]})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)(W.Select,{value:o?String(o.getFullYear()):void 0,onValueChange:T,children:[(0,t.jsx)(W.SelectTrigger,{children:(0,t.jsx)(W.SelectValue,{placeholder:"Year"})}),(0,t.jsx)(W.SelectContent,{children:k.map(e=>(0,t.jsx)(W.SelectItem,{value:String(e),children:e},e))})]})})]}),o&&(0,t.jsxs)("div",{className:"text-sm text-muted-foreground",children:["Selected: ",o?(0,z.format)(o,"PPP"):"No date selected"]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(H.Label,{htmlFor:"notes",children:"Notes"}),(0,t.jsx)(ea.Textarea,{id:"notes",...b("notes"),rows:4,placeholder:"Add any notes about this customer..."})]}),(0,t.jsxs)(e5.DialogFooter,{children:[(0,t.jsx)(R.Button,{variant:"outline",type:"button",onClick:n,children:"Cancel"}),(0,t.jsx)(R.Button,{type:"submit",disabled:r,children:r?"Saving...":"Save Changes"})]})]})})};var e8=e.i(17255);let e9=({open:e,onClose:a,onAddCustomer:s,initialData:n})=>{let r=async e=>(s(e),!0),l=!!n;return(0,t.jsx)(e5.Dialog,{open:e,onOpenChange:a,children:(0,t.jsxs)(e5.DialogContent,{className:"max-w-2xl max-h-[90vh]",children:[(0,t.jsxs)(e5.DialogHeader,{children:[(0,t.jsx)(e5.DialogTitle,{children:l?"Edit Customer":"Add New Customer"}),(0,t.jsx)(e5.DialogDescription,{children:"Fill in the customer details below. Only name is required."})]}),(0,t.jsx)(e8.ScrollArea,{className:"h-[calc(80vh-8rem)]",children:(0,t.jsx)("div",{className:"px-1",children:(0,t.jsx)(e7,{onSubmit:r,onCancel:a,initialData:n})})})]})})};var te=e.i(626427),tt=e.i(576255);let ta=({onLoadDraft:e,onDismiss:a,savedAt:s})=>(0,t.jsxs)(te.Alert,{className:"mb-4 border-blue-200 bg-blue-50",children:[(0,t.jsx)(tt.FileText,{className:"h-4 w-4 text-blue-600"}),(0,t.jsxs)(te.AlertDescription,{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("span",{className:"text-blue-800 font-medium",children:"Draft found!"}),(0,t.jsxs)("span",{className:"text-blue-700 ml-2",children:["Saved on ",s.toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]}),(0,t.jsxs)("div",{className:"flex gap-2 ml-4",children:[(0,t.jsx)(R.Button,{size:"sm",onClick:e,className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Load Draft"}),(0,t.jsx)(R.Button,{size:"sm",variant:"ghost",onClick:a,className:"text-blue-600 hover:text-blue-700 hover:bg-blue-100",children:(0,t.jsx)(ez.X,{className:"h-4 w-4"})})]})]})]}),ts=({editSale:e,currency:a,showDraftNotification:s,draftData:n,onLoadDraft:r,onDismissDraft:l,onSaleComplete:i,onClearDraft:o,customers:c,onAddNewCustomer:d,isReceiptOpen:u,completedSale:m,includePaymentInfo:h,onReceiptClose:x,newCustomerDialogOpen:p,onCloseNewCustomerDialog:g,onAddCustomer:y})=>(0,t.jsxs)(t.Fragment,{children:[s&&n&&(0,t.jsx)(ta,{onLoadDraft:r,onDismiss:l,savedAt:n.savedAt}),(0,t.jsx)(e2,{initialData:e,onSaleComplete:i,currency:a,customers:c,onAddNewCustomer:d,draftData:n,onClearDraft:o}),(0,t.jsx)(e3.default,{isOpen:u,sale:m,currency:a,onOpenChange:x,includePaymentInfo:h}),(0,t.jsx)(e9,{open:p,onClose:g,onAddCustomer:y})]});var tn=e.i(638822),tr=e.i(675878);e.s(["default",0,()=>{let e=(0,s.useNavigate)(),m=(0,s.useLocation)(),{user:h}=(0,n.useAuth)(),{settings:C}=(0,r.useBusinessSettings)(),{currentBusiness:S,isLoading:w}=(0,l.useBusiness)(),{hasPermission:I,isLoading:k}=(0,tn.useProfiles)(),P=m.state?.editSale,[D,T]=a.default.useState(0),A=a.default.useCallback(()=>{T(e=>e+1)},[]),{showDraftNotification:E,draftData:L,handleLoadDraft:B,handleDismissDraft:F,clearDraft:M}=(e=>{let[t,s]=(0,a.useState)(!1),[n,r]=(0,a.useState)(null),{hasDraft:l,loadDraft:o,clearDraft:c,checkForDraft:d}=i();return(0,a.useEffect)(()=>{if(!e&&d()){let e=o();e&&r(e)}},[e,d,o]),{showDraftNotification:!1,draftData:n,handleLoadDraft:()=>{r(null)},handleDismissDraft:()=>{c(),s(!1),r(null)},clearDraft:c}})(P),{isReceiptOpen:q,completedSale:$,newCustomerDialogOpen:_,includePaymentInfo:z,customers:U,handleSaleComplete:V,handleReceiptClose:O,handleAddCustomer:H,handleOpenNewCustomerDialog:K,setNewCustomerDialogOpen:Y}=((e,t)=>{let s=(0,o.useRouter)(),{user:i}=(0,n.useAuth)(),{toast:m}=(0,c.useToast)(),{customers:h,createCustomer:b}=(0,d.useCustomers)(),{addSale:N,updateSale:v}=(0,u.useSalesData)(i?.id),{updateInventoryForSale:C,updateInventoryForEditedSale:S}=x(i?.id),{logActivity:w}=(0,g.useActivityLogger)(),{currentBusiness:I}=(0,l.useBusiness)(),{settings:k}=(0,r.useBusinessSettings)(),[P,D]=(0,a.useState)(!1),[T,A]=(0,a.useState)(null),[E,L]=(0,a.useState)(!1),[B,F]=(0,a.useState)(!0),M=(0,a.useCallback)(async(a,n=!1,r=!0,l,o,c,d=!1)=>{if(!e&&o&&o(),i?.id&&a.customerName.trim()){let e=a.customerId;if(!e){let t=await (0,j.getCustomerByNameAction)(I?.id||"",a.customerName.trim());if(t)e=t.id;else try{let t=await b({fullName:a.customerName,phoneNumber:a.customerContact||null,location:a.customerAddress||null,email:null,birthday:null,gender:null,categoryId:l||null,notes:null,tags:null,socialMedia:null});t&&(e=t.id,p.toast.success(`Added ${a.customerName} to your customers list`))}catch(e){console.error("Error adding customer:",e)}}if(e&&a.id)try{await (0,j.updateSaleCustomerAction)(a.id,e)}catch(e){console.error("Error associating sale with customer:",e)}}if(!(e?await S(e.items,a.items,a.paymentStatus,void 0,a.id,a.receiptNumber,e.paymentStatus):await C(a.items,a.paymentStatus,c,a.id,a.receiptNumber)))throw console.error("Inventory update failed. Initiating rollback..."),e?m({title:"Inventory Update Failed",description:"The sale was saved, but inventory could not be updated. Please check stock levels manually.",variant:"destructive"}):await (0,j.deleteSaleAction)(a.id)?m({title:"Sale Cancelled",description:"Inventory update failed, so the sale was cancelled to ensure data consistency.",variant:"destructive"}):(console.error("CRITICAL: Failed to rollback sale after inventory failure"),m({title:"Critical Error",description:"Inventory failed to update, and we could not cancel the sale. Please contact support.",variant:"destructive"})),Error("Inventory update failed");let u=a.items.reduce((e,t)=>{let a=t.price*t.quantity,s="amount"===t.discountType?t.discountAmount||0:a*(t.discountPercentage||0)/100;return e+(a-s)},0),h=a.taxRate?u*a.taxRate/100:0,x=u+h;if(await w({activityType:e?"UPDATE":"CREATE",module:"SALES",entityType:"sale",entityId:a.id,entityName:`Sale #${a.receiptNumber}`,description:`${e?"Updated":"Created"} sale for ${a.customerName} - Total: UGX ${x.toLocaleString()}`,metadata:{receiptNumber:a.receiptNumber,customerName:a.customerName,customerAddress:a.customerAddress,customerContact:a.customerContact,totalAmount:x,amountPaid:a.amountPaid,profit:a.profit,paymentStatus:a.paymentStatus,taxRate:a.taxRate,itemCount:a.items.length,items:a.items.map(e=>({description:e.description,quantity:e.quantity,price:e.price,cost:e.cost,total:e.quantity*e.price,discountPercentage:e.discountPercentage,discountAmount:e.discountAmount})),notes:a.notes}}),m({title:e?"Sale Updated":"Sale Created",description:`${e?"Updated":"Created"} sale for ${a.customerName}. ${"NOT PAID"===a.paymentStatus?"Inventory has been updated for this credit sale.":""}`}),Object.keys(localStorage).forEach(e=>{e.startsWith("soldItems_")&&localStorage.removeItem(e)}),A(a),e?v(a):N(a),F(r),n){if(D(!0),d)try{let e=await (0,y.generateThermalReceipt)(a,k);await (0,f.print)(e,k.defaultPrinterName)}catch(e){console.error("Auto-print failed:",e),p.toast.error("Automated thermal printing failed")}}else!e&&t?t():s.push("/sales")},[i?.id,b,e,m,s,w,N,v,t]),R=(0,a.useCallback)(()=>{D(!1),!e&&t?t():s.push("/sales")},[s,e,t]);return{isReceiptOpen:P,completedSale:T,newCustomerDialogOpen:E,includePaymentInfo:B,customers:h,handleSaleComplete:M,handleReceiptClose:R,handleAddCustomer:(0,a.useCallback)(async e=>{if(!i?.id)return!1;try{if(await b(e))return L(!1),!0;return!1}catch(e){return console.error("Error adding customer:",e),!1}},[i?.id,b]),handleOpenNewCustomerDialog:(0,a.useCallback)(()=>{L(!0)},[]),setNewCustomerDialogOpen:L}})(P,A);if(w||k)return(0,t.jsx)(b,{});if(!S)return(0,t.jsx)(N,{});let X=!P||I("sales","edit"),Q=!!P||I("sales","create");return X&&Q?(0,t.jsxs)("div",{className:"max-w-4xl mx-auto",children:[!h&&(0,t.jsx)(v,{}),(0,t.jsx)(ts,{editSale:P,currency:C.currency,showDraftNotification:E,draftData:L,onLoadDraft:B,onDismissDraft:F,onSaleComplete:(e,t,a,s,n,r,l)=>V(e,t,a,s,M||n,r,l),onClearDraft:M,customers:U||[],onAddNewCustomer:K,isReceiptOpen:q,completedSale:$,includePaymentInfo:z,onReceiptClose:O,newCustomerDialogOpen:_,onCloseNewCustomerDialog:()=>Y(!1),onAddCustomer:H},D)]}):(0,t.jsxs)("div",{className:"max-w-4xl mx-auto p-6",children:[(0,t.jsxs)(te.Alert,{variant:"destructive",children:[(0,t.jsx)(tr.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)(te.AlertTitle,{children:"Access Denied"}),(0,t.jsxs)(te.AlertDescription,{children:["You do not have permission to ",P?"edit this sale":"create a new sale",". Please contact your administrator if you believe this is an error."]})]}),(0,t.jsx)("div",{className:"mt-4",children:(0,t.jsx)(R.Button,{onClick:()=>e("/sales"),variant:"outline",children:"Back to Sales"})})]})}],72702)},829121,(e,t,a)=>{let s="/NewSale";(window.__NEXT_P=window.__NEXT_P||[]).push([s,()=>e.r(72702)]),t.hot&&t.hot.dispose(function(){window.__NEXT_P.push([s])})}]);