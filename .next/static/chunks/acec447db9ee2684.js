(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,289844,349609,197704,611747,365722,630680,e=>{"use strict";var t=e.i(271645),a=e.i(422713);let s=()=>{let[e,s]=(0,t.useState)(!1),{currentBusiness:n}=(0,a.useBusiness)(),r=(0,t.useMemo)(()=>n?.id?`sale_draft_${n.id}`:"sale_draft",[n?.id]),l=(0,t.useCallback)(()=>{let e=!!localStorage.getItem(r);return s(e),e},[r]);(0,t.useEffect)(()=>{n?.id&&l()},[l,n?.id]);let i=(0,t.useCallback)((e,t)=>{if(!n?.id)return;let a={formData:e,selectedDate:t.toISOString(),savedAt:new Date().toISOString()};localStorage.setItem(r,JSON.stringify(a)),s(!0)},[r,n?.id]);return{hasDraft:e,saveDraft:i,loadDraft:(0,t.useCallback)(()=>{let e=localStorage.getItem(r);if(e)try{let t=JSON.parse(e);return{formData:t.formData,selectedDate:new Date(t.selectedDate),savedAt:new Date(t.savedAt)}}catch(e){console.error("Error parsing draft:",e),localStorage.removeItem(r),s(!1)}return null},[r]),clearDraft:(0,t.useCallback)(()=>{localStorage.removeItem(r),s(!1)},[r]),checkForDraft:l}};e.s(["useNewSaleDraft",0,e=>{let[a,n]=(0,t.useState)(!1),[r,l]=(0,t.useState)(null),{hasDraft:i,loadDraft:o,clearDraft:c,checkForDraft:d}=s();return(0,t.useEffect)(()=>{if(!e&&d()){let e=o();e&&l(e)}},[e,d,o]),{showDraftNotification:!1,draftData:r,handleLoadDraft:()=>{l(null)},handleDismissDraft:()=>{c(),n(!1),l(null)},clearDraft:c}}],289844);var n=e.i(618566),r=e.i(102594),l=e.i(908406),i=e.i(39725),o=e.i(146786),c=e.i(908962),d=e.i(850823);let u=e=>{let{products:s}=(0,c.useProducts)(e),{currentBusiness:n}=(0,a.useBusiness)(),{deductStockForSale:r,adjustStockForEditedSale:l}=(0,d.useInventoryActions)(e),[i,o]=(0,t.useState)({});return{products:s,selectedProducts:i,selectProduct:(e,t)=>{o(a=>({...a,[e]:t}))},getProductForItem:e=>{let t=i[e];return t&&s.find(e=>e.id===t)||null},updateInventoryForSale:async(e,t,a,s,l)=>"Quote"===t||r(e,s,a,l,n?.id),updateInventoryForEditedSale:async(e,t,a,s,r,i,o)=>{let c="Quote"!==o,d="Quote"!==a;return!c&&!d||l(c?e:[],d?t:[],r,s,i,n?.id)}}};var m=e.i(846696),x=e.i(457786),h=e.i(703285),p=e.i(588974),g=e.i(160615),y=e.i(95187);let f=(0,y.createServerReference)("602de18dc3faf52666fcf9224768f7ac9c1a6340ca",y.callServer,void 0,y.findSourceMapURL,"getCustomerByNameAction"),b=(0,y.createServerReference)("601a24df33adeed822b4de1bc4a7ea1dad51e405a6",y.callServer,void 0,y.findSourceMapURL,"updateSaleCustomerAction");var j=e.i(617318);e.s(["useNewSaleActions",0,(e,s)=>{let c=(0,n.useRouter)(),{user:d}=(0,r.useAuth)(),{toast:y}=(0,l.useToast)(),{customers:N,createCustomer:v}=(0,i.useCustomers)(),{addSale:C,updateSale:S}=(0,o.useSalesData)(d?.id),{updateInventoryForSale:w,updateInventoryForEditedSale:I}=u(d?.id),{logActivity:P}=(0,x.useActivityLogger)(),{currentBusiness:k}=(0,a.useBusiness)(),{settings:D}=(0,g.useBusinessSettings)(),[T,A]=(0,t.useState)(!1),[E,B]=(0,t.useState)(null),[L,R]=(0,t.useState)(!1),[M,F]=(0,t.useState)(!0),q=(0,t.useCallback)(async(t,a=!1,n=!0,r,l,i,o=!1)=>{if(!e&&l&&l(),d?.id&&t.customerName.trim()){let e=t.customerId;if(!e){let a=await f(k?.id||"",t.customerName.trim());if(a)e=a.id;else try{let a=await v({fullName:t.customerName,phoneNumber:t.customerContact||null,location:t.customerAddress||null,email:null,birthday:null,gender:null,categoryId:r||null,notes:null,tags:null,socialMedia:null});a&&(e=a.id,m.toast.success(`Added ${t.customerName} to your customers list`))}catch(e){console.error("Error adding customer:",e)}}if(e&&t.id)try{await b(t.id,e)}catch(e){console.error("Error associating sale with customer:",e)}}if(!(e?await I(e.items,t.items,t.paymentStatus,void 0,t.id,t.receiptNumber,e.paymentStatus):await w(t.items,t.paymentStatus,i,t.id,t.receiptNumber)))throw console.error("Inventory update failed. Initiating rollback..."),e?y({title:"Inventory Update Failed",description:"The sale was saved, but inventory could not be updated. Please check stock levels manually.",variant:"destructive"}):await (0,j.deleteSaleAction)(t.id)?y({title:"Sale Cancelled",description:"Inventory update failed, so the sale was cancelled to ensure data consistency.",variant:"destructive"}):(console.error("CRITICAL: Failed to rollback sale after inventory failure"),y({title:"Critical Error",description:"Inventory failed to update, and we could not cancel the sale. Please contact support.",variant:"destructive"})),Error("Inventory update failed");let u=t.items.reduce((e,t)=>{let a=t.price*t.quantity,s="amount"===t.discountType?t.discountAmount||0:a*(t.discountPercentage||0)/100;return e+(a-s)},0),x=t.taxRate?u*t.taxRate/100:0,g=u+x;if(await P({activityType:e?"UPDATE":"CREATE",module:"SALES",entityType:"sale",entityId:t.id,entityName:`Sale #${t.receiptNumber}`,description:`${e?"Updated":"Created"} sale for ${t.customerName} - Total: UGX ${g.toLocaleString()}`,metadata:{receiptNumber:t.receiptNumber,customerName:t.customerName,customerAddress:t.customerAddress,customerContact:t.customerContact,totalAmount:g,amountPaid:t.amountPaid,profit:t.profit,paymentStatus:t.paymentStatus,taxRate:t.taxRate,itemCount:t.items.length,items:t.items.map(e=>({description:e.description,quantity:e.quantity,price:e.price,cost:e.cost,total:e.quantity*e.price,discountPercentage:e.discountPercentage,discountAmount:e.discountAmount})),notes:t.notes}}),y({title:e?"Sale Updated":"Sale Created",description:`${e?"Updated":"Created"} sale for ${t.customerName}. ${"NOT PAID"===t.paymentStatus?"Inventory has been updated for this credit sale.":""}`}),Object.keys(localStorage).forEach(e=>{e.startsWith("soldItems_")&&localStorage.removeItem(e)}),B(t),e?S(t):C(t),F(n),a){if(A(!0),o)try{let e=await (0,h.generateThermalReceipt)(t,D);await (0,p.print)(e,D.defaultPrinterName)}catch(e){console.error("Auto-print failed:",e),m.toast.error("Automated thermal printing failed")}}else!e&&s?s():c.push("/sales")},[d?.id,v,e,y,c,P,C,S,s]),$=(0,t.useCallback)(()=>{A(!1),!e&&s?s():c.push("/sales")},[c,e,s]);return{isReceiptOpen:T,completedSale:E,newCustomerDialogOpen:L,includePaymentInfo:M,customers:N,handleSaleComplete:q,handleReceiptClose:$,handleAddCustomer:(0,t.useCallback)(async e=>{if(!d?.id)return!1;try{if(await v(e))return R(!1),!0;return!1}catch(e){return console.error("Error adding customer:",e),!1}},[d?.id,v]),handleOpenNewCustomerDialog:(0,t.useCallback)(()=>{R(!0)},[]),setNewCustomerDialogOpen:R}}],349609);var N=e.i(843476);e.s(["default",0,()=>(0,N.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,N.jsxs)("div",{className:"animate-pulse",children:[(0,N.jsx)("div",{className:"h-8 bg-gray-200 rounded w-48 mb-4"}),(0,N.jsx)("div",{className:"h-64 bg-gray-200 rounded"})]})})],197704),e.s(["default",0,()=>{let e=(0,n.useRouter)();return(0,N.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,N.jsxs)("div",{className:"bg-amber-50 border border-amber-200 p-4 rounded-md",children:[(0,N.jsx)("p",{className:"text-amber-800 mb-4",children:"No business location found. Please create a business location to manage sales."}),(0,N.jsx)("button",{onClick:()=>e.push("/business-management"),className:"bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700",children:"Manage Business Locations"})]})})}],611747),e.s(["default",0,()=>(0,N.jsx)("div",{className:"bg-amber-50 border border-amber-200 p-4 rounded-md mb-6",children:(0,N.jsx)("p",{className:"text-amber-800",children:"You need to be signed in to create or edit sales. All sales are saved to your Supabase database."})})],365722);var v=e.i(589271),C=e.i(230994),S=e.i(555781),w=e.i(966265);let I={description:"",quantity:1,price:0,cost:0},P={description:"",quantity:1,price:0,cost:0};var k=e.i(416610),D=e.i(98363);let T=(0,y.createServerReference)("40db42f6103f55b9f7ade5c65ca70a00feff7ff278",y.callServer,void 0,y.findSourceMapURL,"findCashTransactionAction");var A=e.i(44686),E=e.i(304228),B=e.i(266027);let L=(0,y.createServerReference)("707be093cac72269888b676c90752075900286c135",y.callServer,void 0,y.findSourceMapURL,"upsertSaleAction");var R=e.i(515288),M=e.i(519455),F=e.i(871689),q=e.i(367240),$=e.i(401851),z=e.i(747697),U=e.i(227766),_=e.i(337822),H=e.i(110204),O=e.i(975157);let K=({selectedDate:e,onDateChange:t})=>(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"date",children:"Date"}),(0,N.jsxs)(_.Popover,{children:[(0,N.jsx)(_.PopoverTrigger,{asChild:!0,children:(0,N.jsxs)(M.Button,{variant:"outline",className:(0,O.cn)("w-full justify-start text-left font-normal",!e&&"text-muted-foreground"),children:[(0,N.jsx)(z.CalendarIcon,{className:"mr-2 h-4 w-4"}),e?(0,$.format)(e,"PPP"):(0,N.jsx)("span",{children:"Pick a date"})]})}),(0,N.jsx)(_.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,N.jsx)(U.Calendar,{mode:"single",selected:e,onSelect:e=>{e&&t(new Date(e.getFullYear(),e.getMonth(),e.getDate(),12,0,0))},initialFocus:!0,className:(0,O.cn)("p-3 pointer-events-auto")})})]})]});var V=e.i(793479),Q=e.i(643531),X=e.i(967489),W=e.i(965901);let Y=({customerName:e,customerAddress:a,customerContact:s,notes:n="",onCustomerInfoChange:r,errors:l,customers:i=[],onAddNewCustomer:o,onSelectCustomer:c,selectedCategoryId:d,onCategoryChange:u})=>{let[m,x]=(0,t.useState)(!1),[h,p]=(0,t.useState)(""),[g,y]=(0,t.useState)(""),{categories:f}=(0,W.useCustomerCategories)(),b=i?.filter(e=>e.fullName.toLowerCase().includes(h.toLowerCase()))||[];(0,t.useEffect)(()=>{if(p(e),e.trim()){let t=i.find(t=>t.fullName===e);if(t&&t.categoryId){let e=f.find(e=>e.id===t.categoryId);y(e?.name||"")}else y("")}else y("")},[e,i,f]),(0,t.useEffect)(()=>{if(d){let e=f.find(e=>e.id===d);y(e?.name||"")}else y("")},[d,f]);let j=e.trim()&&i.some(t=>t.fullName===e);return(0,N.jsxs)("div",{className:"space-y-4",children:[(0,N.jsx)("h3",{className:"text-lg font-semibold",children:"Customer Information"}),(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"customerName",children:"Customer Name"}),(0,N.jsxs)("div",{className:"flex flex-col space-y-2 relative",children:[(0,N.jsx)(V.Input,{id:"customerName",name:"customerName",value:e,onChange:e=>{let t=e.target.value;p(t),r(e),t.trim()?x(!0):(x(!1),y(""),u&&u(""))},onFocus:()=>h.trim()&&x(!0),onBlur:()=>{setTimeout(()=>{x(!1)},200)},onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("customerAddress")?.focus())},className:(0,O.cn)(l.customerName?"border-red-500":"","w-full"),placeholder:"Start typing customer name...",autoComplete:"off"}),m&&(0,N.jsx)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border rounded-md shadow-lg z-50 max-h-60 overflow-y-auto",children:b.length>0?b.map(t=>{let a=(e=>{if(!e)return null;let t=f.find(t=>t.id===e);return t?.name||null})(t.categoryId||null);return(0,N.jsx)("div",{className:"px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b last:border-0 border-gray-100 dark:border-gray-700 transition-colors",onMouseDown:e=>{e.preventDefault();if(x(!1),c&&c(t),t.categoryId){let e=f.find(e=>e.id===t.categoryId);y(e?.name||""),u&&u(t.categoryId)}else y(""),u&&u("")},children:(0,N.jsx)("div",{className:"flex items-start justify-between gap-2",children:(0,N.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,N.jsxs)("div",{className:"flex items-center gap-2 mb-0.5",children:[e===t.fullName&&(0,N.jsx)(Q.Check,{className:"h-4 w-4 text-green-500 shrink-0"}),(0,N.jsx)("span",{className:"font-medium text-sm truncate uppercase tracking-tight",children:t.fullName}),a&&(0,N.jsx)("span",{className:"text-[10px] font-bold bg-primary/10 text-primary px-1.5 py-0.5 rounded leading-none uppercase",children:a})]}),(0,N.jsxs)("div",{className:"flex flex-wrap gap-x-3 gap-y-1 text-xs text-muted-foreground mt-1",children:[t.location&&(0,N.jsxs)("span",{className:"flex items-center gap-1",children:[(0,N.jsx)("span",{className:"opacity-70 italic text-[11px]",children:"at"})," ",t.location]}),t.phoneNumber&&(0,N.jsx)("span",{className:"flex items-center gap-1",children:(0,N.jsx)("span",{className:"opacity-70 tabular-nums",children:t.phoneNumber})})]})]})})},t.id)}):(0,N.jsxs)("div",{className:"px-4 py-6 text-center text-muted-foreground",children:[(0,N.jsx)("p",{className:"text-sm",children:"No customers found"}),(0,N.jsx)("p",{className:"text-xs opacity-70 mt-1",children:"Try a different search or add a new customer"})]})}),l.customerName&&(0,N.jsx)("p",{className:"text-red-500 text-xs",children:l.customerName})]})]}),(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"customerAddress",children:"Customer Address"}),(0,N.jsx)(V.Input,{id:"customerAddress",name:"customerAddress",value:a,onChange:r,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("customerContact")?.focus())}})]}),(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"customerContact",children:"Customer Contact"}),(0,N.jsx)(V.Input,{id:"customerContact",name:"customerContact",value:s,onChange:r,onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.getElementById("customerCategory"),a=document.querySelector('[role="combobox"]');t?t.focus():a?a.focus():document.getElementById("description-0")?.focus()}}})]}),(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"customerCategory",children:"Customer Category"}),j?(0,N.jsx)(V.Input,{id:"customerCategory",value:g,readOnly:!0,className:"bg-gray-50 dark:bg-gray-800",placeholder:"Category from existing customer",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("description-0")?.focus())}}):(0,N.jsxs)(X.Select,{value:d||"none",onValueChange:e=>{if("none"===e)y(""),u&&u("");else{let t=f.find(t=>t.id===e);t&&(y(t.name),u&&u(e))}},onOpenChange:e=>{e||setTimeout(()=>{document.getElementById("description-0")?.focus()},100)},children:[(0,N.jsx)(X.SelectTrigger,{onKeyDown:e=>{"Enter"===e.key&&setTimeout(()=>{document.getElementById("description-0")?.focus()},100)},children:(0,N.jsx)(X.SelectValue,{placeholder:"Select a category"})}),(0,N.jsxs)(X.SelectContent,{children:[(0,N.jsx)(X.SelectItem,{value:"none",children:"No Category"}),f.filter(e=>e.id&&""!==e.id.trim()).map(e=>(0,N.jsx)(X.SelectItem,{value:e.id,children:e.name},e.id))]})]})]}),o&&(0,N.jsx)(M.Button,{type:"button",variant:"outline",onClick:o,className:"w-full mt-2",children:"Add New Customer"})]})},G=({isEditing:e,selectedDate:t,onDateChange:a,customerName:s,customerAddress:r,customerContact:l,notes:i,onCustomerInfoChange:o,errors:c,customers:d,onAddNewCustomer:u,onSelectCustomer:m,selectedCategoryId:x,onCategoryChange:h,onClearForm:p})=>{let g=(0,n.useRouter)();return(0,N.jsxs)(R.Card,{className:"mb-6",children:[(0,N.jsx)(R.CardHeader,{children:(0,N.jsxs)("div",{className:"flex items-center justify-between",children:[(0,N.jsxs)("div",{className:"flex items-center gap-3",children:[(0,N.jsx)(M.Button,{variant:"ghost",size:"icon",onClick:()=>{g.push("/sales")},type:"button",className:"h-8 w-8",children:(0,N.jsx)(F.ArrowLeft,{className:"h-4 w-4"})}),(0,N.jsxs)("div",{children:[(0,N.jsx)(R.CardTitle,{children:e?"Edit Sale":"New Sale"}),(0,N.jsx)(R.CardDescription,{children:"Enter the sale details below"})]})]}),!e&&p&&(0,N.jsxs)(M.Button,{variant:"outline",size:"sm",onClick:p,type:"button",className:"flex items-center gap-2",children:[(0,N.jsx)(q.RotateCcw,{className:"h-4 w-4"}),"Clear Form"]})]})}),(0,N.jsxs)(R.CardContent,{className:"space-y-6",children:[(0,N.jsx)(K,{selectedDate:t,onDateChange:a}),(0,N.jsx)(Y,{customerName:s,customerAddress:r,customerContact:l,notes:i,onCustomerInfoChange:o,errors:c,customers:d,onAddNewCustomer:u,onSelectCustomer:m,selectedCategoryId:x,onCategoryChange:h})]})]})};var J=e.i(107233),Z=e.i(624687),ee=e.i(727612),et=e.i(286536),ea=e.i(77705);let es=(0,e.i(475254).default)("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);var en=e.i(414877),er=e.i(669469),el=e.i(746798),ei=e.i(107308),eo=e.i(487486),ec=e.i(899426),ed=e.i(392401);let eu=({item:e,index:s,onUpdate:n,onRemove:l,saleDate:i})=>{let o,c,{settings:d}=(0,g.useBusinessSettings)(),u=d.currency||"USD",{user:x}=(0,r.useAuth)(),{currentBusiness:h}=(0,a.useBusiness)(),{canViewCostPrice:p,canViewSellingPrice:y,formatFinancial:f}=(0,ed.useFinancialVisibility)(),[b,j]=(0,t.useState)(e.description||""),v=(0,en.useIsMobile)(),[C,w]=(0,t.useState)(!1),[I,P]=(0,t.useState)(!1),[k,D]=(0,t.useState)((0,O.formatNumberInput)(e.quantity?.toString()||"0")),[T,A]=(0,t.useState)((0,O.formatNumberInput)(e.price?.toString()||"0")),[E,L]=(0,t.useState)((0,O.formatNumberInput)(e.cost?.toString()||"0")),[R,F]=(0,t.useState)((0,O.formatNumberInput)(e.discountAmount?.toString()||"0")),[q,$]=(0,t.useState)((0,O.formatNumberInput)(e.discountPercentage?.toString()||"0")),[z,U]=(0,t.useState)(e.description||"");(0,t.useEffect)(()=>{let e=setTimeout(()=>{U(b)},300);return()=>clearTimeout(e)},[b]);let{data:K=[]}=(0,B.useQuery)({queryKey:["all-products",x?.id,h?.id],queryFn:async()=>x?.id&&h?.id?await (0,S.getAllProductsAction)(x.id,h.id):[],enabled:!!x?.id&&!!h?.id,staleTime:3e5}),Q=(0,t.useMemo)(()=>z.trim()?K.filter(e=>(0,ec.matchProductSearch)(e,z)).slice(0,20):[],[K,z]);(0,t.useEffect)(()=>{j(e.description||""),Math.abs((parseFloat(k.replace(/,/g,""))||0)-e.quantity)>.001&&D(0===e.quantity&&""===k?"":e.quantity.toString()),Math.abs((parseFloat(T.replace(/,/g,""))||0)-e.price)>.001&&A(0===e.price&&""===T?"":e.price.toString()),Math.abs((parseFloat(E.replace(/,/g,""))||0)-e.cost)>.001&&L(0===e.cost&&""===E?"":e.cost.toString()),Math.abs((parseFloat(R.replace(/,/g,""))||0)-(e.discountAmount||0))>.001&&F(e.discountAmount?.toString()||"0"),Math.abs((parseFloat(q.replace(/,/g,""))||0)-(e.discountPercentage||0))>.001&&$(e.discountPercentage?.toString()||"0")},[e.description,e.quantity,e.price,e.cost,e.discountAmount,e.discountPercentage]);let X=e.price*e.quantity,W="amount"===e.discountType?e.discountAmount||0:X*(e.discountPercentage||0)/100,Y=t=>{let{name:a,value:r}=t.target;if("description"===a){j(r),P(""!==r.trim());return}let l=(0,O.formatNumberInput)(r),i=(0,O.parseNumberInput)(r);if("quantity"===a){D(l),n(s,{...e,quantity:i});return}if("price"===a){A(l),n(s,{...e,price:i});return}if("cost"===a){L(l),n(s,{...e,cost:i});return}if("discountAmount"===a){F(l),n(s,{...e,discountAmount:i});return}if("discountPercentage"===a){$(l),n(s,{...e,discountPercentage:i});return}n(s,{...e,[a]:i})},G=t=>{let a=(0,O.parseNumberInput)(t.target.value)/(e.quantity||1);L((0,O.formatNumberInput)(a.toString())),n(s,{...e,cost:a})},J=e.productId?Q.find(t=>t.id===e.productId):null,eu=J&&i&&(o=new Date(J.createdAt),c=new Date(i).setHours(0,0,0,0),new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()>c);return(0,N.jsxs)("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[(0,N.jsxs)("div",{className:"flex justify-between items-start",children:[(0,N.jsxs)("h3",{className:"text-sm font-medium",children:["Item ",s+1]}),(0,N.jsxs)("div",{className:"flex space-x-2",children:[(0,N.jsxs)(M.Button,{variant:"outline",size:"sm",onClick:()=>{j(""),P(!1),e.quantity;let t={...e,description:"",price:0,cost:0,productId:null,discountAmount:0,discountPercentage:0};A("0"),L("0"),F("0"),$("0"),n(s,t),m.toast.success("Item cleared")},className:"text-gray-600 hover:text-gray-800",children:[(0,N.jsx)(es,{className:"h-4 w-4 mr-1"}),(0,N.jsx)("span",{className:"hidden sm:inline",children:"Clear"})]}),(0,N.jsxs)(M.Button,{variant:"ghost",size:"sm",onClick:()=>l(s),className:"text-destructive hover:text-destructive",children:[(0,N.jsx)(ee.Trash2,{className:"h-4 w-4"}),(0,N.jsx)("span",{className:"sr-only",children:"Remove Item"})]})]})]}),(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`description-${s}`,className:"text-sm font-medium",children:"Product / Service"}),(0,N.jsxs)("div",{className:"flex space-x-2",children:[(0,N.jsxs)("div",{className:"flex-grow relative",children:[(0,N.jsx)(Z.Textarea,{id:`description-${s}`,name:"description",value:b,onChange:Y,placeholder:"Enter product name",onFocus:()=>""!==b.trim()&&P(!0),onBlur:()=>{b!==e.description&&n(s,{...e,description:b})},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),document.getElementById(`quantity-${s}`)?.focus())},className:v?"min-h-16 text-base":""}),I&&""!==b.trim()&&Q.length>0&&(0,N.jsx)("div",{className:"absolute z-10 mt-1 w-full bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:Q.map(t=>(0,N.jsxs)("div",{className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center",onClick:()=>{j(t.name),P(!1),A((0,O.formatNumberInput)(t.sellingPrice.toString())),L((0,O.formatNumberInput)(t.costPrice.toString())),n(s,{...e,description:t.name,price:t.sellingPrice,cost:t.costPrice,productId:t.id})},children:[(0,N.jsxs)("div",{className:"flex items-center",children:[(0,N.jsx)(er.default,{imageUrl:t.imageUrl,alt:t.name,size:"sm"}),(0,N.jsxs)("div",{className:"ml-3",children:[(0,N.jsxs)("div",{className:"font-medium flex items-center gap-2",children:[t.name,t.category&&(0,N.jsx)(eo.Badge,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-4 bg-gray-100 text-gray-500 font-normal",children:t.category})]}),(0,N.jsx)("div",{className:"text-xs text-gray-500",children:y?`${u} ${t.sellingPrice.toFixed(2)}`:"Price Hidden"})]})]}),(0,N.jsxs)("div",{className:"text-xs",children:[parseFloat(t.quantity.toFixed(5)).toString()," in stock"]})]},t.id))})]}),eu&&(0,N.jsxs)("div",{className:"mt-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[(0,N.jsx)("p",{className:"text-sm text-red-700 font-medium",children:"ðŸš« Error: This product was created after the sale date. The sale cannot be created or updated."}),(0,N.jsx)("p",{className:"text-xs text-red-600 mt-1",children:"Please adjust the sale date or select a different product to continue."})]})]})]}),v?(0,N.jsxs)("div",{className:"space-y-4",children:[(0,N.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`quantity-${s}`,className:"text-sm font-medium",children:"Quantity"}),(0,N.jsx)(V.Input,{id:`quantity-${s}`,name:"quantity",type:"text",inputMode:"decimal",value:k,onChange:Y,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById(`price-${s}`)?.focus())},className:"h-12 text-lg"})]}),(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`price-${s}`,className:"text-sm font-medium",children:"Price per unit"}),(0,N.jsx)(V.Input,{id:`price-${s}`,name:"price",type:"text",inputMode:"decimal",value:T,onChange:Y,onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.getElementById(`price-${s}`);t?.focus()}},className:"h-12 text-lg"})]})]}),(0,N.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsxs)("div",{className:"flex items-center justify-between",children:[(0,N.jsx)(H.Label,{className:"text-sm font-medium",children:"Discount"}),(0,N.jsxs)("select",{value:e.discountType||"percentage",onChange:t=>{let a=t.target.value,r={...e,discountType:a};"percentage"===a?(r.discountAmount=0,F("0")):(r.discountPercentage=0,$("0")),n(s,r)},className:"flex-shrink-0 w-12 h-8 text-xs border border-input bg-background px-1 rounded-md",children:[(0,N.jsx)("option",{value:"percentage",children:"%"}),(0,N.jsx)("option",{value:"amount",children:u})]})]}),(0,N.jsx)(V.Input,{name:"amount"===e.discountType?"discountAmount":"discountPercentage",type:"text",inputMode:"decimal",value:"amount"===e.discountType?R:q,onChange:Y,placeholder:"0",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("taxRate")?.focus())},className:"h-12 text-lg"})]}),p&&(0,N.jsx)("div",{className:"space-y-2",children:(0,N.jsxs)(ei.Collapsible,{open:C,onOpenChange:w,children:[(0,N.jsxs)("div",{className:"flex items-center justify-between",children:[(0,N.jsx)(H.Label,{className:"text-sm font-medium text-gray-500",children:"Cost Info"}),(0,N.jsx)(ei.CollapsibleTrigger,{asChild:!0,children:(0,N.jsx)(M.Button,{variant:"ghost",size:"sm",className:"p-1 h-8 w-8",children:C?(0,N.jsx)(ea.EyeOff,{className:"h-4 w-4 text-gray-500"}):(0,N.jsx)(et.Eye,{className:"h-4 w-4 text-gray-500"})})})]}),(0,N.jsxs)(ei.CollapsibleContent,{className:"space-y-4 pt-2",children:[(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`cost-${s}`,className:"text-xs text-gray-500",children:"Cost per unit"}),(0,N.jsx)(V.Input,{id:`cost-${s}`,name:"cost",type:"text",inputMode:"decimal",value:E,onChange:Y,className:"h-12 text-lg"})]}),(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`total-cost-${s}`,className:"text-xs text-gray-500",children:"Total Cost"}),(0,N.jsx)(V.Input,{id:`total-cost-${s}`,name:"totalCost",type:"text",inputMode:"decimal",value:(0,O.formatNumber)(e.cost*e.quantity),onChange:G,className:"h-12 text-lg font-semibold bg-gray-50"})]}),(0,N.jsx)("p",{className:"text-xs text-muted-foreground",children:"(Internal use only)"})]})]})})]})]}):(0,N.jsxs)("div",{className:"grid grid-cols-4 gap-4",children:[(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`quantity-${s}`,children:"Quantity"}),(0,N.jsx)(V.Input,{id:`quantity-${s}`,name:"quantity",type:"text",inputMode:"decimal",value:k,onChange:Y,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById(`price-${s}`)?.focus())}})]}),(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`price-${s}`,children:"Price per unit"}),(0,N.jsx)(V.Input,{id:`price-${s}`,name:"price",type:"text",inputMode:"decimal",value:T,onChange:Y,onKeyDown:t=>{if("Enter"===t.key){t.preventDefault();let a=document.querySelector(`input[name="${"amount"===e.discountType?"discountAmount":"discountPercentage"}"]`);a?.focus()}}})]}),(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{children:"Discount"}),(0,N.jsxs)("div",{className:"flex gap-1",children:[(0,N.jsxs)("select",{value:e.discountType||"percentage",onChange:t=>{let a=t.target.value,r={...e,discountType:a};"percentage"===a?(r.discountAmount=0,F("0")):(r.discountPercentage=0,$("0")),n(s,r)},className:"flex-shrink-0 w-12 text-xs border border-input bg-background px-1 py-2 rounded-md",children:[(0,N.jsx)("option",{value:"percentage",children:"%"}),(0,N.jsx)("option",{value:"amount",children:u})]}),(0,N.jsx)(V.Input,{name:"amount"===e.discountType?"discountAmount":"discountPercentage",type:"text",inputMode:"decimal",value:"amount"===e.discountType?R:q,onChange:Y,placeholder:"0",onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("taxRate")?.focus())},className:"flex-1"})]})]}),p&&(0,N.jsx)("div",{className:"space-y-2",children:(0,N.jsxs)(_.Popover,{children:[(0,N.jsxs)("div",{className:"flex items-center justify-between",children:[(0,N.jsx)(H.Label,{className:"text-gray-500",children:"Cost Info"}),(0,N.jsx)(el.TooltipProvider,{children:(0,N.jsxs)(el.Tooltip,{children:[(0,N.jsx)(el.TooltipTrigger,{asChild:!0,children:(0,N.jsx)(_.PopoverTrigger,{asChild:!0,children:(0,N.jsx)(M.Button,{variant:"ghost",size:"sm",className:"p-0 h-6 w-6",children:(0,N.jsx)(et.Eye,{className:"h-4 w-4 text-gray-500"})})})}),(0,N.jsx)(el.TooltipContent,{children:(0,N.jsx)("p",{children:"Click to view/edit cost"})})]})})]}),(0,N.jsx)(_.PopoverContent,{className:"w-64 p-4 bg-white shadow-xl border",children:(0,N.jsxs)("div",{className:"space-y-4",children:[(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{htmlFor:`cost-popover-${s}`,className:"text-xs",children:"Cost per unit"}),(0,N.jsx)(V.Input,{id:`cost-popover-${s}`,name:"cost",type:"text",inputMode:"decimal",value:E,onChange:Y})]}),(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsxs)(H.Label,{htmlFor:`total-cost-popover-${s}`,className:"text-xs",children:["Total Cost (for ",e.quantity," units)"]}),(0,N.jsx)(V.Input,{id:`total-cost-popover-${s}`,name:"totalCost",type:"text",value:(0,O.formatNumber)(e.cost*e.quantity),onChange:G,className:"font-bold bg-gray-50"})]}),(0,N.jsx)("div",{className:"pt-2 border-t",children:(0,N.jsx)("p",{className:"text-[10px] text-muted-foreground",children:"Costs entered here only apply to this specific sale and do not change the product's base price in inventory."})})]})})]})})]}),(0,N.jsx)("div",{className:"pt-2 border-t mt-2",children:(0,N.jsxs)("div",{className:"flex justify-end items-center space-y-1 flex-col",children:[((e.discountPercentage||0)>0||(e.discountAmount||0)>0)&&(0,N.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,N.jsx)("span",{className:"text-xs text-muted-foreground mr-2",children:"Subtotal:"}),(0,N.jsxs)("span",{className:"text-xs text-muted-foreground line-through",children:[u," ",(0,O.formatNumber)(X)]})]}),((e.discountPercentage||0)>0||(e.discountAmount||0)>0)&&(0,N.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,N.jsxs)("span",{className:"text-xs text-green-600 mr-2",children:["Discount ","amount"===e.discountType?"":`(${e.discountPercentage}%)`,":"]}),(0,N.jsxs)("span",{className:"text-xs text-green-600",children:["-",u," ",(0,O.formatNumber)(W)]})]}),(0,N.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,N.jsx)("span",{className:"text-sm font-medium mr-2",children:"Total:"}),(0,N.jsxs)("span",{className:"text-sm font-bold",children:[u," ",(0,O.formatNumber)(X-W)]})]})]})})]})},em=({items:e,onAddItem:t,onUpdateItem:a,onRemoveItem:s,saleDate:n})=>(0,N.jsxs)("div",{className:"space-y-4",children:[(0,N.jsx)("h3",{className:"text-lg font-semibold",children:"Items/Services"}),(0,N.jsxs)("div",{className:"space-y-4",children:[e.map((e,t)=>(0,N.jsx)("div",{id:`sale-item-${t}`,children:(0,N.jsx)(eu,{item:e,index:t,onUpdate:a,onRemove:s,saleDate:n})},t)),(0,N.jsxs)(M.Button,{type:"button",variant:"outline",size:"sm",onClick:()=>t(),className:"gap-1 w-full mt-2",children:[(0,N.jsx)(J.Plus,{className:"h-4 w-4"}),"Add Item"]})]})]}),ex=({taxRateInput:e,onTaxRateChange:t,errors:a})=>(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"taxRate",children:"Tax Rate (%)"}),(0,N.jsx)(V.Input,{id:"taxRate",name:"taxRate",type:"text",inputMode:"decimal",value:e,onChange:t,onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.querySelector('[data-payment-status-select="true"]');if(t)t.focus();else{let e=document.querySelector('button[type="submit"]');e?.focus()}}},className:a.taxRate?"border-red-500":""}),a.taxRate&&(0,N.jsx)("p",{className:"text-red-500 text-xs",children:a.taxRate})]}),eh=({totalAmount:e,taxAmount:t,grandTotal:a,taxRate:s,currency:n})=>(0,N.jsx)("div",{className:"bg-slate-50 p-4 rounded-md border",children:(0,N.jsxs)("div",{className:"flex flex-col space-y-2",children:[(0,N.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,N.jsx)("h3",{className:"font-medium",children:"Subtotal"}),(0,N.jsxs)("span",{className:"font-medium",children:[n," ",(0,O.formatNumber)(e)]})]}),s>0&&(0,N.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,N.jsxs)("h3",{className:"font-medium",children:["Tax (",s,"%)"]}),(0,N.jsxs)("span",{className:"font-medium",children:[n," ",(0,O.formatNumber)(t)]})]}),(0,N.jsx)("div",{className:"h-px bg-gray-300 my-1"}),(0,N.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,N.jsx)("h3",{className:"font-semibold",children:"Grand Total"}),(0,N.jsxs)("span",{className:"text-xl font-bold",children:[n," ",(0,O.formatNumber)(a)]})]})]})}),ep=({items:e,onAddItem:a,onUpdateItem:s,onRemoveItem:n,taxRateInput:r,onTaxRateChange:l,errors:i,totalAmount:o,taxAmount:c,grandTotal:d,taxRate:u,currency:m,saleDate:x})=>{let h=t.default.useRef(e);return t.default.useEffect(()=>{let t=h.current,a=-1;e.length>t.length?a=e.length-1:e.length===t.length&&(a=e.findIndex((e,a)=>{let s=t[a];return s&&e.quantity!==s.quantity})),h.current=e,-1!==a&&setTimeout(()=>{let e=document.getElementById(`sale-item-${a}`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})},150)},[e]),(0,N.jsx)(R.Card,{className:"mb-6",children:(0,N.jsxs)(R.CardContent,{className:"pt-6 space-y-6",children:[(0,N.jsx)(em,{items:e,onAddItem:a,onUpdateItem:s,onRemoveItem:n,saleDate:x}),(0,N.jsx)(ex,{taxRateInput:r,onTaxRateChange:l,errors:i}),(0,N.jsx)(eh,{totalAmount:o,taxAmount:c,grandTotal:d,taxRate:u,currency:m})]})})},eg=({paymentStatus:e,onPaymentStatusChange:t})=>(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"paymentStatus",children:"Payment Status"}),(0,N.jsxs)(X.Select,{value:e,onValueChange:t,children:[(0,N.jsx)(X.SelectTrigger,{className:"w-full","data-payment-status-select":"true",onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.querySelector('[data-cash-account-switch="true"]');if(t)t.focus();else{let e=document.querySelector('button[type="submit"]');e?.focus()}}},children:(0,N.jsx)(X.SelectValue,{placeholder:"Select payment status"})}),(0,N.jsxs)(X.SelectContent,{children:[(0,N.jsx)(X.SelectItem,{value:"Paid",children:"Paid"}),(0,N.jsx)(X.SelectItem,{value:"NOT PAID",children:"NOT PAID"}),(0,N.jsx)(X.SelectItem,{value:"Quote",children:"Quote"}),(0,N.jsx)(X.SelectItem,{value:"Installment Sale",children:"Installment Sale"})]})]})]});var ey=e.i(784774),ef=e.i(503116),eb=e.i(37727),ej=e.i(283627),eN=e.i(221345);let ev=({payments:e,currency:a,isLoading:s,pendingChanges:n=[],isLocalMode:r=!1,onStageChange:l,cashAccounts:i=[],onLinkToCash:o,onUpdatePayment:c})=>{let[d,u]=(0,t.useState)(null),[m,x]=(0,t.useState)(null),[h,p]=(0,t.useState)(""),[g,y]=(0,t.useState)(""),[f,b]=(0,t.useState)(void 0),[j,v]=(0,t.useState)(null),[C,S]=(0,t.useState)(""),w=(e,t)=>{u(e.id),x(t||null),p(E(e).toString()),y(B(e)||""),b(e.paymentDate)},I=async e=>{c&&"deleted"!==A(e.id)&&w(e,"date")},P=async(e,t)=>{if(t&&c){console.log("ðŸ”µ Date selected:",{paymentId:e.id,oldDate:e.paymentDate,newDate:t,formattedNew:(0,$.format)(t,"yyyy-MM-dd")});try{await c(e.id,{paymentDate:t}),console.log("âœ… Date update successful"),l&&l({id:e.id,type:"update",originalPayment:e,updatedData:{paymentDate:t}}),u(null),x(null),b(void 0)}catch(t){console.error("âŒ Error updating payment date:",t),b(e.paymentDate)}}},k=async e=>{if(!l&&!c)return;let t=""===h?0:parseFloat(h)||0;l?l({id:e.id,type:"update",originalPayment:e,updatedData:{amount:t,notes:g.trim()||void 0}}):c&&await c(e.id,{amount:"amount"===m?t:void 0,notes:"notes"===m&&g.trim()||void 0}),u(null),x(null)},D=()=>{u(null),x(null),p(""),y(""),b(void 0)},T=e=>{if(!l)return;let t=0===e.amount;window.confirm(t?"Are you sure you want to remove this zero-amount payment entry?":"Are you sure you want to mark this payment for deletion?")&&(console.log("ðŸŸ¡ STAGING deletion locally - NO DATABASE CALL"),l({id:e.id,type:"delete",originalPayment:e}),console.log("âœ… Deletion staged successfully"))},A=e=>{let t=n.find(t=>t.id===e);return t?.type==="delete"?"deleted":t?.type==="update"?"modified":"original"},E=e=>{let t=n.find(t=>t.id===e.id&&"update"===t.type);return t?.updatedData?.amount||e.amount},B=e=>{let t=n.find(t=>t.id===e.id&&"update"===t.type);return t?.updatedData?.notes||e.notes},L=e=>!!r&&!!l&&"deleted"!==A(e.id),F=e=>{v(e),S("")},q=()=>{v(null),S("")},H=async e=>{if(o&&C)try{await o(e.id,C),v(null),S("")}catch(e){console.error("Error linking payment to cash account:",e)}};if(s)return(0,N.jsxs)(R.Card,{className:"border-blue-200 bg-blue-50",children:[(0,N.jsx)(R.CardHeader,{className:"pb-3",children:(0,N.jsx)(R.CardTitle,{className:"text-sm text-blue-800",children:"Payment History"})}),(0,N.jsx)(R.CardContent,{children:(0,N.jsx)("div",{className:"text-sm text-muted-foreground",children:"Loading payment history..."})})]});if(0===e.length)return(0,N.jsxs)(R.Card,{className:"border-blue-200 bg-blue-50",children:[(0,N.jsx)(R.CardHeader,{className:"pb-3",children:(0,N.jsx)(R.CardTitle,{className:"text-sm text-blue-800",children:"Payment History"})}),(0,N.jsx)(R.CardContent,{children:(0,N.jsx)("div",{className:"text-sm text-muted-foreground",children:"No payments recorded yet"})})]});let K=e.reduce((e,t)=>"deleted"===A(t.id)?e:e+E(t),0),W=r&&l;return console.log("InstallmentPaymentHistory - isLocalMode:",r,"onStageChange:",!!l,"showInlineEdit:",W),(0,N.jsxs)(R.Card,{className:"border-blue-200 bg-blue-50",children:[(0,N.jsx)(R.CardHeader,{className:"pb-3",children:(0,N.jsxs)(R.CardTitle,{className:"text-sm text-blue-800 flex items-center justify-between",children:[(0,N.jsxs)("div",{className:"flex items-center gap-2",children:["Payment History",r&&(0,N.jsx)(ef.Clock,{className:"h-3 w-3 text-amber-600"}),n.length>0&&(0,N.jsxs)(eo.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:[n.length," staged"]})]}),(0,N.jsxs)(eo.Badge,{variant:"secondary",className:"bg-blue-100 text-blue-800 text-xs",children:["Total: ",a," ",(0,O.formatNumber)(K)]})]})}),(0,N.jsxs)(R.CardContent,{className:"p-3 sm:p-6",children:[W&&(0,N.jsx)("div",{className:"hidden sm:block mb-4 text-xs text-muted-foreground bg-blue-50 p-2 rounded border border-blue-200",children:"ðŸ’¡ Double-click on amount or notes to edit. Click delete button to remove payments (including zero amounts)."}),(0,N.jsx)("div",{className:"block sm:hidden space-y-3",children:e.map(e=>{let t=A(e.id),s=E(e),n=B(e),r=d===e.id,l=L(e);return(0,N.jsxs)("div",{className:`bg-white rounded-lg p-3 border shadow-sm ${"deleted"===t?"border-red-200 bg-red-50 opacity-60":"modified"===t?"border-amber-200 bg-amber-50":"border-gray-200"}`,children:[(0,N.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,N.jsxs)("div",{className:"flex items-center gap-2",children:[r&&"date"===m?(0,N.jsxs)(_.Popover,{children:[(0,N.jsx)(_.PopoverTrigger,{asChild:!0,children:(0,N.jsxs)(M.Button,{variant:"outline",size:"sm",className:(0,O.cn)("h-7 text-xs justify-start text-left font-normal",!f&&"text-muted-foreground"),children:[(0,N.jsx)(z.CalendarIcon,{className:"mr-2 h-3 w-3"}),f?(0,$.format)(f,"MMM dd, yyyy"):(0,N.jsx)("span",{children:"Pick a date"})]})}),(0,N.jsx)(_.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,N.jsx)(U.Calendar,{mode:"single",selected:f,onSelect:t=>P(e,t),initialFocus:!0,className:(0,O.cn)("p-3 pointer-events-auto")})})]}):(0,N.jsx)("div",{className:`text-xs text-muted-foreground ${c?"cursor-pointer hover:text-blue-600":""}`,onClick:()=>c&&I(e),title:c?"Click to edit date":"",children:(0,$.format)(e.paymentDate,"MMM dd, yyyy")}),"deleted"===t&&(0,N.jsx)(eo.Badge,{variant:"outline",className:"text-xs bg-red-100 text-red-800 border-red-300",children:"To Delete"}),"modified"===t&&(0,N.jsx)(eo.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:"Modified"})]}),r&&"amount"===m?(0,N.jsx)("div",{className:"flex flex-col gap-2 min-w-0 flex-1 ml-2",children:(0,N.jsx)(V.Input,{type:"number",value:h,onChange:e=>p(e.target.value),className:"h-7 text-xs",step:"0.01",min:"0",placeholder:"0"})}):(0,N.jsxs)("div",{className:`text-sm font-semibold ${"deleted"===t?"line-through":""}`,children:[a," ",(0,O.formatNumber)(s)]})]}),r?(0,N.jsxs)("div",{className:"space-y-2",children:["notes"===m&&(0,N.jsx)(V.Input,{value:g,onChange:e=>y(e.target.value),placeholder:"Payment notes",className:"h-7 text-xs"}),(0,N.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,N.jsx)(M.Button,{size:"sm",variant:"outline",className:"h-6 px-2 text-xs",onClick:D,children:(0,N.jsx)(eb.X,{className:"h-3 w-3"})}),(0,N.jsx)(M.Button,{size:"sm",className:"h-6 px-2 text-xs",onClick:()=>k(e),children:(0,N.jsx)(Q.Check,{className:"h-3 w-3"})})]})]}):(0,N.jsxs)(N.Fragment,{children:[n&&(0,N.jsx)("div",{className:`text-xs text-muted-foreground mb-3 ${"deleted"===t?"line-through":""} ${c?"cursor-pointer hover:text-blue-600":""}`,onClick:()=>c&&w(e,"notes"),title:c?"Click to edit notes":"",children:n}),(0,N.jsxs)("div",{className:"mb-3",children:[(0,N.jsx)("div",{className:"text-xs text-muted-foreground mb-1",children:"Cash Account:"}),j===e.id?(0,N.jsxs)("div",{className:"flex items-center gap-2",children:[(0,N.jsxs)(X.Select,{value:C,onValueChange:S,children:[(0,N.jsx)(X.SelectTrigger,{className:"h-7 text-xs flex-1",children:(0,N.jsx)(X.SelectValue,{placeholder:"Select account"})}),(0,N.jsx)(X.SelectContent,{children:i.map(e=>(0,N.jsx)(X.SelectItem,{value:e.id,children:(0,N.jsxs)("div",{className:"flex items-center",children:[(0,N.jsx)("span",{children:e.name}),e.isDefault&&(0,N.jsx)("span",{className:"ml-1 text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded",children:"Default"})]})},e.id))})]}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-gray-500 hover:text-gray-700",onClick:q,children:(0,N.jsx)(eb.X,{className:"h-3 w-3"})}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-green-500 hover:text-green-700",onClick:()=>H(e),disabled:!C,children:(0,N.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,N.jsx)("div",{className:"flex items-center gap-2",children:e.cashTransactionId?(0,N.jsx)(eo.Badge,{variant:"outline",className:"text-xs bg-green-100 text-green-800 border-green-300",children:"Linked"}):(0,N.jsxs)(N.Fragment,{children:[(0,N.jsx)("span",{className:"text-xs text-muted-foreground",children:"Not linked"}),o&&i.length>0&&(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-blue-500 hover:text-blue-700",onClick:()=>F(e.id),title:"Link to cash account",children:(0,N.jsx)(eN.Link,{className:"h-3 w-3"})})]})})]}),W&&l&&(0,N.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,N.jsxs)(M.Button,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs text-blue-600 hover:text-blue-700 border-blue-200 hover:border-blue-300",onClick:()=>w(e),children:[(0,N.jsx)(ej.Edit3,{className:"h-3 w-3 mr-1"}),"Edit"]}),(0,N.jsxs)(M.Button,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs text-red-600 hover:text-red-700 border-red-200 hover:border-red-300",onClick:()=>T(e),children:[(0,N.jsx)(ee.Trash2,{className:"h-3 w-3 mr-1"}),"Delete"]})]})]})]},e.id)})}),(0,N.jsx)("div",{className:"hidden sm:block overflow-x-auto",children:(0,N.jsxs)(ey.Table,{children:[(0,N.jsx)(ey.TableHeader,{children:(0,N.jsxs)(ey.TableRow,{children:[(0,N.jsx)(ey.TableHead,{className:"text-xs",children:"Date"}),(0,N.jsx)(ey.TableHead,{className:"text-xs text-right",children:"Amount"}),(0,N.jsx)(ey.TableHead,{className:"text-xs",children:"Notes"}),(0,N.jsx)(ey.TableHead,{className:"text-xs",children:"Cash Account"}),W&&(0,N.jsx)(ey.TableHead,{className:"text-xs w-16",children:"Actions"})]})}),(0,N.jsx)(ey.TableBody,{children:e.map(e=>{let t=A(e.id),s=E(e),n=B(e),u=d===e.id,x=L(e);return(0,N.jsxs)(ey.TableRow,{className:"deleted"===t?"bg-red-50 opacity-60":"modified"===t?"bg-amber-50":"",children:[(0,N.jsx)(ey.TableCell,{className:"text-xs",children:(0,N.jsxs)("div",{className:"flex items-center gap-2",children:[d===e.id&&"date"===m?(0,N.jsxs)("div",{className:"flex items-center gap-1",children:[(0,N.jsxs)(_.Popover,{children:[(0,N.jsx)(_.PopoverTrigger,{asChild:!0,children:(0,N.jsxs)(M.Button,{variant:"outline",size:"sm",className:(0,O.cn)("h-7 text-xs justify-start text-left font-normal w-32",!f&&"text-muted-foreground"),children:[(0,N.jsx)(z.CalendarIcon,{className:"mr-2 h-3 w-3"}),f?(0,$.format)(f,"MMM dd, yyyy"):(0,N.jsx)("span",{children:"Pick a date"})]})}),(0,N.jsx)(_.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,N.jsx)(U.Calendar,{mode:"single",selected:f,onSelect:t=>P(e,t),initialFocus:!0,className:(0,O.cn)("p-3 pointer-events-auto")})})]}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,N.jsx)(eb.X,{className:"h-3 w-3"})}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>k(e),children:(0,N.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,N.jsx)("span",{className:`cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===t?"line-through":""} ${c?"hover:bg-blue-50":""}`,onClick:()=>c&&I(e),title:c?"Click to edit date":"",children:(0,$.format)(e.paymentDate,"MMM dd, yyyy")}),"deleted"===t&&(0,N.jsx)(eo.Badge,{variant:"outline",className:"text-xs bg-red-100 text-red-800 border-red-300",children:"To Delete"}),"modified"===t&&(0,N.jsx)(eo.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:"Modified"})]})}),(0,N.jsx)(ey.TableCell,{className:"text-xs text-right",children:u&&"amount"===m?(0,N.jsxs)("div",{className:"flex items-center gap-1 justify-end",children:[(0,N.jsx)(V.Input,{type:"number",value:h,onChange:e=>p(e.target.value),className:"h-7 text-xs w-24",step:"0.01",min:"0",autoFocus:!0,placeholder:"0"}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,N.jsx)(eb.X,{className:"h-3 w-3"})}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>k(e),children:(0,N.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,N.jsxs)("span",{className:`font-medium cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===t?"line-through":""} ${W&&x?"hover:bg-blue-50":""}`,onDoubleClick:()=>{!r||!l||"deleted"!==A(e.id)&&w(e,"amount")},title:W&&x?"Double-click to edit":"",children:[a," ",(0,O.formatNumber)(s)]})}),(0,N.jsx)(ey.TableCell,{className:"text-xs",children:u&&"notes"===m?(0,N.jsxs)("div",{className:"flex items-center gap-1",children:[(0,N.jsx)(V.Input,{value:g,onChange:e=>y(e.target.value),placeholder:"Payment notes",className:"h-7 text-xs",autoFocus:!0}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,N.jsx)(eb.X,{className:"h-3 w-3"})}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>k(e),children:(0,N.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,N.jsx)("span",{className:`text-muted-foreground cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===t?"line-through":""} ${W&&x?"hover:bg-blue-50":""}`,onDoubleClick:()=>{!r||!l||"deleted"!==A(e.id)&&w(e,"notes")},title:W&&x?"Double-click to edit":"",children:n||"-"})}),(0,N.jsx)(ey.TableCell,{className:"text-xs",children:j===e.id?(0,N.jsxs)("div",{className:"flex items-center gap-1",children:[(0,N.jsxs)(X.Select,{value:C,onValueChange:S,children:[(0,N.jsx)(X.SelectTrigger,{className:"h-7 text-xs w-32",children:(0,N.jsx)(X.SelectValue,{placeholder:"Select account"})}),(0,N.jsx)(X.SelectContent,{children:i.map(e=>(0,N.jsx)(X.SelectItem,{value:e.id,children:(0,N.jsxs)("div",{className:"flex items-center",children:[(0,N.jsx)("span",{children:e.name}),e.isDefault&&(0,N.jsx)("span",{className:"ml-1 text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded",children:"Default"})]})},e.id))})]}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:q,children:(0,N.jsx)(eb.X,{className:"h-3 w-3"})}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>H(e),disabled:!C,children:(0,N.jsx)(Q.Check,{className:"h-3 w-3"})})]}):(0,N.jsx)("div",{className:"flex items-center gap-1",children:e.cashTransactionId?(0,N.jsx)(eo.Badge,{variant:"outline",className:"text-xs bg-green-100 text-green-800 border-green-300",children:"Linked"}):o&&i.length>0&&(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-blue-500 hover:text-blue-700",onClick:()=>F(e.id),title:"Link to cash account",children:(0,N.jsx)(eN.Link,{className:"h-3 w-3"})})})}),W&&(0,N.jsx)(ey.TableCell,{className:"text-xs",children:!u&&x&&(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-red-500 hover:text-red-700",onClick:()=>T(e),title:"Delete payment",children:(0,N.jsx)(ee.Trash2,{className:"h-3 w-3"})})})]},e.id)})})]})})]})]})},eC=({amountPaid:e,amountDue:a,grandTotal:s,currency:n,onAmountPaidChange:r,onPaymentDateChange:l,paymentDate:i,maxAmount:o,saleId:c,onPaymentStatusChange:d,isEditing:u=!1,payments:m=[],pendingChanges:x=[],onStagePaymentChange:h,cashAccounts:p=[],onLinkToCash:g,onUpdatePayment:y})=>{let[f,b]=(0,t.useState)(i||new Date),[j,v]=(0,t.useState)((0,O.formatNumberInput)(e?.toString()||"0"));t.default.useEffect(()=>{Math.abs((0,O.parseNumberInput)(j)-e)>.001&&v((0,O.formatNumberInput)(e.toString()))},[e]);let C=m.filter(e=>!x.find(t=>t.id===e.id&&"delete"===t.type)).map(e=>{let t=x.find(t=>t.id===e.id&&"update"===t.type);return t&&t.updatedData?{...e,amount:t.updatedData.amount??e.amount,notes:t.updatedData.notes??e.notes}:e}).reduce((e,t)=>e+t.amount,0),S=Math.max(0,s-C),w=C>=s,I=w?0:e||0;return console.log("InstallmentPaymentInput - isEditing:",u,"has onStagePaymentChange:",!!h),(0,N.jsxs)("div",{className:"space-y-4",children:[(0,N.jsxs)(R.Card,{className:"border-blue-200 bg-blue-50",children:[(0,N.jsx)(R.CardHeader,{className:"pb-3",children:(0,N.jsx)(R.CardTitle,{className:"text-sm text-blue-800",children:"Installment Payment Details"})}),(0,N.jsxs)(R.CardContent,{className:"space-y-4",children:[(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"amountPaid",className:"text-sm font-medium",children:"Amount Paid (Current Payment)"}),(0,N.jsx)(V.Input,{id:"amountPaid",type:"text",inputMode:"decimal",value:j,onChange:e=>{let t=e.target.value;v((0,O.formatNumberInput)(t)),r(Math.min((0,O.parseNumberInput)(t),S))},placeholder:"Enter amount paid",disabled:w,className:"text-base"})]}),(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{className:"text-sm font-medium",children:"Payment Date"}),(0,N.jsxs)(_.Popover,{children:[(0,N.jsx)(_.PopoverTrigger,{asChild:!0,children:(0,N.jsxs)(M.Button,{variant:"outline",className:(0,O.cn)("w-full justify-start text-left font-normal",!f&&"text-muted-foreground"),disabled:w,children:[(0,N.jsx)(z.CalendarIcon,{className:"mr-2 h-4 w-4"}),f?(0,$.format)(f,"PPP"):(0,N.jsx)("span",{children:"Pick a date"})]})}),(0,N.jsx)(_.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,N.jsx)(U.Calendar,{mode:"single",selected:f,onSelect:e=>{e&&(b(e),l?.(e))},initialFocus:!0,className:(0,O.cn)("p-3 pointer-events-auto")})})]})]}),(0,N.jsxs)("div",{className:"space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4",children:[(0,N.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,N.jsx)("span",{className:"text-sm text-muted-foreground",children:"Total Amount:"}),(0,N.jsxs)("span",{className:"text-sm font-semibold sm:block",children:[n," ",(0,O.formatNumber)(s)]})]}),(0,N.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,N.jsx)("span",{className:"text-sm text-muted-foreground",children:"Total Paid (History):"}),(0,N.jsxs)("span",{className:"text-sm font-semibold text-green-600 sm:block",children:[n," ",(0,O.formatNumber)(C)]})]})]}),(0,N.jsxs)("div",{className:"space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4",children:[(0,N.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,N.jsx)("span",{className:"text-sm text-muted-foreground",children:"Current Payment:"}),(0,N.jsxs)("span",{className:"text-sm font-semibold text-blue-600 sm:block",children:[n," ",(0,O.formatNumber)(I)]})]}),(0,N.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,N.jsx)("span",{className:"text-sm text-muted-foreground",children:"Amount Due:"}),(0,N.jsxs)("span",{className:"text-sm font-semibold text-red-600 sm:block",children:[n," ",(0,O.formatNumber)(Math.max(0,S-I))]})]})]}),C+I>=s&&I>0&&(0,N.jsx)("div",{className:"text-sm text-green-600 font-medium bg-green-50 p-3 rounded border border-green-200",children:"âœ“ Full payment received - you can manually change status to Paid if needed"}),w&&(0,N.jsx)("div",{className:"text-sm text-green-600 font-medium bg-green-50 p-3 rounded border border-green-200",children:"âœ“ Sale fully paid - you can manually change status to Paid if needed"}),u&&x.length>0&&(0,N.jsxs)("div",{className:"text-sm text-amber-600 font-medium bg-amber-50 p-3 rounded border border-amber-200",children:["â„¹ï¸ ",x.length,' payment change(s) staged. Changes will be saved when you click "Update Sale".']}),u&&0===x.length&&m.length>0&&(0,N.jsx)("div",{className:"text-sm text-blue-600 font-medium bg-blue-50 p-3 rounded border border-blue-200",children:'â„¹ï¸ You can edit payment history. Changes will be saved when you click "Update Sale".'})]})]}),c&&(0,N.jsx)(ev,{payments:m,currency:n,isLoading:!1,pendingChanges:x,isLocalMode:u,onStageChange:h,cashAccounts:p,onLinkToCash:g,onUpdatePayment:y})]})};var eS=e.i(699375);let ew=({linkToCash:e,onLinkToCashChange:t,selectedCashAccountId:a,onCashAccountChange:s,cashAccounts:n,paymentStatus:r})=>"Paid"!==r&&"Installment Sale"!==r?null:(0,N.jsxs)(R.Card,{className:"border-green-200 bg-green-50",children:[(0,N.jsx)(R.CardHeader,{className:"pb-3",children:(0,N.jsx)(R.CardTitle,{className:"text-sm text-green-800",children:"Installment Sale"===r?"Link Partial Payment to Cash Account":"Link to Cash Account"})}),(0,N.jsxs)(R.CardContent,{className:"space-y-4",children:[(0,N.jsxs)("div",{className:"flex items-center justify-between",children:[(0,N.jsxs)("div",{className:"space-y-0.5",children:[(0,N.jsx)(H.Label,{htmlFor:"link-to-cash",children:"Link to Cash Account"}),(0,N.jsx)("div",{className:"text-sm text-muted-foreground",children:"Installment Sale"===r?"Record the partial payment in a cash account":"Record this payment in a cash account"})]}),(0,N.jsx)(eS.Switch,{id:"link-to-cash",checked:e,onCheckedChange:t,"data-cash-account-switch":"true",onKeyDown:t=>{if("Enter"===t.key)if(t.preventDefault(),e){let e=document.querySelector('[data-cash-account-select="true"]');e?.focus()}else{let e=document.querySelector('button[type="submit"]');e?.focus()}}})]}),e&&(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"cash-account",children:"Select Cash Account"}),(0,N.jsxs)(X.Select,{value:a,onValueChange:s,children:[(0,N.jsx)(X.SelectTrigger,{className:"w-full","data-cash-account-select":"true",onKeyDown:e=>{if("Enter"===e.key){e.preventDefault();let t=document.querySelector('button[type="submit"]');t?.focus()}},children:(0,N.jsx)(X.SelectValue,{placeholder:"Select a cash account"})}),(0,N.jsx)(X.SelectContent,{children:n.map(e=>(0,N.jsx)(X.SelectItem,{value:e.id,children:(0,N.jsxs)("div",{className:"flex items-center",children:[(0,N.jsx)("span",{children:e.name}),e.isDefault&&(0,N.jsx)("span",{className:"ml-2 text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded",children:"Default"})]})},e.id))})]}),a&&(0,N.jsx)("div",{className:"text-sm text-muted-foreground",children:"Installment Sale"===r?"The partial payment amount will be recorded in this account":"The full payment amount will be recorded in this account"})]})]})]});var eI=e.i(830999);let eP=({value:e,onChange:t,label:a="Sales Source",placeholder:s="Select category (optional)"})=>{let{categories:n,isLoading:r}=(0,eI.useSalesCategories)();return r?(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{children:a}),(0,N.jsx)(X.Select,{disabled:!0,children:(0,N.jsx)(X.SelectTrigger,{children:(0,N.jsx)(X.SelectValue,{placeholder:"Loading..."})})})]}):(0,N.jsxs)("div",{className:"space-y-2",children:[(0,N.jsx)(H.Label,{children:a}),(0,N.jsxs)(X.Select,{value:e||"none",onValueChange:e=>{t("none"===e?"":e)},children:[(0,N.jsx)(X.SelectTrigger,{children:(0,N.jsx)(X.SelectValue,{placeholder:s})}),(0,N.jsxs)(X.SelectContent,{children:[(0,N.jsx)(X.SelectItem,{value:"none",children:"No source"}),n.map(e=>(0,N.jsx)(X.SelectItem,{value:e.id,children:e.name},e.id))]})]})]})},ek=({paymentStatus:e,onPaymentStatusChange:t,isInstallmentSale:a,amountPaid:s,amountDue:n,grandTotal:r,currency:l,onAmountPaidChange:i,onPaymentDateChange:o,paymentDate:c,saleId:d,onPaymentStatusChangeFromInstallment:u,isEditing:m,payments:x,pendingChanges:h,onStagePaymentChange:p,linkToCash:g,onLinkToCashChange:y,selectedCashAccountId:f,onCashAccountChange:b,cashAccounts:j,hasPaidWithHistory:v,onLinkPaymentToCash:C,onUpdatePayment:S,notes:w="",onNotesChange:I,categoryId:P="",onCategoryChange:k})=>(0,N.jsxs)(R.Card,{className:"mb-6",children:[(0,N.jsx)(R.CardHeader,{children:(0,N.jsx)(R.CardTitle,{children:"Payment Information"})}),(0,N.jsxs)(R.CardContent,{className:"space-y-6",children:[(0,N.jsx)(eg,{paymentStatus:e,onPaymentStatusChange:t}),a&&(0,N.jsx)(eC,{amountPaid:s,amountDue:n,grandTotal:r,currency:l,onAmountPaidChange:i,onPaymentDateChange:o,paymentDate:c,maxAmount:r,saleId:d,onPaymentStatusChange:u,isEditing:m,payments:x,pendingChanges:h,onStagePaymentChange:m?p:void 0,cashAccounts:j,onLinkToCash:C,onUpdatePayment:S}),v&&(0,N.jsxs)(R.Card,{className:"border-green-200 bg-green-50",children:[(0,N.jsx)(R.CardHeader,{className:"pb-3",children:(0,N.jsx)(R.CardTitle,{className:"text-sm text-green-800",children:"Payment History (Sale Completed)"})}),(0,N.jsx)(R.CardContent,{children:(0,N.jsx)(ev,{payments:x,currency:l,isLoading:!1,pendingChanges:h,isLocalMode:m,onStageChange:m?p:void 0,cashAccounts:j,onLinkToCash:C,onUpdatePayment:S})})]}),(0,N.jsx)(ew,{linkToCash:g,onLinkToCashChange:y,selectedCashAccountId:f,onCashAccountChange:b,cashAccounts:j,paymentStatus:e}),k&&(0,N.jsx)(eP,{value:P,onChange:k}),(0,N.jsxs)("div",{className:"grid gap-3",children:[(0,N.jsx)(H.Label,{htmlFor:"saleNotes",children:"Notes"}),(0,N.jsx)(V.Input,{id:"saleNotes",name:"notes",value:w,onChange:I,placeholder:"Order notes (will appear on receipt)"})]})]})]});var eD=e.i(257428),eT=e.i(531278),eA=e.i(686311),eE=e.i(303281);let eB=({loading:e,isEditing:s,onCancel:n,onClearForm:l,printAfterSave:i,onPrintAfterSaveChange:o,thermalPrintAfterSave:c=!1,onThermalPrintAfterSaveChange:d,paymentStatus:u,includePaymentInfo:m,onIncludePaymentInfoChange:x,hasPendingPaymentChanges:h=!1,sendSMS:y=!1,onSendSMSChange:f,smsMessage:b="",onSMSMessageChange:j,customerName:v="",customerHasPhone:C=!1,disabled:S=!1})=>{let{user:w}=(0,r.useAuth)(),I=w?.id,{currentBusiness:P}=(0,a.useBusiness)(),{settings:k}=(0,g.useBusinessSettings)(),[D,T]=(0,t.useState)(!1),{templates:A=[],isLoading:B}=(0,E.useMessages)(I),[L,F]=(0,t.useState)("");(0,t.useEffect)(()=>{(async()=>{T(await (0,p.checkBridgeStatus)())})()},[]);let q="Thank you for your purchase from {business_name} We truly appreciate your support and trust in our Business. If you need any assistance or have any questions about your order, please feel free to reach out, on {business_number} We look forward to servingÂ youÂ again!",$=(e,t)=>{let a=e;return t&&(a=a.replace(/\{customer_name\}/gi,t).replace(/\{first_name\}/gi,t.split(" ")[0]||"").replace(/\{last_name\}/gi,t.split(" ").slice(1).join(" ")||"")),a=a.replace(/\{business_name\}/gi,P?.name||"[Business Name]").replace(/\{business_number\}/gi,k.businessPhone||"[Business Number]")},z=(0,t.useMemo)(()=>A.filter(e=>e.category&&"ThankYou"===String(e.category).trim()),[A]);(0,t.useEffect)(()=>{if(!y||!j)return;let e=q;if("default"===L)e=q;else if(L&&z.length>0){let t=z.find(e=>e.id===L);t&&(e=t.content)}else L||F("default");j($(e,v))},[y,v,z,L,j]);let U=b.length,_=Math.ceil(U/160)||1;return(0,N.jsxs)("div",{className:"space-y-4",children:[(0,N.jsx)(R.Card,{className:"border-gray-200",children:(0,N.jsxs)(R.CardContent,{className:"pt-6 space-y-4",children:[(0,N.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,N.jsx)(eD.Checkbox,{id:"printAfterSave",checked:i,onCheckedChange:o}),(0,N.jsxs)(H.Label,{className:"text-sm",children:["Show receipt after ",s?"updating":"creating"," sale"]})]}),D&&d&&(0,N.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,N.jsx)(eD.Checkbox,{id:"thermalPrintAfterSave",checked:c,onCheckedChange:d}),(0,N.jsxs)(H.Label,{className:"text-sm flex items-center gap-1.5 text-green-700 font-medium",children:[(0,N.jsx)(eE.Printer,{className:"w-3.5 h-3.5"}),"Auto-print (Thermal Bridge)"]})]}),("Paid"===u||"Installment Sale"===u)&&(0,N.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,N.jsx)(eD.Checkbox,{id:"includePaymentInfo",checked:m,onCheckedChange:x}),(0,N.jsx)(H.Label,{className:"text-sm",children:"Include payment information in receipt"})]})]})}),f&&j&&(0,N.jsx)(R.Card,{className:`border-blue-200 ${y?"bg-blue-50/50":"bg-gray-50"}`,children:(0,N.jsxs)(R.CardContent,{className:"pt-6 space-y-4",children:[(0,N.jsxs)("div",{className:"flex items-start space-x-3",children:[(0,N.jsx)(eD.Checkbox,{id:"sendSMS",checked:y,onCheckedChange:f,disabled:!C}),(0,N.jsxs)("div",{className:"flex-1",children:[(0,N.jsxs)(H.Label,{className:"text-base font-medium flex items-center gap-2",children:[(0,N.jsx)(eA.MessageSquare,{className:"w-5 h-5 text-blue-600"}),"Send Thank You SMS"]}),!C&&(0,N.jsx)("p",{className:"text-xs text-amber-600 mt-1",children:"Customer phone number required to send SMS"})]})]}),y&&C&&(0,N.jsxs)("div",{className:"space-y-4 pl-8 border-l-4 border-blue-300 bg-blue-50/30 -m-4 p-4 rounded-r-lg",children:[(0,N.jsxs)("div",{children:[(0,N.jsx)(H.Label,{className:"text-sm font-medium",children:"Template"}),B?(0,N.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-2 mt-1",children:[(0,N.jsx)(eT.Loader2,{className:"w-4 h-4 animate-spin"}),"Loading templates..."]}):(0,N.jsxs)(X.Select,{value:L||"default",onValueChange:e=>{F(e);let t=q;if("default"===e)t=q;else{let a=z.find(t=>t.id===e);a&&(t=a.content)}let a=$(t,v);j?.(a)},children:[(0,N.jsx)(X.SelectTrigger,{className:"mt-1",children:(0,N.jsx)(X.SelectValue,{placeholder:"Choose a thank you template..."})}),(0,N.jsxs)(X.SelectContent,{children:[(0,N.jsx)(X.SelectItem,{value:"default",children:"Default Template"}),z.map(e=>(0,N.jsx)(X.SelectItem,{value:e.id,children:e.name},e.id))]})]})]}),(0,N.jsxs)("div",{children:[(0,N.jsx)(H.Label,{className:"text-sm font-medium",children:"Message"}),(0,N.jsx)(Z.Textarea,{value:b,onChange:e=>j?.(e.target.value),placeholder:"Your message will appear here...",rows:4,className:"mt-1 resize-none text-sm font-medium"}),(0,N.jsxs)("div",{className:"flex justify-between items-center mt-2 text-xs text-gray-600",children:[(0,N.jsxs)("span",{children:[U," characters"]}),(0,N.jsxs)("span",{className:"font-semibold text-blue-600",children:[_," SMS credit",_>1?"s":""," will be used"]})]})]})]})]})}),h&&(0,N.jsx)("div",{className:"text-sm text-amber-600 bg-amber-50 p-3 rounded border border-amber-200",children:"Pending payment changes will be applied when updating."}),(0,N.jsxs)("div",{className:"flex gap-4 pt-4",children:[(0,N.jsx)(M.Button,{type:"button",variant:"outline",onClick:n,disabled:e,className:"flex-1",children:"Cancel"}),!s&&l&&(0,N.jsx)(M.Button,{type:"button",variant:"outline",onClick:l,disabled:e,className:"flex-1",children:"Clear Form"}),(0,N.jsx)(M.Button,{type:"submit",disabled:e||S,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:e?(0,N.jsxs)(N.Fragment,{children:[(0,N.jsx)(eT.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),s?"Updating...":"Creating..."]}):s?"Update Sale":"Create Sale"})]})]})},eL=({initialData:e,onSaleComplete:l,currency:i="USD",customers:o=[],onAddNewCustomer:c,draftData:d,onClearDraft:x})=>{let h=(0,n.useRouter)();(0,n.useSearchParams)();let[p,y]=(0,t.useState)(!1),[f,b]=(0,t.useState)(e?.date||new Date),j=e?.paymentStatus||"Paid",{settings:R}=(0,g.useBusinessSettings)(),{user:M}=(0,r.useAuth)(),{updateInventoryForSale:F,updateInventoryForEditedSale:q}=u(M?.id),{accounts:$}=(0,w.useCashAccounts)(),{currentBusiness:z}=(0,a.useBusiness)();(0,t.useEffect)(()=>{e&&(console.log("SalesForm initialData:",e),console.log("SalesForm initialData.categoryId:",e.categoryId),console.log("SalesForm initialData.notes:",e.notes))},[e]);let{saveDraft:U}=s(),{updateStockHistoryDatesBySaleId:_}=(0,A.useStockHistory)(M?.id),H=(0,t.useRef)(),O=(0,t.useRef)(!1),[K,V]=(0,t.useState)(!1),{createMessage:Q,templates:X=[]}=(0,E.useMessages)(M?.id),[W,Y]=(0,t.useState)(null),[J,Z]=(0,t.useState)(!0),[ee,et]=(0,t.useState)("Thank you for your purchase from {business_name} We truly appreciate your support and trust in our Business. If you need any assistance or have any questions about your order, please feel free to reach out, on {business_number} We look forward to servingÂ youÂ again!"),{formData:ea,errors:es,taxRateInput:en,printAfterSave:er,thermalPrintAfterSave:el,includePaymentInfo:ei,selectedCustomerCategoryId:eo,paymentDate:ec,linkToCash:ed,selectedCashAccountId:eu,cashTransactionId:em,originalPaymentStatus:ex,formRecentlyCleared:eh,payments:eg,pendingChanges:ey,hasChanges:ef,setFormData:eb,setTaxRateInput:ej,setPrintAfterSave:eN,setThermalPrintAfterSave:ev,setIncludePaymentInfo:eC,setLinkToCash:eS,setSelectedCashAccountId:ew,setCashTransactionId:eI,setOriginalPaymentStatus:eP,handleChange:eD,handleSelectChange:eT,handleAddItem:eA,handleUpdateItem:eE,handleRemoveItem:eL,handleSelectCustomer:eR,handleCategoryChange:eM,handleSalesCategoryChange:eF,handleAmountPaidChange:eq,handlePaymentDateChange:e$,calculateTotalAmount:ez,calculateTaxAmount:eU,validateForm:e_,processPendingPaymentChanges:eH,createInstallmentPayment:eO,updateInstallmentPayment:eK,deleteInstallmentPayment:eV,addPaymentChange:eQ,clearChanges:eX,getModifiedPayments:eW,clearForm:eY}=(({initialData:e,defaultPaymentStatus:a,cashAccounts:s})=>{let{formData:n,errors:r,taxRateInput:l,printAfterSave:i,thermalPrintAfterSave:o,includePaymentInfo:c,selectedCustomerCategoryId:d,paymentDate:u,linkToCash:m,selectedCashAccountId:x,cashTransactionId:h,originalPaymentStatus:p,formRecentlyCleared:g,setFormData:y,setErrors:f,setTaxRateInput:b,setPrintAfterSave:j,setThermalPrintAfterSave:N,setIncludePaymentInfo:v,setSelectedCustomerCategoryId:C,setPaymentDate:S,setLinkToCash:w,setSelectedCashAccountId:D,setCashTransactionId:T,setOriginalPaymentStatus:A,setFormRecentlyCleared:E,clearFormState:B}=(({initialData:e,defaultPaymentStatus:a})=>{let[s,n]=(0,t.useState)({customerName:e?.customerName||"",customerAddress:e?.customerAddress||"",customerContact:e?.customerContact||"",customerId:e?.customerId||"",items:e?.items||[{...I}],paymentStatus:a,taxRate:e?.taxRate||0,amountPaid:e&&"Installment Sale"===e.paymentStatus?0:e?.amountPaid||0,amountDue:e?.amountDue||0,notes:e?.notes||"",categoryId:e?.categoryId||""}),[r,l]=(0,t.useState)({}),[i,o]=(0,t.useState)(e?.taxRate?e.taxRate.toString():""),[c,d]=(0,t.useState)(!0),[u,m]=(0,t.useState)(!1),[x,h]=(0,t.useState)(!0),[p,g]=(0,t.useState)(""),[y,f]=(0,t.useState)(new Date),[b,j]=(0,t.useState)(!1),[N,v]=(0,t.useState)(""),[C,S]=(0,t.useState)(null),[w,P]=(0,t.useState)(a),[k,D]=(0,t.useState)(!1),T=(0,t.useCallback)(e=>{n({customerName:"",customerAddress:"",customerContact:"",customerId:"",items:[{...I}],paymentStatus:a,taxRate:0,amountPaid:0,amountDue:0,notes:"",categoryId:""}),o(""),g(""),f(new Date),j(!1),l({}),D(!0),e&&e()},[a]);return(0,t.useEffect)(()=>{e&&(n(t=>({...t,customerName:e.customerName||t.customerName,customerAddress:e.customerAddress||t.customerAddress,customerContact:e.customerContact||t.customerContact,customerId:e.customerId||t.customerId,items:e.items&&e.items.length>0?e.items:t.items,paymentStatus:e.paymentStatus||t.paymentStatus,taxRate:void 0!==e.taxRate?e.taxRate:t.taxRate,amountPaid:void 0!==e.amountPaid?e.amountPaid:t.amountPaid,amountDue:void 0!==e.amountDue?e.amountDue:t.amountDue,notes:e.notes||t.notes,categoryId:e.categoryId||t.categoryId})),e.categoryId&&D(!1),void 0!==e.taxRate&&o(e.taxRate.toString()))},[e]),{formData:s,errors:r,taxRateInput:i,printAfterSave:c,thermalPrintAfterSave:u,includePaymentInfo:x,selectedCustomerCategoryId:p,paymentDate:y,linkToCash:b,selectedCashAccountId:N,cashTransactionId:C,originalPaymentStatus:w,formRecentlyCleared:k,setFormData:n,setErrors:l,setTaxRateInput:o,setPrintAfterSave:d,setThermalPrintAfterSave:m,setIncludePaymentInfo:h,setSelectedCustomerCategoryId:g,setPaymentDate:f,setLinkToCash:j,setSelectedCashAccountId:v,setCashTransactionId:S,setOriginalPaymentStatus:P,setFormRecentlyCleared:D,clearFormState:T}})({initialData:e,defaultPaymentStatus:a}),{handleChange:L,handleSelectChange:R,handleAmountPaidChange:M,handlePaymentDateChange:F}=(({formData:e,setFormData:a,errors:s,setErrors:n,setTaxRateInput:r,setLinkToCash:l})=>{let i=(0,t.useCallback)(e=>{let{name:t,value:l}=e.target;if("taxRate"===t){r(l);let e=l.replace(/,/g,""),t=""===e?0:parseFloat(e);a(e=>({...e,taxRate:isNaN(t)?0:t}))}else a(e=>({...e,[t]:l}));s[t]&&n(e=>({...e,[t]:void 0}))},[s,a,n,r]),o=(0,t.useCallback)(e=>{a(t=>({...t,paymentStatus:e})),"Paid"!==e&&"Installment Sale"!==e&&l(!1),"Installment Sale"!==e&&a(t=>({...t,paymentStatus:e,amountPaid:0,amountDue:0}))},[a,l]);return{handleChange:i,handleSelectChange:o,handleAmountPaidChange:(0,t.useCallback)((e,t)=>{let s=Math.max(0,t-e);a(t=>({...t,amountPaid:e,amountDue:s}))},[a]),handlePaymentDateChange:(0,t.useCallback)(e=>{},[])}})({formData:n,setFormData:y,errors:r,setErrors:f,setTaxRateInput:b,setLinkToCash:w}),{handleAddItem:q,handleAddItemWithProduct:$,handleUpdateItem:z,handleRemoveItem:U}=(({formData:e,setFormData:a})=>{let s=(0,t.useCallback)(()=>{a(e=>({...e,items:[...e.items,{...P}]}))},[a]),n=(0,t.useCallback)(e=>{a(t=>{let a=t.items.findIndex(t=>t.productId===e.id);if(-1!==a){let e=[...t.items];return e[a]={...e[a],quantity:e[a].quantity+1},{...t,items:e}}let s={productId:e.id,description:e.name,quantity:1,price:e.sellingPrice,cost:e.costPrice};return 1!==t.items.length||t.items[0].description||t.items[0].productId?{...t,items:[...t.items,s]}:{...t,items:[s]}})},[a]);return{handleAddItem:s,handleAddItemWithProduct:n,handleUpdateItem:(0,t.useCallback)((e,t)=>{a(a=>{if(t.productId){let s=a.items.findIndex((a,s)=>s!==e&&a.productId===t.productId);if(-1!==s){let n=[...a.items],r=n[s];return n[s]={...r,quantity:r.quantity+t.quantity},n.length>1?n.splice(e,1):n[e]={...P},{...a,items:n}}}let s=[...a.items];return s[e]=t,{...a,items:s}})},[a]),handleRemoveItem:(0,t.useCallback)(e=>{a(t=>{if(1===t.items.length)return t;let a=t.items.filter((t,a)=>a!==e);return{...t,items:a}})},[a])}})({formData:n,setFormData:y}),{handleSelectCustomer:_,handleCategoryChange:H}=(({setFormData:e,setSelectedCustomerCategoryId:a})=>({handleSelectCustomer:(0,t.useCallback)(t=>{e(e=>({...e,customerName:t.fullName,customerAddress:t.location||"",customerContact:t.phoneNumber||"",customerId:t.id})),a(t.categoryId||"")},[e,a]),handleCategoryChange:(0,t.useCallback)(e=>{a(e)},[a])}))({setFormData:y,setSelectedCustomerCategoryId:C}),{validateForm:O}=(({formData:e,linkToCash:a,selectedCashAccountId:s,initialData:n,formRecentlyCleared:r,setErrors:l})=>({validateForm:(0,t.useCallback)((t,r)=>{let i={};return e.customerName.trim()||(i.customerName="Customer name is required"),e.taxRate<0&&(i.taxRate="Tax rate cannot be negative"),e.items.filter(e=>""!==e.description.trim()||e.quantity>0||e.price>0).some(e=>!e.description.trim()||e.quantity<=0||e.price<0||e.cost<0)&&(i.items="All items must have a description, positive quantity, and non-negative price/cost"),a&&("Paid"===e.paymentStatus||"Installment Sale"===e.paymentStatus)&&!s&&(i.cashAccount="Select a cash account when linking payments"),"Installment Sale"===e.paymentStatus&&!n&&((!e.amountPaid||e.amountPaid<=0)&&(i.amountPaid="Enter an initial payment greater than 0"),e.amountPaid&&e.amountPaid>t&&(i.amountPaid="Amount paid cannot exceed total")),"Installment Sale"===e.paymentStatus&&n&&e.amountPaid&&e.amountPaid>t&&(i.amountPaid="Amount paid cannot exceed total"),l(i),0===Object.keys(i).length},[e,a,s,n,r,l])}))({formData:n,linkToCash:m,selectedCashAccountId:x,initialData:e,formRecentlyCleared:g,setErrors:f}),{calculateTotalAmount:K,calculateTaxAmount:V}=(({taxRate:e})=>({calculateTotalAmount:(0,t.useCallback)(e=>e.reduce((e,t)=>{let a=t.price*t.quantity,s="amount"===t.discountType?t.discountAmount||0:a*(t.discountPercentage||0)/100;return e+(a-s)},0),[]),calculateTaxAmount:(0,t.useCallback)(t=>e/100*t,[e])}))({taxRate:n.taxRate}),{payments:Q,pendingChanges:X,hasChanges:W,createInstallmentPayment:Y,updateInstallmentPayment:G,deleteInstallmentPayment:J,addPaymentChange:Z,clearChanges:ee,getModifiedPayments:et,processPendingPaymentChanges:ea}=(({initialDataId:e})=>{let{payments:a,createPayment:s,updatePayment:n,deletePayment:r}=(0,k.useInstallmentPayments)(e),{pendingChanges:l,addPaymentChange:i,clearChanges:o,getModifiedPayments:c,hasChanges:d}=(()=>{let[e,a]=(0,t.useState)([]),s=e.length>0;return{pendingChanges:e,addPaymentChange:e=>{a(t=>[...t.filter(t=>t.id!==e.id),e])},removePaymentChange:e=>{a(t=>t.filter(t=>t.id!==e))},clearChanges:()=>{a([])},getModifiedPayments:t=>t.filter(t=>!e.find(e=>e.id===t.id&&"delete"===e.type)).map(t=>{let a=e.find(e=>e.id===t.id&&"update"===e.type);return a&&a.updatedData?{...t,amount:a.updatedData.amount??t.amount,notes:a.updatedData.notes??t.notes,paymentDate:a.updatedData.paymentDate??t.paymentDate}:t}),hasChanges:s}})(),u=(0,t.useCallback)(async()=>{for(let e of l)"update"===e.type?await n(e.id,e.updatedData):"delete"===e.type&&await r(e.id);o()},[l,n,r,o]);return{payments:a,pendingChanges:l,hasChanges:d,createInstallmentPayment:s,updateInstallmentPayment:n,deleteInstallmentPayment:r,addPaymentChange:i,clearChanges:o,getModifiedPayments:c,processPendingPaymentChanges:u}})({initialDataId:e?.id}),es=(0,t.useCallback)(e=>{S(e)},[S]),en=(0,t.useCallback)((e,t)=>{B(e),ee(),t&&t()},[B,ee]),er=(0,t.useCallback)(e=>{g&&E(!1),L(e)},[g,E,L]),el=(0,t.useCallback)(e=>{g&&E(!1),R(e)},[g,E,R]),ei=(0,t.useCallback)(e=>{g&&E(!1);let t=e&&(e.nativeEvent||e.preventDefault||e.stopPropagation||e.type&&e.target);e&&!t?$(e):q()},[g,E,q,$]),eo=(0,t.useCallback)((e,t)=>{g&&E(!1),z(e,t)},[g,E,z]),ec=(0,t.useCallback)(e=>{g&&E(!1),U(e)},[g,E,U]),ed=(0,t.useCallback)(e=>{g&&E(!1),_(e)},[g,E,_]),eu=(0,t.useCallback)(e=>{g&&E(!1),H(e)},[g,E,H]),em=(0,t.useCallback)(e=>{g&&E(!1),y(t=>({...t,categoryId:e}))},[g,E,y]);return{formData:n,errors:r,taxRateInput:l,printAfterSave:i,thermalPrintAfterSave:o,includePaymentInfo:c,selectedCustomerCategoryId:d,paymentDate:u,linkToCash:m,selectedCashAccountId:x,cashTransactionId:h,originalPaymentStatus:p,formRecentlyCleared:g,payments:Q,pendingChanges:X,hasChanges:W,setFormData:y,setTaxRateInput:b,setPrintAfterSave:j,setThermalPrintAfterSave:N,setIncludePaymentInfo:v,setLinkToCash:w,setSelectedCashAccountId:D,setCashTransactionId:T,setOriginalPaymentStatus:A,handleChange:er,handleSelectChange:el,handleAddItem:ei,handleUpdateItem:eo,handleRemoveItem:ec,handleSelectCustomer:ed,handleCategoryChange:eu,handleSalesCategoryChange:em,handleAmountPaidChange:M,handlePaymentDateChange:es,clearForm:en,calculateTotalAmount:K,calculateTaxAmount:V,validateForm:O,processPendingPaymentChanges:ea,createInstallmentPayment:Y,updateInstallmentPayment:G,deleteInstallmentPayment:J,addPaymentChange:Z,clearChanges:ee,getModifiedPayments:et}})({initialData:e,defaultPaymentStatus:j,cashAccounts:$}),{createCashTransactionForSale:eG,updateCashTransactionForSale:eJ,createInstallmentPaymentWithCash:eZ,findCashTransactionForSale:e0}=(()=>{let{createTransaction:e,updateTransaction:a,deleteTransaction:s}=(0,D.useCashTransactions)(),n=(0,t.useCallback)(async(t,a,s,n,r,l)=>{if(!s||!n||"Paid"!==l)return null;try{let s=`Sale to ${t.customerName||t.customer_name||"Customer"} - Receipt #${t.receiptNumber||t.receipt_number||"N/A"}`,l=await e({accountId:n,amount:a,transactionType:"cash_in",category:"Cash sale",description:s,date:r,personInCharge:"",tags:[],paymentMethod:"",receiptImage:""});return l?.id||null}catch(e){return console.error("Error creating cash transaction:",e),m.toast.error("Failed to create cash transaction"),null}},[e]),r=(0,t.useCallback)(async(t,n,r,l,i,o,c,d)=>{try{let u=`Sale to ${t.customerName||t.customer_name||"Customer"} - Receipt #${t.receiptNumber||t.receipt_number||"N/A"}`,m=c&&""!==c.trim();if(!r&&o&&"Paid"===i&&m){let t=await e({accountId:c,amount:n,transactionType:"cash_in",category:"Cash sale",description:u,date:d,personInCharge:"",tags:[],paymentMethod:"",receiptImage:""});return t?.id||null}if(!r)return null;if("Paid"===l&&"Installment Sale"===i)return await s(r),null;if(o&&"Paid"===i&&m)return await a(r,{amount:n,category:"Cash sale",description:u,date:d}),r;return await s(r),null}catch(e){return console.error("Error updating cash transaction:",e),m.toast.error("Failed to update cash transaction"),r}},[e,a,s]);return{createCashTransactionForSale:n,updateCashTransactionForSale:r,createInstallmentPaymentWithCash:(0,t.useCallback)(async(e,t,a,s,n,r,l)=>t<=0?null:s&&n?await l({saleId:e,amount:t,accountId:n,locationId:r,date:new Date}):await l({saleId:e,amount:t}),[]),findCashTransactionForSale:(0,t.useCallback)(async e=>{try{let t=await T(e);if(t.success&&t.data)return t.data.accountId}catch(e){console.error("Error finding cash transaction:",e)}return null},[])}})(),{payments:e1,linkPaymentToCashAccount:e2,unlinkPaymentFromCashAccount:e3,updatePayment:e6}=(0,k.useInstallmentPayments)(e?.id),e4=async(e,t)=>{await e6(e,t)},[e5,e7]=(0,t.useState)(!1),e8=()=>{O.current=!0,eY&&eY(()=>b(new Date),x)};(0,t.useEffect)(()=>{O.current=!1});let e9=t.default.useCallback(()=>{!O.current&&!e&&!p&&!e5&&!eh&&(ea.customerName.trim()||ea.customerAddress.trim()||ea.customerContact.trim()||ea.items.some(e=>e.description.trim()||1!==e.quantity||0!==e.price))&&U(ea,f)},[ea,f,e,p,U,e5,eh]);(0,t.useEffect)(()=>(H.current&&clearTimeout(H.current),H.current=setTimeout(e9,2e3),()=>{H.current&&clearTimeout(H.current),e9()}),[e9]),(0,t.useEffect)(()=>{let e=()=>e9(),t=()=>document.hidden&&e9();return window.addEventListener("beforeunload",e),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("beforeunload",e),document.removeEventListener("visibilitychange",t)}},[e9]),(0,t.useEffect)(()=>{d&&!e&&(eb(d.formData),b(d.selectedDate),ej(d.formData.taxRate?.toString()||""))},[d,e,eb,ej]),(0,t.useEffect)(()=>{(async()=>{if(e?.cashTransactionId){eS(!0),eI(e.cashTransactionId);let t=await e0(e.cashTransactionId);t&&ew(t)}!($.length>0)||eu||e?.cashTransactionId||ew(($.find(e=>e.isDefault)||$[0]).id)})()},[e,$,e0,ew]);let te=async t=>{t.preventDefault();let a=ez(ea.items),s=eU(a),n=a+s;if(!e_(n,f))return void(es.customerName?m.toast.error(es.customerName):es.taxRate?m.toast.error(es.taxRate):m.toast.error("Please fill in all required fields correctly"));if(0===ea.items.length||ea.items.every(e=>!e.description.trim()))return void m.toast.error("Please add at least one valid item");y(!0);try{let t=e?.receiptNumber||await (0,C.generateReceiptNumber)(z?.id||""),a=ea.items.reduce((e,t)=>{let a=t.price*t.quantity,s="amount"===t.discountType?t.discountAmount||0:a*(t.discountPercentage||0)/100,n=t.cost*t.quantity;return e+(a-s-n)},0),s=em;e&&(s=await eJ({id:e.id,customerName:ea.customerName,receiptNumber:e.receiptNumber,items:ea.items},n,em,ex,ea.paymentStatus,ed,eu,f),eI(s));let r=(0,v.mapSaleToDbSale)(ea,f,a,t,M?.id||"",z?.id||"",s),{success:i,data:c,error:u}=await L(r,!!e,e?.id);if(!i||!c)throw Error(u||"Failed to save sale");let p={id:c.id,receiptNumber:c.receiptNumber,customerName:c.customerName,customerAddress:c.customerAddress||"",customerContact:c.customerContact||"",customerId:c.customerId||void 0,items:c.items,paymentStatus:c.paymentStatus,profit:c.profit,date:new Date(c.date),taxRate:c.taxRate?Number(c.taxRate):0,cashTransactionId:c.cashTransactionId||void 0,amountPaid:c.amountPaid?Number(c.amountPaid):void 0,amountDue:c.amountDue?Number(c.amountDue):void 0,notes:c.notes||"",categoryId:c.categoryId||void 0,createdAt:new Date(c.createdAt)};if(e)ef&&await eH(),"Installment Sale"===ea.paymentStatus&&ea.amountPaid&&(await eO({saleId:p.id,amount:ea.amountPaid,notes:p.items.map(e=>e.description).join(", "),paymentDate:ec,accountId:ed?eu:void 0,locationId:z?.id}),eb(e=>({...e,amountPaid:0}))),e.date.getTime()!==f.getTime()&&await _(p.id,f);else{let e=await eG(p,n,ed,eu,f,ea.paymentStatus);e&&(await (0,S.updateSaleCashTransactionAction)(p.id,e),p.cashTransactionId=e),"Installment Sale"===ea.paymentStatus&&ea.amountPaid&&await eZ(p.id,ea.amountPaid,p.items.map(e=>e.description).join(", "),ed,eu,z?.id||"",eO)}if(d&&x&&x(),l&&await l(p,er,ei,eo,void 0,f,el),m.toast.success(e?"Sale updated successfully!":"Sale recorded successfully!"),J&&ea.customerContact&&!e){let e=ea.items.map(e=>`â€¢ ${e.description} (Qty: ${e.quantity})`).join("\r\n"),t=ee.replace(/\{customer_name\}/gi,ea.customerName||"Valued Customer").replace(/\{receipt_number\}/gi,p.receiptNumber).replace(/\{items_list\}/gi,e).replace(/\{currency\}/gi,R.currency||"UGX").replace(/\{amount\}/gi,n.toLocaleString()).replace(/\{business_contact\}/gi,R.businessPhone||"our office").replace(/\{business_name\}/gi,z?.name||"Our Business");try{await Q({phoneNumber:ea.customerContact,content:t,customerId:o.find(e=>e.phoneNumber===ea.customerContact)?.id,metadata:{sale_id:p.id,receipt_number:p.receiptNumber,type:"thank_you"}}),m.toast.success("Thank you SMS sent successfully!")}catch(e){m.toast.error("Sale saved, but failed to send SMS: "+e.message)}}e7(!0),V(!0),e7(!0),V(!0),l||h.push("/sales")}catch(e){console.error("Error submitting sale:",e),V(!1),m.toast.error(e.message||"An error occurred. Please try again.")}finally{y(!1)}},tt=(0,t.useMemo)(()=>ez(ea.items),[ea.items]),ta=(0,t.useMemo)(()=>eU(tt),[tt,ea.taxRate]),ts=(0,t.useMemo)(()=>tt+ta,[tt,ta]),{data:tn=[]}=(0,B.useQuery)({queryKey:["all-products-for-scanner",M?.id,z?.id],queryFn:async()=>M?.id&&z?.id?(await (0,S.getProductsForBarcodeScannerAction)(z.id)||[]).map(v.mapDbProductToProduct):[],enabled:!!M?.id&&!!z?.id,staleTime:3e5}),tr=(0,t.useRef)(""),tl=(0,t.useRef)(Date.now());return(0,t.useEffect)(()=>{let e=e=>{let t=e.target,a=Date.now(),s=a-tl.current;if(tl.current=a,"Shift"===e.key||"Control"===e.key||"Alt"===e.key||"Meta"===e.key)return;let n=/^[a-zA-Z0-9\-_]$/.test(e.key),r="INPUT"===t.tagName||"TEXTAREA"===t.tagName||"true"===t.contentEditable;if(!r&&n&&(e.preventDefault(),e.stopPropagation()),"Enter"===e.key){let t=tr.current.trim();if(t.length>=2){e.preventDefault(),e.stopPropagation(),console.log(`[Scanner] Processing: "${t}"`);let a=async e=>{let t=await (0,S.lookupProductByBarcodeAction)(e,z?.id||"");return t?(0,v.mapDbProductToProduct)(t):null};(async()=>{let e=await a(t);if(e){let a=e.barcode||e.itemNumber||t;console.log(`[Scanner] âœ… Server Match: ${e.name}`),console.log(`[Scanner] ðŸ”— Mapping "${t}" -> System Code "${a}"`),eA(e),m.toast.success(`Scanned: ${e.name} (${a})`)}else console.warn(`[Scanner] âŒ No server match for: "${t}"`)})(),tr.current="";return}tr.current="",e.preventDefault(),e.stopPropagation();return}1===e.key.length&&(s<60&&r&&n&&(e.preventDefault(),e.stopPropagation()),s>100?tr.current=e.key:tr.current+=e.key)};return window.addEventListener("keydown",e,!0),()=>window.removeEventListener("keydown",e,!0)},[M?.id,z?.id]),(0,N.jsxs)("form",{onSubmit:te,className:"space-y-6",children:[(0,N.jsx)(G,{isEditing:!!e,selectedDate:f,onDateChange:b,customerName:ea.customerName,customerAddress:ea.customerAddress,customerContact:ea.customerContact,notes:ea.notes,onCustomerInfoChange:eD,errors:es,customers:o,onAddNewCustomer:c,onSelectCustomer:eR,selectedCategoryId:eo,onCategoryChange:eM,onClearForm:e?void 0:e8}),(0,N.jsx)(ep,{items:ea.items,onAddItem:eA,onUpdateItem:eE,onRemoveItem:eL,taxRateInput:en,onTaxRateChange:eD,errors:es,totalAmount:tt,taxAmount:ta,grandTotal:ts,taxRate:ea.taxRate||0,currency:R.currency,saleDate:f.toISOString()}),(0,N.jsx)(ek,{paymentStatus:ea.paymentStatus,onPaymentStatusChange:eT,isInstallmentSale:"Installment Sale"===ea.paymentStatus,amountPaid:ea.amountPaid||0,amountDue:ea.amountDue||0,grandTotal:ts,currency:R.currency,onAmountPaidChange:e=>eq(e,ts),onPaymentDateChange:e$,paymentDate:ec,saleId:e?.id,isEditing:!!e,payments:eW(eg),pendingChanges:ey,onStagePaymentChange:e?eQ:void 0,linkToCash:ed,onLinkToCashChange:eS,selectedCashAccountId:eu,onCashAccountChange:ew,cashAccounts:$,hasPaidWithHistory:"Paid"===ea.paymentStatus&&eg.length>0,onLinkPaymentToCash:(e,t)=>e2(e,t,z?.id||""),onUpdatePayment:e4,onPaymentStatusChangeFromInstallment:async e=>eT(e),notes:ea.notes,onNotesChange:eD,categoryId:ea.categoryId||"",onCategoryChange:eF}),(0,N.jsx)(eB,{loading:p,isEditing:!!e,onCancel:()=>h.push("/sales"),onClearForm:e?void 0:e8,printAfterSave:er,onPrintAfterSaveChange:eN,thermalPrintAfterSave:el,onThermalPrintAfterSaveChange:ev,paymentStatus:ea.paymentStatus,includePaymentInfo:ei,onIncludePaymentInfoChange:eC,hasPendingPaymentChanges:ef,sendSMS:J,onSendSMSChange:Z,smsMessage:ee,onSMSMessageChange:et,customerHasPhone:!!ea.customerContact,customerName:ea.customerName,disabled:K})]})};var eR=e.i(11381),eM=e.i(639054),eF=e.i(929592),eq=e.i(178583);let e$=({onLoadDraft:e,onDismiss:t,savedAt:a})=>(0,N.jsxs)(eF.Alert,{className:"mb-4 border-blue-200 bg-blue-50",children:[(0,N.jsx)(eq.FileText,{className:"h-4 w-4 text-blue-600"}),(0,N.jsxs)(eF.AlertDescription,{className:"flex items-center justify-between",children:[(0,N.jsxs)("div",{className:"flex-1",children:[(0,N.jsx)("span",{className:"text-blue-800 font-medium",children:"Draft found!"}),(0,N.jsxs)("span",{className:"text-blue-700 ml-2",children:["Saved on ",a.toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]}),(0,N.jsxs)("div",{className:"flex gap-2 ml-4",children:[(0,N.jsx)(M.Button,{size:"sm",onClick:e,className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Load Draft"}),(0,N.jsx)(M.Button,{size:"sm",variant:"ghost",onClick:t,className:"text-blue-600 hover:text-blue-700 hover:bg-blue-100",children:(0,N.jsx)(eb.X,{className:"h-4 w-4"})})]})]})]});e.s(["default",0,({editSale:e,currency:t,showDraftNotification:a,draftData:s,onLoadDraft:n,onDismissDraft:r,onSaleComplete:l,onClearDraft:i,customers:o,onAddNewCustomer:c,isReceiptOpen:d,completedSale:u,includePaymentInfo:m,onReceiptClose:x,newCustomerDialogOpen:h,onCloseNewCustomerDialog:p,onAddCustomer:g})=>(0,N.jsxs)(N.Fragment,{children:[a&&s&&(0,N.jsx)(e$,{onLoadDraft:n,onDismiss:r,savedAt:s.savedAt}),(0,N.jsx)(eL,{initialData:e,onSaleComplete:l,currency:t,customers:o,onAddNewCustomer:c,draftData:s,onClearDraft:i}),(0,N.jsx)(eR.default,{isOpen:d,sale:u,currency:t,onOpenChange:x,includePaymentInfo:m}),(0,N.jsx)(eM.default,{open:h,onClose:p,onAddCustomer:g})]})],630680)}]);