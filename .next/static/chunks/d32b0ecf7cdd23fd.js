(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,924432,e=>{"use strict";var t=e.i(256680),r=e.i(290205);async function a(e,r){try{let a={locationId:e};r&&(a.productId=r);let s=await t.db.productHistory.findMany({where:a,include:{product:{select:{name:!0,costPrice:!0,sellingPrice:!0,sku:!0}}},orderBy:[{createdAt:"desc"},{id:"desc"}]});return{success:!0,data:s.map(e=>({id:e.id,productId:e.productId,oldQuantity:e.previousQuantity,newQuantity:e.newQuantity,changeReason:e.changeReason,createdAt:e.createdAt.toISOString(),referenceId:e.referenceId,receiptNumber:e.receiptNumber,product:e.product?{name:e.product.name,costPrice:e.product.costPrice,sellingPrice:e.product.sellingPrice,itemNumber:e.product.sku}:void 0}))}}catch(e){return console.error("Error fetching stock history:",e),{success:!1,error:e.message}}}async function s(e){try{let a=await t.db.$transaction(async t=>{let r=await t.productHistory.create({data:{userId:e.userId,locationId:e.locationId,productId:e.productId,previousQuantity:e.previousQuantity,newQuantity:e.newQuantity,changeReason:e.changeReason,referenceId:e.referenceId||null,receiptNumber:e.receiptNumber||null,createdAt:e.createdAt?new Date(e.createdAt):void 0}});return await t.product.update({where:{id:e.productId},data:{stock:e.newQuantity}}),r});return(0,r.revalidatePath)("/inventory"),{success:!0,data:a}}catch(e){return console.error("Error creating stock history:",e),{success:!1,error:e.message}}}async function i(e,a){try{let s=await t.db.$transaction(async t=>{let r=await t.productHistory.findMany({where:{productId:e,locationId:a},orderBy:[{createdAt:"asc"},{id:"asc"}]});if(0===r.length)return{finalQuantity:0};let s=0,i=[];for(let e of r){let r=e.newQuantity-e.previousQuantity,a=s,n=a+r;(e.previousQuantity!==a||e.newQuantity!==n)&&i.push(t.productHistory.update({where:{id:e.id},data:{previousQuantity:a,newQuantity:n}})),s=n}return i.length>0&&await Promise.all(i),await t.product.update({where:{id:e},data:{stock:s}}),{finalQuantity:s}});return(0,r.revalidatePath)("/inventory"),{success:!0,data:s}}catch(e){return console.error("Error recalculating stock chain:",e),{success:!1,error:e.message}}}async function n(e,a){try{let s=await t.db.$transaction(async t=>{let r=await t.productHistory.findMany({where:{referenceId:e,locationId:a},select:{productId:!0}}),s=[...new Set(r.map(e=>e.productId))];for(let r of(await t.productHistory.deleteMany({where:{referenceId:e,locationId:a}}),s))await c(t,r,a);return{affectedProducts:s.length}});return(0,r.revalidatePath)("/inventory"),{success:!0,data:s}}catch(e){return console.error("Error deleting stock history by reference:",e),{success:!1,error:e.message}}}async function o(e,a,s){try{let i=await t.db.productHistory.updateMany({where:{referenceId:e,locationId:a},data:{createdAt:new Date(s)}});return(0,r.revalidatePath)("/inventory"),{success:!0,data:i}}catch(e){return console.error("Error updating stock history dates:",e),{success:!1,error:e.message}}}async function c(e,t,r){let a=await e.productHistory.findMany({where:{productId:t,locationId:r},orderBy:[{createdAt:"asc"},{id:"asc"}]}),s=0;for(let t of a){let r=t.newQuantity-t.previousQuantity,a=s,i=a+r;(t.previousQuantity!==a||t.newQuantity!==i)&&await e.productHistory.update({where:{id:t.id},data:{previousQuantity:a,newQuantity:i}}),s=i}await e.product.update({where:{id:t},data:{stock:s}})}async function d(e,r){try{let a=await t.db.requisition.findMany({where:{userId:e,locationId:r},orderBy:{createdAt:"desc"}});return{success:!0,data:a.map(e=>({id:e.id,userId:e.userId,locationId:e.branchId,requisitionNumber:e.requisitionNumber,title:e.title||"",items:e.items||[],notes:e.notes,status:e.status,createdAt:e.createdAt.toISOString(),updatedAt:e.updatedAt.toISOString()}))}}catch(e){return console.error("Error fetching requisitions:",e),{success:!1,error:e.message}}}async function l(e){try{let a=await t.db.requisition.create({data:{userId:e.userId,branchId:e.locationId,requisitionNumber:e.requisitionNumber,title:e.title,items:e.items,notes:e.notes,status:e.status||"draft"}});return(0,r.revalidatePath)("/requisitions"),{success:!0,data:{id:a.id,userId:a.userId,locationId:a.branchId,requisitionNumber:a.requisitionNumber,title:a.title||"",items:a.items||[],notes:a.notes,status:a.status,createdAt:a.createdAt.toISOString(),updatedAt:a.updatedAt.toISOString()}}}catch(e){return console.error("Error creating requisition:",e),{success:!1,error:e.message}}}async function u(e,a,s){try{let i=await t.db.requisition.update({where:{id:e,userId:a},data:{title:s.title,items:s.items,notes:s.notes,status:s.status,updatedAt:new Date}});return(0,r.revalidatePath)("/requisitions"),{success:!0,data:{id:i.id,userId:i.userId,locationId:i.branchId,requisitionNumber:i.requisitionNumber,title:i.title||"",items:i.items||[],notes:i.notes,status:i.status,createdAt:i.createdAt.toISOString(),updatedAt:i.updatedAt.toISOString()}}}catch(e){return console.error("Error updating requisition:",e),{success:!1,error:e.message}}}async function y(e,a){try{return await t.db.requisition.delete({where:{id:e,userId:a}}),(0,r.revalidatePath)("/requisitions"),{success:!0}}catch(e){return console.error("Error deleting requisition:",e),{success:!1,error:e.message}}}async function h(e,r,a){try{let s=new Date(r),i=new Date(a),n=await t.db.product.findMany({where:{branchId:e},include:{category:!0}}),o=await Promise.all(n.map(async r=>{let a=await t.db.productHistory.findMany({where:{productId:r.id,locationId:e,createdAt:{gte:s,lte:i}},orderBy:{createdAt:"asc"}}),n=0,o=0,c=0,d=0;a.forEach(e=>{let t=e.newQuantity-e.previousQuantity;"SALE"===e.changeReason?n+=Math.abs(t):"STOCK_IN"===e.changeReason||"RESTOCK"===e.changeReason?o+=t:t>0?c+=t:d+=Math.abs(t)});let l=await t.db.productHistory.findFirst({where:{productId:r.id,locationId:e,createdAt:{lte:i}},orderBy:{createdAt:"desc"}}),u=l?l.newQuantity:0,y=u-(o+c-n-d);return{productId:r.id,productName:r.name,itemNumber:r.sku||r.id,imageUrl:r.imageUrl,costPrice:Number(r.costPrice),sellingPrice:Number(r.sellingPrice),category:r.category?.name,openingStock:y,itemsSold:n,stockIn:o,transferOut:0,returnIn:0,returnOut:0,adjustmentsIn:c,adjustmentsOut:d,closingStock:u,revaluation:u*Number(r.costPrice)}}));return{success:!0,data:o}}catch(e){return console.error("Error generating stock summary report:",e),{success:!1,error:e.message}}}async function p(e,r){try{let a=await t.db.product.findUnique({where:{id:r},include:{category:!0}});if(!a)return{success:!1,error:"Product not found"};let s=await t.db.productHistory.findMany({where:{productId:r,locationId:e},orderBy:[{createdAt:"asc"},{id:"asc"}]}),i=await t.db.sale.findMany({where:{branchId:e},orderBy:{date:"asc"}}),n=s.length>0?s[0].newStock:0,o=s.length>0?s[0].createdAt:null,c=new Map,d=0;i.forEach(e=>{let t=(e.items||[]).filter(e=>e.productId===r).reduce((e,t)=>e+(Number(t.quantity)||0),0);if(t>0)if(o&&e.date<o)d+=t;else{let r=e.date.toISOString().split("T")[0],a=c.get(r)||{itemsSold:0,stockAdded:0,transferOut:0,returnIn:0,returnOut:0,adjustments:0};a.itemsSold+=t,c.set(r,a)}}),s.slice(1).forEach(e=>{let t=e.createdAt.toISOString().split("T")[0],r=e.newStock-e.oldStock,a=(e.changeReason||"").toLowerCase(),s=c.get(t)||{itemsSold:0,stockAdded:0,transferOut:0,returnIn:0,returnOut:0,adjustments:0};"RESTOCK"===e.type||a.includes("purchase")||a.includes("addition")?s.stockAdded+=r:a.includes("transfer out")?s.transferOut+=Math.abs(r):a.includes("customer return")?s.returnIn+=r:a.includes("return to supplier")?s.returnOut+=Math.abs(r):"SALE"!==e.type&&(s.adjustments+=r),c.set(t,s)});let l=Array.from(c.keys()).sort(),u=[],y=n;for(let e of l){let t=c.get(e),r=y,a=r-t.itemsSold+t.stockAdded-t.transferOut+t.returnIn-t.returnOut+t.adjustments;u.push({date:e,startingStock:r,...t,endingStock:a}),y=a}return{success:!0,data:{product:{id:a.id,name:a.name,quantity:a.stock,itemNumber:a.sku},currentStock:a.stock,calculatedStock:y,discrepancy:a.stock-y,openingStock:n,openingDate:o?.toISOString(),excludedSalesQty:d,dailyBreakdown:u}}}catch(e){return console.error("Error in reconciliation action:",e),{success:!1,error:e.message}}}async function g(e){try{let r=await t.db.product.findMany({where:{branchId:e},select:{id:!0,name:!0,stock:!0}}),a=[];for(let s of r){let r=await t.db.productHistory.findMany({where:{productId:s.id,locationId:e},orderBy:[{createdAt:"asc"},{id:"asc"}]});if(0===r.length)continue;let i=0,n=[];for(let e of r){let t=e.newStock-e.oldStock,r=i,a=r+t;(e.oldStock!==r||e.newStock!==a)&&n.push({entryId:e.id,createdAt:e.createdAt.toISOString(),changeReason:e.changeReason,currentPrevQty:e.oldStock,currentNewQty:e.newStock,fixedPrevQty:r,fixedNewQty:a}),i=a}(n.length>0||Math.abs(s.stock-i)>.001)&&a.push({productId:s.id,productName:s.name,totalEntries:r.length,brokenEntries:n,finalFixedQty:i,currentProductQty:s.stock})}return{success:!0,data:a}}catch(e){return{success:!1,error:e.message}}}async function m(e,r){try{let a=r||(await t.db.product.findMany({where:{branchId:e},select:{id:!0}})).map(e=>e.id),s=0,n=0;for(let t of a)try{await i(t,e),s++}catch(e){n++}return{success:!0,data:{repaired:s,failed:n}}}catch(e){return{success:!1,error:e.message}}}async function f(e){try{let r=await t.db.activityHistory.findMany({where:{entityId:{in:e}},select:{entityId:!0,entityName:!0}});return{success:!0,data:r}}catch(e){return{success:!1,error:e.message,data:[]}}}async function v(e,r){try{return await t.db.productHistory.updateMany({where:{id:{in:e}},data:{createdAt:new Date(r)}}),{success:!0}}catch(e){return{success:!1,error:e.message}}}e.s(["createRequisitionAction",()=>l,"createStockHistoryAction",()=>s,"deleteRequisitionAction",()=>y,"deleteStockHistoryEntriesByReferenceAction",()=>n,"getActivityByEntityIdsAction",()=>f,"getProductReconciliationAction",()=>p,"getRequisitionsAction",()=>d,"getStockHistoryAction",()=>a,"getStockRepairsPreviewAction",()=>g,"getStockSummaryReportAction",()=>h,"recalculateStockChainAction",()=>i,"repairStockChainsAction",()=>m,"updateRequisitionAction",()=>u,"updateStockHistoryDatesAction",()=>v,"updateStockHistoryDatesByReferenceAction",()=>o])},368104,e=>{"use strict";var t=e.i(824216),r=e.i(46108),a=e.i(893930),s=e.i(285700),i=e.i(924432);e.s(["useStockSummaryData",0,e=>{let{user:n}=(0,t.useAuth)(),{currentBusiness:o}=(0,r.useBusiness)(),c=(0,s.useQueryClient)(),d=async()=>{if(!n?.id||!o?.id||!e?.from||!e?.to)return[];try{let t=await (0,i.getStockSummaryReportAction)(o.id,e.from.toISOString(),e.to.toISOString());if(t.success&&t.data)return t.data;throw Error(t.error)}catch(e){throw console.error("[StockSummary] Error fetching report:",e.message),e}},{data:l=[],isLoading:u,refetch:y}=(0,a.useQuery)({queryKey:["stockSummary",o?.id,e.from?.toISOString(),e.to?.toISOString()],queryFn:d,enabled:!!n?.id&&!!o?.id&&!!e?.from&&!!e?.to,staleTime:3e5,gcTime:18e5});return{stockSummaryData:l,isLoading:u,loadStockSummaryData:y,clearCache:()=>{c.invalidateQueries({queryKey:["stockSummary"]})},clearAllLocationCaches:()=>{c.invalidateQueries({queryKey:["stockSummary"]})}}}])},641405,e=>{"use strict";let t=(0,e.i(369547).default)("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);e.s(["Printer",()=>t],641405)},8745,(e,t,r)=>{let a=Error("Could not parse module '[project]/src/app/actions/products.ts'\n\n'import', and 'export' cannot be used outside of module code");throw a.code="MODULE_UNPARSABLE",a},355879,775778,e=>{"use strict";var t=e.i(191788),r=e.i(563905),a=e.i(46108),s=e.i(893930),i=e.i(285700);let n=e=>{let t=Object.keys(localStorage),r=["allProductsStats_","stockSummary_","soldItems_","dashboardData_","analyticsData_"],a=0;t.forEach(e=>{r.some(t=>e.startsWith(t))&&(localStorage.removeItem(e),a++)}),a>0&&console.log(`[Cache] Cleared ${a} inventory-related localStorage entries.`),e&&(console.log("[Cache] Invalidating React Query inventory keys..."),e.invalidateQueries({queryKey:["inventory_global_stats"]}),e.invalidateQueries({queryKey:["stockSummary"]}),e.invalidateQueries({queryKey:["products"]}),e.invalidateQueries({queryKey:["sales"]}),e.invalidateQueries({queryKey:["all-products-for-scanner"]}),e.invalidateQueries({queryKey:["all-products"]}))};e.s(["clearInventoryCaches",0,n],775778);var o=e.i(8745);e.s(["useProducts",0,(e,c=50)=>{let[d,l]=(0,t.useState)([]),[u,y]=(0,t.useState)(1),[h,p]=(0,t.useState)(c),[g,m]=(0,t.useState)(0),[f,v]=(0,t.useState)(!1),{settings:x}=(0,r.useBusinessSettings)(),{currentBusiness:w}=(0,a.useBusiness)(),k=(0,i.useQueryClient)(),[S,b]=(0,t.useState)({search:"",category:"all",stockStatus:"all"}),[j,A]=(0,t.useState)(null),I=(0,t.useCallback)(e=>{e.search!==S.search&&(v(!0),j&&clearTimeout(j),A(setTimeout(()=>{v(!1)},600))),b(e)},[S.search,j]),N=(0,t.useCallback)(async()=>{if(!e||!w)return{products:[],count:0};try{return await (0,o.getProductsAction)({userId:e,businessId:w.id,page:u,pageSize:h,search:S.search,category:"all"===S.category?void 0:S.category,stockStatus:S.stockStatus})}catch(e){return console.error("Error loading products from server action:",e),{products:[],count:0}}},[e,w?.id,u,h,S.search,S.category,S.stockStatus]),E=(0,t.useMemo)(()=>["products",e,w?.id],[e,w?.id]),D=(0,t.useMemo)(()=>[...E,u,h,S.search,S.category,S.stockStatus],[E,u,h,S.search,S.category,S.stockStatus]),{data:C,isLoading:Q,isFetching:P,refetch:q}=(0,s.useQuery)({queryKey:D,queryFn:N,enabled:!!e&&!!w?.id,staleTime:3e4,gcTime:18e5,refetchOnWindowFocus:!0,refetchOnReconnect:!0});(0,t.useEffect)(()=>{C&&(l(C.products),m(C.count))},[C]);let R=async t=>{try{if(!e)return null;return console.warn("Image upload redirecting to server action (TODO)"),null}catch(e){return console.error("Error in uploadProductImage:",e),null}};return{products:d,isLoading:Q&&!C&&!f,loadProducts:N,page:u,setPage:y,pageSize:h,setPageSize:p,totalCount:g,createProduct:async t=>{try{if(!e||!w)return null;let r=await (0,o.createProductAction)({...t,userId:e,businessId:w.id});if(!r)return null;return l(e=>[r,...e]),m(e=>e+1),k.invalidateQueries({queryKey:E}),n(k),r}catch(e){return console.error("Error creating product:",e),null}},updateProduct:async(t,r,a,s=!1,i,c,d,l)=>{try{if(!e||!w)return!1;let c=r.imageUrl;if(a&&(c=await R(a)),!await (0,o.updateProductAction)(t,{...r,imageUrl:c,userId:e,businessId:w.id,isFromSale:s,customChangeReason:i,referenceId:d}))return!1;return k.invalidateQueries({queryKey:E}),n(k),!0}catch(e){return console.error("Error updating product:",e),!1}},updateProductsBulk:async(t,r,a,s,i,c)=>{try{if(!e||!w)return!1;let r=await (0,o.updateProductsBulkAction)(t.map(e=>({id:e.id,updated:e.updated})),w.id);return r&&(k.invalidateQueries({queryKey:E}),n(k)),r}catch(e){return console.error("Error in bulk update:",e),!1}},deleteProduct:async t=>{try{if(!e)return!1;if(await (0,o.deleteProductAction)(t))return k.invalidateQueries({queryKey:E}),n(k),!0;return!1}catch(e){return console.error("Error deleting product:",e),!1}},uploadProductImage:R,refetch:q,isFetching:P,filters:S,setFilters:I}}],355879)},398957,e=>{"use strict";let t=(0,e.i(369547).default)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);e.s(["RefreshCw",()=>t],398957)},972733,e=>{"use strict";let t=(0,e.i(369547).default)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);e.s(["Plus",()=>t],972733)},909289,e=>{"use strict";let t=(0,e.i(369547).default)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);e.s(["Trash2",()=>t],909289)},708997,e=>{"use strict";let t=(0,e.i(369547).default)("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);e.s(["Edit",()=>t],708997)},432237,e=>{"use strict";let t=(0,e.i(369547).default)("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);e.s(["AlertTriangle",()=>t],432237)},327877,e=>{"use strict";let t=(0,e.i(369547).default)("Package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["path",{d:"m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7",key:"yx3hmr"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);e.s(["Package",()=>t],327877)},317176,(e,t,r)=>{"use strict";t.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},910432,(e,t,r)=>{"use strict";var a=e.r(317176);function s(){}function i(){}i.resetWarningCache=s,t.exports=function(){function e(e,t,r,s,i,n){if(n!==a){var o=Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function t(){return e}e.isRequired=e;var r={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:i,resetWarningCache:s};return r.PropTypes=r,r}},691567,(e,t,r)=>{t.exports=e.r(910432)()},83049,e=>{"use strict";var t=e.i(191788),r=e.i(46108),a=e.i(924432);e.s(["useStockHistory",0,(e,s)=>{let[i,n]=(0,t.useState)([]),[o,c]=(0,t.useState)(!0),{currentBusiness:d}=(0,r.useBusiness)(),l=(0,t.useCallback)(async()=>{if(!e||!d){n([]),c(!1);return}try{c(!0);let e=await (0,a.getStockHistoryAction)(d.id,s);if(!e.success||!e.data)throw Error(e.error||"Failed to fetch stock history");let t=e.data.map(e=>({id:e.id,productId:e.productId,oldQuantity:e.oldQuantity,newQuantity:e.newQuantity,changeReason:e.changeReason,createdAt:new Date(e.createdAt),referenceId:e.referenceId,receiptNumber:e.receiptNumber,product:e.product}));n(t)}catch(e){console.error("Error loading stock history:",e)}finally{c(!1)}},[e,d?.id,s]);return(0,t.useEffect)(()=>{l()},[l]),{stockHistory:i,isLoading:o,createStockHistoryEntry:async(t,r,s,i,n,o,c,u)=>{try{if(!e||!d)return!1;let y=u?`[${u}] | ${i}`:i,h=await (0,a.createStockHistoryAction)({userId:e,locationId:d.id,productId:t,previousQuantity:r,newQuantity:s,changeReason:y,referenceId:n,receiptNumber:c,createdAt:o?.toISOString()});if(!h.success)return console.error("Error creating stock history entry:",h.error),!1;return await l(),!0}catch(e){return console.error("Error creating stock history:",e),!1}},deleteMultipleStockHistoryEntriesByReference:async e=>{try{if(!d)return!1;let t=await (0,a.deleteStockHistoryEntriesByReferenceAction)(e,d.id);if(!t.success)throw Error(t.error);return await l(),!0}catch(e){return console.error("Error deleting stock history entries:",e),!1}},recalculateStockChain:async e=>{try{if(!d)return!1;let t=await (0,a.recalculateStockChainAction)(e,d.id);if(!t.success)throw Error(t.error);return await l(),!0}catch(e){return console.error("Error recalculating stock chain:",e),!1}},updateStockHistoryDatesBySaleId:async(e,t)=>{try{if(!d)return!1;let r=await (0,a.updateStockHistoryDatesByReferenceAction)(e,d.id,t.toISOString());if(!r.success)throw Error(r.error);return await l(),!0}catch(e){return console.error("Error updating stock history dates:",e),!1}},repairAllStockChains:async e=>{try{if(!d)return{repaired:0,failed:0};let e=await (0,a.repairStockChainsAction)(d.id);if(e.success&&e.data)return e.data;return{repaired:0,failed:0}}catch(e){return console.error("Error repairing all chains:",e),{repaired:0,failed:0}}},previewStockChainRepairs:async e=>{try{if(!d)return[];let e=await (0,a.getStockRepairsPreviewAction)(d.id);if(e.success&&e.data)return e.data;return[]}catch(e){return console.error("Error previewing repairs:",e),[]}},refreshHistory:l}}])},721070,297375,531877,e=>{"use strict";let t=(0,e.i(369547).default)("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);e.s(["History",()=>t],721070);var r=e.i(391398),a=e.i(191788),s=e.i(296202),i=e.i(939310),n=e.i(45124),o=e.i(91762),c=e.i(792042),d=e.i(150064),l=e.i(638822);e.s(["default",0,({open:e,onOpenChange:t,entry:u,onConfirm:y,isInitialStock:h=!1,stockHistory:p=[],productCreatedAt:g})=>{let[m,f]=(0,a.useState)(0),[v,x]=(0,a.useState)(""),[w,k]=(0,a.useState)(!1),[S,b]=(0,a.useState)(""),{toast:j}=(0,d.useToast)(),{hasPermission:A}=(0,l.useProfiles)();(0,a.useEffect)(()=>{u&&(f(u.newQuantity-u.oldQuantity),x(u.changeReason),b(""))},[u]);let I=(e,t)=>t<0&&e>0?"Cannot change from negative to positive value.":t>0&&e<0?"Cannot change from positive to negative value.":"",N=e=>{if(""===e){f(""),b("");return}let t=parseInt(e)||0,r=I(t,""===m?0:m);r?b(r):(f(t),b(""))},E=async(e=!1)=>{if(!u)return;let r=""===m?0:m,a=I(r,u.newQuantity-u.oldQuantity);if(a)return void j({title:"Invalid quantity change",description:a,variant:"destructive"});let s=u.oldQuantity+r;if(!v.trim())return void j({title:"Invalid reason",description:"Please provide a reason for this stock change",variant:"destructive"});k(!0);try{await y(u.id,s,v.trim())?(j({title:"Stock history updated",description:"The stock history entry has been updated successfully."}),t(!1)):j({title:"Update failed",description:"Failed to update stock history entry. Please try again.",variant:"destructive"})}catch(e){console.error("Error updating stock history:",e),j({title:"Error",description:"An error occurred while updating the stock history.",variant:"destructive"})}finally{k(!1)}},D=()=>{t(!1)};if(!u)return null;if(h)return(0,r.jsx)(s.Dialog,{open:e,onOpenChange:t,children:(0,r.jsxs)(s.DialogContent,{className:"sm:max-w-md",children:[(0,r.jsxs)(s.DialogHeader,{children:[(0,r.jsx)(s.DialogTitle,{children:"Edit Initial Stock Entry"}),(0,r.jsx)(s.DialogDescription,{children:"This is the initial stock entry. You can modify quantity, reason, and date, but the date must be earlier than all other stock transactions."})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(o.Label,{htmlFor:"quantity",children:"Quantity Change"}),(0,r.jsx)(n.Input,{id:"quantity",type:"number",value:m,onChange:e=>N(e.target.value),className:S?"border-destructive border-2 bg-destructive/5 focus:border-destructive focus:ring-destructive":""}),S&&(0,r.jsx)("p",{className:"text-sm text-destructive",children:S})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(o.Label,{htmlFor:"reason",children:"Change Reason"}),(0,r.jsx)(n.Input,{id:"reason",value:v,onChange:e=>x(e.target.value),placeholder:"Enter reason for stock change"})]})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-2 mt-6",children:[(0,r.jsx)(i.Button,{variant:"outline",onClick:D,disabled:w,children:"Cancel"}),(0,r.jsx)(i.Button,{onClick:()=>E(),disabled:w||!A("inventory","stock_adjustment"),children:w?"Updating...":"Update Entry"})]})]})});if(["Sale","Delete sale","Deleted Sale","Sale qty edit"].some(e=>u.changeReason.toLowerCase().includes(e.toLowerCase())))return(0,r.jsx)(s.Dialog,{open:e,onOpenChange:t,children:(0,r.jsxs)(s.DialogContent,{className:"sm:max-w-md",children:[(0,r.jsxs)(s.DialogHeader,{children:[(0,r.jsx)(s.DialogTitle,{children:"Cannot Edit Sale-Related Entry"}),(0,r.jsx)(s.DialogDescription,{children:"This stock history entry was created by a sales operation and can only be modified through the Edit Sale form."})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"bg-muted p-3 rounded-lg space-y-2",children:[(0,r.jsx)("div",{className:"font-medium",children:"Entry Details:"}),(0,r.jsxs)("div",{className:"text-sm space-y-1",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Date:"})," ",(0,c.format)(u.createdAt,"PPP p")]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Change:"})," ",u.oldQuantity," → ",u.newQuantity]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Reason:"})," ",u.changeReason.replace("Deleted sale","Deleted Sale")]})]})]}),(0,r.jsx)("div",{className:"bg-blue-50 border border-blue-200 p-3 rounded-lg",children:(0,r.jsxs)("div",{className:"text-blue-800 text-sm",children:[(0,r.jsx)("strong",{children:"Note:"})," To modify this entry, please use the Edit Sale form in the Sales section."]})})]}),(0,r.jsx)("div",{className:"flex justify-end gap-2 mt-6",children:(0,r.jsx)(i.Button,{variant:"outline",onClick:()=>t(!1),children:"Close"})})]})});let C=u.newQuantity-u.oldQuantity,Q=""===m?0:m,P=u.oldQuantity+Q;return(0,r.jsx)(s.Dialog,{open:e,onOpenChange:t,children:(0,r.jsxs)(s.DialogContent,{className:"sm:max-w-md",children:[(0,r.jsxs)(s.DialogHeader,{children:[(0,r.jsx)(s.DialogTitle,{children:"Edit Stock History Entry"}),(0,r.jsx)(s.DialogDescription,{children:"Modify the details of this stock history entry. The product's current stock will be recalculated after saving."})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(o.Label,{className:"text-muted-foreground",children:"Original"}),(0,r.jsxs)("div",{className:"font-medium",children:[u.oldQuantity," → ",u.newQuantity]}),(0,r.jsxs)("div",{className:`text-xs ${C>=0?"text-green-600":"text-red-600"}`,children:[C>=0?"+":"",C]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(o.Label,{className:"text-muted-foreground",children:"New"}),(0,r.jsxs)("div",{className:"font-medium",children:[u.oldQuantity," → ",P]}),(0,r.jsxs)("div",{className:`text-xs ${Q>=0?"text-green-600":"text-red-600"}`,children:[Q>=0?"+":"",Q]})]})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(o.Label,{htmlFor:"quantity",children:"Quantity Change"}),(0,r.jsx)(n.Input,{id:"quantity",type:"number",value:m,onChange:e=>N(e.target.value),className:S?"border-destructive border-2 bg-destructive/5 focus:border-destructive focus:ring-destructive":""}),u&&(0,r.jsxs)("p",{className:"text-xs text-muted-foreground",children:["⚠️ ",(""===m?0:m)<0?"Current change is negative - you cannot change to positive values":"Current change is positive - you cannot change to negative values"]}),S&&(0,r.jsx)("p",{className:"text-sm text-destructive",children:S})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(o.Label,{htmlFor:"reason",children:"Change Reason"}),(0,r.jsx)(n.Input,{id:"reason",value:v,onChange:e=>x(e.target.value),placeholder:"Enter reason for stock change"})]})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-2 mt-6",children:[(0,r.jsx)(i.Button,{variant:"outline",onClick:D,disabled:w,children:"Cancel"}),(0,r.jsx)(i.Button,{onClick:()=>E(),disabled:w||!A("inventory","stock_adjustment"),children:w?"Updating...":"Update Entry"})]})]})})}],297375);var u=e.i(212283),y=e.i(432237);e.s(["default",0,({open:e,onOpenChange:t,entry:s,onConfirm:i})=>{let[n,o]=(0,a.useState)(!1),{toast:l}=(0,d.useToast)(),h=async()=>{if(s){o(!0);try{await i(s.id)?(l({title:"Stock history deleted",description:"The stock history entry has been deleted and stock recalculated."}),t(!1)):l({title:"Delete failed",description:"Failed to delete stock history entry. Please try again.",variant:"destructive"})}catch(e){console.error("Error deleting stock history:",e),l({title:"Error",description:"An error occurred while deleting the stock history.",variant:"destructive"})}finally{o(!1)}}};if(!s)return null;if(["Sale","Delete sale","Deleted Sale","Sale qty edit"].some(e=>s.changeReason.toLowerCase().includes(e.toLowerCase())))return(0,r.jsx)(u.AlertDialog,{open:e,onOpenChange:t,children:(0,r.jsxs)(u.AlertDialogContent,{children:[(0,r.jsxs)(u.AlertDialogHeader,{children:[(0,r.jsxs)(u.AlertDialogTitle,{className:"flex items-center gap-2",children:[(0,r.jsx)(y.AlertTriangle,{className:"h-5 w-5 text-blue-600"}),"Cannot Delete Sale-Related Entry"]}),(0,r.jsxs)(u.AlertDialogDescription,{className:"space-y-3",children:[(0,r.jsx)("p",{children:"This stock history entry was created by a sales operation and cannot be deleted directly."}),(0,r.jsxs)("div",{className:"bg-muted p-3 rounded-lg space-y-2",children:[(0,r.jsx)("div",{className:"font-medium",children:"Entry Details:"}),(0,r.jsxs)("div",{className:"text-sm space-y-1",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Date:"})," ",(0,c.format)(s.createdAt,"PPP p")]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Change:"})," ",s.oldQuantity," → ",s.newQuantity]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Reason:"})," ",s.changeReason.replace("Deleted sale","Deleted Sale")]})]})]}),(0,r.jsx)("div",{className:"bg-blue-50 border border-blue-200 p-3 rounded-lg",children:(0,r.jsxs)("div",{className:"text-blue-800 text-sm",children:[(0,r.jsx)("strong",{children:"Note:"})," To remove this entry, please edit or delete the corresponding sale in the Sales section."]})})]})]}),(0,r.jsx)(u.AlertDialogFooter,{children:(0,r.jsx)(u.AlertDialogCancel,{children:"Close"})})]})});let p=s.newQuantity-s.oldQuantity;return(0,r.jsx)(u.AlertDialog,{open:e,onOpenChange:t,children:(0,r.jsxs)(u.AlertDialogContent,{children:[(0,r.jsxs)(u.AlertDialogHeader,{children:[(0,r.jsxs)(u.AlertDialogTitle,{className:"flex items-center gap-2",children:[(0,r.jsx)(y.AlertTriangle,{className:"h-5 w-5 text-destructive"}),"Delete Stock History Entry"]}),(0,r.jsxs)(u.AlertDialogDescription,{className:"space-y-3",children:[(0,r.jsx)("p",{children:"Are you sure you want to delete this stock history entry? This action cannot be undone."}),(0,r.jsxs)("div",{className:"bg-muted p-3 rounded-lg space-y-2",children:[(0,r.jsx)("div",{className:"font-medium",children:"Entry Details:"}),(0,r.jsxs)("div",{className:"text-sm space-y-1",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Date:"})," ",(0,c.format)(s.createdAt,"PPP p")]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Change:"})," ",s.oldQuantity," → ",s.newQuantity]}),(0,r.jsxs)("div",{className:`${p>=0?"text-green-600":"text-red-600"}`,children:[(0,r.jsx)("strong",{children:"Impact:"})," ",p>=0?"+":"",p," units"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Reason:"})," ",s.changeReason.replace("Deleted sale","Deleted Sale")]})]})]}),(0,r.jsx)("div",{className:"bg-amber-50 border border-amber-200 p-3 rounded-lg",children:(0,r.jsxs)("div",{className:"text-amber-800 text-sm",children:[(0,r.jsx)("strong",{children:"Warning:"})," After deletion, the product's current stock will be automatically recalculated based on the remaining stock history entries."]})})]})]}),(0,r.jsxs)(u.AlertDialogFooter,{children:[(0,r.jsx)(u.AlertDialogCancel,{disabled:n,children:"Cancel"}),(0,r.jsx)(u.AlertDialogAction,{onClick:h,disabled:n,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:n?"Deleting...":"Delete Entry"})]})]})})}],531877)}]);