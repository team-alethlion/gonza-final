(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,983766,e=>{"use strict";var t=e.i(391398),s=e.i(191788),a=e.i(365713),r=e.i(824216),l=e.i(355879),i=e.i(83049),n=e.i(368104),c=e.i(679935),d=e.i(57997),o=e.i(46108),m=e.i(426119),u=e.i(939310),x=e.i(563905),h=e.i(353533),g=e.i(599875),y=e.i(708997),p=e.i(327877),j=e.i(675878),f=e.i(386408),b=e.i(909289),N=e.i(369547);let v=(0,N.default)("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);var w=e.i(398957),k=e.i(641405),C=e.i(687072);let S=(0,N.default)("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]);var D=e.i(972733);let P=(0,N.default)("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);var A=e.i(57977),Q=e.i(681912);let B=async e=>{let{productName:t,barcodeValue:a,price:r,currency:l="KES",showPrice:i=!0}=e,n=document.createElement("div");n.style.position="absolute",n.style.left="-9999px",n.style.top="-9999px",n.style.width="340px",n.style.padding="20px",n.style.backgroundColor="white",n.style.fontFamily="Arial, sans-serif",document.body.appendChild(n);try{let e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.gap="10px";let c=document.createElement("div");c.textContent=t,c.style.fontSize="18px",c.style.fontWeight="bold",c.style.textAlign="center",c.style.maxWidth="100%",c.style.wordWrap="break-word",e.appendChild(c);let o=document.createElement("div");if(o.id="barcode-svg-container",e.appendChild(o),i&&void 0!==r){let t=document.createElement("div");t.textContent=`${l} ${r.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`,t.style.fontSize="18px",t.style.fontWeight="bold",t.style.textAlign="center",e.appendChild(t)}n.appendChild(e);let m=(0,Q.createRoot)(o);await new Promise(e=>{let t=d.default;m.render(s.default.createElement(t,{value:a,width:2,height:80,fontSize:16})),setTimeout(()=>e(),100)}),(await (0,A.default)(n,{backgroundColor:"#ffffff",scale:2})).toBlob(e=>{if(e){let s=URL.createObjectURL(e),a=document.createElement("a"),r=t.replace(/[^a-z0-9]/gi,"_").toLowerCase();a.download=`barcode_${r}_${Date.now()}.jpg`,a.href=s,a.click(),URL.revokeObjectURL(s)}},"image/jpeg",.95),m.unmount()}catch(e){throw console.error("Error exporting barcode to JPEG:",e),e}finally{document.body.removeChild(n)}};var T=e.i(413259),E=e.i(89635),$=e.i(792042),M=e.i(212283);let L=({open:e,onOpenChange:s,product:a,onConfirm:r})=>(0,t.jsx)(M.AlertDialog,{open:e,onOpenChange:s,children:(0,t.jsxs)(M.AlertDialogContent,{children:[(0,t.jsxs)(M.AlertDialogHeader,{children:[(0,t.jsx)(M.AlertDialogTitle,{children:"Are you sure?"}),(0,t.jsxs)(M.AlertDialogDescription,{children:['This will delete the product "',a?.name,'" and all its associated data. This action cannot be undone.']})]}),(0,t.jsxs)(M.AlertDialogFooter,{children:[(0,t.jsx)(M.AlertDialogCancel,{children:"Cancel"}),(0,t.jsx)(M.AlertDialogAction,{onClick:()=>{r(),s(!1)},className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})});var I=e.i(45124),O=e.i(638822),F=e.i(296202),H=e.i(130027),z=e.i(91762);let q=({product:e,stockHistory:n,isLoadingHistory:N,onStockUpdate:A})=>{let Q=(0,a.useNavigate)(),{user:M}=(0,r.useAuth)(),{currentBusiness:q}=(0,o.useBusiness)(),{settings:R}=(0,x.useBusinessSettings)(),{updateProduct:U,deleteProduct:_}=(0,l.useProducts)(M?.id),{createStockHistoryEntry:V,stockHistory:W}=(0,i.useStockHistory)(M?.id,e.id),{hasPermission:X}=(0,O.useProfiles)(),[G,J]=(0,s.useState)(!1),[K,Z]=(0,s.useState)(!1),[Y,ee]=(0,s.useState)("Stock In"),[et,es]=(0,s.useState)(0),[ea,er]=(0,s.useState)(""),[el,ei]=(0,s.useState)(new Date().toISOString().split("T")[0]),[en,ec]=(0,s.useState)(new Date().toTimeString().split(" ")[0]),[ed,eo]=(0,s.useState)(!1),[em,eu]=(0,s.useState)(!1),[ex,eh]=(0,s.useState)(!0),[eg,ey]=(0,s.useState)(1),[ep,ej]=(0,s.useState)(!1),{formatFinancial:ef,canViewCostPrice:eb,canViewProfit:eN,canViewSellingPrice:ev}=(0,E.useFinancialVisibility)(),ew=async()=>!!await _(e.id)&&(c.toast.success("Product deleted successfully"),Q("/inventory"),!0),ek=(e,t)=>{if(!e)return"";let s=(()=>{let e=n.length>0?n:W;if(0===e.length)return null;let t=[...e].sort((e,t)=>e.createdAt.getTime()-t.createdAt.getTime());return t[0]?.createdAt||null})();if(!s)return"";let[a,r,l]=e.split("-").map(Number),[i,c,d=0]=t.split(":").map(Number);return new Date(a,r-1,l,i,c,d)<s?`Date and time cannot be before the initial stock date and time (${(0,$.format)(s,"PPP p")})`:""},eC=async()=>{if(!et||et<=0)return void c.toast.error("Please enter a valid quantity greater than zero");let t=ek(el,en);if(t)return void c.toast.error(t);eo(!0);try{let t=e.quantity,s=t,a=ea.trim()?`${Y}: ${ea}`:Y;"Stock In"===Y?s=t+et:"Stock Out"===Y&&(s=Math.max(0,t-et),0===s&&t<et&&c.toast.warning(`Attempted to remove ${et} items but only ${t} were available. Stock is now 0.`));let[r,l,i]=el.split("-").map(Number),[n,d,o=0]=en.split(":").map(Number),m=new Date(r,l-1,i,n,d,o);await V(e.id,t,s,a,void 0,m,void 0,e.name)?await U(e.id,{quantity:s},void 0,!1,"skip-history")?(c.toast.success("Stock updated successfully"),A&&A(),es(0),er(""),ei(new Date().toISOString().split("T")[0]),ec(new Date().toTimeString().split(" ")[0])):c.toast.error("History logged, but failed to update product quantity."):c.toast.error("Failed to update stock history")}catch(e){console.error("Error applying stock adjustment:",e),c.toast.error("Failed to apply stock adjustment. Please try again.")}finally{eo(!1)}};return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 md:p-4 shadow-sm",children:(0,t.jsxs)("div",{className:"flex flex-col space-y-3 lg:flex-row lg:justify-between lg:items-center lg:space-y-0 lg:gap-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(u.Button,{variant:"outline",size:"sm",onClick:()=>Q("/products"),className:"flex items-center gap-2 hover:bg-gray-50 text-sm",children:[(0,t.jsx)(f.ArrowLeft,{className:"h-4 w-4"}),"Back to Products"]}),(0,t.jsxs)(u.Button,{variant:"outline",size:"sm",onClick:A,className:"flex items-center gap-1 text-sm",children:[(0,t.jsx)(w.RefreshCw,{className:"h-4 w-4"}),"Refresh Data"]})]}),(0,t.jsxs)("div",{className:"flex flex-col space-y-2 lg:flex-row lg:items-center lg:space-y-0 lg:gap-2",children:[X("inventory","create")&&(0,t.jsxs)(u.Button,{variant:"outline",size:"sm",onClick:()=>{c.toast.success("Duplicating product..."),Q("/inventory/new",{state:{duplicateData:{name:`${e.name} (Copy)`,description:e.description,category:e.category,supplier:e.supplier,costPrice:e.costPrice,sellingPrice:e.sellingPrice,imageUrl:e.imageUrl,createdAt:e.createdAt,minimumStock:e.minimumStock}}})},className:"flex items-center justify-center gap-2 w-full lg:w-auto hover:bg-blue-50 hover:border-blue-300 text-sm",children:[(0,t.jsx)(v,{className:"h-4 w-4"}),"Duplicate"]}),X("inventory","edit")&&(0,t.jsxs)(u.Button,{onClick:()=>Q(`/inventory/edit/${e.id}`),className:"flex items-center justify-center gap-2 w-full lg:w-auto bg-secondary hover:bg-secondary/90 text-sm",size:"sm",children:[(0,t.jsx)(y.Edit,{className:"h-4 w-4"}),"Edit Product"]}),(0,t.jsxs)(F.Dialog,{open:em,onOpenChange:eu,children:[(0,t.jsx)(F.DialogTrigger,{asChild:!0,children:(0,t.jsxs)(u.Button,{variant:"outline",size:"sm",className:"flex items-center justify-center gap-2 w-full lg:w-auto hover:bg-green-50 hover:border-green-300 text-sm",children:[(0,t.jsx)(k.Printer,{className:"h-4 w-4"}),"Barcode Label"]})}),(0,t.jsxs)(F.DialogContent,{className:"sm:max-w-md",children:[(0,t.jsx)(F.DialogHeader,{children:(0,t.jsx)(F.DialogTitle,{children:"Barcode Label Preview"})}),(0,t.jsx)("div",{className:"flex flex-col items-center justify-center py-6 bg-gray-50 rounded-lg border border-dashed",children:e.barcode?(0,t.jsxs)("div",{className:"bg-white p-6 shadow-sm rounded-md flex flex-col items-center",children:[(0,t.jsx)("span",{className:"text-lg font-bold mb-2 truncate max-w-[280px]",children:e.name}),(0,t.jsx)(d.default,{value:e.barcode,width:2,height:80,fontSize:16}),ex&&(0,t.jsxs)("span",{className:"text-lg font-bold mt-2",children:[R.currency," ",(0,h.formatNumber)(e.sellingPrice)]})]}):(0,t.jsxs)("div",{className:"text-center p-6 text-muted-foreground",children:[(0,t.jsx)(j.AlertCircle,{className:"h-10 w-10 mx-auto mb-2 opacity-50"}),(0,t.jsx)("p",{children:"No barcode available for this selection."})]})}),(0,t.jsxs)("div",{className:"space-y-4 pt-4 border-t",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"space-y-0.5",children:[(0,t.jsx)(z.Label,{className:"text-sm font-medium",children:"Show Price"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Include price on the printed label"})]}),(0,t.jsx)(H.Switch,{checked:ex,onCheckedChange:eh})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"space-y-0.5",children:[(0,t.jsx)(z.Label,{className:"text-sm font-medium",children:"Quantity to Print"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Number of labels to print"})]}),(0,t.jsx)(I.Input,{type:"number",min:"1",className:"w-20",value:eg,onChange:e=>ey(parseInt(e.target.value)||1)})]}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,t.jsxs)(u.Button,{className:"w-full gap-2",disabled:!e.barcode,onClick:()=>{let t=ex?`TEXT 15,180,"3",0,1,1,"${R.currency} ${(0,h.formatNumber)(e.sellingPrice)}"
`:"";fetch("http://localhost:5000/print/label",{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({PrinterName:R.defaultPrinterName||"Label Printer",Content:`SIZE 50 mm, 30 mm
GAP 3 mm, 0 mm
CLS
TEXT 15,20,"3",0,1,1,"${e.name}"
BARCODE 15,70,"128",60,1,0,2,2,"${e.barcode}"
${t}PRINT ${eg}
`})}).then(()=>{c.toast.success(`${eg} label${eg>1?"s":""} sent to printer`)}).catch(e=>{console.error("Failed to print label:",e),c.toast.error("Printing failed. Make sure Printer Bridge is running.")})},children:[(0,t.jsx)(k.Printer,{className:"h-4 w-4"}),"Print ",eg," Label",eg>1?"s":""]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("div",{className:"absolute inset-0 flex items-center",children:(0,t.jsx)("span",{className:"w-full border-t"})}),(0,t.jsx)("div",{className:"relative flex justify-center text-xs uppercase",children:(0,t.jsx)("span",{className:"bg-background px-2 text-muted-foreground",children:"Or Download"})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,t.jsxs)(u.Button,{variant:"outline",className:"gap-2",disabled:!e.barcode||ep,onClick:async()=>{ej(!0);try{await B({productName:e.name,barcodeValue:e.barcode,price:e.sellingPrice,currency:R.currency,showPrice:ex}),c.toast.success("Barcode exported as JPEG")}catch(e){console.error("Export failed:",e),c.toast.error("Failed to export barcode")}finally{ej(!1)}},children:[(0,t.jsx)(S,{className:"h-4 w-4"}),"JPEG"]}),(0,t.jsxs)(u.Button,{variant:"outline",className:"gap-2",disabled:!e.barcode||ep,onClick:async()=>{ej(!0);try{await (0,T.exportSingleBarcodeToPDF)({productName:e.name,barcodeValue:e.barcode,price:e.sellingPrice,currency:R.currency,showPrice:ex}),c.toast.success("Barcode exported as PDF")}catch(e){console.error("Export failed:",e),c.toast.error("Failed to export barcode")}finally{ej(!1)}},children:[(0,t.jsx)(C.Download,{className:"h-4 w-4"}),"PDF"]})]}),(0,t.jsx)(u.Button,{variant:"outline",className:"w-full",onClick:()=>eu(!1),children:"Close"})]})]})]})]}),X("inventory","delete")&&(0,t.jsxs)(u.Button,{variant:"outline",size:"sm",onClick:()=>J(!0),className:"flex items-center justify-center gap-2 w-full lg:w-auto text-red-600 hover:text-red-700 border-red-200 hover:border-red-300 hover:bg-red-50 text-sm",children:[(0,t.jsx)(b.Trash2,{className:"h-4 w-4"}),"Delete"]})]})]})}),(0,t.jsxs)("div",{className:"grid md:grid-cols-3 gap-6",children:[(0,t.jsxs)(m.Card,{className:"md:col-span-2",children:[(0,t.jsx)(m.CardHeader,{children:(0,t.jsxs)(m.CardTitle,{className:"flex justify-between items-center",children:[(0,t.jsx)("span",{children:"Product Details"}),0===e.quantity?(0,t.jsx)(g.Badge,{variant:"destructive",className:"text-sm",children:"Out of stock"}):e.quantity<=e.minimumStock?(0,t.jsx)(g.Badge,{variant:"warning",className:"bg-amber-500 text-sm",children:"Low stock"}):(0,t.jsx)(g.Badge,{variant:"success",className:"bg-green-600 text-sm",children:"In stock"})]})}),(0,t.jsxs)(m.CardContent,{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"flex flex-col md:flex-row gap-6",children:[e.imageUrl&&(0,t.jsx)("div",{className:"md:w-1/3",children:(0,t.jsx)("img",{src:e.imageUrl,alt:e.name,className:"w-full h-auto object-contain border rounded-md"})}),(0,t.jsxs)("div",{className:e.imageUrl?"md:w-2/3":"w-full",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold mb-2",children:e.name}),(0,t.jsxs)("div",{className:"mb-4 flex flex-wrap gap-2",children:[(0,t.jsx)(g.Badge,{variant:"outline",children:e.category}),(0,t.jsxs)(g.Badge,{variant:"secondary",children:["#",e.itemNumber]})]}),e.description&&(0,t.jsx)("p",{className:"text-gray-700 mb-4",children:e.description}),(0,t.jsxs)("dl",{className:"grid grid-cols-2 gap-x-4 gap-y-2",children:[(0,t.jsx)("dt",{className:"text-gray-500",children:"Item Number:"}),(0,t.jsxs)("dd",{className:"font-semibold",children:["#",e.itemNumber]}),e.manufacturerBarcode&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("dt",{className:"text-gray-500",children:"Manufacturer Barcode:"}),(0,t.jsx)("dd",{className:"font-semibold",children:e.manufacturerBarcode})]}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Quantity in Stock:"}),(0,t.jsx)("dd",{className:"font-semibold",children:e.quantity%1==0?e.quantity:e.quantity.toFixed(2)}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Minimum Stock Level:"}),(0,t.jsx)("dd",{children:e.minimumStock}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Cost Price:"}),(0,t.jsx)("dd",{children:eb?`${R.currency} ${ef(e.costPrice,"cost")}`:"•••"}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Selling Price:"}),(0,t.jsx)("dd",{children:ev?`${R.currency} ${ef(e.sellingPrice,"selling")}`:"•••"}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Total Cost:"}),(0,t.jsx)("dd",{className:"font-semibold",children:eb?`${R.currency} ${(0,h.formatNumber)(e.quantity*e.costPrice)}`:"•••"}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Profit Margin:"}),(0,t.jsx)("dd",{children:eN?`${((e.sellingPrice-e.costPrice)/e.sellingPrice*100).toFixed(2)}%`:"•••"}),e.supplier&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("dt",{className:"text-gray-500",children:"Supplier:"}),(0,t.jsx)("dd",{children:e.supplier})]}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Created:"}),(0,t.jsx)("dd",{children:(0,$.format)(e.createdAt,"MMM d, yyyy")}),(0,t.jsx)("dt",{className:"text-gray-500",children:"Last Updated:"}),(0,t.jsx)("dd",{children:(0,$.format)(e.updatedAt,"MMM d, yyyy")})]})]})]}),(0,t.jsx)("div",{className:"flex flex-wrap gap-4",children:e.quantity<=e.minimumStock&&(0,t.jsxs)("div",{className:"bg-amber-50 border border-amber-200 rounded-md p-4 w-full flex items-center gap-3",children:[(0,t.jsx)(j.AlertCircle,{className:"text-amber-600 h-6 w-6 flex-shrink-0"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-medium text-amber-800",children:"Low Stock Alert"}),(0,t.jsxs)("p",{className:"text-sm text-amber-700",children:["Current stock (",e.quantity,") is below or equal to the minimum threshold (",e.minimumStock,")."]})]})]})})]})]}),(0,t.jsx)("div",{className:"space-y-6",children:(0,t.jsxs)(m.Card,{children:[(0,t.jsx)(m.CardHeader,{className:"pb-2",children:(0,t.jsx)(m.CardTitle,{className:"text-lg",children:"Stock Management"})}),(0,t.jsx)(m.CardContent,{children:X("inventory","stock_adjustment")?(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Adjustment Type"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-2",children:[(0,t.jsxs)(u.Button,{type:"button",variant:"Stock In"===Y?"default":"outline",onClick:()=>ee("Stock In"),className:`w-full ${"Stock In"===Y?"bg-orange-600 hover:bg-orange-700":""}`,children:[(0,t.jsx)(D.Plus,{className:"mr-2 h-4 w-4"}),"Stock In"]}),(0,t.jsxs)(u.Button,{type:"button",variant:"Stock Out"===Y?"default":"outline",onClick:()=>ee("Stock Out"),className:`w-full ${"Stock Out"===Y?"bg-orange-600 hover:bg-orange-700":""}`,children:[(0,t.jsx)(P,{className:"mr-2 h-4 w-4"}),"Stock Out"]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),(0,t.jsx)(I.Input,{type:"number",min:"0.01",step:"0.01",value:et||"",onChange:e=>es(parseFloat(e.target.value)||0),placeholder:"Enter quantity"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Reason (Optional)"}),(0,t.jsx)(I.Input,{type:"text",value:ea,onChange:e=>er(e.target.value),placeholder:"e.g., Weekly restock, Damaged goods",maxLength:100})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Date"}),(0,t.jsx)(I.Input,{type:"date",value:el,onChange:e=>ei(e.target.value),min:e.createdAt?new Date(e.createdAt).toISOString().split("T")[0]:void 0,max:new Date().toISOString().split("T")[0],className:ek(el,en)?"border-destructive border-2 bg-destructive/5":""})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Time"}),(0,t.jsx)(I.Input,{type:"time",step:"1",value:en,onChange:e=>ec(e.target.value),className:ek(el,en)?"border-destructive border-2 bg-destructive/5":""})]})]}),ek(el,en)&&(0,t.jsx)("p",{className:"text-sm text-destructive mt-1",children:ek(el,en)}),(0,t.jsxs)(u.Button,{onClick:eC,disabled:ed||et<=0||!!ek(el,en),className:"w-full bg-orange-600 hover:bg-orange-700",children:[(0,t.jsx)(p.Package,{className:"mr-2 h-4 w-4"}),ed?"Applying...":`Apply ${Y}`]})]}):(0,t.jsxs)("div",{className:"py-4 text-center space-y-2",children:[(0,t.jsx)(j.AlertCircle,{className:"h-8 w-8 text-muted-foreground mx-auto opacity-50"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"You do not have permission to perform stock adjustments."})]})})]})})]}),(0,t.jsx)(L,{open:G,onOpenChange:J,product:e,onConfirm:ew})]})};var R=e.i(756043),U=e.i(721070),_=e.i(297375),V=e.i(531877);let W=({stockHistory:e,isLoadingHistory:a,onEditStockHistory:r,onDeleteStockHistory:l,products:i})=>{let n,{hasPermission:c}=(0,O.useProfiles)(),[d,o]=(0,s.useState)({open:!1,entry:null}),[x,h]=(0,s.useState)({open:!1,entry:null}),[p,j]=(0,s.useState)(null),[f,N]=(0,s.useState)(null),v=t=>{if(0===e.length)return!1;let s=[...e].sort((e,t)=>e.createdAt.getTime()-t.createdAt.getTime());return s[0]?.id===t.id},w=(0,s.useMemo)(()=>{let t={},s=[];return e.forEach(e=>{if(["Sale","Delete sale","Deleted Sale","Sale qty edit"].some(t=>e.changeReason.toLowerCase().includes(t.toLowerCase()))){let s=e.receiptNumber||e.referenceId||e.id;t[s]||(t[s]=[]),t[s].push(e)}else s.push(e)}),[...Object.values(t).map(e=>{let t=[...e].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime());return{type:"sale",main:t[0],all:t,sortDate:t[0].createdAt}}),...s.map(e=>({type:"single",entry:e,sortDate:e.createdAt}))].sort((e,t)=>{let s=new Date(e.sortDate).getTime();return new Date(t.sortDate).getTime()-s})},[e]),k=a?(0,t.jsxs)("div",{className:"animate-pulse text-center py-8",children:[(0,t.jsx)("div",{className:"w-16 h-16 bg-gray-200 rounded-full mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-500",children:"Loading stock history..."})]}):0===e.length?(0,t.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,t.jsx)(U.History,{size:48,className:"mx-auto mb-4 opacity-50"}),(0,t.jsx)("p",{children:"No stock history available for this product"}),(0,t.jsx)("p",{className:"text-sm mt-2",children:"Stock changes will appear here once you make adjustments"})]}):(0,t.jsx)("div",{className:"space-y-3",children:w.map(e=>{if("sale"===e.type){let{main:s,all:a}=e,r=s.receiptNumber||s.referenceId||s.id,l=p===r,i=a[0],n=a[a.length-1],c=a.length>1;return(0,t.jsxs)("div",{className:`border rounded-lg p-4 transition-colors ${s.newQuantity>s.oldQuantity?"bg-green-50 border-green-200 hover:bg-green-100":s.newQuantity<s.oldQuantity?"bg-red-50 border-red-200 hover:bg-red-100":"border-gray-200 hover:bg-gray-50"}`,children:[(0,t.jsxs)("div",{className:"flex justify-between items-start",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,t.jsxs)(g.Badge,{variant:"outline",className:"text-xs",children:["Sale - ",s.receiptNumber||s.referenceId||s.id]}),c&&(0,t.jsx)(g.Badge,{variant:"secondary",className:"text-[10px] h-5",children:"Edited"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[c?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(g.Badge,{variant:"outline",className:"text-xs bg-muted/50 font-normal",children:["Original: ",n.oldQuantity," → ",n.newQuantity," (",n.newQuantity-n.oldQuantity>0?"+":"",n.newQuantity-n.oldQuantity,")"]}),(0,t.jsx)("span",{className:"text-muted-foreground",children:"→"}),(0,t.jsxs)(g.Badge,{variant:"secondary",className:"text-xs font-normal",children:["Current: ",i.oldQuantity," → ",i.newQuantity," (",i.newQuantity-i.oldQuantity>0?"+":"",i.newQuantity-i.oldQuantity,")"]})]}):(0,t.jsxs)(g.Badge,{variant:"outline",className:"text-xs bg-muted/50 font-normal",children:["Qty: ",s.oldQuantity," → ",s.newQuantity," (",s.newQuantity-s.oldQuantity>0?"+":"",s.newQuantity-s.oldQuantity,")"]}),!c&&(0,t.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-1 ml-2",children:[(0,t.jsx)(R.Clock,{className:"inline-block w-3 h-3"}),(0,$.format)(s.createdAt,"MMM d, yyyy h:mm a")]}),c&&(0,t.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-1 ml-2",children:[(0,t.jsx)(R.Clock,{className:"inline-block w-3 h-3"}),(0,$.format)(i.createdAt,"MMM d, yyyy h:mm a")]})]})]}),(0,t.jsx)("div",{className:"flex items-center gap-3",children:(0,t.jsx)(u.Button,{variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>j(l?null:r),children:l?"Hide Details":"View Details"})})]}),l&&(0,t.jsxs)("div",{className:"mt-4 border-t pt-3",children:[(0,t.jsx)("div",{className:"font-semibold mb-2 text-sm text-muted-foreground",children:"Sale Actions"}),(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"min-w-full text-xs border",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{className:"bg-muted/50",children:[(0,t.jsx)("th",{className:"px-2 py-1 text-left",children:"Action"}),(0,t.jsx)("th",{className:"px-2 py-1 text-left",children:"Date"}),(0,t.jsx)("th",{className:"px-2 py-1 text-left",children:"Qty Change"})]})}),(0,t.jsx)("tbody",{children:a.map(e=>(0,t.jsxs)("tr",{className:"border-b last:border-b-0",children:[(0,t.jsx)("td",{className:"px-2 py-1 font-medium",children:e.changeReason.replace("Deleted sale","Deleted Sale")}),(0,t.jsx)("td",{className:"px-2 py-1 text-muted-foreground",children:(0,$.format)(e.createdAt,"MMM d, yyyy h:mm a")}),(0,t.jsxs)("td",{className:"px-2 py-1",children:[e.oldQuantity," → ",e.newQuantity," (",e.newQuantity-e.oldQuantity>0?"+":"",e.newQuantity-e.oldQuantity,")"]})]},e.id))})]})})]})]},s.id)}{let{entry:s}=e,a=f===s.id;return(0,t.jsxs)("div",{className:`border rounded-lg p-4 transition-colors ${s.newQuantity>s.oldQuantity?"bg-green-50 border-green-200 hover:bg-green-100":s.newQuantity<s.oldQuantity?"bg-red-50 border-red-200 hover:bg-red-100":"border-gray-200 hover:bg-gray-50"}`,children:[(0,t.jsxs)("div",{className:"flex justify-between items-start",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("div",{className:"flex items-center gap-2 mb-2",children:(0,t.jsxs)(g.Badge,{variant:"outline",className:"text-xs",children:[s.changeReason.replace("Deleted sale","Deleted Sale"),s.receiptNumber&&` - #${s.receiptNumber}`]})}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[(0,t.jsxs)(g.Badge,{variant:"outline",className:"text-xs bg-muted/50 font-normal",children:["Qty: ",s.oldQuantity," → ",s.newQuantity," (",s.newQuantity-s.oldQuantity>0?"+":"",s.newQuantity-s.oldQuantity,")"]}),(0,t.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-1 ml-2",children:[(0,t.jsx)(R.Clock,{className:"inline-block w-3 h-3"}),(0,$.format)(s.createdAt,"MMM d, yyyy h:mm a")]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(u.Button,{variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>N(a?null:s.id),children:a?"Hide Details":"View Details"}),v(s)?(0,t.jsxs)(t.Fragment,{children:[c("inventory","edit")&&(0,t.jsx)(u.Button,{variant:"outline",size:"sm",onClick:()=>o({open:!0,entry:s}),className:"h-8 px-2",children:(0,t.jsx)(y.Edit,{className:"h-3 w-3"})}),(0,t.jsx)("div",{className:"text-xs text-muted-foreground px-2 py-1 bg-blue-100 text-blue-800 rounded",children:"Initial Stock"})]}):(0,t.jsxs)(t.Fragment,{children:[c("inventory","edit")&&(0,t.jsx)(u.Button,{variant:"outline",size:"sm",onClick:()=>o({open:!0,entry:s}),className:"h-8 px-2",children:(0,t.jsx)(y.Edit,{className:"h-3 w-3"})}),c("inventory","delete")&&(0,t.jsx)(u.Button,{variant:"outline",size:"sm",onClick:()=>h({open:!0,entry:s}),className:"h-8 px-2 text-destructive hover:text-destructive",children:(0,t.jsx)(b.Trash2,{className:"h-3 w-3"})})]})]})]}),a&&(0,t.jsxs)("div",{className:"mt-4 border-t pt-3",children:[(0,t.jsx)("div",{className:"font-semibold mb-2 text-sm text-muted-foreground",children:"Details"}),(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"min-w-full text-xs border",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{className:"bg-muted/50",children:[(0,t.jsx)("th",{className:"px-2 py-1 text-left",children:"Reason"}),(0,t.jsx)("th",{className:"px-2 py-1 text-left",children:"Date"}),(0,t.jsx)("th",{className:"px-2 py-1 text-left",children:"Qty Change"})]})}),(0,t.jsx)("tbody",{children:(0,t.jsxs)("tr",{className:"border-b last:border-b-0",children:[(0,t.jsx)("td",{className:"px-2 py-1 font-medium",children:s.changeReason.replace("Deleted sale","Deleted Sale")}),(0,t.jsx)("td",{className:"px-2 py-1 text-muted-foreground",children:(0,$.format)(s.createdAt,"MMM d, yyyy h:mm a")}),(0,t.jsxs)("td",{className:"px-2 py-1",children:[s.oldQuantity," → ",s.newQuantity," (",s.newQuantity-s.oldQuantity>0?"+":"",s.newQuantity-s.oldQuantity,")"]})]})})]})})]})]},s.id)}})});return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(m.Card,{children:[(0,t.jsx)(m.CardHeader,{children:(0,t.jsx)("div",{className:"flex items-center justify-between",children:(0,t.jsxs)(m.CardTitle,{className:"flex items-center gap-2",children:[(0,t.jsx)(U.History,{className:"h-5 w-5"}),"Stock History",e.length>0&&(0,t.jsxs)(g.Badge,{variant:"secondary",className:"ml-2",children:[e.length," entries"]})]})})}),(0,t.jsx)(m.CardContent,{children:k})]}),(0,t.jsx)(_.default,{open:d.open,onOpenChange:e=>o({open:e,entry:null}),entry:d.entry,onConfirm:r,isInitialStock:!!d.entry&&v(d.entry),stockHistory:e,productCreatedAt:d.entry&&(n=i.find(e=>e.id===d.entry?.productId))?new Date(n.createdAt):void 0}),(0,t.jsx)(V.default,{open:x.open,onOpenChange:e=>h({open:e,entry:null}),entry:x.entry,onConfirm:l})]})};e.s(["default",0,()=>{let{id:e}=(0,a.useParams)(),d=(0,a.useNavigate)(),{user:o}=(0,r.useAuth)(),{products:m,isLoading:u,loadProducts:x,refetch:h}=(0,l.useProducts)(o?.id,1e4),[g,y]=(0,s.useState)(null),{stockHistory:p,isLoading:j,loadStockHistory:f,updateStockHistoryEntry:b,deleteStockHistoryEntry:N,recalculateProductStock:v}=(0,i.useStockHistory)(o?.id,e),{clearAllLocationCaches:w}=(0,n.useStockSummaryData)({from:void 0,to:void 0}),[k,C]=(0,s.useState)(!1),[S,D]=(0,s.useState)(0),P=async()=>{if(e){C(!0);let{data:t}=await h(),s=(t?.products||[]).find(t=>t.id===e);s?y(s):(c.toast.error("Product not found"),d("/inventory")),C(!1)}},A=async()=>{await P(),e&&f&&await f(),D(e=>e+1)},Q=async(e,t,s,a)=>{let r=await b(e,t,s,a);return r&&(w(),await Promise.all([f(),P()])),r},B=async e=>{let t=await N(e);return t&&(w(),await Promise.all([v(g.id),f(),P()])),t};return((0,s.useEffect)(()=>{if(!u&&m.length>0&&e){let t=m.find(t=>t.id===e);t?y(t):(c.toast.error("Product not found"),d("/inventory"))}},[e,m,u,d]),(0,s.useEffect)(()=>{let e=()=>{console.log("Stock updated, refreshing product data"),A()};return window.addEventListener("stock-updated",e),()=>{window.removeEventListener("stock-updated",e)}},[A]),u||k||!g)?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[60vh] space-y-4",children:[(0,t.jsx)("img",{src:"/lovable-uploads/7f7549a3-e9df-4762-b8b9-8e041e34f55d.png",alt:"Loading",className:"w-16 h-16 animate-spin"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Loading product data..."})]}):(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)(q,{product:g,stockHistory:p,isLoadingHistory:j,onStockUpdate:A},`details-${S}`),(0,t.jsx)(W,{stockHistory:p,isLoadingHistory:j,onEditStockHistory:Q,onDeleteStockHistory:B,products:m},`history-${S}`)]})}],983766)},236307,(e,t,s)=>{let a="/ProductDetail";(window.__NEXT_P=window.__NEXT_P||[]).push([a,()=>e.r(983766)]),t.hot&&t.hot.dispose(function(){window.__NEXT_P.push([a])})}]);