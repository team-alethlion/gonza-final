(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,25652,e=>{"use strict";let s=(0,e.i(475254).default)("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);e.s(["TrendingUp",()=>s],25652)},269638,e=>{"use strict";let s=(0,e.i(475254).default)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);e.s(["CheckCircle",()=>s],269638)},555781,(e,s,t)=>{let a=Error("Could not parse module '[project]/src/app/actions/products.ts'\n\n'import', and 'export' cannot be used outside of module code");throw a.code="MODULE_UNPARSABLE",a},160615,e=>{"use strict";var s=e.i(271645),t=e.i(266027),a=e.i(908406),r=e.i(422713),i=e.i(95187);let n=(0,i.createServerReference)("40290a4fc6b8571a026afeb877566edb807919e482",i.callServer,void 0,i.findSourceMapURL,"getBusinessSettingsAction");var l=e.i(709239);let c=()=>({businessName:"",businessAddress:"",businessPhone:"",businessEmail:"",currency:"UGX",paymentInfo:"",defaultPrintFormat:"standard"});e.s(["convertPaymentMethodsToString",0,e=>e.filter(e=>""!==e.method.trim()||""!==e.accountNumber.trim()||""!==e.accountName.trim()).map(e=>`${e.method}
${e.accountNumber}
${e.accountName}`).join("\n"),"parsePaymentInfo",0,e=>{if(!e||""===e.trim())return[];let s=e.split("\n").filter(e=>""!==e.trim()),t=[];for(let e=0;e<s.length;e+=3)e+2<s.length&&t.push({method:s[e].trim(),accountNumber:s[e+1].trim(),accountName:s[e+2].trim()});return t},"useBusinessSettings",0,()=>{let[e,i]=(0,s.useState)(c()),[d,o]=(0,s.useState)(!1),{toast:u}=(0,a.useToast)(),{currentBusiness:m}=(0,r.useBusiness)(),x=async()=>{if(!m)return c();try{let e=await n(m.id);if(!e)return c();{let s=e.metadata&&"object"==typeof e.metadata&&e.metadata.payment_info||"";return{id:e.id,businessName:e.business_name||"",businessAddress:e.business_address||"",businessPhone:e.business_phone||"",businessEmail:e.business_email||"",businessLogo:e.business_logo||void 0,currency:e.currency||"UGX",signature:e.signature||void 0,paymentInfo:s,defaultPrintFormat:e.metadata&&"object"==typeof e.metadata&&e.metadata.default_print_format||"standard",defaultPrinterName:e.metadata&&"object"==typeof e.metadata&&e.metadata.default_printer_name||"",defaultPrinterType:e.metadata&&"object"==typeof e.metadata&&e.metadata.default_printer_type||"USB",printerPaperSize:e.metadata&&"object"==typeof e.metadata&&e.metadata.printer_paper_size||"58mm"}}}catch(e){return console.error("Error loading business settings:",e),u({title:"Error",description:"Failed to load business settings. Please try again.",variant:"destructive"}),c()}},h=async s=>{if(!m)return console.error("No business selected for updating settings"),u({title:"Error",description:"No business selected",variant:"destructive"}),!1;try{let t={payment_info:s.hasOwnProperty("paymentInfo")?s.paymentInfo:e.paymentInfo||"",default_print_format:s.hasOwnProperty("defaultPrintFormat")?s.defaultPrintFormat:e.defaultPrintFormat||"standard",default_printer_name:s.hasOwnProperty("defaultPrinterName")?s.defaultPrinterName:e.defaultPrinterName||"",default_printer_type:s.hasOwnProperty("defaultPrinterType")?s.defaultPrinterType:e.defaultPrinterType||"USB",printer_paper_size:s.hasOwnProperty("printerPaperSize")?s.printerPaperSize:e.printerPaperSize||"58mm"},a={business_name:s.hasOwnProperty("businessName")?s.businessName:e.businessName,business_address:s.hasOwnProperty("businessAddress")?s.businessAddress:e.businessAddress,business_phone:s.hasOwnProperty("businessPhone")?s.businessPhone:e.businessPhone,business_email:s.hasOwnProperty("businessEmail")?s.businessEmail:e.businessEmail,business_logo:s.hasOwnProperty("businessLogo")?s.businessLogo:e.businessLogo,currency:s.hasOwnProperty("currency")?s.currency:e.currency,signature:s.hasOwnProperty("signature")?s.signature:e.signature,metadata:t},r=await (0,l.upsertBusinessSettingsAction)(m.id,"00000000-0000-0000-0000-000000000000",a);if(!r.success)throw console.error("Supabase error updating business settings:",r.error),Error(r.error);return u({title:"Success",description:"Business settings updated successfully"}),g(),!0}catch(e){return console.error("Error updating business settings:",e),u({title:"Error",description:"Failed to update business settings. Please try again.",variant:"destructive"}),!1}},{data:p,isLoading:j,isFetching:f,refetch:g}=(0,t.useQuery)({queryKey:["businessSettings",m?.id],queryFn:x,enabled:!!m?.id,staleTime:3e5,gcTime:18e5,refetchOnWindowFocus:!1,refetchOnReconnect:!1});return(0,s.useEffect)(()=>{p?i(p):m||i(c())},[p,m]),(0,s.useEffect)(()=>{o(j||f)},[j,f]),{settings:e,isLoading:d,updateSettings:h,loadSettings:x}}],160615)},63209,e=>{"use strict";let s=(0,e.i(475254).default)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);e.s(["AlertCircle",()=>s],63209)},487486,e=>{"use strict";var s=e.i(843476),t=e.i(225913),a=e.i(975157);let r=(0,t.cva)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground",warning:"border-transparent bg-amber-500 text-white hover:bg-amber-600",success:"border-transparent bg-green-600 text-white hover:bg-green-700"}},defaultVariants:{variant:"default"}});function i({className:e,variant:t,...i}){return(0,s.jsx)("div",{className:(0,a.cn)(r({variant:t}),e),...i})}e.s(["Badge",()=>i])},392401,e=>{"use strict";var s=e.i(777624);e.s(["useFinancialVisibility",0,()=>{let{hasPermission:e}=(0,s.useProfiles)(),t=e("inventory","view_cost_price"),a=e("inventory","view_profit"),r=e("inventory","view_selling_price"),i=e("dashboard","view_total_sales"),n=e("dashboard","view_gross_profit"),l=e("dashboard","view_total_expenses"),c=e("dashboard","view_inventory_value"),d=e("dashboard","view_sales_types"),o=e("dashboard","view_avg_price"),u=e("dashboard","view_total_amount"),m=e("finance","manage_accounts"),x=e("finance","view"),h=e("expenses","view"),p=e("expenses","create"),j=e("expenses","edit");return{canViewCostPrice:t,canViewProfit:a,canViewSellingPrice:r,canViewTotalSales:i,canViewTotalGrossProfit:n,canViewTotalExpenses:l,canViewInventoryValue:c,canViewSalesTypes:d,canViewAvgPrice:o,canViewTotalAmount:u,canManageFinanceAccounts:m,canViewFinance:x,canViewExpenses:h,canCreateExpenses:p,canEditExpenses:j,canDeleteExpenses:e("expenses","delete"),formatFinancial:(e,s)=>"cost"===s&&t||"selling"===s&&r||"profit"===s&&a?e?.toLocaleString()||"0":"•••"}}])},634076,e=>{"use strict";var s=e.i(95187);let t=(0,s.createServerReference)("406e0d925bc965618c40bddb0b2011bea951e9b025",s.callServer,void 0,s.findSourceMapURL,"getStockRepairsPreviewAction");e.s(["getStockRepairsPreviewAction",()=>t])},752304,e=>{"use strict";var s=e.i(95187);let t=(0,s.createServerReference)("60a33152b65e6ef5593ff2b5c1d0a77d09216fe7e5",s.callServer,void 0,s.findSourceMapURL,"repairStockChainsAction");e.s(["repairStockChainsAction",()=>t])},654550,e=>{"use strict";var s=e.i(95187);let t=(0,s.createServerReference)("40193ce83d40b7dbf7c2991866f6d090da71bf2f59",s.callServer,void 0,s.findSourceMapURL,"createStockHistoryAction");e.s(["createStockHistoryAction",()=>t])},903711,e=>{"use strict";var s=e.i(95187);let t=(0,s.createServerReference)("605a5ac8c70aa01eb0dd29483cb3c24316ae309de0",s.callServer,void 0,s.findSourceMapURL,"getProductReconciliationAction");e.s(["getProductReconciliationAction",()=>t])},635408,e=>{"use strict";let s=(0,e.i(475254).default)("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]);e.s(["TrendingDown",()=>s],635408)},338374,e=>{"use strict";var s=e.i(843476),t=e.i(302747);e.s(["default",0,()=>(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"mb-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(t.Skeleton,{className:"h-8 w-48 mb-2"}),(0,s.jsx)(t.Skeleton,{className:"h-4 w-64"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(t.Skeleton,{className:"h-9 w-9"}),(0,s.jsx)(t.Skeleton,{className:"h-9 w-24"}),(0,s.jsx)(t.Skeleton,{className:"h-9 w-32"})]})]}),(0,s.jsx)("div",{className:"mb-4",children:(0,s.jsx)(t.Skeleton,{className:"h-10 w-full max-w-md"})}),(0,s.jsx)("div",{className:"mb-6",children:(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[void 0,void 0,void 0,void 0].map((e,a)=>(0,s.jsx)(t.Skeleton,{className:"h-24"},a))})}),(0,s.jsx)(t.Skeleton,{className:"h-64 mb-6"}),(0,s.jsx)(t.Skeleton,{className:"h-96"})]})])},987981,e=>{"use strict";var s=e.i(843476),t=e.i(271645),a=e.i(102594),r=e.i(422713),i=e.i(515288),n=e.i(793479),l=e.i(519455),c=e.i(776639),d=e.i(487486),o=e.i(759684),u=e.i(63209),m=e.i(269638),x=e.i(635408),h=e.i(25652),p=e.i(475254);let j=(0,p.default)("PackagePlus",[["path",{d:"M16 16h6",key:"100bgy"}],["path",{d:"M19 13v6",key:"85cyf1"}],["path",{d:"M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14",key:"e7tb2h"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["line",{x1:"12",x2:"12",y1:"22",y2:"12",key:"a4e8g8"}]]),f=(0,p.default)("PackageMinus",[["path",{d:"M16 16h6",key:"100bgy"}],["path",{d:"M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14",key:"e7tb2h"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["line",{x1:"12",x2:"12",y1:"22",y2:"12",key:"a4e8g8"}]]);var g=e.i(846696),b=e.i(160615),y=e.i(392401),N=e.i(903711),v=e.i(555781);let C=({product:e,onClose:n,onReconciled:p})=>{let{user:C}=(0,a.useAuth)(),{currentBusiness:w}=(0,r.useBusiness)(),{settings:k}=(0,b.useBusinessSettings)(),{canViewCostPrice:S,canViewSellingPrice:P,formatFinancial:A}=(0,y.useFinancialVisibility)(),[F,_]=(0,t.useState)(!1),[R,T]=(0,t.useState)(!1),[D,B]=(0,t.useState)(!0),[O,E]=(0,t.useState)({currentStock:0,openingStock:0,itemsSold:0,stockAdded:0,transferOut:0,returnIn:0,returnOut:0,adjustments:0,calculatedClosingStock:0,discrepancy:0,openingDate:null,excludedSalesQty:0,dailyBreakdown:[]}),[I,L]=(0,t.useState)(e.costPrice||0),[M,H]=(0,t.useState)(e.sellingPrice||0);(0,t.useEffect)(()=>{L(e.costPrice||0),H(e.sellingPrice||0)},[e.id,e.costPrice,e.sellingPrice]),(0,t.useEffect)(()=>{(async()=>{if(w?.id){B(!0);try{let s=await (0,N.getProductReconciliationAction)(w.id,e.id);s.success&&s.data?E(s.data):g.toast.error(s.error||"Failed to calculate reconciliation data")}catch(e){console.error("Error calculating reconciliation:",e),g.toast.error("An unexpected error occurred during reconciliation calculation")}finally{B(!1)}}})()},[w?.id,e.id]);let U=O.currentStock*(e.costPrice||0),$=O.currentStock*(e.sellingPrice||0),z=O.calculatedClosingStock*I,V=O.calculatedClosingStock*M,q=z-U,Q=V-$,K=Math.abs(O.discrepancy)>.01,G=async()=>{if(C?.id&&w?.id){_(!0);try{if(await (0,v.updateProductAction)(e.id,{userId:C.id,quantity:O.calculatedClosingStock,costPrice:I,sellingPrice:M,customChangeReason:"Stock Reconciliation"}))g.toast.success(`Stock reconciled successfully! Corrected ${Math.abs(O.discrepancy).toFixed(2)} units.`),p(),n();else throw Error("Update failed")}catch(e){console.error("Error reconciling stock:",e),g.toast.error("Failed to reconcile stock. Please try again.")}finally{_(!1)}}};return(0,s.jsx)(c.Dialog,{open:!0,onOpenChange:n,children:(0,s.jsxs)(c.DialogContent,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,s.jsxs)(c.DialogHeader,{children:[(0,s.jsxs)(c.DialogTitle,{className:"flex items-center gap-2",children:[K?(0,s.jsx)(u.AlertCircle,{className:"h-5 w-5 text-orange-500"}):(0,s.jsx)(m.CheckCircle,{className:"h-5 w-5 text-green-500"}),"Stock Reconciliation - ",e.name]}),(0,s.jsx)(c.DialogDescription,{children:"Review stock calculations and apply corrections if needed"})]}),D?(0,s.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,s.jsx)("div",{className:"text-muted-foreground",children:"Loading reconciliation data..."})}):(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{className:"pb-3",children:(0,s.jsx)(i.CardTitle,{className:"text-sm font-medium",children:"Current Stock"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsx)("div",{className:"text-2xl font-bold",children:O.currentStock.toFixed(2)})})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{className:"pb-3",children:(0,s.jsx)(i.CardTitle,{className:"text-sm font-medium",children:"Calculated Stock"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsx)("div",{className:"text-2xl font-bold",children:O.calculatedClosingStock.toFixed(2)})})]})]}),(0,s.jsxs)(i.Card,{className:"border-sales-primary/20 bg-sales-primary/5",children:[(0,s.jsx)(i.CardHeader,{className:"pb-3",children:(0,s.jsxs)(i.CardTitle,{className:"text-base flex items-center gap-2",children:[(0,s.jsx)(h.TrendingUp,{className:"h-4 w-4 text-sales-primary"}),"Valuation & Price Adjustment"]})}),(0,s.jsxs)(i.CardContent,{children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-6",children:[S&&(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Adjustment Cost Price"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-sm",children:k.currency}),(0,s.jsx)("input",{type:"number",value:I,onChange:e=>L(Number(e.target.value)),className:"w-full pl-12 pr-4 py-2 bg-white border rounded-md text-sm focus:ring-2 focus:ring-sales-primary/20 outline-none transition-all"})]}),(0,s.jsx)("p",{className:"text-[10px] text-muted-foreground",children:"Affects Cost Value"})]}),P&&(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Adjustment Selling Price"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-sm",children:k.currency}),(0,s.jsx)("input",{type:"number",value:M,onChange:e=>H(Number(e.target.value)),className:"w-full pl-12 pr-4 py-2 bg-white border rounded-md text-sm focus:ring-2 focus:ring-sales-primary/20 outline-none transition-all"})]}),(0,s.jsx)("p",{className:"text-[10px] text-muted-foreground",children:"Affects Stock Value"})]})]}),(0,s.jsxs)("div",{className:"mt-4 pt-4 border-t border-sales-primary/10 grid grid-cols-2 gap-4",children:[S&&(0,s.jsxs)("div",{className:"p-3 rounded-lg bg-white border shadow-sm",children:[(0,s.jsx)("p",{className:"text-[10px] font-bold text-muted-foreground uppercase mb-1",children:"Cost Valuation Impact"}),(0,s.jsx)("div",{className:"flex items-end justify-between",children:(0,s.jsxs)("span",{className:`text-base font-bold ${q>=0?"text-emerald-600":"text-rose-600"}`,children:[q>=0?"+":"",A(q,"cost")]})})]}),P&&(0,s.jsxs)("div",{className:"p-3 rounded-lg bg-white border shadow-sm",children:[(0,s.jsx)("p",{className:"text-[10px] font-bold text-muted-foreground uppercase mb-1",children:"Stock Valuation Impact"}),(0,s.jsx)("div",{className:"flex items-end justify-between",children:(0,s.jsxs)("span",{className:`text-base font-bold ${Q>=0?"text-violet-600":"text-rose-600"}`,children:[Q>=0?"+":"",A(Q,"selling")]})})]})]})]})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{children:(0,s.jsx)(i.CardTitle,{className:"text-base",children:"Stock Calculation Summary"})}),(0,s.jsxs)(i.CardContent,{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("span",{className:"text-sm text-muted-foreground",children:"Opening Stock"}),(0,s.jsx)("span",{className:"font-medium",children:O.openingStock.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center text-red-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(x.TrendingDown,{className:"h-4 w-4"}),"Items Sold"]}),(0,s.jsxs)("span",{className:"font-medium",children:["- ",O.itemsSold.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center text-emerald-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(j,{className:"h-4 w-4"}),"Stock Added"]}),(0,s.jsxs)("span",{className:"font-medium",children:["+ ",O.stockAdded.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center text-orange-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(f,{className:"h-4 w-4"}),"Transfer Out"]}),(0,s.jsxs)("span",{className:"font-medium",children:["- ",O.transferOut.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center text-blue-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(j,{className:"h-4 w-4"}),"Return In"]}),(0,s.jsxs)("span",{className:"font-medium",children:["+ ",O.returnIn.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center text-purple-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(f,{className:"h-4 w-4"}),"Return Out"]}),(0,s.jsxs)("span",{className:"font-medium",children:["- ",O.returnOut.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center text-amber-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(u.AlertCircle,{className:"h-4 w-4"}),"Manual Adjustments"]}),(0,s.jsxs)("span",{className:"font-medium",children:[O.adjustments>0?"+":"",O.adjustments.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"border-t pt-3 flex justify-between items-center font-semibold text-lg",children:[(0,s.jsx)("span",{children:"Calculated Closing Stock"}),(0,s.jsx)("span",{children:O.calculatedClosingStock.toFixed(2)})]}),K&&(0,s.jsxs)("div",{className:`border-t pt-3 flex justify-between items-center ${O.discrepancy>0?"text-green-600":"text-red-600"}`,children:[(0,s.jsx)("span",{className:"font-semibold",children:"Actual vs Calculated Discrepancy"}),(0,s.jsxs)(d.Badge,{variant:O.discrepancy>0?"default":"destructive",children:[O.discrepancy>0?"+":"",O.discrepancy.toFixed(2)," units"]})]})]})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{children:(0,s.jsx)(i.CardTitle,{className:"text-base",children:"Daily Breakdown"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsx)(o.ScrollArea,{className:"h-[300px] pr-4",children:(0,s.jsx)("div",{className:"space-y-3",children:0===O.dailyBreakdown.length?(0,s.jsx)("div",{className:"text-center text-muted-foreground py-8",children:"No transactions found for this product"}):O.dailyBreakdown.map((e,t)=>(0,s.jsxs)(i.Card,{className:"p-3 bg-slate-50",children:[(0,s.jsx)("div",{className:"font-semibold text-sm mb-2 text-slate-700",children:new Date(e.date).toLocaleDateString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric"})}),(0,s.jsxs)("div",{className:"space-y-1.5 text-xs",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"Starting Stock:"}),(0,s.jsx)("span",{className:"font-medium",children:e.startingStock.toFixed(2)})]}),e.itemsSold>0&&(0,s.jsxs)("div",{className:"flex justify-between text-red-600",children:[(0,s.jsx)("span",{children:"Items Sold:"}),(0,s.jsxs)("span",{className:"font-medium",children:["-",e.itemsSold.toFixed(2)]})]}),e.stockAdded>0&&(0,s.jsxs)("div",{className:"flex justify-between text-emerald-600",children:[(0,s.jsx)("span",{children:"Stock Added:"}),(0,s.jsxs)("span",{className:"font-medium",children:["+",e.stockAdded.toFixed(2)]})]}),e.transferOut>0&&(0,s.jsxs)("div",{className:"flex justify-between text-orange-600",children:[(0,s.jsx)("span",{children:"Transfer Out:"}),(0,s.jsxs)("span",{className:"font-medium",children:["-",e.transferOut.toFixed(2)]})]}),e.returnIn>0&&(0,s.jsxs)("div",{className:"flex justify-between text-blue-600",children:[(0,s.jsx)("span",{children:"Return In:"}),(0,s.jsxs)("span",{className:"font-medium",children:["+",e.returnIn.toFixed(2)]})]}),e.returnOut>0&&(0,s.jsxs)("div",{className:"flex justify-between text-purple-600",children:[(0,s.jsx)("span",{children:"Return Out:"}),(0,s.jsxs)("span",{className:"font-medium",children:["-",e.returnOut.toFixed(2)]})]}),0!==e.adjustments&&(0,s.jsxs)("div",{className:"flex justify-between text-amber-600",children:[(0,s.jsx)("span",{children:"Adjustments:"}),(0,s.jsxs)("span",{className:"font-medium",children:[e.adjustments>0?"+":"",e.adjustments.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between pt-1.5 border-t border-slate-200",children:[(0,s.jsx)("span",{className:"font-semibold text-slate-700",children:"Ending Stock:"}),(0,s.jsx)("span",{className:"font-bold text-slate-900",children:e.endingStock.toFixed(2)})]})]})]},t))})})})]}),K&&R&&(0,s.jsxs)(i.Card,{className:"bg-blue-50 border-blue-200",children:[(0,s.jsx)(i.CardHeader,{children:(0,s.jsx)(i.CardTitle,{className:"text-base text-blue-900",children:"Preview Correction"})}),(0,s.jsxs)(i.CardContent,{className:"space-y-2",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-sm text-blue-800",children:"Current (Recorded):"}),(0,s.jsxs)("span",{className:"font-medium text-blue-900",children:[O.currentStock.toFixed(2)," units"]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-sm text-blue-800",children:"Calculated (History):"}),(0,s.jsxs)("span",{className:"font-medium text-blue-900",children:[O.calculatedClosingStock.toFixed(2)," units"]})]}),(0,s.jsxs)("div",{className:"flex justify-between pt-2 border-t border-blue-200",children:[(0,s.jsx)("span",{className:"text-sm font-semibold text-blue-800",children:"Correction Amount:"}),(0,s.jsxs)("span",{className:"font-semibold text-blue-900",children:[O.discrepancy>0?"+":"",Math.abs(O.discrepancy).toFixed(2)," units"]})]})]})]}),!K&&(0,s.jsxs)("div",{className:"flex items-center gap-2 p-4 bg-green-50 border border-green-200 rounded-lg",children:[(0,s.jsx)(m.CheckCircle,{className:"h-5 w-5 text-green-600"}),(0,s.jsx)("p",{className:"text-sm text-green-800",children:"Stock levels are accurate based on transaction history."})]})]}),(0,s.jsxs)(c.DialogFooter,{children:[(0,s.jsx)(l.Button,{variant:"outline",onClick:n,children:"Cancel"}),K&&(0,s.jsx)(s.Fragment,{children:R?(0,s.jsx)(l.Button,{onClick:G,disabled:F,className:"bg-blue-600 hover:bg-blue-700",children:F?"Applying...":"Apply Correction"}):(0,s.jsx)(l.Button,{onClick:()=>T(!0),children:"Preview Correction"})})]})]})})};var w=e.i(338374),k=e.i(266027);let S=(0,p.default)("Wrench",[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]]);var P=e.i(777624),A=e.i(929592),F=e.i(904792),_=e.i(634076),R=e.i(752304),T=e.i(654550);e.s(["default",0,()=>{let{user:e}=(0,a.useAuth)(),m=(0,F.useNavigate)(),{currentBusiness:h,isLoading:p}=(0,r.useBusiness)(),{hasPermission:f,isLoading:b}=(0,P.useProfiles)(),[y,D]=(0,t.useState)(""),[B,O]=t.default.useState(null),[E,I]=(0,t.useState)(!1),[L,M]=(0,t.useState)(!1),[H,U]=(0,t.useState)(!1),[$,z]=(0,t.useState)([]),[V,q]=(0,t.useState)(null),[Q,K]=(0,t.useState)(!1),[G,W]=(0,t.useState)([]),[X,Y]=(0,t.useState)(!1),[J,Z]=(0,t.useState)(!1),{data:ee=[],isLoading:es}=(0,k.useQuery)({queryKey:["all-products-reconciliation",e?.id,h?.id],queryFn:async()=>e?.id&&h?.id?await (0,v.getAllProductsAction)(e.id,h.id):[],enabled:!!e?.id&&!!h?.id,staleTime:12e4}),et=(0,t.useMemo)(()=>{if(!y.trim())return[];let e=y.toLowerCase();return ee.filter(s=>s.name.toLowerCase().includes(e)||s.itemNumber?.toLowerCase().includes(e)||s.category?.toLowerCase().includes(e)||s.supplier?.toLowerCase().includes(e)||s.description?.toLowerCase().includes(e))},[ee,y]),ea=async()=>{if(h?.id){K(!0);try{let e=await (0,R.repairStockChainsAction)(h.id);if(e.success&&e.data){let{repaired:s,failed:t}=e.data;0===t?g.toast.success(`Stock chains repaired successfully for ${s} product(s).`):g.toast.warning(`Repaired ${s} product(s). ${t} failed.`)}}catch(e){console.error("Error repairing stock chains:",e),g.toast.error("Failed to repair stock chains.")}finally{K(!1),Y(!1)}}},er=async()=>{if(h?.id){Z(!0);try{let e=await (0,_.getStockRepairsPreviewAction)(h.id);e.success&&e.data&&(W(e.data),0===e.data.length?g.toast.success("No broken stock chains found!"):Y(!0))}catch(e){console.error("Error previewing stock repairs:",e),g.toast.error("Failed to preview stock repairs.")}finally{Z(!1)}}},ei=async()=>{if(!h?.id)return;M(!0);let e=[];try{for(let s of ee){let t=await (0,N.getProductReconciliationAction)(h.id,s.id);t.success&&t.data&&Math.abs(t.data.discrepancy)>.01&&e.push(t.data)}z(e),U(!0)}catch(e){console.error("Error calculating preview:",e),g.toast.error("Failed to calculate reconciliation preview.")}finally{M(!1)}},en=async()=>{if(e?.id&&h?.id&&0!==$.length){I(!0);try{let s=0,t=0;for(let a of $)try{let t=await (0,T.createStockHistoryAction)({userId:e.id,locationId:h.id,productId:a.product.id,previousQuantity:a.currentStock,newQuantity:a.calculatedStock,changeReason:"Bulk Stock Reconciliation",createdAt:new Date().toISOString()});if(t.success)s++;else throw Error(t.error)}catch(e){t++,console.error(`Failed to reconcile ${a.product.name}:`,e)}g.toast.success(`Bulk reconciliation complete! Updated ${s} product(s).`),t>0&&g.toast.error(`${t} product(s) failed.`),U(!1),z([])}catch(e){console.error("Bulk reconciliation error:",e),g.toast.error("Failed to complete bulk reconciliation.")}finally{I(!1)}}};return p||b||!h?(0,s.jsx)(w.default,{}):f("inventory","stock_adjustment")?(0,s.jsxs)("div",{className:"p-2 md:p-6 space-y-4 md:space-y-6 max-w-full",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)("h1",{className:"text-xl md:text-2xl lg:text-3xl font-bold text-sales-dark",children:"Stock Reconciliation"}),(0,s.jsx)("p",{className:"text-sm md:text-base text-muted-foreground",children:"Select a product, preview the correction, then apply."})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)(l.Button,{onClick:er,disabled:Q||J||es||0===ee.length,variant:"outline",size:"lg",children:[(0,s.jsx)(u.AlertCircle,{className:"h-4 w-4 mr-2"}),J?"Scanning...":"Preview Repairs"]}),(0,s.jsxs)(l.Button,{onClick:ea,disabled:Q||J||es||0===ee.length,variant:"secondary",size:"lg",children:[(0,s.jsx)(S,{className:"h-4 w-4 mr-2"}),Q?"Repairing...":"Quick Repair All"]}),(0,s.jsx)(l.Button,{onClick:ei,disabled:L||es||0===ee.length,size:"lg",children:L?"Calculating...":"Reconcile All Products"})]})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{children:(0,s.jsx)(i.CardTitle,{className:"text-base",children:"Search Product"})}),(0,s.jsxs)(i.CardContent,{className:"space-y-3",children:[(0,s.jsx)(n.Input,{placeholder:"Search by name, item number, category, or supplier",value:y,onChange:e=>D(e.target.value)}),y&&(0,s.jsx)("div",{className:"border rounded-md",children:(0,s.jsx)(o.ScrollArea,{className:"max-h-96",children:(0,s.jsxs)("ul",{className:"divide-y",children:[es&&(0,s.jsx)("li",{className:"p-3 text-sm text-muted-foreground",children:"Loading products..."}),!es&&0===et.length&&(0,s.jsx)("li",{className:"p-3 text-sm text-muted-foreground",children:"No matching products found"}),(!es&&et).map(e=>(0,s.jsxs)("li",{className:"p-3 hover:bg-muted/40 cursor-pointer",onClick:()=>O(e),children:[(0,s.jsx)("div",{className:"font-medium",children:e.name}),(0,s.jsxs)("div",{className:"text-xs text-muted-foreground",children:[e.itemNumber?`Item: ${e.itemNumber}`:"—"," • Qty: ",e.quantity," • Cat: ",e.category||"—"]})]},e.id))]})})})]})]}),B&&(0,s.jsx)(C,{product:B,onClose:()=>O(null),onReconciled:()=>O(null)}),(0,s.jsx)(c.Dialog,{open:H,onOpenChange:U,children:(0,s.jsxs)(c.DialogContent,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[(0,s.jsxs)(c.DialogHeader,{children:[(0,s.jsxs)(c.DialogTitle,{className:"flex items-center gap-2",children:[(0,s.jsx)(u.AlertCircle,{className:"h-5 w-5 text-orange-500"}),"Bulk Reconciliation Preview"]}),(0,s.jsxs)(c.DialogDescription,{children:[$.length," product(s) with discrepancies found."]})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{className:"pb-3",children:(0,s.jsx)(i.CardTitle,{className:"text-sm",children:"Products to Update"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsx)("div",{className:"text-2xl font-bold",children:$.length})})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{className:"pb-3",children:(0,s.jsx)(i.CardTitle,{className:"text-sm",children:"Total Adjustment"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsxs)("div",{className:"text-2xl font-bold",children:[$.reduce((e,s)=>e+Math.abs(s.discrepancy),0).toFixed(2)," units"]})})]})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{children:(0,s.jsx)(i.CardTitle,{className:"text-base",children:"Products with Discrepancies"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsx)(o.ScrollArea,{className:"h-[400px]",children:(0,s.jsx)("div",{className:"space-y-2",children:$.map(e=>(0,s.jsx)(i.Card,{className:"p-3 cursor-pointer hover:bg-muted/50",onClick:()=>q(e),children:(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("div",{className:"font-semibold",children:e.product.name}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.product.itemNumber&&`Item: ${e.product.itemNumber}`})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsxs)("div",{className:"text-sm",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"Current:"})," ",Number(e.currentStock).toFixed(2)]}),(0,s.jsxs)("div",{className:"text-sm",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"Calculated:"})," ",Number(e.calculatedStock).toFixed(2)]}),(0,s.jsxs)(d.Badge,{variant:e.discrepancy>0?"default":"destructive",className:"mt-1",children:[e.discrepancy>0?"+":"",e.discrepancy.toFixed(2)]})]})]})},e.product.id))})})})]})]}),(0,s.jsxs)(c.DialogFooter,{children:[(0,s.jsx)(l.Button,{variant:"outline",onClick:()=>U(!1),disabled:E,children:"Cancel"}),(0,s.jsx)(l.Button,{onClick:en,disabled:E,children:E?"Applying...":`Apply Reconciliation (${$.length} products)`})]})]})}),V&&(0,s.jsx)(c.Dialog,{open:!!V,onOpenChange:()=>q(null),children:(0,s.jsxs)(c.DialogContent,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[(0,s.jsxs)(c.DialogHeader,{children:[(0,s.jsx)(c.DialogTitle,{children:V.product.name}),(0,s.jsx)(c.DialogDescription,{children:"Detailed reconciliation breakdown"})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{className:"pb-3",children:(0,s.jsx)(i.CardTitle,{className:"text-sm",children:"Current Stock"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsx)("div",{className:"text-2xl font-bold",children:Number(V.currentStock).toFixed(2)})})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{className:"pb-3",children:(0,s.jsx)(i.CardTitle,{className:"text-sm",children:"Calculated Stock"})}),(0,s.jsx)(i.CardContent,{children:(0,s.jsx)("div",{className:"text-2xl font-bold",children:Number(V.calculatedStock).toFixed(2)})})]})]}),(0,s.jsxs)(i.Card,{children:[(0,s.jsx)(i.CardHeader,{children:(0,s.jsx)(i.CardTitle,{className:"text-base",children:"Stock Calculation"})}),(0,s.jsxs)(i.CardContent,{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-sm text-muted-foreground",children:"Opening Stock"}),(0,s.jsx)("span",{className:"font-medium",children:Number(V.openingStock).toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between text-red-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(x.TrendingDown,{className:"h-4 w-4"})," Items Sold"]}),(0,s.jsxs)("span",{className:"font-medium",children:["-",Number(V.itemsSold).toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between text-emerald-600",children:[(0,s.jsxs)("span",{className:"text-sm flex items-center gap-1",children:[(0,s.jsx)(j,{className:"h-4 w-4"})," Stock Added"]}),(0,s.jsxs)("span",{className:"font-medium",children:["+",Number(V.stockAdded).toFixed(2)]})]}),(0,s.jsxs)("div",{className:"border-t pt-3 flex justify-between font-semibold",children:[(0,s.jsx)("span",{children:"Calculated Closing Stock"}),(0,s.jsx)("span",{children:Number(V.calculatedStock).toFixed(2)})]})]})]})]}),(0,s.jsx)(c.DialogFooter,{children:(0,s.jsx)(l.Button,{onClick:()=>q(null),children:"Close"})})]})})]}):(0,s.jsxs)("div",{className:"max-w-4xl mx-auto p-6",children:[(0,s.jsxs)(A.Alert,{variant:"destructive",children:[(0,s.jsx)(u.AlertCircle,{className:"h-4 w-4"}),(0,s.jsx)(A.AlertTitle,{children:"Access Denied"}),(0,s.jsx)(A.AlertDescription,{children:"You do not have permission to access stock reconciliation."})]}),(0,s.jsx)("div",{className:"mt-4",children:(0,s.jsx)(l.Button,{onClick:()=>m("/inventory"),variant:"outline",children:"Back to Inventory"})})]})}],987981)}]);