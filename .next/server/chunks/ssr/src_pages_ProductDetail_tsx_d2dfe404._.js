module.exports=[587756,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(665967),e=a.i(391956),f=a.i(347778),g=a.i(842544),h=a.i(342928),i=a.i(823292),j=a.i(558800),k=a.i(169819),l=a.i(591119),m=a.i(699570),n=a.i(866102),o=a.i(368114),p=a.i(786304),q=a.i(824569),r=a.i(883497),s=a.i(292e3),t=a.i(400210),u=a.i(781560),v=a.i(170106);let w=(0,v.default)("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);var x=a.i(669520),y=a.i(771931),z=a.i(284505);let A=(0,v.default)("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]);var B=a.i(915618);let C=(0,v.default)("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);var D=a.i(33926),E=a.i(606388);let F=async a=>{let{productName:b,barcodeValue:d,price:e,currency:f="KES",showPrice:g=!0}=a,h=document.createElement("div");h.style.position="absolute",h.style.left="-9999px",h.style.top="-9999px",h.style.width="340px",h.style.padding="20px",h.style.backgroundColor="white",h.style.fontFamily="Arial, sans-serif",document.body.appendChild(h);try{let a=document.createElement("div");a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="center",a.style.gap="10px";let i=document.createElement("div");i.textContent=b,i.style.fontSize="18px",i.style.fontWeight="bold",i.style.textAlign="center",i.style.maxWidth="100%",i.style.wordWrap="break-word",a.appendChild(i);let k=document.createElement("div");if(k.id="barcode-svg-container",a.appendChild(k),g&&void 0!==e){let b=document.createElement("div");b.textContent=`${f} ${e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`,b.style.fontSize="18px",b.style.fontWeight="bold",b.style.textAlign="center",a.appendChild(b)}h.appendChild(a);let l=(0,E.createRoot)(k);await new Promise(a=>{let b=j.default;l.render(c.default.createElement(b,{value:d,width:2,height:80,fontSize:16})),setTimeout(()=>a(),100)}),(await (0,D.default)(h,{backgroundColor:"#ffffff",scale:2})).toBlob(a=>{if(a){let c=URL.createObjectURL(a),d=document.createElement("a"),e=b.replace(/[^a-z0-9]/gi,"_").toLowerCase();d.download=`barcode_${e}_${Date.now()}.jpg`,d.href=c,d.click(),URL.revokeObjectURL(c)}},"image/jpeg",.95),l.unmount()}catch(a){throw console.error("Error exporting barcode to JPEG:",a),a}finally{document.body.removeChild(h)}};var G=a.i(652647),H=a.i(400291),I=a.i(256711),J=a.i(486192);let K=({open:a,onOpenChange:c,product:d,onConfirm:e})=>(0,b.jsx)(J.AlertDialog,{open:a,onOpenChange:c,children:(0,b.jsxs)(J.AlertDialogContent,{children:[(0,b.jsxs)(J.AlertDialogHeader,{children:[(0,b.jsx)(J.AlertDialogTitle,{children:"Are you sure?"}),(0,b.jsxs)(J.AlertDialogDescription,{children:['This will delete the product "',d?.name,'" and all its associated data. This action cannot be undone.']})]}),(0,b.jsxs)(J.AlertDialogFooter,{children:[(0,b.jsx)(J.AlertDialogCancel,{children:"Cancel"}),(0,b.jsx)(J.AlertDialogAction,{onClick:()=>{e(),c(!1)},className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})});var L=a.i(866718),M=a.i(890914),N=a.i(814574),O=a.i(563658),P=a.i(870430);let Q=({product:a,stockHistory:h,isLoadingHistory:v,onStockUpdate:D})=>{let E=(0,d.useNavigate)(),{user:J}=(0,e.useAuth)(),{currentBusiness:Q}=(0,k.useBusiness)(),{settings:R}=(0,n.useBusinessSettings)(),{updateProduct:S,deleteProduct:T}=(0,f.useProducts)(J?.id),{createStockHistoryEntry:U,stockHistory:V}=(0,g.useStockHistory)(J?.id,a.id),{hasPermission:W}=(0,M.useProfiles)(),[X,Y]=(0,c.useState)(!1),[Z,$]=(0,c.useState)(!1),[_,aa]=(0,c.useState)("Stock In"),[ab,ac]=(0,c.useState)(0),[ad,ae]=(0,c.useState)(""),[af,ag]=(0,c.useState)(new Date().toISOString().split("T")[0]),[ah,ai]=(0,c.useState)(new Date().toTimeString().split(" ")[0]),[aj,ak]=(0,c.useState)(!1),[al,am]=(0,c.useState)(!1),[an,ao]=(0,c.useState)(!0),[ap,aq]=(0,c.useState)(1),[ar,as]=(0,c.useState)(!1),{formatFinancial:at,canViewCostPrice:au,canViewProfit:av,canViewSellingPrice:aw}=(0,H.useFinancialVisibility)(),ax=async()=>!!await T(a.id)&&(i.toast.success("Product deleted successfully"),E("/inventory"),!0),ay=(a,b)=>{if(!a)return"";let c=(()=>{let a=h.length>0?h:V;if(0===a.length)return null;let b=[...a].sort((a,b)=>a.createdAt.getTime()-b.createdAt.getTime());return b[0]?.createdAt||null})();if(!c)return"";let[d,e,f]=a.split("-").map(Number),[g,i,j=0]=b.split(":").map(Number);return new Date(d,e-1,f,g,i,j)<c?`Date and time cannot be before the initial stock date and time (${(0,I.format)(c,"PPP p")})`:""},az=async()=>{if(!ab||ab<=0)return void i.toast.error("Please enter a valid quantity greater than zero");let b=ay(af,ah);if(b)return void i.toast.error(b);ak(!0);try{let b=a.quantity,c=b,d=ad.trim()?`${_}: ${ad}`:_;"Stock In"===_?c=b+ab:"Stock Out"===_&&(c=Math.max(0,b-ab),0===c&&b<ab&&i.toast.warning(`Attempted to remove ${ab} items but only ${b} were available. Stock is now 0.`));let[e,f,g]=af.split("-").map(Number),[h,j,k=0]=ah.split(":").map(Number),l=new Date(e,f-1,g,h,j,k);await U(a.id,b,c,d,void 0,l,void 0,a.name)?await S(a.id,{quantity:c},void 0,!1,"skip-history")?(i.toast.success("Stock updated successfully"),D&&D(),ac(0),ae(""),ag(new Date().toISOString().split("T")[0]),ai(new Date().toTimeString().split(" ")[0])):i.toast.error("History logged, but failed to update product quantity."):i.toast.error("Failed to update stock history")}catch(a){console.error("Error applying stock adjustment:",a),i.toast.error("Failed to apply stock adjustment. Please try again.")}finally{ak(!1)}};return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 md:p-4 shadow-sm",children:(0,b.jsxs)("div",{className:"flex flex-col space-y-3 lg:flex-row lg:justify-between lg:items-center lg:space-y-0 lg:gap-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(m.Button,{variant:"outline",size:"sm",onClick:()=>E("/products"),className:"flex items-center gap-2 hover:bg-gray-50 text-sm",children:[(0,b.jsx)(t.ArrowLeft,{className:"h-4 w-4"}),"Back to Products"]}),(0,b.jsxs)(m.Button,{variant:"outline",size:"sm",onClick:D,className:"flex items-center gap-1 text-sm",children:[(0,b.jsx)(x.RefreshCw,{className:"h-4 w-4"}),"Refresh Data"]})]}),(0,b.jsxs)("div",{className:"flex flex-col space-y-2 lg:flex-row lg:items-center lg:space-y-0 lg:gap-2",children:[W("inventory","create")&&(0,b.jsxs)(m.Button,{variant:"outline",size:"sm",onClick:()=>{i.toast.success("Duplicating product..."),E("/inventory/new",{state:{duplicateData:{name:`${a.name} (Copy)`,description:a.description,category:a.category,supplier:a.supplier,costPrice:a.costPrice,sellingPrice:a.sellingPrice,imageUrl:a.imageUrl,createdAt:a.createdAt,minimumStock:a.minimumStock}}})},className:"flex items-center justify-center gap-2 w-full lg:w-auto hover:bg-blue-50 hover:border-blue-300 text-sm",children:[(0,b.jsx)(w,{className:"h-4 w-4"}),"Duplicate"]}),W("inventory","edit")&&(0,b.jsxs)(m.Button,{onClick:()=>E(`/inventory/edit/${a.id}`),className:"flex items-center justify-center gap-2 w-full lg:w-auto bg-secondary hover:bg-secondary/90 text-sm",size:"sm",children:[(0,b.jsx)(q.Edit,{className:"h-4 w-4"}),"Edit Product"]}),(0,b.jsxs)(N.Dialog,{open:al,onOpenChange:am,children:[(0,b.jsx)(N.DialogTrigger,{asChild:!0,children:(0,b.jsxs)(m.Button,{variant:"outline",size:"sm",className:"flex items-center justify-center gap-2 w-full lg:w-auto hover:bg-green-50 hover:border-green-300 text-sm",children:[(0,b.jsx)(y.Printer,{className:"h-4 w-4"}),"Barcode Label"]})}),(0,b.jsxs)(N.DialogContent,{className:"sm:max-w-md",children:[(0,b.jsx)(N.DialogHeader,{children:(0,b.jsx)(N.DialogTitle,{children:"Barcode Label Preview"})}),(0,b.jsx)("div",{className:"flex flex-col items-center justify-center py-6 bg-gray-50 rounded-lg border border-dashed",children:a.barcode?(0,b.jsxs)("div",{className:"bg-white p-6 shadow-sm rounded-md flex flex-col items-center",children:[(0,b.jsx)("span",{className:"text-lg font-bold mb-2 truncate max-w-[280px]",children:a.name}),(0,b.jsx)(j.default,{value:a.barcode,width:2,height:80,fontSize:16}),an&&(0,b.jsxs)("span",{className:"text-lg font-bold mt-2",children:[R.currency," ",(0,o.formatNumber)(a.sellingPrice)]})]}):(0,b.jsxs)("div",{className:"text-center p-6 text-muted-foreground",children:[(0,b.jsx)(s.AlertCircle,{className:"h-10 w-10 mx-auto mb-2 opacity-50"}),(0,b.jsx)("p",{children:"No barcode available for this selection."})]})}),(0,b.jsxs)("div",{className:"space-y-4 pt-4 border-t",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"space-y-0.5",children:[(0,b.jsx)(P.Label,{className:"text-sm font-medium",children:"Show Price"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Include price on the printed label"})]}),(0,b.jsx)(O.Switch,{checked:an,onCheckedChange:ao})]}),(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"space-y-0.5",children:[(0,b.jsx)(P.Label,{className:"text-sm font-medium",children:"Quantity to Print"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Number of labels to print"})]}),(0,b.jsx)(L.Input,{type:"number",min:"1",className:"w-20",value:ap,onChange:a=>aq(parseInt(a.target.value)||1)})]}),(0,b.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,b.jsxs)(m.Button,{className:"w-full gap-2",disabled:!a.barcode,onClick:()=>{let b=an?`TEXT 15,180,"3",0,1,1,"${R.currency} ${(0,o.formatNumber)(a.sellingPrice)}"
`:"";fetch("http://localhost:5000/print/label",{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({PrinterName:R.defaultPrinterName||"Label Printer",Content:`SIZE 50 mm, 30 mm
GAP 3 mm, 0 mm
CLS
TEXT 15,20,"3",0,1,1,"${a.name}"
BARCODE 15,70,"128",60,1,0,2,2,"${a.barcode}"
${b}PRINT ${ap}
`})}).then(()=>{i.toast.success(`${ap} label${ap>1?"s":""} sent to printer`)}).catch(a=>{console.error("Failed to print label:",a),i.toast.error("Printing failed. Make sure Printer Bridge is running.")})},children:[(0,b.jsx)(y.Printer,{className:"h-4 w-4"}),"Print ",ap," Label",ap>1?"s":""]}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("div",{className:"absolute inset-0 flex items-center",children:(0,b.jsx)("span",{className:"w-full border-t"})}),(0,b.jsx)("div",{className:"relative flex justify-center text-xs uppercase",children:(0,b.jsx)("span",{className:"bg-background px-2 text-muted-foreground",children:"Or Download"})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,b.jsxs)(m.Button,{variant:"outline",className:"gap-2",disabled:!a.barcode||ar,onClick:async()=>{as(!0);try{await F({productName:a.name,barcodeValue:a.barcode,price:a.sellingPrice,currency:R.currency,showPrice:an}),i.toast.success("Barcode exported as JPEG")}catch(a){console.error("Export failed:",a),i.toast.error("Failed to export barcode")}finally{as(!1)}},children:[(0,b.jsx)(A,{className:"h-4 w-4"}),"JPEG"]}),(0,b.jsxs)(m.Button,{variant:"outline",className:"gap-2",disabled:!a.barcode||ar,onClick:async()=>{as(!0);try{await (0,G.exportSingleBarcodeToPDF)({productName:a.name,barcodeValue:a.barcode,price:a.sellingPrice,currency:R.currency,showPrice:an}),i.toast.success("Barcode exported as PDF")}catch(a){console.error("Export failed:",a),i.toast.error("Failed to export barcode")}finally{as(!1)}},children:[(0,b.jsx)(z.Download,{className:"h-4 w-4"}),"PDF"]})]}),(0,b.jsx)(m.Button,{variant:"outline",className:"w-full",onClick:()=>am(!1),children:"Close"})]})]})]})]}),W("inventory","delete")&&(0,b.jsxs)(m.Button,{variant:"outline",size:"sm",onClick:()=>Y(!0),className:"flex items-center justify-center gap-2 w-full lg:w-auto text-red-600 hover:text-red-700 border-red-200 hover:border-red-300 hover:bg-red-50 text-sm",children:[(0,b.jsx)(u.Trash2,{className:"h-4 w-4"}),"Delete"]})]})]})}),(0,b.jsxs)("div",{className:"grid md:grid-cols-3 gap-6",children:[(0,b.jsxs)(l.Card,{className:"md:col-span-2",children:[(0,b.jsx)(l.CardHeader,{children:(0,b.jsxs)(l.CardTitle,{className:"flex justify-between items-center",children:[(0,b.jsx)("span",{children:"Product Details"}),0===a.quantity?(0,b.jsx)(p.Badge,{variant:"destructive",className:"text-sm",children:"Out of stock"}):a.quantity<=a.minimumStock?(0,b.jsx)(p.Badge,{variant:"warning",className:"bg-amber-500 text-sm",children:"Low stock"}):(0,b.jsx)(p.Badge,{variant:"success",className:"bg-green-600 text-sm",children:"In stock"})]})}),(0,b.jsxs)(l.CardContent,{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-6",children:[a.imageUrl&&(0,b.jsx)("div",{className:"md:w-1/3",children:(0,b.jsx)("img",{src:a.imageUrl,alt:a.name,className:"w-full h-auto object-contain border rounded-md"})}),(0,b.jsxs)("div",{className:a.imageUrl?"md:w-2/3":"w-full",children:[(0,b.jsx)("h2",{className:"text-2xl font-bold mb-2",children:a.name}),(0,b.jsxs)("div",{className:"mb-4 flex flex-wrap gap-2",children:[(0,b.jsx)(p.Badge,{variant:"outline",children:a.category}),(0,b.jsxs)(p.Badge,{variant:"secondary",children:["#",a.itemNumber]})]}),a.description&&(0,b.jsx)("p",{className:"text-gray-700 mb-4",children:a.description}),(0,b.jsxs)("dl",{className:"grid grid-cols-2 gap-x-4 gap-y-2",children:[(0,b.jsx)("dt",{className:"text-gray-500",children:"Item Number:"}),(0,b.jsxs)("dd",{className:"font-semibold",children:["#",a.itemNumber]}),a.manufacturerBarcode&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("dt",{className:"text-gray-500",children:"Manufacturer Barcode:"}),(0,b.jsx)("dd",{className:"font-semibold",children:a.manufacturerBarcode})]}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Quantity in Stock:"}),(0,b.jsx)("dd",{className:"font-semibold",children:a.quantity%1==0?a.quantity:a.quantity.toFixed(2)}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Minimum Stock Level:"}),(0,b.jsx)("dd",{children:a.minimumStock}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Cost Price:"}),(0,b.jsx)("dd",{children:au?`${R.currency} ${at(a.costPrice,"cost")}`:"•••"}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Selling Price:"}),(0,b.jsx)("dd",{children:aw?`${R.currency} ${at(a.sellingPrice,"selling")}`:"•••"}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Total Cost:"}),(0,b.jsx)("dd",{className:"font-semibold",children:au?`${R.currency} ${(0,o.formatNumber)(a.quantity*a.costPrice)}`:"•••"}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Profit Margin:"}),(0,b.jsx)("dd",{children:av?`${((a.sellingPrice-a.costPrice)/a.sellingPrice*100).toFixed(2)}%`:"•••"}),a.supplier&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("dt",{className:"text-gray-500",children:"Supplier:"}),(0,b.jsx)("dd",{children:a.supplier})]}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Created:"}),(0,b.jsx)("dd",{children:(0,I.format)(a.createdAt,"MMM d, yyyy")}),(0,b.jsx)("dt",{className:"text-gray-500",children:"Last Updated:"}),(0,b.jsx)("dd",{children:(0,I.format)(a.updatedAt,"MMM d, yyyy")})]})]})]}),(0,b.jsx)("div",{className:"flex flex-wrap gap-4",children:a.quantity<=a.minimumStock&&(0,b.jsxs)("div",{className:"bg-amber-50 border border-amber-200 rounded-md p-4 w-full flex items-center gap-3",children:[(0,b.jsx)(s.AlertCircle,{className:"text-amber-600 h-6 w-6 flex-shrink-0"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h4",{className:"font-medium text-amber-800",children:"Low Stock Alert"}),(0,b.jsxs)("p",{className:"text-sm text-amber-700",children:["Current stock (",a.quantity,") is below or equal to the minimum threshold (",a.minimumStock,")."]})]})]})})]})]}),(0,b.jsx)("div",{className:"space-y-6",children:(0,b.jsxs)(l.Card,{children:[(0,b.jsx)(l.CardHeader,{className:"pb-2",children:(0,b.jsx)(l.CardTitle,{className:"text-lg",children:"Stock Management"})}),(0,b.jsx)(l.CardContent,{children:W("inventory","stock_adjustment")?(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Adjustment Type"}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-2",children:[(0,b.jsxs)(m.Button,{type:"button",variant:"Stock In"===_?"default":"outline",onClick:()=>aa("Stock In"),className:`w-full ${"Stock In"===_?"bg-orange-600 hover:bg-orange-700":""}`,children:[(0,b.jsx)(B.Plus,{className:"mr-2 h-4 w-4"}),"Stock In"]}),(0,b.jsxs)(m.Button,{type:"button",variant:"Stock Out"===_?"default":"outline",onClick:()=>aa("Stock Out"),className:`w-full ${"Stock Out"===_?"bg-orange-600 hover:bg-orange-700":""}`,children:[(0,b.jsx)(C,{className:"mr-2 h-4 w-4"}),"Stock Out"]})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),(0,b.jsx)(L.Input,{type:"number",min:"0.01",step:"0.01",value:ab||"",onChange:a=>ac(parseFloat(a.target.value)||0),placeholder:"Enter quantity"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Reason (Optional)"}),(0,b.jsx)(L.Input,{type:"text",value:ad,onChange:a=>ae(a.target.value),placeholder:"e.g., Weekly restock, Damaged goods",maxLength:100})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Date"}),(0,b.jsx)(L.Input,{type:"date",value:af,onChange:a=>ag(a.target.value),min:a.createdAt?new Date(a.createdAt).toISOString().split("T")[0]:void 0,max:new Date().toISOString().split("T")[0],className:ay(af,ah)?"border-destructive border-2 bg-destructive/5":""})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Time"}),(0,b.jsx)(L.Input,{type:"time",step:"1",value:ah,onChange:a=>ai(a.target.value),className:ay(af,ah)?"border-destructive border-2 bg-destructive/5":""})]})]}),ay(af,ah)&&(0,b.jsx)("p",{className:"text-sm text-destructive mt-1",children:ay(af,ah)}),(0,b.jsxs)(m.Button,{onClick:az,disabled:aj||ab<=0||!!ay(af,ah),className:"w-full bg-orange-600 hover:bg-orange-700",children:[(0,b.jsx)(r.Package,{className:"mr-2 h-4 w-4"}),aj?"Applying...":`Apply ${_}`]})]}):(0,b.jsxs)("div",{className:"py-4 text-center space-y-2",children:[(0,b.jsx)(s.AlertCircle,{className:"h-8 w-8 text-muted-foreground mx-auto opacity-50"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"You do not have permission to perform stock adjustments."})]})})]})})]}),(0,b.jsx)(K,{open:X,onOpenChange:Y,product:a,onConfirm:ax})]})};var R=a.i(641710),S=a.i(591965),T=a.i(229805),U=a.i(782104);let V=({stockHistory:a,isLoadingHistory:d,onEditStockHistory:e,onDeleteStockHistory:f,products:g})=>{let h,{hasPermission:i}=(0,M.useProfiles)(),[j,k]=(0,c.useState)({open:!1,entry:null}),[n,o]=(0,c.useState)({open:!1,entry:null}),[r,s]=(0,c.useState)(null),[t,v]=(0,c.useState)(null),w=b=>{if(0===a.length)return!1;let c=[...a].sort((a,b)=>a.createdAt.getTime()-b.createdAt.getTime());return c[0]?.id===b.id},x=(0,c.useMemo)(()=>{let b={},c=[];return a.forEach(a=>{if(["Sale","Delete sale","Deleted Sale","Sale qty edit"].some(b=>a.changeReason.toLowerCase().includes(b.toLowerCase()))){let c=a.receiptNumber||a.referenceId||a.id;b[c]||(b[c]=[]),b[c].push(a)}else c.push(a)}),[...Object.values(b).map(a=>{let b=[...a].sort((a,b)=>new Date(b.createdAt).getTime()-new Date(a.createdAt).getTime());return{type:"sale",main:b[0],all:b,sortDate:b[0].createdAt}}),...c.map(a=>({type:"single",entry:a,sortDate:a.createdAt}))].sort((a,b)=>{let c=new Date(a.sortDate).getTime();return new Date(b.sortDate).getTime()-c})},[a]),y=d?(0,b.jsxs)("div",{className:"animate-pulse text-center py-8",children:[(0,b.jsx)("div",{className:"w-16 h-16 bg-gray-200 rounded-full mx-auto mb-4"}),(0,b.jsx)("p",{className:"text-gray-500",children:"Loading stock history..."})]}):0===a.length?(0,b.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,b.jsx)(S.History,{size:48,className:"mx-auto mb-4 opacity-50"}),(0,b.jsx)("p",{children:"No stock history available for this product"}),(0,b.jsx)("p",{className:"text-sm mt-2",children:"Stock changes will appear here once you make adjustments"})]}):(0,b.jsx)("div",{className:"space-y-3",children:x.map(a=>{if("sale"===a.type){let{main:c,all:d}=a,e=c.receiptNumber||c.referenceId||c.id,f=r===e,g=d[0],h=d[d.length-1],i=d.length>1;return(0,b.jsxs)("div",{className:`border rounded-lg p-4 transition-colors ${c.newQuantity>c.oldQuantity?"bg-green-50 border-green-200 hover:bg-green-100":c.newQuantity<c.oldQuantity?"bg-red-50 border-red-200 hover:bg-red-100":"border-gray-200 hover:bg-gray-50"}`,children:[(0,b.jsxs)("div",{className:"flex justify-between items-start",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,b.jsxs)(p.Badge,{variant:"outline",className:"text-xs",children:["Sale - ",c.receiptNumber||c.referenceId||c.id]}),i&&(0,b.jsx)(p.Badge,{variant:"secondary",className:"text-[10px] h-5",children:"Edited"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[i?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(p.Badge,{variant:"outline",className:"text-xs bg-muted/50 font-normal",children:["Original: ",h.oldQuantity," → ",h.newQuantity," (",h.newQuantity-h.oldQuantity>0?"+":"",h.newQuantity-h.oldQuantity,")"]}),(0,b.jsx)("span",{className:"text-muted-foreground",children:"→"}),(0,b.jsxs)(p.Badge,{variant:"secondary",className:"text-xs font-normal",children:["Current: ",g.oldQuantity," → ",g.newQuantity," (",g.newQuantity-g.oldQuantity>0?"+":"",g.newQuantity-g.oldQuantity,")"]})]}):(0,b.jsxs)(p.Badge,{variant:"outline",className:"text-xs bg-muted/50 font-normal",children:["Qty: ",c.oldQuantity," → ",c.newQuantity," (",c.newQuantity-c.oldQuantity>0?"+":"",c.newQuantity-c.oldQuantity,")"]}),!i&&(0,b.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-1 ml-2",children:[(0,b.jsx)(R.Clock,{className:"inline-block w-3 h-3"}),(0,I.format)(c.createdAt,"MMM d, yyyy h:mm a")]}),i&&(0,b.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-1 ml-2",children:[(0,b.jsx)(R.Clock,{className:"inline-block w-3 h-3"}),(0,I.format)(g.createdAt,"MMM d, yyyy h:mm a")]})]})]}),(0,b.jsx)("div",{className:"flex items-center gap-3",children:(0,b.jsx)(m.Button,{variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>s(f?null:e),children:f?"Hide Details":"View Details"})})]}),f&&(0,b.jsxs)("div",{className:"mt-4 border-t pt-3",children:[(0,b.jsx)("div",{className:"font-semibold mb-2 text-sm text-muted-foreground",children:"Sale Actions"}),(0,b.jsx)("div",{className:"overflow-x-auto",children:(0,b.jsxs)("table",{className:"min-w-full text-xs border",children:[(0,b.jsx)("thead",{children:(0,b.jsxs)("tr",{className:"bg-muted/50",children:[(0,b.jsx)("th",{className:"px-2 py-1 text-left",children:"Action"}),(0,b.jsx)("th",{className:"px-2 py-1 text-left",children:"Date"}),(0,b.jsx)("th",{className:"px-2 py-1 text-left",children:"Qty Change"})]})}),(0,b.jsx)("tbody",{children:d.map(a=>(0,b.jsxs)("tr",{className:"border-b last:border-b-0",children:[(0,b.jsx)("td",{className:"px-2 py-1 font-medium",children:a.changeReason.replace("Deleted sale","Deleted Sale")}),(0,b.jsx)("td",{className:"px-2 py-1 text-muted-foreground",children:(0,I.format)(a.createdAt,"MMM d, yyyy h:mm a")}),(0,b.jsxs)("td",{className:"px-2 py-1",children:[a.oldQuantity," → ",a.newQuantity," (",a.newQuantity-a.oldQuantity>0?"+":"",a.newQuantity-a.oldQuantity,")"]})]},a.id))})]})})]})]},c.id)}{let{entry:c}=a,d=t===c.id;return(0,b.jsxs)("div",{className:`border rounded-lg p-4 transition-colors ${c.newQuantity>c.oldQuantity?"bg-green-50 border-green-200 hover:bg-green-100":c.newQuantity<c.oldQuantity?"bg-red-50 border-red-200 hover:bg-red-100":"border-gray-200 hover:bg-gray-50"}`,children:[(0,b.jsxs)("div",{className:"flex justify-between items-start",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("div",{className:"flex items-center gap-2 mb-2",children:(0,b.jsxs)(p.Badge,{variant:"outline",className:"text-xs",children:[c.changeReason.replace("Deleted sale","Deleted Sale"),c.receiptNumber&&` - #${c.receiptNumber}`]})}),(0,b.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[(0,b.jsxs)(p.Badge,{variant:"outline",className:"text-xs bg-muted/50 font-normal",children:["Qty: ",c.oldQuantity," → ",c.newQuantity," (",c.newQuantity-c.oldQuantity>0?"+":"",c.newQuantity-c.oldQuantity,")"]}),(0,b.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-1 ml-2",children:[(0,b.jsx)(R.Clock,{className:"inline-block w-3 h-3"}),(0,I.format)(c.createdAt,"MMM d, yyyy h:mm a")]})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)(m.Button,{variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>v(d?null:c.id),children:d?"Hide Details":"View Details"}),w(c)?(0,b.jsxs)(b.Fragment,{children:[i("inventory","edit")&&(0,b.jsx)(m.Button,{variant:"outline",size:"sm",onClick:()=>k({open:!0,entry:c}),className:"h-8 px-2",children:(0,b.jsx)(q.Edit,{className:"h-3 w-3"})}),(0,b.jsx)("div",{className:"text-xs text-muted-foreground px-2 py-1 bg-blue-100 text-blue-800 rounded",children:"Initial Stock"})]}):(0,b.jsxs)(b.Fragment,{children:[i("inventory","edit")&&(0,b.jsx)(m.Button,{variant:"outline",size:"sm",onClick:()=>k({open:!0,entry:c}),className:"h-8 px-2",children:(0,b.jsx)(q.Edit,{className:"h-3 w-3"})}),i("inventory","delete")&&(0,b.jsx)(m.Button,{variant:"outline",size:"sm",onClick:()=>o({open:!0,entry:c}),className:"h-8 px-2 text-destructive hover:text-destructive",children:(0,b.jsx)(u.Trash2,{className:"h-3 w-3"})})]})]})]}),d&&(0,b.jsxs)("div",{className:"mt-4 border-t pt-3",children:[(0,b.jsx)("div",{className:"font-semibold mb-2 text-sm text-muted-foreground",children:"Details"}),(0,b.jsx)("div",{className:"overflow-x-auto",children:(0,b.jsxs)("table",{className:"min-w-full text-xs border",children:[(0,b.jsx)("thead",{children:(0,b.jsxs)("tr",{className:"bg-muted/50",children:[(0,b.jsx)("th",{className:"px-2 py-1 text-left",children:"Reason"}),(0,b.jsx)("th",{className:"px-2 py-1 text-left",children:"Date"}),(0,b.jsx)("th",{className:"px-2 py-1 text-left",children:"Qty Change"})]})}),(0,b.jsx)("tbody",{children:(0,b.jsxs)("tr",{className:"border-b last:border-b-0",children:[(0,b.jsx)("td",{className:"px-2 py-1 font-medium",children:c.changeReason.replace("Deleted sale","Deleted Sale")}),(0,b.jsx)("td",{className:"px-2 py-1 text-muted-foreground",children:(0,I.format)(c.createdAt,"MMM d, yyyy h:mm a")}),(0,b.jsxs)("td",{className:"px-2 py-1",children:[c.oldQuantity," → ",c.newQuantity," (",c.newQuantity-c.oldQuantity>0?"+":"",c.newQuantity-c.oldQuantity,")"]})]})})]})})]})]},c.id)}})});return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(l.Card,{children:[(0,b.jsx)(l.CardHeader,{children:(0,b.jsx)("div",{className:"flex items-center justify-between",children:(0,b.jsxs)(l.CardTitle,{className:"flex items-center gap-2",children:[(0,b.jsx)(S.History,{className:"h-5 w-5"}),"Stock History",a.length>0&&(0,b.jsxs)(p.Badge,{variant:"secondary",className:"ml-2",children:[a.length," entries"]})]})})}),(0,b.jsx)(l.CardContent,{children:y})]}),(0,b.jsx)(T.default,{open:j.open,onOpenChange:a=>k({open:a,entry:null}),entry:j.entry,onConfirm:e,isInitialStock:!!j.entry&&w(j.entry),stockHistory:a,productCreatedAt:j.entry&&(h=g.find(a=>a.id===j.entry?.productId))?new Date(h.createdAt):void 0}),(0,b.jsx)(U.default,{open:n.open,onOpenChange:a=>o({open:a,entry:null}),entry:n.entry,onConfirm:f})]})};a.s(["default",0,()=>{let{id:a}=(0,d.useParams)(),j=(0,d.useNavigate)(),{user:k}=(0,e.useAuth)(),{products:l,isLoading:m,loadProducts:n,refetch:o}=(0,f.useProducts)(k?.id,1e4),[p,q]=(0,c.useState)(null),{stockHistory:r,isLoading:s,loadStockHistory:t,updateStockHistoryEntry:u,deleteStockHistoryEntry:v,recalculateProductStock:w}=(0,g.useStockHistory)(k?.id,a),{clearAllLocationCaches:x}=(0,h.useStockSummaryData)({from:void 0,to:void 0}),[y,z]=(0,c.useState)(!1),[A,B]=(0,c.useState)(0),C=async()=>{if(a){z(!0);let{data:b}=await o(),c=(b?.products||[]).find(b=>b.id===a);c?q(c):(i.toast.error("Product not found"),j("/inventory")),z(!1)}},D=async()=>{await C(),a&&t&&await t(),B(a=>a+1)},E=async(a,b,c,d)=>{let e=await u(a,b,c,d);return e&&(x(),await Promise.all([t(),C()])),e},F=async a=>{let b=await v(a);return b&&(x(),await Promise.all([w(p.id),t(),C()])),b};return((0,c.useEffect)(()=>{if(!m&&l.length>0&&a){let b=l.find(b=>b.id===a);b?q(b):(i.toast.error("Product not found"),j("/inventory"))}},[a,l,m,j]),(0,c.useEffect)(()=>{let a=()=>{console.log("Stock updated, refreshing product data"),D()};return window.addEventListener("stock-updated",a),()=>{window.removeEventListener("stock-updated",a)}},[D]),m||y||!p)?(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[60vh] space-y-4",children:[(0,b.jsx)("img",{src:"/lovable-uploads/7f7549a3-e9df-4762-b8b9-8e041e34f55d.png",alt:"Loading",className:"w-16 h-16 animate-spin"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"Loading product data..."})]}):(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsx)(Q,{product:p,stockHistory:r,isLoadingHistory:s,onStockUpdate:D},`details-${A}`),(0,b.jsx)(V,{stockHistory:r,isLoadingHistory:s,onEditStockHistory:E,onDeleteStockHistory:F,products:l},`history-${A}`)]})}],587756)}];

//# sourceMappingURL=src_pages_ProductDetail_tsx_d2dfe404._.js.map