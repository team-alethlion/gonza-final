{"version":3,"sources":["../../../../src/app/actions/inventory.ts","../../../../src/hooks/useStockHistory.ts"],"sourcesContent":["'use server';\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// --- STOCK HISTORY ---\r\n\r\nexport async function getStockHistoryAction(locationId: string, productId?: string) {\r\n    try {\r\n        const where: any = { locationId };\r\n        if (productId) where.productId = productId;\r\n\r\n        const history = await db.productHistory.findMany({\r\n            where,\r\n            include: {\r\n                product: {\r\n                    select: {\r\n                        name: true,\r\n                        costPrice: true,\r\n                        sellingPrice: true,\r\n                        sku: true\r\n                    }\r\n                }\r\n            },\r\n            orderBy: [{ createdAt: 'desc' }, { id: 'desc' }]\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: history.map((h: any) => ({\r\n                id: h.id,\r\n                productId: h.productId,\r\n                oldQuantity: h.previousQuantity,\r\n                newQuantity: h.newQuantity,\r\n                changeReason: h.changeReason,\r\n                createdAt: h.createdAt.toISOString(),\r\n                referenceId: h.referenceId,\r\n                receiptNumber: h.receiptNumber,\r\n                product: h.product ? {\r\n                    name: h.product.name,\r\n                    costPrice: h.product.costPrice,\r\n                    sellingPrice: h.product.sellingPrice,\r\n                    itemNumber: h.product.sku\r\n                } : undefined\r\n            }))\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error fetching stock history:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createStockHistoryAction(data: any) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            const entry = await tx.productHistory.create({\r\n                data: {\r\n                    userId: data.userId,\r\n                    locationId: data.locationId,\r\n                    productId: data.productId,\r\n                    previousQuantity: data.previousQuantity,\r\n                    newQuantity: data.newQuantity,\r\n                    changeReason: data.changeReason,\r\n                    referenceId: data.referenceId || null,\r\n                    receiptNumber: data.receiptNumber || null,\r\n                    createdAt: data.createdAt ? new Date(data.createdAt) : undefined\r\n                }\r\n            });\r\n\r\n            // Update product stock as well\r\n            await tx.product.update({\r\n                where: { id: data.productId },\r\n                data: { stock: data.newQuantity }\r\n            });\r\n\r\n            return entry;\r\n        });\r\n\r\n        revalidatePath('/inventory');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error creating stock history:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function recalculateStockChainAction(productId: string, locationId: string) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            const history = await tx.productHistory.findMany({\r\n                where: { productId, locationId },\r\n                orderBy: [{ createdAt: 'asc' }, { id: 'asc' }]\r\n            });\r\n\r\n            if (history.length === 0) return { finalQuantity: 0 };\r\n\r\n            let runningQuantity = 0;\r\n            const updates = [];\r\n\r\n            for (const entry of history) {\r\n                const change = entry.newQuantity - entry.previousQuantity;\r\n                const newPrev = runningQuantity;\r\n                const newNext = newPrev + change;\r\n\r\n                if (entry.previousQuantity !== newPrev || entry.newQuantity !== newNext) {\r\n                    updates.push(tx.productHistory.update({\r\n                        where: { id: entry.id },\r\n                        data: { previousQuantity: newPrev, newQuantity: newNext }\r\n                    }));\r\n                }\r\n                runningQuantity = newNext;\r\n            }\r\n\r\n            if (updates.length > 0) {\r\n                await Promise.all(updates);\r\n            }\r\n\r\n            // Update product\r\n            await tx.product.update({\r\n                where: { id: productId },\r\n                data: { stock: runningQuantity }\r\n            });\r\n\r\n            return { finalQuantity: runningQuantity };\r\n        });\r\n\r\n        revalidatePath('/inventory');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error recalculating stock chain:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteStockHistoryEntriesByReferenceAction(referenceId: string, locationId: string) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            const entries = await tx.productHistory.findMany({\r\n                where: { referenceId, locationId },\r\n                select: { productId: true }\r\n            });\r\n\r\n            const productIds = [...new Set(entries.map((e: any) => e.productId as string))];\r\n\r\n            await tx.productHistory.deleteMany({\r\n                where: { referenceId, locationId }\r\n            });\r\n\r\n            // Recalculate chains for affected products\r\n            for (const productId of productIds) {\r\n                await recalculateStockChainInternal(tx, productId as string, locationId);\r\n            }\r\n\r\n            return { affectedProducts: productIds.length };\r\n        });\r\n\r\n        revalidatePath('/inventory');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error deleting stock history by reference:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function updateStockHistoryDatesByReferenceAction(referenceId: string, locationId: string, newDate: string) {\r\n    try {\r\n        const result = await db.productHistory.updateMany({\r\n            where: { referenceId, locationId },\r\n            data: { createdAt: new Date(newDate) }\r\n        });\r\n\r\n        revalidatePath('/inventory');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error updating stock history dates:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// Internal helper for use within transactions\r\nasync function recalculateStockChainInternal(tx: any, productId: string, locationId: string) {\r\n    const history = await tx.productHistory.findMany({\r\n        where: { productId, locationId },\r\n        orderBy: [{ createdAt: 'asc' }, { id: 'asc' }]\r\n    });\r\n\r\n    let runningQuantity = 0;\r\n    for (const entry of history) {\r\n        const change = entry.newQuantity - entry.previousQuantity;\r\n        const newPrev = runningQuantity;\r\n        const newNext = newPrev + change;\r\n\r\n        if (entry.previousQuantity !== newPrev || entry.newQuantity !== newNext) {\r\n            await tx.productHistory.update({\r\n                where: { id: entry.id },\r\n                data: { previousQuantity: newPrev, newQuantity: newNext }\r\n            });\r\n        }\r\n        runningQuantity = newNext;\r\n    }\r\n\r\n    await tx.product.update({\r\n        where: { id: productId },\r\n        data: { stock: runningQuantity }\r\n    });\r\n}\r\n\r\n// --- REQUISITIONS ---\r\n\r\nexport async function getRequisitionsAction(userId: string, locationId: string) {\r\n    try {\r\n        const requisitions = await db.requisition.findMany({\r\n            where: {\r\n                userId,\r\n                locationId\r\n            },\r\n            orderBy: {\r\n                createdAt: 'desc'\r\n            }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: requisitions.map((req: any) => ({\r\n                id: req.id,\r\n                userId: req.userId,\r\n                locationId: req.branchId,\r\n                requisitionNumber: req.requisitionNumber,\r\n                title: req.title || '',\r\n                items: (req.items as any) || [],\r\n                notes: req.notes,\r\n                status: req.status,\r\n                createdAt: req.createdAt.toISOString(),\r\n                updatedAt: req.updatedAt.toISOString()\r\n            }))\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error fetching requisitions:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createRequisitionAction(data: any) {\r\n    try {\r\n        const requisition = await db.requisition.create({\r\n            data: {\r\n                userId: data.userId,\r\n                branchId: data.locationId,\r\n                requisitionNumber: data.requisitionNumber,\r\n                title: data.title,\r\n                items: data.items,\r\n                notes: data.notes,\r\n                status: data.status || 'draft'\r\n            }\r\n        });\r\n\r\n        revalidatePath('/requisitions');\r\n        return {\r\n            success: true,\r\n            data: {\r\n                id: requisition.id,\r\n                userId: requisition.userId,\r\n                locationId: requisition.branchId,\r\n                requisitionNumber: requisition.requisitionNumber,\r\n                title: requisition.title || '',\r\n                items: (requisition.items as any) || [],\r\n                notes: requisition.notes,\r\n                status: requisition.status,\r\n                createdAt: requisition.createdAt.toISOString(),\r\n                updatedAt: requisition.updatedAt.toISOString()\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error creating requisition:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function updateRequisitionAction(id: string, userId: string, data: any) {\r\n    try {\r\n        const requisition = await db.requisition.update({\r\n            where: { id, userId },\r\n            data: {\r\n                title: data.title,\r\n                items: data.items,\r\n                notes: data.notes,\r\n                status: data.status,\r\n                updatedAt: new Date()\r\n            }\r\n        });\r\n\r\n        revalidatePath('/requisitions');\r\n        return {\r\n            success: true,\r\n            data: {\r\n                id: requisition.id,\r\n                userId: requisition.userId,\r\n                locationId: requisition.branchId,\r\n                requisitionNumber: requisition.requisitionNumber,\r\n                title: requisition.title || '',\r\n                items: (requisition.items as any) || [],\r\n                notes: requisition.notes,\r\n                status: requisition.status,\r\n                createdAt: requisition.createdAt.toISOString(),\r\n                updatedAt: requisition.updatedAt.toISOString()\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error updating requisition:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteRequisitionAction(id: string, userId: string) {\r\n    try {\r\n        await db.requisition.delete({\r\n            where: { id, userId }\r\n        });\r\n\r\n        revalidatePath('/requisitions');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error deleting requisition:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- REPORTS / ANALYTICS ---\r\n\r\nexport async function getStockSummaryReportAction(locationId: string, startDate: string, endDate: string) {\r\n    try {\r\n        const start = new Date(startDate);\r\n        const end = new Date(endDate);\r\n\r\n        // Fetch all products for the location\r\n        const products = await db.product.findMany({\r\n            where: { branchId: locationId },\r\n            include: { category: true }\r\n        });\r\n\r\n        const reportData = await Promise.all(products.map(async (product: any) => {\r\n            // This is a simplified version of the logic that was likely in the RPC\r\n            // In a real production app, we'd use complex SQL or dedicated aggregate tables\r\n\r\n            // Get history for this product in the date range\r\n            const history = await db.productHistory.findMany({\r\n                where: {\r\n                    productId: product.id,\r\n                    locationId,\r\n                    createdAt: {\r\n                        gte: start,\r\n                        lte: end\r\n                    }\r\n                },\r\n                orderBy: { createdAt: 'asc' }\r\n            });\r\n\r\n            // Calculate metrics from history\r\n            let itemsSold = 0;\r\n            let stockIn = 0;\r\n            let adjustmentsIn = 0;\r\n            let adjustmentsOut = 0;\r\n\r\n            history.forEach((h: any) => {\r\n                const change = h.newQuantity - h.previousQuantity;\r\n                if (h.changeReason === 'SALE') {\r\n                    itemsSold += Math.abs(change);\r\n                } else if (h.changeReason === 'STOCK_IN' || h.changeReason === 'RESTOCK') {\r\n                    stockIn += change;\r\n                } else if (change > 0) {\r\n                    adjustmentsIn += change;\r\n                } else {\r\n                    adjustmentsOut += Math.abs(change);\r\n                }\r\n            });\r\n\r\n            // Get closing stock at end date (or current if after end date)\r\n            const closingStockEntry = await db.productHistory.findFirst({\r\n                where: {\r\n                    productId: product.id,\r\n                    locationId,\r\n                    createdAt: { lte: end }\r\n                },\r\n                orderBy: { createdAt: 'desc' }\r\n            });\r\n\r\n            const closingStock = closingStockEntry ? closingStockEntry.newQuantity : 0;\r\n            const openingStock = closingStock - (stockIn + adjustmentsIn - itemsSold - adjustmentsOut);\r\n\r\n            return {\r\n                productId: product.id,\r\n                productName: product.name,\r\n                itemNumber: product.sku || product.id,\r\n                imageUrl: product.imageUrl,\r\n                costPrice: Number(product.costPrice),\r\n                sellingPrice: Number(product.sellingPrice),\r\n                category: product.category?.name,\r\n                openingStock,\r\n                itemsSold,\r\n                stockIn,\r\n                transferOut: 0,\r\n                returnIn: 0,\r\n                returnOut: 0,\r\n                adjustmentsIn,\r\n                adjustmentsOut,\r\n                closingStock,\r\n                revaluation: closingStock * Number(product.costPrice)\r\n            };\r\n        }));\r\n\r\n        return { success: true, data: reportData };\r\n    } catch (error: any) {\r\n        console.error('Error generating stock summary report:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- STOCK RECONCILIATION & REPAIRS ---\r\n\r\nexport async function getProductReconciliationAction(businessId: string, productId: string) {\r\n    try {\r\n        const product = await db.product.findUnique({\r\n            where: { id: productId },\r\n            include: { category: true }\r\n        });\r\n\r\n        if (!product) return { success: false, error: 'Product not found' };\r\n\r\n        // Fetch all history entries\r\n        const history = await db.productHistory.findMany({\r\n            where: { productId, locationId: businessId },\r\n            orderBy: [{ createdAt: 'asc' }, { id: 'asc' }]\r\n        });\r\n\r\n        // Fetch all sales containing this product\r\n        const sales = await db.sale.findMany({\r\n            where: { branchId: businessId },\r\n            orderBy: { date: 'asc' }\r\n        });\r\n\r\n        const openingStock = history.length > 0 ? history[0].newStock : 0;\r\n        const openingDate = history.length > 0 ? history[0].createdAt : null;\r\n\r\n        const dailyTransactions = new Map<string, any>();\r\n        let excludedSalesQty = 0;\r\n\r\n        sales.forEach(sale => {\r\n            const items = (sale.items as any[]) || [];\r\n            const soldQty = items\r\n                .filter(item => item.productId === productId)\r\n                .reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);\r\n\r\n            if (soldQty > 0) {\r\n                if (openingDate && sale.date < openingDate) {\r\n                    excludedSalesQty += soldQty;\r\n                } else {\r\n                    const dateStr = sale.date.toISOString().split('T')[0];\r\n                    const day = dailyTransactions.get(dateStr) || { itemsSold: 0, stockAdded: 0, transferOut: 0, returnIn: 0, returnOut: 0, adjustments: 0 };\r\n                    day.itemsSold += soldQty;\r\n                    dailyTransactions.set(dateStr, day);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Movements (excluding initial entry)\r\n        const movements = history.slice(1);\r\n        movements.forEach(h => {\r\n            const dateStr = h.createdAt.toISOString().split('T')[0];\r\n            const delta = h.newStock - h.oldStock;\r\n            const reason = (h.changeReason || '').toLowerCase();\r\n\r\n            const day = dailyTransactions.get(dateStr) || { itemsSold: 0, stockAdded: 0, transferOut: 0, returnIn: 0, returnOut: 0, adjustments: 0 };\r\n\r\n            if (h.type === 'RESTOCK' || reason.includes('purchase') || reason.includes('addition')) {\r\n                day.stockAdded += delta;\r\n            } else if (reason.includes('transfer out')) {\r\n                day.transferOut += Math.abs(delta);\r\n            } else if (reason.includes('customer return')) {\r\n                day.returnIn += delta;\r\n            } else if (reason.includes('return to supplier')) {\r\n                day.returnOut += Math.abs(delta);\r\n            } else if (h.type !== 'SALE') {\r\n                day.adjustments += delta;\r\n            }\r\n            dailyTransactions.set(dateStr, day);\r\n        });\r\n\r\n        const sortedDates = Array.from(dailyTransactions.keys()).sort();\r\n        const dailyBreakdown = [];\r\n        let runningStock = openingStock;\r\n\r\n        for (const date of sortedDates) {\r\n            const day = dailyTransactions.get(date);\r\n            const startingStock = runningStock;\r\n            const endingStock = startingStock - day.itemsSold + day.stockAdded - day.transferOut + day.returnIn - day.returnOut + day.adjustments;\r\n\r\n            dailyBreakdown.push({\r\n                date,\r\n                startingStock,\r\n                ...day,\r\n                endingStock\r\n            });\r\n            runningStock = endingStock;\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                product: {\r\n                    id: product.id,\r\n                    name: product.name,\r\n                    quantity: product.stock,\r\n                    itemNumber: product.sku\r\n                },\r\n                currentStock: product.stock,\r\n                calculatedStock: runningStock,\r\n                discrepancy: product.stock - runningStock,\r\n                openingStock,\r\n                openingDate: openingDate?.toISOString(),\r\n                excludedSalesQty,\r\n                dailyBreakdown\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error in reconciliation action:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function getStockRepairsPreviewAction(businessId: string) {\r\n    try {\r\n        const products = await db.product.findMany({\r\n            where: { branchId: businessId },\r\n            select: { id: true, name: true, stock: true }\r\n        });\r\n\r\n        const brokenChains = [];\r\n\r\n        for (const product of products) {\r\n            const history = await db.productHistory.findMany({\r\n                where: { productId: product.id, locationId: businessId },\r\n                orderBy: [{ createdAt: 'asc' }, { id: 'asc' }]\r\n            });\r\n\r\n            if (history.length === 0) continue;\r\n\r\n            let runningQuantity = 0;\r\n            const brokenEntries = [];\r\n\r\n            for (const entry of history) {\r\n                const change = entry.newStock - entry.oldStock;\r\n                const expectedPrev = runningQuantity;\r\n                const expectedNext = expectedPrev + change;\r\n\r\n                if (entry.oldStock !== expectedPrev || entry.newStock !== expectedNext) {\r\n                    brokenEntries.push({\r\n                        entryId: entry.id,\r\n                        createdAt: entry.createdAt.toISOString(),\r\n                        changeReason: entry.changeReason,\r\n                        currentPrevQty: entry.oldStock,\r\n                        currentNewQty: entry.newStock,\r\n                        fixedPrevQty: expectedPrev,\r\n                        fixedNewQty: expectedNext\r\n                    });\r\n                }\r\n                runningQuantity = expectedNext;\r\n            }\r\n\r\n            if (brokenEntries.length > 0 || Math.abs(product.stock - runningQuantity) > 0.001) {\r\n                brokenChains.push({\r\n                    productId: product.id,\r\n                    productName: product.name,\r\n                    totalEntries: history.length,\r\n                    brokenEntries,\r\n                    finalFixedQty: runningQuantity,\r\n                    currentProductQty: product.stock\r\n                });\r\n            }\r\n        }\r\n\r\n        return { success: true, data: brokenChains };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function repairStockChainsAction(businessId: string, productIds?: string[]) {\r\n    try {\r\n        const ids = productIds || (await db.product.findMany({\r\n            where: { branchId: businessId },\r\n            select: { id: true }\r\n        })).map(p => p.id);\r\n\r\n        let repaired = 0;\r\n        let failed = 0;\r\n\r\n        for (const id of ids) {\r\n            try {\r\n                await recalculateStockChainAction(id, businessId);\r\n                repaired++;\r\n            } catch (err) {\r\n                failed++;\r\n            }\r\n        }\r\n\r\n        return { success: true, data: { repaired, failed } };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function getActivityByEntityIdsAction(entityIds: string[]) {\r\n    try {\r\n        const records = await db.activityHistory.findMany({\r\n            where: { entityId: { in: entityIds } },\r\n            select: { entityId: true, entityName: true }\r\n        });\r\n        return { success: true, data: records };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message, data: [] };\r\n    }\r\n}\r\n\r\nexport async function updateStockHistoryDatesAction(entryIds: string[], newDate: string) {\r\n    try {\r\n        await db.productHistory.updateMany({\r\n            where: { id: { in: entryIds } },\r\n            data: { createdAt: new Date(newDate) }\r\n        });\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n","\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { StockHistoryEntry } from '@/types';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\nimport {\r\n  getStockHistoryAction,\r\n  createStockHistoryAction,\r\n  recalculateStockChainAction,\r\n  deleteStockHistoryEntriesByReferenceAction,\r\n  updateStockHistoryDatesByReferenceAction,\r\n  repairStockChainsAction,\r\n  getStockRepairsPreviewAction\r\n} from '@/app/actions/inventory';\r\nimport { useAuth } from '@/components/auth/AuthProvider';\r\n\r\nexport interface ChainRepairBreakEntry {\r\n  entryId: string;\r\n  createdAt: string;\r\n  changeReason: string;\r\n  currentPrevQty: number;\r\n  currentNewQty: number;\r\n  fixedPrevQty: number;\r\n  fixedNewQty: number;\r\n}\r\n\r\nexport interface ChainRepairPreview {\r\n  productId: string;\r\n  productName: string;\r\n  totalEntries: number;\r\n  brokenEntries: ChainRepairBreakEntry[];\r\n  finalFixedQty: number;\r\n  currentProductQty: number;\r\n}\r\n\r\nexport const useStockHistory = (userId: string | undefined, productId?: string) => {\r\n  const [stockHistory, setStockHistory] = useState<StockHistoryEntry[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const { currentBusiness } = useBusiness();\r\n\r\n  const loadStockHistory = useCallback(async () => {\r\n    if (!userId || !currentBusiness) {\r\n      setStockHistory([]);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n      const result = await getStockHistoryAction(currentBusiness.id, productId);\r\n\r\n      if (!result.success || !result.data) {\r\n        throw new Error(result.error || 'Failed to fetch stock history');\r\n      }\r\n\r\n      const formattedHistory: StockHistoryEntry[] = result.data.map((entry: any) => ({\r\n        id: entry.id,\r\n        productId: entry.productId,\r\n        oldQuantity: entry.oldQuantity,\r\n        newQuantity: entry.newQuantity,\r\n        changeReason: entry.changeReason,\r\n        createdAt: new Date(entry.createdAt),\r\n        referenceId: entry.referenceId,\r\n        receiptNumber: entry.receiptNumber,\r\n        product: entry.product\r\n      }));\r\n\r\n      setStockHistory(formattedHistory);\r\n    } catch (error) {\r\n      console.error('Error loading stock history:', error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [userId, currentBusiness?.id, productId]);\r\n\r\n  useEffect(() => {\r\n    loadStockHistory();\r\n  }, [loadStockHistory]);\r\n\r\n  const createStockHistoryEntry = async (\r\n    targetProductId: string,\r\n    previousQuantity: number,\r\n    newQuantity: number,\r\n    reason: string,\r\n    referenceId?: string,\r\n    entryDate?: Date,\r\n    receiptNumber?: string,\r\n    productName?: string\r\n  ) => {\r\n    try {\r\n      if (!userId || !currentBusiness) return false;\r\n\r\n      const snapshottedReason = productName\r\n        ? `[${productName}] | ${reason}`\r\n        : reason;\r\n\r\n      const result = await createStockHistoryAction({\r\n        userId,\r\n        locationId: currentBusiness.id,\r\n        productId: targetProductId,\r\n        previousQuantity,\r\n        newQuantity,\r\n        changeReason: snapshottedReason,\r\n        referenceId,\r\n        receiptNumber,\r\n        createdAt: entryDate?.toISOString()\r\n      });\r\n\r\n      if (!result.success) {\r\n        console.error('Error creating stock history entry:', result.error);\r\n        return false;\r\n      }\r\n\r\n      await loadStockHistory();\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error creating stock history:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const deleteMultipleStockHistoryEntriesByReference = async (referenceId: string) => {\r\n    try {\r\n      if (!currentBusiness) return false;\r\n      const result = await deleteStockHistoryEntriesByReferenceAction(referenceId, currentBusiness.id);\r\n      if (!result.success) throw new Error(result.error);\r\n\r\n      await loadStockHistory();\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting stock history entries:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const recalculateStockChain = async (targetProductId: string) => {\r\n    try {\r\n      if (!currentBusiness) return false;\r\n      const result = await recalculateStockChainAction(targetProductId, currentBusiness.id);\r\n      if (!result.success) throw new Error(result.error);\r\n\r\n      await loadStockHistory();\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error recalculating stock chain:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const updateStockHistoryDatesBySaleId = async (saleId: string, newDate: Date) => {\r\n    try {\r\n      if (!currentBusiness) return false;\r\n      const result = await updateStockHistoryDatesByReferenceAction(saleId, currentBusiness.id, newDate.toISOString());\r\n      if (!result.success) throw new Error(result.error);\r\n\r\n      await loadStockHistory();\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating stock history dates:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const repairAllStockChains = async (progressCallback?: (current: number, total: number) => void) => {\r\n    try {\r\n      if (!currentBusiness) return { repaired: 0, failed: 0 };\r\n      const result = await repairStockChainsAction(currentBusiness.id);\r\n      if (result.success && result.data) return result.data;\r\n      return { repaired: 0, failed: 0 };\r\n    } catch (error) {\r\n      console.error('Error repairing all chains:', error);\r\n      return { repaired: 0, failed: 0 };\r\n    }\r\n  }\r\n\r\n  const previewStockChainRepairs = async (progressCallback?: (current: number, total: number) => void) => {\r\n    try {\r\n      if (!currentBusiness) return [];\r\n      const result = await getStockRepairsPreviewAction(currentBusiness.id);\r\n      if (result.success && result.data) return result.data;\r\n      return [];\r\n    } catch (error) {\r\n      console.error('Error previewing repairs:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  return {\r\n    stockHistory,\r\n    isLoading,\r\n    createStockHistoryEntry,\r\n    deleteMultipleStockHistoryEntriesByReference,\r\n    recalculateStockChain,\r\n    updateStockHistoryDatesBySaleId,\r\n    repairAllStockChains,\r\n    previewStockChainRepairs,\r\n    refreshHistory: loadStockHistory\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}