{"version":3,"sources":["../../../../src/utils/thermalPrinterNative.ts"],"sourcesContent":["import { Capacitor } from '@capacitor/core';\r\nimport { Storage } from '@capacitor/storage';\r\nimport BluetoothSpp from 'capacitor-bluetooth-spp';\r\n\r\nlet connectedDevice: string | null = null;\r\n\r\nBluetoothSpp.addListener('connected', (info) => console.log('Event: connected', info));\r\nBluetoothSpp.addListener('connectionFailed', (info) => console.log('Event: connectionFailed', info));\r\nBluetoothSpp.addListener('disconnected', (info) => console.log('Event: disconnected', info));\r\nBluetoothSpp.addListener('deviceFound', (device) => console.log('Event: deviceFound', device));\r\nBluetoothSpp.addListener('discoveryFinished', () => console.log('Event: discoveryFinished'));\r\n\r\nexport async function printBluetooth(data: string) {\r\n  if (!Capacitor.isNativePlatform()) {\r\n    return { success: false, message: 'Not a native platform' };\r\n  }\r\n\r\n  try {\r\n    await BluetoothSpp.requestPermissions();\r\n\r\n    // Try loading stored printer\r\n    const saved = await Storage.get({ key: 'selected_printer' });\r\n    let storedPrinter = saved.value;\r\n\r\n    // If the stored printer exists, try using it\r\n    if (storedPrinter) {\r\n      try {\r\n        console.log('Trying stored printer:', storedPrinter);\r\n        const res = await BluetoothSpp.connect({ address: storedPrinter });\r\n\r\n        if (res?.connected) {\r\n          connectedDevice = storedPrinter;\r\n          console.log('Connected using stored printer.');\r\n        } else {\r\n          storedPrinter = null; // fallback\r\n        }\r\n      } catch (_) {\r\n        console.log('Stored printer failed. Falling back to selection.');\r\n        storedPrinter = null;\r\n      }\r\n    }\r\n\r\n    // Fallback if no stored printer or it failed\r\n    if (!storedPrinter && !connectedDevice) {\r\n      console.log('Listing paired devices...');\r\n      const paired = await BluetoothSpp.listPairedDevices();\r\n\r\n      if (!paired?.devices?.length) {\r\n        throw new Error('No paired devices found');\r\n      }\r\n\r\n      const deviceNames = paired.devices.map((d) => d.name || d.address);\r\n\r\n      const selection = prompt(\r\n        `Select a Bluetooth device:\\n${deviceNames\r\n          .map((n, i) => `${i + 1}: ${n}`)\r\n          .join('\\n')}`,\r\n        '1'\r\n      );\r\n\r\n      const index = parseInt(selection || '1', 10) - 1;\r\n\r\n      if (index < 0 || index >= paired.devices.length) {\r\n        throw new Error('Invalid device selection');\r\n      }\r\n\r\n      const device = paired.devices[index];\r\n      console.log('Connecting to', device.name, device.address);\r\n\r\n      const connectRes = await BluetoothSpp.connect({ address: device.address });\r\n\r\n      if (!connectRes?.connected) throw new Error('Failed to connect');\r\n\r\n      connectedDevice = device.address;\r\n\r\n      // Store selected printer for future automatic use\r\n      await Storage.set({\r\n        key: 'selected_printer',\r\n        value: device.address,\r\n      });\r\n\r\n      console.log('Printer saved:', device.address);\r\n    }\r\n\r\n    // Send print data\r\n    await BluetoothSpp.write({ data });\r\n\r\n    // Feed paper (optional)\r\n    const feedLines = \"\\x1B\\x64\\x03\";\r\n    await BluetoothSpp.write({ data: feedLines });\r\n\r\n    return { success: true, message: 'Printed successfully' };\r\n\r\n  } catch (err: any) {\r\n    console.error('Bluetooth print failed:', err);\r\n    try { await BluetoothSpp.disconnect(); } catch (_) {}\r\n    connectedDevice = null;\r\n\r\n    return { success: false, message: err?.message || 'Unknown error' };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}