module.exports=[895363,a=>a.a(async(b,c)=>{try{var d=a.i(199105),e=a.i(411418),f=a.i(964889),g=a.i(805297),h=b([d,e,f,g]);[d,e,f,g]=h.then?(await h)():h,a.s(["useActivityLogger",0,()=>{let{userId:a}=(0,e.useCurrentUser)(),{currentBusiness:b}=(0,f.useBusiness)(),c=null;try{let{currentProfile:a}=(0,g.useProfiles)();c=a}catch{c=null}return{logActivity:async e=>{if(!a||!b?.id)return void console.warn("Cannot log activity: missing user or business context");try{let f=await (0,d.logActivityAction)({userId:a,locationId:b.id,activityType:e.activityType,module:e.module,entityType:e.entityType,entityId:e.entityId||void 0,entityName:e.entityName,description:e.description,metadata:e.metadata||void 0,profileId:c?.id||void 0,profileName:c?.profile_name||void 0});f.success||console.error("Error logging activity:",f.error)}catch(a){console.error("Failed to log activity:",a)}}}}]),c()}catch(a){c(a)}},!1),483123,a=>{"use strict";a.s(["mapDbProductToProduct",0,a=>({id:a.id,itemNumber:a.item_number,barcode:a.barcode,manufacturerBarcode:a.manufacturer_barcode,name:a.name,description:a.description,category:a.category,quantity:a.quantity,costPrice:Number(a.cost_price),sellingPrice:Number(a.selling_price),supplier:a.supplier,imageUrl:a.image_url,minimumStock:a.minimum_stock,createdAt:new Date(a.created_at),updatedAt:new Date(a.updated_at)}),"mapDbSaleToSale",0,a=>{let b=(Array.isArray(a.items)?a.items:[]).map(a=>{let b=void 0!==a.discountPercentage?Number(a.discountPercentage):void 0,c=void 0!==a.discountAmount?Number(a.discountAmount):void 0,d=a.discountType;return!d&&(b&&b>0?d="percentage":c&&c>0&&(d="amount")),{description:a.description||"",quantity:Number(a.quantity)||0,price:Number(a.price)||0,cost:Number(a.cost)||0,productId:a.productId||void 0,discountType:d,discountPercentage:b,discountAmount:c,createdAt:a.createdAt||void 0}});return{id:a.id,receiptNumber:a.receipt_number,customerName:a.customer_name,customerAddress:a.customer_address||"",customerContact:a.customer_contact||"",customerId:a.customer_id||void 0,items:b,paymentStatus:a.payment_status,profit:Number(a.profit),date:new Date(a.date),taxRate:a.tax_rate?Number(a.tax_rate):0,cashTransactionId:a.cash_transaction_id||void 0,amountPaid:a.amount_paid?Number(a.amount_paid):void 0,amountDue:a.amount_due?Number(a.amount_due):void 0,notes:a.notes||"",categoryId:a.category_id||void 0,createdAt:new Date(a.created_at)}},"mapSaleToDbSale",0,(a,b,c,d,e,f,g)=>({user_id:e,location_id:f,receipt_number:d,customer_name:a.customerName,customer_address:a.customerAddress||null,customer_contact:a.customerContact||null,customer_id:a.customerId||null,items:a.items,payment_status:a.paymentStatus,profit:c,date:b.toISOString().split("T")[0],tax_rate:a.taxRate||0,cash_transaction_id:g||null,amount_paid:a.amountPaid||null,amount_due:a.amountDue||null,notes:a.notes||null,category_id:a.categoryId||null})])},733290,a=>a.a(async(b,c)=>{try{var d=a.i(482331),e=a.i(169320),f=a.i(852741),g=b([d,e]);[d,e]=g.then?(await g)():g,a.s(["useInventoryActions",0,a=>{let{updateProductsBulk:b}=(0,d.useProducts)(a),c=async(a,b)=>{if(!a.length)return[];try{return await (0,f.getProductsByIdsAction)(a,b)}catch(a){throw console.error("Error fetching fresh products:",a),a}},g=async(d,f,g,h,i)=>{if(!a)return!1;try{let j=d.filter(a=>a.productId);if(0===j.length)return!0;let k=[...new Set(j.map(a=>a.productId))],l=await c(k,i);if(0===l.length)return!1;let m=new Map;for(let a of j){let b=m.get(a.productId)||0;m.set(a.productId,b+a.quantity)}let n=[];for(let[a,b]of m.entries()){let c=l.find(b=>b.id===a);if(!c)continue;let d=c.quantity-b;n.push({id:a,updated:{...c,quantity:d}}),d<0&&e.toast.warning(`${c.name} inventory is now negative (${d}). Please restock soon.`)}return n.length>0&&await b(n,a,"Sale",f,g,h),!0}catch(a){return console.error("Error deducting stock for sale:",a),!1}},h=async(d,e,f,g)=>{if(!a)return!1;try{let h=d.filter(a=>a.productId);if(0===h.length)return!0;let i=[...new Set(h.map(a=>a.productId))],j=await c(i,g),k=new Map;for(let a of h){let b=k.get(a.productId)||0;k.set(a.productId,b+a.quantity)}let l=[];for(let[a,b]of k.entries()){let c=j.find(b=>b.id===a);if(!c)continue;let d=c.quantity+b;l.push({id:a,updated:{...c,quantity:d}})}return l.length>0&&await b(l,a,"Deleted Sale",e,void 0,f),!0}catch(a){return console.error("Error restoring stock for sale:",a),!1}},i=async(d,f,g,h,i,j)=>{if(!a)return!1;try{let k=[...d.filter(a=>a.productId).map(a=>a.productId),...f.filter(a=>a.productId).map(a=>a.productId)],l=[...new Set(k)];if(0===l.length)return!0;let m=await c(l,j),n=new Map;for(let a of d.filter(a=>a.productId)){let b=n.get(a.productId)||0;n.set(a.productId,b+a.quantity)}for(let a of f.filter(a=>a.productId)){let b=n.get(a.productId)||0;n.set(a.productId,b-a.quantity)}let o=[];for(let[a,b]of n.entries()){if(0===b)continue;let c=m.find(b=>b.id===a);if(!c)continue;let d=c.quantity+b;o.push({id:a,updated:{...c,quantity:d}}),d<0&&e.toast.warning(`${c.name} inventory is now negative (${d}). Please restock soon.`)}return o.length>0&&await b(o,a,"Sale Status/Qty Edit",g,h,i),!0}catch(a){return console.error("Error adjusting stock for edited sale:",a),!1}};return{deductStockForSale:g,restoreStockForSale:h,adjustStockForEditedSale:i}}]),c()}catch(a){c(a)}},!1),392240,a=>a.a(async(b,c)=>{try{var d=a.i(150848),e=a.i(348287),f=b([d]);async function g(a,b="desc",c){try{let e={where:{branchId:a},orderBy:{createdAt:b},include:{cashTransaction:!0}};return c&&c>0&&(e.take=c),(await d.db.sale.findMany(e)).map(a=>({id:a.id,user_id:a.userId,location_id:a.branchId,receipt_number:a.saleNumber,customer_name:a.customerName,customer_address:a.customerAddress,customer_contact:a.customerPhone,customer_id:a.customerId,items:a.items,payment_status:a.paymentStatus,profit:0,date:a.date.toISOString(),tax_rate:a.taxRate?Number(a.taxRate):0,created_at:a.createdAt.toISOString(),updated_at:a.updatedAt.toISOString(),cash_transaction_id:a.cashTransactionId,amount_paid:Number(a.amountPaid),amount_due:Number(a.balance),category_id:a.categoryId,notes:a.notes}))}catch(a){return console.error("Error fetching sales:",a),[]}}async function h(a,b){try{let c=await d.db.sale.findUnique({where:{id:a},include:{cashTransaction:!0,installmentPayments:!0}});if(!c||c.branchId!==b)return{success:!1,error:"Sale not found or unauthorized"};return await d.db.$transaction(async b=>{await b.installmentPayment.deleteMany({where:{saleId:a}}),c.cashTransactionId&&await b.cashTransaction.delete({where:{id:c.cashTransactionId}}),await b.sale.delete({where:{id:a}})}),{success:!0,sale:{receiptNumber:c.saleNumber,customerName:c.customerName,customerAddress:c.customerAddress,customerContact:c.customerPhone,paymentStatus:c.paymentStatus,cashTransactionId:c.cashTransactionId,items:c.items,amountPaid:Number(c.amountPaid),amountDue:Number(c.balance),profit:0,taxRate:Number(c.taxRate),notes:c.notes}}}catch(a){return console.error("Error deleting sale:",a),{success:!1,error:a.message||"Failed to delete sale"}}}async function i(a,b,c){try{let e=a.payment_status;"NOT PAID"===e?e="UNPAID":"Installment Sale"===e?e="INSTALLMENT":"Paid"===e?e="PAID":"Quote"===e&&(e="QUOTE");let f={userId:a.user_id,branchId:a.location_id,saleNumber:a.receipt_number,customerName:a.customer_name,customerAddress:a.customer_address,customerPhone:a.customer_contact,customerId:a.customer_id,items:a.items,paymentStatus:e,date:new Date(a.date),taxRate:a.tax_rate,cashTransactionId:a.cash_transaction_id,amountPaid:a.amount_paid,balance:a.amount_due,categoryId:a.category_id,notes:a.notes,subtotal:0,total:0};if(b&&c){let a=await d.db.sale.update({where:{id:c},data:f});return{success:!0,data:a}}{let a=await d.db.sale.create({data:f});return{success:!0,data:a}}}catch(a){return console.error("Error upserting sale:",a),{success:!1,error:a.message||"Failed to preserve sale"}}}async function j(a){try{let b=await d.db.saleCategory.findMany({where:{branchId:a},orderBy:{name:"asc"}});return{success:!0,data:b}}catch(a){return console.error("Error fetching sales categories:",a),{success:!1,error:a.message}}}async function k(a,b,c,f=!1){try{let g=await d.db.saleCategory.create({data:{branchId:a,userId:b,name:c,is_default:f}});return(0,e.revalidatePath)("/sales"),{success:!0,data:g}}catch(a){return console.error("Error creating sales category:",a),{success:!1,error:a.message}}}async function l(a,b){try{let c=await d.db.saleCategory.update({where:{id:a},data:{name:b}});return(0,e.revalidatePath)("/sales"),{success:!0,data:c}}catch(a){return console.error("Error updating sales category:",a),{success:!1,error:a.message}}}async function m(a){try{return await d.db.saleCategory.delete({where:{id:a}}),(0,e.revalidatePath)("/sales"),{success:!0}}catch(a){return console.error("Error deleting sales category:",a),{success:!1,error:a.message}}}async function n(a,b){if(!a||!b)return null;try{return await d.db.customer.findFirst({where:{branchId:a,name:{contains:b,mode:"insensitive"}},select:{id:!0,name:!0}})}catch(a){return console.error("Error looking up customer by name:",a),null}}async function o(a,b){try{return await d.db.sale.update({where:{id:a},data:{customerId:b}}),{success:!0}}catch(a){return console.error("Error updating sale customer:",a),{success:!1,error:a.message}}}async function h(a){try{return await d.db.sale.delete({where:{id:a}}),(0,e.revalidatePath)("/sales"),!0}catch(a){return console.error("Error deleting sale:",a),!1}}[d]=f.then?(await f)():f,a.s(["createSalesCategoryAction",()=>k,"deleteSaleAction",()=>h,"deleteSalesCategoryAction",()=>m,"getCustomerByNameAction",()=>n,"getSalesAction",()=>g,"getSalesCategoriesAction",()=>j,"updateSaleCustomerAction",()=>o,"updateSalesCategoryAction",()=>l,"upsertSaleAction",()=>i]),c()}catch(a){c(a)}},!1),385375,a=>a.a(async(b,c)=>{try{var d=a.i(127669),e=a.i(483123),f=a.i(108191),g=a.i(500885),h=a.i(895363),i=a.i(964889),j=a.i(733290),k=a.i(121677),l=a.i(392240),m=b([g,h,i,j,l]);[g,h,i,j,l]=m.then?(await m)():m,a.s(["useSalesData",0,(a,b="desc",c)=>{let m=(0,g.useQueryClient)(),{toast:n}=(0,f.useToast)(),{logActivity:o}=(0,h.useActivityLogger)(),{currentBusiness:p}=(0,i.useBusiness)(),{restoreStockForSale:q}=(0,j.useInventoryActions)(a),r=(0,d.useCallback)(async()=>{try{if(!a||!p)return[];let d=await (0,l.getSalesAction)(p.id,b,c);return d?d.map(a=>{let b={id:a.id,user_id:a.user_id,location_id:a.location_id,receipt_number:a.receipt_number,customer_name:a.customer_name,customer_address:a.customer_address,customer_contact:a.customer_contact,customer_id:a.customer_id,items:a.items,payment_status:a.payment_status,profit:a.profit?Number(a.profit):0,date:a.date,tax_rate:a.tax_rate||0,created_at:a.created_at,updated_at:a.updated_at,cash_transaction_id:a.cash_transaction_id,amount_paid:a.amount_paid?Number(a.amount_paid):void 0,amount_due:a.amount_due?Number(a.amount_due):void 0,category_id:a.category_id,notes:a.notes};return(0,e.mapDbSaleToSale)(b)}):[]}catch(a){return console.error("Error loading sales:",a),n({title:"Error",description:"Failed to load sales data. Please try again.",variant:"destructive"}),[]}},[a,p?.id,b,c,n]),s=(0,d.useMemo)(()=>["sales",p?.id,a],[p?.id,a]),t=(0,d.useMemo)(()=>[...s,b,c],[s,b,c]),{data:u=[],isLoading:v,isFetching:w,refetch:x}=(0,g.useQuery)({queryKey:t,queryFn:r,enabled:!!a&&!!p?.id,staleTime:3e4,gcTime:18e5,refetchOnWindowFocus:!0,refetchOnReconnect:!0}),y=v||w&&0===u.length,z=(0,d.useMemo)(()=>{let a=u.filter(a=>"Quote"!==a.paymentStatus),b=new Map;return a.forEach(a=>{let c=a.customerName,d=a.items.reduce((a,b)=>a+b.price*b.quantity,0);if(b.has(c)){let e=b.get(c);b.set(c,{total:e.total+d,count:e.count+1,customerId:e.customerId||a.customerId})}else b.set(c,{total:d,count:1,customerId:a.customerId})}),Array.from(b.entries()).map(([a,b])=>({id:b.customerId,name:a,totalPurchases:b.total,orderCount:b.count})).sort((a,b)=>b.totalPurchases-a.totalPurchases)},[u]),A=(0,d.useMemo)(()=>a=>{let b=u.filter(b=>b.customerName.toLowerCase()===a.toLowerCase()&&"Quote"!==b.paymentStatus);return{total:b.reduce((a,b)=>a+b.items.reduce((a,b)=>a+b.price*b.quantity,0),0),count:b.length}},[u]),B=async a=>{try{let b=u.find(b=>b.id===a);if(!b)throw Error("Sale not found");if("Quote"!==b.paymentStatus&&b.items.length>0&&(console.log("Restoring product quantities via useInventoryActions..."),await q(b.items,a,b.receiptNumber,p?.id)||n({title:"Inventory Update Warning",description:"Sale deleted, but inventory restoration might have failed. Please check your stock levels.",variant:"destructive"})),!p?.id)throw Error("Business context missing for deletion");let c=await (0,l.deleteSaleAction)(a,p.id);if(!c.success)throw Error(c.error);return m.setQueryData(t,b=>b?b.filter(b=>b.id!==a):[]),m.invalidateQueries({queryKey:s}),C(),await o({activityType:"DELETE",module:"SALES",entityType:"sale",entityId:a,entityName:`Sale #${b.receiptNumber}`,description:`Deleted sale for ${b.customerName} - Total: UGX ${((b.amountPaid||0)+(b.amountDue||0)).toLocaleString()} (Stock restored)`,metadata:{receiptNumber:b.receiptNumber,customerName:b.customerName,customerAddress:b.customerAddress,customerContact:b.customerContact,totalAmount:(b.amountPaid||0)+(b.amountDue||0),amountPaid:b.amountPaid,profit:b.profit,paymentStatus:b.paymentStatus,taxRate:b.taxRate,itemCount:b.items.length,items:b.items.map(a=>({description:a.description,quantity:a.quantity,price:a.price,cost:a.cost,total:a.quantity*a.price,discountPercentage:a.discountPercentage,discountAmount:a.discountAmount})),notes:b.notes,cashTransactionDeleted:!!b.cashTransactionId}}),n({title:"Sale Deleted",description:"The sale record and associated data have been successfully deleted."}),(0,k.clearInventoryCaches)(),!0}catch(a){return console.error("Error deleting sale:",a),n({title:"Error",description:"Failed to delete sale. Please try again.",variant:"destructive"}),!1}},C=(0,d.useCallback)(()=>{if(!p?.id)return;let a=`soldItemsFilters_${p.id}`;localStorage.removeItem(a),localStorage.removeItem("soldItemsFilters")},[p?.id]),D=(0,d.useCallback)(a=>{m.setQueryData(t,b=>b?[a,...b]:[a]),m.invalidateQueries({queryKey:s}),C(),(0,k.clearInventoryCaches)()},[m,t,s,C,k.clearInventoryCaches]),E=(0,d.useCallback)(a=>{m.setQueryData(t,b=>b?b.map(b=>b.id===a.id?a:b):[a]),m.invalidateQueries({queryKey:s}),C(),(0,k.clearInventoryCaches)()},[m,t,s,C,k.clearInventoryCaches]);return{sales:u,isLoading:y,deleteSale:B,addSale:D,updateSale:E,getTopCustomers:z,getCustomerLifetimePurchases:A,clearSoldItemsCache:C,refetch:x,isFetching:w}}]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=src_b05f2ad3._.js.map