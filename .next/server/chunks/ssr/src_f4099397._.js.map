{"version":3,"sources":["../../../../src/types/index.ts","../../../../src/hooks/useActivityLogger.ts","../../../../src/hooks/useInventoryActions.ts","../../../../src/app/actions/sales.ts","../../../../src/hooks/useSalesData.ts"],"sourcesContent":["// Sale item type definition\r\nexport interface SaleItem {\r\n  description: string;\r\n  quantity: number;\r\n  price: number;\r\n  cost: number;\r\n  productId?: string;\r\n  discountPercentage?: number;\r\n  discountType?: 'percentage' | 'amount';\r\n  discountAmount?: number;\r\n}\r\n\r\nexport interface SalesCategory {\r\n  id: string;\r\n  user_id: string;\r\n  location_id?: string;\r\n  name: string;\r\n  is_default: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface Sale {\r\n  id: string;\r\n  receiptNumber: string;\r\n  customerName: string;\r\n  customerAddress?: string;\r\n  customerContact?: string;\r\n  customerId?: string;\r\n  items: SaleItem[];\r\n  paymentStatus: 'Paid' | 'NOT PAID' | 'Quote' | 'Installment Sale';\r\n  profit: number;\r\n  date: Date;\r\n  taxRate?: number;\r\n  cashTransactionId?: string;\r\n  amountPaid?: number;\r\n  amountDue?: number;\r\n  notes?: string;\r\n  categoryId?: string;\r\n  installments?: Array<{\r\n    date?: string | Date;\r\n    amountPaid?: number;\r\n  }>;\r\n  createdAt: Date;\r\n}\r\n\r\n// Supabase database schema and Json type\r\nexport type Json =\r\n  | string\r\n  | number\r\n  | boolean\r\n  | null\r\n  | { [key: string]: Json | undefined }\r\n  | Json[];\r\n\r\n// Supabase database sale structure\r\nexport interface DbSale {\r\n  id: string;\r\n  user_id: string;\r\n  location_id: string;\r\n  receipt_number: string;\r\n  customer_name: string;\r\n  customer_address?: string | null;\r\n  customer_contact?: string | null;\r\n  customer_id?: string | null;\r\n  items: Json;\r\n  payment_status: string;\r\n  profit: number;\r\n  date: string;\r\n  tax_rate?: number | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n  cash_transaction_id?: string | null;\r\n  amount_paid?: number | null;\r\n  amount_due?: number | null;\r\n  notes?: string | null;\r\n  category_id?: string | null;\r\n}\r\n\r\n// Expense interface - add cashTransactionId field\r\nexport interface Expense {\r\n  id: string;\r\n  amount: number;\r\n  description: string;\r\n  category: string | null;\r\n  date: Date;\r\n  paymentMethod: string | null;\r\n  personInCharge: string | null;\r\n  receiptImage: string | null;\r\n  cashAccountId: string | null;\r\n  cashTransactionId: string | null; // Add this field\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\n// Supabase database expense structure\r\nexport interface DbExpense {\r\n  id: string;\r\n  user_id: string;\r\n  amount: number;\r\n  description: string;\r\n  category: string | null;\r\n  date: string;\r\n  payment_method: string | null;\r\n  person_in_charge: string | null;\r\n  receipt_image: string | null;\r\n  cash_account_id: string | null;\r\n  cash_transaction_id: string | null; // Add this field\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface SaleFormData {\r\n  customerName: string;\r\n  customerAddress: string;\r\n  customerContact: string;\r\n  customerId?: string; // Added customerId field\r\n  items: SaleItem[];\r\n  paymentStatus: \"Paid\" | \"NOT PAID\" | \"Quote\" | \"Installment Sale\";\r\n  receiptNumber?: string;\r\n  taxRate?: number | null;\r\n  amountPaid?: number;\r\n  amountDue?: number;\r\n  notes?: string;\r\n  categoryId?: string;\r\n}\r\n\r\n// Analytics data type\r\nexport interface AnalyticsData {\r\n  totalSales: number;\r\n  totalProfit: number;\r\n  totalCost: number;\r\n  paidSalesCount: number;\r\n  pendingSalesCount: number;\r\n}\r\n\r\n// Form validation errors\r\nexport interface FormErrors {\r\n  customerName?: string;\r\n  customerAddress?: string;\r\n  customerContact?: string;\r\n  itemDescription?: string;\r\n  quantity?: string;\r\n  salePrice?: string;\r\n  costOfProduction?: string;\r\n  taxRate?: string;\r\n}\r\n\r\n// BusinessSettings interface to include paymentInfo\r\nexport interface BusinessSettings {\r\n  businessName: string;\r\n  businessAddress: string;\r\n  businessPhone: string;\r\n  businessEmail: string;\r\n  businessLogo?: string;\r\n  currency: string;\r\n  signature?: string;\r\n  paymentInfo?: string; // Added payment information field\r\n  defaultPrintFormat?: 'standard' | 'thermal'; // Added default print format\r\n  defaultPrinterName?: string; // Added default printer name\r\n  defaultPrinterType?: 'USB' | 'Bluetooth'; // Added default printer type\r\n}\r\n\r\n// Database business settings structure\r\nexport interface DbBusinessSettings {\r\n  id?: string;\r\n  user_id: string; // Make sure this is required, not optional\r\n  business_name: string;\r\n  business_address: string;\r\n  business_phone: string;\r\n  business_email: string;\r\n  business_logo?: string;\r\n  currency: string;\r\n  signature?: string;\r\n  metadata?: Json | null; // Add metadata field\r\n  created_at?: string;\r\n  updated_at?: string;\r\n}\r\n\r\n// Updated UserProfile interface to match the Supabase database structure\r\nexport interface UserProfile {\r\n  id: string;\r\n  full_name: string | null;\r\n  display_name: string | null;\r\n  avatar_url: string | null;\r\n  created_at: string | null;\r\n  updated_at: string | null;\r\n}\r\n\r\n// New interfaces for Product management - ADDED itemNumber\r\nexport interface Product {\r\n  id: string;\r\n  itemNumber: string; // Added item number field\r\n  barcode: string | null; // Added barcode field\r\n  manufacturerBarcode: string | null; // Added manufacturer barcode field\r\n  name: string;\r\n  description: string | null;\r\n  category: string;\r\n  quantity: number;\r\n  costPrice: number;\r\n  sellingPrice: number;\r\n  supplier: string | null;\r\n  imageUrl: string | null;\r\n  minimumStock: number;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface DbProduct {\r\n  id: string;\r\n  user_id: string;\r\n  item_number: string; // Added item number field\r\n  barcode: string | null; // Added barcode field\r\n  manufacturer_barcode: string | null; // Added manufacturer barcode field\r\n  name: string;\r\n  description: string | null;\r\n  category: string;\r\n  quantity: number;\r\n  cost_price: number;\r\n  selling_price: number;\r\n  supplier: string | null;\r\n  image_url: string | null;\r\n  minimum_stock: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface ProductFormData {\r\n  name: string;\r\n  barcode?: string; // Added barcode field\r\n  manufacturerBarcode?: string; // Added manufacturer barcode field\r\n  description?: string;\r\n  category?: string;\r\n  quantity: number; // Always a number, never undefined\r\n  costPrice?: number;\r\n  sellingPrice?: number;\r\n  supplier?: string;\r\n  minimumStock?: number;\r\n  imageFile?: File | null;\r\n  imageUrl?: string | null;\r\n  createdAt?: Date; // Added created date field\r\n}\r\n\r\nexport interface ProductCategory {\r\n  id: string;\r\n  name: string;\r\n  createdAt?: Date;\r\n}\r\n\r\nexport interface DbProductCategory {\r\n  id: string;\r\n  user_id: string;\r\n  name: string;\r\n  created_at: string;\r\n}\r\n\r\nexport interface StockHistoryEntry {\r\n  id: string;\r\n  productId: string;\r\n  oldQuantity: number;\r\n  newQuantity: number;\r\n  changeReason: string;\r\n  referenceId?: string | null;\r\n  receiptNumber?: string;\r\n  createdAt: Date;\r\n  product?: {\r\n    name: string;\r\n    costPrice: number;\r\n    sellingPrice: number;\r\n    itemNumber: string;\r\n  };\r\n}\r\n\r\nexport interface DbStockHistoryEntry {\r\n  id: string;\r\n  user_id: string;\r\n  product_id: string;\r\n  previous_quantity: number;\r\n  new_quantity: number;\r\n  change_reason: string;\r\n  reference_id?: string | null;\r\n  created_at: string;\r\n}\r\n\r\nexport interface ProductFilters {\r\n  search: string;\r\n  category: string;\r\n  stockStatus: 'all' | 'inStock' | 'lowStock' | 'outOfStock';\r\n}\r\n\r\n// Customer management types\r\nexport interface Customer {\r\n  id: string;\r\n  fullName: string;\r\n  email: string | null;\r\n  phoneNumber: string | null;\r\n  birthday: Date | null;\r\n  location: string | null;\r\n  categoryId: string | null; // Added category relationship\r\n  socialMedia: {\r\n    facebook?: string;\r\n    instagram?: string;\r\n    twitter?: string;\r\n    linkedin?: string;\r\n    other?: string;\r\n  } | null;\r\n  gender: string | null;\r\n  tags: string[] | null;\r\n  notes: string | null;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface DbCustomer {\r\n  id: string;\r\n  user_id: string;\r\n  full_name: string;\r\n  email: string | null;\r\n  phone_number: string | null;\r\n  birthday: string | null;\r\n  location: string | null;\r\n  category_id: string | null; // Added category relationship\r\n  social_media: Json | null;\r\n  gender: string | null;\r\n  tags: string[] | null;\r\n  notes: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface CustomerFormData {\r\n  fullName: string;\r\n  email: string;\r\n  phoneNumber: string;\r\n  birthday: Date | null;\r\n  location: string;\r\n  categoryId: string | null; // Added category field\r\n  socialMedia: {\r\n    facebook?: string;\r\n    instagram?: string;\r\n    twitter?: string;\r\n    linkedin?: string;\r\n    other?: string;\r\n  };\r\n  gender: string;\r\n  tags: string[];\r\n  notes: string;\r\n}\r\n\r\n// Utility functions for database conversions\r\nexport const mapDbSaleToSale = (dbSale: DbSale): Sale => {\r\n  // Parse items and ensure numeric fields are numbers, not strings\r\n  // This is critical for discount calculations to work correctly\r\n  const items = (Array.isArray(dbSale.items) ? dbSale.items : []).map((item: any) => {\r\n    const discountPercentage = item.discountPercentage !== undefined ? Number(item.discountPercentage) : undefined;\r\n    const discountAmount = item.discountAmount !== undefined ? Number(item.discountAmount) : undefined;\r\n\r\n    // Infer discountType if missing (for legacy data)\r\n    let discountType = item.discountType as 'percentage' | 'amount' | undefined;\r\n    if (!discountType) {\r\n      if (discountPercentage && discountPercentage > 0) {\r\n        discountType = 'percentage';\r\n      } else if (discountAmount && discountAmount > 0) {\r\n        discountType = 'amount';\r\n      }\r\n    }\r\n\r\n    return {\r\n      description: item.description || '',\r\n      quantity: Number(item.quantity) || 0,\r\n      price: Number(item.price) || 0,\r\n      cost: Number(item.cost) || 0,\r\n      productId: item.productId || undefined,\r\n      discountType,\r\n      discountPercentage,\r\n      discountAmount,\r\n      createdAt: item.createdAt || undefined,\r\n    };\r\n  }) as SaleItem[];\r\n\r\n  return {\r\n    id: dbSale.id,\r\n    receiptNumber: dbSale.receipt_number,\r\n    customerName: dbSale.customer_name,\r\n    customerAddress: dbSale.customer_address || '',\r\n    customerContact: dbSale.customer_contact || '',\r\n    customerId: dbSale.customer_id || undefined,\r\n    items,\r\n    paymentStatus: dbSale.payment_status as 'Paid' | 'NOT PAID' | 'Quote' | 'Installment Sale',\r\n    profit: Number(dbSale.profit),\r\n    date: new Date(dbSale.date),\r\n    taxRate: dbSale.tax_rate ? Number(dbSale.tax_rate) : 0,\r\n    cashTransactionId: dbSale.cash_transaction_id || undefined,\r\n    amountPaid: dbSale.amount_paid ? Number(dbSale.amount_paid) : undefined,\r\n    amountDue: dbSale.amount_due ? Number(dbSale.amount_due) : undefined,\r\n    notes: dbSale.notes || '',\r\n    categoryId: dbSale.category_id || undefined,\r\n    createdAt: new Date(dbSale.created_at),\r\n  };\r\n};\r\n\r\nexport const mapSaleToDbSale = (\r\n  saleData: SaleFormData,\r\n  selectedDate: Date,\r\n  profit: number,\r\n  receiptNumber: string,\r\n  userId: string,\r\n  locationId: string,\r\n  cashTransactionId?: string | null\r\n): Omit<DbSale, 'id' | 'created_at' | 'updated_at'> => {\r\n  return {\r\n    user_id: userId,\r\n    location_id: locationId,\r\n    receipt_number: receiptNumber,\r\n    customer_name: saleData.customerName,\r\n    customer_address: saleData.customerAddress || null,\r\n    customer_contact: saleData.customerContact || null,\r\n    customer_id: saleData.customerId || null, // Include customer_id\r\n    items: (saleData.items as unknown) as Json,\r\n    payment_status: saleData.paymentStatus,\r\n    profit: profit,\r\n    date: selectedDate.toISOString().split('T')[0],\r\n    tax_rate: saleData.taxRate || 0,\r\n    cash_transaction_id: cashTransactionId || null,\r\n    amount_paid: saleData.amountPaid || null,\r\n    amount_due: saleData.amountDue || null,\r\n    notes: saleData.notes || null,\r\n    category_id: saleData.categoryId || null,\r\n  };\r\n};\r\n\r\n// Conversion functions for business settings\r\nexport const mapDbBusinessSettingsToBusinessSettings = (dbSettings: DbBusinessSettings): BusinessSettings => {\r\n  return {\r\n    businessName: dbSettings.business_name,\r\n    businessAddress: dbSettings.business_address,\r\n    businessPhone: dbSettings.business_phone,\r\n    businessEmail: dbSettings.business_email,\r\n    businessLogo: dbSettings.business_logo,\r\n    currency: dbSettings.currency,\r\n    signature: dbSettings.signature,\r\n    paymentInfo: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).payment_info as string || '' : '',\r\n    defaultPrintFormat: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).default_print_format as 'standard' | 'thermal' || 'standard' : 'standard',\r\n    defaultPrinterName: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).default_printer_name as string || '' : '',\r\n    defaultPrinterType: dbSettings.metadata && typeof dbSettings.metadata === 'object' ?\r\n      (dbSettings.metadata as Record<string, unknown>).default_printer_type as 'USB' | 'Bluetooth' || 'USB' : 'USB'\r\n  };\r\n};\r\n\r\nexport const mapBusinessSettingsToDbBusinessSettings = (\r\n  settings: BusinessSettings,\r\n  userId: string\r\n): DbBusinessSettings => {\r\n  // Create metadata object with payment_info\r\n  const metadata: Json = {\r\n    payment_info: settings.paymentInfo || '',\r\n    default_print_format: settings.defaultPrintFormat || 'standard',\r\n    default_printer_name: settings.defaultPrinterName || '',\r\n    default_printer_type: settings.defaultPrinterType || 'USB'\r\n  };\r\n\r\n  return {\r\n    user_id: userId,\r\n    business_name: settings.businessName,\r\n    business_address: settings.businessAddress,\r\n    business_phone: settings.businessPhone,\r\n    business_email: settings.businessEmail,\r\n    business_logo: settings.businessLogo,\r\n    currency: settings.currency,\r\n    signature: settings.signature,\r\n    metadata: metadata, // Include metadata in the return object\r\n    updated_at: new Date().toISOString()\r\n  };\r\n};\r\n\r\n// Conversion functions for products and categories - ADDED itemNumber\r\nexport const mapDbProductToProduct = (dbProduct: DbProduct): Product => {\r\n  return {\r\n    id: dbProduct.id,\r\n    itemNumber: dbProduct.item_number, // Added item number mapping\r\n    barcode: dbProduct.barcode, // Added barcode mapping\r\n    manufacturerBarcode: dbProduct.manufacturer_barcode, // Added manufacturer barcode mapping\r\n    name: dbProduct.name,\r\n    description: dbProduct.description,\r\n    category: dbProduct.category,\r\n    quantity: dbProduct.quantity,\r\n    costPrice: Number(dbProduct.cost_price),\r\n    sellingPrice: Number(dbProduct.selling_price),\r\n    supplier: dbProduct.supplier,\r\n    imageUrl: dbProduct.image_url,\r\n    minimumStock: dbProduct.minimum_stock,\r\n    createdAt: new Date(dbProduct.created_at),\r\n    updatedAt: new Date(dbProduct.updated_at)\r\n  };\r\n};\r\n\r\nexport const mapProductToDbProduct = (product: Partial<Product>, userId: string): Partial<DbProduct> => {\r\n  const result: Partial<DbProduct> = {\r\n    user_id: userId\r\n  };\r\n\r\n  if (product.id) result.id = product.id;\r\n  if (product.itemNumber) result.item_number = product.itemNumber; // Added item number mapping\r\n  if (product.barcode !== undefined) result.barcode = product.barcode; // Added barcode mapping\r\n  if (product.manufacturerBarcode !== undefined) result.manufacturer_barcode = product.manufacturerBarcode; // Added manufacturer barcode mapping\r\n  if (product.name) result.name = product.name;\r\n  result.description = product.description;\r\n  if (product.category) result.category = product.category;\r\n  if (product.quantity !== undefined) result.quantity = product.quantity;\r\n  if (product.costPrice !== undefined) {\r\n    result.cost_price = product.costPrice;\r\n    console.log(`DEBUG: Mapping costPrice ${product.costPrice} to cost_price`);\r\n  }\r\n  if (product.sellingPrice !== undefined) {\r\n    result.selling_price = product.sellingPrice;\r\n    console.log(`DEBUG: Mapping sellingPrice ${product.sellingPrice} to selling_price`);\r\n  }\r\n  result.supplier = product.supplier;\r\n  result.image_url = product.imageUrl;\r\n  if (product.minimumStock !== undefined) result.minimum_stock = product.minimumStock;\r\n\r\n  return result;\r\n};\r\n\r\nexport const mapDbProductCategoryToProductCategory = (dbCategory: DbProductCategory): ProductCategory => {\r\n  return {\r\n    id: dbCategory.id,\r\n    name: dbCategory.name\r\n  };\r\n};\r\n\r\nexport const mapDbStockHistoryToStockHistory = (dbHistory: DbStockHistoryEntry): StockHistoryEntry => {\r\n  return {\r\n    id: dbHistory.id,\r\n    productId: dbHistory.product_id,\r\n    oldQuantity: dbHistory.previous_quantity,\r\n    newQuantity: dbHistory.new_quantity,\r\n    changeReason: dbHistory.change_reason,\r\n    referenceId: dbHistory.reference_id || null,\r\n    createdAt: new Date(dbHistory.created_at)\r\n  };\r\n};\r\n\r\n// Updated Customer mapping functions to include categoryId\r\nexport const mapDbCustomerToCustomer = (dbCustomer: DbCustomer): Customer => {\r\n  let birthday = null;\r\n\r\n  if (dbCustomer.birthday) {\r\n    try {\r\n      const birthdayStr = String(dbCustomer.birthday);\r\n      const [year, month, day] = birthdayStr.split('-').map(Number);\r\n\r\n      if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {\r\n        birthday = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));\r\n\r\n        console.log(\r\n          'Converting DB birthday to Date object:',\r\n          dbCustomer.birthday,\r\n          'â†’',\r\n          birthday,\r\n          '(UTC string:',\r\n          birthday.toISOString(),\r\n          ')'\r\n        );\r\n      } else {\r\n        console.error('Invalid date components in birthday:', dbCustomer.birthday);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error parsing birthday:', error, dbCustomer.birthday);\r\n    }\r\n  }\r\n\r\n  return {\r\n    id: dbCustomer.id,\r\n    fullName: dbCustomer.full_name,\r\n    email: dbCustomer.email,\r\n    phoneNumber: dbCustomer.phone_number,\r\n    birthday: birthday,\r\n    location: dbCustomer.location,\r\n    categoryId: dbCustomer.category_id, // Added category mapping\r\n    socialMedia: dbCustomer.social_media as any,\r\n    gender: dbCustomer.gender,\r\n    tags: dbCustomer.tags,\r\n    notes: dbCustomer.notes,\r\n    createdAt: new Date(dbCustomer.created_at),\r\n    updatedAt: new Date(dbCustomer.updated_at)\r\n  };\r\n};\r\n\r\nexport const mapCustomerToDbCustomer = (customer: Partial<Customer>, userId: string): Partial<DbCustomer> => {\r\n  const result: Partial<DbCustomer> = {\r\n    user_id: userId\r\n  };\r\n\r\n  if (customer.id) result.id = customer.id;\r\n  if (customer.fullName) result.full_name = customer.fullName;\r\n  result.email = customer.email;\r\n  result.phone_number = customer.phoneNumber;\r\n  if (customer.birthday) result.birthday = customer.birthday.toISOString().split('T')[0];\r\n  result.location = customer.location;\r\n  result.category_id = customer.categoryId; // Added category mapping\r\n  result.social_media = customer.socialMedia as Json;\r\n  result.gender = customer.gender;\r\n  result.tags = customer.tags;\r\n  result.notes = customer.notes;\r\n\r\n  return result;\r\n};\r\n\r\n// Conversion functions for expenses\r\nexport const mapDbExpenseToExpense = (dbExpense: DbExpense): Expense => {\r\n  return {\r\n    id: dbExpense.id,\r\n    amount: Number(dbExpense.amount),\r\n    description: dbExpense.description,\r\n    category: dbExpense.category,\r\n    date: new Date(dbExpense.date),\r\n    paymentMethod: dbExpense.payment_method,\r\n    personInCharge: dbExpense.person_in_charge,\r\n    receiptImage: dbExpense.receipt_image,\r\n    cashAccountId: dbExpense.cash_account_id,\r\n    cashTransactionId: dbExpense.cash_transaction_id,\r\n    createdAt: new Date(dbExpense.created_at),\r\n    updatedAt: new Date(dbExpense.updated_at)\r\n  };\r\n};\r\n\r\nexport const mapExpenseToDbExpense = (expense: Partial<Expense>, userId: string): Partial<DbExpense> => {\r\n  const result: Partial<DbExpense> = {\r\n    user_id: userId\r\n  };\r\n\r\n  if (expense.id) result.id = expense.id;\r\n  if (expense.amount !== undefined) result.amount = expense.amount;\r\n  if (expense.description) result.description = expense.description;\r\n  result.category = expense.category;\r\n  if (expense.date) result.date = expense.date.toISOString().split('T')[0];\r\n  result.payment_method = expense.paymentMethod;\r\n  result.person_in_charge = expense.personInCharge;\r\n  result.receipt_image = expense.receiptImage;\r\n  result.cash_account_id = expense.cashAccountId;\r\n  result.cash_transaction_id = expense.cashTransactionId;\r\n\r\n  return result;\r\n};\r\n","import { logActivityAction, ActivityLogInput } from '@/app/actions/activity';\r\nimport { useCurrentUser } from './useCurrentUser';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\nimport { useProfiles } from '@/contexts/ProfileContext';\r\n\r\nexport type ActivityType = 'CREATE' | 'UPDATE' | 'DELETE';\r\nexport type ModuleType = 'SALES' | 'INVENTORY' | 'EXPENSES' | 'FINANCE' | 'CUSTOMERS' | 'TASKS';\r\n\r\nexport interface ActivityLogData {\r\n  activityType: ActivityType;\r\n  module: ModuleType;\r\n  entityType: string;\r\n  entityId?: string;\r\n  entityName: string;\r\n  description: string;\r\n  metadata?: any;\r\n}\r\n\r\nexport const useActivityLogger = () => {\r\n  const { userId } = useCurrentUser();\r\n  const { currentBusiness } = useBusiness();\r\n\r\n  // Safely get current profile, handle case where ProfileProvider isn't available\r\n  let currentProfile = null;\r\n  try {\r\n    const { currentProfile: profile } = useProfiles();\r\n    currentProfile = profile;\r\n  } catch {\r\n    // ProfileProvider not available, continue without profile\r\n    currentProfile = null;\r\n  }\r\n\r\n  const logActivity = async (data: ActivityLogData) => {\r\n    if (!userId || !currentBusiness?.id) {\r\n      console.warn('Cannot log activity: missing user or business context');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await logActivityAction({\r\n        userId: userId,\r\n        locationId: currentBusiness.id,\r\n        activityType: data.activityType as any,\r\n        module: data.module as any,\r\n        entityType: data.entityType,\r\n        entityId: data.entityId || undefined,\r\n        entityName: data.entityName,\r\n        description: data.description,\r\n        metadata: data.metadata || undefined,\r\n        profileId: currentProfile?.id || undefined,\r\n        profileName: currentProfile?.profile_name || undefined\r\n      });\r\n\r\n      if (!result.success) {\r\n        console.error('Error logging activity:', result.error);\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to log activity:', error);\r\n    }\r\n  };\r\n\r\n  return { logActivity };\r\n};","import { useProducts } from './useProducts';\r\nimport { SaleItem, Product } from '@/types';\r\nimport { toast } from 'sonner';\r\nimport { getProductsByIdsAction } from '@/app/actions/products';\r\n\r\nexport const useInventoryActions = (userId: string | undefined) => {\r\n    const { updateProductsBulk } = useProducts(userId);\r\n\r\n    /**\r\n     * Helper to fetch fresh product data from DB to avoid race conditions/stale data\r\n     */\r\n    const fetchFreshProducts = async (productIds: string[], locationId?: string) => {\r\n        if (!productIds.length) return [];\r\n\r\n        try {\r\n            const result = await getProductsByIdsAction(productIds, locationId);\r\n            return result as Product[];\r\n        } catch (error) {\r\n            console.error('Error fetching fresh products:', error);\r\n            throw error;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Deduct stock for a new sale\r\n     */\r\n    const deductStockForSale = async (\r\n        items: SaleItem[],\r\n        saleId?: string,\r\n        saleDate?: Date,\r\n        receiptNumber?: string,\r\n        locationId?: string\r\n    ): Promise<boolean> => {\r\n        if (!userId) return false;\r\n\r\n        try {\r\n            const itemsWithProductIds = items.filter(item => item.productId);\r\n            if (itemsWithProductIds.length === 0) return true;\r\n\r\n            const uniqueIds = [...new Set(itemsWithProductIds.map(item => item.productId!))];\r\n            const freshProducts = await fetchFreshProducts(uniqueIds, locationId);\r\n\r\n            if (freshProducts.length === 0) return false;\r\n\r\n            // Calculate total quantity to deduct per product\r\n            const quantityChanges = new Map<string, number>();\r\n            for (const item of itemsWithProductIds) {\r\n                const existing = quantityChanges.get(item.productId!) || 0;\r\n                quantityChanges.set(item.productId!, existing + item.quantity);\r\n            }\r\n\r\n            const bulkUpdates = [];\r\n            for (const [productId, quantityToDeduct] of quantityChanges.entries()) {\r\n                const product = freshProducts.find(p => p.id === productId);\r\n                if (!product) continue;\r\n\r\n                const newQuantity = product.quantity - quantityToDeduct;\r\n\r\n                bulkUpdates.push({\r\n                    id: productId,\r\n                    updated: { ...product, quantity: newQuantity }\r\n                });\r\n\r\n                if (newQuantity < 0) {\r\n                    toast.warning(`${product.name} inventory is now negative (${newQuantity}). Please restock soon.`);\r\n                }\r\n            }\r\n\r\n            if (bulkUpdates.length > 0) {\r\n                await updateProductsBulk(bulkUpdates, userId, 'Sale', saleId, saleDate, receiptNumber);\r\n            }\r\n\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error deducting stock for sale:', error);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Restore stock (e.g. when deleting a sale)\r\n     */\r\n    const restoreStockForSale = async (\r\n        items: SaleItem[],\r\n        saleId?: string, // Reference ID for history\r\n        receiptNumber?: string, // Reference receipt number\r\n        locationId?: string\r\n    ): Promise<boolean> => {\r\n        if (!userId) return false;\r\n\r\n        try {\r\n            const itemsWithProductIds = items.filter(item => item.productId);\r\n            if (itemsWithProductIds.length === 0) return true;\r\n\r\n            const uniqueIds = [...new Set(itemsWithProductIds.map(item => item.productId!))];\r\n            const freshProducts = await fetchFreshProducts(uniqueIds, locationId);\r\n\r\n            // Calculate total quantity to restore\r\n            const quantityChanges = new Map<string, number>();\r\n            for (const item of itemsWithProductIds) {\r\n                const existing = quantityChanges.get(item.productId!) || 0;\r\n                quantityChanges.set(item.productId!, existing + item.quantity);\r\n            }\r\n\r\n            const bulkUpdates = [];\r\n            for (const [productId, quantityToRestore] of quantityChanges.entries()) {\r\n                const product = freshProducts.find(p => p.id === productId);\r\n                if (!product) continue;\r\n\r\n                const newQuantity = product.quantity + quantityToRestore;\r\n\r\n                bulkUpdates.push({\r\n                    id: productId,\r\n                    updated: { ...product, quantity: newQuantity }\r\n                });\r\n            }\r\n\r\n            if (bulkUpdates.length > 0) {\r\n                await updateProductsBulk(bulkUpdates, userId, 'Deleted Sale', saleId, undefined, receiptNumber);\r\n            }\r\n\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error restoring stock for sale:', error);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Adjust stock for an edited sale (Handle both adding and removing items)\r\n     */\r\n    const adjustStockForEditedSale = async (\r\n        originalItems: SaleItem[],\r\n        newItems: SaleItem[],\r\n        saleId?: string,\r\n        saleDate?: Date,\r\n        receiptNumber?: string,\r\n        locationId?: string\r\n    ): Promise<boolean> => {\r\n        if (!userId) return false;\r\n\r\n        try {\r\n            const allProductIds = [\r\n                ...originalItems.filter(i => i.productId).map(i => i.productId!),\r\n                ...newItems.filter(i => i.productId).map(i => i.productId!)\r\n            ];\r\n            const uniqueIds = [...new Set(allProductIds)];\r\n            if (uniqueIds.length === 0) return true;\r\n\r\n            const freshProducts = await fetchFreshProducts(uniqueIds, locationId);\r\n\r\n            const productNetChanges = new Map<string, number>();\r\n\r\n            // 1. Restore original items (add back to stock)\r\n            for (const item of originalItems.filter(i => i.productId)) {\r\n                const current = productNetChanges.get(item.productId!) || 0;\r\n                productNetChanges.set(item.productId!, current + item.quantity);\r\n            }\r\n\r\n            // 2. Deduct new items (remove from stock)\r\n            for (const item of newItems.filter(i => i.productId)) {\r\n                const current = productNetChanges.get(item.productId!) || 0;\r\n                productNetChanges.set(item.productId!, current - item.quantity);\r\n            }\r\n\r\n            const bulkUpdates = [];\r\n            for (const [productId, netChange] of productNetChanges.entries()) {\r\n                if (netChange === 0) continue;\r\n\r\n                const product = freshProducts.find(p => p.id === productId);\r\n                if (!product) continue;\r\n\r\n                const newQuantity = product.quantity + netChange;\r\n\r\n                bulkUpdates.push({\r\n                    id: productId,\r\n                    updated: { ...product, quantity: newQuantity }\r\n                });\r\n\r\n                if (newQuantity < 0) {\r\n                    toast.warning(`${product.name} inventory is now negative (${newQuantity}). Please restock soon.`);\r\n                }\r\n            }\r\n\r\n            if (bulkUpdates.length > 0) {\r\n                await updateProductsBulk(bulkUpdates, userId, 'Sale Status/Qty Edit', saleId, saleDate, receiptNumber);\r\n            }\r\n\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error adjusting stock for edited sale:', error);\r\n            return false;\r\n        }\r\n    };\r\n\r\n    return {\r\n        deductStockForSale,\r\n        restoreStockForSale,\r\n        adjustStockForEditedSale\r\n    };\r\n};\r\n","'use server';\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function getSalesAction(businessId: string, sortOrder: 'asc' | 'desc' = 'desc', pageSize?: number) {\r\n    try {\r\n        const queryOptions: any = {\r\n            where: {\r\n                branchId: businessId,\r\n            },\r\n            orderBy: {\r\n                createdAt: sortOrder,\r\n            },\r\n            include: {\r\n                cashTransaction: true,\r\n            }\r\n        };\r\n\r\n        if (pageSize && pageSize > 0) {\r\n            queryOptions.take = pageSize;\r\n        }\r\n\r\n        const sales = await db.sale.findMany(queryOptions);\r\n\r\n        // Provide default mappings to existing React components\r\n        return sales.map((item: any) => ({\r\n            id: item.id,\r\n            user_id: item.userId,\r\n            location_id: item.branchId,\r\n            receipt_number: item.saleNumber,\r\n            customer_name: item.customerName,\r\n            customer_address: item.customerAddress,\r\n            customer_contact: item.customerPhone,\r\n            customer_id: item.customerId,\r\n            items: item.items as any, // jsonb type\r\n            payment_status: item.paymentStatus,\r\n            profit: 0, // Profit not stored directly\r\n            date: item.date.toISOString(),\r\n            tax_rate: item.taxRate ? Number(item.taxRate) : 0,\r\n            created_at: item.createdAt.toISOString(),\r\n            updated_at: item.updatedAt.toISOString(),\r\n            cash_transaction_id: item.cashTransactionId,\r\n            amount_paid: Number(item.amountPaid),\r\n            amount_due: Number(item.balance),\r\n            category_id: item.categoryId,\r\n            notes: item.notes\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching sales:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\nexport async function deleteSaleAction(id: string, businessId: string) {\r\n    try {\r\n        const sale = await db.sale.findUnique({\r\n            where: { id },\r\n            include: { cashTransaction: true, installmentPayments: true }\r\n        });\r\n\r\n        if (!sale || sale.branchId !== businessId) {\r\n            return { success: false, error: 'Sale not found or unauthorized' };\r\n        }\r\n\r\n        await db.$transaction(async (tx) => {\r\n            // Delete installments\r\n            await tx.installmentPayment.deleteMany({\r\n                where: { saleId: id }\r\n            });\r\n\r\n            // Delete associated cash transaction\r\n            if (sale.cashTransactionId) {\r\n                await tx.cashTransaction.delete({\r\n                    where: { id: sale.cashTransactionId }\r\n                });\r\n            }\r\n\r\n            // Delete the sale itself\r\n            await tx.sale.delete({\r\n                where: { id }\r\n            });\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            sale: {\r\n                receiptNumber: sale.saleNumber,\r\n                customerName: sale.customerName,\r\n                customerAddress: sale.customerAddress,\r\n                customerContact: sale.customerPhone,\r\n                paymentStatus: sale.paymentStatus,\r\n                cashTransactionId: sale.cashTransactionId,\r\n                items: sale.items as any,\r\n                amountPaid: Number(sale.amountPaid),\r\n                amountDue: Number(sale.balance),\r\n                profit: 0,\r\n                taxRate: Number(sale.taxRate),\r\n                notes: sale.notes\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error deleting sale:', error);\r\n        return { success: false, error: error.message || 'Failed to delete sale' };\r\n    }\r\n}\r\n\r\nexport async function upsertSaleAction(saleDbData: any, isUpdate: boolean, updateId?: string) {\r\n    try {\r\n        // Map PaymentStatus if needed\r\n        let status = saleDbData.payment_status;\r\n        if (status === 'NOT PAID') status = 'UNPAID';\r\n        else if (status === 'Installment Sale') status = 'INSTALLMENT';\r\n        else if (status === 'Paid') status = 'PAID';\r\n        else if (status === 'Quote') status = 'QUOTE';\r\n\r\n        const prismaData: any = {\r\n            userId: saleDbData.user_id,\r\n            branchId: saleDbData.location_id,\r\n            saleNumber: saleDbData.receipt_number,\r\n            customerName: saleDbData.customer_name,\r\n            customerAddress: saleDbData.customer_address,\r\n            customerPhone: saleDbData.customer_contact,\r\n            customerId: saleDbData.customer_id,\r\n            items: saleDbData.items,\r\n            paymentStatus: status,\r\n            date: new Date(saleDbData.date),\r\n            taxRate: saleDbData.tax_rate,\r\n            cashTransactionId: saleDbData.cash_transaction_id,\r\n            amountPaid: saleDbData.amount_paid,\r\n            balance: saleDbData.amount_due,\r\n            categoryId: saleDbData.category_id,\r\n            notes: saleDbData.notes,\r\n            subtotal: 0, // Placeholder\r\n            total: 0,     // Placeholder\r\n        };\r\n\r\n        if (isUpdate && updateId) {\r\n            const updated = await db.sale.update({\r\n                where: { id: updateId },\r\n                data: prismaData\r\n            });\r\n            return { success: true, data: updated };\r\n        } else {\r\n            const created = await db.sale.create({\r\n                data: prismaData\r\n            });\r\n            return { success: true, data: created };\r\n        }\r\n    } catch (error: any) {\r\n        console.error('Error upserting sale:', error);\r\n        return { success: false, error: error.message || 'Failed to preserve sale' };\r\n    }\r\n}\r\n\r\nexport async function createReceiptAction(saleData: any, businessId: string, userId: string) {\r\n    try {\r\n        let status = saleData.paymentStatus;\r\n        if (status === 'NOT PAID') status = 'UNPAID';\r\n        else if (status === 'Installment Sale') status = 'INSTALLMENT';\r\n        else if (status === 'Paid') status = 'PAID';\r\n        else if (status === 'Quote') status = 'QUOTE';\r\n\r\n        const created = await db.sale.create({\r\n            data: {\r\n                userId: userId,\r\n                branchId: businessId,\r\n                saleNumber: saleData.receiptNumber,\r\n                customerName: saleData.customerName,\r\n                customerId: saleData.customerId,\r\n                date: new Date(saleData.date),\r\n                items: saleData.items,\r\n                paymentStatus: status,\r\n                amountPaid: saleData.amountPaid || 0,\r\n                balance: saleData.amountDue || 0,\r\n                cashAccountId: saleData.cashAccountId,\r\n                notes: saleData.notes,\r\n                subtotal: 0,\r\n                total: 0,\r\n            }\r\n        });\r\n\r\n        revalidatePath('/sales');\r\n        revalidatePath('/customers');\r\n\r\n        return { success: true, data: created };\r\n    } catch (error: any) {\r\n        console.error('Error creating receipt:', error);\r\n        return { success: false, error: error.message || 'Failed to create receipt' };\r\n    }\r\n}\r\n\r\n// --- SALES CATEGORIES ---\r\n\r\nexport async function getSalesCategoriesAction(businessId: string) {\r\n    try {\r\n        const categories = await db.saleCategory.findMany({\r\n            where: { branchId: businessId },\r\n            orderBy: { name: 'asc' }\r\n        });\r\n\r\n        return { success: true, data: categories };\r\n    } catch (error: any) {\r\n        console.error('Error fetching sales categories:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createSalesCategoryAction(businessId: string, userId: string, name: string, isDefault: boolean = false) {\r\n    try {\r\n        const category = await db.saleCategory.create({\r\n            data: {\r\n                branchId: businessId,\r\n                userId,\r\n                name,\r\n                is_default: isDefault\r\n            }\r\n        });\r\n\r\n        revalidatePath('/sales');\r\n        return { success: true, data: category };\r\n    } catch (error: any) {\r\n        console.error('Error creating sales category:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function updateSalesCategoryAction(id: string, name: string) {\r\n    try {\r\n        const category = await db.saleCategory.update({\r\n            where: { id },\r\n            data: { name }\r\n        });\r\n\r\n        revalidatePath('/sales');\r\n        return { success: true, data: category };\r\n    } catch (error: any) {\r\n        console.error('Error updating sales category:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteSalesCategoryAction(id: string) {\r\n    try {\r\n        await db.saleCategory.delete({\r\n            where: { id }\r\n        });\r\n\r\n        revalidatePath('/sales');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error deleting sales category:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- CUSTOMER LOOKUP ---\r\n\r\nexport async function getCustomerByNameAction(branchId: string, name: string) {\r\n    if (!branchId || !name) return null;\r\n    try {\r\n        const customer = await db.customer.findFirst({\r\n            where: {\r\n                branchId,\r\n                name: { contains: name, mode: 'insensitive' }\r\n            },\r\n            select: { id: true, name: true }\r\n        });\r\n        return customer;\r\n    } catch (error) {\r\n        console.error('Error looking up customer by name:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function updateSaleCustomerAction(saleId: string, customerId: string) {\r\n    try {\r\n        await db.sale.update({\r\n            where: { id: saleId },\r\n            data: { customerId }\r\n        });\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error updating sale customer:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteSaleAction(saleId: string) {\r\n    try {\r\n        await db.sale.delete({ where: { id: saleId } });\r\n        revalidatePath('/sales');\r\n        return true;\r\n    } catch (error) {\r\n        console.error('Error deleting sale:', error);\r\n        return false;\r\n    }\r\n}\r\n","import { useState, useEffect, useMemo, useCallback } from 'react';\r\nimport { Sale, DbSale, mapDbSaleToSale } from '@/types';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\r\nimport { useActivityLogger } from '@/hooks/useActivityLogger';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\nimport { useProducts } from '@/hooks/useProducts';\r\nimport { useInventoryActions } from '@/hooks/useInventoryActions';\r\nimport { clearInventoryCaches } from '@/utils/inventoryCacheUtils';\r\nimport { getSalesAction, deleteSaleAction } from '@/app/actions/sales';\r\n\r\nexport interface TopCustomer {\r\n  id?: string;\r\n  name: string;\r\n  totalPurchases: number;\r\n  orderCount: number;\r\n}\r\n\r\nexport const useSalesData = (userId: string | undefined, sortOrder: string = 'desc', pageSize?: number) => {\r\n\r\n  const queryClient = useQueryClient();\r\n  const { toast } = useToast();\r\n  const { logActivity } = useActivityLogger();\r\n  const { currentBusiness } = useBusiness();\r\n  const { restoreStockForSale } = useInventoryActions(userId);\r\n\r\n  const loadSales = useCallback(async (): Promise<Sale[]> => {\r\n    try {\r\n      if (!userId || !currentBusiness) {\r\n        return [];\r\n      }\r\n\r\n      // If pageSize is specified, load only that many records\r\n      const salesData = await getSalesAction(currentBusiness.id, sortOrder as any, pageSize);\r\n\r\n      const formattedSales: Sale[] = salesData ? salesData.map((item: any) => {\r\n        const dbSale: DbSale = {\r\n          id: item.id,\r\n          user_id: item.user_id,\r\n          location_id: item.location_id,\r\n          receipt_number: item.receipt_number,\r\n          customer_name: item.customer_name,\r\n          customer_address: item.customer_address,\r\n          customer_contact: item.customer_contact,\r\n          customer_id: item.customer_id,\r\n          items: item.items as any,\r\n          payment_status: item.payment_status,\r\n          profit: item.profit ? Number(item.profit) : 0,\r\n          date: item.date,\r\n          tax_rate: item.tax_rate || 0,\r\n          created_at: item.created_at,\r\n          updated_at: item.updated_at,\r\n          cash_transaction_id: item.cash_transaction_id,\r\n          amount_paid: item.amount_paid ? Number(item.amount_paid) : undefined,\r\n          amount_due: item.amount_due ? Number(item.amount_due) : undefined,\r\n          category_id: item.category_id,\r\n          notes: item.notes\r\n        };\r\n        return mapDbSaleToSale(dbSale);\r\n      }) : [];\r\n\r\n      return formattedSales;\r\n\r\n    } catch (error) {\r\n      console.error('Error loading sales:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to load sales data. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return [];\r\n    }\r\n  }, [userId, currentBusiness?.id, sortOrder, pageSize, toast]);\r\n\r\n  // React Query caching with persistent storage for improved performance\r\n  const baseQueryKey = useMemo(() => ['sales', currentBusiness?.id, userId], [currentBusiness?.id, userId]);\r\n  const queryKey = useMemo(() => [...baseQueryKey, sortOrder, pageSize], [baseQueryKey, sortOrder, pageSize]);\r\n\r\n  const {\r\n    data: sales = [],\r\n    isLoading: isQueryLoading,\r\n    isFetching,\r\n    refetch\r\n  } = useQuery({\r\n    queryKey,\r\n    queryFn: loadSales,\r\n    enabled: !!userId && !!currentBusiness?.id,\r\n    staleTime: 30_000,\r\n    gcTime: 30 * 60_000,\r\n    refetchOnWindowFocus: true,\r\n    refetchOnReconnect: true,\r\n  });\r\n\r\n  // Derived loading state\r\n  const isLoading = isQueryLoading || (isFetching && sales.length === 0);\r\n\r\n  const getTopCustomers = useMemo((): TopCustomer[] => {\r\n    // Skip quotes since they're not actual purchases\r\n    const nonQuoteSales = sales.filter(sale => sale.paymentStatus !== \"Quote\");\r\n\r\n    // Group sales by customer name\r\n    const customerMap = new Map<string, { total: number, count: number, customerId?: string }>();\r\n\r\n    nonQuoteSales.forEach(sale => {\r\n      const customerName = sale.customerName;\r\n      const saleTotal = sale.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);\r\n\r\n      if (!customerMap.has(customerName)) {\r\n        customerMap.set(customerName, {\r\n          total: saleTotal,\r\n          count: 1,\r\n          customerId: sale.customerId\r\n        });\r\n      } else {\r\n        const current = customerMap.get(customerName)!;\r\n        customerMap.set(customerName, {\r\n          total: current.total + saleTotal,\r\n          count: current.count + 1,\r\n          customerId: current.customerId || sale.customerId\r\n        });\r\n      }\r\n    });\r\n\r\n    // Convert map to array and sort by total purchases\r\n    return Array.from(customerMap.entries())\r\n      .map(([name, data]) => ({\r\n        id: data.customerId,\r\n        name,\r\n        totalPurchases: data.total,\r\n        orderCount: data.count\r\n      }))\r\n      .sort((a, b) => b.totalPurchases - a.totalPurchases);\r\n  }, [sales]);\r\n\r\n  // Memoize customer lifetime purchases function\r\n  const getCustomerLifetimePurchases = useMemo(() => {\r\n    return (customerName: string) => {\r\n      // Filter sales by customer name and exclude quotes\r\n      const customerSales = sales.filter(sale =>\r\n        sale.customerName.toLowerCase() === customerName.toLowerCase() &&\r\n        sale.paymentStatus !== \"Quote\"\r\n      );\r\n\r\n      // Calculate total purchase amount and count\r\n      const total = customerSales.reduce((sum, sale) =>\r\n        sum + sale.items.reduce((itemSum, item) => itemSum + (item.price * item.quantity), 0), 0\r\n      );\r\n\r\n      return {\r\n        total,\r\n        count: customerSales.length\r\n      };\r\n    };\r\n  }, [sales]);\r\n\r\n  const deleteSale = async (id: string) => {\r\n    try {\r\n      // First, find the sale to get its details for logging\r\n      const saleToDelete = sales.find(sale => sale.id === id);\r\n      if (!saleToDelete) {\r\n        throw new Error('Sale not found');\r\n      }\r\n\r\n      // Restore product quantities back to inventory (Only if it wasn't a quote which doesn't deduct stock)\r\n      if (saleToDelete.paymentStatus !== 'Quote' && saleToDelete.items.length > 0) {\r\n        console.log('Restoring product quantities via useInventoryActions...');\r\n        const success = await restoreStockForSale(saleToDelete.items, id, saleToDelete.receiptNumber, currentBusiness?.id);\r\n\r\n        if (!success) {\r\n          toast({\r\n            title: \"Inventory Update Warning\",\r\n            description: \"Sale deleted, but inventory restoration might have failed. Please check your stock levels.\",\r\n            variant: \"destructive\"\r\n          });\r\n        }\r\n      }\r\n\r\n      // Proceed to delete the sale via API Action\r\n      if (!currentBusiness?.id) {\r\n        throw new Error('Business context missing for deletion');\r\n      }\r\n\r\n      const result = await deleteSaleAction(id, currentBusiness.id);\r\n\r\n      if (!result.success) {\r\n        throw new Error(result.error);\r\n      }\r\n\r\n      // Update React Query cache\r\n      queryClient.setQueryData(queryKey, (oldData: Sale[] | undefined) => {\r\n        return oldData ? oldData.filter(sale => sale.id !== id) : [];\r\n      });\r\n      queryClient.invalidateQueries({ queryKey: baseQueryKey });\r\n\r\n      // Clear sold items cache after deletion\r\n      clearSoldItemsCache();\r\n\r\n      // Log activity for sale deletion\r\n      await logActivity({\r\n        activityType: 'DELETE',\r\n        module: 'SALES',\r\n        entityType: 'sale',\r\n        entityId: id,\r\n        entityName: `Sale #${saleToDelete.receiptNumber}`,\r\n        description: `Deleted sale for ${saleToDelete.customerName} - Total: UGX ${((saleToDelete.amountPaid || 0) + (saleToDelete.amountDue || 0)).toLocaleString()} (Stock restored)`,\r\n        metadata: {\r\n          receiptNumber: saleToDelete.receiptNumber,\r\n          customerName: saleToDelete.customerName,\r\n          customerAddress: saleToDelete.customerAddress,\r\n          customerContact: saleToDelete.customerContact,\r\n          totalAmount: (saleToDelete.amountPaid || 0) + (saleToDelete.amountDue || 0),\r\n          amountPaid: saleToDelete.amountPaid,\r\n          profit: saleToDelete.profit,\r\n          paymentStatus: saleToDelete.paymentStatus,\r\n          taxRate: saleToDelete.taxRate,\r\n          itemCount: saleToDelete.items.length,\r\n          items: saleToDelete.items.map(item => ({\r\n            description: item.description,\r\n            quantity: item.quantity,\r\n            price: item.price,\r\n            cost: item.cost,\r\n            total: item.quantity * item.price,\r\n            discountPercentage: item.discountPercentage,\r\n            discountAmount: item.discountAmount\r\n          })),\r\n          notes: saleToDelete.notes,\r\n          cashTransactionDeleted: !!saleToDelete.cashTransactionId\r\n        }\r\n      });\r\n\r\n      toast({\r\n        title: \"Sale Deleted\",\r\n        description: \"The sale record and associated data have been successfully deleted.\"\r\n      });\r\n\r\n      clearInventoryCaches();\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting sale:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to delete sale. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const clearSoldItemsCache = useCallback(() => {\r\n    if (!currentBusiness?.id) return;\r\n    const key = `soldItemsFilters_${currentBusiness.id}`;\r\n    localStorage.removeItem(key);\r\n\r\n    // Also clear legacy keys for safety\r\n    localStorage.removeItem('soldItemsFilters');\r\n  }, [currentBusiness?.id]);\r\n\r\n  const addSale = useCallback((newSale: Sale) => {\r\n    queryClient.setQueryData(queryKey, (oldData: Sale[] | undefined) => {\r\n      return oldData ? [newSale, ...oldData] : [newSale];\r\n    });\r\n    queryClient.invalidateQueries({ queryKey: baseQueryKey });\r\n    clearSoldItemsCache();\r\n    clearInventoryCaches();\r\n  }, [queryClient, queryKey, baseQueryKey, clearSoldItemsCache, clearInventoryCaches]);\r\n\r\n  const updateSale = useCallback((updatedSale: Sale) => {\r\n    queryClient.setQueryData(queryKey, (oldData: Sale[] | undefined) => {\r\n      return oldData ? oldData.map(s => s.id === updatedSale.id ? updatedSale : s) : [updatedSale];\r\n    });\r\n    queryClient.invalidateQueries({ queryKey: baseQueryKey });\r\n    clearSoldItemsCache();\r\n    clearInventoryCaches();\r\n  }, [queryClient, queryKey, baseQueryKey, clearSoldItemsCache, clearInventoryCaches]);\r\n\r\n  return {\r\n    sales,\r\n    isLoading,\r\n    deleteSale,\r\n    addSale,\r\n    updateSale,\r\n    getTopCustomers,\r\n    getCustomerLifetimePurchases,\r\n    clearSoldItemsCache,\r\n    refetch,\r\n    isFetching\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}