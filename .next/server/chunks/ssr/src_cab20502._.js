module.exports=[942348,a=>a.a(async(b,c)=>{try{var d=a.i(150848),e=a.i(348287),f=b([d]);async function g(a,b){try{let c={locationId:a};b&&(c.productId=b);let e=await d.db.productHistory.findMany({where:c,include:{product:{select:{name:!0,costPrice:!0,sellingPrice:!0,sku:!0}}},orderBy:[{createdAt:"desc"},{id:"desc"}]});return{success:!0,data:e.map(a=>({id:a.id,productId:a.productId,oldQuantity:a.previousQuantity,newQuantity:a.newQuantity,changeReason:a.changeReason,createdAt:a.createdAt.toISOString(),referenceId:a.referenceId,receiptNumber:a.receiptNumber,product:a.product?{name:a.product.name,costPrice:a.product.costPrice,sellingPrice:a.product.sellingPrice,itemNumber:a.product.sku}:void 0}))}}catch(a){return console.error("Error fetching stock history:",a),{success:!1,error:a.message}}}async function h(a){try{let b=await d.db.$transaction(async b=>{let c=await b.productHistory.create({data:{userId:a.userId,locationId:a.locationId,productId:a.productId,previousQuantity:a.previousQuantity,newQuantity:a.newQuantity,changeReason:a.changeReason,referenceId:a.referenceId||null,receiptNumber:a.receiptNumber||null,createdAt:a.createdAt?new Date(a.createdAt):void 0}});return await b.product.update({where:{id:a.productId},data:{stock:a.newQuantity}}),c});return(0,e.revalidatePath)("/inventory"),{success:!0,data:b}}catch(a){return console.error("Error creating stock history:",a),{success:!1,error:a.message}}}async function i(a,b){try{let c=await d.db.$transaction(async c=>{let d=await c.productHistory.findMany({where:{productId:a,locationId:b},orderBy:[{createdAt:"asc"},{id:"asc"}]});if(0===d.length)return{finalQuantity:0};let e=0,f=[];for(let a of d){let b=a.newQuantity-a.previousQuantity,d=e,g=d+b;(a.previousQuantity!==d||a.newQuantity!==g)&&f.push(c.productHistory.update({where:{id:a.id},data:{previousQuantity:d,newQuantity:g}})),e=g}return f.length>0&&await Promise.all(f),await c.product.update({where:{id:a},data:{stock:e}}),{finalQuantity:e}});return(0,e.revalidatePath)("/inventory"),{success:!0,data:c}}catch(a){return console.error("Error recalculating stock chain:",a),{success:!1,error:a.message}}}async function j(a,b){try{let c=await d.db.$transaction(async c=>{let d=await c.productHistory.findMany({where:{referenceId:a,locationId:b},select:{productId:!0}}),e=[...new Set(d.map(a=>a.productId))];for(let d of(await c.productHistory.deleteMany({where:{referenceId:a,locationId:b}}),e))await l(c,d,b);return{affectedProducts:e.length}});return(0,e.revalidatePath)("/inventory"),{success:!0,data:c}}catch(a){return console.error("Error deleting stock history by reference:",a),{success:!1,error:a.message}}}async function k(a,b,c){try{let f=await d.db.productHistory.updateMany({where:{referenceId:a,locationId:b},data:{createdAt:new Date(c)}});return(0,e.revalidatePath)("/inventory"),{success:!0,data:f}}catch(a){return console.error("Error updating stock history dates:",a),{success:!1,error:a.message}}}async function l(a,b,c){let d=await a.productHistory.findMany({where:{productId:b,locationId:c},orderBy:[{createdAt:"asc"},{id:"asc"}]}),e=0;for(let b of d){let c=b.newQuantity-b.previousQuantity,d=e,f=d+c;(b.previousQuantity!==d||b.newQuantity!==f)&&await a.productHistory.update({where:{id:b.id},data:{previousQuantity:d,newQuantity:f}}),e=f}await a.product.update({where:{id:b},data:{stock:e}})}async function m(a,b){try{let c=await d.db.requisition.findMany({where:{userId:a,locationId:b},orderBy:{createdAt:"desc"}});return{success:!0,data:c.map(a=>({id:a.id,userId:a.userId,locationId:a.branchId,requisitionNumber:a.requisitionNumber,title:a.title||"",items:a.items||[],notes:a.notes,status:a.status,createdAt:a.createdAt.toISOString(),updatedAt:a.updatedAt.toISOString()}))}}catch(a){return console.error("Error fetching requisitions:",a),{success:!1,error:a.message}}}async function n(a){try{let b=await d.db.requisition.create({data:{userId:a.userId,branchId:a.locationId,requisitionNumber:a.requisitionNumber,title:a.title,items:a.items,notes:a.notes,status:a.status||"draft"}});return(0,e.revalidatePath)("/requisitions"),{success:!0,data:{id:b.id,userId:b.userId,locationId:b.branchId,requisitionNumber:b.requisitionNumber,title:b.title||"",items:b.items||[],notes:b.notes,status:b.status,createdAt:b.createdAt.toISOString(),updatedAt:b.updatedAt.toISOString()}}}catch(a){return console.error("Error creating requisition:",a),{success:!1,error:a.message}}}async function o(a,b,c){try{let f=await d.db.requisition.update({where:{id:a,userId:b},data:{title:c.title,items:c.items,notes:c.notes,status:c.status,updatedAt:new Date}});return(0,e.revalidatePath)("/requisitions"),{success:!0,data:{id:f.id,userId:f.userId,locationId:f.branchId,requisitionNumber:f.requisitionNumber,title:f.title||"",items:f.items||[],notes:f.notes,status:f.status,createdAt:f.createdAt.toISOString(),updatedAt:f.updatedAt.toISOString()}}}catch(a){return console.error("Error updating requisition:",a),{success:!1,error:a.message}}}async function p(a,b){try{return await d.db.requisition.delete({where:{id:a,userId:b}}),(0,e.revalidatePath)("/requisitions"),{success:!0}}catch(a){return console.error("Error deleting requisition:",a),{success:!1,error:a.message}}}async function q(a,b,c){try{let e=new Date(b),f=new Date(c),g=await d.db.product.findMany({where:{branchId:a},include:{category:!0}}),h=await Promise.all(g.map(async b=>{let c=await d.db.productHistory.findMany({where:{productId:b.id,locationId:a,createdAt:{gte:e,lte:f}},orderBy:{createdAt:"asc"}}),g=0,h=0,i=0,j=0;c.forEach(a=>{let b=a.newQuantity-a.previousQuantity;"SALE"===a.changeReason?g+=Math.abs(b):"STOCK_IN"===a.changeReason||"RESTOCK"===a.changeReason?h+=b:b>0?i+=b:j+=Math.abs(b)});let k=await d.db.productHistory.findFirst({where:{productId:b.id,locationId:a,createdAt:{lte:f}},orderBy:{createdAt:"desc"}}),l=k?k.newQuantity:0,m=l-(h+i-g-j);return{productId:b.id,productName:b.name,itemNumber:b.sku||b.id,imageUrl:b.imageUrl,costPrice:Number(b.costPrice),sellingPrice:Number(b.sellingPrice),category:b.category?.name,openingStock:m,itemsSold:g,stockIn:h,transferOut:0,returnIn:0,returnOut:0,adjustmentsIn:i,adjustmentsOut:j,closingStock:l,revaluation:l*Number(b.costPrice)}}));return{success:!0,data:h}}catch(a){return console.error("Error generating stock summary report:",a),{success:!1,error:a.message}}}async function r(a,b){try{let c=await d.db.product.findUnique({where:{id:b},include:{category:!0}});if(!c)return{success:!1,error:"Product not found"};let e=await d.db.productHistory.findMany({where:{productId:b,locationId:a},orderBy:[{createdAt:"asc"},{id:"asc"}]}),f=await d.db.sale.findMany({where:{branchId:a},orderBy:{date:"asc"}}),g=e.length>0?e[0].newStock:0,h=e.length>0?e[0].createdAt:null,i=new Map,j=0;f.forEach(a=>{let c=(a.items||[]).filter(a=>a.productId===b).reduce((a,b)=>a+(Number(b.quantity)||0),0);if(c>0)if(h&&a.date<h)j+=c;else{let b=a.date.toISOString().split("T")[0],d=i.get(b)||{itemsSold:0,stockAdded:0,transferOut:0,returnIn:0,returnOut:0,adjustments:0};d.itemsSold+=c,i.set(b,d)}}),e.slice(1).forEach(a=>{let b=a.createdAt.toISOString().split("T")[0],c=a.newStock-a.oldStock,d=(a.changeReason||"").toLowerCase(),e=i.get(b)||{itemsSold:0,stockAdded:0,transferOut:0,returnIn:0,returnOut:0,adjustments:0};"RESTOCK"===a.type||d.includes("purchase")||d.includes("addition")?e.stockAdded+=c:d.includes("transfer out")?e.transferOut+=Math.abs(c):d.includes("customer return")?e.returnIn+=c:d.includes("return to supplier")?e.returnOut+=Math.abs(c):"SALE"!==a.type&&(e.adjustments+=c),i.set(b,e)});let k=Array.from(i.keys()).sort(),l=[],m=g;for(let a of k){let b=i.get(a),c=m,d=c-b.itemsSold+b.stockAdded-b.transferOut+b.returnIn-b.returnOut+b.adjustments;l.push({date:a,startingStock:c,...b,endingStock:d}),m=d}return{success:!0,data:{product:{id:c.id,name:c.name,quantity:c.stock,itemNumber:c.sku},currentStock:c.stock,calculatedStock:m,discrepancy:c.stock-m,openingStock:g,openingDate:h?.toISOString(),excludedSalesQty:j,dailyBreakdown:l}}}catch(a){return console.error("Error in reconciliation action:",a),{success:!1,error:a.message}}}async function s(a){try{let b=await d.db.product.findMany({where:{branchId:a},select:{id:!0,name:!0,stock:!0}}),c=[];for(let e of b){let b=await d.db.productHistory.findMany({where:{productId:e.id,locationId:a},orderBy:[{createdAt:"asc"},{id:"asc"}]});if(0===b.length)continue;let f=0,g=[];for(let a of b){let b=a.newStock-a.oldStock,c=f,d=c+b;(a.oldStock!==c||a.newStock!==d)&&g.push({entryId:a.id,createdAt:a.createdAt.toISOString(),changeReason:a.changeReason,currentPrevQty:a.oldStock,currentNewQty:a.newStock,fixedPrevQty:c,fixedNewQty:d}),f=d}(g.length>0||Math.abs(e.stock-f)>.001)&&c.push({productId:e.id,productName:e.name,totalEntries:b.length,brokenEntries:g,finalFixedQty:f,currentProductQty:e.stock})}return{success:!0,data:c}}catch(a){return{success:!1,error:a.message}}}async function t(a,b){try{let c=b||(await d.db.product.findMany({where:{branchId:a},select:{id:!0}})).map(a=>a.id),e=0,f=0;for(let b of c)try{await i(b,a),e++}catch(a){f++}return{success:!0,data:{repaired:e,failed:f}}}catch(a){return{success:!1,error:a.message}}}async function u(a){try{let b=await d.db.activityHistory.findMany({where:{entityId:{in:a}},select:{entityId:!0,entityName:!0}});return{success:!0,data:b}}catch(a){return{success:!1,error:a.message,data:[]}}}async function v(a,b){try{return await d.db.productHistory.updateMany({where:{id:{in:a}},data:{createdAt:new Date(b)}}),{success:!0}}catch(a){return{success:!1,error:a.message}}}[d]=f.then?(await f)():f,a.s(["createRequisitionAction",()=>n,"createStockHistoryAction",()=>h,"deleteRequisitionAction",()=>p,"deleteStockHistoryEntriesByReferenceAction",()=>j,"getActivityByEntityIdsAction",()=>u,"getProductReconciliationAction",()=>r,"getRequisitionsAction",()=>m,"getStockHistoryAction",()=>g,"getStockRepairsPreviewAction",()=>s,"getStockSummaryReportAction",()=>q,"recalculateStockChainAction",()=>i,"repairStockChainsAction",()=>t,"updateRequisitionAction",()=>o,"updateStockHistoryDatesAction",()=>v,"updateStockHistoryDatesByReferenceAction",()=>k]),c()}catch(a){c(a)}},!1),142499,a=>a.a(async(b,c)=>{try{var d=a.i(127669),e=a.i(964889),f=a.i(942348),g=b([e,f]);[e,f]=g.then?(await g)():g,a.s(["useStockHistory",0,(a,b)=>{let[c,g]=(0,d.useState)([]),[h,i]=(0,d.useState)(!0),{currentBusiness:j}=(0,e.useBusiness)(),k=(0,d.useCallback)(async()=>{if(!a||!j){g([]),i(!1);return}try{i(!0);let a=await (0,f.getStockHistoryAction)(j.id,b);if(!a.success||!a.data)throw Error(a.error||"Failed to fetch stock history");let c=a.data.map(a=>({id:a.id,productId:a.productId,oldQuantity:a.oldQuantity,newQuantity:a.newQuantity,changeReason:a.changeReason,createdAt:new Date(a.createdAt),referenceId:a.referenceId,receiptNumber:a.receiptNumber,product:a.product}));g(c)}catch(a){console.error("Error loading stock history:",a)}finally{i(!1)}},[a,j?.id,b]);(0,d.useEffect)(()=>{k()},[k]);let l=async(b,c,d,e,g,h,i,l)=>{try{if(!a||!j)return!1;let m=l?`[${l}] | ${e}`:e,n=await (0,f.createStockHistoryAction)({userId:a,locationId:j.id,productId:b,previousQuantity:c,newQuantity:d,changeReason:m,referenceId:g,receiptNumber:i,createdAt:h?.toISOString()});if(!n.success)return console.error("Error creating stock history entry:",n.error),!1;return await k(),!0}catch(a){return console.error("Error creating stock history:",a),!1}},m=async a=>{try{if(!j)return!1;let b=await (0,f.deleteStockHistoryEntriesByReferenceAction)(a,j.id);if(!b.success)throw Error(b.error);return await k(),!0}catch(a){return console.error("Error deleting stock history entries:",a),!1}},n=async a=>{try{if(!j)return!1;let b=await (0,f.recalculateStockChainAction)(a,j.id);if(!b.success)throw Error(b.error);return await k(),!0}catch(a){return console.error("Error recalculating stock chain:",a),!1}},o=async(a,b)=>{try{if(!j)return!1;let c=await (0,f.updateStockHistoryDatesByReferenceAction)(a,j.id,b.toISOString());if(!c.success)throw Error(c.error);return await k(),!0}catch(a){return console.error("Error updating stock history dates:",a),!1}},p=async a=>{try{if(!j)return{repaired:0,failed:0};let a=await (0,f.repairStockChainsAction)(j.id);if(a.success&&a.data)return a.data;return{repaired:0,failed:0}}catch(a){return console.error("Error repairing all chains:",a),{repaired:0,failed:0}}},q=async a=>{try{if(!j)return[];let a=await (0,f.getStockRepairsPreviewAction)(j.id);if(a.success&&a.data)return a.data;return[]}catch(a){return console.error("Error previewing repairs:",a),[]}};return{stockHistory:c,isLoading:h,createStockHistoryEntry:l,deleteMultipleStockHistoryEntriesByReference:m,recalculateStockChain:n,updateStockHistoryDatesBySaleId:o,repairAllStockChains:p,previewStockChainRepairs:q,refreshHistory:k}}]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=src_cab20502._.js.map