module.exports=[635785,a=>{"use strict";a.s(["mapDbProductToProduct",0,a=>({id:a.id,itemNumber:a.item_number,barcode:a.barcode,manufacturerBarcode:a.manufacturer_barcode,name:a.name,description:a.description,category:a.category,quantity:a.quantity,costPrice:Number(a.cost_price),sellingPrice:Number(a.selling_price),supplier:a.supplier,imageUrl:a.image_url,minimumStock:a.minimum_stock,createdAt:new Date(a.created_at),updatedAt:new Date(a.updated_at)}),"mapDbSaleToSale",0,a=>{let b=(Array.isArray(a.items)?a.items:[]).map(a=>{let b=void 0!==a.discountPercentage?Number(a.discountPercentage):void 0,c=void 0!==a.discountAmount?Number(a.discountAmount):void 0,d=a.discountType;return!d&&(b&&b>0?d="percentage":c&&c>0&&(d="amount")),{description:a.description||"",quantity:Number(a.quantity)||0,price:Number(a.price)||0,cost:Number(a.cost)||0,productId:a.productId||void 0,discountType:d,discountPercentage:b,discountAmount:c,createdAt:a.createdAt||void 0}});return{id:a.id,receiptNumber:a.receipt_number,customerName:a.customer_name,customerAddress:a.customer_address||"",customerContact:a.customer_contact||"",customerId:a.customer_id||void 0,items:b,paymentStatus:a.payment_status,profit:Number(a.profit),date:new Date(a.date),taxRate:a.tax_rate?Number(a.tax_rate):0,cashTransactionId:a.cash_transaction_id||void 0,amountPaid:a.amount_paid?Number(a.amount_paid):void 0,amountDue:a.amount_due?Number(a.amount_due):void 0,notes:a.notes||"",categoryId:a.category_id||void 0,createdAt:new Date(a.created_at)}},"mapSaleToDbSale",0,(a,b,c,d,e,f,g)=>({user_id:e,location_id:f,receipt_number:d,customer_name:a.customerName,customer_address:a.customerAddress||null,customer_contact:a.customerContact||null,customer_id:a.customerId||null,items:a.items,payment_status:a.paymentStatus,profit:c,date:b.toISOString().split("T")[0],tax_rate:a.taxRate||0,cash_transaction_id:g||null,amount_paid:a.amountPaid||null,amount_due:a.amountDue||null,notes:a.notes||null,category_id:a.categoryId||null})])},258956,a=>{"use strict";var b=a.i(405050);let c=(0,b.createServerReference)("401d907b5cd7e0b2f207e9b555ac4fe2e14de08444",b.callServer,void 0,b.findSourceMapURL,"logActivityAction");var d=a.i(349774),e=a.i(169819),f=a.i(890914);a.s(["useActivityLogger",0,()=>{let{userId:a}=(0,d.useCurrentUser)(),{currentBusiness:b}=(0,e.useBusiness)(),g=null;try{let{currentProfile:a}=(0,f.useProfiles)();g=a}catch{g=null}return{logActivity:async d=>{if(!a||!b?.id)return void console.warn("Cannot log activity: missing user or business context");try{let e=await c({userId:a,locationId:b.id,activityType:d.activityType,module:d.module,entityType:d.entityType,entityId:d.entityId||void 0,entityName:d.entityName,description:d.description,metadata:d.metadata||void 0,profileId:g?.id||void 0,profileName:g?.profile_name||void 0});e.success||console.error("Error logging activity:",e.error)}catch(a){console.error("Failed to log activity:",a)}}}}],258956)},737139,201643,602703,a=>{"use strict";var b=a.i(572131),c=a.i(635785),d=a.i(478793),e=a.i(433217),f=a.i(937927),g=a.i(258956),h=a.i(169819),i=a.i(347778),j=a.i(823292),k=a.i(3048);let l=a=>{let{updateProductsBulk:b}=(0,i.useProducts)(a),c=async(a,b)=>{if(!a.length)return[];try{return await (0,k.getProductsByIdsAction)(a,b)}catch(a){throw console.error("Error fetching fresh products:",a),a}};return{deductStockForSale:async(d,e,f,g,h)=>{if(!a)return!1;try{let i=d.filter(a=>a.productId);if(0===i.length)return!0;let k=[...new Set(i.map(a=>a.productId))],l=await c(k,h);if(0===l.length)return!1;let m=new Map;for(let a of i){let b=m.get(a.productId)||0;m.set(a.productId,b+a.quantity)}let n=[];for(let[a,b]of m.entries()){let c=l.find(b=>b.id===a);if(!c)continue;let d=c.quantity-b;n.push({id:a,updated:{...c,quantity:d}}),d<0&&j.toast.warning(`${c.name} inventory is now negative (${d}). Please restock soon.`)}return n.length>0&&await b(n,a,"Sale",e,f,g),!0}catch(a){return console.error("Error deducting stock for sale:",a),!1}},restoreStockForSale:async(d,e,f,g)=>{if(!a)return!1;try{let h=d.filter(a=>a.productId);if(0===h.length)return!0;let i=[...new Set(h.map(a=>a.productId))],j=await c(i,g),k=new Map;for(let a of h){let b=k.get(a.productId)||0;k.set(a.productId,b+a.quantity)}let l=[];for(let[a,b]of k.entries()){let c=j.find(b=>b.id===a);if(!c)continue;let d=c.quantity+b;l.push({id:a,updated:{...c,quantity:d}})}return l.length>0&&await b(l,a,"Deleted Sale",e,void 0,f),!0}catch(a){return console.error("Error restoring stock for sale:",a),!1}},adjustStockForEditedSale:async(d,e,f,g,h,i)=>{if(!a)return!1;try{let k=[...d.filter(a=>a.productId).map(a=>a.productId),...e.filter(a=>a.productId).map(a=>a.productId)],l=[...new Set(k)];if(0===l.length)return!0;let m=await c(l,i),n=new Map;for(let a of d.filter(a=>a.productId)){let b=n.get(a.productId)||0;n.set(a.productId,b+a.quantity)}for(let a of e.filter(a=>a.productId)){let b=n.get(a.productId)||0;n.set(a.productId,b-a.quantity)}let o=[];for(let[a,b]of n.entries()){if(0===b)continue;let c=m.find(b=>b.id===a);if(!c)continue;let d=c.quantity+b;o.push({id:a,updated:{...c,quantity:d}}),d<0&&j.toast.warning(`${c.name} inventory is now negative (${d}). Please restock soon.`)}return o.length>0&&await b(o,a,"Sale Status/Qty Edit",f,g,h),!0}catch(a){return console.error("Error adjusting stock for edited sale:",a),!1}}}};a.s(["useInventoryActions",0,l],201643);var m=a.i(282141),n=a.i(405050);let o=(0,n.createServerReference)("703e9376bfaf2adbf9aba886e70ba6b561f6bf5e0c",n.callServer,void 0,n.findSourceMapURL,"getSalesAction"),p=(0,n.createServerReference)("40d9064371ce5c0811194879498fdc849fbf872b8a",n.callServer,void 0,n.findSourceMapURL,"deleteSaleAction");a.s(["deleteSaleAction",()=>p],602703),a.s(["useSalesData",0,(a,i="desc",j)=>{let k=(0,f.useQueryClient)(),{toast:n}=(0,d.useToast)(),{logActivity:q}=(0,g.useActivityLogger)(),{currentBusiness:r}=(0,h.useBusiness)(),{restoreStockForSale:s}=l(a),t=(0,b.useCallback)(async()=>{try{if(!a||!r)return[];let b=await o(r.id,i,j);return b?b.map(a=>{let b={id:a.id,user_id:a.user_id,location_id:a.location_id,receipt_number:a.receipt_number,customer_name:a.customer_name,customer_address:a.customer_address,customer_contact:a.customer_contact,customer_id:a.customer_id,items:a.items,payment_status:a.payment_status,profit:a.profit?Number(a.profit):0,date:a.date,tax_rate:a.tax_rate||0,created_at:a.created_at,updated_at:a.updated_at,cash_transaction_id:a.cash_transaction_id,amount_paid:a.amount_paid?Number(a.amount_paid):void 0,amount_due:a.amount_due?Number(a.amount_due):void 0,category_id:a.category_id,notes:a.notes};return(0,c.mapDbSaleToSale)(b)}):[]}catch(a){return console.error("Error loading sales:",a),n({title:"Error",description:"Failed to load sales data. Please try again.",variant:"destructive"}),[]}},[a,r?.id,i,j,n]),u=(0,b.useMemo)(()=>["sales",r?.id,a],[r?.id,a]),v=(0,b.useMemo)(()=>[...u,i,j],[u,i,j]),{data:w=[],isLoading:x,isFetching:y,refetch:z}=(0,e.useQuery)({queryKey:v,queryFn:t,enabled:!!a&&!!r?.id,staleTime:3e4,gcTime:18e5,refetchOnWindowFocus:!0,refetchOnReconnect:!0}),A=x||y&&0===w.length,B=(0,b.useMemo)(()=>{let a=w.filter(a=>"Quote"!==a.paymentStatus),b=new Map;return a.forEach(a=>{let c=a.customerName,d=a.items.reduce((a,b)=>a+b.price*b.quantity,0);if(b.has(c)){let e=b.get(c);b.set(c,{total:e.total+d,count:e.count+1,customerId:e.customerId||a.customerId})}else b.set(c,{total:d,count:1,customerId:a.customerId})}),Array.from(b.entries()).map(([a,b])=>({id:b.customerId,name:a,totalPurchases:b.total,orderCount:b.count})).sort((a,b)=>b.totalPurchases-a.totalPurchases)},[w]),C=(0,b.useMemo)(()=>a=>{let b=w.filter(b=>b.customerName.toLowerCase()===a.toLowerCase()&&"Quote"!==b.paymentStatus);return{total:b.reduce((a,b)=>a+b.items.reduce((a,b)=>a+b.price*b.quantity,0),0),count:b.length}},[w]),D=async a=>{try{let b=w.find(b=>b.id===a);if(!b)throw Error("Sale not found");if("Quote"!==b.paymentStatus&&b.items.length>0&&(console.log("Restoring product quantities via useInventoryActions..."),await s(b.items,a,b.receiptNumber,r?.id)||n({title:"Inventory Update Warning",description:"Sale deleted, but inventory restoration might have failed. Please check your stock levels.",variant:"destructive"})),!r?.id)throw Error("Business context missing for deletion");let c=await p(a,r.id);if(!c.success)throw Error(c.error);return k.setQueryData(v,b=>b?b.filter(b=>b.id!==a):[]),k.invalidateQueries({queryKey:u}),E(),await q({activityType:"DELETE",module:"SALES",entityType:"sale",entityId:a,entityName:`Sale #${b.receiptNumber}`,description:`Deleted sale for ${b.customerName} - Total: UGX ${((b.amountPaid||0)+(b.amountDue||0)).toLocaleString()} (Stock restored)`,metadata:{receiptNumber:b.receiptNumber,customerName:b.customerName,customerAddress:b.customerAddress,customerContact:b.customerContact,totalAmount:(b.amountPaid||0)+(b.amountDue||0),amountPaid:b.amountPaid,profit:b.profit,paymentStatus:b.paymentStatus,taxRate:b.taxRate,itemCount:b.items.length,items:b.items.map(a=>({description:a.description,quantity:a.quantity,price:a.price,cost:a.cost,total:a.quantity*a.price,discountPercentage:a.discountPercentage,discountAmount:a.discountAmount})),notes:b.notes,cashTransactionDeleted:!!b.cashTransactionId}}),n({title:"Sale Deleted",description:"The sale record and associated data have been successfully deleted."}),(0,m.clearInventoryCaches)(),!0}catch(a){return console.error("Error deleting sale:",a),n({title:"Error",description:"Failed to delete sale. Please try again.",variant:"destructive"}),!1}},E=(0,b.useCallback)(()=>{if(!r?.id)return;let a=`soldItemsFilters_${r.id}`;localStorage.removeItem(a),localStorage.removeItem("soldItemsFilters")},[r?.id]);return{sales:w,isLoading:A,deleteSale:D,addSale:(0,b.useCallback)(a=>{k.setQueryData(v,b=>b?[a,...b]:[a]),k.invalidateQueries({queryKey:u}),E(),(0,m.clearInventoryCaches)()},[k,v,u,E,m.clearInventoryCaches]),updateSale:(0,b.useCallback)(a=>{k.setQueryData(v,b=>b?b.map(b=>b.id===a.id?a:b):[a]),k.invalidateQueries({queryKey:u}),E(),(0,m.clearInventoryCaches)()},[k,v,u,E,m.clearInventoryCaches]),getTopCustomers:B,getCustomerLifetimePurchases:C,clearSoldItemsCache:E,refetch:z,isFetching:y}}],737139)}];

//# sourceMappingURL=src_433d31e7._.js.map