{"version":3,"sources":["../../../../src/app/actions/finance.ts"],"sourcesContent":["'use server';\r\n\r\nimport { db, PaymentStatus, ActivityType, ActivityModule } from '../../../prisma/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// --- EXPENSES ---\r\n\r\nexport interface ExpenseInput {\r\n    amount: number;\r\n    description: string;\r\n    category?: string;\r\n    date: Date;\r\n    paymentMethod?: string;\r\n    personInCharge?: string;\r\n    receiptImage?: string;\r\n    cashAccountId?: string;\r\n    userId: string;\r\n    locationId: string;\r\n}\r\n\r\nexport async function createExpenseAction(data: ExpenseInput, linkToCash: boolean) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            // 1. Create the expense\r\n            const expense = await tx.expense.create({\r\n                data: {\r\n                    userId: data.userId,\r\n                    branchId: data.locationId,\r\n                    amount: data.amount,\r\n                    description: data.description,\r\n                    category: data.category || null,\r\n                    date: data.date,\r\n                    paymentMethod: data.paymentMethod || null,\r\n                    personInCharge: data.personInCharge || null,\r\n                    receiptImage: data.receiptImage || null,\r\n                    cashAccountId: linkToCash && data.cashAccountId ? data.cashAccountId : null\r\n                }\r\n            });\r\n\r\n            // 2. If linking to cash, create a cash transaction\r\n            if (linkToCash && data.cashAccountId) {\r\n                const cashTx = await tx.cashTransaction.create({\r\n                    data: {\r\n                        userId: data.userId,\r\n                        branchId: data.locationId,\r\n                        accountId: data.cashAccountId,\r\n                        amount: data.amount,\r\n                        transactionType: 'cash_out',\r\n                        category: data.category || 'Expense',\r\n                        description: `Expense: ${data.description}`,\r\n                        personInCharge: data.personInCharge || null,\r\n                        date: data.date,\r\n                        paymentMethod: data.paymentMethod || null,\r\n                        receiptImage: data.receiptImage || null\r\n                    }\r\n                });\r\n\r\n                // Update expense with transaction reference\r\n                await tx.expense.update({\r\n                    where: { id: expense.id },\r\n                    data: { cashTransactionId: cashTx.id }\r\n                });\r\n            }\r\n\r\n            return expense;\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error creating expense:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function getExpensesAction(locationId: string) {\r\n    try {\r\n        const expenses = await db.expense.findMany({\r\n            where: { branchId: locationId },\r\n            orderBy: { date: 'desc' }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: expenses.map((e: any) => ({\r\n                ...e,\r\n                created_at: e.createdAt.toISOString(),\r\n                updated_at: e.updatedAt.toISOString(),\r\n                payment_method: e.paymentMethod,\r\n                person_in_charge: e.personInCharge,\r\n                receipt_image: e.receiptImage,\r\n                cash_account_id: e.cashAccountId,\r\n                cash_transaction_id: e.cashTransactionId\r\n            }))\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error fetching expenses:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function updateExpenseAction(id: string, updates: any, currentExpense: any) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            // Update expense\r\n            const updatedExpense = await tx.expense.update({\r\n                where: { id },\r\n                data: {\r\n                    amount: updates.amount,\r\n                    description: updates.description,\r\n                    category: updates.category,\r\n                    date: updates.date,\r\n                    paymentMethod: updates.paymentMethod,\r\n                    personInCharge: updates.personInCharge,\r\n                    receiptImage: updates.receiptImage,\r\n                    cashAccountId: updates.cashAccountId || null\r\n                }\r\n            });\r\n\r\n            const shouldLinkToCash = !!updates.cashAccountId;\r\n            const wasLinkedToCash = !!currentExpense.cashTransactionId;\r\n\r\n            if (shouldLinkToCash && !wasLinkedToCash) {\r\n                // Create new cash transaction\r\n                const cashTx = await tx.cashTransaction.create({\r\n                    data: {\r\n                        userId: currentExpense.userId,\r\n                        branchId: currentExpense.branchId || currentExpense.locationId,\r\n                        accountId: updates.cashAccountId,\r\n                        amount: updates.amount || currentExpense.amount,\r\n                        transactionType: 'cash_out',\r\n                        category: updates.category || currentExpense.category || 'Expense',\r\n                        description: `Expense: ${updates.description || currentExpense.description}`,\r\n                        personInCharge: updates.personInCharge || currentExpense.personInCharge || null,\r\n                        date: updates.date || currentExpense.date,\r\n                        paymentMethod: updates.paymentMethod || currentExpense.paymentMethod || null,\r\n                        receiptImage: updates.receiptImage || currentExpense.receiptImage || null\r\n                    }\r\n                });\r\n                await tx.expense.update({\r\n                    where: { id },\r\n                    data: { cashTransactionId: cashTx.id }\r\n                });\r\n            } else if (shouldLinkToCash && wasLinkedToCash) {\r\n                // Update existing cash transaction\r\n                await tx.cashTransaction.update({\r\n                    where: { id: currentExpense.cashTransactionId },\r\n                    data: {\r\n                        accountId: updates.cashAccountId,\r\n                        amount: updates.amount || currentExpense.amount,\r\n                        category: updates.category || currentExpense.category || 'Expense',\r\n                        description: `Expense: ${updates.description || currentExpense.description}`,\r\n                        personInCharge: updates.personInCharge || currentExpense.personInCharge || null,\r\n                        date: updates.date || currentExpense.date,\r\n                        paymentMethod: updates.paymentMethod || currentExpense.paymentMethod || null,\r\n                        receiptImage: updates.receiptImage || currentExpense.receiptImage || null\r\n                    }\r\n                });\r\n            } else if (!shouldLinkToCash && wasLinkedToCash) {\r\n                // Delete existing cash transaction\r\n                await tx.cashTransaction.delete({\r\n                    where: { id: currentExpense.cashTransactionId }\r\n                });\r\n                await tx.expense.update({\r\n                    where: { id },\r\n                    data: { cashTransactionId: null }\r\n                });\r\n            }\r\n\r\n            return updatedExpense;\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error updating expense:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteExpenseAction(id: string) {\r\n    try {\r\n        await db.$transaction(async (tx: any) => {\r\n            const expense = await tx.expense.findUnique({\r\n                where: { id },\r\n                select: { cashTransactionId: true }\r\n            });\r\n\r\n            if (expense?.cashTransactionId) {\r\n                await tx.cashTransaction.delete({\r\n                    where: { id: expense.cashTransactionId }\r\n                });\r\n            }\r\n\r\n            await tx.expense.delete({\r\n                where: { id }\r\n            });\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error deleting expense:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- INSTALLMENT PAYMENTS ---\r\n\r\nexport async function getInstallmentPaymentsAction(saleId: string) {\r\n    try {\r\n        const payments = await db.installmentPayment.findMany({\r\n            where: { saleId },\r\n            orderBy: { paymentDate: 'desc' }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: payments.map((p: any) => ({\r\n                id: p.id,\r\n                saleId: p.saleId,\r\n                userId: p.userId,\r\n                amount: Number(p.amount),\r\n                paymentDate: p.paymentDate.toISOString(),\r\n                notes: p.notes,\r\n                cashTransactionId: p.cashTransactionId,\r\n                createdAt: p.createdAt.toISOString(),\r\n                updatedAt: p.updatedAt.toISOString()\r\n            }))\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error fetching installment payments:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createInstallmentPaymentAction(data: any) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            let cashTxId = data.cashTransactionId;\r\n\r\n            if (data.accountId && data.locationId && !cashTxId) {\r\n                const sale = await tx.sale.findUnique({\r\n                    where: { id: data.saleId },\r\n                    select: { customerName: true, receiptNumber: true }\r\n                });\r\n\r\n                const description = sale\r\n                    ? `Installment payment for ${sale.customerName} - Receipt #${sale.receiptNumber}`\r\n                    : `Installment payment for sale`;\r\n\r\n                const cashTx = await tx.cashTransaction.create({\r\n                    data: {\r\n                        userId: data.userId,\r\n                        branchId: data.locationId,\r\n                        accountId: data.accountId,\r\n                        amount: data.amount,\r\n                        transactionType: 'cash_in',\r\n                        category: 'Installment payment',\r\n                        description: description,\r\n                        date: data.paymentDate ? new Date(data.paymentDate) : new Date(),\r\n                    }\r\n                });\r\n                cashTxId = cashTx.id;\r\n            }\r\n\r\n            const payment = await tx.installmentPayment.create({\r\n                data: {\r\n                    saleId: data.saleId,\r\n                    userId: data.userId,\r\n                    amount: data.amount,\r\n                    notes: data.notes,\r\n                    cashTransactionId: cashTxId,\r\n                    paymentDate: data.paymentDate ? new Date(data.paymentDate) : new Date()\r\n                }\r\n            });\r\n\r\n            return payment;\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error creating installment payment:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function updateInstallmentPaymentAction(id: string, updates: any) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            const current = await tx.installmentPayment.findUnique({\r\n                where: { id },\r\n                select: { cashTransactionId: true }\r\n            });\r\n\r\n            if (!current) throw new Error(\"Payment not found\");\r\n\r\n            const updated = await tx.installmentPayment.update({\r\n                where: { id },\r\n                data: {\r\n                    amount: updates.amount,\r\n                    notes: updates.notes,\r\n                    paymentDate: updates.paymentDate ? new Date(updates.paymentDate) : undefined\r\n                }\r\n            });\r\n\r\n            if (current.cashTransactionId) {\r\n                await tx.cashTransaction.update({\r\n                    where: { id: current.cashTransactionId },\r\n                    data: {\r\n                        amount: updates.amount,\r\n                        date: updates.paymentDate ? new Date(updates.paymentDate) : undefined\r\n                    }\r\n                });\r\n            }\r\n\r\n            return updated;\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error updating installment payment:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteInstallmentPaymentAction(id: string) {\r\n    try {\r\n        await db.$transaction(async (tx: any) => {\r\n            const payment = await tx.installmentPayment.findUnique({\r\n                where: { id },\r\n                select: { cashTransactionId: true }\r\n            });\r\n\r\n            if (payment?.cashTransactionId) {\r\n                await tx.cashTransaction.delete({\r\n                    where: { id: payment.cashTransactionId }\r\n                });\r\n            }\r\n\r\n            await tx.installmentPayment.delete({\r\n                where: { id }\r\n            });\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error deleting installment payment:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function linkInstallmentToCashAction(paymentId: string, accountId: string, locationId: string, userId: string) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            const payment = await tx.installmentPayment.findUnique({\r\n                where: { id: paymentId },\r\n                include: { sale: true }\r\n            });\r\n\r\n            if (!payment) throw new Error(\"Payment not found\");\r\n            if (payment.cashTransactionId) throw new Error(\"Payment already linked\");\r\n\r\n            const description = payment.sale\r\n                ? `Installment payment for ${payment.sale.customerName} - Receipt #${payment.sale.receiptNumber}`\r\n                : `Installment payment #${paymentId.substring(0, 8)}`;\r\n\r\n            const cashTx = await tx.cashTransaction.create({\r\n                data: {\r\n                    userId,\r\n                    branchId: locationId,\r\n                    accountId,\r\n                    amount: payment.amount,\r\n                    transactionType: 'cash_in',\r\n                    category: 'Installment payment',\r\n                    description,\r\n                    date: payment.paymentDate,\r\n                }\r\n            });\r\n\r\n            await tx.installmentPayment.update({\r\n                where: { id: paymentId },\r\n                data: { cashTransactionId: cashTx.id }\r\n            });\r\n\r\n            return cashTx;\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error linking installment to cash:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function unlinkInstallmentFromCashAction(paymentId: string) {\r\n    try {\r\n        await db.$transaction(async (tx: any) => {\r\n            const payment = await tx.installmentPayment.findUnique({\r\n                where: { id: paymentId },\r\n                select: { cashTransactionId: true }\r\n            });\r\n\r\n            if (!payment?.cashTransactionId) throw new Error(\"Payment not linked\");\r\n\r\n            await tx.cashTransaction.delete({\r\n                where: { id: payment.cashTransactionId }\r\n            });\r\n\r\n            await tx.installmentPayment.update({\r\n                where: { id: paymentId },\r\n                data: { cashTransactionId: null }\r\n            });\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error unlinking installment from cash:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- EXPENSE CATEGORIES ---\r\n\r\nexport async function getExpenseCategoriesAction(locationId: string) {\r\n    try {\r\n        const categories = await db.expenseCategory.findMany({\r\n            where: { branchId: locationId },\r\n            orderBy: [{ isDefault: 'desc' }, { name: 'asc' }]\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: categories.map((c: any) => ({\r\n                id: c.id,\r\n                name: c.name,\r\n                isDefault: c.isDefault,\r\n                createdAt: c.createdAt.toISOString()\r\n            }))\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error fetching expense categories:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createExpenseCategoryAction(data: any) {\r\n    try {\r\n        const result = await db.expenseCategory.create({\r\n            data: {\r\n                userId: data.userId,\r\n                branchId: data.locationId,\r\n                name: data.name,\r\n                isDefault: data.isDefault || false\r\n            }\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error creating expense category:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteExpenseCategoryAction(id: string) {\r\n    try {\r\n        await db.expenseCategory.delete({\r\n            where: { id }\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error deleting expense category:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createDefaultExpenseCategoriesAction(userId: string, locationId: string, categoryNames: string[]) {\r\n    try {\r\n        const data = categoryNames.map(name => ({\r\n            userId,\r\n            branchId: locationId,\r\n            name,\r\n            isDefault: true\r\n        }));\r\n\r\n        await db.expenseCategory.createMany({\r\n            data,\r\n            skipDuplicates: true\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error creating default categories:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- CASH ACCOUNTS ---\r\n\r\nexport async function getCashAccountsAction(locationId: string) {\r\n    try {\r\n        const accounts = await db.cashAccount.findMany({\r\n            where: { branchId: locationId },\r\n            orderBy: [{ isDefault: 'desc' }, { name: 'asc' }]\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: accounts.map((a: any) => ({\r\n                id: a.id,\r\n                name: a.name,\r\n                description: a.description,\r\n                openingBalance: Number(a.initialBalance),\r\n                isDefault: a.isDefault,\r\n                createdAt: a.createdAt.toISOString(),\r\n                updatedAt: a.updatedAt.toISOString()\r\n            }))\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error fetching cash accounts:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createCashAccountAction(data: any) {\r\n    try {\r\n        const result = await db.cashAccount.create({\r\n            data: {\r\n                userId: data.userId,\r\n                branchId: data.locationId,\r\n                name: data.name,\r\n                description: data.description || null,\r\n                initialBalance: data.openingBalance || 0,\r\n                isDefault: data.isDefault || false\r\n            }\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error creating cash account:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function updateCashAccountAction(id: string, updates: any) {\r\n    try {\r\n        const result = await db.cashAccount.update({\r\n            where: { id },\r\n            data: {\r\n                name: updates.name,\r\n                description: updates.description,\r\n                initialBalance: updates.openingBalance,\r\n                isDefault: updates.isDefault\r\n            }\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error updating cash account:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteCashAccountAction(id: string, locationId: string) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            const txCount = await tx.cashTransaction.count({\r\n                where: { accountId: id, branchId: locationId }\r\n            });\r\n\r\n            const expCount = await tx.expense.count({\r\n                where: { cashAccountId: id, branchId: locationId }\r\n            });\r\n\r\n            if (txCount > 0 || expCount > 0) {\r\n                return {\r\n                    success: false,\r\n                    hasTransactions: true,\r\n                    details: `Account has ${txCount} transactions and ${expCount} expenses.`\r\n                };\r\n            }\r\n\r\n            await tx.cashAccount.delete({\r\n                where: { id, locationId }\r\n            });\r\n\r\n            return { success: true, hasTransactions: false };\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return result;\r\n    } catch (error: any) {\r\n        console.error('Error deleting cash account:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteCashAccountWithTransactionsAction(id: string, locationId: string, deleteTransactions: boolean) {\r\n    try {\r\n        await db.$transaction(async (tx: any) => {\r\n            if (deleteTransactions) {\r\n                await tx.cashTransaction.deleteMany({\r\n                    where: { accountId: id, branchId: locationId }\r\n                });\r\n                await tx.expense.updateMany({\r\n                    where: { cashAccountId: id, branchId: locationId },\r\n                    data: { cashAccountId: null, cashTransactionId: null }\r\n                });\r\n            } else {\r\n                await tx.cashTransaction.updateMany({\r\n                    where: { accountId: id, branchId: locationId },\r\n                    data: { accountId: null }\r\n                });\r\n                await tx.expense.updateMany({\r\n                    where: { cashAccountId: id, branchId: locationId },\r\n                    data: { cashAccountId: null, cashTransactionId: null }\r\n                });\r\n            }\r\n\r\n            await tx.cashAccount.delete({\r\n                where: { id, branchId: locationId }\r\n            });\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error deleting cash account with transactions:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function getCashAccountBalanceAction(accountId: string, locationId: string) {\r\n    try {\r\n        const account = await db.cashAccount.findUnique({\r\n            where: { id: accountId },\r\n            select: { initialBalance: true }\r\n        });\r\n\r\n        if (!account) return { success: false, error: 'Account not found' };\r\n\r\n        const transactions = await db.cashTransaction.findMany({\r\n            where: { accountId, branchId: locationId },\r\n            select: { amount: true, transactionType: true }\r\n        });\r\n\r\n        let balance = Number(account.initialBalance);\r\n        for (const tx of transactions) {\r\n            const amount = Number(tx.amount);\r\n            if (tx.transactionType === 'cash_in' || tx.transactionType === 'transfer_in') {\r\n                balance += amount;\r\n            } else if (tx.transactionType === 'cash_out' || tx.transactionType === 'transfer_out') {\r\n                balance -= amount;\r\n            }\r\n        }\r\n\r\n        return { success: true, data: balance };\r\n    } catch (error: any) {\r\n        console.error('Error calculating account balance:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- CASH TRANSACTIONS ---\r\n\r\nexport async function getCashTransactionsAction(locationId: string, accountId?: string) {\r\n    try {\r\n        const where: any = { branchId: locationId };\r\n        if (accountId) where.accountId = accountId;\r\n\r\n        const transactions = await db.cashTransaction.findMany({\r\n            where,\r\n            orderBy: [{ date: 'desc' }, { createdAt: 'desc' }]\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: transactions.map((t: any) => ({\r\n                ...t,\r\n                created_at: t.createdAt.toISOString(),\r\n                updated_at: t.updatedAt.toISOString(),\r\n                user_id: t.userId,\r\n                account_id: t.accountId,\r\n                location_id: t.locationId,\r\n                transaction_type: t.transactionType,\r\n                person_in_charge: t.personInCharge,\r\n                payment_method: t.paymentMethod,\r\n                receipt_image: t.receiptImage\r\n            }))\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error fetching cash transactions:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createCashTransactionAction(data: any) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            if (data.transactionType === 'transfer' && data.toAccountId) {\r\n                const txOut = await tx.cashTransaction.create({\r\n                    data: {\r\n                        userId: data.userId,\r\n                        locationId: data.locationId,\r\n                        accountId: data.accountId,\r\n                        amount: data.amount,\r\n                        transactionType: 'transfer_out',\r\n                        description: data.description,\r\n                        date: data.date ? new Date(data.date) : new Date(),\r\n                        category: data.category || 'Transfer'\r\n                    }\r\n                });\r\n\r\n                const txIn = await tx.cashTransaction.create({\r\n                    data: {\r\n                        userId: data.userId,\r\n                        locationId: data.locationId,\r\n                        accountId: data.toAccountId,\r\n                        amount: data.amount,\r\n                        transactionType: 'transfer_in',\r\n                        description: data.description,\r\n                        date: data.date ? new Date(data.date) : new Date(),\r\n                        category: data.category || 'Transfer'\r\n                    }\r\n                });\r\n\r\n                return [txOut, txIn];\r\n            } else {\r\n                const transaction = await tx.cashTransaction.create({\r\n                    data: {\r\n                        userId: data.userId,\r\n                        branchId: data.locationId,\r\n                        accountId: data.accountId,\r\n                        amount: data.amount,\r\n                        transactionType: data.transactionType,\r\n                        category: data.category,\r\n                        description: data.description,\r\n                        personInCharge: data.personInCharge,\r\n                        tags: data.tags,\r\n                        date: data.date ? new Date(data.date) : new Date(),\r\n                        paymentMethod: data.paymentMethod,\r\n                        receiptImage: data.receiptImage\r\n                    }\r\n                });\r\n                return transaction;\r\n            }\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error creating cash transaction:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function updateCashTransactionAction(id: string, updates: any) {\r\n    try {\r\n        const result = await db.cashTransaction.update({\r\n            where: { id },\r\n            data: {\r\n                accountId: updates.accountId,\r\n                amount: updates.amount,\r\n                transactionType: updates.transactionType,\r\n                category: updates.category,\r\n                description: updates.description,\r\n                personInCharge: updates.personInCharge,\r\n                tags: updates.tags,\r\n                date: updates.date ? new Date(updates.date) : undefined,\r\n                paymentMethod: updates.paymentMethod,\r\n                receiptImage: updates.receiptImage\r\n            }\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error updating cash transaction:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function findCashTransactionAction(id: string) {\r\n    try {\r\n        const transaction = await db.cashTransaction.findUnique({\r\n            where: { id },\r\n            select: { accountId: true }\r\n        });\r\n\r\n        return { success: true, data: transaction };\r\n    } catch (error: any) {\r\n        console.error('Error finding cash transaction:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function deleteCashTransactionAction(id: string, locationId: string) {\r\n    try {\r\n        await db.$transaction(async (tx: any) => {\r\n            await tx.installmentPayment.updateMany({\r\n                where: { cashTransactionId: id },\r\n                data: { cashTransactionId: null }\r\n            });\r\n\r\n            await tx.cashTransaction.delete({\r\n                where: { id, branchId: locationId }\r\n            });\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error deleting cash transaction:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function getAccountOpeningBalanceAction(accountId: string, locationId: string) {\r\n    try {\r\n        const account = await db.cashAccount.findFirst({\r\n            where: { id: accountId, branchId: locationId },\r\n            select: { initialBalance: true }\r\n        });\r\n\r\n        return { success: true, data: Number(account?.initialBalance || 0) };\r\n    } catch (error: any) {\r\n        console.error('Error fetching opening balance:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function createBulkCashTransactionsAction(transactions: any[]) {\r\n    try {\r\n        const result = await db.$transaction(async (tx: any) => {\r\n            const created = [];\r\n            for (const data of transactions) {\r\n                if (data.transactionType === 'transfer' && data.toAccountId) {\r\n                    created.push(await tx.cashTransaction.create({\r\n                        data: {\r\n                            userId: data.userId,\r\n                            branchId: data.locationId,\r\n                            accountId: data.accountId,\r\n                            amount: data.amount,\r\n                            transactionType: 'transfer_out',\r\n                            description: data.description,\r\n                            date: data.date ? new Date(data.date) : new Date(),\r\n                            category: data.category || 'Transfer'\r\n                        }\r\n                    }));\r\n                    created.push(await tx.cashTransaction.create({\r\n                        data: {\r\n                            userId: data.userId,\r\n                            branchId: data.locationId,\r\n                            accountId: data.toAccountId,\r\n                            amount: data.amount,\r\n                            transactionType: 'transfer_in',\r\n                            description: data.description,\r\n                            date: data.date ? new Date(data.date) : new Date(),\r\n                            category: data.category || 'Transfer'\r\n                        }\r\n                    }));\r\n                } else {\r\n                    created.push(await tx.cashTransaction.create({\r\n                        data: {\r\n                            userId: data.userId,\r\n                            branchId: data.locationId,\r\n                            accountId: data.accountId,\r\n                            amount: data.amount,\r\n                            transactionType: data.transactionType,\r\n                            category: data.category,\r\n                            description: data.description,\r\n                            personInCharge: data.personInCharge,\r\n                            tags: data.tags,\r\n                            date: data.date ? new Date(data.date) : new Date(),\r\n                            paymentMethod: data.paymentMethod,\r\n                            receiptImage: data.receiptImage\r\n                        }\r\n                    }));\r\n                }\r\n            }\r\n            return created;\r\n        });\r\n\r\n        revalidatePath('/finance');\r\n        return { success: true, data: result };\r\n    } catch (error: any) {\r\n        console.error('Error creating bulk transactions:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}