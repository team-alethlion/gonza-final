module.exports=[784784,597480,812019,580716,9719,262285,a=>{"use strict";var b=a.i(572131),c=a.i(169819);let d=()=>{let[a,d]=(0,b.useState)(!1),{currentBusiness:e}=(0,c.useBusiness)(),f=(0,b.useMemo)(()=>e?.id?`sale_draft_${e.id}`:"sale_draft",[e?.id]),g=(0,b.useCallback)(()=>{let a=!!localStorage.getItem(f);return d(a),a},[f]);(0,b.useEffect)(()=>{e?.id&&g()},[g,e?.id]);let h=(0,b.useCallback)((a,b)=>{if(!e?.id)return;let c={formData:a,selectedDate:b.toISOString(),savedAt:new Date().toISOString()};localStorage.setItem(f,JSON.stringify(c)),d(!0)},[f,e?.id]);return{hasDraft:a,saveDraft:h,loadDraft:(0,b.useCallback)(()=>{let a=localStorage.getItem(f);if(a)try{let b=JSON.parse(a);return{formData:b.formData,selectedDate:new Date(b.selectedDate),savedAt:new Date(b.savedAt)}}catch(a){console.error("Error parsing draft:",a),localStorage.removeItem(f),d(!1)}return null},[f]),clearDraft:(0,b.useCallback)(()=>{localStorage.removeItem(f),d(!1)},[f]),checkForDraft:g}};a.s(["useNewSaleDraft",0,a=>{let[c,e]=(0,b.useState)(!1),[f,g]=(0,b.useState)(null),{hasDraft:h,loadDraft:i,clearDraft:j,checkForDraft:k}=d();return(0,b.useEffect)(()=>{if(!a&&k()){let a=i();a&&g(a)}},[a,k,i]),{showDraftNotification:!1,draftData:f,handleLoadDraft:()=>{g(null)},handleDismissDraft:()=>{j(),e(!1),g(null)},clearDraft:j}}],784784);var e=a.i(50944),f=a.i(391956),g=a.i(478793),h=a.i(100260),i=a.i(737139),j=a.i(347778),k=a.i(201643);let l=a=>{let{products:d}=(0,j.useProducts)(a),{currentBusiness:e}=(0,c.useBusiness)(),{deductStockForSale:f,adjustStockForEditedSale:g}=(0,k.useInventoryActions)(a),[h,i]=(0,b.useState)({});return{products:d,selectedProducts:h,selectProduct:(a,b)=>{i(c=>({...c,[a]:b}))},getProductForItem:a=>{let b=h[a];return b&&d.find(a=>a.id===b)||null},updateInventoryForSale:async(a,b,c,d,g)=>"Quote"===b||f(a,d,c,g,e?.id),updateInventoryForEditedSale:async(a,b,c,d,f,h,i)=>{let j="Quote"!==i,k="Quote"!==c;return!j&&!k||g(j?a:[],k?b:[],f,d,h,e?.id)}}};var m=a.i(823292),n=a.i(258956),o=a.i(790341),p=a.i(965643),q=a.i(866102),r=a.i(405050);let s=(0,r.createServerReference)("602de18dc3faf52666fcf9224768f7ac9c1a6340ca",r.callServer,void 0,r.findSourceMapURL,"getCustomerByNameAction"),t=(0,r.createServerReference)("601a24df33adeed822b4de1bc4a7ea1dad51e405a6",r.callServer,void 0,r.findSourceMapURL,"updateSaleCustomerAction");var u=a.i(602703);a.s(["useNewSaleActions",0,(a,d)=>{let j=(0,e.useRouter)(),{user:k}=(0,f.useAuth)(),{toast:r}=(0,g.useToast)(),{customers:v,createCustomer:w}=(0,h.useCustomers)(),{addSale:x,updateSale:y}=(0,i.useSalesData)(k?.id),{updateInventoryForSale:z,updateInventoryForEditedSale:A}=l(k?.id),{logActivity:B}=(0,n.useActivityLogger)(),{currentBusiness:C}=(0,c.useBusiness)(),{settings:D}=(0,q.useBusinessSettings)(),[E,F]=(0,b.useState)(!1),[G,H]=(0,b.useState)(null),[I,J]=(0,b.useState)(!1),[K,L]=(0,b.useState)(!0),M=(0,b.useCallback)(async(b,c=!1,e=!0,f,g,h,i=!1)=>{if(!a&&g&&g(),k?.id&&b.customerName.trim()){let a=b.customerId;if(!a){let c=await s(C?.id||"",b.customerName.trim());if(c)a=c.id;else try{let c=await w({fullName:b.customerName,phoneNumber:b.customerContact||null,location:b.customerAddress||null,email:null,birthday:null,gender:null,categoryId:f||null,notes:null,tags:null,socialMedia:null});c&&(a=c.id,m.toast.success(`Added ${b.customerName} to your customers list`))}catch(a){console.error("Error adding customer:",a)}}if(a&&b.id)try{await t(b.id,a)}catch(a){console.error("Error associating sale with customer:",a)}}if(!(a?await A(a.items,b.items,b.paymentStatus,void 0,b.id,b.receiptNumber,a.paymentStatus):await z(b.items,b.paymentStatus,h,b.id,b.receiptNumber)))throw console.error("Inventory update failed. Initiating rollback..."),a?r({title:"Inventory Update Failed",description:"The sale was saved, but inventory could not be updated. Please check stock levels manually.",variant:"destructive"}):await (0,u.deleteSaleAction)(b.id)?r({title:"Sale Cancelled",description:"Inventory update failed, so the sale was cancelled to ensure data consistency.",variant:"destructive"}):(console.error("CRITICAL: Failed to rollback sale after inventory failure"),r({title:"Critical Error",description:"Inventory failed to update, and we could not cancel the sale. Please contact support.",variant:"destructive"})),Error("Inventory update failed");let l=b.items.reduce((a,b)=>{let c=b.price*b.quantity,d="amount"===b.discountType?b.discountAmount||0:c*(b.discountPercentage||0)/100;return a+(c-d)},0),n=b.taxRate?l*b.taxRate/100:0,q=l+n;if(await B({activityType:a?"UPDATE":"CREATE",module:"SALES",entityType:"sale",entityId:b.id,entityName:`Sale #${b.receiptNumber}`,description:`${a?"Updated":"Created"} sale for ${b.customerName} - Total: UGX ${q.toLocaleString()}`,metadata:{receiptNumber:b.receiptNumber,customerName:b.customerName,customerAddress:b.customerAddress,customerContact:b.customerContact,totalAmount:q,amountPaid:b.amountPaid,profit:b.profit,paymentStatus:b.paymentStatus,taxRate:b.taxRate,itemCount:b.items.length,items:b.items.map(a=>({description:a.description,quantity:a.quantity,price:a.price,cost:a.cost,total:a.quantity*a.price,discountPercentage:a.discountPercentage,discountAmount:a.discountAmount})),notes:b.notes}}),r({title:a?"Sale Updated":"Sale Created",description:`${a?"Updated":"Created"} sale for ${b.customerName}. ${"NOT PAID"===b.paymentStatus?"Inventory has been updated for this credit sale.":""}`}),Object.keys(localStorage).forEach(a=>{a.startsWith("soldItems_")&&localStorage.removeItem(a)}),H(b),a?y(b):x(b),L(e),c){if(F(!0),i)try{let a=await (0,o.generateThermalReceipt)(b,D);await (0,p.print)(a,D.defaultPrinterName)}catch(a){console.error("Auto-print failed:",a),m.toast.error("Automated thermal printing failed")}}else!a&&d?d():j.push("/sales")},[k?.id,w,a,r,j,B,x,y,d]),N=(0,b.useCallback)(()=>{F(!1),!a&&d?d():j.push("/sales")},[j,a,d]);return{isReceiptOpen:E,completedSale:G,newCustomerDialogOpen:I,includePaymentInfo:K,customers:v,handleSaleComplete:M,handleReceiptClose:N,handleAddCustomer:(0,b.useCallback)(async a=>{if(!k?.id)return!1;try{if(await w(a))return J(!1),!0;return!1}catch(a){return console.error("Error adding customer:",a),!1}},[k?.id,w]),handleOpenNewCustomerDialog:(0,b.useCallback)(()=>{J(!0)},[]),setNewCustomerDialogOpen:J}}],597480);var v=a.i(187924);a.s(["default",0,()=>(0,v.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,v.jsxs)("div",{className:"animate-pulse",children:[(0,v.jsx)("div",{className:"h-8 bg-gray-200 rounded w-48 mb-4"}),(0,v.jsx)("div",{className:"h-64 bg-gray-200 rounded"})]})})],812019),a.s(["default",0,()=>{let a=(0,e.useRouter)();return(0,v.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,v.jsxs)("div",{className:"bg-amber-50 border border-amber-200 p-4 rounded-md",children:[(0,v.jsx)("p",{className:"text-amber-800 mb-4",children:"No business location found. Please create a business location to manage sales."}),(0,v.jsx)("button",{onClick:()=>a.push("/business-management"),className:"bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700",children:"Manage Business Locations"})]})})}],580716),a.s(["default",0,()=>(0,v.jsx)("div",{className:"bg-amber-50 border border-amber-200 p-4 rounded-md mb-6",children:(0,v.jsx)("p",{className:"text-amber-800",children:"You need to be signed in to create or edit sales. All sales are saved to your Supabase database."})})],9719);var w=a.i(635785),x=a.i(533018),y=a.i(3048),z=a.i(291914);let A={description:"",quantity:1,price:0,cost:0},B={description:"",quantity:1,price:0,cost:0};var C=a.i(209079),D=a.i(129743);let E=(0,r.createServerReference)("40db42f6103f55b9f7ade5c65ca70a00feff7ff278",r.callServer,void 0,r.findSourceMapURL,"findCashTransactionAction");var F=a.i(842544),G=a.i(225126),H=a.i(433217);let I=(0,r.createServerReference)("707be093cac72269888b676c90752075900286c135",r.callServer,void 0,r.findSourceMapURL,"upsertSaleAction");var J=a.i(591119),K=a.i(699570),L=a.i(400210),M=a.i(787654),N=a.i(256711),O=a.i(730769),P=a.i(320146),Q=a.i(599209),R=a.i(870430),S=a.i(368114);let T=({selectedDate:a,onDateChange:b})=>(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"date",children:"Date"}),(0,v.jsxs)(Q.Popover,{children:[(0,v.jsx)(Q.PopoverTrigger,{asChild:!0,children:(0,v.jsxs)(K.Button,{variant:"outline",className:(0,S.cn)("w-full justify-start text-left font-normal",!a&&"text-muted-foreground"),children:[(0,v.jsx)(O.CalendarIcon,{className:"mr-2 h-4 w-4"}),a?(0,N.format)(a,"PPP"):(0,v.jsx)("span",{children:"Pick a date"})]})}),(0,v.jsx)(Q.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,v.jsx)(P.Calendar,{mode:"single",selected:a,onSelect:a=>{a&&b(new Date(a.getFullYear(),a.getMonth(),a.getDate(),12,0,0))},initialFocus:!0,className:(0,S.cn)("p-3 pointer-events-auto")})})]})]});var U=a.i(866718),V=a.i(533441),W=a.i(580701),X=a.i(662432);let Y=({customerName:a,customerAddress:c,customerContact:d,notes:e="",onCustomerInfoChange:f,errors:g,customers:h=[],onAddNewCustomer:i,onSelectCustomer:j,selectedCategoryId:k,onCategoryChange:l})=>{let[m,n]=(0,b.useState)(!1),[o,p]=(0,b.useState)(""),[q,r]=(0,b.useState)(""),{categories:s}=(0,X.useCustomerCategories)(),t=h?.filter(a=>a.fullName.toLowerCase().includes(o.toLowerCase()))||[];(0,b.useEffect)(()=>{if(p(a),a.trim()){let b=h.find(b=>b.fullName===a);if(b&&b.categoryId){let a=s.find(a=>a.id===b.categoryId);r(a?.name||"")}else r("")}else r("")},[a,h,s]),(0,b.useEffect)(()=>{if(k){let a=s.find(a=>a.id===k);r(a?.name||"")}else r("")},[k,s]);let u=a.trim()&&h.some(b=>b.fullName===a);return(0,v.jsxs)("div",{className:"space-y-4",children:[(0,v.jsx)("h3",{className:"text-lg font-semibold",children:"Customer Information"}),(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"customerName",children:"Customer Name"}),(0,v.jsxs)("div",{className:"flex flex-col space-y-2 relative",children:[(0,v.jsx)(U.Input,{id:"customerName",name:"customerName",value:a,onChange:a=>{let b=a.target.value;p(b),f(a),b.trim()?n(!0):(n(!1),r(""),l&&l(""))},onFocus:()=>o.trim()&&n(!0),onBlur:()=>{setTimeout(()=>{n(!1)},200)},onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),document.getElementById("customerAddress")?.focus())},className:(0,S.cn)(g.customerName?"border-red-500":"","w-full"),placeholder:"Start typing customer name...",autoComplete:"off"}),m&&(0,v.jsx)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border rounded-md shadow-lg z-50 max-h-60 overflow-y-auto",children:t.length>0?t.map(b=>{let c=(a=>{if(!a)return null;let b=s.find(b=>b.id===a);return b?.name||null})(b.categoryId||null);return(0,v.jsx)("div",{className:"px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b last:border-0 border-gray-100 dark:border-gray-700 transition-colors",onMouseDown:a=>{a.preventDefault();if(n(!1),j&&j(b),b.categoryId){let a=s.find(a=>a.id===b.categoryId);r(a?.name||""),l&&l(b.categoryId)}else r(""),l&&l("")},children:(0,v.jsx)("div",{className:"flex items-start justify-between gap-2",children:(0,v.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,v.jsxs)("div",{className:"flex items-center gap-2 mb-0.5",children:[a===b.fullName&&(0,v.jsx)(V.Check,{className:"h-4 w-4 text-green-500 shrink-0"}),(0,v.jsx)("span",{className:"font-medium text-sm truncate uppercase tracking-tight",children:b.fullName}),c&&(0,v.jsx)("span",{className:"text-[10px] font-bold bg-primary/10 text-primary px-1.5 py-0.5 rounded leading-none uppercase",children:c})]}),(0,v.jsxs)("div",{className:"flex flex-wrap gap-x-3 gap-y-1 text-xs text-muted-foreground mt-1",children:[b.location&&(0,v.jsxs)("span",{className:"flex items-center gap-1",children:[(0,v.jsx)("span",{className:"opacity-70 italic text-[11px]",children:"at"})," ",b.location]}),b.phoneNumber&&(0,v.jsx)("span",{className:"flex items-center gap-1",children:(0,v.jsx)("span",{className:"opacity-70 tabular-nums",children:b.phoneNumber})})]})]})})},b.id)}):(0,v.jsxs)("div",{className:"px-4 py-6 text-center text-muted-foreground",children:[(0,v.jsx)("p",{className:"text-sm",children:"No customers found"}),(0,v.jsx)("p",{className:"text-xs opacity-70 mt-1",children:"Try a different search or add a new customer"})]})}),g.customerName&&(0,v.jsx)("p",{className:"text-red-500 text-xs",children:g.customerName})]})]}),(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"customerAddress",children:"Customer Address"}),(0,v.jsx)(U.Input,{id:"customerAddress",name:"customerAddress",value:c,onChange:f,onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),document.getElementById("customerContact")?.focus())}})]}),(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"customerContact",children:"Customer Contact"}),(0,v.jsx)(U.Input,{id:"customerContact",name:"customerContact",value:d,onChange:f,onKeyDown:a=>{if("Enter"===a.key){a.preventDefault();let b=document.getElementById("customerCategory"),c=document.querySelector('[role="combobox"]');b?b.focus():c?c.focus():document.getElementById("description-0")?.focus()}}})]}),(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"customerCategory",children:"Customer Category"}),u?(0,v.jsx)(U.Input,{id:"customerCategory",value:q,readOnly:!0,className:"bg-gray-50 dark:bg-gray-800",placeholder:"Category from existing customer",onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),document.getElementById("description-0")?.focus())}}):(0,v.jsxs)(W.Select,{value:k||"none",onValueChange:a=>{if("none"===a)r(""),l&&l("");else{let b=s.find(b=>b.id===a);b&&(r(b.name),l&&l(a))}},onOpenChange:a=>{a||setTimeout(()=>{document.getElementById("description-0")?.focus()},100)},children:[(0,v.jsx)(W.SelectTrigger,{onKeyDown:a=>{"Enter"===a.key&&setTimeout(()=>{document.getElementById("description-0")?.focus()},100)},children:(0,v.jsx)(W.SelectValue,{placeholder:"Select a category"})}),(0,v.jsxs)(W.SelectContent,{children:[(0,v.jsx)(W.SelectItem,{value:"none",children:"No Category"}),s.filter(a=>a.id&&""!==a.id.trim()).map(a=>(0,v.jsx)(W.SelectItem,{value:a.id,children:a.name},a.id))]})]})]}),i&&(0,v.jsx)(K.Button,{type:"button",variant:"outline",onClick:i,className:"w-full mt-2",children:"Add New Customer"})]})},Z=({isEditing:a,selectedDate:b,onDateChange:c,customerName:d,customerAddress:f,customerContact:g,notes:h,onCustomerInfoChange:i,errors:j,customers:k,onAddNewCustomer:l,onSelectCustomer:m,selectedCategoryId:n,onCategoryChange:o,onClearForm:p})=>{let q=(0,e.useRouter)();return(0,v.jsxs)(J.Card,{className:"mb-6",children:[(0,v.jsx)(J.CardHeader,{children:(0,v.jsxs)("div",{className:"flex items-center justify-between",children:[(0,v.jsxs)("div",{className:"flex items-center gap-3",children:[(0,v.jsx)(K.Button,{variant:"ghost",size:"icon",onClick:()=>{q.push("/sales")},type:"button",className:"h-8 w-8",children:(0,v.jsx)(L.ArrowLeft,{className:"h-4 w-4"})}),(0,v.jsxs)("div",{children:[(0,v.jsx)(J.CardTitle,{children:a?"Edit Sale":"New Sale"}),(0,v.jsx)(J.CardDescription,{children:"Enter the sale details below"})]})]}),!a&&p&&(0,v.jsxs)(K.Button,{variant:"outline",size:"sm",onClick:p,type:"button",className:"flex items-center gap-2",children:[(0,v.jsx)(M.RotateCcw,{className:"h-4 w-4"}),"Clear Form"]})]})}),(0,v.jsxs)(J.CardContent,{className:"space-y-6",children:[(0,v.jsx)(T,{selectedDate:b,onDateChange:c}),(0,v.jsx)(Y,{customerName:d,customerAddress:f,customerContact:g,notes:h,onCustomerInfoChange:i,errors:j,customers:k,onAddNewCustomer:l,onSelectCustomer:m,selectedCategoryId:n,onCategoryChange:o})]})]})};var $=a.i(915618),_=a.i(429246),aa=a.i(781560),ab=a.i(177156),ac=a.i(141379);let ad=(0,a.i(170106).default)("Eraser",[["path",{d:"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21",key:"182aya"}],["path",{d:"M22 21H7",key:"t4ddhn"}],["path",{d:"m5 11 9 9",key:"1mo9qw"}]]);var ae=a.i(770094),af=a.i(243920),ag=a.i(785259),ah=a.i(421234),ai=a.i(786304),aj=a.i(896378),ak=a.i(400291);let al=({item:a,index:d,onUpdate:e,onRemove:g,saleDate:h})=>{let i,j,{settings:k}=(0,q.useBusinessSettings)(),l=k.currency||"USD",{user:n}=(0,f.useAuth)(),{currentBusiness:o}=(0,c.useBusiness)(),{canViewCostPrice:p,canViewSellingPrice:r,formatFinancial:s}=(0,ak.useFinancialVisibility)(),[t,u]=(0,b.useState)(a.description||""),w=(0,ae.useIsMobile)(),[x,z]=(0,b.useState)(!1),[A,B]=(0,b.useState)(!1),[C,D]=(0,b.useState)((0,S.formatNumberInput)(a.quantity?.toString()||"0")),[E,F]=(0,b.useState)((0,S.formatNumberInput)(a.price?.toString()||"0")),[G,I]=(0,b.useState)((0,S.formatNumberInput)(a.cost?.toString()||"0")),[J,L]=(0,b.useState)((0,S.formatNumberInput)(a.discountAmount?.toString()||"0")),[M,N]=(0,b.useState)((0,S.formatNumberInput)(a.discountPercentage?.toString()||"0")),[O,P]=(0,b.useState)(a.description||"");(0,b.useEffect)(()=>{let a=setTimeout(()=>{P(t)},300);return()=>clearTimeout(a)},[t]);let{data:T=[]}=(0,H.useQuery)({queryKey:["all-products",n?.id,o?.id],queryFn:async()=>n?.id&&o?.id?await (0,y.getAllProductsAction)(n.id,o.id):[],enabled:!!n?.id&&!!o?.id,staleTime:3e5}),V=(0,b.useMemo)(()=>O.trim()?T.filter(a=>(0,aj.matchProductSearch)(a,O)).slice(0,20):[],[T,O]);(0,b.useEffect)(()=>{u(a.description||""),Math.abs((parseFloat(C.replace(/,/g,""))||0)-a.quantity)>.001&&D(0===a.quantity&&""===C?"":a.quantity.toString()),Math.abs((parseFloat(E.replace(/,/g,""))||0)-a.price)>.001&&F(0===a.price&&""===E?"":a.price.toString()),Math.abs((parseFloat(G.replace(/,/g,""))||0)-a.cost)>.001&&I(0===a.cost&&""===G?"":a.cost.toString()),Math.abs((parseFloat(J.replace(/,/g,""))||0)-(a.discountAmount||0))>.001&&L(a.discountAmount?.toString()||"0"),Math.abs((parseFloat(M.replace(/,/g,""))||0)-(a.discountPercentage||0))>.001&&N(a.discountPercentage?.toString()||"0")},[a.description,a.quantity,a.price,a.cost,a.discountAmount,a.discountPercentage]);let W=a.price*a.quantity,X="amount"===a.discountType?a.discountAmount||0:W*(a.discountPercentage||0)/100,Y=b=>{let{name:c,value:f}=b.target;if("description"===c){u(f),B(""!==f.trim());return}let g=(0,S.formatNumberInput)(f),h=(0,S.parseNumberInput)(f);if("quantity"===c){D(g),e(d,{...a,quantity:h});return}if("price"===c){F(g),e(d,{...a,price:h});return}if("cost"===c){I(g),e(d,{...a,cost:h});return}if("discountAmount"===c){L(g),e(d,{...a,discountAmount:h});return}if("discountPercentage"===c){N(g),e(d,{...a,discountPercentage:h});return}e(d,{...a,[c]:h})},Z=b=>{let c=(0,S.parseNumberInput)(b.target.value)/(a.quantity||1);I((0,S.formatNumberInput)(c.toString())),e(d,{...a,cost:c})},$=a.productId?V.find(b=>b.id===a.productId):null,al=$&&h&&(i=new Date($.createdAt),j=new Date(h).setHours(0,0,0,0),new Date(i.getFullYear(),i.getMonth(),i.getDate()).getTime()>j);return(0,v.jsxs)("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[(0,v.jsxs)("div",{className:"flex justify-between items-start",children:[(0,v.jsxs)("h3",{className:"text-sm font-medium",children:["Item ",d+1]}),(0,v.jsxs)("div",{className:"flex space-x-2",children:[(0,v.jsxs)(K.Button,{variant:"outline",size:"sm",onClick:()=>{u(""),B(!1),a.quantity;let b={...a,description:"",price:0,cost:0,productId:null,discountAmount:0,discountPercentage:0};F("0"),I("0"),L("0"),N("0"),e(d,b),m.toast.success("Item cleared")},className:"text-gray-600 hover:text-gray-800",children:[(0,v.jsx)(ad,{className:"h-4 w-4 mr-1"}),(0,v.jsx)("span",{className:"hidden sm:inline",children:"Clear"})]}),(0,v.jsxs)(K.Button,{variant:"ghost",size:"sm",onClick:()=>g(d),className:"text-destructive hover:text-destructive",children:[(0,v.jsx)(aa.Trash2,{className:"h-4 w-4"}),(0,v.jsx)("span",{className:"sr-only",children:"Remove Item"})]})]})]}),(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`description-${d}`,className:"text-sm font-medium",children:"Product / Service"}),(0,v.jsxs)("div",{className:"flex space-x-2",children:[(0,v.jsxs)("div",{className:"flex-grow relative",children:[(0,v.jsx)(_.Textarea,{id:`description-${d}`,name:"description",value:t,onChange:Y,placeholder:"Enter product name",onFocus:()=>""!==t.trim()&&B(!0),onBlur:()=>{t!==a.description&&e(d,{...a,description:t})},onKeyDown:a=>{"Enter"!==a.key||a.shiftKey||(a.preventDefault(),document.getElementById(`quantity-${d}`)?.focus())},className:w?"min-h-16 text-base":""}),A&&""!==t.trim()&&V.length>0&&(0,v.jsx)("div",{className:"absolute z-10 mt-1 w-full bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:V.map(b=>(0,v.jsxs)("div",{className:"px-4 py-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center",onClick:()=>{u(b.name),B(!1),F((0,S.formatNumberInput)(b.sellingPrice.toString())),I((0,S.formatNumberInput)(b.costPrice.toString())),e(d,{...a,description:b.name,price:b.sellingPrice,cost:b.costPrice,productId:b.id})},children:[(0,v.jsxs)("div",{className:"flex items-center",children:[(0,v.jsx)(af.default,{imageUrl:b.imageUrl,alt:b.name,size:"sm"}),(0,v.jsxs)("div",{className:"ml-3",children:[(0,v.jsxs)("div",{className:"font-medium flex items-center gap-2",children:[b.name,b.category&&(0,v.jsx)(ai.Badge,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-4 bg-gray-100 text-gray-500 font-normal",children:b.category})]}),(0,v.jsx)("div",{className:"text-xs text-gray-500",children:r?`${l} ${b.sellingPrice.toFixed(2)}`:"Price Hidden"})]})]}),(0,v.jsxs)("div",{className:"text-xs",children:[parseFloat(b.quantity.toFixed(5)).toString()," in stock"]})]},b.id))})]}),al&&(0,v.jsxs)("div",{className:"mt-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[(0,v.jsx)("p",{className:"text-sm text-red-700 font-medium",children:"ðŸš« Error: This product was created after the sale date. The sale cannot be created or updated."}),(0,v.jsx)("p",{className:"text-xs text-red-600 mt-1",children:"Please adjust the sale date or select a different product to continue."})]})]})]}),w?(0,v.jsxs)("div",{className:"space-y-4",children:[(0,v.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`quantity-${d}`,className:"text-sm font-medium",children:"Quantity"}),(0,v.jsx)(U.Input,{id:`quantity-${d}`,name:"quantity",type:"text",inputMode:"decimal",value:C,onChange:Y,onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),document.getElementById(`price-${d}`)?.focus())},className:"h-12 text-lg"})]}),(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`price-${d}`,className:"text-sm font-medium",children:"Price per unit"}),(0,v.jsx)(U.Input,{id:`price-${d}`,name:"price",type:"text",inputMode:"decimal",value:E,onChange:Y,onKeyDown:a=>{if("Enter"===a.key){a.preventDefault();let b=document.getElementById(`price-${d}`);b?.focus()}},className:"h-12 text-lg"})]})]}),(0,v.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsxs)("div",{className:"flex items-center justify-between",children:[(0,v.jsx)(R.Label,{className:"text-sm font-medium",children:"Discount"}),(0,v.jsxs)("select",{value:a.discountType||"percentage",onChange:b=>{let c=b.target.value,f={...a,discountType:c};"percentage"===c?(f.discountAmount=0,L("0")):(f.discountPercentage=0,N("0")),e(d,f)},className:"flex-shrink-0 w-12 h-8 text-xs border border-input bg-background px-1 rounded-md",children:[(0,v.jsx)("option",{value:"percentage",children:"%"}),(0,v.jsx)("option",{value:"amount",children:l})]})]}),(0,v.jsx)(U.Input,{name:"amount"===a.discountType?"discountAmount":"discountPercentage",type:"text",inputMode:"decimal",value:"amount"===a.discountType?J:M,onChange:Y,placeholder:"0",onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),document.getElementById("taxRate")?.focus())},className:"h-12 text-lg"})]}),p&&(0,v.jsx)("div",{className:"space-y-2",children:(0,v.jsxs)(ah.Collapsible,{open:x,onOpenChange:z,children:[(0,v.jsxs)("div",{className:"flex items-center justify-between",children:[(0,v.jsx)(R.Label,{className:"text-sm font-medium text-gray-500",children:"Cost Info"}),(0,v.jsx)(ah.CollapsibleTrigger,{asChild:!0,children:(0,v.jsx)(K.Button,{variant:"ghost",size:"sm",className:"p-1 h-8 w-8",children:x?(0,v.jsx)(ac.EyeOff,{className:"h-4 w-4 text-gray-500"}):(0,v.jsx)(ab.Eye,{className:"h-4 w-4 text-gray-500"})})})]}),(0,v.jsxs)(ah.CollapsibleContent,{className:"space-y-4 pt-2",children:[(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`cost-${d}`,className:"text-xs text-gray-500",children:"Cost per unit"}),(0,v.jsx)(U.Input,{id:`cost-${d}`,name:"cost",type:"text",inputMode:"decimal",value:G,onChange:Y,className:"h-12 text-lg"})]}),(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`total-cost-${d}`,className:"text-xs text-gray-500",children:"Total Cost"}),(0,v.jsx)(U.Input,{id:`total-cost-${d}`,name:"totalCost",type:"text",inputMode:"decimal",value:(0,S.formatNumber)(a.cost*a.quantity),onChange:Z,className:"h-12 text-lg font-semibold bg-gray-50"})]}),(0,v.jsx)("p",{className:"text-xs text-muted-foreground",children:"(Internal use only)"})]})]})})]})]}):(0,v.jsxs)("div",{className:"grid grid-cols-4 gap-4",children:[(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`quantity-${d}`,children:"Quantity"}),(0,v.jsx)(U.Input,{id:`quantity-${d}`,name:"quantity",type:"text",inputMode:"decimal",value:C,onChange:Y,onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),document.getElementById(`price-${d}`)?.focus())}})]}),(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`price-${d}`,children:"Price per unit"}),(0,v.jsx)(U.Input,{id:`price-${d}`,name:"price",type:"text",inputMode:"decimal",value:E,onChange:Y,onKeyDown:b=>{if("Enter"===b.key){b.preventDefault();let c=document.querySelector(`input[name="${"amount"===a.discountType?"discountAmount":"discountPercentage"}"]`);c?.focus()}}})]}),(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{children:"Discount"}),(0,v.jsxs)("div",{className:"flex gap-1",children:[(0,v.jsxs)("select",{value:a.discountType||"percentage",onChange:b=>{let c=b.target.value,f={...a,discountType:c};"percentage"===c?(f.discountAmount=0,L("0")):(f.discountPercentage=0,N("0")),e(d,f)},className:"flex-shrink-0 w-12 text-xs border border-input bg-background px-1 py-2 rounded-md",children:[(0,v.jsx)("option",{value:"percentage",children:"%"}),(0,v.jsx)("option",{value:"amount",children:l})]}),(0,v.jsx)(U.Input,{name:"amount"===a.discountType?"discountAmount":"discountPercentage",type:"text",inputMode:"decimal",value:"amount"===a.discountType?J:M,onChange:Y,placeholder:"0",onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),document.getElementById("taxRate")?.focus())},className:"flex-1"})]})]}),p&&(0,v.jsx)("div",{className:"space-y-2",children:(0,v.jsxs)(Q.Popover,{children:[(0,v.jsxs)("div",{className:"flex items-center justify-between",children:[(0,v.jsx)(R.Label,{className:"text-gray-500",children:"Cost Info"}),(0,v.jsx)(ag.TooltipProvider,{children:(0,v.jsxs)(ag.Tooltip,{children:[(0,v.jsx)(ag.TooltipTrigger,{asChild:!0,children:(0,v.jsx)(Q.PopoverTrigger,{asChild:!0,children:(0,v.jsx)(K.Button,{variant:"ghost",size:"sm",className:"p-0 h-6 w-6",children:(0,v.jsx)(ab.Eye,{className:"h-4 w-4 text-gray-500"})})})}),(0,v.jsx)(ag.TooltipContent,{children:(0,v.jsx)("p",{children:"Click to view/edit cost"})})]})})]}),(0,v.jsx)(Q.PopoverContent,{className:"w-64 p-4 bg-white shadow-xl border",children:(0,v.jsxs)("div",{className:"space-y-4",children:[(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{htmlFor:`cost-popover-${d}`,className:"text-xs",children:"Cost per unit"}),(0,v.jsx)(U.Input,{id:`cost-popover-${d}`,name:"cost",type:"text",inputMode:"decimal",value:G,onChange:Y})]}),(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsxs)(R.Label,{htmlFor:`total-cost-popover-${d}`,className:"text-xs",children:["Total Cost (for ",a.quantity," units)"]}),(0,v.jsx)(U.Input,{id:`total-cost-popover-${d}`,name:"totalCost",type:"text",value:(0,S.formatNumber)(a.cost*a.quantity),onChange:Z,className:"font-bold bg-gray-50"})]}),(0,v.jsx)("div",{className:"pt-2 border-t",children:(0,v.jsx)("p",{className:"text-[10px] text-muted-foreground",children:"Costs entered here only apply to this specific sale and do not change the product's base price in inventory."})})]})})]})})]}),(0,v.jsx)("div",{className:"pt-2 border-t mt-2",children:(0,v.jsxs)("div",{className:"flex justify-end items-center space-y-1 flex-col",children:[((a.discountPercentage||0)>0||(a.discountAmount||0)>0)&&(0,v.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,v.jsx)("span",{className:"text-xs text-muted-foreground mr-2",children:"Subtotal:"}),(0,v.jsxs)("span",{className:"text-xs text-muted-foreground line-through",children:[l," ",(0,S.formatNumber)(W)]})]}),((a.discountPercentage||0)>0||(a.discountAmount||0)>0)&&(0,v.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,v.jsxs)("span",{className:"text-xs text-green-600 mr-2",children:["Discount ","amount"===a.discountType?"":`(${a.discountPercentage}%)`,":"]}),(0,v.jsxs)("span",{className:"text-xs text-green-600",children:["-",l," ",(0,S.formatNumber)(X)]})]}),(0,v.jsxs)("div",{className:"flex justify-end items-center w-full",children:[(0,v.jsx)("span",{className:"text-sm font-medium mr-2",children:"Total:"}),(0,v.jsxs)("span",{className:"text-sm font-bold",children:[l," ",(0,S.formatNumber)(W-X)]})]})]})})]})},am=({items:a,onAddItem:b,onUpdateItem:c,onRemoveItem:d,saleDate:e})=>(0,v.jsxs)("div",{className:"space-y-4",children:[(0,v.jsx)("h3",{className:"text-lg font-semibold",children:"Items/Services"}),(0,v.jsxs)("div",{className:"space-y-4",children:[a.map((a,b)=>(0,v.jsx)("div",{id:`sale-item-${b}`,children:(0,v.jsx)(al,{item:a,index:b,onUpdate:c,onRemove:d,saleDate:e})},b)),(0,v.jsxs)(K.Button,{type:"button",variant:"outline",size:"sm",onClick:()=>b(),className:"gap-1 w-full mt-2",children:[(0,v.jsx)($.Plus,{className:"h-4 w-4"}),"Add Item"]})]})]}),an=({taxRateInput:a,onTaxRateChange:b,errors:c})=>(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"taxRate",children:"Tax Rate (%)"}),(0,v.jsx)(U.Input,{id:"taxRate",name:"taxRate",type:"text",inputMode:"decimal",value:a,onChange:b,onKeyDown:a=>{if("Enter"===a.key){a.preventDefault();let b=document.querySelector('[data-payment-status-select="true"]');if(b)b.focus();else{let a=document.querySelector('button[type="submit"]');a?.focus()}}},className:c.taxRate?"border-red-500":""}),c.taxRate&&(0,v.jsx)("p",{className:"text-red-500 text-xs",children:c.taxRate})]}),ao=({totalAmount:a,taxAmount:b,grandTotal:c,taxRate:d,currency:e})=>(0,v.jsx)("div",{className:"bg-slate-50 p-4 rounded-md border",children:(0,v.jsxs)("div",{className:"flex flex-col space-y-2",children:[(0,v.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,v.jsx)("h3",{className:"font-medium",children:"Subtotal"}),(0,v.jsxs)("span",{className:"font-medium",children:[e," ",(0,S.formatNumber)(a)]})]}),d>0&&(0,v.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,v.jsxs)("h3",{className:"font-medium",children:["Tax (",d,"%)"]}),(0,v.jsxs)("span",{className:"font-medium",children:[e," ",(0,S.formatNumber)(b)]})]}),(0,v.jsx)("div",{className:"h-px bg-gray-300 my-1"}),(0,v.jsxs)("div",{className:"flex justify-between items-center bg-gray-100 px-2 py-1 rounded-sm",children:[(0,v.jsx)("h3",{className:"font-semibold",children:"Grand Total"}),(0,v.jsxs)("span",{className:"text-xl font-bold",children:[e," ",(0,S.formatNumber)(c)]})]})]})}),ap=({items:a,onAddItem:c,onUpdateItem:d,onRemoveItem:e,taxRateInput:f,onTaxRateChange:g,errors:h,totalAmount:i,taxAmount:j,grandTotal:k,taxRate:l,currency:m,saleDate:n})=>{let o=b.default.useRef(a);return b.default.useEffect(()=>{let b=o.current,c=-1;a.length>b.length?c=a.length-1:a.length===b.length&&(c=a.findIndex((a,c)=>{let d=b[c];return d&&a.quantity!==d.quantity})),o.current=a,-1!==c&&setTimeout(()=>{let a=document.getElementById(`sale-item-${c}`);a&&a.scrollIntoView({behavior:"smooth",block:"center"})},150)},[a]),(0,v.jsx)(J.Card,{className:"mb-6",children:(0,v.jsxs)(J.CardContent,{className:"pt-6 space-y-6",children:[(0,v.jsx)(am,{items:a,onAddItem:c,onUpdateItem:d,onRemoveItem:e,saleDate:n}),(0,v.jsx)(an,{taxRateInput:f,onTaxRateChange:g,errors:h}),(0,v.jsx)(ao,{totalAmount:i,taxAmount:j,grandTotal:k,taxRate:l,currency:m})]})})},aq=({paymentStatus:a,onPaymentStatusChange:b})=>(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"paymentStatus",children:"Payment Status"}),(0,v.jsxs)(W.Select,{value:a,onValueChange:b,children:[(0,v.jsx)(W.SelectTrigger,{className:"w-full","data-payment-status-select":"true",onKeyDown:a=>{if("Enter"===a.key){a.preventDefault();let b=document.querySelector('[data-cash-account-switch="true"]');if(b)b.focus();else{let a=document.querySelector('button[type="submit"]');a?.focus()}}},children:(0,v.jsx)(W.SelectValue,{placeholder:"Select payment status"})}),(0,v.jsxs)(W.SelectContent,{children:[(0,v.jsx)(W.SelectItem,{value:"Paid",children:"Paid"}),(0,v.jsx)(W.SelectItem,{value:"NOT PAID",children:"NOT PAID"}),(0,v.jsx)(W.SelectItem,{value:"Quote",children:"Quote"}),(0,v.jsx)(W.SelectItem,{value:"Installment Sale",children:"Installment Sale"})]})]})]});var ar=a.i(206015),as=a.i(641710),at=a.i(633508),au=a.i(468976),av=a.i(179257);let aw=({payments:a,currency:c,isLoading:d,pendingChanges:e=[],isLocalMode:f=!1,onStageChange:g,cashAccounts:h=[],onLinkToCash:i,onUpdatePayment:j})=>{let[k,l]=(0,b.useState)(null),[m,n]=(0,b.useState)(null),[o,p]=(0,b.useState)(""),[q,r]=(0,b.useState)(""),[s,t]=(0,b.useState)(void 0),[u,w]=(0,b.useState)(null),[x,y]=(0,b.useState)(""),z=(a,b)=>{l(a.id),n(b||null),p(G(a).toString()),r(H(a)||""),t(a.paymentDate)},A=async a=>{j&&"deleted"!==F(a.id)&&z(a,"date")},B=async(a,b)=>{if(b&&j){console.log("ðŸ”µ Date selected:",{paymentId:a.id,oldDate:a.paymentDate,newDate:b,formattedNew:(0,N.format)(b,"yyyy-MM-dd")});try{await j(a.id,{paymentDate:b}),console.log("âœ… Date update successful"),g&&g({id:a.id,type:"update",originalPayment:a,updatedData:{paymentDate:b}}),l(null),n(null),t(void 0)}catch(b){console.error("âŒ Error updating payment date:",b),t(a.paymentDate)}}},C=async a=>{if(!g&&!j)return;let b=""===o?0:parseFloat(o)||0;g?g({id:a.id,type:"update",originalPayment:a,updatedData:{amount:b,notes:q.trim()||void 0}}):j&&await j(a.id,{amount:"amount"===m?b:void 0,notes:"notes"===m&&q.trim()||void 0}),l(null),n(null)},D=()=>{l(null),n(null),p(""),r(""),t(void 0)},E=a=>{if(!g)return;let b=0===a.amount;window.confirm(b?"Are you sure you want to remove this zero-amount payment entry?":"Are you sure you want to mark this payment for deletion?")&&(console.log("ðŸŸ¡ STAGING deletion locally - NO DATABASE CALL"),g({id:a.id,type:"delete",originalPayment:a}),console.log("âœ… Deletion staged successfully"))},F=a=>{let b=e.find(b=>b.id===a);return b?.type==="delete"?"deleted":b?.type==="update"?"modified":"original"},G=a=>{let b=e.find(b=>b.id===a.id&&"update"===b.type);return b?.updatedData?.amount||a.amount},H=a=>{let b=e.find(b=>b.id===a.id&&"update"===b.type);return b?.updatedData?.notes||a.notes},I=a=>!!f&&!!g&&"deleted"!==F(a.id),L=a=>{w(a),y("")},M=()=>{w(null),y("")},R=async a=>{if(i&&x)try{await i(a.id,x),w(null),y("")}catch(a){console.error("Error linking payment to cash account:",a)}};if(d)return(0,v.jsxs)(J.Card,{className:"border-blue-200 bg-blue-50",children:[(0,v.jsx)(J.CardHeader,{className:"pb-3",children:(0,v.jsx)(J.CardTitle,{className:"text-sm text-blue-800",children:"Payment History"})}),(0,v.jsx)(J.CardContent,{children:(0,v.jsx)("div",{className:"text-sm text-muted-foreground",children:"Loading payment history..."})})]});if(0===a.length)return(0,v.jsxs)(J.Card,{className:"border-blue-200 bg-blue-50",children:[(0,v.jsx)(J.CardHeader,{className:"pb-3",children:(0,v.jsx)(J.CardTitle,{className:"text-sm text-blue-800",children:"Payment History"})}),(0,v.jsx)(J.CardContent,{children:(0,v.jsx)("div",{className:"text-sm text-muted-foreground",children:"No payments recorded yet"})})]});let T=a.reduce((a,b)=>"deleted"===F(b.id)?a:a+G(b),0),X=f&&g;return console.log("InstallmentPaymentHistory - isLocalMode:",f,"onStageChange:",!!g,"showInlineEdit:",X),(0,v.jsxs)(J.Card,{className:"border-blue-200 bg-blue-50",children:[(0,v.jsx)(J.CardHeader,{className:"pb-3",children:(0,v.jsxs)(J.CardTitle,{className:"text-sm text-blue-800 flex items-center justify-between",children:[(0,v.jsxs)("div",{className:"flex items-center gap-2",children:["Payment History",f&&(0,v.jsx)(as.Clock,{className:"h-3 w-3 text-amber-600"}),e.length>0&&(0,v.jsxs)(ai.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:[e.length," staged"]})]}),(0,v.jsxs)(ai.Badge,{variant:"secondary",className:"bg-blue-100 text-blue-800 text-xs",children:["Total: ",c," ",(0,S.formatNumber)(T)]})]})}),(0,v.jsxs)(J.CardContent,{className:"p-3 sm:p-6",children:[X&&(0,v.jsx)("div",{className:"hidden sm:block mb-4 text-xs text-muted-foreground bg-blue-50 p-2 rounded border border-blue-200",children:"ðŸ’¡ Double-click on amount or notes to edit. Click delete button to remove payments (including zero amounts)."}),(0,v.jsx)("div",{className:"block sm:hidden space-y-3",children:a.map(a=>{let b=F(a.id),d=G(a),e=H(a),f=k===a.id,g=I(a);return(0,v.jsxs)("div",{className:`bg-white rounded-lg p-3 border shadow-sm ${"deleted"===b?"border-red-200 bg-red-50 opacity-60":"modified"===b?"border-amber-200 bg-amber-50":"border-gray-200"}`,children:[(0,v.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,v.jsxs)("div",{className:"flex items-center gap-2",children:[f&&"date"===m?(0,v.jsxs)(Q.Popover,{children:[(0,v.jsx)(Q.PopoverTrigger,{asChild:!0,children:(0,v.jsxs)(K.Button,{variant:"outline",size:"sm",className:(0,S.cn)("h-7 text-xs justify-start text-left font-normal",!s&&"text-muted-foreground"),children:[(0,v.jsx)(O.CalendarIcon,{className:"mr-2 h-3 w-3"}),s?(0,N.format)(s,"MMM dd, yyyy"):(0,v.jsx)("span",{children:"Pick a date"})]})}),(0,v.jsx)(Q.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,v.jsx)(P.Calendar,{mode:"single",selected:s,onSelect:b=>B(a,b),initialFocus:!0,className:(0,S.cn)("p-3 pointer-events-auto")})})]}):(0,v.jsx)("div",{className:`text-xs text-muted-foreground ${j?"cursor-pointer hover:text-blue-600":""}`,onClick:()=>j&&A(a),title:j?"Click to edit date":"",children:(0,N.format)(a.paymentDate,"MMM dd, yyyy")}),"deleted"===b&&(0,v.jsx)(ai.Badge,{variant:"outline",className:"text-xs bg-red-100 text-red-800 border-red-300",children:"To Delete"}),"modified"===b&&(0,v.jsx)(ai.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:"Modified"})]}),f&&"amount"===m?(0,v.jsx)("div",{className:"flex flex-col gap-2 min-w-0 flex-1 ml-2",children:(0,v.jsx)(U.Input,{type:"number",value:o,onChange:a=>p(a.target.value),className:"h-7 text-xs",step:"0.01",min:"0",placeholder:"0"})}):(0,v.jsxs)("div",{className:`text-sm font-semibold ${"deleted"===b?"line-through":""}`,children:[c," ",(0,S.formatNumber)(d)]})]}),f?(0,v.jsxs)("div",{className:"space-y-2",children:["notes"===m&&(0,v.jsx)(U.Input,{value:q,onChange:a=>r(a.target.value),placeholder:"Payment notes",className:"h-7 text-xs"}),(0,v.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,v.jsx)(K.Button,{size:"sm",variant:"outline",className:"h-6 px-2 text-xs",onClick:D,children:(0,v.jsx)(at.X,{className:"h-3 w-3"})}),(0,v.jsx)(K.Button,{size:"sm",className:"h-6 px-2 text-xs",onClick:()=>C(a),children:(0,v.jsx)(V.Check,{className:"h-3 w-3"})})]})]}):(0,v.jsxs)(v.Fragment,{children:[e&&(0,v.jsx)("div",{className:`text-xs text-muted-foreground mb-3 ${"deleted"===b?"line-through":""} ${j?"cursor-pointer hover:text-blue-600":""}`,onClick:()=>j&&z(a,"notes"),title:j?"Click to edit notes":"",children:e}),(0,v.jsxs)("div",{className:"mb-3",children:[(0,v.jsx)("div",{className:"text-xs text-muted-foreground mb-1",children:"Cash Account:"}),u===a.id?(0,v.jsxs)("div",{className:"flex items-center gap-2",children:[(0,v.jsxs)(W.Select,{value:x,onValueChange:y,children:[(0,v.jsx)(W.SelectTrigger,{className:"h-7 text-xs flex-1",children:(0,v.jsx)(W.SelectValue,{placeholder:"Select account"})}),(0,v.jsx)(W.SelectContent,{children:h.map(a=>(0,v.jsx)(W.SelectItem,{value:a.id,children:(0,v.jsxs)("div",{className:"flex items-center",children:[(0,v.jsx)("span",{children:a.name}),a.isDefault&&(0,v.jsx)("span",{className:"ml-1 text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded",children:"Default"})]})},a.id))})]}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-gray-500 hover:text-gray-700",onClick:M,children:(0,v.jsx)(at.X,{className:"h-3 w-3"})}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-green-500 hover:text-green-700",onClick:()=>R(a),disabled:!x,children:(0,v.jsx)(V.Check,{className:"h-3 w-3"})})]}):(0,v.jsx)("div",{className:"flex items-center gap-2",children:a.cashTransactionId?(0,v.jsx)(ai.Badge,{variant:"outline",className:"text-xs bg-green-100 text-green-800 border-green-300",children:"Linked"}):(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)("span",{className:"text-xs text-muted-foreground",children:"Not linked"}),i&&h.length>0&&(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-blue-500 hover:text-blue-700",onClick:()=>L(a.id),title:"Link to cash account",children:(0,v.jsx)(av.Link,{className:"h-3 w-3"})})]})})]}),X&&g&&(0,v.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,v.jsxs)(K.Button,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs text-blue-600 hover:text-blue-700 border-blue-200 hover:border-blue-300",onClick:()=>z(a),children:[(0,v.jsx)(au.Edit3,{className:"h-3 w-3 mr-1"}),"Edit"]}),(0,v.jsxs)(K.Button,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs text-red-600 hover:text-red-700 border-red-200 hover:border-red-300",onClick:()=>E(a),children:[(0,v.jsx)(aa.Trash2,{className:"h-3 w-3 mr-1"}),"Delete"]})]})]})]},a.id)})}),(0,v.jsx)("div",{className:"hidden sm:block overflow-x-auto",children:(0,v.jsxs)(ar.Table,{children:[(0,v.jsx)(ar.TableHeader,{children:(0,v.jsxs)(ar.TableRow,{children:[(0,v.jsx)(ar.TableHead,{className:"text-xs",children:"Date"}),(0,v.jsx)(ar.TableHead,{className:"text-xs text-right",children:"Amount"}),(0,v.jsx)(ar.TableHead,{className:"text-xs",children:"Notes"}),(0,v.jsx)(ar.TableHead,{className:"text-xs",children:"Cash Account"}),X&&(0,v.jsx)(ar.TableHead,{className:"text-xs w-16",children:"Actions"})]})}),(0,v.jsx)(ar.TableBody,{children:a.map(a=>{let b=F(a.id),d=G(a),e=H(a),l=k===a.id,n=I(a);return(0,v.jsxs)(ar.TableRow,{className:"deleted"===b?"bg-red-50 opacity-60":"modified"===b?"bg-amber-50":"",children:[(0,v.jsx)(ar.TableCell,{className:"text-xs",children:(0,v.jsxs)("div",{className:"flex items-center gap-2",children:[k===a.id&&"date"===m?(0,v.jsxs)("div",{className:"flex items-center gap-1",children:[(0,v.jsxs)(Q.Popover,{children:[(0,v.jsx)(Q.PopoverTrigger,{asChild:!0,children:(0,v.jsxs)(K.Button,{variant:"outline",size:"sm",className:(0,S.cn)("h-7 text-xs justify-start text-left font-normal w-32",!s&&"text-muted-foreground"),children:[(0,v.jsx)(O.CalendarIcon,{className:"mr-2 h-3 w-3"}),s?(0,N.format)(s,"MMM dd, yyyy"):(0,v.jsx)("span",{children:"Pick a date"})]})}),(0,v.jsx)(Q.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,v.jsx)(P.Calendar,{mode:"single",selected:s,onSelect:b=>B(a,b),initialFocus:!0,className:(0,S.cn)("p-3 pointer-events-auto")})})]}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,v.jsx)(at.X,{className:"h-3 w-3"})}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>C(a),children:(0,v.jsx)(V.Check,{className:"h-3 w-3"})})]}):(0,v.jsx)("span",{className:`cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===b?"line-through":""} ${j?"hover:bg-blue-50":""}`,onClick:()=>j&&A(a),title:j?"Click to edit date":"",children:(0,N.format)(a.paymentDate,"MMM dd, yyyy")}),"deleted"===b&&(0,v.jsx)(ai.Badge,{variant:"outline",className:"text-xs bg-red-100 text-red-800 border-red-300",children:"To Delete"}),"modified"===b&&(0,v.jsx)(ai.Badge,{variant:"outline",className:"text-xs bg-amber-100 text-amber-800 border-amber-300",children:"Modified"})]})}),(0,v.jsx)(ar.TableCell,{className:"text-xs text-right",children:l&&"amount"===m?(0,v.jsxs)("div",{className:"flex items-center gap-1 justify-end",children:[(0,v.jsx)(U.Input,{type:"number",value:o,onChange:a=>p(a.target.value),className:"h-7 text-xs w-24",step:"0.01",min:"0",autoFocus:!0,placeholder:"0"}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,v.jsx)(at.X,{className:"h-3 w-3"})}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>C(a),children:(0,v.jsx)(V.Check,{className:"h-3 w-3"})})]}):(0,v.jsxs)("span",{className:`font-medium cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===b?"line-through":""} ${X&&n?"hover:bg-blue-50":""}`,onDoubleClick:()=>{!f||!g||"deleted"!==F(a.id)&&z(a,"amount")},title:X&&n?"Double-click to edit":"",children:[c," ",(0,S.formatNumber)(d)]})}),(0,v.jsx)(ar.TableCell,{className:"text-xs",children:l&&"notes"===m?(0,v.jsxs)("div",{className:"flex items-center gap-1",children:[(0,v.jsx)(U.Input,{value:q,onChange:a=>r(a.target.value),placeholder:"Payment notes",className:"h-7 text-xs",autoFocus:!0}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:D,children:(0,v.jsx)(at.X,{className:"h-3 w-3"})}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>C(a),children:(0,v.jsx)(V.Check,{className:"h-3 w-3"})})]}):(0,v.jsx)("span",{className:`text-muted-foreground cursor-pointer hover:bg-gray-100 px-2 py-1 rounded ${"deleted"===b?"line-through":""} ${X&&n?"hover:bg-blue-50":""}`,onDoubleClick:()=>{!f||!g||"deleted"!==F(a.id)&&z(a,"notes")},title:X&&n?"Double-click to edit":"",children:e||"-"})}),(0,v.jsx)(ar.TableCell,{className:"text-xs",children:u===a.id?(0,v.jsxs)("div",{className:"flex items-center gap-1",children:[(0,v.jsxs)(W.Select,{value:x,onValueChange:y,children:[(0,v.jsx)(W.SelectTrigger,{className:"h-7 text-xs w-32",children:(0,v.jsx)(W.SelectValue,{placeholder:"Select account"})}),(0,v.jsx)(W.SelectContent,{children:h.map(a=>(0,v.jsx)(W.SelectItem,{value:a.id,children:(0,v.jsxs)("div",{className:"flex items-center",children:[(0,v.jsx)("span",{children:a.name}),a.isDefault&&(0,v.jsx)("span",{className:"ml-1 text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded",children:"Default"})]})},a.id))})]}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-gray-500 hover:text-gray-700",onClick:M,children:(0,v.jsx)(at.X,{className:"h-3 w-3"})}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-green-500 hover:text-green-700",onClick:()=>R(a),disabled:!x,children:(0,v.jsx)(V.Check,{className:"h-3 w-3"})})]}):(0,v.jsx)("div",{className:"flex items-center gap-1",children:a.cashTransactionId?(0,v.jsx)(ai.Badge,{variant:"outline",className:"text-xs bg-green-100 text-green-800 border-green-300",children:"Linked"}):i&&h.length>0&&(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-blue-500 hover:text-blue-700",onClick:()=>L(a.id),title:"Link to cash account",children:(0,v.jsx)(av.Link,{className:"h-3 w-3"})})})}),X&&(0,v.jsx)(ar.TableCell,{className:"text-xs",children:!l&&n&&(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 text-red-500 hover:text-red-700",onClick:()=>E(a),title:"Delete payment",children:(0,v.jsx)(aa.Trash2,{className:"h-3 w-3"})})})]},a.id)})})]})})]})]})},ax=({amountPaid:a,amountDue:c,grandTotal:d,currency:e,onAmountPaidChange:f,onPaymentDateChange:g,paymentDate:h,maxAmount:i,saleId:j,onPaymentStatusChange:k,isEditing:l=!1,payments:m=[],pendingChanges:n=[],onStagePaymentChange:o,cashAccounts:p=[],onLinkToCash:q,onUpdatePayment:r})=>{let[s,t]=(0,b.useState)(h||new Date),[u,w]=(0,b.useState)((0,S.formatNumberInput)(a?.toString()||"0"));b.default.useEffect(()=>{Math.abs((0,S.parseNumberInput)(u)-a)>.001&&w((0,S.formatNumberInput)(a.toString()))},[a]);let x=m.filter(a=>!n.find(b=>b.id===a.id&&"delete"===b.type)).map(a=>{let b=n.find(b=>b.id===a.id&&"update"===b.type);return b&&b.updatedData?{...a,amount:b.updatedData.amount??a.amount,notes:b.updatedData.notes??a.notes}:a}).reduce((a,b)=>a+b.amount,0),y=Math.max(0,d-x),z=x>=d,A=z?0:a||0;return console.log("InstallmentPaymentInput - isEditing:",l,"has onStagePaymentChange:",!!o),(0,v.jsxs)("div",{className:"space-y-4",children:[(0,v.jsxs)(J.Card,{className:"border-blue-200 bg-blue-50",children:[(0,v.jsx)(J.CardHeader,{className:"pb-3",children:(0,v.jsx)(J.CardTitle,{className:"text-sm text-blue-800",children:"Installment Payment Details"})}),(0,v.jsxs)(J.CardContent,{className:"space-y-4",children:[(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"amountPaid",className:"text-sm font-medium",children:"Amount Paid (Current Payment)"}),(0,v.jsx)(U.Input,{id:"amountPaid",type:"text",inputMode:"decimal",value:u,onChange:a=>{let b=a.target.value;w((0,S.formatNumberInput)(b)),f(Math.min((0,S.parseNumberInput)(b),y))},placeholder:"Enter amount paid",disabled:z,className:"text-base"})]}),(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{className:"text-sm font-medium",children:"Payment Date"}),(0,v.jsxs)(Q.Popover,{children:[(0,v.jsx)(Q.PopoverTrigger,{asChild:!0,children:(0,v.jsxs)(K.Button,{variant:"outline",className:(0,S.cn)("w-full justify-start text-left font-normal",!s&&"text-muted-foreground"),disabled:z,children:[(0,v.jsx)(O.CalendarIcon,{className:"mr-2 h-4 w-4"}),s?(0,N.format)(s,"PPP"):(0,v.jsx)("span",{children:"Pick a date"})]})}),(0,v.jsx)(Q.PopoverContent,{className:"w-auto p-0",align:"start",children:(0,v.jsx)(P.Calendar,{mode:"single",selected:s,onSelect:a=>{a&&(t(a),g?.(a))},initialFocus:!0,className:(0,S.cn)("p-3 pointer-events-auto")})})]})]}),(0,v.jsxs)("div",{className:"space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4",children:[(0,v.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,v.jsx)("span",{className:"text-sm text-muted-foreground",children:"Total Amount:"}),(0,v.jsxs)("span",{className:"text-sm font-semibold sm:block",children:[e," ",(0,S.formatNumber)(d)]})]}),(0,v.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,v.jsx)("span",{className:"text-sm text-muted-foreground",children:"Total Paid (History):"}),(0,v.jsxs)("span",{className:"text-sm font-semibold text-green-600 sm:block",children:[e," ",(0,S.formatNumber)(x)]})]})]}),(0,v.jsxs)("div",{className:"space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4",children:[(0,v.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,v.jsx)("span",{className:"text-sm text-muted-foreground",children:"Current Payment:"}),(0,v.jsxs)("span",{className:"text-sm font-semibold text-blue-600 sm:block",children:[e," ",(0,S.formatNumber)(A)]})]}),(0,v.jsxs)("div",{className:"flex justify-between sm:block",children:[(0,v.jsx)("span",{className:"text-sm text-muted-foreground",children:"Amount Due:"}),(0,v.jsxs)("span",{className:"text-sm font-semibold text-red-600 sm:block",children:[e," ",(0,S.formatNumber)(Math.max(0,y-A))]})]})]}),x+A>=d&&A>0&&(0,v.jsx)("div",{className:"text-sm text-green-600 font-medium bg-green-50 p-3 rounded border border-green-200",children:"âœ“ Full payment received - you can manually change status to Paid if needed"}),z&&(0,v.jsx)("div",{className:"text-sm text-green-600 font-medium bg-green-50 p-3 rounded border border-green-200",children:"âœ“ Sale fully paid - you can manually change status to Paid if needed"}),l&&n.length>0&&(0,v.jsxs)("div",{className:"text-sm text-amber-600 font-medium bg-amber-50 p-3 rounded border border-amber-200",children:["â„¹ï¸ ",n.length,' payment change(s) staged. Changes will be saved when you click "Update Sale".']}),l&&0===n.length&&m.length>0&&(0,v.jsx)("div",{className:"text-sm text-blue-600 font-medium bg-blue-50 p-3 rounded border border-blue-200",children:'â„¹ï¸ You can edit payment history. Changes will be saved when you click "Update Sale".'})]})]}),j&&(0,v.jsx)(aw,{payments:m,currency:e,isLoading:!1,pendingChanges:n,isLocalMode:l,onStageChange:o,cashAccounts:p,onLinkToCash:q,onUpdatePayment:r})]})};var ay=a.i(563658);let az=({linkToCash:a,onLinkToCashChange:b,selectedCashAccountId:c,onCashAccountChange:d,cashAccounts:e,paymentStatus:f})=>"Paid"!==f&&"Installment Sale"!==f?null:(0,v.jsxs)(J.Card,{className:"border-green-200 bg-green-50",children:[(0,v.jsx)(J.CardHeader,{className:"pb-3",children:(0,v.jsx)(J.CardTitle,{className:"text-sm text-green-800",children:"Installment Sale"===f?"Link Partial Payment to Cash Account":"Link to Cash Account"})}),(0,v.jsxs)(J.CardContent,{className:"space-y-4",children:[(0,v.jsxs)("div",{className:"flex items-center justify-between",children:[(0,v.jsxs)("div",{className:"space-y-0.5",children:[(0,v.jsx)(R.Label,{htmlFor:"link-to-cash",children:"Link to Cash Account"}),(0,v.jsx)("div",{className:"text-sm text-muted-foreground",children:"Installment Sale"===f?"Record the partial payment in a cash account":"Record this payment in a cash account"})]}),(0,v.jsx)(ay.Switch,{id:"link-to-cash",checked:a,onCheckedChange:b,"data-cash-account-switch":"true",onKeyDown:b=>{if("Enter"===b.key)if(b.preventDefault(),a){let a=document.querySelector('[data-cash-account-select="true"]');a?.focus()}else{let a=document.querySelector('button[type="submit"]');a?.focus()}}})]}),a&&(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"cash-account",children:"Select Cash Account"}),(0,v.jsxs)(W.Select,{value:c,onValueChange:d,children:[(0,v.jsx)(W.SelectTrigger,{className:"w-full","data-cash-account-select":"true",onKeyDown:a=>{if("Enter"===a.key){a.preventDefault();let b=document.querySelector('button[type="submit"]');b?.focus()}},children:(0,v.jsx)(W.SelectValue,{placeholder:"Select a cash account"})}),(0,v.jsx)(W.SelectContent,{children:e.map(a=>(0,v.jsx)(W.SelectItem,{value:a.id,children:(0,v.jsxs)("div",{className:"flex items-center",children:[(0,v.jsx)("span",{children:a.name}),a.isDefault&&(0,v.jsx)("span",{className:"ml-2 text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded",children:"Default"})]})},a.id))})]}),c&&(0,v.jsx)("div",{className:"text-sm text-muted-foreground",children:"Installment Sale"===f?"The partial payment amount will be recorded in this account":"The full payment amount will be recorded in this account"})]})]})]});var aA=a.i(161990);let aB=({value:a,onChange:b,label:c="Sales Source",placeholder:d="Select category (optional)"})=>{let{categories:e,isLoading:f}=(0,aA.useSalesCategories)();return f?(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{children:c}),(0,v.jsx)(W.Select,{disabled:!0,children:(0,v.jsx)(W.SelectTrigger,{children:(0,v.jsx)(W.SelectValue,{placeholder:"Loading..."})})})]}):(0,v.jsxs)("div",{className:"space-y-2",children:[(0,v.jsx)(R.Label,{children:c}),(0,v.jsxs)(W.Select,{value:a||"none",onValueChange:a=>{b("none"===a?"":a)},children:[(0,v.jsx)(W.SelectTrigger,{children:(0,v.jsx)(W.SelectValue,{placeholder:d})}),(0,v.jsxs)(W.SelectContent,{children:[(0,v.jsx)(W.SelectItem,{value:"none",children:"No source"}),e.map(a=>(0,v.jsx)(W.SelectItem,{value:a.id,children:a.name},a.id))]})]})]})},aC=({paymentStatus:a,onPaymentStatusChange:b,isInstallmentSale:c,amountPaid:d,amountDue:e,grandTotal:f,currency:g,onAmountPaidChange:h,onPaymentDateChange:i,paymentDate:j,saleId:k,onPaymentStatusChangeFromInstallment:l,isEditing:m,payments:n,pendingChanges:o,onStagePaymentChange:p,linkToCash:q,onLinkToCashChange:r,selectedCashAccountId:s,onCashAccountChange:t,cashAccounts:u,hasPaidWithHistory:w,onLinkPaymentToCash:x,onUpdatePayment:y,notes:z="",onNotesChange:A,categoryId:B="",onCategoryChange:C})=>(0,v.jsxs)(J.Card,{className:"mb-6",children:[(0,v.jsx)(J.CardHeader,{children:(0,v.jsx)(J.CardTitle,{children:"Payment Information"})}),(0,v.jsxs)(J.CardContent,{className:"space-y-6",children:[(0,v.jsx)(aq,{paymentStatus:a,onPaymentStatusChange:b}),c&&(0,v.jsx)(ax,{amountPaid:d,amountDue:e,grandTotal:f,currency:g,onAmountPaidChange:h,onPaymentDateChange:i,paymentDate:j,maxAmount:f,saleId:k,onPaymentStatusChange:l,isEditing:m,payments:n,pendingChanges:o,onStagePaymentChange:m?p:void 0,cashAccounts:u,onLinkToCash:x,onUpdatePayment:y}),w&&(0,v.jsxs)(J.Card,{className:"border-green-200 bg-green-50",children:[(0,v.jsx)(J.CardHeader,{className:"pb-3",children:(0,v.jsx)(J.CardTitle,{className:"text-sm text-green-800",children:"Payment History (Sale Completed)"})}),(0,v.jsx)(J.CardContent,{children:(0,v.jsx)(aw,{payments:n,currency:g,isLoading:!1,pendingChanges:o,isLocalMode:m,onStageChange:m?p:void 0,cashAccounts:u,onLinkToCash:x,onUpdatePayment:y})})]}),(0,v.jsx)(az,{linkToCash:q,onLinkToCashChange:r,selectedCashAccountId:s,onCashAccountChange:t,cashAccounts:u,paymentStatus:a}),C&&(0,v.jsx)(aB,{value:B,onChange:C}),(0,v.jsxs)("div",{className:"grid gap-3",children:[(0,v.jsx)(R.Label,{htmlFor:"saleNotes",children:"Notes"}),(0,v.jsx)(U.Input,{id:"saleNotes",name:"notes",value:z,onChange:A,placeholder:"Order notes (will appear on receipt)"})]})]})]});var aD=a.i(315055),aE=a.i(596221),aF=a.i(563588),aG=a.i(771931);let aH=({loading:a,isEditing:d,onCancel:e,onClearForm:g,printAfterSave:h,onPrintAfterSaveChange:i,thermalPrintAfterSave:j=!1,onThermalPrintAfterSaveChange:k,paymentStatus:l,includePaymentInfo:m,onIncludePaymentInfoChange:n,hasPendingPaymentChanges:o=!1,sendSMS:r=!1,onSendSMSChange:s,smsMessage:t="",onSMSMessageChange:u,customerName:w="",customerHasPhone:x=!1,disabled:y=!1})=>{let{user:z}=(0,f.useAuth)(),A=z?.id,{currentBusiness:B}=(0,c.useBusiness)(),{settings:C}=(0,q.useBusinessSettings)(),[D,E]=(0,b.useState)(!1),{templates:F=[],isLoading:H}=(0,G.useMessages)(A),[I,L]=(0,b.useState)("");(0,b.useEffect)(()=>{(async()=>{E(await (0,p.checkBridgeStatus)())})()},[]);let M="Thank you for your purchase from {business_name} We truly appreciate your support and trust in our Business. If you need any assistance or have any questions about your order, please feel free to reach out, on {business_number} We look forward to servingÂ youÂ again!",N=(a,b)=>{let c=a;return b&&(c=c.replace(/\{customer_name\}/gi,b).replace(/\{first_name\}/gi,b.split(" ")[0]||"").replace(/\{last_name\}/gi,b.split(" ").slice(1).join(" ")||"")),c=c.replace(/\{business_name\}/gi,B?.name||"[Business Name]").replace(/\{business_number\}/gi,C.businessPhone||"[Business Number]")},O=(0,b.useMemo)(()=>F.filter(a=>a.category&&"ThankYou"===String(a.category).trim()),[F]);(0,b.useEffect)(()=>{if(!r||!u)return;let a=M;if("default"===I)a=M;else if(I&&O.length>0){let b=O.find(a=>a.id===I);b&&(a=b.content)}else I||L("default");u(N(a,w))},[r,w,O,I,u]);let P=t.length,Q=Math.ceil(P/160)||1;return(0,v.jsxs)("div",{className:"space-y-4",children:[(0,v.jsx)(J.Card,{className:"border-gray-200",children:(0,v.jsxs)(J.CardContent,{className:"pt-6 space-y-4",children:[(0,v.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,v.jsx)(aD.Checkbox,{id:"printAfterSave",checked:h,onCheckedChange:i}),(0,v.jsxs)(R.Label,{className:"text-sm",children:["Show receipt after ",d?"updating":"creating"," sale"]})]}),D&&k&&(0,v.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,v.jsx)(aD.Checkbox,{id:"thermalPrintAfterSave",checked:j,onCheckedChange:k}),(0,v.jsxs)(R.Label,{className:"text-sm flex items-center gap-1.5 text-green-700 font-medium",children:[(0,v.jsx)(aG.Printer,{className:"w-3.5 h-3.5"}),"Auto-print (Thermal Bridge)"]})]}),("Paid"===l||"Installment Sale"===l)&&(0,v.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,v.jsx)(aD.Checkbox,{id:"includePaymentInfo",checked:m,onCheckedChange:n}),(0,v.jsx)(R.Label,{className:"text-sm",children:"Include payment information in receipt"})]})]})}),s&&u&&(0,v.jsx)(J.Card,{className:`border-blue-200 ${r?"bg-blue-50/50":"bg-gray-50"}`,children:(0,v.jsxs)(J.CardContent,{className:"pt-6 space-y-4",children:[(0,v.jsxs)("div",{className:"flex items-start space-x-3",children:[(0,v.jsx)(aD.Checkbox,{id:"sendSMS",checked:r,onCheckedChange:s,disabled:!x}),(0,v.jsxs)("div",{className:"flex-1",children:[(0,v.jsxs)(R.Label,{className:"text-base font-medium flex items-center gap-2",children:[(0,v.jsx)(aF.MessageSquare,{className:"w-5 h-5 text-blue-600"}),"Send Thank You SMS"]}),!x&&(0,v.jsx)("p",{className:"text-xs text-amber-600 mt-1",children:"Customer phone number required to send SMS"})]})]}),r&&x&&(0,v.jsxs)("div",{className:"space-y-4 pl-8 border-l-4 border-blue-300 bg-blue-50/30 -m-4 p-4 rounded-r-lg",children:[(0,v.jsxs)("div",{children:[(0,v.jsx)(R.Label,{className:"text-sm font-medium",children:"Template"}),H?(0,v.jsxs)("div",{className:"text-sm text-gray-500 flex items-center gap-2 mt-1",children:[(0,v.jsx)(aE.Loader2,{className:"w-4 h-4 animate-spin"}),"Loading templates..."]}):(0,v.jsxs)(W.Select,{value:I||"default",onValueChange:a=>{L(a);let b=M;if("default"===a)b=M;else{let c=O.find(b=>b.id===a);c&&(b=c.content)}let c=N(b,w);u?.(c)},children:[(0,v.jsx)(W.SelectTrigger,{className:"mt-1",children:(0,v.jsx)(W.SelectValue,{placeholder:"Choose a thank you template..."})}),(0,v.jsxs)(W.SelectContent,{children:[(0,v.jsx)(W.SelectItem,{value:"default",children:"Default Template"}),O.map(a=>(0,v.jsx)(W.SelectItem,{value:a.id,children:a.name},a.id))]})]})]}),(0,v.jsxs)("div",{children:[(0,v.jsx)(R.Label,{className:"text-sm font-medium",children:"Message"}),(0,v.jsx)(_.Textarea,{value:t,onChange:a=>u?.(a.target.value),placeholder:"Your message will appear here...",rows:4,className:"mt-1 resize-none text-sm font-medium"}),(0,v.jsxs)("div",{className:"flex justify-between items-center mt-2 text-xs text-gray-600",children:[(0,v.jsxs)("span",{children:[P," characters"]}),(0,v.jsxs)("span",{className:"font-semibold text-blue-600",children:[Q," SMS credit",Q>1?"s":""," will be used"]})]})]})]})]})}),o&&(0,v.jsx)("div",{className:"text-sm text-amber-600 bg-amber-50 p-3 rounded border border-amber-200",children:"Pending payment changes will be applied when updating."}),(0,v.jsxs)("div",{className:"flex gap-4 pt-4",children:[(0,v.jsx)(K.Button,{type:"button",variant:"outline",onClick:e,disabled:a,className:"flex-1",children:"Cancel"}),!d&&g&&(0,v.jsx)(K.Button,{type:"button",variant:"outline",onClick:g,disabled:a,className:"flex-1",children:"Clear Form"}),(0,v.jsx)(K.Button,{type:"submit",disabled:a||y,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:a?(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(aE.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),d?"Updating...":"Creating..."]}):d?"Update Sale":"Create Sale"})]})]})},aI=({initialData:a,onSaleComplete:g,currency:h="USD",customers:i=[],onAddNewCustomer:j,draftData:k,onClearDraft:n})=>{let o=(0,e.useRouter)();(0,e.useSearchParams)();let[p,r]=(0,b.useState)(!1),[s,t]=(0,b.useState)(a?.date||new Date),u=a?.paymentStatus||"Paid",{settings:J}=(0,q.useBusinessSettings)(),{user:K}=(0,f.useAuth)(),{updateInventoryForSale:L,updateInventoryForEditedSale:M}=l(K?.id),{accounts:N}=(0,z.useCashAccounts)(),{currentBusiness:O}=(0,c.useBusiness)();(0,b.useEffect)(()=>{a&&(console.log("SalesForm initialData:",a),console.log("SalesForm initialData.categoryId:",a.categoryId),console.log("SalesForm initialData.notes:",a.notes))},[a]);let{saveDraft:P}=d(),{updateStockHistoryDatesBySaleId:Q}=(0,F.useStockHistory)(K?.id),R=(0,b.useRef)(),S=(0,b.useRef)(!1),[T,U]=(0,b.useState)(!1),{createMessage:V,templates:W=[]}=(0,G.useMessages)(K?.id),[X,Y]=(0,b.useState)(null),[$,_]=(0,b.useState)(!0),[aa,ab]=(0,b.useState)("Thank you for your purchase from {business_name} We truly appreciate your support and trust in our Business. If you need any assistance or have any questions about your order, please feel free to reach out, on {business_number} We look forward to servingÂ youÂ again!"),{formData:ac,errors:ad,taxRateInput:ae,printAfterSave:af,thermalPrintAfterSave:ag,includePaymentInfo:ah,selectedCustomerCategoryId:ai,paymentDate:aj,linkToCash:ak,selectedCashAccountId:al,cashTransactionId:am,originalPaymentStatus:an,formRecentlyCleared:ao,payments:aq,pendingChanges:ar,hasChanges:as,setFormData:at,setTaxRateInput:au,setPrintAfterSave:av,setThermalPrintAfterSave:aw,setIncludePaymentInfo:ax,setLinkToCash:ay,setSelectedCashAccountId:az,setCashTransactionId:aA,setOriginalPaymentStatus:aB,handleChange:aD,handleSelectChange:aE,handleAddItem:aF,handleUpdateItem:aG,handleRemoveItem:aI,handleSelectCustomer:aJ,handleCategoryChange:aK,handleSalesCategoryChange:aL,handleAmountPaidChange:aM,handlePaymentDateChange:aN,calculateTotalAmount:aO,calculateTaxAmount:aP,validateForm:aQ,processPendingPaymentChanges:aR,createInstallmentPayment:aS,updateInstallmentPayment:aT,deleteInstallmentPayment:aU,addPaymentChange:aV,clearChanges:aW,getModifiedPayments:aX,clearForm:aY}=(({initialData:a,defaultPaymentStatus:c,cashAccounts:d})=>{let{formData:e,errors:f,taxRateInput:g,printAfterSave:h,thermalPrintAfterSave:i,includePaymentInfo:j,selectedCustomerCategoryId:k,paymentDate:l,linkToCash:m,selectedCashAccountId:n,cashTransactionId:o,originalPaymentStatus:p,formRecentlyCleared:q,setFormData:r,setErrors:s,setTaxRateInput:t,setPrintAfterSave:u,setThermalPrintAfterSave:v,setIncludePaymentInfo:w,setSelectedCustomerCategoryId:x,setPaymentDate:y,setLinkToCash:z,setSelectedCashAccountId:D,setCashTransactionId:E,setOriginalPaymentStatus:F,setFormRecentlyCleared:G,clearFormState:H}=(({initialData:a,defaultPaymentStatus:c})=>{let[d,e]=(0,b.useState)({customerName:a?.customerName||"",customerAddress:a?.customerAddress||"",customerContact:a?.customerContact||"",customerId:a?.customerId||"",items:a?.items||[{...A}],paymentStatus:c,taxRate:a?.taxRate||0,amountPaid:a&&"Installment Sale"===a.paymentStatus?0:a?.amountPaid||0,amountDue:a?.amountDue||0,notes:a?.notes||"",categoryId:a?.categoryId||""}),[f,g]=(0,b.useState)({}),[h,i]=(0,b.useState)(a?.taxRate?a.taxRate.toString():""),[j,k]=(0,b.useState)(!0),[l,m]=(0,b.useState)(!1),[n,o]=(0,b.useState)(!0),[p,q]=(0,b.useState)(""),[r,s]=(0,b.useState)(new Date),[t,u]=(0,b.useState)(!1),[v,w]=(0,b.useState)(""),[x,y]=(0,b.useState)(null),[z,B]=(0,b.useState)(c),[C,D]=(0,b.useState)(!1),E=(0,b.useCallback)(a=>{e({customerName:"",customerAddress:"",customerContact:"",customerId:"",items:[{...A}],paymentStatus:c,taxRate:0,amountPaid:0,amountDue:0,notes:"",categoryId:""}),i(""),q(""),s(new Date),u(!1),g({}),D(!0),a&&a()},[c]);return(0,b.useEffect)(()=>{a&&(e(b=>({...b,customerName:a.customerName||b.customerName,customerAddress:a.customerAddress||b.customerAddress,customerContact:a.customerContact||b.customerContact,customerId:a.customerId||b.customerId,items:a.items&&a.items.length>0?a.items:b.items,paymentStatus:a.paymentStatus||b.paymentStatus,taxRate:void 0!==a.taxRate?a.taxRate:b.taxRate,amountPaid:void 0!==a.amountPaid?a.amountPaid:b.amountPaid,amountDue:void 0!==a.amountDue?a.amountDue:b.amountDue,notes:a.notes||b.notes,categoryId:a.categoryId||b.categoryId})),a.categoryId&&D(!1),void 0!==a.taxRate&&i(a.taxRate.toString()))},[a]),{formData:d,errors:f,taxRateInput:h,printAfterSave:j,thermalPrintAfterSave:l,includePaymentInfo:n,selectedCustomerCategoryId:p,paymentDate:r,linkToCash:t,selectedCashAccountId:v,cashTransactionId:x,originalPaymentStatus:z,formRecentlyCleared:C,setFormData:e,setErrors:g,setTaxRateInput:i,setPrintAfterSave:k,setThermalPrintAfterSave:m,setIncludePaymentInfo:o,setSelectedCustomerCategoryId:q,setPaymentDate:s,setLinkToCash:u,setSelectedCashAccountId:w,setCashTransactionId:y,setOriginalPaymentStatus:B,setFormRecentlyCleared:D,clearFormState:E}})({initialData:a,defaultPaymentStatus:c}),{handleChange:I,handleSelectChange:J,handleAmountPaidChange:K,handlePaymentDateChange:L}=(({formData:a,setFormData:c,errors:d,setErrors:e,setTaxRateInput:f,setLinkToCash:g})=>{let h=(0,b.useCallback)(a=>{let{name:b,value:g}=a.target;if("taxRate"===b){f(g);let a=g.replace(/,/g,""),b=""===a?0:parseFloat(a);c(a=>({...a,taxRate:isNaN(b)?0:b}))}else c(a=>({...a,[b]:g}));d[b]&&e(a=>({...a,[b]:void 0}))},[d,c,e,f]),i=(0,b.useCallback)(a=>{c(b=>({...b,paymentStatus:a})),"Paid"!==a&&"Installment Sale"!==a&&g(!1),"Installment Sale"!==a&&c(b=>({...b,paymentStatus:a,amountPaid:0,amountDue:0}))},[c,g]);return{handleChange:h,handleSelectChange:i,handleAmountPaidChange:(0,b.useCallback)((a,b)=>{let d=Math.max(0,b-a);c(b=>({...b,amountPaid:a,amountDue:d}))},[c]),handlePaymentDateChange:(0,b.useCallback)(a=>{},[])}})({formData:e,setFormData:r,errors:f,setErrors:s,setTaxRateInput:t,setLinkToCash:z}),{handleAddItem:M,handleAddItemWithProduct:N,handleUpdateItem:O,handleRemoveItem:P}=(({formData:a,setFormData:c})=>{let d=(0,b.useCallback)(()=>{c(a=>({...a,items:[...a.items,{...B}]}))},[c]),e=(0,b.useCallback)(a=>{c(b=>{let c=b.items.findIndex(b=>b.productId===a.id);if(-1!==c){let a=[...b.items];return a[c]={...a[c],quantity:a[c].quantity+1},{...b,items:a}}let d={productId:a.id,description:a.name,quantity:1,price:a.sellingPrice,cost:a.costPrice};return 1!==b.items.length||b.items[0].description||b.items[0].productId?{...b,items:[...b.items,d]}:{...b,items:[d]}})},[c]);return{handleAddItem:d,handleAddItemWithProduct:e,handleUpdateItem:(0,b.useCallback)((a,b)=>{c(c=>{if(b.productId){let d=c.items.findIndex((c,d)=>d!==a&&c.productId===b.productId);if(-1!==d){let e=[...c.items],f=e[d];return e[d]={...f,quantity:f.quantity+b.quantity},e.length>1?e.splice(a,1):e[a]={...B},{...c,items:e}}}let d=[...c.items];return d[a]=b,{...c,items:d}})},[c]),handleRemoveItem:(0,b.useCallback)(a=>{c(b=>{if(1===b.items.length)return b;let c=b.items.filter((b,c)=>c!==a);return{...b,items:c}})},[c])}})({formData:e,setFormData:r}),{handleSelectCustomer:Q,handleCategoryChange:R}=(({setFormData:a,setSelectedCustomerCategoryId:c})=>({handleSelectCustomer:(0,b.useCallback)(b=>{a(a=>({...a,customerName:b.fullName,customerAddress:b.location||"",customerContact:b.phoneNumber||"",customerId:b.id})),c(b.categoryId||"")},[a,c]),handleCategoryChange:(0,b.useCallback)(a=>{c(a)},[c])}))({setFormData:r,setSelectedCustomerCategoryId:x}),{validateForm:S}=(({formData:a,linkToCash:c,selectedCashAccountId:d,initialData:e,formRecentlyCleared:f,setErrors:g})=>({validateForm:(0,b.useCallback)((b,f)=>{let h={};return a.customerName.trim()||(h.customerName="Customer name is required"),a.taxRate<0&&(h.taxRate="Tax rate cannot be negative"),a.items.filter(a=>""!==a.description.trim()||a.quantity>0||a.price>0).some(a=>!a.description.trim()||a.quantity<=0||a.price<0||a.cost<0)&&(h.items="All items must have a description, positive quantity, and non-negative price/cost"),c&&("Paid"===a.paymentStatus||"Installment Sale"===a.paymentStatus)&&!d&&(h.cashAccount="Select a cash account when linking payments"),"Installment Sale"===a.paymentStatus&&!e&&((!a.amountPaid||a.amountPaid<=0)&&(h.amountPaid="Enter an initial payment greater than 0"),a.amountPaid&&a.amountPaid>b&&(h.amountPaid="Amount paid cannot exceed total")),"Installment Sale"===a.paymentStatus&&e&&a.amountPaid&&a.amountPaid>b&&(h.amountPaid="Amount paid cannot exceed total"),g(h),0===Object.keys(h).length},[a,c,d,e,f,g])}))({formData:e,linkToCash:m,selectedCashAccountId:n,initialData:a,formRecentlyCleared:q,setErrors:s}),{calculateTotalAmount:T,calculateTaxAmount:U}=(({taxRate:a})=>({calculateTotalAmount:(0,b.useCallback)(a=>a.reduce((a,b)=>{let c=b.price*b.quantity,d="amount"===b.discountType?b.discountAmount||0:c*(b.discountPercentage||0)/100;return a+(c-d)},0),[]),calculateTaxAmount:(0,b.useCallback)(b=>a/100*b,[a])}))({taxRate:e.taxRate}),{payments:V,pendingChanges:W,hasChanges:X,createInstallmentPayment:Y,updateInstallmentPayment:Z,deleteInstallmentPayment:$,addPaymentChange:_,clearChanges:aa,getModifiedPayments:ab,processPendingPaymentChanges:ac}=(({initialDataId:a})=>{let{payments:c,createPayment:d,updatePayment:e,deletePayment:f}=(0,C.useInstallmentPayments)(a),{pendingChanges:g,addPaymentChange:h,clearChanges:i,getModifiedPayments:j,hasChanges:k}=(()=>{let[a,c]=(0,b.useState)([]),d=a.length>0;return{pendingChanges:a,addPaymentChange:a=>{c(b=>[...b.filter(b=>b.id!==a.id),a])},removePaymentChange:a=>{c(b=>b.filter(b=>b.id!==a))},clearChanges:()=>{c([])},getModifiedPayments:b=>b.filter(b=>!a.find(a=>a.id===b.id&&"delete"===a.type)).map(b=>{let c=a.find(a=>a.id===b.id&&"update"===a.type);return c&&c.updatedData?{...b,amount:c.updatedData.amount??b.amount,notes:c.updatedData.notes??b.notes,paymentDate:c.updatedData.paymentDate??b.paymentDate}:b}),hasChanges:d}})(),l=(0,b.useCallback)(async()=>{for(let a of g)"update"===a.type?await e(a.id,a.updatedData):"delete"===a.type&&await f(a.id);i()},[g,e,f,i]);return{payments:c,pendingChanges:g,hasChanges:k,createInstallmentPayment:d,updateInstallmentPayment:e,deleteInstallmentPayment:f,addPaymentChange:h,clearChanges:i,getModifiedPayments:j,processPendingPaymentChanges:l}})({initialDataId:a?.id}),ad=(0,b.useCallback)(a=>{y(a)},[y]),ae=(0,b.useCallback)((a,b)=>{H(a),aa(),b&&b()},[H,aa]),af=(0,b.useCallback)(a=>{q&&G(!1),I(a)},[q,G,I]),ag=(0,b.useCallback)(a=>{q&&G(!1),J(a)},[q,G,J]),ah=(0,b.useCallback)(a=>{q&&G(!1);let b=a&&(a.nativeEvent||a.preventDefault||a.stopPropagation||a.type&&a.target);a&&!b?N(a):M()},[q,G,M,N]),ai=(0,b.useCallback)((a,b)=>{q&&G(!1),O(a,b)},[q,G,O]),aj=(0,b.useCallback)(a=>{q&&G(!1),P(a)},[q,G,P]),ak=(0,b.useCallback)(a=>{q&&G(!1),Q(a)},[q,G,Q]),al=(0,b.useCallback)(a=>{q&&G(!1),R(a)},[q,G,R]),am=(0,b.useCallback)(a=>{q&&G(!1),r(b=>({...b,categoryId:a}))},[q,G,r]);return{formData:e,errors:f,taxRateInput:g,printAfterSave:h,thermalPrintAfterSave:i,includePaymentInfo:j,selectedCustomerCategoryId:k,paymentDate:l,linkToCash:m,selectedCashAccountId:n,cashTransactionId:o,originalPaymentStatus:p,formRecentlyCleared:q,payments:V,pendingChanges:W,hasChanges:X,setFormData:r,setTaxRateInput:t,setPrintAfterSave:u,setThermalPrintAfterSave:v,setIncludePaymentInfo:w,setLinkToCash:z,setSelectedCashAccountId:D,setCashTransactionId:E,setOriginalPaymentStatus:F,handleChange:af,handleSelectChange:ag,handleAddItem:ah,handleUpdateItem:ai,handleRemoveItem:aj,handleSelectCustomer:ak,handleCategoryChange:al,handleSalesCategoryChange:am,handleAmountPaidChange:K,handlePaymentDateChange:ad,clearForm:ae,calculateTotalAmount:T,calculateTaxAmount:U,validateForm:S,processPendingPaymentChanges:ac,createInstallmentPayment:Y,updateInstallmentPayment:Z,deleteInstallmentPayment:$,addPaymentChange:_,clearChanges:aa,getModifiedPayments:ab}})({initialData:a,defaultPaymentStatus:u,cashAccounts:N}),{createCashTransactionForSale:aZ,updateCashTransactionForSale:a$,createInstallmentPaymentWithCash:a_,findCashTransactionForSale:a0}=(()=>{let{createTransaction:a,updateTransaction:c,deleteTransaction:d}=(0,D.useCashTransactions)(),e=(0,b.useCallback)(async(b,c,d,e,f,g)=>{if(!d||!e||"Paid"!==g)return null;try{let d=`Sale to ${b.customerName||b.customer_name||"Customer"} - Receipt #${b.receiptNumber||b.receipt_number||"N/A"}`,g=await a({accountId:e,amount:c,transactionType:"cash_in",category:"Cash sale",description:d,date:f,personInCharge:"",tags:[],paymentMethod:"",receiptImage:""});return g?.id||null}catch(a){return console.error("Error creating cash transaction:",a),m.toast.error("Failed to create cash transaction"),null}},[a]),f=(0,b.useCallback)(async(b,e,f,g,h,i,j,k)=>{try{let l=`Sale to ${b.customerName||b.customer_name||"Customer"} - Receipt #${b.receiptNumber||b.receipt_number||"N/A"}`,m=j&&""!==j.trim();if(!f&&i&&"Paid"===h&&m){let b=await a({accountId:j,amount:e,transactionType:"cash_in",category:"Cash sale",description:l,date:k,personInCharge:"",tags:[],paymentMethod:"",receiptImage:""});return b?.id||null}if(!f)return null;if("Paid"===g&&"Installment Sale"===h)return await d(f),null;if(i&&"Paid"===h&&m)return await c(f,{amount:e,category:"Cash sale",description:l,date:k}),f;return await d(f),null}catch(a){return console.error("Error updating cash transaction:",a),m.toast.error("Failed to update cash transaction"),f}},[a,c,d]);return{createCashTransactionForSale:e,updateCashTransactionForSale:f,createInstallmentPaymentWithCash:(0,b.useCallback)(async(a,b,c,d,e,f,g)=>b<=0?null:d&&e?await g({saleId:a,amount:b,accountId:e,locationId:f,date:new Date}):await g({saleId:a,amount:b}),[]),findCashTransactionForSale:(0,b.useCallback)(async a=>{try{let b=await E(a);if(b.success&&b.data)return b.data.accountId}catch(a){console.error("Error finding cash transaction:",a)}return null},[])}})(),{payments:a1,linkPaymentToCashAccount:a2,unlinkPaymentFromCashAccount:a3,updatePayment:a4}=(0,C.useInstallmentPayments)(a?.id),a5=async(a,b)=>{await a4(a,b)},[a6,a7]=(0,b.useState)(!1),a8=()=>{S.current=!0,aY&&aY(()=>t(new Date),n)};(0,b.useEffect)(()=>{S.current=!1});let a9=b.default.useCallback(()=>{!S.current&&!a&&!p&&!a6&&!ao&&(ac.customerName.trim()||ac.customerAddress.trim()||ac.customerContact.trim()||ac.items.some(a=>a.description.trim()||1!==a.quantity||0!==a.price))&&P(ac,s)},[ac,s,a,p,P,a6,ao]);(0,b.useEffect)(()=>(R.current&&clearTimeout(R.current),R.current=setTimeout(a9,2e3),()=>{R.current&&clearTimeout(R.current),a9()}),[a9]),(0,b.useEffect)(()=>{let a=()=>a9(),b=()=>document.hidden&&a9();return window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",b),()=>{window.removeEventListener("beforeunload",a),document.removeEventListener("visibilitychange",b)}},[a9]),(0,b.useEffect)(()=>{k&&!a&&(at(k.formData),t(k.selectedDate),au(k.formData.taxRate?.toString()||""))},[k,a,at,au]),(0,b.useEffect)(()=>{(async()=>{if(a?.cashTransactionId){ay(!0),aA(a.cashTransactionId);let b=await a0(a.cashTransactionId);b&&az(b)}!(N.length>0)||al||a?.cashTransactionId||az((N.find(a=>a.isDefault)||N[0]).id)})()},[a,N,a0,az]);let ba=async b=>{b.preventDefault();let c=aO(ac.items),d=aP(c),e=c+d;if(!aQ(e,s))return void(ad.customerName?m.toast.error(ad.customerName):ad.taxRate?m.toast.error(ad.taxRate):m.toast.error("Please fill in all required fields correctly"));if(0===ac.items.length||ac.items.every(a=>!a.description.trim()))return void m.toast.error("Please add at least one valid item");r(!0);try{let b=a?.receiptNumber||await (0,x.generateReceiptNumber)(O?.id||""),c=ac.items.reduce((a,b)=>{let c=b.price*b.quantity,d="amount"===b.discountType?b.discountAmount||0:c*(b.discountPercentage||0)/100,e=b.cost*b.quantity;return a+(c-d-e)},0),d=am;a&&(d=await a$({id:a.id,customerName:ac.customerName,receiptNumber:a.receiptNumber,items:ac.items},e,am,an,ac.paymentStatus,ak,al,s),aA(d));let f=(0,w.mapSaleToDbSale)(ac,s,c,b,K?.id||"",O?.id||"",d),{success:h,data:j,error:l}=await I(f,!!a,a?.id);if(!h||!j)throw Error(l||"Failed to save sale");let p={id:j.id,receiptNumber:j.receiptNumber,customerName:j.customerName,customerAddress:j.customerAddress||"",customerContact:j.customerContact||"",customerId:j.customerId||void 0,items:j.items,paymentStatus:j.paymentStatus,profit:j.profit,date:new Date(j.date),taxRate:j.taxRate?Number(j.taxRate):0,cashTransactionId:j.cashTransactionId||void 0,amountPaid:j.amountPaid?Number(j.amountPaid):void 0,amountDue:j.amountDue?Number(j.amountDue):void 0,notes:j.notes||"",categoryId:j.categoryId||void 0,createdAt:new Date(j.createdAt)};if(a)as&&await aR(),"Installment Sale"===ac.paymentStatus&&ac.amountPaid&&(await aS({saleId:p.id,amount:ac.amountPaid,notes:p.items.map(a=>a.description).join(", "),paymentDate:aj,accountId:ak?al:void 0,locationId:O?.id}),at(a=>({...a,amountPaid:0}))),a.date.getTime()!==s.getTime()&&await Q(p.id,s);else{let a=await aZ(p,e,ak,al,s,ac.paymentStatus);a&&(await (0,y.updateSaleCashTransactionAction)(p.id,a),p.cashTransactionId=a),"Installment Sale"===ac.paymentStatus&&ac.amountPaid&&await a_(p.id,ac.amountPaid,p.items.map(a=>a.description).join(", "),ak,al,O?.id||"",aS)}if(k&&n&&n(),g&&await g(p,af,ah,ai,void 0,s,ag),m.toast.success(a?"Sale updated successfully!":"Sale recorded successfully!"),$&&ac.customerContact&&!a){let a=ac.items.map(a=>`â€¢ ${a.description} (Qty: ${a.quantity})`).join("\r\n"),b=aa.replace(/\{customer_name\}/gi,ac.customerName||"Valued Customer").replace(/\{receipt_number\}/gi,p.receiptNumber).replace(/\{items_list\}/gi,a).replace(/\{currency\}/gi,J.currency||"UGX").replace(/\{amount\}/gi,e.toLocaleString()).replace(/\{business_contact\}/gi,J.businessPhone||"our office").replace(/\{business_name\}/gi,O?.name||"Our Business");try{await V({phoneNumber:ac.customerContact,content:b,customerId:i.find(a=>a.phoneNumber===ac.customerContact)?.id,metadata:{sale_id:p.id,receipt_number:p.receiptNumber,type:"thank_you"}}),m.toast.success("Thank you SMS sent successfully!")}catch(a){m.toast.error("Sale saved, but failed to send SMS: "+a.message)}}a7(!0),U(!0),a7(!0),U(!0),g||o.push("/sales")}catch(a){console.error("Error submitting sale:",a),U(!1),m.toast.error(a.message||"An error occurred. Please try again.")}finally{r(!1)}},bb=(0,b.useMemo)(()=>aO(ac.items),[ac.items]),bc=(0,b.useMemo)(()=>aP(bb),[bb,ac.taxRate]),bd=(0,b.useMemo)(()=>bb+bc,[bb,bc]),{data:be=[]}=(0,H.useQuery)({queryKey:["all-products-for-scanner",K?.id,O?.id],queryFn:async()=>K?.id&&O?.id?(await (0,y.getProductsForBarcodeScannerAction)(O.id)||[]).map(w.mapDbProductToProduct):[],enabled:!!K?.id&&!!O?.id,staleTime:3e5}),bf=(0,b.useRef)(""),bg=(0,b.useRef)(Date.now());return(0,b.useEffect)(()=>{let a=a=>{let b=a.target,c=Date.now(),d=c-bg.current;if(bg.current=c,"Shift"===a.key||"Control"===a.key||"Alt"===a.key||"Meta"===a.key)return;let e=/^[a-zA-Z0-9\-_]$/.test(a.key),f="INPUT"===b.tagName||"TEXTAREA"===b.tagName||"true"===b.contentEditable;if(!f&&e&&(a.preventDefault(),a.stopPropagation()),"Enter"===a.key){let b=bf.current.trim();if(b.length>=2){a.preventDefault(),a.stopPropagation(),console.log(`[Scanner] Processing: "${b}"`);let c=async a=>{let b=await (0,y.lookupProductByBarcodeAction)(a,O?.id||"");return b?(0,w.mapDbProductToProduct)(b):null};(async()=>{let a=await c(b);if(a){let c=a.barcode||a.itemNumber||b;console.log(`[Scanner] âœ… Server Match: ${a.name}`),console.log(`[Scanner] ðŸ”— Mapping "${b}" -> System Code "${c}"`),aF(a),m.toast.success(`Scanned: ${a.name} (${c})`)}else console.warn(`[Scanner] âŒ No server match for: "${b}"`)})(),bf.current="";return}bf.current="",a.preventDefault(),a.stopPropagation();return}1===a.key.length&&(d<60&&f&&e&&(a.preventDefault(),a.stopPropagation()),d>100?bf.current=a.key:bf.current+=a.key)};return window.addEventListener("keydown",a,!0),()=>window.removeEventListener("keydown",a,!0)},[K?.id,O?.id]),(0,v.jsxs)("form",{onSubmit:ba,className:"space-y-6",children:[(0,v.jsx)(Z,{isEditing:!!a,selectedDate:s,onDateChange:t,customerName:ac.customerName,customerAddress:ac.customerAddress,customerContact:ac.customerContact,notes:ac.notes,onCustomerInfoChange:aD,errors:ad,customers:i,onAddNewCustomer:j,onSelectCustomer:aJ,selectedCategoryId:ai,onCategoryChange:aK,onClearForm:a?void 0:a8}),(0,v.jsx)(ap,{items:ac.items,onAddItem:aF,onUpdateItem:aG,onRemoveItem:aI,taxRateInput:ae,onTaxRateChange:aD,errors:ad,totalAmount:bb,taxAmount:bc,grandTotal:bd,taxRate:ac.taxRate||0,currency:J.currency,saleDate:s.toISOString()}),(0,v.jsx)(aC,{paymentStatus:ac.paymentStatus,onPaymentStatusChange:aE,isInstallmentSale:"Installment Sale"===ac.paymentStatus,amountPaid:ac.amountPaid||0,amountDue:ac.amountDue||0,grandTotal:bd,currency:J.currency,onAmountPaidChange:a=>aM(a,bd),onPaymentDateChange:aN,paymentDate:aj,saleId:a?.id,isEditing:!!a,payments:aX(aq),pendingChanges:ar,onStagePaymentChange:a?aV:void 0,linkToCash:ak,onLinkToCashChange:ay,selectedCashAccountId:al,onCashAccountChange:az,cashAccounts:N,hasPaidWithHistory:"Paid"===ac.paymentStatus&&aq.length>0,onLinkPaymentToCash:(a,b)=>a2(a,b,O?.id||""),onUpdatePayment:a5,onPaymentStatusChangeFromInstallment:async a=>aE(a),notes:ac.notes,onNotesChange:aD,categoryId:ac.categoryId||"",onCategoryChange:aL}),(0,v.jsx)(aH,{loading:p,isEditing:!!a,onCancel:()=>o.push("/sales"),onClearForm:a?void 0:a8,printAfterSave:af,onPrintAfterSaveChange:av,thermalPrintAfterSave:ag,onThermalPrintAfterSaveChange:aw,paymentStatus:ac.paymentStatus,includePaymentInfo:ah,onIncludePaymentInfoChange:ax,hasPendingPaymentChanges:as,sendSMS:$,onSendSMSChange:_,smsMessage:aa,onSMSMessageChange:ab,customerHasPhone:!!ac.customerContact,customerName:ac.customerName,disabled:T})]})};var aJ=a.i(626109),aK=a.i(197920),aL=a.i(124348),aM=a.i(104720);let aN=({onLoadDraft:a,onDismiss:b,savedAt:c})=>(0,v.jsxs)(aL.Alert,{className:"mb-4 border-blue-200 bg-blue-50",children:[(0,v.jsx)(aM.FileText,{className:"h-4 w-4 text-blue-600"}),(0,v.jsxs)(aL.AlertDescription,{className:"flex items-center justify-between",children:[(0,v.jsxs)("div",{className:"flex-1",children:[(0,v.jsx)("span",{className:"text-blue-800 font-medium",children:"Draft found!"}),(0,v.jsxs)("span",{className:"text-blue-700 ml-2",children:["Saved on ",c.toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]}),(0,v.jsxs)("div",{className:"flex gap-2 ml-4",children:[(0,v.jsx)(K.Button,{size:"sm",onClick:a,className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Load Draft"}),(0,v.jsx)(K.Button,{size:"sm",variant:"ghost",onClick:b,className:"text-blue-600 hover:text-blue-700 hover:bg-blue-100",children:(0,v.jsx)(at.X,{className:"h-4 w-4"})})]})]})]});a.s(["default",0,({editSale:a,currency:b,showDraftNotification:c,draftData:d,onLoadDraft:e,onDismissDraft:f,onSaleComplete:g,onClearDraft:h,customers:i,onAddNewCustomer:j,isReceiptOpen:k,completedSale:l,includePaymentInfo:m,onReceiptClose:n,newCustomerDialogOpen:o,onCloseNewCustomerDialog:p,onAddCustomer:q})=>(0,v.jsxs)(v.Fragment,{children:[c&&d&&(0,v.jsx)(aN,{onLoadDraft:e,onDismiss:f,savedAt:d.savedAt}),(0,v.jsx)(aI,{initialData:a,onSaleComplete:g,currency:b,customers:i,onAddNewCustomer:j,draftData:d,onClearDraft:h}),(0,v.jsx)(aJ.default,{isOpen:k,sale:l,currency:b,onOpenChange:n,includePaymentInfo:m}),(0,v.jsx)(aK.default,{open:o,onClose:p,onAddCustomer:q})]})],262285)}];

//# sourceMappingURL=src_hooks_useNewSaleDraft_ts_8023058f._.js.map