{"version":3,"sources":["../../../../src/hooks/use-toast.ts","../../../../src/app/actions/business.ts","../../../../src/hooks/useBusinessPassword.ts","../../../../src/contexts/BusinessContext.tsx","../../../../src/app/actions/business-settings.ts","../../../../src/hooks/useBusinessSettings.ts"],"sourcesContent":["\"use client\"\r\n\r\nimport * as React from \"react\"\r\n\r\nimport type {\r\n  ToastActionElement,\r\n  ToastProps,\r\n} from \"@/components/ui/toast\"\r\n\r\nconst TOAST_LIMIT = 1\r\nconst TOAST_REMOVE_DELAY = 1000000\r\n\r\ntype ToasterToast = ToastProps & {\r\n  id: string\r\n  title?: React.ReactNode\r\n  description?: React.ReactNode\r\n  action?: ToastActionElement\r\n}\r\n\r\nconst actionTypes = {\r\n  ADD_TOAST: \"ADD_TOAST\",\r\n  UPDATE_TOAST: \"UPDATE_TOAST\",\r\n  DISMISS_TOAST: \"DISMISS_TOAST\",\r\n  REMOVE_TOAST: \"REMOVE_TOAST\",\r\n} as const\r\n\r\nlet count = 0\r\n\r\nfunction genId() {\r\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\r\n  return count.toString()\r\n}\r\n\r\ntype ActionType = typeof actionTypes\r\n\r\ntype Action =\r\n  | {\r\n    type: ActionType[\"ADD_TOAST\"]\r\n    toast: ToasterToast\r\n  }\r\n  | {\r\n    type: ActionType[\"UPDATE_TOAST\"]\r\n    toast: Partial<ToasterToast>\r\n  }\r\n  | {\r\n    type: ActionType[\"DISMISS_TOAST\"]\r\n    toastId?: ToasterToast[\"id\"]\r\n  }\r\n  | {\r\n    type: ActionType[\"REMOVE_TOAST\"]\r\n    toastId?: ToasterToast[\"id\"]\r\n  }\r\n\r\ninterface State {\r\n  toasts: ToasterToast[]\r\n}\r\n\r\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\r\n\r\nconst addToRemoveQueue = (toastId: string) => {\r\n  if (toastTimeouts.has(toastId)) {\r\n    return\r\n  }\r\n\r\n  const timeout = setTimeout(() => {\r\n    toastTimeouts.delete(toastId)\r\n    dispatch({\r\n      type: \"REMOVE_TOAST\",\r\n      toastId: toastId,\r\n    })\r\n  }, TOAST_REMOVE_DELAY)\r\n\r\n  toastTimeouts.set(toastId, timeout)\r\n}\r\n\r\nexport const reducer = (state: State, action: Action): State => {\r\n  switch (action.type) {\r\n    case \"ADD_TOAST\":\r\n      return {\r\n        ...state,\r\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\r\n      }\r\n\r\n    case \"UPDATE_TOAST\":\r\n      return {\r\n        ...state,\r\n        toasts: state.toasts.map((t) =>\r\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\r\n        ),\r\n      }\r\n\r\n    case \"DISMISS_TOAST\": {\r\n      const { toastId } = action\r\n\r\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\r\n      // but I'll keep it here for simplicity\r\n      if (toastId) {\r\n        addToRemoveQueue(toastId)\r\n      } else {\r\n        state.toasts.forEach((toast) => {\r\n          addToRemoveQueue(toast.id)\r\n        })\r\n      }\r\n\r\n      return {\r\n        ...state,\r\n        toasts: state.toasts.map((t) =>\r\n          t.id === toastId || toastId === undefined\r\n            ? {\r\n              ...t,\r\n              open: false,\r\n            }\r\n            : t\r\n        ),\r\n      }\r\n    }\r\n    case \"REMOVE_TOAST\":\r\n      if (action.toastId === undefined) {\r\n        return {\r\n          ...state,\r\n          toasts: [],\r\n        }\r\n      }\r\n      return {\r\n        ...state,\r\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\r\n      }\r\n  }\r\n}\r\n\r\nconst listeners: Array<(state: State) => void> = []\r\n\r\nlet memoryState: State = { toasts: [] }\r\n\r\nfunction dispatch(action: Action) {\r\n  memoryState = reducer(memoryState, action)\r\n  listeners.forEach((listener) => {\r\n    listener(memoryState)\r\n  })\r\n}\r\n\r\ntype Toast = Omit<ToasterToast, \"id\">\r\n\r\nfunction toast({ ...props }: Toast) {\r\n  const id = genId()\r\n\r\n  const update = (props: ToasterToast) =>\r\n    dispatch({\r\n      type: \"UPDATE_TOAST\",\r\n      toast: { ...props, id },\r\n    })\r\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\r\n\r\n  dispatch({\r\n    type: \"ADD_TOAST\",\r\n    toast: {\r\n      ...props,\r\n      id,\r\n      open: true,\r\n      onOpenChange: (open) => {\r\n        if (!open) dismiss()\r\n      },\r\n    },\r\n  })\r\n\r\n  return {\r\n    id: id,\r\n    dismiss,\r\n    update,\r\n  }\r\n}\r\n\r\nfunction useToast() {\r\n  const [state, setState] = React.useState<State>(memoryState)\r\n\r\n  React.useEffect(() => {\r\n    listeners.push(setState)\r\n    return () => {\r\n      const index = listeners.indexOf(setState)\r\n      if (index > -1) {\r\n        listeners.splice(index, 1)\r\n      }\r\n    }\r\n  }, [state])\r\n\r\n  return {\r\n    ...state,\r\n    toast,\r\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\r\n  }\r\n}\r\n\r\nexport { useToast, toast }\r\n","'use server';\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function getBusinessLocationsAction(userId: string) {\r\n    try {\r\n        const branches = await db.branch.findMany({\r\n            where: {\r\n                adminId: userId\r\n            },\r\n            orderBy: [\r\n                {\r\n                    createdAt: 'desc'\r\n                },\r\n                {\r\n                    name: 'asc'\r\n                }\r\n            ]\r\n        });\r\n\r\n        // The previous context expected an is_default field, but it's not in the model.\r\n        // We will make the first branch the default if is_default is missing.\r\n        return branches.map((b: any, index: number) => ({\r\n            id: b.id,\r\n            name: b.name,\r\n            user_id: b.adminId,\r\n            is_default: index === 0, // Mocking is_default\r\n            created_at: b.createdAt.toISOString(),\r\n            updated_at: b.updatedAt.toISOString(),\r\n            switch_password_hash: b.accessPassword\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching business locations:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\nexport async function createBusinessAction(userId: string, name: string) {\r\n    try {\r\n        const branch = await db.branch.create({\r\n            data: {\r\n                name: name,\r\n                location: 'Main Location', // Default location\r\n                adminId: userId\r\n            }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                id: branch.id,\r\n                name: branch.name,\r\n                user_id: branch.adminId,\r\n                is_default: false,\r\n                created_at: branch.createdAt.toISOString(),\r\n                updated_at: branch.updatedAt.toISOString(),\r\n                switch_password_hash: branch.accessPassword\r\n            }\r\n        };\r\n    } catch (error) {\r\n        console.error('Error creating business:', error);\r\n        return { success: false, error: 'Failed to create business' };\r\n    }\r\n}\r\n\r\nexport async function updateBusinessAction(id: string, userId: string, name: string) {\r\n    try {\r\n        const branch = await db.branch.update({\r\n            where: {\r\n                id: id,\r\n                adminId: userId\r\n            },\r\n            data: {\r\n                name: name\r\n            }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                id: branch.id,\r\n                name: branch.name,\r\n                user_id: branch.adminId,\r\n                is_default: false, // Update logic handles defaultness elsewhere\r\n                created_at: branch.createdAt.toISOString(),\r\n                updated_at: branch.updatedAt.toISOString(),\r\n                switch_password_hash: branch.accessPassword\r\n            }\r\n        };\r\n    } catch (error) {\r\n        console.error('Error updating business:', error);\r\n        return { success: false, error: 'Failed to update business' };\r\n    }\r\n}\r\n\r\nexport async function deleteBusinessAction(id: string, userId: string) {\r\n    try {\r\n        await db.branch.delete({\r\n            where: {\r\n                id: id,\r\n                adminId: userId\r\n            }\r\n        });\r\n\r\n        return { success: true };\r\n    } catch (error) {\r\n        console.error('Error deleting business:', error);\r\n        return { success: false, error: 'Failed to delete business' };\r\n    }\r\n}\r\n\r\n// --- BUSINESS RESET ---\r\n\r\nexport async function resetBusinessAction(id: string, userId: string) {\r\n    try {\r\n        // Delete all business data in a transaction (products, sales, stock history, etc.)\r\n        await db.$transaction(async (tx: any) => {\r\n            // Delete stock history first (references products)\r\n            await tx.productHistory.deleteMany({ where: { locationId: id } });\r\n            // Delete sale items related data\r\n            await tx.sale.deleteMany({ where: { branchId: id } });\r\n            // Delete products\r\n            await tx.product.deleteMany({ where: { branchId: id } });\r\n            // Delete customers\r\n            await tx.customer.deleteMany({ where: { branchId: id } });\r\n            // Delete activity history\r\n            await tx.activityHistory.deleteMany({ where: { branchId: id } });\r\n        });\r\n\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error resetting business:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// --- BUSINESS PASSWORD ---\r\n\r\nimport bcrypt from 'bcryptjs';\r\n\r\nexport async function setBusinessPasswordAction(businessId: string, password: string) {\r\n    try {\r\n        const hash = await bcrypt.hash(password, 10);\r\n        await db.branch.update({\r\n            where: { id: businessId },\r\n            data: { accessPassword: hash }\r\n        });\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error setting business password:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function verifyBusinessPasswordAction(businessId: string, password: string) {\r\n    try {\r\n        const branch = await db.branch.findUnique({\r\n            where: { id: businessId },\r\n            select: { accessPassword: true }\r\n        });\r\n\r\n        if (!branch?.accessPassword) {\r\n            return { success: true, verified: true }; // No password set\r\n        }\r\n\r\n        const verified = await bcrypt.compare(password, branch.accessPassword);\r\n        return { success: true, verified };\r\n    } catch (error: any) {\r\n        console.error('Error verifying business password:', error);\r\n        return { success: false, verified: false, error: error.message };\r\n    }\r\n}\r\n\r\nexport async function removeBusinessPasswordAction(businessId: string) {\r\n    try {\r\n        await db.branch.update({\r\n            where: { id: businessId },\r\n            data: { accessPassword: null }\r\n        });\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Error removing business password:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n","\r\nimport { useState } from 'react';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { setBusinessPasswordAction, verifyBusinessPasswordAction, removeBusinessPasswordAction } from '@/app/actions/business';\r\n\r\nexport const useBusinessPassword = () => {\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const { toast } = useToast();\r\n\r\n  const VERIFIED_BUSINESSES_KEY = 'verified_businesses';\r\n\r\n  const getVerifiedBusinesses = (): Set<string> => {\r\n    try {\r\n      const stored = sessionStorage.getItem(VERIFIED_BUSINESSES_KEY);\r\n      return stored ? new Set(JSON.parse(stored)) : new Set();\r\n    } catch {\r\n      return new Set();\r\n    }\r\n  };\r\n\r\n  const setBusinessVerified = (businessId: string) => {\r\n    try {\r\n      const verified = getVerifiedBusinesses();\r\n      verified.add(businessId);\r\n      sessionStorage.setItem(VERIFIED_BUSINESSES_KEY, JSON.stringify(Array.from(verified)));\r\n    } catch (error) {\r\n      console.error('Error storing verified business:', error);\r\n    }\r\n  };\r\n\r\n  const isBusinessVerified = (businessId: string): boolean => {\r\n    return getVerifiedBusinesses().has(businessId);\r\n  };\r\n\r\n  const clearVerifiedBusinesses = () => {\r\n    try {\r\n      sessionStorage.removeItem(VERIFIED_BUSINESSES_KEY);\r\n    } catch (error) {\r\n      console.error('Error clearing verified businesses:', error);\r\n    }\r\n  };\r\n\r\n  const setBusinessPassword = async (businessId: string, password: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    try {\r\n      const result = await setBusinessPasswordAction(businessId, password);\r\n      if (result.success) {\r\n        toast({ title: 'Password Set Successfully', description: 'Your business is now password protected.' });\r\n        return true;\r\n      } else {\r\n        toast({ title: 'Failed to Set Password', description: result.error || 'Please try again later.', variant: 'destructive' });\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      console.error('Error setting business password:', error);\r\n      toast({ title: 'Failed to Set Password', description: 'An unexpected error occurred.', variant: 'destructive' });\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const verifyBusinessPassword = async (businessId: string, password: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    try {\r\n      const result = await verifyBusinessPasswordAction(businessId, password);\r\n      if (result.success && result.verified) {\r\n        setBusinessVerified(businessId);\r\n        return true;\r\n      } else {\r\n        toast({ title: 'Incorrect Password', description: 'The password you entered is incorrect.', variant: 'destructive' });\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      console.error('Error verifying business password:', error);\r\n      toast({ title: 'Verification Error', description: 'An unexpected error occurred.', variant: 'destructive' });\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const removeBusinessPassword = async (businessId: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    try {\r\n      const result = await removeBusinessPasswordAction(businessId);\r\n      if (result.success) {\r\n        const verified = getVerifiedBusinesses();\r\n        verified.delete(businessId);\r\n        sessionStorage.setItem(VERIFIED_BUSINESSES_KEY, JSON.stringify(Array.from(verified)));\r\n        return true;\r\n      } else {\r\n        toast({ title: 'Failed to Remove Password', description: result.error || 'Please try again later.', variant: 'destructive' });\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      console.error('Error removing business password:', error);\r\n      toast({ title: 'Failed to Remove Password', description: 'Please try again later.', variant: 'destructive' });\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  return {\r\n    isLoading,\r\n    setBusinessPassword,\r\n    verifyBusinessPassword,\r\n    removeBusinessPassword,\r\n    isBusinessVerified,\r\n    setBusinessVerified,\r\n    clearVerifiedBusinesses,\r\n  };\r\n};","import React, { createContext, useContext, useState, useEffect } from 'react';\r\nimport { useAuth } from '@/components/auth/AuthProvider';\r\nimport { useBusinessPassword } from '@/hooks/useBusinessPassword';\r\nimport { useQuery } from '@tanstack/react-query';\r\nimport { toast } from '@/hooks/use-toast';\r\nimport { getBusinessLocationsAction, createBusinessAction, updateBusinessAction, deleteBusinessAction, resetBusinessAction } from '@/app/actions/business';\r\n\r\n\r\nexport interface BusinessLocation {\r\n  id: string;\r\n  name: string;\r\n  is_default: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n  switch_password_hash?: string;\r\n}\r\n\r\ninterface BusinessContextType {\r\n  currentBusiness: BusinessLocation | null;\r\n  businessLocations: BusinessLocation[];\r\n  switchBusiness: (businessId: string, onPasswordPrompt?: (businessId: string, businessName: string, onVerified: () => void) => void) => void;\r\n  loadBusinessLocations: () => Promise<void>;\r\n  createBusiness: (name: string) => Promise<BusinessLocation | null>;\r\n  updateBusiness: (id: string, name: string) => Promise<boolean>;\r\n  deleteBusiness: (id: string) => Promise<boolean>;\r\n  resetBusiness: (id: string) => Promise<boolean>;\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  locationLimit: number;\r\n}\r\n\r\nconst BusinessContext = createContext<BusinessContextType | undefined>(undefined);\r\n\r\nexport const useBusiness = () => {\r\n  const context = useContext(BusinessContext);\r\n  if (context === undefined) {\r\n    throw new Error('useBusiness must be used within a BusinessProvider');\r\n  }\r\n  return context;\r\n};\r\n\r\nexport const BusinessProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const { user } = useAuth();\r\n  const [currentBusiness, setCurrentBusiness] = useState<BusinessLocation | null>(null);\r\n  const [businessLocations, setBusinessLocations] = useState<BusinessLocation[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const { isBusinessVerified } = useBusinessPassword();\r\n\r\n  // Static default â€“ limit can be driven from Prisma user profile if needed.\r\n  const locationLimit = 3;\r\n\r\n\r\n  const loadBusinessLocations = async () => {\r\n    if (!user) {\r\n      setIsLoading(false);\r\n      setError(null);\r\n      setCurrentBusiness(null);\r\n      setBusinessLocations([]);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n      setError(null);\r\n\r\n      const data = await getBusinessLocationsAction(user.id);\r\n\r\n      if (!data) {\r\n        throw new Error('Failed to load locations');\r\n      }\r\n\r\n      setBusinessLocations((data as any) || []);\r\n\r\n      // Always try to set a current business if we have locations\r\n      if (data && data.length > 0) {\r\n        // First check localStorage for saved business\r\n        const savedBusinessId = localStorage.getItem('currentBusinessId');\r\n        let businessToSet = (data as any[]).find(b => b.id === savedBusinessId);\r\n\r\n        // If no saved business or saved business not found, use default or first\r\n        if (!businessToSet) {\r\n          businessToSet = (data as any[]).find(b => b.is_default) || data[0];\r\n        }\r\n\r\n        if (businessToSet) {\r\n          setCurrentBusiness(businessToSet);\r\n          localStorage.setItem('currentBusinessId', businessToSet.id);\r\n        }\r\n      } else {\r\n        // No business locations found, clear current business\r\n        setCurrentBusiness(null);\r\n        localStorage.removeItem('currentBusinessId');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading business locations:', error);\r\n      setError('Failed to load business data');\r\n      setCurrentBusiness(null);\r\n      setBusinessLocations([]);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const switchBusiness = (businessId: string, onPasswordPrompt?: (businessId: string, businessName: string, onVerified: () => void) => void) => {\r\n    const business = businessLocations.find(b => b.id === businessId);\r\n    if (!business) {\r\n      console.error('Business not found:', businessId);\r\n      return;\r\n    }\r\n\r\n    // If business has password protection and is not verified in this session\r\n    if (business.switch_password_hash && !isBusinessVerified(businessId)) {\r\n      if (onPasswordPrompt) {\r\n        onPasswordPrompt(businessId, business.name, () => {\r\n          // This callback is called after successful password verification\r\n          setCurrentBusiness(business);\r\n          localStorage.setItem('currentBusinessId', business.id);\r\n        });\r\n        return;\r\n      } else {\r\n        console.warn('Password required but no prompt handler provided');\r\n        return;\r\n      }\r\n    }\r\n\r\n    // No password protection or already verified\r\n    setCurrentBusiness(business);\r\n    localStorage.setItem('currentBusinessId', business.id);\r\n  };\r\n\r\n  const createBusiness = async (name: string): Promise<BusinessLocation | null> => {\r\n    if (!user) {\r\n      console.error('No user found when creating business');\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      // Check location limit\r\n      if (businessLocations.length >= locationLimit) {\r\n        toast({\r\n          title: \"Limit Reached\",\r\n          description: `You have reached the maximum allowed limit of ${locationLimit} locations. Please contact support to increase your limit.`,\r\n          variant: \"destructive\"\r\n        });\r\n        return null;\r\n      }\r\n\r\n      const response = await createBusinessAction(user.id, name.trim());\r\n\r\n      if (!response.success || !response.data) {\r\n        console.error('Error creating business:', response.error);\r\n        throw new Error(response.error || 'Unknown error');\r\n      }\r\n\r\n      const data = response.data;\r\n\r\n      if (data) {\r\n        const newBusiness: BusinessLocation = {\r\n          id: (data as any).id,\r\n          name: (data as any).name,\r\n          is_default: (data as any).is_default,\r\n          created_at: (data as any).created_at,\r\n          updated_at: (data as any).updated_at,\r\n          switch_password_hash: (data as any).switch_password_hash\r\n        };\r\n\r\n        setBusinessLocations(prev => [...prev, newBusiness]);\r\n\r\n        // If this is the first business or it's set as default, make it current\r\n        if (businessLocations.length === 0 || newBusiness.is_default) {\r\n          setCurrentBusiness(newBusiness);\r\n          localStorage.setItem('currentBusinessId', newBusiness.id);\r\n        }\r\n\r\n        return newBusiness;\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Error creating business:', error);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const updateBusiness = async (id: string, name: string): Promise<boolean> => {\r\n    if (!user) return false;\r\n\r\n    try {\r\n      const response = await updateBusinessAction(id, user.id, name);\r\n\r\n      if (!response.success) {\r\n        throw new Error(response.error);\r\n      }\r\n\r\n      const data = response.data;\r\n\r\n      if (data) {\r\n        const updatedBusiness: BusinessLocation = {\r\n          id: (data as any).id,\r\n          name: (data as any).name,\r\n          is_default: (data as any).is_default,\r\n          created_at: (data as any).created_at,\r\n          updated_at: (data as any).updated_at,\r\n          switch_password_hash: (data as any).switch_password_hash\r\n        };\r\n\r\n        setBusinessLocations(prev => prev.map(b => b.id === id ? updatedBusiness : b));\r\n\r\n        if (currentBusiness?.id === id) {\r\n          setCurrentBusiness(updatedBusiness);\r\n        }\r\n\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Error updating business:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const deleteBusiness = async (id: string): Promise<boolean> => {\r\n    if (!user) return false;\r\n\r\n    try {\r\n      const response = await deleteBusinessAction(id, user.id);\r\n\r\n      if (!response.success) throw new Error(response.error);\r\n\r\n      setBusinessLocations(prev => prev.filter(b => b.id !== id));\r\n\r\n      // If deleted business was current, switch to default or first available\r\n      if (currentBusiness?.id === id) {\r\n        const remaining = businessLocations.filter(b => b.id !== id);\r\n        const defaultBusiness = remaining.find(b => b.is_default);\r\n        const nextBusiness = defaultBusiness || remaining[0] || null;\r\n\r\n        setCurrentBusiness(nextBusiness);\r\n        if (nextBusiness) {\r\n          localStorage.setItem('currentBusinessId', nextBusiness.id);\r\n        } else {\r\n          localStorage.removeItem('currentBusinessId');\r\n        }\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting business:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const resetBusiness = async (id: string): Promise<boolean> => {\r\n    if (!user) {\r\n      console.error('No user found when resetting business');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const response = await resetBusinessAction(id, user.id);\r\n      if (!response.success) throw new Error(response.error);\r\n\r\n      // Reload business locations to refresh the data\r\n      await loadBusinessLocations();\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error resetting business:', error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      loadBusinessLocations();\r\n    } else {\r\n      setCurrentBusiness(null);\r\n      setBusinessLocations([]);\r\n      setIsLoading(false);\r\n      setError(null);\r\n      localStorage.removeItem('currentBusinessId');\r\n    }\r\n  }, [user?.id]);\r\n\r\n  return (\r\n    <BusinessContext.Provider\r\n      value={{\r\n        currentBusiness,\r\n        businessLocations,\r\n        switchBusiness,\r\n        loadBusinessLocations,\r\n        createBusiness,\r\n        updateBusiness,\r\n        deleteBusiness,\r\n        resetBusiness,\r\n        isLoading,\r\n        error,\r\n        locationLimit\r\n      }}\r\n    >\r\n      {children}\r\n    </BusinessContext.Provider>\r\n  );\r\n};\r\n","'use server';\r\n\r\nimport { db } from '../../../prisma/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function getBusinessSettingsAction(branchId: string) {\r\n    try {\r\n        const settings = await db.branchSettings.findUnique({\r\n            where: { branchId }\r\n        });\r\n\r\n        if (!settings) {\r\n            return null;\r\n        }\r\n\r\n        return {\r\n            id: settings.id,\r\n            business_name: settings.businessName,\r\n            business_address: settings.address,\r\n            business_phone: settings.phone,\r\n            business_email: settings.email,\r\n            business_logo: settings.logo,\r\n            currency: settings.currency,\r\n            signature: settings.signatureImage,\r\n            metadata: settings.metadata || {}\r\n        };\r\n    } catch (error) {\r\n        console.error('Error fetching business settings:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function upsertBusinessSettingsAction(branchId: string, userId: string, updateData: any) {\r\n    try {\r\n        // Validate user access to branch\r\n        const branch = await db.branch.findFirst({\r\n            where: {\r\n                id: branchId,\r\n                OR: [\r\n                    { adminId: userId },\r\n                    { users: { some: { id: userId } } }\r\n                ]\r\n            }\r\n        });\r\n\r\n        if (!branch) {\r\n            return { success: false, error: 'Unauthorized to update branch settings' };\r\n        }\r\n\r\n        const data = {\r\n            businessName: updateData.business_name,\r\n            address: updateData.business_address,\r\n            phone: updateData.business_phone,\r\n            email: updateData.business_email,\r\n            logo: updateData.business_logo,\r\n            currency: updateData.currency,\r\n            signatureImage: updateData.signature,\r\n            metadata: updateData.metadata\r\n        };\r\n\r\n        const upserted = await db.branchSettings.upsert({\r\n            where: { branchId: branchId },\r\n            update: data,\r\n            create: {\r\n                branchId: branchId,\r\n                ...data\r\n            }\r\n        });\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                id: upserted.id,\r\n                business_name: upserted.businessName,\r\n                business_address: upserted.address,\r\n                business_phone: upserted.phone,\r\n                business_email: upserted.email,\r\n                business_logo: upserted.logo,\r\n                currency: upserted.currency,\r\n                signature: upserted.signatureImage,\r\n                metadata: upserted.metadata\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error upserting business settings:', error);\r\n        return { success: false, error: error.message || 'Failed to update settings' };\r\n    }\r\n}\r\n\r\nexport async function getAccountStatusAction(userId: string) {\r\n    try {\r\n        const user = await db.user.findUnique({\r\n            where: { id: userId },\r\n            select: {\r\n                isFrozen: true,\r\n                createdAt: true,\r\n                subscriptions: {\r\n                    where: { status: 'active' },\r\n                    orderBy: { endDate: 'desc' },\r\n                    take: 1\r\n                },\r\n                branches: {\r\n                    select: { id: true }\r\n                }\r\n            }\r\n        });\r\n\r\n        if (!user) return null;\r\n\r\n        const activeSub = user.subscriptions[0];\r\n        const now = new Date();\r\n        const daysRemaining = activeSub ? Math.ceil((activeSub.endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)) : 0;\r\n\r\n        return {\r\n            is_frozen: user.isFrozen,\r\n            location_limit: 1, // Traditional limit or from subscription\r\n            billing_amount: activeSub ? Number(activeSub.amount) : 50000,\r\n            billing_duration: 'Monthly',\r\n            days_remaining: Math.max(0, daysRemaining),\r\n            next_billing_date: activeSub?.endDate.toISOString() || ''\r\n        };\r\n    } catch (error) {\r\n        console.error('Error fetching account status:', error);\r\n        return { is_frozen: false, location_limit: 1, billing_amount: 50000, billing_duration: 'Monthly', days_remaining: 30, next_billing_date: '' };\r\n    }\r\n}\r\n\r\nexport async function getOnboardingStatusAction(locationId: string) {\r\n    try {\r\n        const settings = await db.branchSettings.findUnique({\r\n            where: { branchId: locationId }\r\n        });\r\n\r\n        if (!settings) return null;\r\n\r\n        return {\r\n            id: settings.id,\r\n            location_id: settings.branchId,\r\n            business_name: settings.businessName,\r\n            business_address: settings.address,\r\n            business_phone: settings.phone,\r\n            business_email: settings.email,\r\n            business_logo: settings.logo,\r\n            completed: !!settings.businessName && !!settings.phone, // Simplified completion check\r\n            is_frozen: false // Should come from branch or user status\r\n        };\r\n    } catch (error) {\r\n        console.error('Error fetching onboarding status:', error);\r\n        return null;\r\n    }\r\n}\r\n","\r\nimport { useState, useEffect } from 'react';\r\nimport { useQuery } from '@tanstack/react-query';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { useBusiness } from '@/contexts/BusinessContext';\r\nimport { useAuth } from '@/components/auth/AuthProvider';\r\nimport { getBusinessSettingsAction, upsertBusinessSettingsAction } from '@/app/actions/business-settings';\r\n\r\nexport interface BusinessSettings {\r\n  id?: string;\r\n  businessName: string;\r\n  businessAddress: string;\r\n  businessPhone: string;\r\n  businessEmail: string;\r\n  businessLogo?: string;\r\n  currency: string;\r\n  signature?: string;\r\n  paymentInfo?: string;\r\n  defaultPrintFormat?: 'standard' | 'thermal';\r\n  defaultPrinterName?: string;\r\n  defaultPrinterType?: 'USB' | 'Bluetooth';\r\n  printerPaperSize?: '58mm' | '80mm';\r\n}\r\n\r\n// Utility function to parse payment info text into structured format\r\nexport const parsePaymentInfo = (paymentInfo: string): { method: string, accountNumber: string, accountName: string }[] => {\r\n  if (!paymentInfo || paymentInfo.trim() === '') {\r\n    return [];\r\n  }\r\n\r\n  const lines = paymentInfo.split('\\n').filter(line => line.trim() !== '');\r\n  const methods: { method: string, accountNumber: string, accountName: string }[] = [];\r\n\r\n  for (let i = 0; i < lines.length; i += 3) {\r\n    if (i + 2 < lines.length) {\r\n      methods.push({\r\n        method: lines[i].trim(),\r\n        accountNumber: lines[i + 1].trim(),\r\n        accountName: lines[i + 2].trim()\r\n      });\r\n    }\r\n  }\r\n\r\n  return methods;\r\n};\r\n\r\n// Utility function to convert payment methods array back to string format\r\nexport const convertPaymentMethodsToString = (paymentMethods: { method: string, accountNumber: string, accountName: string }[]): string => {\r\n  return paymentMethods\r\n    .filter(pm => pm.method.trim() !== '' || pm.accountNumber.trim() !== '' || pm.accountName.trim() !== '')\r\n    .map(pm => `${pm.method}\\n${pm.accountNumber}\\n${pm.accountName}`)\r\n    .join('\\n');\r\n};\r\n\r\n// Default settings for new businesses\r\nconst getDefaultSettings = (): BusinessSettings => ({\r\n  businessName: '',\r\n  businessAddress: '',\r\n  businessPhone: '',\r\n  businessEmail: '',\r\n  currency: 'UGX',\r\n  paymentInfo: '',\r\n  defaultPrintFormat: 'standard'\r\n});\r\n\r\nexport const useBusinessSettings = () => {\r\n  const [settings, setSettings] = useState<BusinessSettings>(getDefaultSettings());\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const { toast } = useToast();\r\n  const { currentBusiness } = useBusiness();\r\n\r\n  const loadSettings = async (): Promise<BusinessSettings> => {\r\n    if (!currentBusiness) {\r\n      return getDefaultSettings();\r\n    }\r\n\r\n    try {\r\n      const data = await getBusinessSettingsAction(currentBusiness.id);\r\n\r\n      if (data) {\r\n        // Extract payment info from metadata\r\n        const paymentInfo = data.metadata && typeof data.metadata === 'object' ?\r\n          (data.metadata as Record<string, unknown>).payment_info as string || '' : '';\r\n\r\n        return {\r\n          id: data.id,\r\n          businessName: data.business_name || '',\r\n          businessAddress: data.business_address || '',\r\n          businessPhone: data.business_phone || '',\r\n          businessEmail: data.business_email || '',\r\n          businessLogo: data.business_logo || undefined,\r\n          currency: data.currency || 'UGX',\r\n          signature: data.signature || undefined,\r\n          paymentInfo: paymentInfo,\r\n          defaultPrintFormat: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).default_print_format as 'standard' | 'thermal' || 'standard' : 'standard',\r\n          defaultPrinterName: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).default_printer_name as string || '' : '',\r\n          defaultPrinterType: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).default_printer_type as 'USB' | 'Bluetooth' || 'USB' : 'USB',\r\n          printerPaperSize: data.metadata && typeof data.metadata === 'object' ?\r\n            (data.metadata as Record<string, unknown>).printer_paper_size as '58mm' | '80mm' || '58mm' : '58mm'\r\n        };\r\n      } else {\r\n        return getDefaultSettings();\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading business settings:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to load business settings. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return getDefaultSettings();\r\n    }\r\n  };\r\n\r\n  const updateSettings = async (newSettings: Partial<BusinessSettings>) => {\r\n    if (!currentBusiness) {\r\n      console.error('No business selected for updating settings');\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No business selected\",\r\n        variant: \"destructive\"\r\n      });\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const userData = { user: { id: '00000000-0000-0000-0000-000000000000' } }; // Mocked user id for now\r\n\r\n      // Prepare the metadata object with payment info\r\n      const metadata = {\r\n        payment_info: newSettings.hasOwnProperty('paymentInfo') ? newSettings.paymentInfo : settings.paymentInfo || '',\r\n        default_print_format: newSettings.hasOwnProperty('defaultPrintFormat') ? newSettings.defaultPrintFormat : settings.defaultPrintFormat || 'standard',\r\n        default_printer_name: newSettings.hasOwnProperty('defaultPrinterName') ? newSettings.defaultPrinterName : settings.defaultPrinterName || '',\r\n        default_printer_type: newSettings.hasOwnProperty('defaultPrinterType') ? newSettings.defaultPrinterType : settings.defaultPrinterType || 'USB',\r\n        printer_paper_size: newSettings.hasOwnProperty('printerPaperSize') ? newSettings.printerPaperSize : settings.printerPaperSize || '58mm'\r\n      };\r\n\r\n      const updateData = {\r\n        business_name: newSettings.hasOwnProperty('businessName') ? newSettings.businessName : settings.businessName,\r\n        business_address: newSettings.hasOwnProperty('businessAddress') ? newSettings.businessAddress : settings.businessAddress,\r\n        business_phone: newSettings.hasOwnProperty('businessPhone') ? newSettings.businessPhone : settings.businessPhone,\r\n        business_email: newSettings.hasOwnProperty('businessEmail') ? newSettings.businessEmail : settings.businessEmail,\r\n        business_logo: newSettings.hasOwnProperty('businessLogo') ? newSettings.businessLogo : settings.businessLogo,\r\n        currency: newSettings.hasOwnProperty('currency') ? newSettings.currency : settings.currency,\r\n        signature: newSettings.hasOwnProperty('signature') ? newSettings.signature : settings.signature,\r\n        metadata: metadata\r\n      };\r\n\r\n      const response = await upsertBusinessSettingsAction(currentBusiness.id, userData.user.id, updateData);\r\n\r\n      if (!response.success) {\r\n        console.error('Supabase error updating business settings:', response.error);\r\n        throw new Error(response.error);\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Business settings updated successfully\"\r\n      });\r\n\r\n      // Refetch settings after update\r\n      refetch();\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating business settings:', error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to update business settings. Please try again.\",\r\n        variant: \"destructive\"\r\n      });\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // React Query for settings loading with proper caching\r\n  const { data: queriedData, isLoading: isQueryLoading, isFetching, refetch } = useQuery({\r\n    queryKey: ['businessSettings', currentBusiness?.id],\r\n    queryFn: loadSettings,\r\n    enabled: !!currentBusiness?.id,\r\n    staleTime: 5 * 60_000,\r\n    gcTime: 30 * 60_000,\r\n    refetchOnWindowFocus: false,\r\n    refetchOnReconnect: false,\r\n  });\r\n\r\n  // Sync React Query data with local state\r\n  useEffect(() => {\r\n    if (queriedData) {\r\n      setSettings(queriedData);\r\n    } else if (!currentBusiness) {\r\n      setSettings(getDefaultSettings());\r\n    }\r\n  }, [queriedData, currentBusiness]);\r\n\r\n  // Sync loading state from React Query\r\n  useEffect(() => {\r\n    setIsLoading(isQueryLoading || isFetching);\r\n  }, [isQueryLoading, isFetching]);\r\n\r\n  return {\r\n    settings,\r\n    isLoading,\r\n    updateSettings,\r\n    loadSettings\r\n  };\r\n};\r\n"],"names":[],"mappings":"wCAEA,IAAA,EAAA,EAAA,CAAA,CAAA,QAwBA,IAAI,EAAQ,EA+BN,EAAgB,IAAI,IAEpB,EAAmB,AAAC,IACxB,GAAI,EAAc,GAAG,CAAC,GACpB,OAD8B,AAIhC,IAAM,EAAU,WAAW,KACzB,EAAc,MAAM,CAAC,GACrB,EAAS,CACP,KAAM,eACN,QAAS,CACX,EACF,EA5DyB,CA4DtB,IAEH,EAAc,GAAG,CAAC,EAAS,EAC7B,EAyDM,EAA2C,EAAE,CAE/C,EAAqB,CAAE,OAAQ,EAAE,AAAC,EAEtC,SAAS,EAAS,CAAc,EAC9B,EA5DqB,AA4DP,EA5DQ,EAAc,KACpC,OAAQ,EAAO,IAAI,EACjB,IAAK,YACH,MAAO,CACL,GAAG,CAAK,CACR,OAAQ,CAAC,EAAO,KAAK,IAAK,EAAM,MAAM,CAAC,CAAC,KAAK,CAAC,EAvElC,CAuEqC,CACnD,CAEF,KAAK,eACH,MAAO,CACL,GAAG,CAAK,CACR,OAAQ,EAAM,MAAM,CAAC,GAAG,CAAC,AAAC,GACxB,EAAE,EAAE,GAAK,EAAO,KAAK,CAAC,EAAE,CAAG,CAAE,GAAG,CAAC,CAAE,GAAG,EAAO,KAAK,AAAC,EAAI,EAE3D,CAEF,KAAK,gBAAiB,CACpB,GAAM,SAAE,CAAO,CAAE,CAAG,EAYpB,OARI,EACF,EAAiB,GAEjB,EAAM,AAHK,MAGC,CAAC,OAAO,CAAE,AAAD,IACnB,EAAiB,EAAM,EAAE,CAC3B,GAGK,CACL,GAAG,CAAK,CACR,OAAQ,EAAM,MAAM,CAAC,GAAG,CAAC,AAAC,GACxB,EAAE,EAAE,GAAK,QAAuB,IAAZ,EAChB,CACA,GAAG,CAAC,CACJ,KAAM,EACR,EACE,EAER,CACF,CACA,IAAK,eACH,GAAI,KAAmB,MAAZ,KAAuB,EAAhB,CAChB,MAAO,CACL,GAAG,CAAK,CACR,OAAQ,EAAE,AACZ,EAEF,MAAO,CACL,GAAG,CAAK,CACR,OAAQ,EAAM,MAAM,CAAC,MAAM,CAAE,AAAD,GAAO,EAAE,EAAE,GAAK,EAAO,OAAO,CAC5D,CACJ,EACF,EAOwB,EAAa,GACnC,EAAU,OAAO,CAAC,AAAC,IACjB,EAAS,EACX,EACF,CAIA,SAAS,EAAM,CAAE,GAAG,EAAc,EAChC,IAAM,EAnHN,AACO,GADC,AAmHG,CAnHF,GAAQ,CAAC,CAAI,OAAO,gBAAgB,AAAhB,EAChB,QAAQ,GAyHf,EAAU,IAAM,EAAS,CAAE,KAAM,gBAAiB,QAAS,CAAG,GAcpE,OAZA,EAAS,CACP,KAAM,YACN,MAAO,CACL,GAAG,CAAK,IACR,EACA,MAAM,EACN,aAAc,AAAC,IACT,AAAC,GAAM,GACb,CACF,CACF,GAEO,CACL,GAAI,UACJ,EACA,OAtBa,AAAC,GACd,EAAS,CACP,KAAM,eACN,MAAO,CAAE,GAAG,CAAK,IAAE,CAAG,CACxB,EAmBF,CACF,CAEA,SAAS,IACP,GAAM,CAAC,EAAO,EAAS,CAAG,EAAA,QAAc,CAAQ,GAYhD,OAVA,EAAA,SAAe,CAAC,KACd,EAAU,IAAI,CAAC,GACR,KACL,IAAM,EAAQ,EAAU,OAAO,CAAC,GAC5B,EAAQ,CAAC,GAAG,AACd,EAAU,MAAM,CAAC,EAAO,EAE5B,GACC,CAAC,EAAM,EAEH,CACL,GAAG,CAAK,OACR,EACA,QAAS,AAAC,GAAqB,EAAS,CAAE,KAAM,wBAAiB,CAAQ,EAC3E,CACF,uEC5LA,IAAA,EAAA,EAAA,CAAA,CAAA,QAyIA,EAAA,EAAA,CAAA,CAAA,mBAtIO,eAAe,EAA2B,CAAc,EAC3D,GAAI,CAiBA,MAAO,CAhBU,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,QAAQ,CAAC,CACtC,MAAO,CACH,QAAS,CACb,EACA,QAAS,CACL,CACI,UAAW,MACf,EACA,CACI,KAAM,KACV,EACH,AACL,EAAA,EAIgB,GAAG,CAAC,CAAC,EAAQ,KAAmB,CAC5C,EAD2C,CACvC,EAAE,EAAE,CACR,KAAM,EAAE,IAAI,CACZ,QAAS,EAAE,OAAO,CAClB,WAAY,AAAU,MACtB,WAAY,EAAE,SAAS,CAAC,WAAW,GACnC,WAAY,EAAE,SAAS,CAAC,WAAW,GACnC,qBAAsB,EAAE,cAAc,CAC1C,CAAC,CACL,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,qCAAsC,GAC7C,EACX,AADa,CAEjB,CAEO,eAAe,EAAqB,CAAc,CAAE,CAAY,EACnE,GAAI,CACA,IAAM,EAAS,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CAClC,KAAM,CACF,KAAM,EACN,SAAU,gBACV,QAAS,CACb,CACJ,GAEA,MAAO,CACH,SAAS,EACT,KAAM,CACF,GAAI,EAAO,EAAE,CACb,KAAM,EAAO,IAAI,CACjB,QAAS,EAAO,OAAO,CACvB,YAAY,EACZ,WAAY,EAAO,SAAS,CAAC,WAAW,GACxC,WAAY,EAAO,SAAS,CAAC,WAAW,GACxC,qBAAsB,EAAO,cAAc,AAC/C,CACJ,CACJ,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,CAAE,SAAS,EAAO,MAAO,2BAA4B,CAChE,CACJ,CAEO,eAAe,EAAqB,CAAU,CAAE,CAAc,CAAE,CAAY,EAC/E,GAAI,CACA,IAAM,EAAS,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CAClC,MAAO,CACH,GAAI,EACJ,QAAS,CACb,EACA,KAAM,CACF,KAAM,CACV,CACJ,GAEA,MAAO,CACH,SAAS,EACT,KAAM,CACF,GAAI,EAAO,EAAE,CACb,KAAM,EAAO,IAAI,CACjB,QAAS,EAAO,OAAO,CACvB,YAAY,EACZ,WAAY,EAAO,SAAS,CAAC,WAAW,GACxC,WAAY,EAAO,SAAS,CAAC,WAAW,GACxC,qBAAsB,EAAO,cAAc,AAC/C,CACJ,CACJ,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,CAAE,SAAS,EAAO,MAAO,2BAA4B,CAChE,CACJ,CAEO,eAAe,EAAqB,CAAU,CAAE,CAAc,EACjE,GAAI,CAQA,OAPA,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CACnB,MAAO,CACH,GAAI,EACJ,QAAS,CACb,CACJ,GAEO,CAAE,QAAS,EAAK,CAC3B,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,CAAE,SAAS,EAAO,MAAO,2BAA4B,CAChE,CACJ,CAIO,eAAe,EAAoB,CAAU,CAAE,CAAc,EAChE,GAAI,CAeA,OAbA,MAAM,EAAA,EAAE,CAAC,YAAY,CAAC,MAAO,IAEzB,MAAM,EAAG,cAAc,CAAC,UAAU,CAAC,CAAE,MAAO,CAAE,WAAY,CAAG,CAAE,GAE/D,MAAM,EAAG,IAAI,CAAC,UAAU,CAAC,CAAE,MAAO,CAAE,SAAU,CAAG,CAAE,GAEnD,MAAM,EAAG,OAAO,CAAC,UAAU,CAAC,CAAE,MAAO,CAAE,SAAU,CAAG,CAAE,GAEtD,MAAM,EAAG,QAAQ,CAAC,UAAU,CAAC,CAAE,MAAO,CAAE,SAAU,CAAG,CAAE,GAEvD,MAAM,EAAG,eAAe,CAAC,UAAU,CAAC,CAAE,MAAO,CAAE,SAAU,CAAG,CAAE,EAClE,GAEO,CAAE,SAAS,CAAK,CAC3B,CAAE,MAAO,EAAY,CAEjB,OADA,QAAQ,KAAK,CAAC,4BAA6B,GACpC,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,CAClD,CACJ,CAMO,eAAe,EAA0B,CAAkB,CAAE,CAAgB,EAChF,GAAI,CACA,IAAM,EAAO,MAAM,EAAA,OAAM,CAAC,IAAI,CAAC,EAAU,IAKzC,OAJA,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CACnB,MAAO,CAAE,GAAI,CAAW,EACxB,KAAM,CAAE,eAAgB,CAAK,CACjC,GACO,CAAE,SAAS,CAAK,CAC3B,CAAE,MAAO,EAAY,CAEjB,OADA,QAAQ,KAAK,CAAC,mCAAoC,GAC3C,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,CAClD,CACJ,CAEO,eAAe,EAA6B,CAAkB,CAAE,CAAgB,EACnF,GAAI,CACA,IAAM,EAAS,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,UAAU,CAAC,CACtC,MAAO,CAAE,GAAI,CAAW,EACxB,OAAQ,CAAE,gBAAgB,CAAK,CACnC,GAEA,GAAI,CAAC,GAAQ,eACT,CADyB,KAClB,CAAE,QAAS,GAAM,UAAU,CAAK,EAG3C,CAH8C,GAGxC,EAAW,MAAM,EAAA,KAHyC,EAGnC,CAAC,OAAO,CAAC,EAAU,EAAO,cAAc,EACrE,MAAO,CAAE,SAAS,WAAM,CAAS,CACrC,CAAE,MAAO,EAAY,CAEjB,OADA,QAAQ,KAAK,CAAC,qCAAsC,GAC7C,CAAE,QAAS,GAAO,UAAU,EAAO,MAAO,EAAM,OAAO,AAAC,CACnE,CACJ,CAEO,eAAe,EAA6B,CAAkB,EACjE,GAAI,CAKA,OAJA,MAAM,EAAA,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CACnB,MAAO,CAAE,GAAI,CAAW,EACxB,KAAM,CAAE,eAAgB,IAAK,CACjC,GACO,CAAE,SAAS,CAAK,CAC3B,CAAE,MAAO,EAAY,CAEjB,OADA,QAAQ,KAAK,CAAC,oCAAqC,GAC5C,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,AAAC,CAClD,CACJ,4VCxLA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,uEAEmC,KACjC,GAAM,CAAC,EAAW,EAAa,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,IACrC,CAAE,OAAK,CAAE,CAAG,CAAA,EAAA,EAAA,QAAQ,AAAR,IAEZ,EAA0B,sBAE1B,EAAwB,KAC5B,GAAI,CACF,IAAM,EAAS,eAAe,OAAO,CAAC,GACtC,OAAO,EAAS,IAAI,IAAI,KAAK,KAAK,CAAC,IAAW,IAAI,GACpD,CAAE,KAAM,CACN,OAAO,IAAI,GACb,CACF,EAEM,EAAsB,AAAC,IAC3B,GAAI,CACF,IAAM,EAAW,IACjB,EAAS,GAAG,CAAC,GACb,eAAe,OAAO,CAAC,EAAyB,KAAK,SAAS,CAAC,MAAM,IAAI,CAAC,IAC5E,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,mCAAoC,EACpD,CACF,EAcM,EAAsB,MAAO,EAAoB,KACrD,GAAa,GACb,GAAI,CACF,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,yBAAyB,AAAzB,EAA0B,EAAY,GAC3D,GAAI,EAAO,OAAO,CAEhB,CAFkB,MAClB,EAAM,CAAE,MAAO,4BAA6B,YAAa,0CAA2C,IAC7F,EAGP,OADA,EAAM,CAAE,MAAO,yBAA0B,YAAa,EAAO,KAAK,EAAI,0BAA2B,QAAS,aAAc,IACjH,CAEX,CAAE,MAAO,EAAO,CAGd,OAFA,QAAQ,KAAK,CAAC,mCAAoC,GAClD,EAAM,CAAE,MAAO,yBAA0B,YAAa,gCAAiC,QAAS,aAAc,IACvG,CACT,QAAU,CACR,EAAa,GACf,CACF,EAEM,EAAyB,MAAO,EAAoB,KACxD,GAAa,GACb,GAAI,CACF,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,4BAAA,AAA4B,EAAC,EAAY,GAC9D,GAAI,EAAO,OAAO,EAAI,EAAO,QAAQ,CAEnC,CAFqC,MACrC,EAAoB,GACb,GAGP,OADA,EAAM,CAAE,MAAO,qBAAsB,YAAa,yCAA0C,QAAS,aAAc,IAC5G,CAEX,CAAE,MAAO,EAAO,CAGd,OAFA,QAAQ,KAAK,CAAC,qCAAsC,GACpD,EAAM,CAAE,MAAO,qBAAsB,YAAa,gCAAiC,QAAS,aAAc,IACnG,CACT,QAAU,CACR,GAAa,EACf,CACF,EAEM,EAAyB,MAAO,IACpC,EAAa,IACb,GAAI,CACF,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,4BAAA,AAA4B,EAAC,GAClD,IAAI,EAAO,OAAO,CAOhB,OADA,EAAM,CAAE,MAAO,4BAA6B,YAAa,EAAO,KAAK,EAAI,0BAA2B,QAAS,aAAc,IACpH,CAPW,EAClB,IAAM,EAAW,IAGjB,OAFA,EAAS,MAAM,CAAC,GAChB,eAAe,OAAO,CAAC,EAAyB,KAAK,SAAS,CAAC,MAAM,IAAI,CAAC,KACnE,EACT,CAIF,CAAE,KAJO,CAIA,EAAO,CAGd,OAFA,QAAQ,KAAK,CAAC,oCAAqC,GACnD,EAAM,CAAE,MAAO,4BAA6B,YAAa,0BAA2B,QAAS,aAAc,IACpG,CACT,QAAU,CACR,GAAa,EACf,CACF,EAEA,MAAO,CACL,gCACA,EACA,gDACA,EACA,mBA/E0B,AAAD,GAClB,IAAwB,GAAG,CAAC,uBA+EnC,EACA,wBA7E8B,KAC9B,GAAI,CACF,eAAe,UAAU,CAAC,EAC5B,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,sCAAuC,EACvD,CACF,CAwEA,CACF,uECjHA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAEA,EAAA,CAAA,CAAA,QACA,IAAA,EAAA,EAAA,CAAA,CAAA,kDA0BA,IAAM,EAAkB,CAAA,EAAA,EAAA,aAAA,AAAa,OAAkC,wBAE5C,KACzB,IAAM,EAAU,CAAA,EAAA,EAAA,UAAU,AAAV,EAAW,GAC3B,QAAgB,IAAZ,EACF,KADyB,CACnB,AAAI,MAAM,sDAElB,OAAO,CACT,mLCrCA,IAAA,EAAA,EAAA,CAAA,CAAA,iBAGO,eAAe,EAA0B,CAAgB,EAC5D,GAAI,CACA,IAAM,EAAW,MAAM,EAAA,EAAE,CAAC,cAAc,CAAC,UAAU,CAAC,CAChD,MAAO,UAAE,CAAS,CACtB,GAEA,GAAI,CAAC,EACD,OAAO,CADI,IAIf,MAAO,CACH,GAAI,EAAS,EAAE,CACf,cAAe,EAAS,YAAY,CACpC,iBAAkB,EAAS,OAAO,CAClC,eAAgB,EAAS,KAAK,CAC9B,eAAgB,EAAS,KAAK,CAC9B,cAAe,EAAS,IAAI,CAC5B,SAAU,EAAS,QAAQ,CAC3B,UAAW,EAAS,cAAc,CAClC,SAAU,EAAS,QAAQ,EAAI,CAAC,CACpC,CACJ,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,oCAAqC,GAC5C,IACX,CACJ,CAEO,eAAe,EAA6B,CAAgB,CAAE,CAAc,CAAE,CAAe,EAChG,GAAI,CAYA,GAAI,CAVW,AAUV,MAVgB,EAUR,AAVQ,EAAE,CAAC,MAAM,CAAC,SAAS,CAAC,CACrC,MAAO,CACH,GAAI,EACJ,GAAI,CACA,CAAE,QAAS,CAAO,EAClB,CAAE,MAAO,CAAE,KAAM,CAAE,GAAI,CAAO,CAAE,CAAE,EAE1C,AADK,CAET,GAGI,MAAO,CAAE,SAAS,EAAO,MAAO,wCAAyC,EAG7E,IAAM,EAAO,CACT,aAAc,EAAW,aAAa,CACtC,QAAS,EAAW,gBAAgB,CACpC,MAAO,EAAW,cAAc,CAChC,MAAO,EAAW,cAAc,CAChC,KAAM,EAAW,aAAa,CAC9B,SAAU,EAAW,QAAQ,CAC7B,eAAgB,EAAW,SAAS,CACpC,SAAU,EAAW,QAAQ,AACjC,EAEM,EAAW,MAAM,EAAA,EAAE,CAAC,cAAc,CAAC,MAAM,CAAC,CAC5C,MAAO,CAAE,SAAU,CAAS,EAC5B,OAAQ,EACR,OAAQ,CACJ,SAAU,EACV,GAAG,CAAI,AACX,CACJ,GAEA,MAAO,CACH,SAAS,EACT,KAAM,CACF,GAAI,EAAS,EAAE,CACf,cAAe,EAAS,YAAY,CACpC,iBAAkB,EAAS,OAAO,CAClC,eAAgB,EAAS,KAAK,CAC9B,eAAgB,EAAS,KAAK,CAC9B,cAAe,EAAS,IAAI,CAC5B,SAAU,EAAS,QAAQ,CAC3B,UAAW,EAAS,cAAc,CAClC,SAAU,EAAS,QACvB,AAD+B,CAEnC,CACJ,CAAE,MAAO,EAAY,CAEjB,OADA,QAAQ,KAAK,CAAC,qCAAsC,GAC7C,CAAE,QAAS,GAAO,MAAO,EAAM,OAAO,EAAI,2BAA4B,CACjF,CACJ,CAEO,eAAe,EAAuB,CAAc,EACvD,GAAI,CACA,IAAM,EAAO,MAAM,EAAA,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,CAClC,MAAO,CAAE,GAAI,CAAO,EACpB,OAAQ,CACJ,UAAU,EACV,UAAW,GACX,cAAe,CACX,MAAO,CAAE,OAAQ,QAAS,EAC1B,QAAS,CAAE,QAAS,MAAO,EAC3B,KAAM,CACV,EACA,SAAU,CACN,OAAQ,CAAE,IAAI,CAAK,CACvB,CACJ,CACJ,GAEA,GAAI,CAAC,EAAM,OAAO,KAElB,IAAM,EAAY,EAAK,aAAa,CAAC,EAAE,CACjC,EAAM,IAAI,KACV,EAAgB,EAAY,KAAK,IAAI,CAAC,CAAC,EAAU,OAAO,CAAC,OAAO,GAAK,EAAI,OAAO,EAAA,CAAE,CAAK,GAAD,IAAyB,AAAjB,EAEpG,GAFyG,GAElG,CACH,CAH0G,EAAE,OAGjG,EAAK,QAAQ,CACxB,eAAgB,EAChB,eAAgB,EAAY,OAAO,EAAU,MAAM,EAAI,IACvD,iBAAkB,UAClB,eAAgB,KAAK,GAAG,CAAC,EAAG,GAC5B,kBAAmB,GAAW,QAAQ,eAAiB,EAC3D,CACJ,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,iCAAkC,GACzC,CAAE,WAAW,EAAO,eAAgB,EAAG,eAAgB,IAAO,iBAAkB,UAAW,eAAgB,GAAI,kBAAmB,EAAG,CAChJ,CACJ,CAEO,eAAe,EAA0B,CAAkB,EAC9D,GAAI,CACA,IAAM,EAAW,MAAM,EAAA,EAAE,CAAC,cAAc,CAAC,UAAU,CAAC,CAChD,MAAO,CAAE,SAAU,CAAW,CAClC,GAEA,GAAI,CAAC,EAAU,OAAO,KAEtB,MAAO,CACH,GAAI,EAAS,EAAE,CACf,YAAa,EAAS,QAAQ,CAC9B,cAAe,EAAS,YAAY,CACpC,iBAAkB,EAAS,OAAO,CAClC,eAAgB,EAAS,KAAK,CAC9B,eAAgB,EAAS,KAAK,CAC9B,cAAe,EAAS,IAAI,CAC5B,UAAW,CAAC,CAAC,EAAS,YAAY,EAAI,CAAC,CAAC,EAAS,KAAK,CACtD,WAAW,CACf,CACJ,CAAE,GAFuB,GAEhB,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,cAHgD,sBAGX,GAC5C,IACX,CACJ,gOCrJA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAEA,EAAA,EAAA,CAAA,CAAA,kDAiDA,IAAM,EAAqB,IAAwB,CAAC,CAClD,aAAc,GACd,gBAAiB,GACjB,cAAe,GACf,cAAe,GACf,SAAU,MACV,YAAa,GACb,mBAAoB,WACtB,CAAC,2BAtC+B,AAAC,IAC/B,GAAI,CAAC,GAAsC,IAAI,CAA3B,EAAY,IAAI,GAClC,MAAO,EAAE,CAGX,IAAM,EAAQ,EAAY,KAAK,CAAC,MAAM,MAAM,CAAC,GAAwB,KAAhB,EAAK,IAAI,IACxD,EAA4E,EAAE,CAEpF,IAAK,IAAI,EAAI,EAAG,EAAI,EAAM,MAAM,CAAE,GAAK,EAAG,AACpC,EAAI,EAAI,EAAM,MAAM,EAAE,AACxB,EAAQ,IAAI,CAAC,CACX,OAAQ,CAAK,CAAC,EAAE,CAAC,IAAI,GACrB,cAAe,CAAK,CAAC,EAAI,EAAE,CAAC,IAAI,GAChC,YAAa,CAAK,CAAC,EAAI,EAAE,CAAC,IAAI,EAChC,GAIJ,OAAO,CACT,0BAqBmC,KACjC,GAAM,CAAC,EAAU,EAAY,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAmB,KACrD,CAAC,EAAW,EAAa,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,GAAC,GACrC,OAAE,CAAK,CAAE,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,IACpB,iBAAE,CAAe,CAAE,CAAG,CAAA,EAAA,EAAA,WAAA,AAAW,IAEjC,EAAe,UACnB,GAAI,CAAC,EACH,OAAO,IAGT,GAAI,CAJkB,AAKpB,IAAM,EAAO,MAAM,CAAA,EAAA,EAAA,yBAAA,AAAyB,EAAC,EAAgB,EAAE,EAE/D,IAAI,EAyBF,OAAO,GAzBC,EAER,IAAM,EAAc,EAAK,QAAQ,EAA6B,UAAzB,OAAO,EAAK,QAAQ,EACtD,EAAK,QAAQ,CAA6B,YAAY,EAAc,GAEvE,EAF4E,IAErE,CACL,GAAI,EAAK,EAAE,CACX,aAAc,EAAK,aAAa,EAAI,GACpC,gBAAiB,EAAK,gBAAgB,EAAI,GAC1C,cAAe,EAAK,cAAc,EAAI,GACtC,cAAe,EAAK,cAAc,EAAI,GACtC,aAAc,EAAK,aAAa,EAAI,OACpC,SAAU,EAAK,QAAQ,EAAI,MAC3B,UAAW,EAAK,SAAS,OAAI,EAC7B,YAAa,EACb,mBAAoB,EAAK,QAAQ,EAA6B,UAAzB,OAAO,EAAK,QAAQ,EACtD,EAAK,QAAQ,CAA6B,oBAAoB,EAA8B,WAC/F,EAD4G,iBACxF,EAAK,QAAQ,EAA6B,UAAzB,OAAO,EAAK,QAAQ,EACtD,EAAK,QAAQ,CAA6B,oBAAoB,EAAc,GAC/E,EADoF,iBAChE,EAAK,QAAQ,EAA6B,UAAzB,OAAO,EAAK,QAAQ,EACtD,EAAK,QAAQ,CAA6B,oBAAoB,EAA2B,MAC5F,EADoG,eAClF,EAAK,QAAQ,EAA6B,UAAzB,OAAO,EAAK,QAAQ,EACpD,EAAK,QAAQ,CAA6B,kBAAkB,EAAuB,MACxF,CACF,CAGF,CALqG,AAKnG,KAHO,CAGA,EAAO,CAOd,OANA,QAAQ,KAAK,CAAC,mCAAoC,GAClD,EAAM,CACJ,MAAO,QACP,YAAa,sDACb,QAAS,aACX,GACO,GACT,CACF,EAEM,EAAiB,MAAO,IAC5B,GAAI,CAAC,EAOH,OANA,QADoB,AACZ,KAAK,CAAC,8CACd,EAAM,CACJ,MAAO,QACP,YAAa,uBACb,QAAS,aACX,IACO,EAGT,GAAI,CAIF,IAAM,EAAW,CACf,aAAc,EAAY,cAAc,CAAC,eAAiB,EAAY,WAAW,CAAG,EAAS,WAAW,EAAI,GAC5G,qBAAsB,EAAY,cAAc,CAAC,sBAAwB,EAAY,kBAAkB,CAAG,EAAS,kBAAkB,EAAI,WACzI,qBAAsB,EAAY,cAAc,CAAC,sBAAwB,EAAY,kBAAkB,CAAG,EAAS,kBAAkB,EAAI,GACzI,qBAAsB,EAAY,cAAc,CAAC,sBAAwB,EAAY,kBAAkB,CAAG,EAAS,kBAAkB,EAAI,MACzI,mBAAoB,EAAY,cAAc,CAAC,oBAAsB,EAAY,gBAAgB,CAAG,EAAS,gBAAgB,EAAI,MACnI,EAEM,EAAa,CACjB,cAAe,EAAY,cAAc,CAAC,gBAAkB,EAAY,YAAY,CAAG,EAAS,YAAY,CAC5G,iBAAkB,EAAY,cAAc,CAAC,mBAAqB,EAAY,eAAe,CAAG,EAAS,eAAe,CACxH,eAAgB,EAAY,cAAc,CAAC,iBAAmB,EAAY,aAAa,CAAG,EAAS,aAAa,CAChH,eAAgB,EAAY,cAAc,CAAC,iBAAmB,EAAY,aAAa,CAAG,EAAS,aAAa,CAChH,cAAe,EAAY,cAAc,CAAC,gBAAkB,EAAY,YAAY,CAAG,EAAS,YAAY,CAC5G,SAAU,EAAY,cAAc,CAAC,YAAc,EAAY,QAAQ,CAAG,EAAS,QAAQ,CAC3F,UAAW,EAAY,cAAc,CAAC,aAAe,EAAY,SAAS,CAAG,EAAS,SAAS,CAC/F,SAAU,CACZ,EAEM,EAAW,MAAM,CAAA,EAAA,EAAA,4BAA4B,AAA5B,EAA6B,EAAgB,EAAE,CAtBvC,CAsByC,SAAS,IAAI,CAAC,EAAE,sBAAE,GAE1F,GAAI,CAAC,EAAS,OAAO,CAEnB,CAFqB,KACrB,QAAQ,KAAK,CAAC,6CAA8C,EAAS,KAAK,EACpE,AAAI,MAAM,EAAS,KAAK,EAWhC,OARA,EAAM,CACJ,MAAO,UACP,YAAa,wCACf,GAGA,KAEO,CACT,CAAE,MAAO,EAAO,CAOd,OANA,QAAQ,KAAK,CAAC,oCAAqC,GACnD,EAAM,CACJ,MAAO,QACP,YAAa,wDACb,QAAS,aACX,IACO,CACT,CACF,EAGM,CAAE,KAAM,CAAW,CAAE,UAAW,CAAc,YAAE,CAAU,SAAE,CAAO,CAAE,CAAG,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CACrF,SAAU,CAAC,mBAAoB,GAAiB,GAAG,CACnD,QAAS,EACT,QAAS,CAAC,CAAC,GAAiB,GAC5B,UAAW,IAAI,AACf,OAAQ,KAAK,AACb,sBAAsB,EACtB,oBAAoB,CACtB,GAgBA,MAbA,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACJ,EACF,EAAY,GACH,AAAC,GACV,EAAY,CAHG,GAKnB,EAAG,CAAC,EAAa,EAAgB,CAHF,CAM/B,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,KACR,EAAa,GAAkB,EACjC,EAAG,CAAC,EAAgB,EAAW,EAExB,UACL,YACA,EACA,8BACA,CACF,CACF"}